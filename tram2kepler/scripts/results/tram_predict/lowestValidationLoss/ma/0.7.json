{"schema":{"fields":[{"name":"index","type":"integer"},{"name":"segment","type":"string"},{"name":"label(s)","type":"string"}],"primaryKey":["index"],"pandas_version":"1.4.0"},"data":[{"index":0,"segment":"5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) Malware Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs We discovered an active campaign targeting Eastern Europeans in the cryptocurrency industry using fake job lures. By: Aliakbar Zahravi, Peter Girnus February 09, 2023 Read time: 11 min (3099 words) P ri n t \ue94e \ue952 Subscribe We recently found an active campaign that uses a fake employment pretext targeting Eastern Europeans in the cryptocurrency industry to install an information stealer. In this campaign, the suspected Russian threat actors use several highly obfuscated and under-development custom loaders to infect those involved in the cryptocurrency industry with the Enigma Stealer (detected as TrojanSpy.MSIL.ENIGMASTEALER.YXDBC), a modi\u0000ed version of the Stealerium information stealer. In addition to these loaders, the attacker also exploits CVE-2015-2291, an Intel driver vulnerability, to load a malicious driver designed to reduce the token integrity of Microsoft Defender. \ue90a Cookies Settings This website uses cookies for website functionality, tra\u0000c analytics, personalization, social media functionality and Steadavleerrtiisuinmg., O tuhre C ooorkiigei nNoatli cien pfororvmideast imoonr es itnefoarlmeart iwonh aicnhd serves as the base for Accept explains how to amend your cookie settings. Learn more Enigma Stealer, Bis a sn o ep ssen-source project written in C# and markets \ue8b6itself as u in a stealer, clipper, and keylogger with logging capabilities using the Telegram https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 1\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) API. Security teams and individual users are advised to continuously update the security solutions of their systems and remain vigilant against threat actors who perform social engineering via job opportunity or salary increase-related lures. Attack Chain Figure 1. The Attack kill chain used by Enigma Stealer operator (click the image for a larger version) Using fake cryptocurrency interviews to lure victims The infection chain starts with a malicious RAR archive","label(s)":[]},{"index":1,"segment":"infection chain starts with a malicious RAR archive \u2014 in this instance\ue90a, contract.rar","label(s)":["T1027"]},{"index":2,"segment":"malicious RAR archive \u2014 in this instance\ue90a, contract.rar (SHA256: This website uses cookies for website functionality, tra\u0000c 65a8n7al2yt5icfsb, p5eers7o5nealbizabtciobn0, s3obciacl4 m6edd4ia4 fuf0nc4ti8oana0lift1y 4an5d367e\u000066c8a1a9dc84eef777a9c advertising. Our Cookie Notice provides more information and c) \u2014 which is distributed to victims via phishing attempts or through social explains how to amend your cookie settings. Learn more Business \ue8b6 media. The archive contains the \u0000les, Interview questions.txt, and Interview conditions.word.exe. https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 2\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Figure 2. The \u0000les found inside the malicious RAR archive These \u0000les set up the pretext for a fake cryptocurrency role or job opening. One \u0000le, Interview questions.txt (SHA256: 3a1eb6fabf45d18869de4\u0000d773ae82949ef80f89105e5f96505de810653ed7 3) contains sample interview questions written in Cyrillic. This serves to further legitimize the package in the eyes of the victim and draw attention away from the malicious binary. Figure 3. A machine translation of Interview questions.txt The other \u0000le Interview conditions.word.exe (SHA256: 03b9d7296b01e8f3fb3d12c4d80fe8a1bb0ab2fd76f33c5ce11b40729b75fb 23) contains the \u0000rst stage Enigma loader. This \u0000le, which also masquerades \ue90a as a legitimate word document, is designed to lure unsuspecting victims This website uses cookies for website functionality, tra\u0000c into executing the loader. Once executed, the Enigma loader begins the analytics, personalization, social media functionality and regadisvetrrtaistiinogn. O aunr Cdo dokoiew Nnoltoicae dprinovgid oesf mthoere sinefcoromnadtio-snt aangde payload. explains how to amend your cookie settings. Learn more Business \ue8b6 Analysis of the Enigma infrastructure https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 3\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) Enigma uses two servers in its operation.","label(s)":[]},{"index":3,"segment":"(NO) Enigma uses two servers in its operation. The \u0000rst utilizes Telegram for","label(s)":["T1090"]},{"index":4,"segment":"in its operation. The \u0000rst utilizes Telegram for delivering payloads, sending commands, and receiving the payload heartbeat. The second server 193[.]56[.]146[.]29 is used for DevOps and logging purposes. At each stage the payload sends its execution log to the logging server. Since this malware is under continuous development the attacker potentially uses the logging server to improve malware performance. We have also identi\u0000ed the Amadey C2 panel on 193[.]56[.]146[.]29 which has only one sample (95b4de74daadf79f0e0eef7735ce80bc) communicating with it. \ue90a This website uses cookies for website functionality, tra\u0000c Figure 4. Amadey C&C login page analytics, personalization, social media functionality and advertising. Our Cookie Notice provides more information and Amexapdlaeinys ihso wa tpoo apmuenladr y obuor tcnooekti et hseattti nisgs s. oLeldar no nm oRruessian speaking forums, but its Business \ue8b6 source code has been leaked online. Amadey o\u0000ers threat actors polling https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 4\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) and reconnaissance services. Figure 5. The exposed info.php page of the threat actors\u2019 command-and-control (C&C) infrastructure This server has a unique Linux distribution only referenced in Russian Linux forums. Figure 6. The default time zone of the C&C server \ue90a The default time zone on this server is set to Europe\/Moscow. This server This website uses cookies for website functionality, tra\u0000c registers a newly infected host when Interview conditions.word.exe is analytics, personalization, social media functionality and exaedcvuertteisdin gb. yO utrh Ceo ovkiciet iNmot.ice provides more information and explains how to amend your cookie settings. Learn more Business \ue8b6 Stage 1: EnigmaDownloader_s001 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 5\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) MD5 1693D0A858B8FF3B83852C185880E459 SHA-1 5F1536F573D9BFEF21A4E15273B5A9852D3D81F1 SHA- 03B9D7296B01E8F3FB3D12C4D80FE8A1BB0AB2FD76F33C5CE11B40729B75FB23 256 File 367.00 KB (375808 bytes) size The initial stage of Enigma, Interview conditions.word.exe, is a downloader written in C++. Its primary objective is to download, deobfuscate,","label(s)":[]},{"index":5,"segment":"C++. Its primary objective is to download, deobfuscate, decompress, and launch the secondary","label(s)":["T1140"]},{"index":6,"segment":"to download, deobfuscate, decompress, and launch the secondary stage payload. The malware incorporates multiple tactics to avoid detection and complicate reverse engineering, such as API hashing, string encryption, and irrelevant code. Before delving into the analysis of \"EnigmaDownloader_s001,\" let's \u0000rst examine how the malware decrypts strings and resolves","label(s)":[]},{"index":7,"segment":"examine how the malware decrypts strings and resolves hashed Windows APIs. By understanding","label(s)":["T1140"]},{"index":8,"segment":"strings and resolves hashed Windows APIs. By understanding this, we can implement an automated system to help us retrieve encrypted data and streamline the analysis process. Please be advised that to enhance code legibility, we have substituted all hashes with the corresponding function","label(s)":[]},{"index":9,"segment":"have substituted all hashes with the corresponding function names. EnigmaDownloader_s001 API Hashing: API hashing is a technique employed by malware to conceal the","label(s)":["T1106"]},{"index":10,"segment":"a technique employed by malware to conceal the utilization \ue90a of potentially suspicious","label(s)":[]},{"index":11,"segment":"to conceal the utilization \ue90a of potentially suspicious APIs (functions) from static detection.","label(s)":["T1027"]},{"index":12,"segment":"of potentially suspicious APIs (functions) from static detection. This technique helps the malware disguise its activities and evade detection. This website uses cookies for website functionality, tra\u0000c analytics, personalization, social media functionality and advertising. Our Cookie Notice provides more information and explains how to amend your cookie settings. Learn more It involves replaBciunsgi nthees shuman-readable names of functions (such as\ue8b6 \"CreateMutexW\") with a hash value, such as 0x0FD43765A. The hash value https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 6\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake is then used in the code to call the corresponding","label(s)":[]},{"index":13,"segment":"used in the code to call the corresponding API function, rather than using the human-readable name. The purpose","label(s)":["T1106"]},{"index":14,"segment":"rather than using the human-readable name. The purpose of this technique is to make the process of understanding the code more time-consuming and di\u0000cult. For API Hashing the EnigmaDownloader_s001 uses the following custom MurmurHash: \ue90a This website uses cookFieigs uforer 7w.e Cbussitteo mfu nimctpiolenmaleitny,t atrtiao\u0000n cof murmur hash analytics, personalization, social media functionality and advertising. Our Cookie Notice provides more information and The malware employs dynamic API resolving","label(s)":[]},{"index":15,"segment":"information and The malware employs dynamic API resolving to conceal its API imports and explains how to amend","label(s)":["T1106"]},{"index":16,"segment":"its API imports and explains how to amend your cookie settings. Learn more Business \ue8b6 make static analysis more di\u0000cult. This technique involves storing the https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 7\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) names or hashes of the APIs needed, then importing them dynamically","label(s)":[]},{"index":17,"segment":"of the APIs needed, then importing them dynamically at runtime. The Windows API o\u0000ers LoadLibrary and GetProcAddress functions","label(s)":["T1106"]},{"index":18,"segment":"The Windows API o\u0000ers LoadLibrary and GetProcAddress functions to facilitate this. LoadLibrary accepts the name of a DLL and returns a handle, which is then passed to GetProcAddress along with a function name to obtain a pointer to that function. To further evade detection, the malware author even implemented their own custom version of GetProcAddress to retrieve the address of functions such as LoadLibrary and others. The use of standard methods like GetProcAddress and LoadLibrary might raise a red \u0000ag, so the custom implementation helps to avoid detection.","label(s)":[]},{"index":19,"segment":"so the custom implementation helps to avoid detection. \ue90a Figure 8. Dynamic API","label(s)":["T1106"]},{"index":20,"segment":"to avoid detection. \ue90a Figure 8. Dynamic API loading This website uses cookies for website functionality, tra\u0000c analytics,","label(s)":[]},{"index":21,"segment":"functionality, tra\u0000c analytics, personalization, social media functionality and Thaed vfeorltliosinwgi.n Ogu ri sC","label(s)":["T1059.003"]},{"index":22,"segment":"media functionality and Thaed vfeorltliosinwgi.n Ogu ri sC oao kliise tN ootfi cAe PpIr ohvaidsehs mvoarleu iensfo ramloatniogn wanitdh the names of functions explains how to amend your cookie settings. Learn more that have been used in this sample (Please note that the hash value might Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 8\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) be di\u0000erent in other variants since the malware author changed some of the constant values in the hash generator function). \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, social media functionality and advertising. Our Cookie Notice provides more information and explains how to amend your cookie settings. Learn more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 9\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) 0xE04A219 : kernel32_HeapCreate 0xA1ADA36 : kernel32_lstrcpyA 0x5097BB4 : kernel32_RegOpenKeyExA 0x750EFAB : kernel32_GetLastError 0x4CB039A : kernel32_RegQueryValueExA 0xAAF4498 : kernel32_RegCloseKey 0xFAD2A34 : kernel32_lstrcmpiA 0x11A198F : combase_CoCreateGuid 0xE94A809 : kernel32_RtlZeroMemory 0x6A6A154 : kernel32_lstrcatA 0x8150471 : ntdll_RtlAllocateHeap 0x4CF4539 : user32_wvsprintfW 0x663555F : kernel32_WideCharToMultiByte 0x59CADCE : ntdll_RtlFreeHeap 0x1CE543C : cabinet_CloseDecompressor 0x11CF0A2 : wininet_InternetGetConnectedState 0x675C7B2 : kernel32_Sleep 0xDC75FF2","label(s)":[]},{"index":23,"segment":"cabinet_CloseDecompressor 0x11CF0A2 : wininet_InternetGetConnectedState 0x675C7B2 : kernel32_Sleep 0xDC75FF2 : wininet_InternetCheckConnectionA 0x5CC35B1 : wininet_InternetSetOptionA","label(s)":["T1027"]},{"index":24,"segment":": kernel32_Sleep 0xDC75FF2 : wininet_InternetCheckConnectionA 0x5CC35B1 : wininet_InternetSetOptionA 0xF9E8859 : wininet_InternetOpenA 0x6F05A9E : wininet_InternetConnectA 0xBAEECD9 : wininet_HttpOpenRequestA 0xAD9A77C : wininet_HttpSendRequestA 0x835FA71 : wininet_HttpQueryInfoA 0xBFA9532 : wininet_InternetReadFile 0x99D029C : wininet_InternetCloseHandle 0x8DABD38 : kernel32_GetFileAttributesW 0x44E1C18 : kernel32_DeleteFileW 0xAB69596 : kernel32_CreateFileW 0x2CF38A1 : kernel32_WriteFile 0x1CE43DE : kernel32_CloseHandle 0x548C5A4 : Rpcrt4_RpcStringBindingComposeW 0x7B0F79F : Rpcrt4_RpcBindingFromStringBindingW 0x69A2B62 : Rpcrt4_RpcStringFreeW 0xD2CD112 : advapi32_CreateWellKnownSid 0xEFBC2E9 : kernel32_LocalFree 0x60EDB01 : Rpcrt4_RpcBindingFree 0x7A7DAA0 : Rpcrt4_RpcAsyncInitializeHandle 0xB3F16FA : kernel32_CreateEventW 0x1C23B4F : Rpcrt4_NdrAsyncClientCall 0x8C1F37 : kernel32_WaitForSingleObject 0x7831640 : Rpcrt4_RpcRaiseException 0xF2FCCFE : Rpcrt4_RpcAsyncCompleteCall 0x816F545 : kernel32_SetLastError 0xFBE2D99 : oleaut32_SysAllocString 0x393ACB : oleaut32_SysFreeString \ue90a 0xC9FEF5F : kernel32_ExpandEnvironmentStringsW 0x74D51D3 : kernel32_CreateProcessW This w0exbCsDitEe 9usEeCs2 c7oo k:ie sw fiorn wienbestit_e HfutntctpioWneablitSyo, tcrak\u0000ectClose analy0tixcs8, 0peCr8so4n4a9li za:t iokne, sroncieall m3e2d_iaT efurnmctiionnaatliteyP arnodcess adver0tixsi4n1g.8 OBu4rE C7oEo ki:e Nwoiticnei pnreovtid_eAsp mpoCraec inhfeorCmhaetcioknM aanndifest 0x44E65EB : kernel32_WaitForDebugEvent explains how to amend your cookie settings. Learn more 0x81C3F46B u:s ikneersnsel32_ContinueDebugEvent \ue8b6 0x1FB9EB2 : kernel32_LoadLibraryW 0x1071970 : kernel32_GetProcAddress 0xDAE6C9B : combase_CoInitializeEx https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 10\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) 0xFD43765 : kernel32_CreateMutexW 0x73861029 : kernel32_BasepSetFileEncryptionCompression 0xA3FE987 : advapi32_RegDeleteKeyW 0x1CA6703 : advapi32_RegCreateKeyA 0x24EBD39 : kernel32_lstrlenA 0x69F38C6 : kernel32_RegSetValueExA 0xC2D33DC : ntdll_RtlGetVersion 0xBD5D03A : kernel32_GetNativeSystemInfo 0x10BEDD60 : wininet_CreateMD5SSOHash To resolve the API hash, the malware \u0000rst passes two arguments to the \"mw_resolveAPI\" function. The \u0000rst argument is the speci\u0000c library name index number (in this case 0xA = Kernel32.dll), while the second argument is the export function name hashed value (which, in this example, is 0xFD43765A) The mw_resolveAPI function \u0000rst \u0000nds the speci\u0000c index, jumps to it, and decrypts","label(s)":[]},{"index":25,"segment":"the speci\u0000c index, jumps to it, and decrypts the corresponding library name value as shown in the bottom","label(s)":["T1140"]},{"index":26,"segment":"library name value as shown in the bottom image of Figure 9. \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, social media functionality and advertising. Our Cookie Notice provides more information and explains how to amend your cookie settings. Learn more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 11\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Figure 9. Resolving API hashes The following is the list","label(s)":[]},{"index":27,"segment":"Resolving API hashes The following is the list of decrypted library names: \ue90a","label(s)":["T1106"]},{"index":28,"segment":"is the list of decrypted library names: \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 12\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake WinInet.dll \ue933 userenv.dll \ue933 psapi.dll","label(s)":[]},{"index":29,"segment":"Trend Micro (NO) WinInet.dll \ue933 userenv.dll \ue933 psapi.dll \ue933 netapi32.dll \ue933 mpr.dll \ue933","label(s)":["T1053.005"]},{"index":30,"segment":"userenv.dll \ue933 psapi.dll \ue933 netapi32.dll \ue933 mpr.dll \ue933 wtsapi32.dll \ue933 api-ms-win-core-processthreads-l1-1-0.dll \ue933 ntoskrnl.exe \ue933 Rpcrt4.dll \ue933 User32.dll \ue933 api-ms-win-core-com-l1-1-0.dll \ue933 Cabinet.dll \ue933 shell32.dll \ue933 OleAut32.dll \ue933 Ole32.dll \ue933","label(s)":[]},{"index":31,"segment":"Cabinet.dll \ue933 shell32.dll \ue933 OleAut32.dll \ue933 Ole32.dll \ue933 ntdll.dll \ue933 mscoree.dll \ue933 kernel32.dll \ue933 advapi32.dll \ue933 The library name and export function name","label(s)":["T1053.005"]},{"index":32,"segment":"\ue933 The library name and export function name hashed value is then passed to GetExportAddressByHash, which is responsible for opening the handle to the library, creating a hash for each export function name, and comparing it with the passed argument. Once the match is found, the malware returns the function address and calls it. \ue90a This website uses cookies for website functionality, tra\u0000c and advertising. Our Cookie Notice provides more information and explains how to amend your cookie settings. Learn more Business \ue8b6 Figure 10. Retrieving the address of an API https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 13\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake The code snippet in Figure 11 demonstrates how mw_GetExportAddressByHash resolves the given API hash and","label(s)":[]},{"index":33,"segment":"how mw_GetExportAddressByHash resolves the given API hash and retrieves the address of an","label(s)":["T1027"]},{"index":34,"segment":"API hash and retrieves the address of an exported function. The techniques used","label(s)":[]},{"index":35,"segment":"address of an exported function. The techniques used to decrypt strings and resolve API hashes in both the","label(s)":["T1140"]},{"index":36,"segment":"strings and resolve API hashes in both the stage 1 and stage 2 payloads are identical. Figure 11. Custom implementation of GetProcAddress With an understanding of this process, we can then proceed with our analysis. \ue90a Upon execution, the malware creates the mutual exclusion object (mutex) to mark its presence in the system and retrieves the MachineGuid of the This website uses cookies for website functionality, tra\u0000c analytics, infected system from the SOFTWARE\\Microsoft\\Cryptography\\MachineGuid advertising. Our Cookie Notice provides more information and regexisptlariyn sk heoyw, two hamicehn dit y uousre cso oaksie a s euttninigqsu. Lee aidrne nmtoi\u0000reer to register the system with Business \ue8b6 its C&C server and track its infection. https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 14\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Figure 12. Constructing a unique system identi\u0000er and creating a mutex It then deletes the HKCU\\SOFTWARE\\Intel registry key and recreates it with two values, HWID and ID, as shown in Figure 13. \ue90a This website uses cookies for website functionality, \ue8b6 Figure 13. Recreating HKCU\\SOFTWARE\\Intel https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 15\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) It then collects information about the .NET Framework","label(s)":[]},{"index":37,"segment":"It then collects information about the .NET Framework Setup on the infected system","label(s)":["T1082"]},{"index":38,"segment":"the .NET Framework Setup on the infected system and sends it to its C&C server as shown in Figure 14. Figure 14. Constructing \u0000rst debug message Figure 15. An example of the \u0000rst debug message There are two C&C servers that were used in this attack chain. The \u0000rst one \ue90a ,193[.]56[.]146[.]29, is used to send program execution DEBUG and This website uses cookies for website functionality, tra\u0000c Telegram to deliver payloads and send commands. analytics, personalization, social media functionality and advertising. Our Cookie Notice provides more information and explains how to amend Business \ue8b6 To download the next stage payload, the malware \u0000rst sends a request to the attacker-controlled Telegram channel https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 16\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) https:\/\/api[.]telegram[.]org\/bot{token}\/getFile to obtain the \u0000le_path. This approach allows the attacker to continuously update and eliminates reliance on \u0000xed \u0000le names. Figure 16. Payload \u201c\u0000le_path\u201d request from Telegram Note that in this case, the next stage payload was \u0000le_17.pack. However, this \u0000le and other stage names were changed multiple times during our investigation. Upon obtaining the \u0000le_path, the malware then sends a request to download the next stage binary \u0000le (shown in Figure 17) \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, social media functionality and Figure 17. Payload download request from Telegram advertising. Our Cookie Notice provides more information and explains https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 17\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) Figure 18. The","label(s)":[]},{"index":39,"segment":"Jobs | Trend Micro (NO) Figure 18. The code responsible for decrypting the next stage payload \u0000le_id and","label(s)":["T1140"]},{"index":40,"segment":"for decrypting the next stage payload \u0000le_id and Telegram token If the \u0000le's download, deobfuscation, and decompression are","label(s)":[]},{"index":41,"segment":"If the \u0000le's download, deobfuscation, and decompression are successful, the malware sends the","label(s)":["T1140"]},{"index":42,"segment":"and decompression are successful, the malware sends the message \"bot getted\" to the debug server. \ue90a This website uses cooFkigieusr efo 1r9 w. Seubcscitees fsufunlc ptiaoynlaolaitdy ,r tertar\u0000ievcal debug message analytics, personalization, social media functionality and advertising. Our and To decompress the payload, the malware uses Microsoft Cabinet's explains how to amend your cookie settings. Learn more Business \ue8b6 Compressapi with the compression algorithm (\"COMPRESS_RAW | COMPRESS_ALGORITHM_LZMS\"). The code snippet in Figure 20 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 18\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) demonstrates how the malware downloads, deobfuscates, and decompresses \u0000le_17.pack (UpdateTask.dll). Figure 20. Code","label(s)":[]},{"index":43,"segment":"deobfuscates, and decompresses \u0000le_17.pack (UpdateTask.dll). Figure 20. Code responsible for downloading, deobfuscating, decompressing, and renaming the downloaded payload","label(s)":["T1140"]},{"index":44,"segment":"downloading, deobfuscating, decompressing, and renaming the downloaded payload \ue90a This website uses cookies for website functionality, tra\u0000c analytics, Learn more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 19\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with (NO) Figure 21. Payload deobfuscation and decompression Before executing the","label(s)":[]},{"index":45,"segment":"21. Payload deobfuscation and decompression Before executing the payload, the malware attempts to","label(s)":["T1140"]},{"index":46,"segment":"Before executing the payload, the malware attempts to elevate its privileges by executing the mw_UAC_bypass function, which is part of an open-source project. This technique, Calling Local Windows RPC Servers from .NET (which was unveiled in 2019 by Project Zero), allows a user to bypass user accou\ue90ant control (UAC) using only two remote procedure call (RPC) requests instead This website uses cookies for website functionality, tra\u0000c of aDnaLlLyt ihcsi,j apecrksionngal.ization, social media functionality and advertising. Our Cookie Notice https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 20\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) Figure 22. Successful UAC bypass execution debug message The malware requires elevated privileges for the subsequent stage payload, which involves loading the malicious driver by exploiting CVE-2015-2291. Finally, the malware executes an export function called \"Entry\" from UpdateTask.dll via rundll32.exe as shown in","label(s)":[]},{"index":47,"segment":"\"Entry\" from UpdateTask.dll via rundll32.exe as shown in Figure 23. Figure 23. Running","label(s)":["T1003.001"]},{"index":48,"segment":"as shown in Figure 23. Figure 23. Running the stage 2 payload through rundll32.exe Stage 2: EnigmaDownloader_s002 \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, social media functionality and 377f617ccd4aa09287d5221d5d8e1228 MD5 advertising. Our Cookie Notice provides more information and explains settings. Learn more Busines2s88358deaa053b30596100c9841a7d6d1616908d \ue8b6 SHA-1 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 21\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) f1623c2f7c00a\u0000a3985cf7b9cdf25e39320700fa9d69f9f9426f03054b4b712 SHA-256 497.50 KB (509440 bytes) File size The second stage payload, UpdatTask.dll, is a dynamic-link library (DLL) written in C++ that comprises two export functions (DllEntryPoint and Entry). The malicious code is executed in the Entry export function, which is triggered by the \u0000rst stage routine. The primary objective of this malware is to disable Microsoft Defender by deploying a malicious kernel mode driver (\u201cbring your own vulnerable driver\u201d or BYOVD method) via exploiting a vulnerable Intel driver (CVE-2015-2291) and then downloading and executing the third-stage payload. Please note that the \u0000rst, second, and third-stage payloads all obtain the infected system's MachineGuid at the start and use it to identify the machine in debug message network tra\u0000c, enabling the adversary to track the infected system's malware execution state. Upon execution, the malware creates the mutex to mark its presence on the system and retrieves the MachineGuid of the infected system from the \"SOFTWARE\\Microsoft\\Cryptography\\MachineGuid\" registry key. \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 22\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Figure 24. Constructing a unique system identi\u0000er and creating a mutex Next, the malware will determine if it is running as an account with administrator privileges or simply as a regular user using the GetTokenInformation","label(s)":[]},{"index":49,"segment":"simply as a regular user using the GetTokenInformation API. If the malware fails to obtain elevated privileges, it","label(s)":["T1106"]},{"index":50,"segment":"the malware fails to obtain elevated privileges, it will bypass the disablement of Windows Defender and proceed to download and execute the next stage of its attack. \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 23\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Figure 25. Checking the process privileges If the process successfully obtains elevated privileges, it proceeds to drop the \u0000les shown in Figure 26. Figure 26. Stage 2 embedded binary \u0000les Name iQVW64.SYS (CVE-2015-2291) \ue90a Description Vulnerable Intel driver, used for kernel exploitation This website uses cookies for website functionality, tra\u0000c MD5 1898ceda3247213c084f43637ef163b3 analytics, personalization, social media functionality and advertising. Our and SHA-1 d04e5db5b6c848a29732bfd52029001f23c3da75 explains how to amend your cookie settings. Learn more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 24\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with (NO) SHA-256 4429f32db1cc70567919d7d47b844a91cf1329a6cd116f582305f3b7b60cd60b Name Driver.SYS Description Malicious drivers reduce the token integrity of Microsoft defender (MsMpEng. MD5 28ca7a21de60671f3b528a9e08a44e1c SHA-1 21F1CFD310633863BABAAFE7E5E892AE311B42F6 SHA-256 D5B4C2C95D9610623E681301869B1643E4E2BF0ADCA42EAC5D4D773B024FA The malware uses an open-source project called KDMapper to manually map non-signed\/self-signed drivers in memory by exploiting the iqvw64e.sys Intel driver. Testing on this has reportedly been conducted on Windows 10 version 1607 to Windows 11 version 22449.1. The functions intel_driver::Load() and kdmapper::MapDriver() are both responsible for achieving this task. The following snippet demonstrates the debug message related to drive loading and installation: \ue90a This website uses cookies for website functionality, tra\u0000c analytics, 25\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with (NO) Figure 27. Debug message for loading the driver and providing execution status The malware then establishes persistence on the","label(s)":[]},{"index":51,"segment":"status The malware then establishes persistence on the targeted system by creating scheduled","label(s)":["T1053.005"]},{"index":52,"segment":"persistence on the targeted system by creating scheduled tasks. \ue90a This website uses","label(s)":[]},{"index":53,"segment":"by creating scheduled tasks. \ue90a This website uses cookies for website functionality, tra\u0000c","label(s)":["T1053.005"]},{"index":54,"segment":"amend your cookie settings. Learn more Business \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 26\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry Micro (NO) Figure 28. Malware","label(s)":[]},{"index":55,"segment":"Jobs | Trend Micro (NO) Figure 28. Malware persistence is achieved via scheduled tasks (click the image for","label(s)":["T1053.005"]},{"index":56,"segment":"achieved via scheduled tasks (click the image for a larger version) Finally, the EnigmaDownloader_s002 downloads and executes the next- stage payload on the infected system. To achieve this task, it employs similar techniques","label(s)":[]},{"index":57,"segment":"To achieve this task, it employs similar techniques as those used in the","label(s)":["T1053.005"]},{"index":58,"segment":"employs similar techniques as those used in the \u0000rst stage \u2014 the only di\u0000erence, in this case, is that the malware is executing a .NET Assembly from C++ in memory using the CLR (Common Language Runtime) hosting technique. \ue90a This website uses cookies for website functionality, tra\u0000c analytics, Learn more Business \ue8b6 Figure 29. The stage 3 .NET binary is executed via CLR hosting https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 27\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) Stage 2.1: Enigma Driver analysis MD5 Driver.SYS SHA- 28CA7A21DE60671F3B528A9E08A44E1C 1 SHA- 21F1CFD310633863BABAAFE7E5E892AE311B42F6 256 File D5B4C2C95D9610623E681301869B1643E4E2BF0ADCA42EAC5D4D773B024FA442 size The driver's sole purpose is to patch the integrity level of the Microsoft defender (MsMpEng.exe) and forcibly reduce it from system to untrusted integrity. The reduction of the integrity level to untrusted impedes the process of accessing secure resources on the system for the victim, silently disabling it without terminating the process. \ue90a Figure 30. Microsoft defender token integrity modi\u0000cation before and after executing Enigma Driver This website uses cookies for website functionality, tra\u0000c analytics, personalization, information and The code snippets in Figure 31 demonstrate how the malware performs explains how to amend your cookie settings. Learn more Business \ue8b6 these operations. https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 28\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) Figure 31. Integrity level patching Figure 32. Details of the vulnerable Intel driver binary \ue90a This website uses cookies for website functionality, \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 29\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) Figure 33. Details of the certi\u0000cate of the vulnerable driver (top) and Enigma Driver (bottom) Stage 3: EnigmaDownloader_s003 The following table shows the details of Enigma.Bot.Net.exe. \ue90a This website uses cookies for website functionality, tra\u0000c analytics, personalization, information and MD5 50949ad2b39796411a4c7a88df0696c8 explains how to amend your cookie settings. Learn more Business \ue8b6 SHA-1 67a502395fc4193721c2cfc39e31be11e124e02c https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 30\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) SHA-256 8dc192914e55cf9f90841098ab0349dbe31825996de99237f35a1aab6d7905bb File size 10.50 KB (10752 bytes) EnigmaDownloader_s003 is a third-stage downloader written in C#. It is responsible for downloading, decompressing, and executing the \u0000nal stealer payload on an infected system. The malware also accepts commands from a Telegram channel, though these commands may vary between variants. stop alive runassembly","label(s)":[]},{"index":59,"segment":"commands may vary between variants. stop alive runassembly Upon launch, the malware sends a \"Bot started\" message to","label(s)":["T1090"]},{"index":60,"segment":"the malware sends a \"Bot started\" message to both the Debug server and the Telegram channel, indicating its successful execution. \ue90a This website uses cookies for website functionality, \ue8b6 https:\/\/www.trendmicro.com\/en_no\/research\/23\/b\/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html 31\/43 5\/1\/24, 11:06 AM Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs | Trend Micro (NO) Figure 34. Stage 3 payload initialization It then sends a GET request to https:\/\/api[.]telegram[.]org\/bot{token}\/getUpdates to retrieve the command. Upon receiving the runassembly","label(s)":[]},{"index":61,"segment":"to retrieve the command. Upon receiving the runassembly command, the malware downloads the","label(s)":["T1105"]},{"index":62,"segment":"receiving the runassembly command, the malware downloads the next part of the \u0000nal","label(s)":[]},{"index":63,"segment":"malware downloads the next part of the \u0000nal stage payload (\u0000le_19.pack), decompresses it","label(s)":["T1105"]},{"index":64,"segment":"of the \u0000nal stage payload (\u0000le_19.pack), decompresses it using the GZipStream API, and executes it. \ue90a This website","label(s)":["T1106"]}]}